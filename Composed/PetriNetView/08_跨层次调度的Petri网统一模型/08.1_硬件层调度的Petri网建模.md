# 08.1 ç¡¬ä»¶å±‚è°ƒåº¦çš„Petriç½‘å»ºæ¨¡

> **å­ä¸»é¢˜**: 08.1
> **æ‰€å±ä¸»é¢˜**: 08 è·¨å±‚æ¬¡è°ƒåº¦çš„Petriç½‘ç»Ÿä¸€æ¨¡å‹
> **æœ€åæ›´æ–°**: 2025-12-02

---

## ğŸ“‹ ç›®å½•

- [08.1 ç¡¬ä»¶å±‚è°ƒåº¦çš„Petriç½‘å»ºæ¨¡](#081-ç¡¬ä»¶å±‚è°ƒåº¦çš„petriç½‘å»ºæ¨¡)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 CPUæµæ°´çº¿çš„Petriç½‘æ¨¡å‹](#1-cpuæµæ°´çº¿çš„petriç½‘æ¨¡å‹)
  - [2 ç¼“å­˜ä¸€è‡´æ€§åè®®](#2-ç¼“å­˜ä¸€è‡´æ€§åè®®)
  - [3 ä¸­æ–­å¤„ç†](#3-ä¸­æ–­å¤„ç†)
  - [4 å®é™…æ¡ˆä¾‹ï¼šARMå¤„ç†å™¨è°ƒåº¦](#4-å®é™…æ¡ˆä¾‹armå¤„ç†å™¨è°ƒåº¦)

---

## 1 CPUæµæ°´çº¿çš„Petriç½‘æ¨¡å‹

**5çº§æµæ°´çº¿**ï¼šFetch â†’ Decode â†’ Execute â†’ Memory â†’ WriteBack

```python
def create_cpu_pipeline():
    """CPUæµæ°´çº¿Petriç½‘æ¨¡å‹"""
    pn = PetriNet()

    stages = ['Fetch', 'Decode', 'Execute', 'Memory', 'WriteBack']

    # åˆå§‹æŒ‡ä»¤é˜Ÿåˆ—
    pn.add_place('p_instruction_queue', tokens=10)

    for i, stage in enumerate(stages):
        # é˜¶æ®µå˜è¿
        pn.add_transition(f't_{stage}')

        if i == 0:
            pn.add_arc('p_instruction_queue', f't_{stage}')
        else:
            prev_stage = stages[i-1]
            pn.add_arc(f'p_after_{prev_stage}', f't_{stage}')

        if i < len(stages) - 1:
            pn.add_place(f'p_after_{stage}', tokens=0)
            pn.add_arc(f't_{stage}', f'p_after_{stage}')
        else:
            pn.add_place('p_retired', tokens=0)
            pn.add_arc(f't_{stage}', 'p_retired')

    return pn
```

---

## 2 ç¼“å­˜ä¸€è‡´æ€§åè®®

**MESIåè®®çš„Petriç½‘è¡¨ç¤º**ï¼š

```python
def create_mesi_protocol():
    """MESIç¼“å­˜ä¸€è‡´æ€§åè®®Petriç½‘"""
    pn = PetriNet()

    # ç¼“å­˜è¡ŒçŠ¶æ€
    states = ['Modified', 'Exclusive', 'Shared', 'Invalid']
    for state in states:
        pn.add_place(f'p_cache_{state}', tokens=0)

    pn.marking['p_cache_Invalid'] = 1  # åˆå§‹ï¼šInvalid

    # çŠ¶æ€è½¬æ¢ï¼ˆç®€åŒ–ï¼‰
    # Read Miss: I -> E æˆ– I -> S
    pn.add_transition('t_read_miss_exclusive')
    pn.add_arc('p_cache_Invalid', 't_read_miss_exclusive')
    pn.add_arc('t_read_miss_exclusive', 'p_cache_Exclusive')

    # Write Hit: E -> M
    pn.add_transition('t_write_hit')
    pn.add_arc('p_cache_Exclusive', 't_write_hit')
    pn.add_arc('t_write_hit', 'p_cache_Modified')

    return pn
```

---

## 3 ä¸­æ–­å¤„ç†

```python
def create_interrupt_handler():
    """ä¸­æ–­å¤„ç†Petriç½‘æ¨¡å‹"""
    pn = PetriNet()

    # æ­£å¸¸æ‰§è¡Œ
    pn.add_place('p_running', tokens=1)
    pn.add_transition('t_execute')
    pn.add_arc('p_running', 't_execute')
    pn.add_arc('t_execute', 'p_running')  # å¾ªç¯

    # ä¸­æ–­åˆ°è¾¾
    pn.add_transition('t_interrupt')
    pn.add_arc('p_running', 't_interrupt')

    # ä¸­æ–­å¤„ç†
    pn.add_place('p_interrupt_handling', tokens=0)
    pn.add_arc('t_interrupt', 'p_interrupt_handling')

    # æ¢å¤æ‰§è¡Œ
    pn.add_transition('t_resume')
    pn.add_arc('p_interrupt_handling', 't_resume')
    pn.add_arc('t_resume', 'p_running')

    return pn
```

---

## 4 å®é™…æ¡ˆä¾‹ï¼šARMå¤„ç†å™¨è°ƒåº¦

```python
def create_arm_cortex_a53():
    """ARM Cortex-A53å¤„ç†å™¨Petriç½‘æ¨¡å‹ï¼ˆ4æ ¸ï¼‰"""
    pn = PetriNet()

    # 4ä¸ªCPUæ ¸å¿ƒ
    for i in range(4):
        pn.add_place(f'p_core{i}_idle', tokens=1)

    # çº¿ç¨‹é˜Ÿåˆ—
    pn.add_place('p_thread_queue', tokens=20)

    # æ¯ä¸ªæ ¸å¿ƒå¯ä»¥è°ƒåº¦çº¿ç¨‹
    for i in range(4):
        pn.add_transition(f't_core{i}_schedule')
        pn.add_arc('p_thread_queue', f't_core{i}_schedule')
        pn.add_arc(f'p_core{i}_idle', f't_core{i}_schedule')

        pn.add_place(f'p_core{i}_running', tokens=0)
        pn.add_arc(f't_core{i}_schedule', f'p_core{i}_running')

        pn.add_transition(f't_core{i}_complete')
        pn.add_arc(f'p_core{i}_running', f't_core{i}_complete')
        pn.add_arc(f't_core{i}_complete', f'p_core{i}_idle')

    return pn
```

---

**è¿”å›**: [08 è·¨å±‚æ¬¡è°ƒåº¦çš„Petriç½‘ç»Ÿä¸€æ¨¡å‹](README.md)
