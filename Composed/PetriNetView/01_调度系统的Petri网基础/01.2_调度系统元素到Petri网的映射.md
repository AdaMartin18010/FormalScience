# 01.2 è°ƒåº¦ç³»ç»Ÿå…ƒç´ åˆ°Petriç½‘çš„æ˜ å°„

> **å­ä¸»é¢˜**: 01.2
> **æ‰€å±ä¸»é¢˜**: 01 è°ƒåº¦ç³»ç»Ÿçš„Petriç½‘åŸºç¡€
> **æœ€åæ›´æ–°**: 2025-12-02
> **æ–‡æ¡£çŠ¶æ€**: âœ… æ–°å¢

---

## ğŸ“‹ ç›®å½•

- [01.2 è°ƒåº¦ç³»ç»Ÿå…ƒç´ åˆ°Petriç½‘çš„æ˜ å°„](#012-è°ƒåº¦ç³»ç»Ÿå…ƒç´ åˆ°petriç½‘çš„æ˜ å°„)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 æ˜ å°„æ¦‚è¿°](#1-æ˜ å°„æ¦‚è¿°)
  - [2 ä»»åŠ¡åˆ°å˜è¿çš„æ˜ å°„](#2-ä»»åŠ¡åˆ°å˜è¿çš„æ˜ å°„)
    - [2.1 æ˜ å°„åŸåˆ™](#21-æ˜ å°„åŸåˆ™)
    - [2.2 ä»»åŠ¡çŠ¶æ€çš„è¡¨ç¤º](#22-ä»»åŠ¡çŠ¶æ€çš„è¡¨ç¤º)
    - [2.3 ä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„è¡¨ç¤º](#23-ä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„è¡¨ç¤º)
  - [3 èµ„æºåˆ°åº“æ‰€çš„æ˜ å°„](#3-èµ„æºåˆ°åº“æ‰€çš„æ˜ å°„)
    - [3.1 æ˜ å°„ç­–ç•¥](#31-æ˜ å°„ç­–ç•¥)
    - [3.2 èµ„æºç±»å‹å»ºæ¨¡](#32-èµ„æºç±»å‹å»ºæ¨¡)
    - [3.3 èµ„æºå®¹é‡å»ºæ¨¡](#33-èµ„æºå®¹é‡å»ºæ¨¡)
  - [4 ä¾èµ–å…³ç³»åˆ°å¼§çš„æ˜ å°„](#4-ä¾èµ–å…³ç³»åˆ°å¼§çš„æ˜ å°„)
    - [4.1 æ•°æ®ä¾èµ–](#41-æ•°æ®ä¾èµ–)
    - [4.2 èµ„æºä¾èµ–](#42-èµ„æºä¾èµ–)
    - [4.3 æ—¶åºä¾èµ–](#43-æ—¶åºä¾èµ–)
  - [5 è°ƒåº¦ç­–ç•¥åˆ°ç‚¹ç«è§„åˆ™çš„æ˜ å°„](#5-è°ƒåº¦ç­–ç•¥åˆ°ç‚¹ç«è§„åˆ™çš„æ˜ å°„)
    - [5.1 FCFSç­–ç•¥](#51-fcfsç­–ç•¥)
    - [5.2 ä¼˜å…ˆçº§ç­–ç•¥](#52-ä¼˜å…ˆçº§ç­–ç•¥)
    - [5.3 æŠ¢å å¼ç­–ç•¥](#53-æŠ¢å å¼ç­–ç•¥)
  - [6 å®é™…æ¡ˆä¾‹ï¼šKubernetes Podè°ƒåº¦](#6-å®é™…æ¡ˆä¾‹kubernetes-podè°ƒåº¦)
    - [6.1 Podç”Ÿå‘½å‘¨æœŸæ˜ å°„](#61-podç”Ÿå‘½å‘¨æœŸæ˜ å°„)
    - [6.2 èµ„æºè¯·æ±‚ä¸é™åˆ¶](#62-èµ„æºè¯·æ±‚ä¸é™åˆ¶)
    - [6.3 äº²å’Œæ€§ä¸åäº²å’Œæ€§](#63-äº²å’Œæ€§ä¸åäº²å’Œæ€§)
    - [6.4 Pythonå®Œæ•´å®ç°](#64-pythonå®Œæ•´å®ç°)
  - [7 æ˜ å°„å®Œæ•´æ€§åˆ†æ](#7-æ˜ å°„å®Œæ•´æ€§åˆ†æ)
  - [8 è·¨è§†è§’é“¾æ¥](#8-è·¨è§†è§’é“¾æ¥)

---

## 1 æ˜ å°„æ¦‚è¿°

**æ ¸å¿ƒæ€æƒ³**ï¼šå»ºç«‹è°ƒåº¦ç³»ç»Ÿä¸Petriç½‘ä¹‹é—´çš„**ç³»ç»ŸåŒ–æ˜ å°„**ï¼Œä½¿å¾—è°ƒåº¦ç³»ç»Ÿçš„æ¯ä¸ªå…ƒç´ éƒ½èƒ½åœ¨Petriç½‘ä¸­æ‰¾åˆ°å¯¹åº”çš„è¡¨ç¤ºã€‚

**æ˜ å°„æ¡†æ¶**ï¼š

```text
è°ƒåº¦ç³»ç»Ÿ           â†’        Petriç½‘
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ä»»åŠ¡ï¼ˆTaskï¼‰       â†’        å˜è¿ï¼ˆTransitionï¼‰
èµ„æºï¼ˆResourceï¼‰   â†’        åº“æ‰€ï¼ˆPlaceï¼‰
çŠ¶æ€ï¼ˆStateï¼‰      â†’        æ ‡è®°ï¼ˆMarkingï¼‰
æ‰§è¡Œï¼ˆExecutionï¼‰  â†’        ç‚¹ç«ï¼ˆFiringï¼‰
ä¾èµ–ï¼ˆDependencyï¼‰ â†’        å¼§ï¼ˆArcï¼‰
ç­–ç•¥ï¼ˆPolicyï¼‰     â†’        ç‚¹ç«è§„åˆ™ï¼ˆFiring Ruleï¼‰
```

**å®šç†1.21ï¼ˆæ˜ å°„ä¿æŒæ€§è´¨ï¼‰**ï¼š

å¦‚æœæ˜ å°„ $\phi: S \to PN$ æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

1. ä»»åŠ¡æ‰§è¡Œ $\Rightarrow$ å˜è¿ç‚¹ç«
2. èµ„æºå¯ç”¨ $\Rightarrow$ åº“æ‰€æ ‡è®°å……è¶³
3. ä¾èµ–æ»¡è¶³ $\Rightarrow$ å˜è¿ä½¿èƒ½

åˆ™è°ƒåº¦ç³»ç»Ÿ $S$ çš„å¯è¡Œè°ƒåº¦åºåˆ—ä¸Petriç½‘ $PN$ çš„å¯è¾¾æ ‡è®°åºåˆ—ä¸€ä¸€å¯¹åº”ã€‚

---

## 2 ä»»åŠ¡åˆ°å˜è¿çš„æ˜ å°„

### 2.1 æ˜ å°„åŸåˆ™

**å®šä¹‰1.22ï¼ˆä»»åŠ¡-å˜è¿æ˜ å°„ï¼‰**ï¼š

ç»™å®šä»»åŠ¡ $task = (id, resources, duration, dependencies)$ï¼Œæ˜ å°„åˆ°å˜è¿ $t_{task}$ï¼š

$$
\phi_{task}(task) = (t_{task}, \bullet t_{task}, t_{task}\bullet, W_{in}, W_{out})
$$

å…¶ä¸­ï¼š

- $\bullet t_{task} = \{p_r \mid r \in resources_{required}\}$ ï¼šè¾“å…¥åº“æ‰€
- $t_{task}\bullet = \{p_r \mid r \in resources_{released}\}$ ï¼šè¾“å‡ºåº“æ‰€
- $W_{in}(p_r, t_{task}) = amount_{required}(r)$ ï¼šè¾“å…¥æƒé‡
- $W_{out}(t_{task}, p_r) = amount_{released}(r)$ ï¼šè¾“å‡ºæƒé‡

**æ˜ å°„ç¤ºä¾‹**ï¼š

```text
ä»»åŠ¡æè¿°ï¼š
- ä»»åŠ¡ID: T1
- éœ€è¦èµ„æº: 2ä¸ªCPU, 4GBå†…å­˜
- é‡Šæ”¾èµ„æº: 2ä¸ªCPU, 4GBå†…å­˜
- æ‰§è¡Œæ—¶é—´: 5ç§’

Petriç½‘è¡¨ç¤ºï¼š
           p_cpu(10)      p_memory(16GB)
              â†“ (2)           â†“ (4)
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚    t_T1  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†‘ (2)           â†‘ (4)
           p_cpu          p_memory
```

### 2.2 ä»»åŠ¡çŠ¶æ€çš„è¡¨ç¤º

**ä»»åŠ¡çŠ¶æ€æ˜ å°„**ï¼š

```text
è°ƒåº¦ç³»ç»Ÿä»»åŠ¡çŠ¶æ€          Petriç½‘è¡¨ç¤º
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Createdï¼ˆå·²åˆ›å»ºï¼‰    â†’    p_readyåº“æ‰€æœ‰æ ‡è®°
Readyï¼ˆå°±ç»ªï¼‰        â†’    t_taskä½¿èƒ½
Runningï¼ˆè¿è¡Œä¸­ï¼‰    â†’    t_taskå·²ç‚¹ç«ï¼Œp_runningæœ‰æ ‡è®°
Completedï¼ˆå®Œæˆï¼‰    â†’    t_completeç‚¹ç«ï¼Œp_doneæœ‰æ ‡è®°
Failedï¼ˆå¤±è´¥ï¼‰       â†’    t_failç‚¹ç«ï¼Œp_failedæœ‰æ ‡è®°
```

**å®Œæ•´çŠ¶æ€è½¬æ¢çš„Petriç½‘**ï¼š

```python
class TaskLifecyclePetriNet:
    """ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸçš„Petriç½‘å»ºæ¨¡"""

    def __init__(self, task_id):
        self.pn = PetriNet()
        self.task_id = task_id

        # åº“æ‰€ï¼šä»»åŠ¡çŠ¶æ€
        self.pn.add_place(f'p_{task_id}_created', tokens=1)
        self.pn.add_place(f'p_{task_id}_ready', tokens=0)
        self.pn.add_place(f'p_{task_id}_running', tokens=0)
        self.pn.add_place(f'p_{task_id}_completed', tokens=0)
        self.pn.add_place(f'p_{task_id}_failed', tokens=0)

        # å˜è¿ï¼šçŠ¶æ€è½¬æ¢
        self.pn.add_transition(f't_{task_id}_submit')      # æäº¤ä»»åŠ¡
        self.pn.add_transition(f't_{task_id}_schedule')    # è°ƒåº¦ä»»åŠ¡
        self.pn.add_transition(f't_{task_id}_execute')     # æ‰§è¡Œä»»åŠ¡
        self.pn.add_transition(f't_{task_id}_complete')    # å®Œæˆä»»åŠ¡
        self.pn.add_transition(f't_{task_id}_fail')        # å¤±è´¥å¤„ç†

        # å¼§ï¼šçŠ¶æ€è½¬æ¢è·¯å¾„
        # created -> ready
        self.pn.add_arc(f'p_{task_id}_created', f't_{task_id}_submit')
        self.pn.add_arc(f't_{task_id}_submit', f'p_{task_id}_ready')

        # ready -> running
        self.pn.add_arc(f'p_{task_id}_ready', f't_{task_id}_schedule')
        self.pn.add_arc(f't_{task_id}_schedule', f'p_{task_id}_running')

        # running -> completed or failed
        self.pn.add_arc(f'p_{task_id}_running', f't_{task_id}_complete')
        self.pn.add_arc(f't_{task_id}_complete', f'p_{task_id}_completed')

        self.pn.add_arc(f'p_{task_id}_running', f't_{task_id}_fail')
        self.pn.add_arc(f't_{task_id}_fail', f'p_{task_id}_failed')

    def visualize(self):
        self.pn.visualize()

# ä½¿ç”¨ç¤ºä¾‹
task_pn = TaskLifecyclePetriNet('task1')
task_pn.visualize()
```

### 2.3 ä»»åŠ¡æ‰§è¡Œæ—¶é—´çš„è¡¨ç¤º

**æ—¶é—´Petriç½‘æ˜ å°„**ï¼š

å¯¹äºæœ‰æ‰§è¡Œæ—¶é—´çš„ä»»åŠ¡ï¼Œä½¿ç”¨**æ—¶é—´Petriç½‘ï¼ˆTPNï¼‰**ï¼š

$$
t_{task} = (name, \bullet t, t\bullet, W, [a, b])
$$

å…¶ä¸­ $[a, b]$ æ˜¯æ—¶é—´åŒºé—´ï¼Œè¡¨ç¤ºä»»åŠ¡æ‰§è¡Œæ—¶é—´åœ¨ $a$ åˆ° $b$ ä¹‹é—´ã€‚

**ç¤ºä¾‹**ï¼š

```text
ä»»åŠ¡æ‰§è¡Œæ—¶é—´: 5-10ç§’

TPNè¡¨ç¤ºï¼š
t_task: [5, 10]

è¯­ä¹‰ï¼š
- å˜è¿ä½¿èƒ½åï¼Œæœ€æ—©5ç§’å¯ç‚¹ç«
- æœ€æ™šå¿…é¡»åœ¨10ç§’å†…ç‚¹ç«
```

---

## 3 èµ„æºåˆ°åº“æ‰€çš„æ˜ å°„

### 3.1 æ˜ å°„ç­–ç•¥

**å®šä¹‰1.23ï¼ˆèµ„æº-åº“æ‰€æ˜ å°„ï¼‰**ï¼š

èµ„æº $r = (type, capacity, sharable)$ æ˜ å°„åˆ°åº“æ‰€ $p_r$ï¼š

$$
\phi_{resource}(r) = (p_r, M_0(p_r), K(p_r))
$$

å…¶ä¸­ï¼š

- $M_0(p_r) = capacity$ ï¼šåˆå§‹æ ‡è®°æ•°ï¼ˆèµ„æºå®¹é‡ï¼‰
- $K(p_r)$ ï¼šåº“æ‰€å®¹é‡ä¸Šç•Œï¼ˆæœ‰ç•Œæ€§ï¼‰

**æ˜ å°„ç­–ç•¥å¯¹æ¯”**ï¼š

| èµ„æºç±»å‹ | æ˜ å°„ç­–ç•¥ | æ ‡è®°å«ä¹‰ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **å¯å†ç”Ÿèµ„æº** | å•ä¸ªåº“æ‰€ | å¯ç”¨æ•°é‡ | CPUæ ¸å¿ƒæ•° |
| **æ¶ˆè€—æ€§èµ„æº** | å•ä¸ªåº“æ‰€ | å‰©ä½™æ•°é‡ | å†…å­˜æ±  |
| **å…±äº«èµ„æº** | å•ä¸ªåº“æ‰€+å¤šå¼§ | å…±äº«çŠ¶æ€ | å…±äº«ç¼“å­˜ |
| **ç‹¬å èµ„æº** | å•ä¸ªåº“æ‰€ï¼ˆå®¹é‡1ï¼‰ | å ç”¨/ç©ºé—² | äº’æ–¥é” |

### 3.2 èµ„æºç±»å‹å»ºæ¨¡

**å¯å†ç”Ÿèµ„æº**ï¼ˆCPUã€å†…å­˜ï¼‰ï¼š

```python
def model_renewable_resource(resource_name, capacity):
    """
    å¯å†ç”Ÿèµ„æºçš„Petriç½‘å»ºæ¨¡
    èµ„æºä½¿ç”¨åä¼šå½’è¿˜
    """
    pn = PetriNet()

    # èµ„æºåº“æ‰€
    pn.add_place(f'p_{resource_name}', tokens=capacity)

    # ä»»åŠ¡å˜è¿ï¼ˆä½¿ç”¨èµ„æºï¼‰
    pn.add_transition(f't_use_{resource_name}')
    pn.add_transition(f't_release_{resource_name}')

    # ä¸´æ—¶å ç”¨åº“æ‰€
    pn.add_place(f'p_{resource_name}_in_use', tokens=0)

    # å¼§ï¼šèµ„æºå¾ªç¯
    pn.add_arc(f'p_{resource_name}', f't_use_{resource_name}')
    pn.add_arc(f't_use_{resource_name}', f'p_{resource_name}_in_use')
    pn.add_arc(f'p_{resource_name}_in_use', f't_release_{resource_name}')
    pn.add_arc(f't_release_{resource_name}', f'p_{resource_name}')

    return pn

# ç¤ºä¾‹ï¼š4ä¸ªCPUæ ¸å¿ƒ
cpu_pn = model_renewable_resource('cpu', capacity=4)
```

**æ¶ˆè€—æ€§èµ„æº**ï¼ˆç”µæ± ç”µé‡ï¼‰ï¼š

```python
def model_consumable_resource(resource_name, initial_capacity):
    """
    æ¶ˆè€—æ€§èµ„æºçš„Petriç½‘å»ºæ¨¡
    èµ„æºä½¿ç”¨åä¸å½’è¿˜
    """
    pn = PetriNet()

    # èµ„æºåº“æ‰€ï¼ˆåªå‡ä¸å¢ï¼‰
    pn.add_place(f'p_{resource_name}', tokens=initial_capacity)

    # æ¶ˆè€—å˜è¿
    pn.add_transition(f't_consume_{resource_name}')

    # æ¶ˆè€—åçš„åº“æ‰€ï¼ˆä¸å›æµï¼‰
    pn.add_place(f'p_{resource_name}_consumed', tokens=0)

    # å¼§ï¼šå•å‘æ¶ˆè€—
    pn.add_arc(f'p_{resource_name}', f't_consume_{resource_name}')
    pn.add_arc(f't_consume_{resource_name}', f'p_{resource_name}_consumed')

    return pn

# ç¤ºä¾‹ï¼š100å•ä½ç”µé‡
battery_pn = model_consumable_resource('battery', initial_capacity=100)
```

### 3.3 èµ„æºå®¹é‡å»ºæ¨¡

**æœ‰ç•Œèµ„æº**ï¼š

```python
def model_bounded_resource(resource_name, min_capacity, max_capacity):
    """
    æœ‰ç•Œèµ„æºçš„Petriç½‘å»ºæ¨¡
    èµ„æºæ•°é‡æœ‰ä¸Šä¸‹ç•Œé™åˆ¶
    """
    pn = PetriNet()

    # èµ„æºåº“æ‰€ï¼ˆæœ‰ç•Œï¼‰
    pn.add_place(f'p_{resource_name}', tokens=min_capacity)

    # å®¹é‡çº¦æŸï¼šä½¿ç”¨æœ‰ç•ŒPetriç½‘æ€§è´¨
    # K(p_resource) = max_capacity

    return pn, max_capacity  # è¿”å›å®¹é‡ä¸Šç•Œ

# ç¤ºä¾‹ï¼šå†…å­˜æ± ï¼ˆæœ€å°2GBï¼Œæœ€å¤§8GBï¼‰
memory_pn, max_mem = model_bounded_resource('memory', min_capacity=2, max_capacity=8)
```

---

## 4 ä¾èµ–å…³ç³»åˆ°å¼§çš„æ˜ å°„

### 4.1 æ•°æ®ä¾èµ–

**å®šä¹‰1.24ï¼ˆæ•°æ®ä¾èµ–æ˜ å°„ï¼‰**ï¼š

å¦‚æœä»»åŠ¡ $t_2$ çš„è¾“å…¥æ•°æ®æ¥è‡ªä»»åŠ¡ $t_1$ çš„è¾“å‡ºï¼Œåˆ™ï¼š

$$
t_1 \xrightarrow{p_{data}} t_2
$$

**ç¤ºä¾‹ï¼šæ•°æ®æµæ°´çº¿**

```python
def model_data_dependency(task1, task2, data_name):
    """
    æ•°æ®ä¾èµ–çš„Petriç½‘å»ºæ¨¡
    task1 -> data -> task2
    """
    pn = PetriNet()

    # ä»»åŠ¡å˜è¿
    pn.add_transition(f't_{task1}')
    pn.add_transition(f't_{task2}')

    # æ•°æ®åº“æ‰€ï¼ˆtask1çš„è¾“å‡ºï¼Œtask2çš„è¾“å…¥ï¼‰
    pn.add_place(f'p_{data_name}', tokens=0)

    # task1çš„è¾“å…¥ï¼ˆå‡è®¾æœ‰ï¼‰
    pn.add_place(f'p_{task1}_ready', tokens=1)
    pn.add_arc(f'p_{task1}_ready', f't_{task1}')

    # æ•°æ®ä¾èµ–å¼§
    pn.add_arc(f't_{task1}', f'p_{data_name}')      # task1äº§ç”Ÿæ•°æ®
    pn.add_arc(f'p_{data_name}', f't_{task2}')      # task2æ¶ˆè´¹æ•°æ®

    # task2çš„è¾“å‡º
    pn.add_place(f'p_{task2}_done', tokens=0)
    pn.add_arc(f't_{task2}', f'p_{task2}_done')

    return pn

# ç¤ºä¾‹ï¼šETLæµæ°´çº¿
# Extract -> Transform -> Load
pn = model_data_dependency('extract', 'transform', 'raw_data')
pn2 = model_data_dependency('transform', 'load', 'clean_data')
```

### 4.2 èµ„æºä¾èµ–

**å…±äº«èµ„æºä¾èµ–**ï¼š

```python
def model_resource_dependency(tasks, resource_name, resource_amount):
    """
    å¤šä¸ªä»»åŠ¡å…±äº«åŒä¸€èµ„æº
    """
    pn = PetriNet()

    # å…±äº«èµ„æºåº“æ‰€
    pn.add_place(f'p_{resource_name}', tokens=resource_amount)

    for task in tasks:
        # ä»»åŠ¡å˜è¿
        pn.add_transition(f't_{task}')

        # ä»»åŠ¡çŠ¶æ€åº“æ‰€
        pn.add_place(f'p_{task}_ready', tokens=1)
        pn.add_place(f'p_{task}_done', tokens=0)

        # èµ„æºä¾èµ–å¼§
        pn.add_arc(f'p_{task}_ready', f't_{task}')
        pn.add_arc(f'p_{resource_name}', f't_{task}', weight=1)  # è·å–èµ„æº
        pn.add_arc(f't_{task}', f'p_{resource_name}', weight=1)  # é‡Šæ”¾èµ„æº
        pn.add_arc(f't_{task}', f'p_{task}_done')

    return pn

# ç¤ºä¾‹ï¼š3ä¸ªä»»åŠ¡å…±äº«2ä¸ªCPUæ ¸å¿ƒ
tasks = ['task1', 'task2', 'task3']
pn = model_resource_dependency(tasks, 'cpu', resource_amount=2)
```

### 4.3 æ—¶åºä¾èµ–

**é¡ºåºä¾èµ–**ï¼ˆHappens-Beforeï¼‰ï¼š

```text
task1 -> task2 -> task3

Petriç½‘è¡¨ç¤ºï¼š

[p_start] -> [t_task1] -> [p_between1_2] -> [t_task2] -> [p_between2_3] -> [t_task3] -> [p_end]
```

**å®ç°**ï¼š

```python
def model_sequential_dependency(tasks):
    """
    é¡ºåºä¾èµ–çš„Petriç½‘å»ºæ¨¡
    tasksæŒ‰é¡ºåºæ‰§è¡Œ
    """
    pn = PetriNet()

    # åˆå§‹åº“æ‰€
    pn.add_place('p_start', tokens=1)

    for i, task in enumerate(tasks):
        # ä»»åŠ¡å˜è¿
        pn.add_transition(f't_{task}')

        if i == 0:
            # ç¬¬ä¸€ä¸ªä»»åŠ¡ä»p_startå¼€å§‹
            pn.add_arc('p_start', f't_{task}')
        else:
            # åç»­ä»»åŠ¡ä»å‰ä¸€ä¸ªä»»åŠ¡çš„è¾“å‡ºå¼€å§‹
            pn.add_arc(f'p_after_{tasks[i-1]}', f't_{task}')

        # ä»»åŠ¡å®Œæˆåçš„åº“æ‰€
        if i < len(tasks) - 1:
            pn.add_place(f'p_after_{task}', tokens=0)
            pn.add_arc(f't_{task}', f'p_after_{task}')
        else:
            # æœ€åä¸€ä¸ªä»»åŠ¡è¾“å‡ºåˆ°p_end
            pn.add_place('p_end', tokens=0)
            pn.add_arc(f't_{task}', 'p_end')

    return pn

# ç¤ºä¾‹ï¼šPipeline
pipeline_tasks = ['fetch', 'decode', 'execute', 'writeback']
pn = model_sequential_dependency(pipeline_tasks)
```

---

## 5 è°ƒåº¦ç­–ç•¥åˆ°ç‚¹ç«è§„åˆ™çš„æ˜ å°„

### 5.1 FCFSç­–ç•¥

**å…ˆæ¥å…ˆæœåŠ¡ï¼ˆFirst-Come-First-Servedï¼‰**ï¼š

```python
def fcfs_scheduling_petri_net(tasks):
    """
    FCFSè°ƒåº¦ç­–ç•¥çš„Petriç½‘å»ºæ¨¡
    ä½¿ç”¨é˜Ÿåˆ—åº“æ‰€å®ç°FIFOé¡ºåº
    """
    pn = PetriNet()

    # ä»»åŠ¡é˜Ÿåˆ—åº“æ‰€ï¼ˆFIFOï¼‰
    pn.add_place('p_task_queue', tokens=len(tasks))

    # CPUèµ„æºåº“æ‰€ï¼ˆå•æ ¸ï¼‰
    pn.add_place('p_cpu', tokens=1)

    for task in tasks:
        # ä»»åŠ¡å˜è¿
        pn.add_transition(f't_{task}')

        # ä»»åŠ¡å®Œæˆåº“æ‰€
        pn.add_place(f'p_{task}_done', tokens=0)

        # å¼§ï¼šFCFSé¡ºåº
        pn.add_arc('p_task_queue', f't_{task}')
        pn.add_arc('p_cpu', f't_{task}')
        pn.add_arc(f't_{task}', 'p_cpu')  # CPUé‡Šæ”¾
        pn.add_arc(f't_{task}', f'p_{task}_done')

    return pn
```

### 5.2 ä¼˜å…ˆçº§ç­–ç•¥

**ä¼˜å…ˆçº§è°ƒåº¦**ï¼š

```python
def priority_scheduling_petri_net(tasks_with_priority):
    """
    ä¼˜å…ˆçº§è°ƒåº¦ç­–ç•¥çš„Petriç½‘å»ºæ¨¡
    ä½¿ç”¨ç€è‰²Petriç½‘æˆ–å®ˆå«å˜è¿å®ç°ä¼˜å…ˆçº§
    """
    pn = PetriNet()

    # æŒ‰ä¼˜å…ˆçº§åˆ†ç»„ä»»åŠ¡
    high_priority = [t for t, p in tasks_with_priority if p == 'high']
    low_priority = [t for t, p in tasks_with_priority if p == 'low']

    # é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—
    pn.add_place('p_high_priority_queue', tokens=len(high_priority))
    # ä½ä¼˜å…ˆçº§é˜Ÿåˆ—
    pn.add_place('p_low_priority_queue', tokens=len(low_priority))

    # CPUèµ„æº
    pn.add_place('p_cpu', tokens=1)

    # é«˜ä¼˜å…ˆçº§ä»»åŠ¡å˜è¿ï¼ˆä¼˜å…ˆç‚¹ç«ï¼‰
    for task in high_priority:
        pn.add_transition(f't_{task}_high')
        pn.add_arc('p_high_priority_queue', f't_{task}_high')
        pn.add_arc('p_cpu', f't_{task}_high')
        pn.add_arc(f't_{task}_high', 'p_cpu')

    # ä½ä¼˜å…ˆçº§ä»»åŠ¡å˜è¿ï¼ˆä»…åœ¨é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸ºç©ºæ—¶ç‚¹ç«ï¼‰
    for task in low_priority:
        pn.add_transition(f't_{task}_low')
        pn.add_arc('p_low_priority_queue', f't_{task}_low')
        pn.add_arc('p_cpu', f't_{task}_low')
        pn.add_arc(f't_{task}_low', 'p_cpu')

    return pn
```

### 5.3 æŠ¢å å¼ç­–ç•¥

**æŠ¢å å¼è°ƒåº¦**ï¼š

```python
def preemptive_scheduling_petri_net():
    """
    æŠ¢å å¼è°ƒåº¦ç­–ç•¥çš„Petriç½‘å»ºæ¨¡
    é«˜ä¼˜å…ˆçº§ä»»åŠ¡å¯ä»¥æŠ¢å ä½ä¼˜å…ˆçº§ä»»åŠ¡
    """
    pn = PetriNet()

    # ä»»åŠ¡çŠ¶æ€åº“æ‰€
    pn.add_place('p_high_ready', tokens=1)
    pn.add_place('p_low_ready', tokens=1)
    pn.add_place('p_low_running', tokens=0)
    pn.add_place('p_high_running', tokens=0)

    # CPUèµ„æº
    pn.add_place('p_cpu', tokens=1)

    # ä½ä¼˜å…ˆçº§ä»»åŠ¡å¼€å§‹
    pn.add_transition('t_low_start')
    pn.add_arc('p_low_ready', 't_low_start')
    pn.add_arc('p_cpu', 't_low_start')
    pn.add_arc('t_low_start', 'p_low_running')

    # é«˜ä¼˜å…ˆçº§ä»»åŠ¡æŠ¢å 
    pn.add_transition('t_high_preempt')
    pn.add_arc('p_high_ready', 't_high_preempt')
    pn.add_arc('p_low_running', 't_high_preempt')  # æŠ¢å ä½ä¼˜å…ˆçº§
    pn.add_arc('t_high_preempt', 'p_high_running')
    pn.add_arc('t_high_preempt', 'p_low_ready')    # ä½ä¼˜å…ˆçº§å›åˆ°å°±ç»ª
    pn.add_arc('t_high_preempt', 'p_cpu')

    # é«˜ä¼˜å…ˆçº§ä»»åŠ¡å®Œæˆï¼Œä½ä¼˜å…ˆçº§æ¢å¤
    pn.add_transition('t_high_complete')
    pn.add_arc('p_high_running', 't_high_complete')
    pn.add_arc('t_high_complete', 'p_cpu')

    return pn
```

---

## 6 å®é™…æ¡ˆä¾‹ï¼šKubernetes Podè°ƒåº¦

### 6.1 Podç”Ÿå‘½å‘¨æœŸæ˜ å°„

**Kubernetes PodçŠ¶æ€**ï¼š

```text
Pending -> Running -> Succeeded / Failed
```

**Petriç½‘å»ºæ¨¡**ï¼š

```python
class KubernetesPodPetriNet:
    """
    Kubernetes Podè°ƒåº¦çš„Petriç½‘å»ºæ¨¡
    """

    def __init__(self, pod_name, cpu_request, memory_request):
        self.pn = PetriNet()
        self.pod_name = pod_name
        self.cpu_request = cpu_request
        self.memory_request = memory_request

        self._build_pod_lifecycle()
        self._build_resources()
        self._build_scheduling()

    def _build_pod_lifecycle(self):
        """æ„å»ºPodç”Ÿå‘½å‘¨æœŸ"""
        # PodçŠ¶æ€åº“æ‰€
        self.pn.add_place(f'p_{self.pod_name}_pending', tokens=1)
        self.pn.add_place(f'p_{self.pod_name}_running', tokens=0)
        self.pn.add_place(f'p_{self.pod_name}_succeeded', tokens=0)
        self.pn.add_place(f'p_{self.pod_name}_failed', tokens=0)

        # çŠ¶æ€è½¬æ¢å˜è¿
        self.pn.add_transition(f't_{self.pod_name}_schedule')
        self.pn.add_transition(f't_{self.pod_name}_succeed')
        self.pn.add_transition(f't_{self.pod_name}_fail')

    def _build_resources(self):
        """æ„å»ºèµ„æºæ¨¡å‹"""
        # å…¨å±€èµ„æºåº“æ‰€ï¼ˆé›†ç¾¤çº§åˆ«ï¼‰
        if 'p_cluster_cpu' not in self.pn.places:
            self.pn.add_place('p_cluster_cpu', tokens=16)  # 16æ ¸CPU
        if 'p_cluster_memory' not in self.pn.places:
            self.pn.add_place('p_cluster_memory', tokens=64)  # 64GBå†…å­˜

    def _build_scheduling(self):
        """æ„å»ºè°ƒåº¦é€»è¾‘"""
        # Pending -> Runningï¼ˆéœ€è¦èµ„æºï¼‰
        self.pn.add_arc(f'p_{self.pod_name}_pending', f't_{self.pod_name}_schedule')
        self.pn.add_arc('p_cluster_cpu', f't_{self.pod_name}_schedule',
                         weight=self.cpu_request)
        self.pn.add_arc('p_cluster_memory', f't_{self.pod_name}_schedule',
                         weight=self.memory_request)
        self.pn.add_arc(f't_{self.pod_name}_schedule', f'p_{self.pod_name}_running')

        # Running -> Succeededï¼ˆé‡Šæ”¾èµ„æºï¼‰
        self.pn.add_arc(f'p_{self.pod_name}_running', f't_{self.pod_name}_succeed')
        self.pn.add_arc(f't_{self.pod_name}_succeed', f'p_{self.pod_name}_succeeded')
        self.pn.add_arc(f't_{self.pod_name}_succeed', 'p_cluster_cpu',
                         weight=self.cpu_request)
        self.pn.add_arc(f't_{self.pod_name}_succeed', 'p_cluster_memory',
                         weight=self.memory_request)

        # Running -> Failedï¼ˆé‡Šæ”¾èµ„æºï¼‰
        self.pn.add_arc(f'p_{self.pod_name}_running', f't_{self.pod_name}_fail')
        self.pn.add_arc(f't_{self.pod_name}_fail', f'p_{self.pod_name}_failed')
        self.pn.add_arc(f't_{self.pod_name}_fail', 'p_cluster_cpu',
                         weight=self.cpu_request)
        self.pn.add_arc(f't_{self.pod_name}_fail', 'p_cluster_memory',
                         weight=self.memory_request)
```

### 6.2 èµ„æºè¯·æ±‚ä¸é™åˆ¶

**Resource Requests & Limits**ï¼š

```yaml
# Kubernetes Podå®šä¹‰
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
spec:
  containers:
  - name: nginx
    image: nginx:1.21
    resources:
      requests:    # æœ€å°èµ„æºä¿è¯
        cpu: "500m"
        memory: "128Mi"
      limits:      # æœ€å¤§èµ„æºé™åˆ¶
        cpu: "1000m"
        memory: "256Mi"
```

**Petriç½‘è¡¨ç¤º**ï¼š

```python
def model_pod_with_limits(pod_name, cpu_request, cpu_limit, mem_request, mem_limit):
    """
    å¸¦èµ„æºè¯·æ±‚å’Œé™åˆ¶çš„Pod Petriç½‘å»ºæ¨¡
    """
    pn = PetriNet()

    # èµ„æºåº“æ‰€ï¼ˆé›†ç¾¤æ€»èµ„æºï¼‰
    pn.add_place('p_cluster_cpu', tokens=16)
    pn.add_place('p_cluster_memory', tokens=64)

    # Podè°ƒåº¦å˜è¿ï¼ˆéœ€è¦æ»¡è¶³requestï¼‰
    pn.add_transition('t_schedule')
    pn.add_arc('p_cluster_cpu', 't_schedule', weight=cpu_request)
    pn.add_arc('p_cluster_memory', 't_schedule', weight=mem_request)

    # Podè¿è¡Œåº“æ‰€ï¼ˆå®é™…å¯èƒ½ä½¿ç”¨åˆ°limitï¼‰
    pn.add_place('p_pod_running', tokens=0)
    pn.add_arc('t_schedule', 'p_pod_running')

    # èµ„æºè¶…é™å¤„ç†ï¼ˆOOMKilledï¼‰
    if cpu_limit or mem_limit:
        pn.add_transition('t_oom_kill')
        pn.add_arc('p_pod_running', 't_oom_kill')
        # æ£€æŸ¥æ˜¯å¦è¶…è¿‡limitï¼ˆéœ€è¦å®ˆå«æ¡ä»¶ï¼‰

    return pn
```

### 6.3 äº²å’Œæ€§ä¸åäº²å’Œæ€§

**Node Affinity**ï¼š

```python
def model_pod_affinity(pod_name, preferred_nodes):
    """
    PodèŠ‚ç‚¹äº²å’Œæ€§çš„Petriç½‘å»ºæ¨¡
    """
    pn = PetriNet()

    # Pod pendingçŠ¶æ€
    pn.add_place(f'p_{pod_name}_pending', tokens=1)

    # æ¯ä¸ªèŠ‚ç‚¹ä¸€ä¸ªè°ƒåº¦å˜è¿
    for node in preferred_nodes:
        pn.add_transition(f't_schedule_to_{node}')
        pn.add_place(f'p_{node}_running', tokens=0)

        # äº²å’Œæ€§ï¼šä¼˜å…ˆè°ƒåº¦åˆ°preferredèŠ‚ç‚¹
        pn.add_arc(f'p_{pod_name}_pending', f't_schedule_to_{node}')
        pn.add_arc(f't_schedule_to_{node}', f'p_{node}_running')

    return pn
```

### 6.4 Pythonå®Œæ•´å®ç°

```python
# å®Œæ•´ç¤ºä¾‹ï¼š3ä¸ªPodè°ƒåº¦åˆ°Kubernetesé›†ç¾¤

# åˆ›å»ºé›†ç¾¤Petriç½‘
cluster_pn = PetriNet()

# é›†ç¾¤èµ„æº
cluster_pn.add_place('p_cluster_cpu', tokens=16)    # 16æ ¸
cluster_pn.add_place('p_cluster_memory', tokens=64) # 64GB

# Podå®šä¹‰
pods = [
    {'name': 'nginx', 'cpu': 2, 'memory': 4},
    {'name': 'redis', 'cpu': 1, 'memory': 2},
    {'name': 'mysql', 'cpu': 4, 'memory': 8},
]

# ä¸ºæ¯ä¸ªPodåˆ›å»ºPetriç½‘
for pod in pods:
    pod_pn = KubernetesPodPetriNet(
        pod_name=pod['name'],
        cpu_request=pod['cpu'],
        memory_request=pod['memory']
    )
    # åˆå¹¶åˆ°é›†ç¾¤Petriç½‘
    # cluster_pn.merge(pod_pn.pn)

# æ¨¡æ‹Ÿè°ƒåº¦
print("Initial cluster resources:")
print(f"  CPU: {cluster_pn.marking['p_cluster_cpu']}")
print(f"  Memory: {cluster_pn.marking['p_cluster_memory']}")

# è°ƒåº¦nginx Pod
if cluster_pn.is_enabled('t_nginx_schedule'):
    cluster_pn.fire('t_nginx_schedule')
    print("\nScheduled nginx Pod")
    print(f"  CPU: {cluster_pn.marking['p_cluster_cpu']}")
    print(f"  Memory: {cluster_pn.marking['p_cluster_memory']}")

# è°ƒåº¦redis Pod
if cluster_pn.is_enabled('t_redis_schedule'):
    cluster_pn.fire('t_redis_schedule')
    print("\nScheduled redis Pod")
    print(f"  CPU: {cluster_pn.marking['p_cluster_cpu']}")
    print(f"  Memory: {cluster_pn.marking['p_cluster_memory']}")

# å°è¯•è°ƒåº¦mysql Pod
if cluster_pn.is_enabled('t_mysql_schedule'):
    cluster_pn.fire('t_mysql_schedule')
    print("\nScheduled mysql Pod")
else:
    print("\nCannot schedule mysql Pod - insufficient resources")
    print(f"  Available CPU: {cluster_pn.marking['p_cluster_cpu']}")
    print(f"  Required CPU: {pods[2]['cpu']}")
```

---

## 7 æ˜ å°„å®Œæ•´æ€§åˆ†æ

**å®šç†1.25ï¼ˆæ˜ å°„å®Œå¤‡æ€§ï¼‰**ï¼š

æ˜ å°„ $\phi: S \to PN$ æ˜¯**å®Œå¤‡çš„**ï¼Œå½“ä¸”ä»…å½“ï¼š

1. **å¯è°ƒåº¦æ€§ä¿æŒ**ï¼š$\forall schedule \in S$ï¼Œå­˜åœ¨å¯¹åº”çš„ç‚¹ç«åºåˆ— $\sigma \in PN$
2. **èµ„æºçº¦æŸä¿æŒ**ï¼š$\forall resource\_limit \in S$ï¼Œå­˜åœ¨å¯¹åº”çš„åº“æ‰€æœ‰ç•Œæ€§
3. **ä¾èµ–å…³ç³»ä¿æŒ**ï¼š$\forall dependency \in S$ï¼Œå­˜åœ¨å¯¹åº”çš„å¼§è¿æ¥

**å®šç†1.26ï¼ˆæ˜ å°„å”¯ä¸€æ€§ï¼‰**ï¼š

åœ¨åˆç†çš„æ˜ å°„è§„åˆ™ä¸‹ï¼Œè°ƒåº¦ç³»ç»Ÿ $S$ åˆ°Petriç½‘ $PN$ çš„æ˜ å°„æ˜¯**å”¯ä¸€çš„**ï¼ˆåŒæ„æ„ä¹‰ä¸‹ï¼‰ã€‚

**è¯æ˜æ€è·¯**ï¼š

1. ä»»åŠ¡æ˜ å°„åˆ°å˜è¿æ˜¯è‡ªç„¶çš„ä¸€ä¸€å¯¹åº”
2. èµ„æºæ˜ å°„åˆ°åº“æ‰€ä¿æŒæ•°é‡å…³ç³»
3. ä¾èµ–å…³ç³»æ˜ å°„åˆ°å¼§ä¿æŒæ‹“æ‰‘ç»“æ„

---

## 8 è·¨è§†è§’é“¾æ¥

**Petriç½‘ç†è®ºåŸºç¡€**ï¼š

- [10_Petriç½‘ç†è®º/10.1 Petriç½‘åŸºç¡€ç†è®º](../../../formal_lang_view/10_Petriç½‘ç†è®º/10.1_Petriç½‘åŸºç¡€ç†è®º.md)
- [01.1 Petriç½‘åŸºæœ¬æ¦‚å¿µä¸å®šä¹‰](01.1_Petriç½‘åŸºæœ¬æ¦‚å¿µä¸å®šä¹‰.md)

**è°ƒåº¦ç³»ç»Ÿåº”ç”¨**ï¼š

- [06_è°ƒåº¦æ¨¡å‹/06.2 OSå†…æ ¸è°ƒåº¦](../../06_è°ƒåº¦æ¨¡å‹/06.2_OSå†…æ ¸è°ƒåº¦.md)
- [31_å¤šé›†ç¾¤è°ƒåº¦](../../31_å¤šé›†ç¾¤è°ƒåº¦/README.md)

**å®é™…æ¡ˆä¾‹**ï¼š

- [05_è™šæ‹ŸåŒ–å®¹å™¨åŒ–æ²™ç›’åŒ–/05.5 Kubernetes](../../05_è™šæ‹ŸåŒ–å®¹å™¨åŒ–æ²™ç›’åŒ–/05.5_Kubernetes.md)

---

**è¿”å›**: [01 è°ƒåº¦ç³»ç»Ÿçš„Petriç½‘åŸºç¡€](README.md)

**å‚è€ƒæ–‡çŒ®**ï¼š

1. van der Aalst, W.M.P. (2016). "Process Mining: Data Science in Action"
2. Jensen, K., & Kristensen, L.M. (2009). "Coloured Petri Nets: Modelling and Validation"
3. Kubernetes Documentation: "Pod Scheduling" - https://kubernetes.io/docs/concepts/scheduling-eviction/

---

**æœ€åæ›´æ–°**: 2025-12-02
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ
