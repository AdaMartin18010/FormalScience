# 02.2 åŒæ­¥æœºåˆ¶çš„Petriç½‘å»ºæ¨¡æ–¹æ³•

> **å­ä¸»é¢˜**: 02.2
> **æ‰€å±ä¸»é¢˜**: 02 å¹¶å‘è°ƒåº¦çš„Petriç½‘å»ºæ¨¡
> **æœ€åæ›´æ–°**: 2025-12-02

---

## ğŸ“‹ ç›®å½•

- [02.2 åŒæ­¥æœºåˆ¶çš„Petriç½‘å»ºæ¨¡æ–¹æ³•](#022-åŒæ­¥æœºåˆ¶çš„petriç½‘å»ºæ¨¡æ–¹æ³•)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 åŒæ­¥æœºåˆ¶æ¦‚è¿°](#1-åŒæ­¥æœºåˆ¶æ¦‚è¿°)
  - [2 å±éšœåŒæ­¥ï¼ˆBarrier Synchronizationï¼‰](#2-å±éšœåŒæ­¥barrier-synchronization)
  - [3 ä¿¡å·é‡æœºåˆ¶](#3-ä¿¡å·é‡æœºåˆ¶)
  - [4 è¯»å†™é”](#4-è¯»å†™é”)
  - [5 æ¡ä»¶å˜é‡](#5-æ¡ä»¶å˜é‡)
  - [6 å®é™…æ¡ˆä¾‹ï¼šMapReduceåŒæ­¥](#6-å®é™…æ¡ˆä¾‹mapreduceåŒæ­¥)

---

## 1 åŒæ­¥æœºåˆ¶æ¦‚è¿°

**åŒæ­¥ï¼ˆSynchronizationï¼‰** æ˜¯å¹¶å‘ç³»ç»Ÿä¸­åè°ƒå¤šä¸ªä»»åŠ¡æ‰§è¡Œçš„å…³é”®æœºåˆ¶ã€‚

**Petriç½‘ä¸­çš„åŒæ­¥è¡¨ç¤º**ï¼š

| åŒæ­¥æœºåˆ¶ | Petriç½‘æ¨¡å¼ | ç‰¹å¾ |
|---------|------------|------|
| å±éšœåŒæ­¥ | AND-Joinå˜è¿ | ç­‰å¾…æ‰€æœ‰åˆ†æ”¯å®Œæˆ |
| ä¿¡å·é‡ | èµ„æºåº“æ‰€ | æ§åˆ¶è®¿é—®æ•°é‡ |
| äº’æ–¥é” | 1-æœ‰ç•Œåº“æ‰€ | äº’æ–¥è®¿é—® |
| è¯»å†™é” | å¤šåº“æ‰€ç»„åˆ | è¯»å†™åˆ†ç¦» |
| æ¡ä»¶å˜é‡ | å®ˆå«å˜è¿ | æ¡ä»¶æ»¡è¶³æ‰æ‰§è¡Œ |

---

## 2 å±éšœåŒæ­¥ï¼ˆBarrier Synchronizationï¼‰

**å®šä¹‰2.21**ï¼šå±éšœåŒæ­¥è¦æ±‚æ‰€æœ‰ä»»åŠ¡åˆ°è¾¾åŒæ­¥ç‚¹åæ‰èƒ½ç»§ç»­ã€‚

**Petriç½‘è¡¨ç¤º**ï¼š

```text
[t_task1] â†’ [p_barrier1] â†˜
[t_task2] â†’ [p_barrier2] â†’ [t_sync] â†’ [p_continue]
[t_task3] â†’ [p_barrier3] â†—
```

**Pythonå®ç°**ï¼š

```python
def create_barrier_synchronization(tasks, barrier_name):
    """å±éšœåŒæ­¥Petriç½‘"""
    pn = PetriNet()

    # Forkï¼šå¹¶è¡Œå¯åŠ¨æ‰€æœ‰ä»»åŠ¡
    pn.add_place('p_start', tokens=1)
    pn.add_transition('t_fork')
    pn.add_arc('p_start', 't_fork')

    # æ¯ä¸ªä»»åŠ¡
    for task in tasks:
        pn.add_place(f'p_{task}_ready', tokens=0)
        pn.add_arc('t_fork', f'p_{task}_ready')

        pn.add_transition(f't_{task}')
        pn.add_arc(f'p_{task}_ready', f't_{task}')

        # åˆ°è¾¾å±éšœ
        pn.add_place(f'p_{task}_at_barrier', tokens=0)
        pn.add_arc(f't_{task}', f'p_{task}_at_barrier')

    # å±éšœåŒæ­¥å˜è¿ï¼ˆéœ€è¦æ‰€æœ‰ä»»åŠ¡åˆ°è¾¾ï¼‰
    pn.add_transition(f't_{barrier_name}_sync')
    for task in tasks:
        pn.add_arc(f'p_{task}_at_barrier', f't_{barrier_name}_sync')

    # ç»§ç»­æ‰§è¡Œ
    pn.add_place('p_after_barrier', tokens=0)
    pn.add_arc(f't_{barrier_name}_sync', 'p_after_barrier')

    return pn

# ä½¿ç”¨ç¤ºä¾‹ï¼šå¹¶è¡Œè®¡ç®—ä¸­çš„å±éšœ
barrier_pn = create_barrier_synchronization(
    tasks=['Worker1', 'Worker2', 'Worker3', 'Worker4'],
    barrier_name='GlobalBarrier'
)
```

---

## 3 ä¿¡å·é‡æœºåˆ¶

**å®šä¹‰2.22**ï¼šä¿¡å·é‡æ§åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„ä»»åŠ¡æ•°é‡ã€‚

**Petriç½‘è¡¨ç¤º**ï¼š

```python
def create_semaphore(name, initial_value):
    """
    ä¿¡å·é‡çš„Petriç½‘å»ºæ¨¡

    Args:
        name: ä¿¡å·é‡åç§°
        initial_value: åˆå§‹å€¼ï¼ˆå…è®¸çš„å¹¶å‘æ•°ï¼‰
    """
    pn = PetriNet()

    # ä¿¡å·é‡åº“æ‰€
    pn.add_place(f'p_sem_{name}', tokens=initial_value)

    # Pæ“ä½œï¼ˆè·å–ä¿¡å·é‡ï¼‰
    pn.add_transition(f't_P_{name}')
    pn.add_arc(f'p_sem_{name}', f't_P_{name}')

    # ä¸´ç•ŒåŒºåº“æ‰€
    pn.add_place(f'p_critical_{name}', tokens=0)
    pn.add_arc(f't_P_{name}', f'p_critical_{name}')

    # Væ“ä½œï¼ˆé‡Šæ”¾ä¿¡å·é‡ï¼‰
    pn.add_transition(f't_V_{name}')
    pn.add_arc(f'p_critical_{name}', f't_V_{name}')
    pn.add_arc(f't_V_{name}', f'p_sem_{name}')

    return pn

# ç¤ºä¾‹ï¼šé™åˆ¶åŒæ—¶è®¿é—®æ•°æ®åº“çš„è¿æ¥æ•°
db_semaphore = create_semaphore('database', initial_value=10)
```

---

## 4 è¯»å†™é”

**è¯»å†™é”Petriç½‘æ¨¡å‹**ï¼š

```python
def create_readers_writers_lock():
    """
    è¯»å†™é”çš„Petriç½‘å»ºæ¨¡

    è§„åˆ™ï¼š
    - å¤šä¸ªè¯»è€…å¯ä»¥åŒæ—¶è¯»
    - åªæœ‰ä¸€ä¸ªå†™è€…å¯ä»¥å†™
    - è¯»å†™äº’æ–¥
    """
    pn = PetriNet()

    # çŠ¶æ€åº“æ‰€
    pn.add_place('p_free', tokens=1)        # ç©ºé—²çŠ¶æ€
    pn.add_place('p_reading', tokens=0)     # è¯»çŠ¶æ€ï¼ˆå¯å¤šä¸ªï¼‰
    pn.add_place('p_writing', tokens=0)     # å†™çŠ¶æ€ï¼ˆæœ€å¤š1ä¸ªï¼‰
    pn.add_place('p_readers_count', tokens=0)  # è¯»è€…è®¡æ•°

    # å¼€å§‹è¯»
    pn.add_transition('t_start_read')
    pn.add_arc('p_free', 't_start_read')
    pn.add_arc('t_start_read', 'p_reading')
    pn.add_arc('t_start_read', 'p_readers_count')

    # ç»§ç»­è¯»ï¼ˆå·²æœ‰è¯»è€…æ—¶ï¼‰
    pn.add_transition('t_continue_read')
    pn.add_arc('p_reading', 't_continue_read')
    pn.add_arc('t_continue_read', 'p_reading')
    pn.add_arc('t_continue_read', 'p_readers_count')

    # ç»“æŸè¯»
    pn.add_transition('t_end_read')
    pn.add_arc('p_readers_count', 't_end_read')
    # å¦‚æœæ˜¯æœ€åä¸€ä¸ªè¯»è€…ï¼Œæ¢å¤freeçŠ¶æ€
    pn.add_transition('t_last_reader')
    pn.add_arc('p_reading', 't_last_reader')
    pn.add_arc('p_readers_count', 't_last_reader')
    pn.add_arc('t_last_reader', 'p_free')

    # å¼€å§‹å†™ï¼ˆéœ€è¦freeçŠ¶æ€ï¼‰
    pn.add_transition('t_start_write')
    pn.add_arc('p_free', 't_start_write')
    pn.add_arc('t_start_write', 'p_writing')

    # ç»“æŸå†™
    pn.add_transition('t_end_write')
    pn.add_arc('p_writing', 't_end_write')
    pn.add_arc('t_end_write', 'p_free')

    return pn
```

---

## 5 æ¡ä»¶å˜é‡

**æ¡ä»¶å˜é‡Petriç½‘æ¨¡å‹**ï¼š

```python
def create_condition_variable():
    """
    æ¡ä»¶å˜é‡çš„Petriç½‘å»ºæ¨¡

    æ¨¡å¼ï¼š
    1. wait(): ç­‰å¾…æ¡ä»¶æ»¡è¶³
    2. signal(): é€šçŸ¥ä¸€ä¸ªç­‰å¾…è€…
    3. broadcast(): é€šçŸ¥æ‰€æœ‰ç­‰å¾…è€…
    """
    pn = PetriNet()

    # æ¡ä»¶åº“æ‰€
    pn.add_place('p_condition', tokens=0)

    # ç­‰å¾…é˜Ÿåˆ—
    pn.add_place('p_waiting', tokens=0)

    # waitæ“ä½œ
    pn.add_transition('t_wait')
    pn.add_arc('t_wait', 'p_waiting')

    # signalæ“ä½œï¼ˆå”¤é†’ä¸€ä¸ªï¼‰
    pn.add_transition('t_signal')
    pn.add_arc('p_condition', 't_signal')
    pn.add_arc('p_waiting', 't_signal')
    pn.add_place('p_resumed', tokens=0)
    pn.add_arc('t_signal', 'p_resumed')

    # broadcastæ“ä½œï¼ˆå”¤é†’æ‰€æœ‰ï¼‰
    # éœ€è¦çŸ¥é“ç­‰å¾…è€…æ•°é‡ï¼ˆç®€åŒ–å®ç°ï¼‰

    return pn
```

---

## 6 å®é™…æ¡ˆä¾‹ï¼šMapReduceåŒæ­¥

```python
def create_mapreduce_with_barrier():
    """
    MapReduceçš„Petriç½‘å»ºæ¨¡ï¼ˆå¸¦å±éšœåŒæ­¥ï¼‰

    æµç¨‹ï¼š
    1. Splitæ•°æ®
    2. å¹¶è¡ŒMapæ“ä½œ
    3. å±éšœåŒæ­¥
    4. Shuffle
    5. å¹¶è¡ŒReduceæ“ä½œ
    6. æ±‡æ€»ç»“æœ
    """
    pn = PetriNet()

    num_mappers = 4
    num_reducers = 2

    # Splité˜¶æ®µ
    pn.add_place('p_input', tokens=1)
    pn.add_transition('t_split')
    pn.add_arc('p_input', 't_split')

    # Mapé˜¶æ®µï¼ˆå¹¶è¡Œï¼‰
    mappers = [f'Mapper{i}' for i in range(num_mappers)]
    for mapper in mappers:
        pn.add_place(f'p_{mapper}_ready', tokens=0)
        pn.add_arc('t_split', f'p_{mapper}_ready')

        pn.add_transition(f't_{mapper}')
        pn.add_arc(f'p_{mapper}_ready', f't_{mapper}')

        pn.add_place(f'p_{mapper}_done', tokens=0)
        pn.add_arc(f't_{mapper}', f'p_{mapper}_done')

    # å±éšœåŒæ­¥ï¼ˆç­‰å¾…æ‰€æœ‰Mapperå®Œæˆï¼‰
    pn.add_transition('t_barrier')
    for mapper in mappers:
        pn.add_arc(f'p_{mapper}_done', 't_barrier')

    # Shuffleé˜¶æ®µ
    pn.add_place('p_shuffled', tokens=0)
    pn.add_arc('t_barrier', 'p_shuffled')

    pn.add_transition('t_shuffle')
    pn.add_arc('p_shuffled', 't_shuffle')

    # Reduceé˜¶æ®µï¼ˆå¹¶è¡Œï¼‰
    reducers = [f'Reducer{i}' for i in range(num_reducers)]
    for reducer in reducers:
        pn.add_place(f'p_{reducer}_ready', tokens=0)
        pn.add_arc('t_shuffle', f'p_{reducer}_ready')

        pn.add_transition(f't_{reducer}')
        pn.add_arc(f'p_{reducer}_ready', f't_{reducer}')

        pn.add_place(f'p_{reducer}_done', tokens=0)
        pn.add_arc(f't_{reducer}', f'p_{reducer}_done')

    # æœ€ç»ˆæ±‡æ€»
    pn.add_transition('t_collect')
    for reducer in reducers:
        pn.add_arc(f'p_{reducer}_done', 't_collect')

    pn.add_place('p_output', tokens=0)
    pn.add_arc('t_collect', 'p_output')

    return pn

# è¿è¡ŒMapReduce
mr_pn = create_mapreduce_with_barrier()
print("MapReduce Petri Net created")
print(f"  Mappers: 4, Reducers: 2")
print(f"  Max concurrency in Map phase: 4")
print(f"  Max concurrency in Reduce phase: 2")
```

---

**è¿”å›**: [02 å¹¶å‘è°ƒåº¦çš„Petriç½‘å»ºæ¨¡](README.md)
