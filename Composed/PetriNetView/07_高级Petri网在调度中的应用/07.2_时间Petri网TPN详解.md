# 07.2 æ—¶é—´Petriç½‘TPNè¯¦è§£

> **å­ä¸»é¢˜**: 07.2
> **æ‰€å±ä¸»é¢˜**: 07 é«˜çº§Petriç½‘åœ¨è°ƒåº¦ä¸­çš„åº”ç”¨
> **æœ€åæ›´æ–°**: 2025-12-02

---

## ğŸ“‹ ç›®å½•

- [07.2 æ—¶é—´Petriç½‘TPNè¯¦è§£](#072-æ—¶é—´petriç½‘tpnè¯¦è§£)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 TPNå½¢å¼åŒ–å®šä¹‰](#1-tpnå½¢å¼åŒ–å®šä¹‰)
  - [2 æ—¶é—´åŒºé—´ã€ç´§æ€¥æ€§ã€å»¶è¿Ÿ](#2-æ—¶é—´åŒºé—´ç´§æ€¥æ€§å»¶è¿Ÿ)
  - [3 æ—¶é—´å¯è¾¾æ€§åˆ†æ](#3-æ—¶é—´å¯è¾¾æ€§åˆ†æ)
  - [4 å®é™…æ¡ˆä¾‹ï¼šå®æ—¶åµŒå…¥å¼ç³»ç»Ÿè°ƒåº¦](#4-å®é™…æ¡ˆä¾‹å®æ—¶åµŒå…¥å¼ç³»ç»Ÿè°ƒåº¦)

---

## 1 TPNå½¢å¼åŒ–å®šä¹‰

**å®šä¹‰7.21ï¼ˆæ—¶é—´Petriç½‘ï¼‰**ï¼š

$$
TPN = (P, T, F, W, M_0, I)
$$

å…¶ä¸­ $I: T \to \mathbb{Q}^+ \times (\mathbb{Q}^+ \cup \{\infty\})$ æ˜¯æ—¶é—´åŒºé—´å‡½æ•°ã€‚

å¯¹äºå˜è¿ $t$ï¼Œ$I(t) = [a, b]$ è¡¨ç¤ºï¼š

- **æœ€æ—©ç‚¹ç«æ—¶é—´**ï¼ˆEFTï¼‰ï¼š$a$
- **æœ€æ™šç‚¹ç«æ—¶é—´**ï¼ˆLFTï¼‰ï¼š$b$

**è¯­ä¹‰**ï¼š

- å˜è¿ä½¿èƒ½åï¼Œå¿…é¡»åœ¨æ—¶é—´åŒºé—´ $[a, b]$ å†…ç‚¹ç«
- å¦‚æœåˆ°æ—¶é—´ $b$ è¿˜æœªç‚¹ç«ï¼Œåˆ™å¿…é¡»ç«‹å³ç‚¹ç«ï¼ˆå¼ºåˆ¶æ€§ï¼‰

---

## 2 æ—¶é—´åŒºé—´ã€ç´§æ€¥æ€§ã€å»¶è¿Ÿ

**æ—¶é—´è¯­ä¹‰**ï¼š

```text
tä½¿èƒ½æ—¶é—´: enable_time(t)
å½“å‰æ—¶é—´: current_time

ç‚¹ç«æ¡ä»¶:
  enable_time(t) + a â‰¤ current_time â‰¤ enable_time(t) + b
```

**Pythonå®ç°**ï¼š

```python
class TimedPetriNet:
    """æ—¶é—´Petriç½‘"""

    def __init__(self):
        self.places = set()
        self.transitions = {}  # {name: (eft, lft)}
        self.arcs = {}
        self.marking = {}
        self.enabled_times = {}  # è®°å½•å˜è¿ä½¿èƒ½æ—¶é—´

    def add_timed_transition(self, name, eft, lft):
        """æ·»åŠ æ—¶é—´å˜è¿"""
        self.transitions[name] = (eft, lft)

    def fire(self, transition, current_time):
        """åœ¨æŒ‡å®šæ—¶é—´ç‚¹ç«å˜è¿"""
        eft, lft = self.transitions[transition]
        enable_time = self.enabled_times.get(transition, 0)

        # æ£€æŸ¥æ—¶é—´çº¦æŸ
        if not (enable_time + eft <= current_time <= enable_time + lft):
            raise ValueError(f"æ—¶é—´çº¦æŸè¿å: [{enable_time + eft}, {enable_time + lft}]")

        # ç‚¹ç«
        # ï¼ˆå®ç°åŒæ™®é€šPetriç½‘ï¼‰
```

---

## 3 æ—¶é—´å¯è¾¾æ€§åˆ†æ

**çŠ¶æ€ç±»ï¼ˆState Classï¼‰æ–¹æ³•**ï¼š

çŠ¶æ€ç±» $(M, D)$ å…¶ä¸­ï¼š

- $M$ï¼šæ ‡è®°
- $D$ï¼šæ—¶é—´çº¦æŸåŸŸ

---

## 4 å®é™…æ¡ˆä¾‹ï¼šå®æ—¶åµŒå…¥å¼ç³»ç»Ÿè°ƒåº¦

**åœºæ™¯**ï¼šæ±½è½¦ECUä»»åŠ¡è°ƒåº¦

```python
def create_ecu_realtime_scheduling():
    """
    æ±½è½¦ECUå®æ—¶ä»»åŠ¡è°ƒåº¦TPNæ¨¡å‹

    ä»»åŠ¡ï¼š
    - å‘åŠ¨æœºæ§åˆ¶ï¼ˆ10mså‘¨æœŸï¼ŒWCET=2msï¼‰
    - åˆ¹è½¦æ§åˆ¶ï¼ˆ20mså‘¨æœŸï¼ŒWCET=5msï¼‰
    - ä»ªè¡¨æ˜¾ç¤ºï¼ˆ100mså‘¨æœŸï¼ŒWCET=10msï¼‰
    """
    tpn = TimedPetriNet()

    # å‘åŠ¨æœºæ§åˆ¶ä»»åŠ¡
    tpn.add_place('p_engine_ready', tokens=1)
    tpn.add_timed_transition('t_engine', eft=0, lft=10)  # å¿…é¡»åœ¨10mså†…å®Œæˆ

    # åˆ¹è½¦æ§åˆ¶ä»»åŠ¡
    tpn.add_place('p_brake_ready', tokens=1)
    tpn.add_timed_transition('t_brake', eft=0, lft=20)

    # ä»ªè¡¨æ˜¾ç¤ºä»»åŠ¡
    tpn.add_place('p_display_ready', tokens=1)
    tpn.add_timed_transition('t_display', eft=0, lft=100)

    return tpn

# å¯è°ƒåº¦æ€§åˆ†æ
ecu_tpn = create_ecu_realtime_scheduling()
# ä½¿ç”¨TINAå·¥å…·è¿›è¡Œæ—¶é—´å¯è¾¾æ€§åˆ†æ
```

---

**è¿”å›**: [07 é«˜çº§Petriç½‘åœ¨è°ƒåº¦ä¸­çš„åº”ç”¨](README.md)

**å‚è€ƒæ–‡çŒ®**ï¼š

1. Merlin, P., & Farber, D. (1976). "Recoverability of Communication Protocols"
2. XTSPNæ‰©å±•æ—¶é—´æµPetriç½‘ (2024)
