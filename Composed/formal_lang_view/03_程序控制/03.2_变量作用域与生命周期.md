# 3.2 变量作用域与生命周期

> **子主题编号**: 03.2
> **主题**: 程序控制
> **最后更新**: 2025-01-XX

---

## 📋 目录

- [3.2 变量作用域与生命周期](#32-变量作用域与生命周期)
  - [📋 目录](#-目录)
  - [1 概述](#1-概述)
  - [📑 目录](#-目录-1)
  - [2 核心概念](#2-核心概念)
    - [2.1 栈帧与Pod生命周期](#21-栈帧与pod生命周期)
    - [2.2 堆与PersistentVolume](#22-堆与persistentvolume)
    - [2.3 RAII与Init Container](#23-raii与init-container)
    - [2.4 垃圾回收与Pod清理](#24-垃圾回收与pod清理)
  - [3 生命周期映射表](#3-生命周期映射表)
  - [4 技术细节](#4-技术细节)
    - [4.1 Pod生命周期阶段](#41-pod生命周期阶段)
    - [4.2 Cgroups资源限制](#42-cgroups资源限制)
    - [4.3 Init Container初始化](#43-init-container初始化)
    - [4.4 垃圾回收机制](#44-垃圾回收机制)
  - [5 实际应用](#5-实际应用)
    - [5.1 Pod生命周期管理](#51-pod生命周期管理)
    - [5.2 资源清理策略](#52-资源清理策略)
  - [6 相关概念](#6-相关概念)

---

## 1 概述

编程语言中的变量作用域和生命周期对应到基础设施中的资源生命周期管理，包括栈帧、堆、RAII和垃圾回收等概念。

---

## 📑 目录

- [3.2 变量作用域与生命周期](#32-变量作用域与生命周期)
  - [📋 目录](#-目录)
  - [1 概述](#1-概述)
  - [📑 目录](#-目录-1)
  - [2 核心概念](#2-核心概念)
    - [2.1 栈帧与Pod生命周期](#21-栈帧与pod生命周期)
    - [2.2 堆与PersistentVolume](#22-堆与persistentvolume)
    - [2.3 RAII与Init Container](#23-raii与init-container)
    - [2.4 垃圾回收与Pod清理](#24-垃圾回收与pod清理)
  - [3 生命周期映射表](#3-生命周期映射表)
  - [4 技术细节](#4-技术细节)
    - [4.1 Pod生命周期阶段](#41-pod生命周期阶段)
    - [4.2 Cgroups资源限制](#42-cgroups资源限制)
    - [4.3 Init Container初始化](#43-init-container初始化)
    - [4.4 垃圾回收机制](#44-垃圾回收机制)
  - [5 实际应用](#5-实际应用)
    - [5.1 Pod生命周期管理](#51-pod生命周期管理)
    - [5.2 资源清理策略](#52-资源清理策略)
  - [6 相关概念](#6-相关概念)

---

## 2 核心概念

### 2.1 栈帧与Pod生命周期

- **栈帧** ↔ **Pod生命周期**：创建→运行→终止
- **栈深度限制** ↔ **Cgroups的`memory.limit_in_bytes`**：限制资源使用
- **函数调用栈** ↔ **Pod状态转换**：Pending → Running → Succeeded/Failed

### 2.2 堆与PersistentVolume

- **堆** ↔ **PersistentVolume**：动态分配的持久化存储
- **堆分配** ↔ **PV动态绑定**：按需分配存储资源
- **堆GC** ↔ **PV回收策略**：自动回收未使用的存储

### 2.3 RAII与Init Container

- **RAII** ↔ **Init Container**：在"资源"作用域开始时强制执行的初始化
- **资源获取** ↔ **Init Container启动**：在应用容器之前执行
- **资源释放** ↔ **preStop钩子**：在容器终止前执行清理

### 2.4 垃圾回收与Pod清理

- **垃圾回收** ↔ **Failed Pod清理** + **镜像GC**
- **kubelet的gc-manager** ↔ **运行时垃圾收集器**
- **内存回收** ↔ **Pod终止和资源释放**

---

## 3 生命周期映射表

| 编程概念 | 基础设施实现 | 对应关系 |
|---------|-------------|---------|
| 栈帧 | Pod生命周期 | 创建→运行→终止 |
| 栈深度限制 | Cgroups内存限制 | 资源使用限制 |
| 堆 | PersistentVolume | 动态分配存储 |
| RAII | Init Container | 资源初始化 |
| 垃圾回收 | Pod清理 + 镜像GC | 资源回收 |

---

## 4 技术细节

### 4.1 Pod生命周期阶段

```yaml
# Pod生命周期
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    image: app:1.0
  # 生命周期：Pending → Running → Succeeded/Failed
```

### 4.2 Cgroups资源限制

```yaml
# Cgroups资源限制
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    resources:
      limits:
        memory: "1Gi"  # 栈深度限制
        cpu: "500m"
```

### 4.3 Init Container初始化

```yaml
# Init Container：RAII模式
apiVersion: v1
kind: Pod
spec:
  initContainers:
  - name: init
    image: init:1.0
    # 资源获取：在应用容器之前执行
  containers:
  - name: app
    image: app:1.0
```

### 4.4 垃圾回收机制

```yaml
# 垃圾回收：Pod清理
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    image: app:1.0
  # kubelet gc-manager：自动清理Failed Pod
```

---

## 5 实际应用

### 5.1 Pod生命周期管理

```text
1. Pod创建：Pending状态
2. 容器启动：Running状态
3. 容器终止：Succeeded/Failed状态
4. 资源清理：垃圾回收
```

### 5.2 资源清理策略

```text
1. Failed Pod清理
2. 镜像GC
3. 未使用的PV回收
4. 资源配额释放
```

---

## 6 相关概念

- [3.1 控制流映射](./03.1_控制流映射.md)
- [3.3 多租户：高阶类型](./03.3_多租户高阶类型.md)
- [07.2 无状态容器与纯函数](../07_效应系统/07.2_无状态容器与纯函数.md)

---

**返回**: [03. 程序控制](./README.md) | [主题索引](../README.md)
