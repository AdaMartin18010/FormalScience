# 5.6 WASMç»„ä»¶æ¨¡å‹

> **å­ä¸»é¢˜ç¼–å·**: 05.6
> **ä¸»é¢˜**: é«˜çº§ç±»å‹ç‰¹æ€§
> **æœ€åæ›´æ–°**: 2025-12-02
> **æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [1 æ¦‚è¿°](#1-æ¦‚è¿°)
- [2 æ€ç»´å¯¼å›¾](#2-æ€ç»´å¯¼å›¾)
- [3 WITç±»å‹ç³»ç»Ÿ](#3-witç±»å‹ç³»ç»Ÿ)
- [4 ç»„ä»¶æ¨¡å‹ç±»å‹](#4-ç»„ä»¶æ¨¡å‹ç±»å‹)
- [5 èµ„æºç±»å‹](#5-èµ„æºç±»å‹)
- [6 çŸ¥è¯†çŸ©é˜µ](#6-çŸ¥è¯†çŸ©é˜µ)
- [7 è·¨è§†è§’é“¾æ¥](#7-è·¨è§†è§’é“¾æ¥)

---

## 1 æ¦‚è¿°

### 1.1 æ ¸å¿ƒæ´å¯Ÿ

WASMç»„ä»¶æ¨¡å‹ï¼ˆComponent Modelï¼‰æ˜¯WebAssemblyçš„ä¸‹ä¸€ä»£æ¨¡å—åŒ–æ ‡å‡†ï¼Œå¼•å…¥äº†**é«˜çº§ç±»å‹ç³»ç»Ÿ**æ¥å®ç°è·¨è¯­è¨€äº’æ“ä½œã€‚å…¶ç±»å‹ç³»ç»Ÿè®¾è®¡èåˆäº†ä»£æ•°æ•°æ®ç±»å‹ã€çº¿æ€§ç±»å‹å’Œæ¥å£ç±»å‹çš„æ¦‚å¿µã€‚

### 1.2 ç»„ä»¶æ¨¡å‹ç‰¹æ€§

| ç‰¹æ€§ | æè¿° | ç±»å‹ç³»ç»Ÿå¯¹åº” |
|------|------|------------|
| **ç»„ä»¶éš”ç¦»** | ç‹¬ç«‹å®ä¾‹ï¼Œæ˜ç¡®è¾¹ç•Œ | æ¨¡å—ç±»å‹ç³»ç»Ÿ |
| **æ¥å£å®šä¹‰** | WITè¯­è¨€å®šä¹‰æ¥å£ | æ¥å£ç±»å‹ |
| **èµ„æºç®¡ç†** | æ‰€æœ‰æƒä¸ç”Ÿå‘½å‘¨æœŸ | çº¿æ€§/ä»¿å°„ç±»å‹ |
| **è§„èŒƒABI** | è¯­è¨€æ— å…³çš„è°ƒç”¨çº¦å®š | è¡¨ç¤ºç±»å‹ |
| **ç»„åˆæ€§** | ç»„ä»¶å¯ç»„åˆ | å‡½å­/æ¨¡å—ç»„åˆ |

### 1.3 å½¢å¼åŒ–å®šä¹‰

```text
WASMç»„ä»¶æ¨¡å‹ç±»å‹ç³»ç»Ÿ T_wasm:

åŸºæœ¬å€¼ç±»å‹ ValType:
  Ï„ ::= bool | s8 | s16 | s32 | s64 | u8 | u16 | u32 | u64
      | f32 | f64 | char | string

å¤åˆç±»å‹ CompType:
  Ï„ ::= (record field*) | (variant case*) | (list Ï„) | (tuple Ï„*)
      | (option Ï„) | (result Ï„ Ï„) | (flags name*) | (enum name*)

èµ„æºç±»å‹ ResType:
  Ï„ ::= (own handle) | (borrow handle)

æ¥å£ç±»å‹ IfaceType:
  I ::= (interface (func name (param Ï„*) (result Ï„*))*)
      | (interface (resource name)*)

ç»„ä»¶ç±»å‹ CompType:
  C ::= (component (import I*) (export I*) (instance I*)*)
```

---

## 2 æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((WASMç»„ä»¶æ¨¡å‹))
    WITç±»å‹
      åŸºæœ¬ç±»å‹
        bool/æ•°å€¼
        char/string
      å¤åˆç±»å‹
        record
        variant
        enum/flags
        list/tuple
      ç‰¹æ®Šç±»å‹
        option
        result
    èµ„æºæ¨¡å‹
      æ‰€æœ‰æƒ
        own
        borrow
      ç”Ÿå‘½å‘¨æœŸ
        è‡ªåŠ¨é‡Šæ”¾
        å€Ÿç”¨æ£€æŸ¥
    ç»„ä»¶
      æ¥å£
        import
        export
      ç»„åˆ
        é“¾æ¥
        å®ä¾‹åŒ–
    äº’æ“ä½œ
      è¯­è¨€ç»‘å®š
        Rust
        Go
        JS
      è§„èŒƒABI
```

---

## 3 WITç±»å‹ç³»ç»Ÿ

### 3.1 WITè¯­æ³•

```wit
// WIT (WebAssembly Interface Type) ç¤ºä¾‹

package example:types@1.0.0;

// åŸºæœ¬ç±»å‹å®šä¹‰
interface basic-types {
    // åŸå§‹ç±»å‹
    type byte = u8;
    type size = u32;

    // è®°å½•ç±»å‹ (Product Type)
    record point {
        x: f64,
        y: f64,
    }

    // å˜ä½“ç±»å‹ (Sum Type)
    variant shape {
        circle(f64),           // åœ†å½¢ï¼ŒåŠå¾„
        rectangle(point),      // çŸ©å½¢ï¼Œå®½é«˜
        polygon(list<point>),  // å¤šè¾¹å½¢ï¼Œé¡¶ç‚¹åˆ—è¡¨
    }

    // æšä¸¾ç±»å‹
    enum color {
        red,
        green,
        blue,
    }

    // æ ‡å¿—ç±»å‹
    flags permissions {
        read,
        write,
        execute,
    }

    // Optionç±»å‹
    type optional-string = option<string>;

    // Resultç±»å‹
    type io-result = result<list<u8>, string>;
}
```

### 3.2 ç±»å‹æ˜ å°„å…³ç³»

| WITç±»å‹ | ç±»å‹ç†è®º | Rustå¯¹åº” | è¯´æ˜ |
|--------|---------|---------|------|
| `record` | ä¹˜ç§¯ç±»å‹ | `struct` | å­—æ®µç§¯ |
| `variant` | å’Œç±»å‹ | `enum` | å¸¦æ•°æ®çš„å˜ä½“ |
| `enum` | æšä¸¾ | `enum` | æ— æ•°æ®æšä¸¾ |
| `flags` | ä½é›† | `bitflags` | ä½æ ‡å¿— |
| `list<T>` | åˆ—è¡¨ | `Vec<T>` | å˜é•¿åºåˆ— |
| `tuple<T*>` | å…ƒç»„ | `(T,...)` | å›ºå®šå…ƒç»„ |
| `option<T>` | Maybe | `Option<T>` | å¯é€‰å€¼ |
| `result<T,E>` | Either | `Result<T,E>` | ç»“æœ/é”™è¯¯ |

### 3.3 ç±»å‹ç­‰ä»·è§„åˆ™

```text
ç±»å‹ç­‰ä»·å…³ç³» â‰¡:

ç»“æ„ç­‰ä»·:
  record{fâ‚:Ï„â‚,...,fâ‚™:Ï„â‚™} â‰¡ record{f_Ï€(1):Ï„_Ï€(1),...,f_Ï€(n):Ï„_Ï€(n)}
  (å­—æ®µé¡ºåºä¸é‡è¦ï¼Œä½†åç§°å¿…é¡»åŒ¹é…)

å˜ä½“ç­‰ä»·:
  variant{câ‚(Ï„â‚),...,câ‚™(Ï„â‚™)} â‰¡ variant{c_Ï€(1)(Ï„_Ï€(1)),...,c_Ï€(n)(Ï„_Ï€(n))}
  (caseé¡ºåºä¸é‡è¦)

å±•å¼€ç­‰ä»·:
  type-alias â‰¡ underlying-type
  (ç±»å‹åˆ«åç­‰ä»·äºåº•å±‚ç±»å‹)
```

---

## 4 ç»„ä»¶æ¨¡å‹ç±»å‹

### 4.1 ç»„ä»¶å®šä¹‰

```wit
// ç»„ä»¶æ¥å£å®šä¹‰
package myapp:http@0.1.0;

// HTTPè¯·æ±‚/å“åº”æ¥å£
interface types {
    record request {
        method: string,
        uri: string,
        headers: list<tuple<string, string>>,
        body: option<list<u8>>,
    }

    record response {
        status: u16,
        headers: list<tuple<string, string>>,
        body: list<u8>,
    }

    variant http-error {
        network-error(string),
        timeout,
        invalid-url,
    }
}

// HTTPå®¢æˆ·ç«¯æ¥å£
interface http-client {
    use types.{request, response, http-error};

    fetch: func(req: request) -> result<response, http-error>;
}

// HTTPæœåŠ¡å™¨æ¥å£
interface http-handler {
    use types.{request, response};

    handle: func(req: request) -> response;
}

// ç»„ä»¶ä¸–ç•Œå®šä¹‰
world http-server {
    import http-client;
    export http-handler;
}
```

### 4.2 ç»„ä»¶ç»„åˆ

```text
ç»„ä»¶ç»„åˆæ¨¡å‹:

ç»„ä»¶ A:
  import: {Iâ‚, Iâ‚‚}
  export: {Eâ‚}

ç»„ä»¶ B:
  import: {Eâ‚}    // åŒ¹é…Açš„å¯¼å‡º
  export: {Eâ‚‚}

ç»„åˆ A âŠ— B:
  import: {Iâ‚, Iâ‚‚}  // Açš„å¯¼å…¥
  export: {Eâ‚‚}      // Bçš„å¯¼å‡º
  internal: A.Eâ‚ â†’ B.import

ç»„åˆè§„åˆ™:
  âˆ€ I âˆˆ B.import. âˆƒ E âˆˆ A.export. I â‰¡ E
  (Bçš„æ¯ä¸ªå¯¼å…¥å¿…é¡»èƒ½ä»Açš„å¯¼å‡ºæ»¡è¶³)
```

### 4.3 å®ä¾‹åŒ–æ¨¡å‹

```mermaid
graph LR
    subgraph "ç»„ä»¶A"
        A_IMP[Import I1]
        A_CORE[Core]
        A_EXP[Export E1]
        A_IMP --> A_CORE
        A_CORE --> A_EXP
    end

    subgraph "ç»„ä»¶B"
        B_IMP[Import E1]
        B_CORE[Core]
        B_EXP[Export E2]
        B_IMP --> B_CORE
        B_CORE --> B_EXP
    end

    A_EXP -->|é“¾æ¥| B_IMP

    I1[å¤–éƒ¨I1] --> A_IMP
    B_EXP --> E2[æœ€ç»ˆE2]
```

---

## 5 èµ„æºç±»å‹

### 5.1 æ‰€æœ‰æƒæ¨¡å‹

```wit
// èµ„æºç±»å‹å®šä¹‰
interface filesystem {
    // èµ„æºå£°æ˜
    resource file-handle {
        // æ„é€ å‡½æ•°
        constructor(path: string);

        // æ–¹æ³•
        read: func(size: u32) -> list<u8>;
        write: func(data: list<u8>) -> result<u32, string>;

        // é™æ€æ–¹æ³•
        exists: static func(path: string) -> bool;
    }

    // ä½¿ç”¨æ‰€æœ‰æƒç±»å‹
    open-file: func(path: string) -> own<file-handle>;

    // ä½¿ç”¨å€Ÿç”¨ç±»å‹
    read-file: func(file: borrow<file-handle>) -> list<u8>;

    // è½¬ç§»æ‰€æœ‰æƒ
    close-file: func(file: own<file-handle>);
}
```

### 5.2 å€Ÿç”¨æ£€æŸ¥è§„åˆ™

```text
èµ„æºå€Ÿç”¨è§„åˆ™:

1. own<T> - æ‹¥æœ‰çš„èµ„æº
   - æŒæœ‰è€…è´Ÿè´£é‡Šæ”¾
   - å¯ä»¥è½¬ç§»æ‰€æœ‰æƒ
   - å¯ä»¥åˆ›å»ºå€Ÿç”¨

2. borrow<T> - å€Ÿç”¨çš„èµ„æº
   - ä¸è´Ÿè´£é‡Šæ”¾
   - ä¸èƒ½è½¬ç§»
   - ç”Ÿå‘½å‘¨æœŸå—é™äºè°ƒç”¨

ç±»å‹è§„åˆ™:
  Î“ âŠ¢ e : own<T>
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Î“ âŠ¢ borrow(e) : borrow<T>

  Î“ âŠ¢ f : borrow<T> â†’ R
  Î“ âŠ¢ e : borrow<T>
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Î“ âŠ¢ f(e) : R

èµ„æºé‡Šæ”¾:
  å½“ own<T> ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨ drop
```

### 5.3 èµ„æºç”Ÿå‘½å‘¨æœŸ

```mermaid
sequenceDiagram
    participant Caller
    participant Component
    participant Resource

    Caller->>Component: open(path) -> own<handle>
    Component->>Resource: allocate
    Resource-->>Component: handle
    Component-->>Caller: own<handle>

    Caller->>Component: read(borrow<handle>)
    Note over Component: å€Ÿç”¨æœŸé—´èµ„æºæœ‰æ•ˆ
    Component-->>Caller: data

    Caller->>Component: close(own<handle>)
    Component->>Resource: deallocate
    Resource-->>Component: done
    Component-->>Caller: ()
```

---

## 6 çŸ¥è¯†çŸ©é˜µ

### 6.1 ç±»å‹ç³»ç»Ÿç‰¹æ€§å¯¹æ¯”

| ç‰¹æ€§ | WASM CM | Rust | Haskell | è¯´æ˜ |
|------|--------|------|---------|------|
| **ä»£æ•°ç±»å‹** | âœ… record/variant | âœ… struct/enum | âœ… data | åŸºç¡€æ”¯æŒ |
| **æ³›å‹** | âŒ è®¡åˆ’ä¸­ | âœ… | âœ… | å°šæœªæ”¯æŒ |
| **çº¿æ€§ç±»å‹** | âš ï¸ own/borrow | âœ… å®Œæ•´ | âŒ | èµ„æºç‰¹å®š |
| **ç±»å‹æ¨æ–­** | âŒ | âœ… å±€éƒ¨ | âœ… å®Œæ•´ | æ˜¾å¼æ ‡æ³¨ |
| **å­ç±»å‹** | âŒ | âŒ | âŒ | ä¸æ”¯æŒ |

### 6.2 èµ„æºæ¨¡å‹å¯¹æ¯”

| æ¨¡å‹ | WASM CM | Rust | Cap'n Proto |
|------|--------|------|-------------|
| **æ‰€æœ‰æƒ** | own | Box/å€¼ | å®¢æˆ·ç«¯æŒæœ‰ |
| **å€Ÿç”¨** | borrow | &/&mut | èƒ½åŠ›å¼•ç”¨ |
| **ç”Ÿå‘½å‘¨æœŸ** | è°ƒç”¨çº§ | è¯æ³•çº§ | æ— é™åˆ¶ |
| **é‡Šæ”¾** | è‡ªåŠ¨drop | è‡ªåŠ¨ | GC/æ‰‹åŠ¨ |

---

## 7 è·¨è§†è§’é“¾æ¥

### 7.1 å½¢å¼è¯­è¨€è§†è§’å…³è”

- [çº¿æ€§ç±»å‹ä¸èµ„æºå®‰å…¨](./05.4_çº¿æ€§ç±»å‹ä¸èµ„æºå®‰å…¨.md) - æ‰€æœ‰æƒç†è®ºåŸºç¡€
- [æ¨¡å—ç³»ç»Ÿ](../06_æ¨¡å—ç³»ç»Ÿ/) - ç»„ä»¶ç»„åˆç†è®º
- [èŒƒç•´è®ºè§†è§’](../09_å½¢å¼åŒ–ç†è®º/09.1_èŒƒç•´è®ºè§†è§’.md) - ç»„åˆè¯­ä¹‰

### 7.2 è°ƒåº¦è§†è§’å…³è”

| è°ƒåº¦æ¦‚å¿µ | WASM CMå¯¹åº” | æ˜ å°„è¯´æ˜ |
|---------|-------------|---------|
| **èµ„æºåˆ†é…** | ownåˆ›å»º | èµ„æºè·å– |
| **èµ„æºé‡Šæ”¾** | dropè°ƒç”¨ | èµ„æºå›æ”¶ |
| **å®¹å™¨éš”ç¦»** | ç»„ä»¶è¾¹ç•Œ | æ²™ç›’éš”ç¦» |
| **æœåŠ¡ç»„åˆ** | ç»„ä»¶é“¾æ¥ | æœåŠ¡ç¼–æ’ |

### 7.3 åº”ç”¨åœºæ™¯

| åœºæ™¯ | ä½¿ç”¨æ–¹å¼ | æ”¶ç›Š |
|------|---------|------|
| **æ’ä»¶ç³»ç»Ÿ** | ç»„ä»¶çƒ­åŠ è½½ | åŠ¨æ€æ‰©å±• |
| **è¾¹ç¼˜è®¡ç®—** | è½»é‡æ²™ç›’ | å®‰å…¨éš”ç¦» |
| **Serverless** | å‡½æ•°ç»„ä»¶ | å¿«é€Ÿå†·å¯åŠ¨ |
| **è·¨è¯­è¨€è°ƒç”¨** | WITæ¥å£ | è¯­è¨€æ— å…³ |

---

## å‚è€ƒèµ„æº

1. [WASM Component Model Spec](https://github.com/WebAssembly/component-model)
2. [WITè¯­æ³•å‚è€ƒ](https://component-model.bytecodealliance.org/design/wit.html)
3. [Bytecode Alliance](https://bytecodealliance.org/)
4. [Wasmtimeè¿è¡Œæ—¶](https://wasmtime.dev/)

---

**è¿”å›**: [é«˜çº§ç±»å‹ç‰¹æ€§ä¸»ç´¢å¼•](./README.md) | [å½¢å¼è¯­è¨€è§†è§’ä¸»ç´¢å¼•](../README.md)
