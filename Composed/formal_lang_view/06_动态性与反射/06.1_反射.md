# 6.1 反射（Reflection）

> **子主题编号**: 06.1
> **主题**: 动态性与反射
> **最后更新**: 2025-01-XX

---

## 📋 目录

- [6.1 反射（Reflection）](#61-反射reflection)
  - [📋 目录](#-目录)
  - [1 概述](#1-概述)
  - [📑 目录](#-目录-1)
  - [2 核心概念](#2-核心概念)
    - [2.1 Downward API作为反射](#21-downward-api作为反射)
    - [2.2 监控指标暴露作为内省](#22-监控指标暴露作为内省)
    - [2.3 kubectl exec作为运行时反射](#23-kubectl-exec作为运行时反射)
  - [3 反射映射表](#3-反射映射表)
  - [4 技术细节](#4-技术细节)
    - [4.1 Downward API实现](#41-downward-api实现)
    - [4.2 Prometheus监控指标](#42-prometheus监控指标)
    - [4.3 kubectl exec运行时检查](#43-kubectl-exec运行时检查)
  - [5 实际应用](#5-实际应用)
    - [5.1 容器元数据获取](#51-容器元数据获取)
    - [5.2 监控指标收集](#52-监控指标收集)
    - [5.3 容器调试](#53-容器调试)
  - [6 相关概念](#6-相关概念)

---

## 1 概述

反射机制允许程序在运行时检查和修改自身结构，在基础设施中，**Downward API**、**监控指标暴露**和**kubectl exec**都体现了反射的概念。

---

## 📑 目录

- [6.1 反射（Reflection）](#61-反射reflection)
  - [📋 目录](#-目录)
  - [1 概述](#1-概述)
  - [📑 目录](#-目录-1)
  - [2 核心概念](#2-核心概念)
    - [2.1 Downward API作为反射](#21-downward-api作为反射)
    - [2.2 监控指标暴露作为内省](#22-监控指标暴露作为内省)
    - [2.3 kubectl exec作为运行时反射](#23-kubectl-exec作为运行时反射)
  - [3 反射映射表](#3-反射映射表)
  - [4 技术细节](#4-技术细节)
    - [4.1 Downward API实现](#41-downward-api实现)
    - [4.2 Prometheus监控指标](#42-prometheus监控指标)
    - [4.3 kubectl exec运行时检查](#43-kubectl-exec运行时检查)
  - [5 实际应用](#5-实际应用)
    - [5.1 容器元数据获取](#51-容器元数据获取)
    - [5.2 监控指标收集](#52-监控指标收集)
    - [5.3 容器调试](#53-容器调试)
  - [6 相关概念](#6-相关概念)

---

## 2 核心概念

### 2.1 Downward API作为反射

- **Downward API**：容器通过`/etc/podinfo`获取自身元数据 ≈ `typeof(this)`
- **反射机制** ↔ **元数据获取**：在运行时获取容器自身信息
- **类型信息** ↔ **Pod元数据**：获取Pod的名称、命名空间等信息

### 2.2 监控指标暴露作为内省

- **监控指标暴露**：Prometheus抓取是基础设施的**Introspection**
- **内省机制** ↔ **指标暴露**：容器主动暴露自身状态
- **类型检查** ↔ **指标收集**：通过指标了解容器运行状态

### 2.3 kubectl exec作为运行时反射

- **kubectl exec**：运行时反射，动态"检查"容器内部状态
- **运行时反射** ↔ **容器调试**：在运行时检查容器内部
- **动态检查** ↔ **交互式调试**：实时查看容器状态

---

## 3 反射映射表

| 编程概念 | 基础设施实现 | 类型论对应 | 示例 |
|---------|-------------|-----------|------|
| `typeof(this)` | Downward API | 元数据获取 | Pod名称、命名空间 |
| Introspection | Prometheus | 指标暴露 | CPU、内存使用率 |
| 运行时反射 | kubectl exec | 容器调试 | 查看容器内部状态 |

---

## 4 技术细节

### 4.1 Downward API实现

```yaml
# Downward API：反射机制
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    image: app:1.0
    env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
  # 反射：获取Pod自身元数据
```

### 4.2 Prometheus监控指标

```yaml
# Prometheus：内省机制
apiVersion: v1
kind: Pod
spec:
  containers:
  - name: app
    image: app:1.0
    ports:
    - name: metrics
      containerPort: 9090
  # 内省：暴露监控指标
```

### 4.3 kubectl exec运行时检查

```bash
# kubectl exec：运行时反射
kubectl exec -it pod-name -- /bin/sh
# 运行时反射：动态检查容器内部状态
```

---

## 5 实际应用

### 5.1 容器元数据获取

```text
1. 使用Downward API
2. 获取Pod元数据
3. 在容器内使用元数据
4. 实现动态配置
```

### 5.2 监控指标收集

```text
1. 容器暴露指标
2. Prometheus抓取
3. 收集监控数据
4. 实现内省机制
```

### 5.3 容器调试

```text
1. 使用kubectl exec
2. 进入容器
3. 检查容器状态
4. 实现运行时反射
```

---

## 6 相关概念

- [6.2 动态类型与弹性伸缩](./06.2_动态类型与弹性伸缩.md)
- [04.2 运行时检查](../04_类型检查与验证/04.2_运行时检查.md)
- [09.6 工程实践工具链](../09_形式化理论/09.6_工程实践工具链.md)

---

**返回**: [06. 动态性与反射](./README.md) | [主题索引](../README.md)
