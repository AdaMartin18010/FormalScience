# 7.4 ä»£æ•°æ•ˆåº”ä¸è°ƒåº¦æ§åˆ¶

> **å­ä¸»é¢˜ç¼–å·**: 07.4
> **ä¸»é¢˜**: æ•ˆåº”ç³»ç»Ÿ
> **æœ€åæ›´æ–°**: 2025-12-02
> **æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [7.4 ä»£æ•°æ•ˆåº”ä¸è°ƒåº¦æ§åˆ¶](#74-ä»£æ•°æ•ˆåº”ä¸è°ƒåº¦æ§åˆ¶)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 æ¦‚è¿°](#1-æ¦‚è¿°)
    - [1.1 æ ¸å¿ƒæ´å¯Ÿ](#11-æ ¸å¿ƒæ´å¯Ÿ)
    - [1.2 æ•ˆåº”ç³»ç»Ÿç‰¹æ€§](#12-æ•ˆåº”ç³»ç»Ÿç‰¹æ€§)
    - [1.3 å½¢å¼åŒ–å®šä¹‰](#13-å½¢å¼åŒ–å®šä¹‰)
    - [1.4 æ ¸å¿ƒæ¦‚å¿µç²¾ç¡®å®šä¹‰](#14-æ ¸å¿ƒæ¦‚å¿µç²¾ç¡®å®šä¹‰)
      - [1.4.1 ä»£æ•°æ•ˆåº”ï¼ˆAlgebraic Effectï¼‰](#141-ä»£æ•°æ•ˆåº”algebraic-effect)
      - [1.4.2 æ•ˆåº”å¤„ç†å™¨ï¼ˆEffect Handlerï¼‰](#142-æ•ˆåº”å¤„ç†å™¨effect-handler)
      - [1.4.3 æ•ˆåº”ä¸è°ƒåº¦çš„åŒæ„å…³ç³»](#143-æ•ˆåº”ä¸è°ƒåº¦çš„åŒæ„å…³ç³»)
    - [1.5 è®¾è®¡åŸç†ä¸åŠ¨æœº](#15-è®¾è®¡åŸç†ä¸åŠ¨æœº)
      - [1.5.1 ä¸ºä»€ä¹ˆåˆ†ç¦»æ•ˆåº”è§¦å‘ä¸å¤„ç†ï¼Ÿ](#151-ä¸ºä»€ä¹ˆåˆ†ç¦»æ•ˆåº”è§¦å‘ä¸å¤„ç†)
      - [1.5.2 è°ƒåº¦ç³»ç»Ÿçš„æ•ˆåº”æŠ½è±¡](#152-è°ƒåº¦ç³»ç»Ÿçš„æ•ˆåº”æŠ½è±¡)
  - [2 æ€ç»´å¯¼å›¾](#2-æ€ç»´å¯¼å›¾)
  - [3 ä»£æ•°æ•ˆåº”ç†è®º](#3-ä»£æ•°æ•ˆåº”ç†è®º)
    - [3.1 æ•ˆåº”ç­¾åå®šä¹‰](#31-æ•ˆåº”ç­¾åå®šä¹‰)
    - [3.2 æ•ˆåº”è¯­ä¹‰](#32-æ•ˆåº”è¯­ä¹‰)
    - [3.3 ç±»å‹ç³»ç»Ÿ](#33-ç±»å‹ç³»ç»Ÿ)
      - [3.3.1 ç±»å‹ç³»ç»Ÿçš„è¯­ä¹‰è§£é‡Š](#331-ç±»å‹ç³»ç»Ÿçš„è¯­ä¹‰è§£é‡Š)
      - [3.3.2 ç±»å‹å®‰å…¨æ€§è´¨](#332-ç±»å‹å®‰å…¨æ€§è´¨)
      - [3.3.3 æ•ˆåº”æ¨æ–­ç®—æ³•](#333-æ•ˆåº”æ¨æ–­ç®—æ³•)
  - [4 æ•ˆåº”å¤„ç†å™¨](#4-æ•ˆåº”å¤„ç†å™¨)
    - [4.1 å¤„ç†å™¨å®šä¹‰](#41-å¤„ç†å™¨å®šä¹‰)
    - [4.2 æ·±æµ…å¤„ç†å™¨](#42-æ·±æµ…å¤„ç†å™¨)
      - [4.2.1 æ·±æµ…å¤„ç†å™¨çš„å½¢å¼åŒ–å®šä¹‰](#421-æ·±æµ…å¤„ç†å™¨çš„å½¢å¼åŒ–å®šä¹‰)
      - [4.2.2 æ·±æµ…å¤„ç†å™¨çš„é€‰æ‹©åŸåˆ™](#422-æ·±æµ…å¤„ç†å™¨çš„é€‰æ‹©åŸåˆ™)
      - [4.2.3 å¤„ç†å™¨è½¬æ¢å®šç†](#423-å¤„ç†å™¨è½¬æ¢å®šç†)
    - [4.3 å¤„ç†å™¨ç»„åˆ](#43-å¤„ç†å™¨ç»„åˆ)
  - [5 è°ƒåº¦æ§åˆ¶æ•ˆåº”](#5-è°ƒåº¦æ§åˆ¶æ•ˆåº”)
    - [5.1 èµ„æºåˆ†é…æ•ˆåº”](#51-èµ„æºåˆ†é…æ•ˆåº”)
    - [5.2 å¹¶å‘æ§åˆ¶æ•ˆåº”](#52-å¹¶å‘æ§åˆ¶æ•ˆåº”)
    - [5.3 çŠ¶æ€ç®¡ç†æ•ˆåº”](#53-çŠ¶æ€ç®¡ç†æ•ˆåº”)
  - [6 å®è·µåº”ç”¨](#6-å®è·µåº”ç”¨)
    - [6.1 K8sæ§åˆ¶å™¨æ•ˆåº”æ¨¡å‹](#61-k8sæ§åˆ¶å™¨æ•ˆåº”æ¨¡å‹)
    - [6.2 Serverlesså‡½æ•°æ•ˆåº”](#62-serverlesså‡½æ•°æ•ˆåº”)
  - [7 çŸ¥è¯†çŸ©é˜µ](#7-çŸ¥è¯†çŸ©é˜µ)
    - [7.1 æ•ˆåº”ç³»ç»Ÿå¯¹æ¯”](#71-æ•ˆåº”ç³»ç»Ÿå¯¹æ¯”)
    - [7.2 æ•ˆåº”-è°ƒåº¦æ˜ å°„](#72-æ•ˆåº”-è°ƒåº¦æ˜ å°„)
  - [8 å…³ç³»å±æ€§ä¸ä¾èµ–åˆ†æ](#8-å…³ç³»å±æ€§ä¸ä¾èµ–åˆ†æ)
    - [8.1 æ•ˆåº”ä¹‹é—´çš„å…³ç³»](#81-æ•ˆåº”ä¹‹é—´çš„å…³ç³»)
      - [8.1.1 æ•ˆåº”ä¾èµ–å…³ç³»](#811-æ•ˆåº”ä¾èµ–å…³ç³»)
      - [8.1.2 æ•ˆåº”ç»„åˆå…³ç³»](#812-æ•ˆåº”ç»„åˆå…³ç³»)
      - [8.1.3 æ•ˆåº”å±‚æ¬¡ç»“æ„](#813-æ•ˆåº”å±‚æ¬¡ç»“æ„)
    - [8.2 å¤„ç†å™¨ä¹‹é—´çš„å…³ç³»](#82-å¤„ç†å™¨ä¹‹é—´çš„å…³ç³»)
      - [8.2.1 å¤„ç†å™¨ç»„åˆå¾‹](#821-å¤„ç†å™¨ç»„åˆå¾‹)
      - [8.2.2 å¤„ç†å™¨äº¤æ¢å¾‹](#822-å¤„ç†å™¨äº¤æ¢å¾‹)
      - [8.2.3 å¤„ç†å™¨å•ä½å…ƒ](#823-å¤„ç†å™¨å•ä½å…ƒ)
    - [8.3 æ•ˆåº”ä¸è°ƒåº¦çš„çº¦æŸå…³ç³»](#83-æ•ˆåº”ä¸è°ƒåº¦çš„çº¦æŸå…³ç³»)
      - [8.3.1 èµ„æºçº¦æŸ](#831-èµ„æºçº¦æŸ)
      - [8.3.2 æ—¶åºçº¦æŸ](#832-æ—¶åºçº¦æŸ)
      - [8.3.3 ä¸€è‡´æ€§çº¦æŸ](#833-ä¸€è‡´æ€§çº¦æŸ)
    - [8.4 å½¢å¼åŒ–å…³ç³»å›¾](#84-å½¢å¼åŒ–å…³ç³»å›¾)
  - [9 è·¨è§†è§’é“¾æ¥](#9-è·¨è§†è§’é“¾æ¥)
    - [9.1 å½¢å¼è¯­è¨€è§†è§’å…³è”](#91-å½¢å¼è¯­è¨€è§†è§’å…³è”)
    - [9.2 è°ƒåº¦è§†è§’å…³è”](#92-è°ƒåº¦è§†è§’å…³è”)
    - [9.3 å…³ç³»å±æ€§æ˜ å°„](#93-å…³ç³»å±æ€§æ˜ å°„)
  - [å‚è€ƒèµ„æº](#å‚è€ƒèµ„æº)


---

## 1 æ¦‚è¿°

### 1.1 æ ¸å¿ƒæ´å¯Ÿ

ä»£æ•°æ•ˆåº”ï¼ˆAlgebraic Effectsï¼‰æ˜¯ä¸€ç§å¼ºå¤§çš„æ§åˆ¶æµæŠ½è±¡ï¼Œå°†**æ•ˆåº”çš„è§¦å‘**ä¸**æ•ˆåº”çš„å¤„ç†**åˆ†ç¦»ã€‚
åœ¨è°ƒåº¦ç³»ç»Ÿä¸­ï¼Œè¿™ç§åˆ†ç¦»å¯¹åº”äº**è°ƒåº¦è¯·æ±‚**ä¸**è°ƒåº¦ç­–ç•¥**çš„è§£è€¦ã€‚

### 1.2 æ•ˆåº”ç³»ç»Ÿç‰¹æ€§

| ç‰¹æ€§ | æè¿° | è°ƒåº¦å¯¹åº” |
|------|------|---------|
| **æ•ˆåº”å£°æ˜** | å£°æ˜å¯èƒ½çš„å‰¯ä½œç”¨ | å£°æ˜èµ„æºéœ€æ±‚ |
| **æ•ˆåº”è§¦å‘** | performæ“ä½œ | è°ƒåº¦è¯·æ±‚ |
| **æ•ˆåº”å¤„ç†** | handlerå®šä¹‰ | è°ƒåº¦ç­–ç•¥ |
| **æ•ˆåº”ç»„åˆ** | å¤šæ•ˆåº”ç»„åˆ | å¤šç­–ç•¥ç»„åˆ |
| **æ•ˆåº”æ¨æ–­** | ç±»å‹çº§æ•ˆåº”è¿½è¸ª | ä¾èµ–åˆ†æ |

### 1.3 å½¢å¼åŒ–å®šä¹‰

```text
ä»£æ•°æ•ˆåº”ç³»ç»Ÿ E = (Î£, Op, H, âŠ¢)

å…¶ä¸­ï¼š
  Î£: æ•ˆåº”ç­¾åé›†åˆ {Îµâ‚, Îµâ‚‚, ..., Îµâ‚™}
  Op: æ“ä½œé›†åˆ {opâ‚: Aâ‚ â†’ Bâ‚, opâ‚‚: Aâ‚‚ â†’ Bâ‚‚, ...}
  H: å¤„ç†å™¨é›†åˆ {hâ‚, hâ‚‚, ...}
  âŠ¢: ç±»å‹åˆ¤æ–­å…³ç³»

æ•ˆåº”ç±»å‹:
  Ï„ ::= Ï„â‚ â†’ Ï„â‚‚ ! Îµ        -- å¸¦æ•ˆåº”çš„å‡½æ•°ç±»å‹
  Îµ ::= âˆ… | Îµâ‚ âˆª Îµâ‚‚ | {op}  -- æ•ˆåº”é›†åˆ

ç±»å‹è§„åˆ™:
  Î“ âŠ¢ e : Ï„ ! Îµ
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Î“ âŠ¢ perform op(e) : Ï„' ! Îµ âˆª {op}
```

### 1.4 æ ¸å¿ƒæ¦‚å¿µç²¾ç¡®å®šä¹‰

#### 1.4.1 ä»£æ•°æ•ˆåº”ï¼ˆAlgebraic Effectï¼‰

**å®šä¹‰**ï¼šä»£æ•°æ•ˆåº”æ˜¯ä¸€ç§**å¯ç»„åˆçš„å‰¯ä½œç”¨æŠ½è±¡æœºåˆ¶**ï¼Œé€šè¿‡ä»£æ•°ç»“æ„ï¼ˆç­¾åã€æ“ä½œã€æ–¹ç¨‹ï¼‰æè¿°è®¡ç®—ä¸­çš„éå±€éƒ¨æ§åˆ¶æµã€‚

**å…³é”®å±æ€§**ï¼š

- **å¯ç»„åˆæ€§**ï¼šå¤šä¸ªæ•ˆåº”å¯ä»¥ç»„åˆè€Œä¸ç›¸äº’å¹²æ‰°
- **å¯äº¤æ¢æ€§**ï¼šæ•ˆåº”å¤„ç†çš„é¡ºåºä¸å½±å“æœ€ç»ˆç»“æœï¼ˆåœ¨æ»¡è¶³äº¤æ¢å¾‹çš„æƒ…å†µä¸‹ï¼‰
- **å¯æ›¿æ¢æ€§**ï¼šåŒä¸€æ•ˆåº”çš„ä¸åŒå¤„ç†å™¨å¯ä»¥äº’æ¢

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

```text
æ•ˆåº” Îµ æ˜¯ä»£æ•°çš„ï¼Œå½“ä¸”ä»…å½“ï¼š
  âˆ€ handlers Hâ‚, Hâ‚‚: handle(handle(e, Hâ‚), Hâ‚‚) = handle(e, compose(Hâ‚, Hâ‚‚))
```

#### 1.4.2 æ•ˆåº”å¤„ç†å™¨ï¼ˆEffect Handlerï¼‰

**å®šä¹‰**ï¼šæ•ˆåº”å¤„ç†å™¨æ˜¯ä¸€ä¸ª**ä»æ•ˆåº”æ“ä½œåˆ°å…·ä½“å®ç°çš„æ˜ å°„**ï¼Œå®šä¹‰äº†å½“é‡åˆ°ç‰¹å®šæ•ˆåº”æ—¶å¦‚ä½•æ‰§è¡Œã€‚

**ç»“æ„**ï¼š

```text
Handler H = {
  return: Î± â†’ Î²,              -- æ­£å¸¸è¿”å›å¤„ç†
  opâ‚: Aâ‚ â†’ (Bâ‚ â†’ Î²) â†’ Î²,     -- æ“ä½œ1çš„å¤„ç†
  opâ‚‚: Aâ‚‚ â†’ (Bâ‚‚ â†’ Î²) â†’ Î²,     -- æ“ä½œ2çš„å¤„ç†
  ...
}
```

**å…³é”®æ€§è´¨**ï¼š

- **ç±»å‹å®‰å…¨**ï¼šå¤„ç†å™¨å¿…é¡»å¤„ç†æ‰€æœ‰å¯èƒ½çš„æ•ˆåº”æ“ä½œ
- **ç»„åˆæ€§**ï¼šå¤„ç†å™¨å¯ä»¥ç»„åˆå½¢æˆå¤åˆå¤„ç†å™¨
- **å¯æ‰©å±•æ€§**ï¼šå¯ä»¥æ·»åŠ æ–°æ“ä½œè€Œä¸ä¿®æ”¹ç°æœ‰ä»£ç 

#### 1.4.3 æ•ˆåº”ä¸è°ƒåº¦çš„åŒæ„å…³ç³»

**å®šç† 1.1**ï¼ˆæ•ˆåº”-è°ƒåº¦åŒæ„ï¼‰ï¼š

```text
è°ƒåº¦ç³»ç»Ÿ (S, A, T, Ïƒ) ä¸æ•ˆåº”ç³»ç»Ÿ (Î£, Op, H, âŠ¢) ä¹‹é—´å­˜åœ¨åŒæ„æ˜ å°„ï¼š

  S (è°ƒåº¦çŠ¶æ€)    â†”  Î£ (æ•ˆåº”ç­¾å)
  A (è°ƒåº¦åŠ¨ä½œ)    â†”  Op (æ•ˆåº”æ“ä½œ)
  T (è°ƒåº¦ç­–ç•¥)    â†”  H (æ•ˆåº”å¤„ç†å™¨)
  Ïƒ (è°ƒåº¦å‡½æ•°)    â†”  handle (æ•ˆåº”å¤„ç†)
```

**è¯æ˜æ€è·¯**ï¼š

1. **çŠ¶æ€æ˜ å°„**ï¼šè°ƒåº¦çŠ¶æ€å¯¹åº”æ•ˆåº”ç­¾åï¼Œä¸¤è€…éƒ½æè¿°ç³»ç»Ÿçš„å¯èƒ½è¡Œä¸º
2. **åŠ¨ä½œæ˜ å°„**ï¼šè°ƒåº¦åŠ¨ä½œï¼ˆåˆ†é…ã€æŠ¢å ï¼‰å¯¹åº”æ•ˆåº”æ“ä½œï¼ˆAllocateã€Preemptï¼‰
3. **ç­–ç•¥æ˜ å°„**ï¼šè°ƒåº¦ç­–ç•¥ï¼ˆFIFOã€ä¼˜å…ˆçº§ï¼‰å¯¹åº”æ•ˆåº”å¤„ç†å™¨ï¼ˆä¸åŒhandlerå®ç°ï¼‰
4. **å‡½æ•°æ˜ å°„**ï¼šè°ƒåº¦å‡½æ•°Ïƒä¸handleéƒ½æ‰§è¡ŒçŠ¶æ€è½¬æ¢

**æ¨è®º 1.1**ï¼šè°ƒåº¦ç³»ç»Ÿçš„ç»„åˆæ€§ç”±æ•ˆåº”ç³»ç»Ÿçš„ä»£æ•°æ€§è´¨ä¿è¯ã€‚

### 1.5 è®¾è®¡åŸç†ä¸åŠ¨æœº

#### 1.5.1 ä¸ºä»€ä¹ˆåˆ†ç¦»æ•ˆåº”è§¦å‘ä¸å¤„ç†ï¼Ÿ

**é—®é¢˜**ï¼šä¼ ç»ŸMonadå°†æ•ˆåº”ä¸è®¡ç®—ç´§å¯†è€¦åˆï¼Œå¯¼è‡´ï¼š

- éš¾ä»¥ç»„åˆå¤šä¸ªæ•ˆåº”
- éš¾ä»¥æ›¿æ¢æ•ˆåº”å®ç°
- éš¾ä»¥æµ‹è¯•å’Œæ¨¡æ‹Ÿ

**è§£å†³æ–¹æ¡ˆ**ï¼šä»£æ•°æ•ˆåº”é€šè¿‡åˆ†ç¦»**å£°æ˜**ï¼ˆperformï¼‰å’Œ**å®ç°**ï¼ˆhandlerï¼‰å®ç°è§£è€¦ã€‚

**ä¼˜åŠ¿è®ºè¯**ï¼š

```text
ä¼ ç»ŸMonadæ–¹å¼:
  compute :: State s a â†’ State s b
  é—®é¢˜ï¼šStateæ•ˆåº”ç¡¬ç¼–ç ï¼Œæ— æ³•æ›¿æ¢ä¸ºå…¶ä»–çŠ¶æ€ç®¡ç†æ–¹å¼

ä»£æ•°æ•ˆåº”æ–¹å¼:
  compute :: (Has State Îµ) => a â†’ b ! Îµ
  ä¼˜åŠ¿ï¼šå¯ä»¥ä¼ å…¥ä¸åŒçš„State handlerï¼Œå®ç°å¯æ›¿æ¢
```

#### 1.5.2 è°ƒåº¦ç³»ç»Ÿçš„æ•ˆåº”æŠ½è±¡

**æ ¸å¿ƒæ´å¯Ÿ**ï¼šè°ƒåº¦å†³ç­–æœ¬è´¨ä¸Šæ˜¯**æ§åˆ¶æµæ•ˆåº”**ï¼Œè€Œéæ•°æ®è®¡ç®—ã€‚

**è®ºè¯**ï¼š

1. **éå±€éƒ¨æ€§**ï¼šè°ƒåº¦å†³ç­–å½±å“æ•´ä¸ªç³»ç»Ÿï¼Œä¸å±€é™äºå•ä¸ªå‡½æ•°
2. **å¯ç»„åˆæ€§**ï¼šå¤šä¸ªè°ƒåº¦ç­–ç•¥éœ€è¦ç»„åˆï¼ˆå¦‚ä¼˜å…ˆçº§+å…¬å¹³æ€§ï¼‰
3. **å¯æ›¿æ¢æ€§**ï¼šåŒä¸€ä½œä¸šåœ¨ä¸åŒè°ƒåº¦ç­–ç•¥ä¸‹è¡Œä¸ºä¸åŒ

**å½¢å¼åŒ–è¡¨è¿°**ï¼š

```text
è°ƒåº¦æ•ˆåº” Îµ_schedule = {
  Allocate: ResourceSpec â†’ ResourceHandle,
  Release: ResourceHandle â†’ Unit,
  Schedule: Task â†’ TaskId,
  Preempt: TaskId â†’ Unit
}

è°ƒåº¦å¤„ç†å™¨ H_schedule = {
  Allocate â†’ èµ„æºåˆ†é…ç­–ç•¥,
  Release â†’ èµ„æºé‡Šæ”¾ç­–ç•¥,
  Schedule â†’ ä»»åŠ¡è°ƒåº¦ç­–ç•¥,
  Preempt â†’ æŠ¢å ç­–ç•¥
}
```

---

## 2 æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((ä»£æ•°æ•ˆåº”))
    æ•ˆåº”å£°æ˜
      effectå…³é”®å­—
      æ“ä½œç­¾å
      æ•ˆåº”å‚æ•°
    æ•ˆåº”è§¦å‘
      perform
      yield
      raise
    æ•ˆåº”å¤„ç†
      handler
        returnåˆ†æ”¯
        æ“ä½œåˆ†æ”¯
      resumeç»§ç»­
      æ·±/æµ…å¤„ç†
    æ•ˆåº”ç»„åˆ
      æ•ˆåº”å¤šæ€
      æ•ˆåº”è¡Œ
      æ•ˆåº”å­ç±»å‹
    è°ƒåº¦æ˜ å°„
      èµ„æºæ•ˆåº”
      çŠ¶æ€æ•ˆåº”
      å¼‚æ­¥æ•ˆåº”
      å¹¶å‘æ•ˆåº”
```

---

## 3 ä»£æ•°æ•ˆåº”ç†è®º

### 3.1 æ•ˆåº”ç­¾åå®šä¹‰

```ocaml
(* OCaml 5.0+ ä»£æ•°æ•ˆåº”ç¤ºä¾‹ *)

(* æ•ˆåº”å£°æ˜ *)
effect Yield : unit
effect Async : 'a promise -> 'a
effect Fork : (unit -> unit) -> unit
effect GetState : 'a
effect SetState : 'a -> unit

(* è°ƒåº¦ç›¸å…³æ•ˆåº” *)
effect Allocate : resource_spec -> resource_handle
effect Release : resource_handle -> unit
effect Schedule : task -> task_id
effect Preempt : task_id -> unit
```

### 3.2 æ•ˆåº”è¯­ä¹‰

```text
æ•ˆåº”æ“ä½œè¯­ä¹‰:

performè§„åˆ™:
  E[perform op v] â†’ E[k] where handler handles op with k

handlerè§„åˆ™:
  handle e with H â†’
    match e with
    | return v â†’ H.return v
    | perform op v k â†’ H.op v (Î»x. handle (k x) with H)

resumeè¯­ä¹‰:
  resume: (Î± â†’ Î²!Îµ) â†’ Î± â†’ Î²!Îµ
  resume k v = k v  -- ç»§ç»­æ‰§è¡Œè¢«æš‚åœçš„è®¡ç®—
```

### 3.3 ç±»å‹ç³»ç»Ÿ

```text
æ•ˆåº”ç±»å‹è§„åˆ™:

(T-Perform)
  Î“ âŠ¢ e : A    op : A â†’ B âˆˆ Î£
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Î“ âŠ¢ perform op e : B ! {op}

(T-Handle)
  Î“ âŠ¢ e : Ï„ ! Îµ âˆª {op}
  Î“ âŠ¢ H : handler(op, Ï„, Ï„')
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Î“ âŠ¢ handle e with H : Ï„' ! Îµ

(T-Return)
  Î“ âŠ¢ e : Ï„ ! âˆ…
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Î“ âŠ¢ return e : Ï„ ! âˆ…

æ•ˆåº”å­ç±»å‹:
  Îµâ‚ âŠ† Îµâ‚‚
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Ï„ ! Îµâ‚ <: Ï„ ! Îµâ‚‚
```

#### 3.3.1 ç±»å‹ç³»ç»Ÿçš„è¯­ä¹‰è§£é‡Š

**ç±»å‹è§„åˆ™çš„å«ä¹‰**ï¼š

1. **T-Performè§„åˆ™**ï¼š
   - **å‰æ**ï¼šè¡¨è¾¾å¼eæœ‰ç±»å‹Aï¼Œæ“ä½œopå°†Aæ˜ å°„åˆ°B
   - **ç»“è®º**ï¼šperformæ“ä½œäº§ç”Ÿç±»å‹Bçš„å€¼ï¼Œå¹¶å¼•å…¥æ•ˆåº”{op}
   - **è¯­ä¹‰**ï¼šæ‰§è¡Œæ“ä½œopä¼šè§¦å‘ç›¸åº”çš„æ•ˆåº”ï¼Œç±»å‹ç³»ç»Ÿè¿½è¸ªè¿™ä¸ªæ•ˆåº”

2. **T-Handleè§„åˆ™**ï¼š
   - **å‰æ**ï¼šè¡¨è¾¾å¼eæœ‰æ•ˆåº”Îµâˆª{op}ï¼Œå¤„ç†å™¨Hå¯ä»¥å¤„ç†op
   - **ç»“è®º**ï¼šå¤„ç†åæ•ˆåº”å‡å°‘ä¸ºÎµï¼ˆç§»é™¤äº†{op}ï¼‰
   - **è¯­ä¹‰**ï¼šå¤„ç†å™¨"æ¶ˆè´¹"äº†æ•ˆåº”ï¼Œå°†å…¶è½¬æ¢ä¸ºå…·ä½“å®ç°

3. **æ•ˆåº”å­ç±»å‹è§„åˆ™**ï¼š
   - **å«ä¹‰**ï¼šæ•ˆåº”é›†åˆçš„åŒ…å«å…³ç³»å¯¹åº”ç±»å‹çš„å­ç±»å‹å…³ç³»
   - **ç›´è§‰**ï¼šèƒ½å¤„ç†æ›´å¤šæ•ˆåº”çš„å‡½æ•°æ›´é€šç”¨ï¼ˆåå˜ï¼‰

#### 3.3.2 ç±»å‹å®‰å…¨æ€§è´¨

**å®šç† 3.1**ï¼ˆæ•ˆåº”ç±»å‹å®‰å…¨ï¼‰ï¼š

```text
å¦‚æœ Î“ âŠ¢ e : Ï„ ! Îµï¼Œåˆ™ï¼š
  1. eçš„æ‰€æœ‰æ•ˆåº”éƒ½åœ¨Îµä¸­
  2. æ‰€æœ‰performæ“ä½œéƒ½æœ‰å¯¹åº”çš„handler
  3. æ•ˆåº”ä¸ä¼š"æ³„æ¼"åˆ°æœªå£°æ˜çš„ä¸Šä¸‹æ–‡
```

**è¯æ˜**ï¼šé€šè¿‡ç»“æ„å½’çº³åœ¨ç±»å‹æ¨å¯¼æ ‘ä¸Šè¿›è¡Œã€‚

**å®šç† 3.2**ï¼ˆæ•ˆåº”ç»„åˆæ€§ï¼‰ï¼š

```text
å¦‚æœ Î“ âŠ¢ eâ‚ : Ï„â‚ ! Îµâ‚ ä¸” Î“ âŠ¢ eâ‚‚ : Ï„â‚‚ ! Îµâ‚‚ï¼Œ
åˆ™ Î“ âŠ¢ (eâ‚, eâ‚‚) : (Ï„â‚, Ï„â‚‚) ! (Îµâ‚ âˆª Îµâ‚‚)
```

**è¯æ˜**ï¼šæ•ˆåº”çš„å¹¶é›†è¿ç®—æ»¡è¶³ç»“åˆå¾‹å’Œäº¤æ¢å¾‹ã€‚

#### 3.3.3 æ•ˆåº”æ¨æ–­ç®—æ³•

**ç®—æ³•æè¿°**ï¼š

```text
infer_effects(expr):
  case expr:
    | perform op e ->
        let (Ï„, Îµ) = infer_effects(e)
        in (op.result_type, Îµ âˆª {op})

    | handle e with H ->
        let (Ï„, Îµ) = infer_effects(e)
        in (Ï„, Îµ - H.handled_effects)

    | eâ‚; eâ‚‚ ->
        let (Ï„â‚, Îµâ‚) = infer_effects(eâ‚)
        let (Ï„â‚‚, Îµâ‚‚) = infer_effects(eâ‚‚)
        in (Ï„â‚‚, Îµâ‚ âˆª Îµâ‚‚)
```

**å¤æ‚åº¦**ï¼šO(nÂ·m)ï¼Œå…¶ä¸­næ˜¯è¡¨è¾¾å¼å¤§å°ï¼Œmæ˜¯æ•ˆåº”æ•°é‡ã€‚

**æ­£ç¡®æ€§**ï¼šç®—æ³•ä¿è¯æ¨æ–­çš„æ•ˆåº”é›†åˆæ˜¯**æœ€å°ä¸Šç•Œ**ï¼ˆleast upper boundï¼‰ã€‚

---

## 4 æ•ˆåº”å¤„ç†å™¨

### 4.1 å¤„ç†å™¨å®šä¹‰

```ocaml
(* åŸºæœ¬å¤„ç†å™¨ç»“æ„ *)
type ('a, 'b) handler = {
  return: 'a -> 'b;
  ops: effect_handlers
}

(* çŠ¶æ€æ•ˆåº”å¤„ç†å™¨ *)
let state_handler init = {
  return = (fun x -> fun _s -> x);
  ops = function
    | GetState -> (fun k -> fun s -> k s s)
    | SetState s' -> (fun k -> fun _s -> k () s')
}

(* è°ƒåº¦æ•ˆåº”å¤„ç†å™¨ *)
let scheduler_handler queue = {
  return = (fun x -> x);
  ops = function
    | Yield -> (fun k ->
        Queue.push k queue;
        match Queue.pop queue with
        | Some k' -> k' ()
        | None -> ())
    | Fork f -> (fun k ->
        Queue.push k queue;
        f ())
}
```

### 4.2 æ·±æµ…å¤„ç†å™¨

```text
æ·±å¤„ç†å™¨ (Deep Handler):
  - é€’å½’å¤„ç†æ‰€æœ‰åç»­æ•ˆåº”
  - å¤„ç†å™¨åŒ…è£¹æ•´ä¸ªè®¡ç®—
  - ç±»ä¼¼try-catch

æµ…å¤„ç†å™¨ (Shallow Handler):
  - åªå¤„ç†ä¸€æ¬¡æ•ˆåº”
  - éœ€è¦æ˜¾å¼é‡æ–°å®‰è£…
  - æ›´ç»†ç²’åº¦æ§åˆ¶

æ·±å¤„ç†å™¨è¯­ä¹‰:
  handle^deep e with H =
    match e with
    | return v â†’ H.return v
    | perform op v k â†’
        H.op v (Î»x. handle^deep (k x) with H)

æµ…å¤„ç†å™¨è¯­ä¹‰:
  handle^shallow e with H =
    match e with
    | return v â†’ H.return v
    | perform op v k â†’ H.op v k  -- kä¸åŒ…è£…
```

#### 4.2.1 æ·±æµ…å¤„ç†å™¨çš„å½¢å¼åŒ–å®šä¹‰

**æ·±å¤„ç†å™¨ï¼ˆDeep Handlerï¼‰**ï¼š

**å®šä¹‰ 4.1**ï¼šæ·±å¤„ç†å™¨H^deepé€’å½’åœ°å¤„ç†è®¡ç®—ä¸­çš„æ‰€æœ‰æ•ˆåº”æ“ä½œã€‚

**å½¢å¼åŒ–è¯­ä¹‰**ï¼š

```text
handle^deep : âˆ€Î±,Î²,Îµ. (Î± ! Îµ) â†’ Handler(Îµ, Î±, Î²) â†’ Î² ! Îµ'

å…¶ä¸­ï¼š
  - è®¡ç®—eçš„ç±»å‹ä¸º Î± ! Îµ
  - å¤„ç†å™¨Hå¤„ç†æ•ˆåº”Îµï¼Œå°†Î±è½¬æ¢ä¸ºÎ²
  - ç»“æœç±»å‹ä¸º Î² ! Îµ'ï¼ˆÎµ' âŠ† Îµï¼Œæœªå¤„ç†çš„æ•ˆåº”ï¼‰
```

**å…³é”®æ€§è´¨**ï¼š

- **é€’å½’æ€§**ï¼šå¤„ç†å™¨è‡ªåŠ¨åŒ…è£¹æ‰€æœ‰åç»­è®¡ç®—
- **é€æ˜æ€§**ï¼šè®¡ç®—å†…éƒ¨çœ‹ä¸åˆ°å¤„ç†å™¨å­˜åœ¨
- **ç»„åˆæ€§**ï¼šå¤šä¸ªæ·±å¤„ç†å™¨å¯ä»¥åµŒå¥—

**å®šç† 4.1**ï¼ˆæ·±å¤„ç†å™¨ç»„åˆå¾‹ï¼‰ï¼š

```text
handle^deep (handle^deep e with Hâ‚) with Hâ‚‚
  = handle^deep e with (compose_deep Hâ‚ Hâ‚‚)
```

**æµ…å¤„ç†å™¨ï¼ˆShallow Handlerï¼‰**ï¼š

**å®šä¹‰ 4.2**ï¼šæµ…å¤„ç†å™¨H^shallowåªå¤„ç†ä¸€æ¬¡æ•ˆåº”æ“ä½œï¼Œä¸é€’å½’åŒ…è£¹åç»­è®¡ç®—ã€‚

**å½¢å¼åŒ–è¯­ä¹‰**ï¼š

```text
handle^shallow : âˆ€Î±,Î²,Îµ. (Î± ! Îµ) â†’ Handler(Îµ, Î±, Î²) â†’ Î² ! Îµ

å…¶ä¸­ï¼š
  - åªå¤„ç†å½“å‰å±‚çš„æ•ˆåº”
  - åç»­è®¡ç®—ä¸­çš„æ•ˆåº”éœ€è¦æ˜¾å¼å¤„ç†
```

**å…³é”®æ€§è´¨**ï¼š

- **ä¸€æ¬¡æ€§**ï¼šåªå¤„ç†å½“å‰æ•ˆåº”ï¼Œä¸é€’å½’
- **æ˜¾å¼æ€§**ï¼šéœ€è¦æ˜¾å¼é‡æ–°å®‰è£…å¤„ç†å™¨
- **çµæ´»æ€§**ï¼šå¯ä»¥åŠ¨æ€åˆ‡æ¢å¤„ç†å™¨

#### 4.2.2 æ·±æµ…å¤„ç†å™¨çš„é€‰æ‹©åŸåˆ™

**ä½•æ—¶ä½¿ç”¨æ·±å¤„ç†å™¨**ï¼š

1. **é€æ˜æŠ½è±¡**ï¼šå¸Œæœ›è®¡ç®—ä»£ç ä¸æ„ŸçŸ¥æ•ˆåº”å¤„ç†
2. **å…¨å±€ç­–ç•¥**ï¼šæ•ˆåº”å¤„ç†ç­–ç•¥é€‚ç”¨äºæ•´ä¸ªè®¡ç®—
3. **ç®€å•åœºæ™¯**ï¼šä¸éœ€è¦åŠ¨æ€åˆ‡æ¢å¤„ç†å™¨

**ä½•æ—¶ä½¿ç”¨æµ…å¤„ç†å™¨**ï¼š

1. **ç»†ç²’åº¦æ§åˆ¶**ï¼šéœ€è¦é’ˆå¯¹ä¸åŒé˜¶æ®µä½¿ç”¨ä¸åŒå¤„ç†å™¨
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šé¿å…ä¸å¿…è¦çš„å¤„ç†å™¨åŒ…è£…å¼€é”€
3. **åŠ¨æ€ç­–ç•¥**ï¼šå¤„ç†å™¨é€‰æ‹©ä¾èµ–äºè¿è¡Œæ—¶çŠ¶æ€

**è°ƒåº¦ç³»ç»Ÿå¯¹åº”**ï¼š

- **æ·±å¤„ç†å™¨** â†” **å…¨å±€è°ƒåº¦ç­–ç•¥**ï¼ˆå¦‚æ•´ä¸ªé›†ç¾¤çš„ç»Ÿä¸€è°ƒåº¦å™¨ï¼‰
- **æµ…å¤„ç†å™¨** â†” **å±€éƒ¨è°ƒåº¦ç­–ç•¥**ï¼ˆå¦‚ç‰¹å®šå‘½åç©ºé—´çš„è°ƒåº¦ç­–ç•¥ï¼‰

#### 4.2.3 å¤„ç†å™¨è½¬æ¢å®šç†

**å®šç† 4.2**ï¼ˆæ·±æµ…è½¬æ¢ï¼‰ï¼š

```text
å¯¹äºä»»ä½•æ·±å¤„ç†å™¨H^deepï¼Œå­˜åœ¨ç­‰ä»·çš„æµ…å¤„ç†å™¨åºåˆ—ï¼š

  handle^deep e with H^deep
    = handle^shallow (handle^shallow ... (handle^shallow e with Hâ‚) ... with Hâ‚™) with Hâ‚™â‚Šâ‚

å…¶ä¸­Hâ‚, ..., Hâ‚™â‚Šâ‚æ˜¯H^deepçš„åˆ†è§£ã€‚
```

**è¯æ˜æ€è·¯**ï¼šé€šè¿‡ç»“æ„å½’çº³ï¼Œå°†é€’å½’å¤„ç†å±•å¼€ä¸ºæ˜¾å¼åºåˆ—ã€‚

**åº”ç”¨**ï¼šåœ¨éœ€è¦æ€§èƒ½ä¼˜åŒ–çš„åœºæ™¯ï¼Œå¯ä»¥å°†æ·±å¤„ç†å™¨è½¬æ¢ä¸ºæµ…å¤„ç†å™¨åºåˆ—ã€‚

### 4.3 å¤„ç†å™¨ç»„åˆ

```ocaml
(* å¤„ç†å™¨ç»„åˆ *)
let compose_handlers h1 h2 = {
  return = (fun x -> h2.return (h1.return x));
  ops = (fun eff ->
    try h1.ops eff
    with Unhandled -> h2.ops eff)
}

(* æ•ˆåº”éš§é“ - é€ä¼ æœªå¤„ç†æ•ˆåº” *)
let tunnel_handler handled_effect other_handler = {
  return = other_handler.return;
  ops = function
    | eff when eff = handled_effect ->
        handle_specific eff
    | eff ->
        (* é€ä¼ ç»™å¤–å±‚ *)
        perform eff
}
```

---

## 5 è°ƒåº¦æ§åˆ¶æ•ˆåº”

### 5.1 èµ„æºåˆ†é…æ•ˆåº”

```ocaml
(* èµ„æºæ•ˆåº”å®šä¹‰ *)
effect Allocate : resource_request -> resource_handle
effect Release : resource_handle -> unit
effect Resize : resource_handle * int -> unit

(* èµ„æºçº¦æŸæ•ˆåº” *)
type resource_constraint = {
  cpu_limit: float;
  memory_limit: int;
  gpu_count: int;
}

effect WithConstraint : resource_constraint -> unit

(* èµ„æºè°ƒåº¦å¤„ç†å™¨ *)
let resource_scheduler cluster = {
  return = (fun x -> x);
  ops = function
    | Allocate req -> (fun k ->
        match find_available_node cluster req with
        | Some node ->
            let handle = allocate_on_node node req in
            k handle
        | None ->
            (* æ’é˜Ÿç­‰å¾… *)
            enqueue_request req k)
    | Release handle -> (fun k ->
        deallocate handle;
        (* å”¤é†’ç­‰å¾…çš„è¯·æ±‚ *)
        process_pending_requests cluster;
        k ())
}
```

### 5.2 å¹¶å‘æ§åˆ¶æ•ˆåº”

```ocaml
(* å¹¶å‘æ•ˆåº” *)
effect Spawn : (unit -> 'a) -> 'a fiber
effect Await : 'a fiber -> 'a
effect Yield : unit
effect Cancel : 'a fiber -> unit

(* åä½œå¼è°ƒåº¦å™¨ *)
let cooperative_scheduler () =
  let run_queue = Queue.create () in
  let blocked = Hashtbl.create 16 in

  {
    return = (fun x -> x);
    ops = function
      | Spawn f -> (fun k ->
          let fiber_id = fresh_id () in
          Queue.push (fiber_id, f) run_queue;
          k fiber_id)
      | Await fiber_id -> (fun k ->
          Hashtbl.add blocked fiber_id k;
          schedule_next run_queue)
      | Yield -> (fun k ->
          Queue.push (current_fiber (), k) run_queue;
          schedule_next run_queue)
      | Cancel fiber_id -> (fun k ->
          remove_fiber fiber_id;
          k ())
  }

(* æŠ¢å å¼è°ƒåº¦å™¨ *)
let preemptive_scheduler time_slice =
  effect TimeSliceExpired : unit

  {
    return = (fun x -> x);
    ops = function
      | TimeSliceExpired -> (fun k ->
          Queue.push k run_queue;
          schedule_next run_queue)
      | other -> cooperative_scheduler().ops other
  }
```

### 5.3 çŠ¶æ€ç®¡ç†æ•ˆåº”

```ocaml
(* çŠ¶æ€æ•ˆåº” *)
effect Get : 'a
effect Put : 'a -> unit
effect Modify : ('a -> 'a) -> unit

(* åˆ†å¸ƒå¼çŠ¶æ€æ•ˆåº” *)
effect DistGet : key -> value option
effect DistPut : key * value -> unit
effect DistCAS : key * value * value -> bool

(* StatefulSetçŠ¶æ€å¤„ç†å™¨ *)
let statefulset_handler etcd_client = {
  return = (fun x -> x);
  ops = function
    | DistGet key -> (fun k ->
        let value = Etcd.get etcd_client key in
        k value)
    | DistPut (key, value) -> (fun k ->
        Etcd.put etcd_client key value;
        k ())
    | DistCAS (key, expected, new_val) -> (fun k ->
        let success = Etcd.cas etcd_client key expected new_val in
        k success)
}
```

---

## 6 å®è·µåº”ç”¨

### 6.1 K8sæ§åˆ¶å™¨æ•ˆåº”æ¨¡å‹

```ocaml
(* K8sæ§åˆ¶å™¨æ•ˆåº” *)
effect Watch : resource_type -> resource_event stream
effect Create : resource -> resource
effect Update : resource -> resource
effect Delete : resource -> unit
effect GetStatus : resource -> status

(* Reconcileræ•ˆåº”å¤„ç†å™¨ *)
let reconciler_handler api_client = {
  return = (fun x -> x);
  ops = function
    | Watch res_type -> (fun k ->
        let stream = Api.watch api_client res_type in
        k stream)
    | Create res -> (fun k ->
        let created = Api.create api_client res in
        k created)
    | Update res -> (fun k ->
        let updated = Api.update api_client res in
        k updated)
    | Delete res -> (fun k ->
        Api.delete api_client res;
        k ())
}

(* ä½¿ç”¨æ•ˆåº”çš„æ§åˆ¶å™¨ *)
let deployment_controller () =
  let events = perform (Watch Deployment) in
  Stream.iter (fun event ->
    match event with
    | Added dep -> reconcile_deployment dep
    | Modified dep -> reconcile_deployment dep
    | Deleted dep -> cleanup_deployment dep
  ) events

and reconcile_deployment dep =
  let current_replicas = perform (GetStatus dep) in
  let desired = dep.spec.replicas in
  if current_replicas < desired then
    for _ = 1 to (desired - current_replicas) do
      let pod = create_pod_spec dep in
      perform (Create pod)
    done
  else if current_replicas > desired then
    (* ç¼©å®¹é€»è¾‘ *)
    scale_down dep (current_replicas - desired)
```

### 6.2 Serverlesså‡½æ•°æ•ˆåº”

```ocaml
(* Serverlessæ•ˆåº” *)
effect Invoke : function_name * input -> output
effect Sleep : duration -> unit
effect Log : string -> unit
effect GetSecret : secret_name -> string

(* å†·å¯åŠ¨ä¼˜åŒ–å¤„ç†å™¨ *)
let serverless_handler pool = {
  return = (fun x -> x);
  ops = function
    | Invoke (fname, input) -> (fun k ->
        match Pool.get_warm pool fname with
        | Some instance ->
            let result = Instance.invoke instance input in
            k result
        | None ->
            (* å†·å¯åŠ¨ *)
            let instance = Pool.cold_start pool fname in
            let result = Instance.invoke instance input in
            Pool.keep_warm pool fname instance;
            k result)
    | Sleep duration -> (fun k ->
        (* æŒ‚èµ·å‡½æ•°ï¼Œé‡Šæ”¾èµ„æº *)
        suspend_function duration k)
}
```

---

## 7 çŸ¥è¯†çŸ©é˜µ

### 7.1 æ•ˆåº”ç³»ç»Ÿå¯¹æ¯”

| è¯­è¨€/ç³»ç»Ÿ | æ•ˆåº”ç±»å‹ | å¤„ç†å™¨ | ç»„åˆæ€§ | æ€§èƒ½ |
|---------|---------|-------|-------|------|
| **OCaml 5** | ä»£æ•°æ•ˆåº” | æ·±/æµ… | é«˜ | é«˜ |
| **Koka** | è¡Œå¤šæ€æ•ˆåº” | æ·± | é«˜ | ä¸­ |
| **Eff** | ä»£æ•°æ•ˆåº” | æ·± | é«˜ | ä½ |
| **Haskell** | Monad | Transformer | ä¸­ | ä¸­ |
| **Rust** | async/await | è¿è¡Œæ—¶ | ä¸­ | é«˜ |

### 7.2 æ•ˆåº”-è°ƒåº¦æ˜ å°„

| æ•ˆåº”ç±»å‹ | è°ƒåº¦æ¦‚å¿µ | K8så¯¹åº” |
|---------|---------|---------|
| **State** | æœ‰çŠ¶æ€è°ƒåº¦ | StatefulSet |
| **Async** | å¼‚æ­¥è°ƒåº¦ | Job/CronJob |
| **Resource** | èµ„æºè°ƒåº¦ | ResourceQuota |
| **Concurrency** | å¹¶å‘æ§åˆ¶ | HPA |
| **Error** | æ•…éšœå¤„ç† | Restart Policy |

---

## 8 å…³ç³»å±æ€§ä¸ä¾èµ–åˆ†æ

### 8.1 æ•ˆåº”ä¹‹é—´çš„å…³ç³»

#### 8.1.1 æ•ˆåº”ä¾èµ–å…³ç³»

**å®šä¹‰ 8.1**ï¼ˆæ•ˆåº”ä¾èµ–ï¼‰ï¼š

```text
æ•ˆåº”Îµâ‚ä¾èµ–äºæ•ˆåº”Îµâ‚‚ï¼Œè®°ä½œ Îµâ‚ âª¯ Îµâ‚‚ï¼Œå½“ä¸”ä»…å½“ï¼š
  å¤„ç†Îµâ‚çš„è®¡ç®—å¿…é¡»å‘ç”Ÿåœ¨å¤„ç†Îµâ‚‚ä¹‹åï¼Œæˆ–
  Îµâ‚çš„å®ç°éœ€è¦Îµâ‚‚æä¾›çš„åŠŸèƒ½
```

**è°ƒåº¦å¯¹åº”**ï¼š

- **èµ„æºåˆ†é…** âª¯ **ä»»åŠ¡è°ƒåº¦**ï¼šå¿…é¡»å…ˆåˆ†é…èµ„æºæ‰èƒ½è°ƒåº¦ä»»åŠ¡
- **çŠ¶æ€è¯»å–** âª¯ **çŠ¶æ€å†™å…¥**ï¼šæŸäº›å†™å…¥æ“ä½œéœ€è¦å…ˆè¯»å–å½“å‰çŠ¶æ€

**æ€§è´¨**ï¼š

- **ä¼ é€’æ€§**ï¼šå¦‚æœÎµâ‚ âª¯ Îµâ‚‚ä¸”Îµâ‚‚ âª¯ Îµâ‚ƒï¼Œåˆ™Îµâ‚ âª¯ Îµâ‚ƒ
- **åå¯¹ç§°æ€§**ï¼šå¦‚æœÎµâ‚ âª¯ Îµâ‚‚ä¸”Îµâ‚‚ âª¯ Îµâ‚ï¼Œåˆ™Îµâ‚ = Îµâ‚‚ï¼ˆæ— å¾ªç¯ä¾èµ–ï¼‰

#### 8.1.2 æ•ˆåº”ç»„åˆå…³ç³»

**å®šä¹‰ 8.2**ï¼ˆæ•ˆåº”ç»„åˆï¼‰ï¼š

```text
ä¸¤ä¸ªæ•ˆåº”Îµâ‚å’ŒÎµâ‚‚å¯ä»¥ç»„åˆï¼Œå½“ä¸”ä»…å½“ï¼š
  1. å®ƒä»¬ä¸å†²çªï¼ˆæ— èµ„æºç«äº‰ï¼‰
  2. å®ƒä»¬çš„å¤„ç†å™¨å¯ä»¥å…±å­˜
  3. ç»„åˆåçš„æ•ˆåº”æ»¡è¶³äº¤æ¢å¾‹æˆ–ç»“åˆå¾‹
```

**ç»„åˆç±»å‹**ï¼š

1. **ç‹¬ç«‹ç»„åˆ**ï¼ˆIndependentï¼‰ï¼š

   ```text
   Îµâ‚ âŠ— Îµâ‚‚ï¼šä¸¤ä¸ªæ•ˆåº”å®Œå…¨ç‹¬ç«‹ï¼Œå¯ä»¥ä»»æ„é¡ºåºå¤„ç†
   æ€§è´¨ï¼šhandle(e, Hâ‚ âŠ— Hâ‚‚) = handle(handle(e, Hâ‚), Hâ‚‚)
   ```

2. **é¡ºåºç»„åˆ**ï¼ˆSequentialï¼‰ï¼š

   ```text
   Îµâ‚ âˆ˜ Îµâ‚‚ï¼šå¿…é¡»æŒ‰é¡ºåºå¤„ç†ï¼ŒÎµâ‚å…ˆäºÎµâ‚‚
   æ€§è´¨ï¼šhandle(e, Hâ‚ âˆ˜ Hâ‚‚) â‰  handle(e, Hâ‚‚ âˆ˜ Hâ‚)
   ```

3. **äº’æ–¥ç»„åˆ**ï¼ˆMutually Exclusiveï¼‰ï¼š

   ```text
   Îµâ‚ âŠ• Îµâ‚‚ï¼šä¸¤ä¸ªæ•ˆåº”äº’æ–¥ï¼Œåªèƒ½å¤„ç†å…¶ä¸­ä¸€ä¸ª
   æ€§è´¨ï¼šhandle(e, Hâ‚ âŠ• Hâ‚‚) = handle(e, Hâ‚) æˆ– handle(e, Hâ‚‚)
   ```

#### 8.1.3 æ•ˆåº”å±‚æ¬¡ç»“æ„

**å®šä¹‰ 8.3**ï¼ˆæ•ˆåº”å±‚æ¬¡ï¼‰ï¼š

```text
æ•ˆåº”å±‚æ¬¡æ˜¯ä¸€ä¸ªååºé›† (E, â‰¤)ï¼Œå…¶ä¸­ï¼š
  - Eæ˜¯æ•ˆåº”é›†åˆ
  - â‰¤æ˜¯"æ›´å…·ä½“"å…³ç³»
  - å¦‚æœÎµâ‚ â‰¤ Îµâ‚‚ï¼Œåˆ™Îµâ‚‚çš„å¤„ç†å™¨å¯ä»¥å¤„ç†Îµâ‚
```

**è°ƒåº¦ç³»ç»Ÿå±‚æ¬¡**ï¼š

```text
ResourceEffect (èµ„æºæ•ˆåº”)
  â”œâ”€ CPUAllocation (CPUåˆ†é…)
  â”œâ”€ MemoryAllocation (å†…å­˜åˆ†é…)
  â””â”€ GPUAllocation (GPUåˆ†é…)

SchedulingEffect (è°ƒåº¦æ•ˆåº”)
  â”œâ”€ TaskScheduling (ä»»åŠ¡è°ƒåº¦)
  â”œâ”€ Preemption (æŠ¢å )
  â””â”€ Migration (è¿ç§»)

StateEffect (çŠ¶æ€æ•ˆåº”)
  â”œâ”€ LocalState (æœ¬åœ°çŠ¶æ€)
  â””â”€ DistributedState (åˆ†å¸ƒå¼çŠ¶æ€)
```

### 8.2 å¤„ç†å™¨ä¹‹é—´çš„å…³ç³»

#### 8.2.1 å¤„ç†å™¨ç»„åˆå¾‹

**å®šç† 8.1**ï¼ˆå¤„ç†å™¨ç»“åˆå¾‹ï¼‰ï¼š

```text
å¯¹äºå¤„ç†å™¨Hâ‚, Hâ‚‚, Hâ‚ƒï¼š
  compose(compose(Hâ‚, Hâ‚‚), Hâ‚ƒ) = compose(Hâ‚, compose(Hâ‚‚, Hâ‚ƒ))
```

**è¯æ˜**ï¼šé€šè¿‡å¤„ç†å™¨è¯­ä¹‰çš„å±•å¼€å’Œé‡æ–°ç»„åˆã€‚

**è°ƒåº¦å¯¹åº”**ï¼šå¤šä¸ªè°ƒåº¦ç­–ç•¥çš„ç»„åˆé¡ºåºä¸å½±å“æœ€ç»ˆç»“æœï¼ˆåœ¨æ»¡è¶³ç»“åˆå¾‹çš„æƒ…å†µä¸‹ï¼‰ã€‚

#### 8.2.2 å¤„ç†å™¨äº¤æ¢å¾‹

**å®šç† 8.2**ï¼ˆå¤„ç†å™¨äº¤æ¢å¾‹ï¼‰ï¼š

```text
å¦‚æœä¸¤ä¸ªå¤„ç†å™¨Hâ‚å’ŒHâ‚‚å¤„ç†çš„æ•ˆåº”é›†åˆä¸ç›¸äº¤ï¼Œåˆ™ï¼š
  compose(Hâ‚, Hâ‚‚) = compose(Hâ‚‚, Hâ‚)
```

**è¯æ˜**ï¼šä¸ç›¸äº¤çš„æ•ˆåº”å¯ä»¥ç‹¬ç«‹å¤„ç†ï¼Œé¡ºåºæ— å…³ã€‚

**è°ƒåº¦å¯¹åº”**ï¼šå¤„ç†ä¸åŒèµ„æºçš„è°ƒåº¦ç­–ç•¥å¯ä»¥å¹¶è¡Œåº”ç”¨ã€‚

#### 8.2.3 å¤„ç†å™¨å•ä½å…ƒ

**å®šä¹‰ 8.4**ï¼ˆå•ä½å¤„ç†å™¨ï¼‰ï¼š

```text
å•ä½å¤„ç†å™¨Idæ»¡è¶³ï¼š
  compose(Id, H) = H = compose(H, Id)
```

**æ€§è´¨**ï¼šå•ä½å¤„ç†å™¨ä¸æ”¹å˜ä»»ä½•æ•ˆåº”ï¼Œç›´æ¥é€ä¼ ã€‚

### 8.3 æ•ˆåº”ä¸è°ƒåº¦çš„çº¦æŸå…³ç³»

#### 8.3.1 èµ„æºçº¦æŸ

**å®šä¹‰ 8.5**ï¼ˆèµ„æºçº¦æŸï¼‰ï¼š

```text
èµ„æºçº¦æŸCæ˜¯ä¸€ä¸ªè°“è¯ï¼Œé™åˆ¶æ•ˆåº”çš„æ‰§è¡Œï¼š
  C: Effect â†’ Bool

  å¦‚æœC(Îµ) = falseï¼Œåˆ™æ•ˆåº”Îµä¸èƒ½æ‰§è¡Œ
```

**è°ƒåº¦å¯¹åº”**ï¼š

- **CPUçº¦æŸ**ï¼šé™åˆ¶CPUåˆ†é…æ•ˆåº”
- **å†…å­˜çº¦æŸ**ï¼šé™åˆ¶å†…å­˜åˆ†é…æ•ˆåº”
- **ç½‘ç»œçº¦æŸ**ï¼šé™åˆ¶ç½‘ç»œå¸¦å®½æ•ˆåº”

#### 8.3.2 æ—¶åºçº¦æŸ

**å®šä¹‰ 8.6**ï¼ˆæ—¶åºçº¦æŸï¼‰ï¼š

```text
æ—¶åºçº¦æŸTå®šä¹‰æ•ˆåº”ä¹‹é—´çš„æ—¶é—´å…³ç³»ï¼š
  T: Effect Ã— Effect â†’ TimeRelation

  å…¶ä¸­TimeRelation âˆˆ {before, after, concurrent, exclusive}
```

**è°ƒåº¦å¯¹åº”**ï¼š

- **ä¾èµ–çº¦æŸ**ï¼šä»»åŠ¡Aå¿…é¡»åœ¨ä»»åŠ¡Bä¹‹å‰å®Œæˆ
- **å¹¶å‘çº¦æŸ**ï¼šä¸¤ä¸ªä»»åŠ¡å¯ä»¥å¹¶å‘æ‰§è¡Œ
- **äº’æ–¥çº¦æŸ**ï¼šä¸¤ä¸ªä»»åŠ¡ä¸èƒ½åŒæ—¶æ‰§è¡Œ

#### 8.3.3 ä¸€è‡´æ€§çº¦æŸ

**å®šä¹‰ 8.7**ï¼ˆä¸€è‡´æ€§çº¦æŸï¼‰ï¼š

```text
ä¸€è‡´æ€§çº¦æŸConsistencyç¡®ä¿æ•ˆåº”å¤„ç†çš„æ­£ç¡®æ€§ï¼š
  Consistency: Handler Ã— Effect â†’ Bool

  å¦‚æœConsistency(H, Îµ) = falseï¼Œåˆ™å¤„ç†å™¨Hä¸èƒ½æ­£ç¡®å¤„ç†æ•ˆåº”Îµ
```

**è°ƒåº¦å¯¹åº”**ï¼š

- **ç­–ç•¥ä¸€è‡´æ€§**ï¼šè°ƒåº¦ç­–ç•¥å¿…é¡»ä¸ç³»ç»Ÿé…ç½®ä¸€è‡´
- **èµ„æºä¸€è‡´æ€§**ï¼šèµ„æºåˆ†é…å¿…é¡»æ»¡è¶³ç‰©ç†çº¦æŸ
- **çŠ¶æ€ä¸€è‡´æ€§**ï¼šçŠ¶æ€æ›´æ–°å¿…é¡»ä¿æŒç³»ç»Ÿä¸€è‡´æ€§

### 8.4 å½¢å¼åŒ–å…³ç³»å›¾

```mermaid
graph TB
    subgraph "æ•ˆåº”å…³ç³»"
        E1[æ•ˆåº”Îµâ‚] -->|ä¾èµ–| E2[æ•ˆåº”Îµâ‚‚]
        E3[æ•ˆåº”Îµâ‚ƒ] -->|ç»„åˆ| E4[æ•ˆåº”Îµâ‚„]
        E5[æ•ˆåº”Îµâ‚…] -->|å±‚æ¬¡| E6[æ•ˆåº”Îµâ‚†]
    end

    subgraph "å¤„ç†å™¨å…³ç³»"
        H1[å¤„ç†å™¨Hâ‚] -->|ç»„åˆ| H2[å¤„ç†å™¨Hâ‚‚]
        H3[å¤„ç†å™¨Hâ‚ƒ] -->|äº¤æ¢| H4[å¤„ç†å™¨Hâ‚„]
    end

    subgraph "çº¦æŸå…³ç³»"
        C1[èµ„æºçº¦æŸ] -->|é™åˆ¶| E1
        C2[æ—¶åºçº¦æŸ] -->|é™åˆ¶| E3
        C3[ä¸€è‡´æ€§çº¦æŸ] -->|é™åˆ¶| H1
    end

    E1 -->|å¤„ç†| H1
    E2 -->|å¤„ç†| H2
```

## 9 è·¨è§†è§’é“¾æ¥

### 9.1 å½¢å¼è¯­è¨€è§†è§’å…³è”

- [æ•ˆåº”ç®¡ç†åŸºç¡€](./07.1_æ•ˆåº”ç®¡ç†åŸºç¡€.md) - æ•ˆåº”ç†è®ºåŸºç¡€
- [Monadicè®¡ç®—](./07.3_StatefulSetä¸Monadicè®¡ç®—.md) - Monadä¸æ•ˆåº”
- [èŒƒç•´è®ºè§†è§’](../09_å½¢å¼åŒ–ç†è®º/09.1_èŒƒç•´è®ºè§†è§’.md) - æ•ˆåº”çš„èŒƒç•´è¯­ä¹‰

### 9.2 è°ƒåº¦è§†è§’å…³è”

| è°ƒåº¦æ¦‚å¿µ | æ•ˆåº”å¯¹åº” | æ˜ å°„è¯´æ˜ |
|---------|---------|---------|
| **è°ƒåº¦è¯·æ±‚** | perform | è§¦å‘è°ƒåº¦æ•ˆåº” |
| **è°ƒåº¦ç­–ç•¥** | handler | å®šä¹‰è°ƒåº¦è¡Œä¸º |
| **çŠ¶æ€ç®¡ç†** | Stateæ•ˆåº” | åˆ†å¸ƒå¼çŠ¶æ€ |
| **å¹¶å‘æ§åˆ¶** | Concurrencyæ•ˆåº” | å¹¶è¡Œè°ƒåº¦ |

### 9.3 å…³ç³»å±æ€§æ˜ å°„

| æ•ˆåº”å…³ç³» | è°ƒåº¦å…³ç³» | æ˜ å°„è¯´æ˜ |
|---------|---------|---------|
| **æ•ˆåº”ä¾èµ–** | ä»»åŠ¡ä¾èµ– | è°ƒåº¦é¡ºåºçº¦æŸ |
| **æ•ˆåº”ç»„åˆ** | ç­–ç•¥ç»„åˆ | å¤šç­–ç•¥ååŒ |
| **æ•ˆåº”å±‚æ¬¡** | è°ƒåº¦å±‚æ¬¡ | å¤šçº§è°ƒåº¦å™¨ |
| **èµ„æºçº¦æŸ** | èµ„æºé™åˆ¶ | ç‰©ç†èµ„æºè¾¹ç•Œ |
| **æ—¶åºçº¦æŸ** | æ—¶é—´çª—å£ | è°ƒåº¦æ—¶é—´çº¦æŸ |
| **ä¸€è‡´æ€§çº¦æŸ** | ç­–ç•¥ä¸€è‡´æ€§ | ç³»ç»ŸçŠ¶æ€ä¸€è‡´æ€§ |

---

## å‚è€ƒèµ„æº

1. [Algebraic Effects for the Rest of Us](https://overreacted.io/algebraic-effects-for-the-rest-of-us/)
2. [OCaml 5 Effect Handlers](https://v2.ocaml.org/manual/effects.html)
3. [Koka Language](https://koka-lang.github.io/)
4. [Eff Programming Language](https://www.eff-lang.org/)

---

**è¿”å›**: [æ•ˆåº”ç³»ç»Ÿä¸»ç´¢å¼•](./README.md) | [å½¢å¼è¯­è¨€è§†è§’ä¸»ç´¢å¼•](../README.md)
