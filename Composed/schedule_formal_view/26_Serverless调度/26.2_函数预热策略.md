# 26.2 å‡½æ•°é¢„çƒ­ç­–ç•¥

> **å­ä¸»é¢˜ç¼–å·**: 26.2
> **ä¸»é¢˜**: Serverlessè°ƒåº¦
> **æœ€åæ›´æ–°**: 2025-12-02
> **æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ

---

## ğŸ“‹ ç›®å½•

- [1 æ¦‚è¿°](#1-æ¦‚è¿°)
- [2 æ€ç»´å¯¼å›¾](#2-æ€ç»´å¯¼å›¾)
- [3 é¢„çƒ­ç­–ç•¥åˆ†ç±»](#3-é¢„çƒ­ç­–ç•¥åˆ†ç±»)
- [4 é¢„æµ‹é¢„çƒ­](#4-é¢„æµ‹é¢„çƒ­)
- [5 å®ä¾‹æ± ç®¡ç†](#5-å®ä¾‹æ± ç®¡ç†)
- [6 çŸ¥è¯†çŸ©é˜µ](#6-çŸ¥è¯†çŸ©é˜µ)
- [7 å½¢å¼åŒ–æ¨¡å‹](#7-å½¢å¼åŒ–æ¨¡å‹)
- [8 è·¨è§†è§’é“¾æ¥](#8-è·¨è§†è§’é“¾æ¥)

---

## 1 æ¦‚è¿°

### 1.1 æ ¸å¿ƒæ´å¯Ÿ

å‡½æ•°é¢„çƒ­æ˜¯æ¶ˆé™¤å†·å¯åŠ¨çš„ä¸»åŠ¨ç­–ç•¥ï¼Œé€šè¿‡æå‰å‡†å¤‡å¥½å¯ç”¨å®ä¾‹æ¥å‡å°‘é¦–æ¬¡è°ƒç”¨å»¶è¿Ÿã€‚é¢„çƒ­ç­–ç•¥çš„æ ¸å¿ƒæŒ‘æˆ˜æ˜¯**é¢„æµ‹å‡†ç¡®æ€§**ä¸**èµ„æºæˆæœ¬**çš„æƒè¡¡ã€‚

### 1.2 é¢„çƒ­ç­–ç•¥åˆ†ç±»

| ç­–ç•¥ç±»å‹ | æè¿° | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|---------|------|------|------|
| **è¢«åŠ¨ä¿æŒ** | å»¶é•¿å®ä¾‹å­˜æ´»æ—¶é—´ | ç®€å• | èµ„æºæµªè´¹ |
| **é¢„ç½®å¹¶å‘** | é¢„å…ˆåˆ†é…å›ºå®šå®ä¾‹ | å¯é  | æˆæœ¬é«˜ |
| **é¢„æµ‹é¢„çƒ­** | åŸºäºé¢„æµ‹ä¸»åŠ¨é¢„çƒ­ | é«˜æ•ˆ | é¢„æµ‹éš¾ |
| **æ± åŒ–é¢„çƒ­** | ç»´æŠ¤é€šç”¨å®ä¾‹æ±  | çµæ´» | åˆå§‹åŒ–å¼€é”€ |

---

## 2 æ€ç»´å¯¼å›¾

```mermaid
mindmap
  root((å‡½æ•°é¢„çƒ­ç­–ç•¥))
    è¢«åŠ¨ç­–ç•¥
      Keep-Alive
        è¶…æ—¶å»¶é•¿
        LRUæ·˜æ±°
        å¼•ç”¨è®¡æ•°
      å®ä¾‹å¤ç”¨
        è¯·æ±‚é˜Ÿåˆ—
        å¹¶å‘å¤„ç†
    ä¸»åŠ¨ç­–ç•¥
      é¢„ç½®å¹¶å‘
        å›ºå®šå®ä¾‹æ•°
        ä¿è¯å¯ç”¨
        æŒ‰é‡è®¡è´¹
      é¢„æµ‹é¢„çƒ­
        æ—¶é—´åºåˆ—
        æœºå™¨å­¦ä¹ 
        æ¨¡å¼åŒ¹é…
    æ± åŒ–ç­–ç•¥
      çƒ­æ± 
        å®Œå…¨åˆå§‹åŒ–
        å³æ—¶å¯ç”¨
      æ¸©æ± 
        éƒ¨åˆ†åˆå§‹åŒ–
        å¿«é€Ÿå°±ç»ª
      å†·æ± 
        èµ„æºé¢„ç•™
        å¿«é€Ÿå¯åŠ¨
    è°ƒåº¦ç®—æ³•
      ä¼˜å…ˆçº§
        SLAç­‰çº§
        å†å²å»¶è¿Ÿ
      è´Ÿè½½æ„ŸçŸ¥
        å½“å‰è´Ÿè½½
        è¶‹åŠ¿é¢„æµ‹
```

---

## 3 é¢„çƒ­ç­–ç•¥åˆ†ç±»

### 3.1 Keep-Aliveç­–ç•¥

```mermaid
sequenceDiagram
    participant R as è¯·æ±‚
    participant S as è°ƒåº¦å™¨
    participant I as å®ä¾‹
    participant T as å®šæ—¶å™¨

    R->>S: è¯·æ±‚1
    S->>I: åˆ†é…å®ä¾‹
    I->>R: å“åº”
    S->>T: å¯åŠ¨Keep-Aliveå®šæ—¶å™¨

    Note over I,T: ç©ºé—²æœŸé—´
    T-->>T: å€’è®¡æ—¶

    R->>S: è¯·æ±‚2 (è¶…æ—¶å‰)
    S->>I: å¤ç”¨å®ä¾‹
    I->>R: å“åº”
    S->>T: é‡ç½®å®šæ—¶å™¨

    Note over T: è¶…æ—¶
    T->>S: è¶…æ—¶é€šçŸ¥
    S->>I: å›æ”¶å®ä¾‹
```

```python
class KeepAliveManager:
    """Keep-Aliveå®ä¾‹ç®¡ç†å™¨"""

    def __init__(self, default_timeout: float = 300.0):
        self.default_timeout = default_timeout
        self.instances: Dict[str, Instance] = {}
        self.timers: Dict[str, Timer] = {}

    def get_or_create(self, function_id: str) -> Instance:
        """è·å–æˆ–åˆ›å»ºå®ä¾‹"""
        if function_id in self.instances:
            # å¤ç”¨ç°æœ‰å®ä¾‹ï¼Œé‡ç½®å®šæ—¶å™¨
            self._reset_timer(function_id)
            return self.instances[function_id]
        else:
            # åˆ›å»ºæ–°å®ä¾‹
            instance = Instance.create(function_id)
            self.instances[function_id] = instance
            self._start_timer(function_id)
            return instance

    def _start_timer(self, function_id: str):
        """å¯åŠ¨Keep-Aliveå®šæ—¶å™¨"""
        timeout = self._get_timeout(function_id)
        timer = Timer(timeout, lambda: self._on_timeout(function_id))
        timer.start()
        self.timers[function_id] = timer

    def _reset_timer(self, function_id: str):
        """é‡ç½®å®šæ—¶å™¨"""
        if function_id in self.timers:
            self.timers[function_id].cancel()
        self._start_timer(function_id)

    def _on_timeout(self, function_id: str):
        """è¶…æ—¶å›è°ƒ"""
        if function_id in self.instances:
            self.instances[function_id].terminate()
            del self.instances[function_id]
            del self.timers[function_id]

    def _get_timeout(self, function_id: str) -> float:
        """è·å–è‡ªé€‚åº”è¶…æ—¶æ—¶é—´"""
        # å¯åŸºäºå†å²è°ƒç”¨æ¨¡å¼åŠ¨æ€è°ƒæ•´
        return self.default_timeout
```

### 3.2 é¢„ç½®å¹¶å‘ (Provisioned Concurrency)

```yaml
# AWS Lambdaé¢„ç½®å¹¶å‘é…ç½®
AWSTemplateFormatVersion: '2010-09-09'
Resources:
  MyFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: critical-function
      Runtime: nodejs18.x
      Handler: index.handler

  ProvisionedConcurrency:
    Type: AWS::Lambda::ProvisionedConcurrencyConfig
    Properties:
      FunctionName: !Ref MyFunction
      Qualifier: prod
      ProvisionedConcurrentExecutions: 10  # é¢„ç½®10ä¸ªå®ä¾‹

# æ•ˆæœ:
# - 10ä¸ªå®ä¾‹å§‹ç»ˆä¿æŒçƒ­çŠ¶æ€
# - æ— å†·å¯åŠ¨å»¶è¿Ÿ
# - æŒ‰é¢„ç½®æ—¶é—´è®¡è´¹
```

### 3.3 ç­–ç•¥å¯¹æ¯”

```mermaid
graph LR
    subgraph "è¢«åŠ¨ç­–ç•¥"
        P1[Keep-Alive]
        P2[å®ä¾‹å¤ç”¨]
    end

    subgraph "ä¸»åŠ¨ç­–ç•¥"
        A1[é¢„ç½®å¹¶å‘]
        A2[é¢„æµ‹é¢„çƒ­]
    end

    P1 -->|ä½æˆæœ¬| LC[æˆæœ¬æ•ˆç‡]
    P2 -->|ä½æˆæœ¬| LC
    A1 -->|é«˜æˆæœ¬| HC[é«˜å¯ç”¨]
    A2 -->|ä¸­æˆæœ¬| MC[æ™ºèƒ½æƒè¡¡]

    style LC fill:#ccffcc
    style HC fill:#ffcccc
    style MC fill:#ffffcc
```

---

## 4 é¢„æµ‹é¢„çƒ­

### 4.1 é¢„æµ‹æ¨¡å‹

```mermaid
graph TB
    subgraph "æ•°æ®æ”¶é›†"
        D1[å†å²è°ƒç”¨æ•°æ®]
        D2[æ—¶é—´ç‰¹å¾]
        D3[ä¸šåŠ¡äº‹ä»¶]
    end

    subgraph "ç‰¹å¾å·¥ç¨‹"
        F1[æ—¶é—´åºåˆ—ç‰¹å¾]
        F2[å‘¨æœŸæ€§ç‰¹å¾]
        F3[å¤–éƒ¨ç‰¹å¾]
    end

    subgraph "é¢„æµ‹æ¨¡å‹"
        M1[ARIMA]
        M2[LSTM]
        M3[Prophet]
    end

    subgraph "é¢„çƒ­å†³ç­–"
        W1[é¢„çƒ­æ•°é‡]
        W2[é¢„çƒ­æ—¶æœº]
    end

    D1 --> F1
    D2 --> F2
    D3 --> F3
    F1 --> M1
    F1 --> M2
    F2 --> M3
    M1 --> W1
    M2 --> W1
    M3 --> W2
```

### 4.2 é¢„æµ‹é¢„çƒ­ç®—æ³•

```python
import numpy as np
from sklearn.ensemble import RandomForestRegressor

class PredictiveWarmer:
    """é¢„æµ‹é¢„çƒ­è°ƒåº¦å™¨"""

    def __init__(self):
        self.model = RandomForestRegressor()
        self.history: Dict[str, List[CallRecord]] = defaultdict(list)

    def record_call(self, function_id: str, timestamp: datetime):
        """è®°å½•è°ƒç”¨"""
        self.history[function_id].append(CallRecord(timestamp))

    def predict_load(self, function_id: str, future_window: timedelta) -> int:
        """é¢„æµ‹æœªæ¥è´Ÿè½½"""
        features = self._extract_features(function_id, future_window)
        predicted_calls = self.model.predict([features])[0]
        return int(np.ceil(predicted_calls))

    def _extract_features(self, function_id: str, window: timedelta) -> List[float]:
        """æå–é¢„æµ‹ç‰¹å¾"""
        now = datetime.now()
        history = self.history[function_id]

        features = [
            # æ—¶é—´ç‰¹å¾
            now.hour,
            now.weekday(),
            now.day,
            # å†å²ç‰¹å¾
            self._calls_in_window(history, timedelta(hours=1)),
            self._calls_in_window(history, timedelta(days=1)),
            self._calls_in_window(history, timedelta(weeks=1)),
            # è¶‹åŠ¿ç‰¹å¾
            self._trend(history),
        ]
        return features

    def schedule_warmup(self, function_id: str):
        """è°ƒåº¦é¢„çƒ­"""
        predicted_load = self.predict_load(function_id, timedelta(minutes=5))
        current_instances = self.get_warm_instances(function_id)

        if predicted_load > current_instances:
            # éœ€è¦é¢„çƒ­æ›´å¤šå®ä¾‹
            warmup_count = predicted_load - current_instances
            self._warmup_instances(function_id, warmup_count)

    def _warmup_instances(self, function_id: str, count: int):
        """æ‰§è¡Œé¢„çƒ­"""
        for _ in range(count):
            instance = Instance.create(function_id)
            instance.initialize()  # é¢„åˆå§‹åŒ–
            self.warm_pool.add(function_id, instance)
```

### 4.3 æ—¶é—´åºåˆ—é¢„æµ‹

```python
# åŸºäºProphetçš„å‘¨æœŸæ€§é¢„æµ‹
from prophet import Prophet

class TimeSeriesPredictor:
    """æ—¶é—´åºåˆ—é¢„æµ‹å™¨"""

    def __init__(self):
        self.models: Dict[str, Prophet] = {}

    def train(self, function_id: str, history: pd.DataFrame):
        """è®­ç»ƒé¢„æµ‹æ¨¡å‹"""
        model = Prophet(
            yearly_seasonality=True,
            weekly_seasonality=True,
            daily_seasonality=True,
        )
        model.fit(history)
        self.models[function_id] = model

    def predict(self, function_id: str, periods: int) -> pd.DataFrame:
        """é¢„æµ‹æœªæ¥è´Ÿè½½"""
        model = self.models[function_id]
        future = model.make_future_dataframe(periods=periods, freq='5min')
        forecast = model.predict(future)
        return forecast[['ds', 'yhat', 'yhat_lower', 'yhat_upper']]

    def get_warmup_schedule(self, function_id: str) -> List[WarmupAction]:
        """ç”Ÿæˆé¢„çƒ­è°ƒåº¦è®¡åˆ’"""
        forecast = self.predict(function_id, periods=12)  # æœªæ¥1å°æ—¶

        schedule = []
        for _, row in forecast.iterrows():
            if row['yhat'] > self.current_capacity(function_id):
                schedule.append(WarmupAction(
                    time=row['ds'] - timedelta(minutes=5),  # æå‰5åˆ†é’Ÿ
                    target_instances=int(np.ceil(row['yhat_upper'])),
                ))

        return schedule
```

---

## 5 å®ä¾‹æ± ç®¡ç†

### 5.1 å¤šçº§å®ä¾‹æ± 

```mermaid
graph TB
    subgraph "çƒ­æ±  (Hot Pool)"
        H1[å®Œå…¨åˆå§‹åŒ–å®ä¾‹]
        H2[å³æ—¶å¯ç”¨]
        H3[é«˜æˆæœ¬ç»´æŠ¤]
    end

    subgraph "æ¸©æ±  (Warm Pool)"
        W1[éƒ¨åˆ†åˆå§‹åŒ–å®ä¾‹]
        W2[å¿«é€Ÿå°±ç»ª ~50ms]
        W3[ä¸­ç­‰æˆæœ¬]
    end

    subgraph "å†·æ±  (Cold Pool)"
        C1[èµ„æºé¢„ç•™]
        C2[éœ€å®Œæ•´å¯åŠ¨]
        C3[ä½æˆæœ¬]
    end

    REQ[è¯·æ±‚] --> H1
    H1 -->|miss| W1
    W1 -->|miss| C1

    style H1 fill:#ff9999
    style W1 fill:#ffcc99
    style C1 fill:#99ccff
```

### 5.2 æ± åŒ–ç®¡ç†ç®—æ³•

```python
class InstancePoolManager:
    """å¤šçº§å®ä¾‹æ± ç®¡ç†å™¨"""

    def __init__(self):
        self.hot_pool: Dict[str, List[Instance]] = defaultdict(list)
        self.warm_pool: Dict[str, List[Instance]] = defaultdict(list)
        self.cold_pool: Dict[str, List[Instance]] = defaultdict(list)

        # æ± å¤§å°é…ç½®
        self.config = PoolConfig(
            hot_pool_size=5,
            warm_pool_size=20,
            cold_pool_size=100,
        )

    def get_instance(self, function_id: str) -> Instance:
        """è·å–å®ä¾‹ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰"""
        # 1. å°è¯•çƒ­æ± 
        if self.hot_pool[function_id]:
            return self.hot_pool[function_id].pop()

        # 2. å°è¯•æ¸©æ± 
        if self.warm_pool[function_id]:
            instance = self.warm_pool[function_id].pop()
            instance.complete_init()  # å®Œæˆåˆå§‹åŒ–
            return instance

        # 3. å°è¯•å†·æ± 
        if self.cold_pool[function_id]:
            instance = self.cold_pool[function_id].pop()
            instance.full_init()  # å®Œæ•´åˆå§‹åŒ–
            return instance

        # 4. åˆ›å»ºæ–°å®ä¾‹
        return Instance.create(function_id)

    def return_instance(self, function_id: str, instance: Instance):
        """å½’è¿˜å®ä¾‹åˆ°æ± """
        if len(self.hot_pool[function_id]) < self.config.hot_pool_size:
            self.hot_pool[function_id].append(instance)
        else:
            instance.partial_cleanup()  # éƒ¨åˆ†æ¸…ç†
            if len(self.warm_pool[function_id]) < self.config.warm_pool_size:
                self.warm_pool[function_id].append(instance)
            else:
                instance.terminate()  # é‡Šæ”¾

    def maintain_pools(self):
        """æ± ç»´æŠ¤ä»»åŠ¡"""
        for function_id in self.get_active_functions():
            # é¢„æµ‹è´Ÿè½½
            predicted_load = self.predictor.predict(function_id)

            # è°ƒæ•´æ± å¤§å°
            self._adjust_pool_size(function_id, predicted_load)

    def _adjust_pool_size(self, function_id: str, target: int):
        """è°ƒæ•´æ± å¤§å°"""
        current = len(self.hot_pool[function_id])

        if target > current:
            # ä»æ¸©æ± æå‡åˆ°çƒ­æ± 
            to_promote = min(target - current, len(self.warm_pool[function_id]))
            for _ in range(to_promote):
                instance = self.warm_pool[function_id].pop()
                instance.complete_init()
                self.hot_pool[function_id].append(instance)
```

---

## 6 çŸ¥è¯†çŸ©é˜µ

### 6.1 é¢„çƒ­ç­–ç•¥å¯¹æ¯”çŸ©é˜µ

| ç­–ç•¥ | å»¶è¿Ÿæ¶ˆé™¤ | æˆæœ¬ | å‡†ç¡®æ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|------|-------|-------|---------|
| **Keep-Alive** | éƒ¨åˆ† | ä½ | - | ä½ | é¢‘ç¹è°ƒç”¨ |
| **é¢„ç½®å¹¶å‘** | å®Œå…¨ | é«˜ | 100% | ä½ | å…³é”®ä¸šåŠ¡ |
| **é¢„æµ‹é¢„çƒ­** | å¤§éƒ¨åˆ† | ä¸­ | 70-90% | é«˜ | æœ‰è§„å¾‹è´Ÿè½½ |
| **æ± åŒ–é¢„çƒ­** | å¤§éƒ¨åˆ† | ä¸­ | - | ä¸­ | é€šç”¨ |

### 6.2 é¢„æµ‹æ¨¡å‹å¯¹æ¯”

| æ¨¡å‹ | å‡†ç¡®ç‡ | è®­ç»ƒæˆæœ¬ | å®æ—¶æ€§ | é€‚ç”¨åœºæ™¯ |
|------|-------|---------|-------|---------|
| **ç§»åŠ¨å¹³å‡** | 60% | æä½ | é«˜ | ç®€å•å‘¨æœŸ |
| **ARIMA** | 70% | ä½ | ä¸­ | å¹³ç¨³åºåˆ— |
| **Prophet** | 80% | ä¸­ | ä¸­ | å¤šå‘¨æœŸ |
| **LSTM** | 85% | é«˜ | ä½ | å¤æ‚æ¨¡å¼ |

---

## 7 å½¢å¼åŒ–æ¨¡å‹

### 7.1 é¢„çƒ­å†³ç­–æ¨¡å‹

```text
é¢„çƒ­å†³ç­–é—®é¢˜:

ç»™å®š:
  Î»(t): æ—¶åˆ»tçš„é¢„æµ‹è¯·æ±‚ç‡
  C_warm: å•å®ä¾‹é¢„çƒ­æˆæœ¬/æ—¶é—´
  C_cold: å†·å¯åŠ¨æƒ©ç½šæˆæœ¬
  C_idle: ç©ºé—²å®ä¾‹æˆæœ¬/æ—¶é—´

å†³ç­–å˜é‡:
  N(t): æ—¶åˆ»tçš„é¢„çƒ­å®ä¾‹æ•°

ç›®æ ‡:
  minimize âˆ«[C_idle Ã— max(0, N(t) - Î»(t)) + C_cold Ã— max(0, Î»(t) - N(t))] dt

çº¦æŸ:
  N(t) â‰¥ N_min  (æœ€å°å®ä¾‹)
  N(t) â‰¤ N_max  (æœ€å¤§å®ä¾‹)
  |N(t+1) - N(t)| â‰¤ R_scale  (ä¼¸ç¼©é€Ÿç‡é™åˆ¶)
```

### 7.2 æœ€ä¼˜é¢„çƒ­æ•°é‡

```text
å®šç†: æœ€ä¼˜é¢„çƒ­å®ä¾‹æ•°

åœ¨å¹³ç¨³è´Ÿè½½å‡è®¾ä¸‹:
  N* = Î» + z_{1-Î±} Ã— Ïƒ

å…¶ä¸­:
  Î» = å¹³å‡è¯·æ±‚ç‡
  Ïƒ = è¯·æ±‚ç‡æ ‡å‡†å·®
  z_{1-Î±} = æ­£æ€åˆ†å¸ƒåˆ†ä½æ•° (SLAå¯¹åº”)

è¯æ˜:
  è®¾å†·å¯åŠ¨æ¦‚ç‡ P_cold = P(Requests > N)
  å¯¹äºæ­£æ€åˆ†å¸ƒ: P_cold = 1 - Î¦((N - Î»)/Ïƒ)

  è¦æ»¡è¶³ P_cold â‰¤ Î±:
  1 - Î¦((N - Î»)/Ïƒ) â‰¤ Î±
  (N - Î»)/Ïƒ â‰¥ z_{1-Î±}
  N â‰¥ Î» + z_{1-Î±} Ã— Ïƒ
```

---

## 8 è·¨è§†è§’é“¾æ¥

### 8.1 è°ƒåº¦è§†è§’å…³è”

- [å†·å¯åŠ¨ä¼˜åŒ–](./26.1_å†·å¯åŠ¨ä¼˜åŒ–è°ƒåº¦.md) - å†·å¯åŠ¨æŠ€æœ¯
- [èµ„æºå¼¹æ€§è°ƒåº¦](./26.3_èµ„æºå¼¹æ€§è°ƒåº¦.md) - è‡ªåŠ¨ä¼¸ç¼©
- [AIé©±åŠ¨è°ƒåº¦](../10_AIé©±åŠ¨è°ƒåº¦/) - é¢„æµ‹æ¨¡å‹

### 8.2 å½¢å¼è¯­è¨€è§†è§’å…³è”

| å½¢å¼è¯­è¨€æ¦‚å¿µ | é¢„çƒ­ç­–ç•¥å¯¹åº” | æ˜ å°„è¯´æ˜ |
|------------|------------|---------|
| **è®°å¿†åŒ–** | å®ä¾‹ç¼“å­˜ | è®¡ç®—ç»“æœå¤ç”¨ |
| **æŠ•æœºæ‰§è¡Œ** | é¢„æµ‹é¢„çƒ­ | æå‰è®¡ç®— |
| **æƒ°æ€§æ±‚å€¼** | æŒ‰éœ€åˆå§‹åŒ– | å»¶è¿Ÿåˆ°éœ€è¦æ—¶ |

---

**è¿”å›**: [Serverlessè°ƒåº¦ä¸»ç´¢å¼•](./README.md) | [è°ƒåº¦è§†è§’ä¸»ç´¢å¼•](../README.md)
