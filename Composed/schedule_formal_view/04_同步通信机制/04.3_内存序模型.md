# 4.3 å†…å­˜åºæ¨¡å‹

> **ä¸»é¢˜**: 04. åŒæ­¥é€šä¿¡æœºåˆ¶ - 4.3 å†…å­˜åºæ¨¡å‹
> **è¦†ç›–**: TSOã€å¼±ä¸€è‡´æ€§ã€acquire/releaseã€é¡ºåºä¸€è‡´æ€§

---

## ğŸ“‹ ç›®å½•

- [4.3 å†…å­˜åºæ¨¡å‹](#43-å†…å­˜åºæ¨¡å‹)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 å†…å­˜åºæ¨¡å‹ç±»å‹](#1-å†…å­˜åºæ¨¡å‹ç±»å‹)
    - [1.1 æ¨¡å‹å¯¹æ¯”](#11-æ¨¡å‹å¯¹æ¯”)
    - [1.2 é‡æ’åºç±»å‹](#12-é‡æ’åºç±»å‹)
  - [2 TSOæ¨¡å‹ï¼ˆx86ï¼‰](#2-tsoæ¨¡å‹x86)
    - [2.1 ç‰¹ç‚¹](#21-ç‰¹ç‚¹)
    - [2.2 Store Buffer](#22-store-buffer)
  - [3 å¼±ä¸€è‡´æ€§æ¨¡å‹ï¼ˆARMï¼‰](#3-å¼±ä¸€è‡´æ€§æ¨¡å‹arm)
    - [3.1 ç‰¹ç‚¹](#31-ç‰¹ç‚¹)
    - [3.2 ä½¿ç”¨ç¤ºä¾‹](#32-ä½¿ç”¨ç¤ºä¾‹)
  - [4 acquire/releaseè¯­ä¹‰](#4-acquirereleaseè¯­ä¹‰)
    - [4.1 Acquireè¯­ä¹‰](#41-acquireè¯­ä¹‰)
    - [4.2 Releaseè¯­ä¹‰](#42-releaseè¯­ä¹‰)
  - [5 é¡ºåºä¸€è‡´æ€§çš„ä¸¥æ ¼åˆ†æ](#5-é¡ºåºä¸€è‡´æ€§çš„ä¸¥æ ¼åˆ†æ)
    - [5.1 é¡ºåºä¸€è‡´æ€§å®šä¹‰](#51-é¡ºåºä¸€è‡´æ€§å®šä¹‰)
    - [5.2 C++å®ç°](#52-cå®ç°)
    - [5.3 æ€§èƒ½ä»£ä»·](#53-æ€§èƒ½ä»£ä»·)
  - [6 å®è·µæ¡ˆä¾‹](#6-å®è·µæ¡ˆä¾‹)
    - [6.1 é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—å†…å­˜åºä¼˜åŒ–](#61-é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—å†…å­˜åºä¼˜åŒ–)
    - [6.2 è‡ªæ—‹é”å†…å­˜åºä¼˜åŒ–](#62-è‡ªæ—‹é”å†…å­˜åºä¼˜åŒ–)
  - [7 å†…å­˜åºé€‰æ‹©](#7-å†…å­˜åºé€‰æ‹©)
    - [7.1 å†³ç­–æŒ‡å—](#71-å†³ç­–æŒ‡å—)
  - [8 æ€ç»´å¯¼å›¾ï¼šå†…å­˜åºæ¨¡å‹å†³ç­–æ ‘](#8-æ€ç»´å¯¼å›¾å†…å­˜åºæ¨¡å‹å†³ç­–æ ‘)
  - [9 æ‰¹åˆ¤æ€§æ€»ç»“](#9-æ‰¹åˆ¤æ€§æ€»ç»“)
    - [7.1 å†…å­˜åºæ¨¡å‹çš„æ ¹æœ¬çŸ›ç›¾](#71-å†…å­˜åºæ¨¡å‹çš„æ ¹æœ¬çŸ›ç›¾)
    - [7.2 2025å¹´å†…å­˜åºæ¨¡å‹æŠ€æœ¯è¶‹åŠ¿](#72-2025å¹´å†…å­˜åºæ¨¡å‹æŠ€æœ¯è¶‹åŠ¿)
  - [10 è·¨é¢†åŸŸæ´å¯Ÿ](#10-è·¨é¢†åŸŸæ´å¯Ÿ)
    - [8.1 å†…å­˜åºæ¨¡å‹çš„æ€§èƒ½vsæ­£ç¡®æ€§æƒè¡¡](#81-å†…å­˜åºæ¨¡å‹çš„æ€§èƒ½vsæ­£ç¡®æ€§æƒè¡¡)
    - [8.2 ç¡¬ä»¶vsè½¯ä»¶å†…å­˜åºçš„æƒè¡¡](#82-ç¡¬ä»¶vsè½¯ä»¶å†…å­˜åºçš„æƒè¡¡)
  - [11 å¤šç»´åº¦å¯¹æ¯”](#11-å¤šç»´åº¦å¯¹æ¯”)
    - [9.1 å†…å­˜åºæ¨¡å‹å¯¹æ¯”ï¼ˆ2025å¹´ï¼‰](#91-å†…å­˜åºæ¨¡å‹å¯¹æ¯”2025å¹´)
    - [9.2 å†…å­˜åºæ¨¡å‹æ¼”è¿›å¯¹æ¯”](#92-å†…å­˜åºæ¨¡å‹æ¼”è¿›å¯¹æ¯”)
  - [12 ç›¸å…³ä¸»é¢˜](#12-ç›¸å…³ä¸»é¢˜)

---

## 1 å†…å­˜åºæ¨¡å‹ç±»å‹

### 1.1 æ¨¡å‹å¯¹æ¯”

| **æ¨¡å‹** | **ç¡¬ä»¶** | **é‡æ’åºé™åˆ¶** | **ç¼–ç¨‹å¤æ‚åº¦** |
|---------|---------|---------------|--------------|
| **é¡ºåºä¸€è‡´æ€§ï¼ˆSCï¼‰** | æ—  | æ— é‡æ’åº | æœ€ç®€å• |
| **TSO** | x86 | å…è®¸Store-Loadé‡æ’ | ä¸­ç­‰ |
| **å¼±ä¸€è‡´æ€§ï¼ˆWMOï¼‰** | ARM | å…è®¸æ‰€æœ‰é‡æ’ | æœ€å¤æ‚ |

### 1.2 é‡æ’åºç±»å‹

**Load-Loadé‡æ’**ï¼š

- ä¸¤ä¸ªè¯»æ“ä½œäº¤æ¢é¡ºåº
- TSOä¸å…è®¸
- WMOå…è®¸

**Store-Storeé‡æ’**ï¼š

- ä¸¤ä¸ªå†™æ“ä½œäº¤æ¢é¡ºåº
- TSOä¸å…è®¸
- WMOå…è®¸

**Load-Storeé‡æ’**ï¼š

- è¯»å’Œå†™äº¤æ¢é¡ºåº
- TSOä¸å…è®¸
- WMOå…è®¸

**Store-Loadé‡æ’**ï¼š

- å†™å’Œè¯»äº¤æ¢é¡ºåº
- TSOå…è®¸ï¼ˆStore Bufferï¼‰
- WMOå…è®¸

---

## 2 TSOæ¨¡å‹ï¼ˆx86ï¼‰

### 2.1 ç‰¹ç‚¹

**æ¡ˆä¾‹4.3.1ï¼ˆTSOæ¨¡å‹ï¼‰**ï¼š

TSOï¼ˆTotal Store Orderingï¼‰æ˜¯x86æ¶æ„çš„å†…å­˜åºæ¨¡å‹ï¼Œåœ¨ç¼–ç¨‹ç®€å•æ€§å’Œæ€§èƒ½ä¹‹é—´åšäº†æƒè¡¡ã€‚

**Total Store Ordering**ï¼š

**TSOæ¨¡å‹è§„åˆ™**ï¼š

1. **æ‰€æœ‰å†™æ“ä½œå…¨å±€é¡ºåº**ï¼šæ‰€æœ‰æ ¸å¿ƒçœ‹åˆ°ç›¸åŒçš„å†™æ“ä½œé¡ºåº
2. **Store Bufferå¯¼è‡´Store-Loadé‡æ’**ï¼šå†™æ“ä½œå¯èƒ½è¢«ç¼“å†²ï¼Œå¯¼è‡´Store-Loadé‡æ’
3. **å…¶ä»–é‡æ’ä¸å…è®¸**ï¼šLoad-Loadã€Load-Storeã€Store-Storeé‡æ’ä¸å…è®¸

**TSOæ¨¡å‹å®ç°**ï¼š

```c
// TSOæ¨¡å‹çš„ç¡¬ä»¶å®ç°ï¼ˆä¼ªä»£ç ï¼‰
typedef struct {
    int store_buffer[STORE_BUFFER_SIZE];  // Store Buffer
    int store_buffer_head;
    int store_buffer_tail;
    cache_t *cache;                       // ç¼“å­˜
} cpu_core_t;

// Storeæ“ä½œ
void tso_store(cpu_core_t *core, int *addr, int value) {
    // 1. å†™å…¥Store Buffer
    core->store_buffer[core->store_buffer_tail] = value;
    core->store_buffer_tail = (core->store_buffer_tail + 1) % STORE_BUFFER_SIZE;

    // 2. å¼‚æ­¥å†™å›ç¼“å­˜ï¼ˆä¸é˜»å¡ï¼‰
    async_write_to_cache(core, addr, value);
}

// Loadæ“ä½œ
int tso_load(cpu_core_t *core, int *addr) {
    // 1. æ£€æŸ¥Store Bufferï¼ˆé˜²æ­¢Store-Loadé‡æ’ï¼‰
    for (int i = core->store_buffer_head; i != core->store_buffer_tail;
         i = (i + 1) % STORE_BUFFER_SIZE) {
        if (core->store_buffer[i].addr == addr) {
            return core->store_buffer[i].value;  // ä»Store Bufferè¯»å–
        }
    }

    // 2. ä»ç¼“å­˜è¯»å–
    return cache_load(core->cache, addr);
}

// å†…å­˜å±éšœï¼ˆMFENCEï¼‰
void tso_mfence(cpu_core_t *core) {
    // 1. ç­‰å¾…Store Bufferæ¸…ç©º
    while (core->store_buffer_head != core->store_buffer_tail) {
        // ç­‰å¾…æ‰€æœ‰å†™æ“ä½œå®Œæˆ
        flush_store_buffer(core);
    }

    // 2. ç¡®ä¿æ‰€æœ‰å†…å­˜æ“ä½œå®Œæˆ
    memory_barrier();
}
```

**TSOä¼˜åŠ¿**ï¼š

- **ç¼–ç¨‹ç®€å•**ï¼šå¤§å¤šæ•°åœºæ™¯æ— éœ€æ˜¾å¼å†…å­˜å±éšœ
- **å¤§å¤šæ•°åœºæ™¯æ— éœ€å†…å­˜å±éšœ**ï¼šTSOä¿è¯å¤§å¤šæ•°æ“ä½œçš„é¡ºåº
- **æ€§èƒ½ç•¥ä½**ï¼šç¡¬ä»¶å¤æ‚åº¦è¾ƒé«˜ï¼Œä½†å¯æ¥å—

**æ·±åº¦è®ºè¯ï¼šTSOæ¨¡å‹çš„æ€§èƒ½-å¤æ‚åº¦æƒè¡¡**

**TSOçš„ç¡¬ä»¶å¤æ‚åº¦**ï¼š

TSOéœ€è¦**å…¨å±€å†™é¡ºåº**ï¼Œå¢åŠ äº†ç¡¬ä»¶å¤æ‚åº¦ï¼š

$$
\text{ç¡¬ä»¶å¤æ‚åº¦} = O(\text{å†™æ“ä½œæ•°}^2)
$$

å› ä¸ºéœ€è¦ç»´æŠ¤æ‰€æœ‰å†™æ“ä½œçš„å…¨å±€é¡ºåºã€‚

**é‡åŒ–å¯¹æ¯”**ï¼šTSO vs WMOçš„æƒè¡¡

| **ç‰¹æ€§** | **TSO** | **WMO** | **å·®å¼‚** |
|---------|---------|---------|---------|
| **ç¼–ç¨‹å¤æ‚åº¦** | ä½ | é«˜ | TSOç®€å• |
| **ç¡¬ä»¶å¤æ‚åº¦** | é«˜ | ä½ | WMOç®€å• |
| **æ€§èƒ½** | ä¸­ | é«˜ | WMOæ›´å¿« |
| **å†…å­˜å±éšœéœ€æ±‚** | å°‘ | å¤š | TSOæ›´å°‘ |

**å…³é”®æƒè¡¡**ï¼šTSOåœ¨**ç¼–ç¨‹ç®€å•æ€§**å’Œ**ç¡¬ä»¶å¤æ‚åº¦**ä¹‹é—´åšäº†æƒè¡¡ï¼Œé€‚åˆé€šç”¨è®¡ç®—ã€‚

### 2.2 Store Buffer

**æ¡ˆä¾‹4.3.2ï¼ˆStore Bufferæœºåˆ¶ï¼‰**ï¼š

Store Bufferæ˜¯TSOæ¨¡å‹çš„æ ¸å¿ƒæœºåˆ¶ï¼Œç”¨äºéšè—å†™æ“ä½œçš„å»¶è¿Ÿã€‚

**Store BufferåŸå› **ï¼š

**1. å†™æ“ä½œå»¶è¿Ÿ**ï¼š

- **ç­‰å¾…ç¼“å­˜è¡Œ**ï¼šå†™æ“ä½œéœ€è¦è·å–ç¼“å­˜è¡Œçš„ç‹¬å æƒï¼ˆMESIåè®®ï¼‰
- **å»¶è¿Ÿè¾ƒé«˜**ï¼šè·å–ç‹¬å æƒéœ€è¦20-40å‘¨æœŸ
- **é˜»å¡é—®é¢˜**ï¼šå¦‚æœå†™æ“ä½œé˜»å¡ï¼Œåç»­æ“ä½œæ— æ³•ç»§ç»­

**2. Store Bufferç¼“å†²**ï¼š

- **å¼‚æ­¥å†™å›**ï¼šStore Bufferå…è®¸å†™æ“ä½œå¼‚æ­¥å®Œæˆ
- **éšè—å»¶è¿Ÿ**ï¼šåç»­è¯»æ“ä½œå¯ä»¥ç»§ç»­æ‰§è¡Œ
- **æ€§èƒ½æå‡**ï¼šæé«˜CPUåˆ©ç”¨ç‡

**Store Bufferå®ç°**ï¼š

```c
// Store Bufferå®ç°
typedef struct {
    struct {
        int *addr;
        int value;
        bool valid;
    } entries[STORE_BUFFER_SIZE];
    int head;
    int tail;
    int count;
} store_buffer_t;

// å†™å…¥Store Buffer
void store_buffer_write(store_buffer_t *sb, int *addr, int value) {
    // 1. æ£€æŸ¥Store Bufferæ˜¯å¦æ»¡
    while (sb->count >= STORE_BUFFER_SIZE) {
        // ç­‰å¾…ç©ºé—´
        flush_oldest_entry(sb);
    }

    // 2. å†™å…¥Store Buffer
    int idx = sb->tail;
    sb->entries[idx].addr = addr;
    sb->entries[idx].value = value;
    sb->entries[idx].valid = true;
    sb->tail = (sb->tail + 1) % STORE_BUFFER_SIZE;
    sb->count++;

    // 3. å¼‚æ­¥å†™å›ç¼“å­˜
    async_write_to_cache(addr, value);
}

// ä»Store Bufferè¯»å–ï¼ˆStore-Loadè½¬å‘ï¼‰
int store_buffer_read(store_buffer_t *sb, int *addr) {
    // 1. æ£€æŸ¥Store Bufferä¸­æ˜¯å¦æœ‰è¯¥åœ°å€çš„å†™æ“ä½œ
    for (int i = sb->head; i != sb->tail; i = (i + 1) % STORE_BUFFER_SIZE) {
        if (sb->entries[i].valid && sb->entries[i].addr == addr) {
            return sb->entries[i].value;  // Store-Loadè½¬å‘
        }
    }

    // 2. ä»ç¼“å­˜è¯»å–
    return cache_read(addr);
}
```

**Store Bufferå½±å“**ï¼š

**1. Store-Loadé‡æ’**ï¼š

```c
// Store-Loadé‡æ’ç¤ºä¾‹
int x = 0, y = 0;

// çº¿ç¨‹1
x = 1;        // Storeï¼ˆå†™å…¥Store Bufferï¼‰
int a = y;    // Loadï¼ˆå¯èƒ½ä»ç¼“å­˜è¯»å–ï¼Œçœ‹ä¸åˆ°x=1ï¼‰

// çº¿ç¨‹2
y = 1;        // Store
int b = x;    // Loadï¼ˆå¯èƒ½çœ‹åˆ°x=0ï¼‰

// å¯èƒ½å‡ºç°ï¼ša=0 && b=0ï¼ˆè¿åé¡ºåºä¸€è‡´æ€§ï¼‰
```

**2. éœ€è¦MFENCEé˜²æ­¢**ï¼š

```c
// ä½¿ç”¨MFENCEé˜²æ­¢Store-Loadé‡æ’
int x = 0, y = 0;

// çº¿ç¨‹1
x = 1;
mfence();     // å†…å­˜å±éšœï¼Œç­‰å¾…Store Bufferæ¸…ç©º
int a = y;    // ä¿è¯çœ‹åˆ°yçš„æœ€æ–°å€¼

// çº¿ç¨‹2
y = 1;
mfence();     // å†…å­˜å±éšœ
int b = x;    // ä¿è¯çœ‹åˆ°xçš„æœ€æ–°å€¼

// ä¸å¯èƒ½å‡ºç°ï¼ša=0 && b=0
```

**æ·±åº¦è®ºè¯ï¼šStore Bufferçš„æ€§èƒ½å½±å“**

**Store Bufferçš„å»¶è¿Ÿéšè—**ï¼š

Store Bufferå…è®¸**å†™æ“ä½œå¼‚æ­¥å®Œæˆ**ï¼Œéšè—å»¶è¿Ÿï¼š

$$
\text{æœ‰æ•ˆå»¶è¿Ÿ} = \max(0, t_{\text{å†™å»¶è¿Ÿ}} - t_{\text{åç»­æ“ä½œ}})
$$

**é‡åŒ–åˆ†æ**ï¼šStore Bufferçš„æ€§èƒ½æå‡

| **åœºæ™¯** | **æ— Store Buffer** | **æœ‰Store Buffer** | **æ€§èƒ½æå‡** |
|---------|------------------|------------------|------------|
| **å†™åè¯»** | åŸºå‡† | +20% | 20% |
| **å†™åå†™** | åŸºå‡† | åŸºå‡† | 0% |
| **è¯»åå†™** | åŸºå‡† | åŸºå‡† | 0% |

**å…³é”®æ´å¯Ÿ**ï¼šStore Bufferåœ¨**å†™åè¯»**åœºæ™¯ä¸‹å¯ä»¥**éšè—å†™å»¶è¿Ÿ**ï¼Œæå‡æ€§èƒ½ã€‚

---

## 3 å¼±ä¸€è‡´æ€§æ¨¡å‹ï¼ˆARMï¼‰

### 3.1 ç‰¹ç‚¹

**æ¡ˆä¾‹4.3.3ï¼ˆå¼±ä¸€è‡´æ€§æ¨¡å‹ï¼‰**ï¼š

å¼±ä¸€è‡´æ€§æ¨¡å‹ï¼ˆWeak Memory Orderingï¼ŒWMOï¼‰æ˜¯ARMæ¶æ„çš„å†…å­˜åºæ¨¡å‹ï¼Œå…è®¸æ‰€æœ‰ç±»å‹çš„å†…å­˜æ“ä½œé‡æ’ã€‚

**Weak Memory Ordering**ï¼š

**WMOæ¨¡å‹è§„åˆ™**ï¼š

1. **å…è®¸æ‰€æœ‰ç±»å‹é‡æ’**ï¼šLoad-Loadã€Load-Storeã€Store-Storeã€Store-Loadéƒ½å¯ä»¥é‡æ’
2. **éœ€è¦æ˜¾å¼å†…å­˜å±éšœ**ï¼šç¨‹åºå‘˜å¿…é¡»æ˜¾å¼æ’å…¥å†…å­˜å±éšœ
3. **ç¡¬ä»¶ç®€å•ï¼Œæ€§èƒ½é«˜**ï¼šç¡¬ä»¶å®ç°ç®€å•ï¼Œæ€§èƒ½æ›´å¥½

**WMOæ¨¡å‹å®ç°**ï¼š

```c
// WMOæ¨¡å‹çš„ç¡¬ä»¶å®ç°ï¼ˆä¼ªä»£ç ï¼‰
typedef struct {
    load_queue_t load_queue;      // Loadé˜Ÿåˆ—
    store_queue_t store_queue;    // Storeé˜Ÿåˆ—
    cache_t *cache;               // ç¼“å­˜
} arm_core_t;

// Loadæ“ä½œï¼ˆå¯èƒ½é‡æ’ï¼‰
int wmo_load(arm_core_t *core, int *addr) {
    // 1. åŠ å…¥Loadé˜Ÿåˆ—
    load_entry_t *entry = alloc_load_entry();
    entry->addr = addr;
    entry->status = PENDING;
    enqueue_load(core->load_queue, entry);

    // 2. å¯èƒ½ä¸å…¶ä»–æ“ä½œé‡æ’
    // 3. ä»ç¼“å­˜è¯»å–
    return cache_load(core->cache, addr);
}

// Storeæ“ä½œï¼ˆå¯èƒ½é‡æ’ï¼‰
void wmo_store(arm_core_t *core, int *addr, int value) {
    // 1. åŠ å…¥Storeé˜Ÿåˆ—
    store_entry_t *entry = alloc_store_entry();
    entry->addr = addr;
    entry->value = value;
    entry->status = PENDING;
    enqueue_store(core->store_queue, entry);

    // 2. å¯èƒ½ä¸å…¶ä»–æ“ä½œé‡æ’
    // 3. å¼‚æ­¥å†™å›ç¼“å­˜
    async_write_to_cache(addr, value);
}

// å†…å­˜å±éšœï¼ˆDMBï¼‰
void wmo_dmb(arm_core_t *core) {
    // 1. ç­‰å¾…æ‰€æœ‰Loadæ“ä½œå®Œæˆ
    flush_load_queue(core->load_queue);

    // 2. ç­‰å¾…æ‰€æœ‰Storeæ“ä½œå®Œæˆ
    flush_store_queue(core->store_queue);

    // 3. ç¡®ä¿æ‰€æœ‰å†…å­˜æ“ä½œå®Œæˆ
    memory_barrier();
}
```

**å†…å­˜å±éšœæŒ‡ä»¤**ï¼š

**1. DMBï¼ˆData Memory Barrierï¼‰**ï¼š

- **æ•°æ®å†…å­˜å±éšœ**ï¼šç¡®ä¿æ•°æ®å†…å­˜æ“ä½œçš„é¡ºåº
- **ä½œç”¨åŸŸ**ï¼šå¯ä»¥æŒ‡å®šä½œç”¨åŸŸï¼ˆinner shareableã€outer shareableç­‰ï¼‰
- **æ€§èƒ½å¼€é”€**ï¼šä¸­ç­‰

**2. DSBï¼ˆData Synchronization Barrierï¼‰**ï¼š

- **æ•°æ®åŒæ­¥å±éšœ**ï¼šæ¯”DMBæ›´å¼ºï¼Œç¡®ä¿æ‰€æœ‰å†…å­˜æ“ä½œå®Œæˆ
- **ç”¨é€”**ï¼šç”¨äºéœ€è¦å¼ºåŒæ­¥çš„åœºæ™¯
- **æ€§èƒ½å¼€é”€**ï¼šè¾ƒé«˜

**3. ISBï¼ˆInstruction Synchronization Barrierï¼‰**ï¼š

- **æŒ‡ä»¤åŒæ­¥å±éšœ**ï¼šåˆ·æ–°æŒ‡ä»¤æµæ°´çº¿
- **ç”¨é€”**ï¼šç”¨äºä»£ç ä¿®æ”¹åçš„åŒæ­¥
- **æ€§èƒ½å¼€é”€**ï¼šæœ€é«˜

### 3.2 ä½¿ç”¨ç¤ºä¾‹

**ARMæ±‡ç¼–ç¤ºä¾‹**ï¼š

```asm
; ARMæ±‡ç¼– - ä½¿ç”¨DMB
ldr r0, [r1]      ; Loadæ“ä½œ
dmb ish           ; æ•°æ®å†…å­˜å±éšœï¼ˆinner shareableï¼‰
str r2, [r3]      ; Storeæ“ä½œï¼ˆä¿è¯åœ¨Loadä¹‹åï¼‰

; ARMæ±‡ç¼– - ä½¿ç”¨DSB
ldr r0, [r1]      ; Loadæ“ä½œ
dsb sy            ; æ•°æ®åŒæ­¥å±éšœï¼ˆsystemï¼‰
str r2, [r3]      ; Storeæ“ä½œï¼ˆå¼ºåŒæ­¥ï¼‰

; ARMæ±‡ç¼– - ä½¿ç”¨ISB
mcr p15, 0, r0, c1, c0, 0  ; ä¿®æ”¹ç³»ç»Ÿå¯„å­˜å™¨
isb                         ; æŒ‡ä»¤åŒæ­¥å±éšœ
ldr r0, [r1]                ; åç»­æŒ‡ä»¤ï¼ˆä¿è¯çœ‹åˆ°ä¿®æ”¹ï¼‰
```

**Cè¯­è¨€ç¤ºä¾‹**ï¼š

```c
// Cè¯­è¨€ä½¿ç”¨å†…å­˜å±éšœ
#include <stdatomic.h>

int x = 0, y = 0;

// çº¿ç¨‹1
x = 1;
atomic_thread_fence(memory_order_release);  // ç›¸å½“äºDMB
int a = y;

// çº¿ç¨‹2
y = 1;
atomic_thread_fence(memory_order_acquire);  // ç›¸å½“äºDMB
int b = x;
```

---

## 4 acquire/releaseè¯­ä¹‰

### 4.1 Acquireè¯­ä¹‰

**æ¡ˆä¾‹4.3.4ï¼ˆAcquireè¯­ä¹‰ï¼‰**ï¼š

Acquireè¯­ä¹‰æ˜¯ä¸€ç§å¼±ä¸€è‡´æ€§å†…å­˜åºï¼Œç”¨äºè¯»æ“ä½œï¼Œä¿è¯åç»­æ“ä½œä¸èƒ½é‡æ’åˆ°acquireä¹‹å‰ã€‚

**Acquireè¯­ä¹‰å®šä¹‰**ï¼š

**1. åç»­æ“ä½œä¸èƒ½é‡æ’åˆ°acquireä¹‹å‰**ï¼š

- **å•å‘å±éšœ**ï¼šåªé˜²æ­¢åç»­æ“ä½œé‡æ’åˆ°acquireä¹‹å‰
- **ä¸é™åˆ¶ä¹‹å‰æ“ä½œ**ï¼šä¹‹å‰çš„æ“ä½œå¯ä»¥é‡æ’
- **è¯»æ“ä½œè¯­ä¹‰**ï¼šé€šå¸¸ç”¨äºè¯»æ“ä½œ

**2. ä¿è¯å¯è§æ€§**ï¼š

- **åŒæ­¥ç‚¹**ï¼šAcquireæ“ä½œæ˜¯ä¸€ä¸ªåŒæ­¥ç‚¹
- **çœ‹åˆ°ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œ**ï¼šä¿è¯çœ‹åˆ°releaseä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œ
- **å†…å­˜å¯è§æ€§**ï¼šä¿è¯å†…å­˜æ“ä½œçš„å¯è§æ€§

**Acquireè¯­ä¹‰å®ç°**ï¼š

```c
// Acquireè¯­ä¹‰çš„ç¡¬ä»¶å®ç°ï¼ˆä¼ªä»£ç ï¼‰
void acquire_barrier(cpu_core_t *core) {
    // 1. ç­‰å¾…æ‰€æœ‰ä¹‹å‰çš„Loadæ“ä½œå®Œæˆ
    flush_load_queue(core->load_queue);

    // 2. ç¡®ä¿åç»­æ“ä½œåœ¨acquireä¹‹å
    memory_barrier();
}

// Acquire Load
int acquire_load(atomic_int *addr) {
    int value = atomic_load_explicit(addr, memory_order_acquire);
    acquire_barrier(get_current_core());
    return value;
}
```

**C++å®ç°ç¤ºä¾‹**ï¼š

```cpp
#include <atomic>
#include <thread>

std::atomic<int> flag{0};
int data = 0;

// çº¿ç¨‹1ï¼šå‘å¸ƒæ•°æ®
void thread1() {
    data = 42;                                    // å†™æ“ä½œ
    flag.store(1, std::memory_order_release);    // Releaseå†™
}

// çº¿ç¨‹2ï¼šè·å–æ•°æ®
void thread2() {
    if (flag.load(std::memory_order_acquire) == 1) {  // Acquireè¯»
        // ä¿è¯çœ‹åˆ°data = 42
        // å› ä¸ºacquireä¿è¯çœ‹åˆ°releaseä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œ
        use(data);
    }
}
```

**Acquireè¯­ä¹‰çš„ä¿è¯**ï¼š

```cpp
// Acquireè¯­ä¹‰ä¿è¯
int x = 0, y = 0;
std::atomic<int> sync{0};

// çº¿ç¨‹1
x = 1;
y = 2;
sync.store(1, std::memory_order_release);  // Release

// çº¿ç¨‹2
if (sync.load(std::memory_order_acquire) == 1) {  // Acquire
    // ä¿è¯çœ‹åˆ°ï¼šx == 1 && y == 2
    // å› ä¸ºacquireä¿è¯çœ‹åˆ°releaseä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œ
    assert(x == 1 && y == 2);
}
```

### 4.2 Releaseè¯­ä¹‰

**æ¡ˆä¾‹4.3.5ï¼ˆReleaseè¯­ä¹‰ï¼‰**ï¼š

Releaseè¯­ä¹‰æ˜¯ä¸€ç§å¼±ä¸€è‡´æ€§å†…å­˜åºï¼Œç”¨äºå†™æ“ä½œï¼Œä¿è¯ä¹‹å‰æ“ä½œä¸èƒ½é‡æ’åˆ°releaseä¹‹åã€‚

**Releaseè¯­ä¹‰å®šä¹‰**ï¼š

**1. ä¹‹å‰æ“ä½œä¸èƒ½é‡æ’åˆ°releaseä¹‹å**ï¼š

- **å•å‘å±éšœ**ï¼šåªé˜²æ­¢ä¹‹å‰æ“ä½œé‡æ’åˆ°releaseä¹‹å
- **ä¸é™åˆ¶åç»­æ“ä½œ**ï¼šåç»­æ“ä½œå¯ä»¥é‡æ’
- **å†™æ“ä½œè¯­ä¹‰**ï¼šé€šå¸¸ç”¨äºå†™æ“ä½œ

**2. ä¿è¯å‘å¸ƒ**ï¼š

- **åŒæ­¥ç‚¹**ï¼šReleaseæ“ä½œæ˜¯ä¸€ä¸ªåŒæ­¥ç‚¹
- **å‘å¸ƒä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œ**ï¼šä¿è¯ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œå¯¹å…¶ä»–çº¿ç¨‹å¯è§
- **å†…å­˜å‘å¸ƒ**ï¼šä¿è¯å†…å­˜æ“ä½œçš„å‘å¸ƒ

**Releaseè¯­ä¹‰å®ç°**ï¼š

```c
// Releaseè¯­ä¹‰çš„ç¡¬ä»¶å®ç°ï¼ˆä¼ªä»£ç ï¼‰
void release_barrier(cpu_core_t *core) {
    // 1. ç­‰å¾…æ‰€æœ‰ä¹‹å‰çš„Storeæ“ä½œå®Œæˆ
    flush_store_queue(core->store_queue);

    // 2. ç¡®ä¿ä¹‹å‰æ“ä½œåœ¨releaseä¹‹å‰
    memory_barrier();
}

// Release Store
void release_store(atomic_int *addr, int value) {
    release_barrier(get_current_core());
    atomic_store_explicit(addr, value, memory_order_release);
}
```

**Releaseè¯­ä¹‰ç”¨é€”**ï¼š

**1. é”é‡Šæ”¾**ï¼š

```cpp
// ä½¿ç”¨Releaseè¯­ä¹‰é‡Šæ”¾é”
class SpinLock {
    std::atomic<bool> locked{false};

public:
    void lock() {
        bool expected = false;
        while (!locked.compare_exchange_weak(expected, true,
                                             std::memory_order_acquire,
                                             std::memory_order_relaxed)) {
            expected = false;
        }
    }

    void unlock() {
        locked.store(false, std::memory_order_release);  // Release
    }
};
```

**2. å‘å¸ƒå…±äº«æ•°æ®**ï¼š

```cpp
// ä½¿ç”¨Releaseè¯­ä¹‰å‘å¸ƒå…±äº«æ•°æ®
struct SharedData {
    int value1;
    int value2;
};

std::atomic<SharedData*> shared_ptr{nullptr};

// çº¿ç¨‹1ï¼šå‘å¸ƒæ•°æ®
void publish_data() {
    SharedData *data = new SharedData{42, 100};
    data->value1 = 42;
    data->value2 = 100;
    shared_ptr.store(data, std::memory_order_release);  // Release
}

// çº¿ç¨‹2ï¼šè·å–æ•°æ®
void consume_data() {
    SharedData *data = shared_ptr.load(std::memory_order_acquire);  // Acquire
    if (data != nullptr) {
        // ä¿è¯çœ‹åˆ°å®Œæ•´çš„data
        use(data->value1, data->value2);
    }
}
```

**3. åŒæ­¥ç‚¹**ï¼š

```cpp
// ä½¿ç”¨Release/Acquireä½œä¸ºåŒæ­¥ç‚¹
std::atomic<int> ready{0};
int data = 0;

// çº¿ç¨‹1
void producer() {
    data = 42;
    ready.store(1, std::memory_order_release);  // åŒæ­¥ç‚¹
}

// çº¿ç¨‹2
void consumer() {
    while (ready.load(std::memory_order_acquire) == 0) {  // åŒæ­¥ç‚¹
        // ç­‰å¾…
    }
    // ä¿è¯çœ‹åˆ°data = 42
    use(data);
}
```

---

## 5 é¡ºåºä¸€è‡´æ€§çš„ä¸¥æ ¼åˆ†æ

**æ¡ˆä¾‹4.3.6ï¼ˆé¡ºåºä¸€è‡´æ€§ï¼‰**ï¼š

é¡ºåºä¸€è‡´æ€§ï¼ˆSequential Consistencyï¼ŒSCï¼‰æ˜¯æœ€å¼ºçš„å†…å­˜åºæ¨¡å‹ï¼Œä¿è¯æ‰€æœ‰æ“ä½œæœ‰ä¸€ä¸ªå…¨å±€é¡ºåºã€‚

**å®šä¹‰4.3ï¼ˆé¡ºåºä¸€è‡´æ€§ï¼‰**ï¼š

å†…å­˜åºæ¨¡å‹$M$æ˜¯é¡ºåºä¸€è‡´çš„ï¼Œå½“ä¸”ä»…å½“å­˜åœ¨ä¸€ä¸ªå…¨å±€é¡ºåº$<$ï¼Œä½¿å¾—ï¼š

$$
\forall \text{op}_1, \text{op}_2. \text{op}_1 <_{\text{prog}} \text{op}_2 \Rightarrow \text{op}_1 < \text{op}_2
$$

å…¶ä¸­$<_{\text{prog}}$æ˜¯ç¨‹åºé¡ºåºã€‚

**å®šç†4.3ï¼ˆé¡ºåºä¸€è‡´æ€§çš„æ€§èƒ½ä»£ä»·ï¼‰**ï¼š

é¡ºåºä¸€è‡´æ€§éœ€è¦å…¨å±€åŒæ­¥ï¼Œå»¶è¿Ÿæ»¡è¶³ï¼š

$$
L_{\text{SC}} \geq L_{\text{local}} + L_{\text{global}}
$$

å…¶ä¸­$L_{\text{local}}$æ˜¯æœ¬åœ°æ“ä½œå»¶è¿Ÿï¼Œ$L_{\text{global}}$æ˜¯å…¨å±€åŒæ­¥å»¶è¿Ÿã€‚

**è¯æ˜**ï¼šé¡ºåºä¸€è‡´æ€§è¦æ±‚æ‰€æœ‰æ ¸å¿ƒçœ‹åˆ°ç›¸åŒçš„å…¨å±€é¡ºåºï¼Œå› æ­¤éœ€è¦å…¨å±€åŒæ­¥ã€‚âˆ

### 5.1 é¡ºåºä¸€è‡´æ€§å®šä¹‰

**Sequential Consistencyï¼ˆSCï¼‰**ï¼š

**1. æ‰€æœ‰æ“ä½œå…¨å±€é¡ºåº**ï¼š

- **å…¨å±€é¡ºåº**ï¼šæ‰€æœ‰çº¿ç¨‹çš„æ‰€æœ‰æ“ä½œæœ‰ä¸€ä¸ªå…¨å±€é¡ºåº
- **ä¸€è‡´æ€§**ï¼šæ‰€æœ‰çº¿ç¨‹çœ‹åˆ°ç›¸åŒçš„å…¨å±€é¡ºåº
- **çº¿æ€§åŒ–**ï¼šæ“ä½œçœ‹èµ·æ¥æ˜¯åŸå­æ‰§è¡Œçš„

**2. æ¯ä¸ªçº¿ç¨‹å†…é¡ºåºä¿æŒ**ï¼š

- **ç¨‹åºé¡ºåº**ï¼šæ¯ä¸ªçº¿ç¨‹å†…çš„æ“ä½œé¡ºåºä¿æŒ
- **å±€éƒ¨é¡ºåº**ï¼šçº¿ç¨‹å†…çš„æ“ä½œé¡ºåºä¸èƒ½æ”¹å˜
- **å…¨å±€é¡ºåº**ï¼šå…¨å±€é¡ºåºå¿…é¡»åŒ…å«æ‰€æœ‰å±€éƒ¨é¡ºåº

**3. æœ€å¼ºä¿è¯**ï¼š

- **æœ€å¼ºè¯­ä¹‰**ï¼šé¡ºåºä¸€è‡´æ€§æ˜¯æœ€å¼ºçš„å†…å­˜åºæ¨¡å‹
- **æœ€ç®€å•**ï¼šç¼–ç¨‹æœ€ç®€å•ï¼Œä¸éœ€è¦è€ƒè™‘é‡æ’
- **æ€§èƒ½ä»£ä»·**ï¼šæ€§èƒ½å¼€é”€æœ€å¤§

**é¡ºåºä¸€è‡´æ€§å®ç°**ï¼š

```c
// é¡ºåºä¸€è‡´æ€§çš„ç¡¬ä»¶å®ç°ï¼ˆä¼ªä»£ç ï¼‰
typedef struct {
    global_order_t global_order;  // å…¨å±€é¡ºåº
    cache_t *cache;               // ç¼“å­˜
} sc_core_t;

// é¡ºåºä¸€è‡´æ€§Load
int sc_load(sc_core_t *core, int *addr) {
    // 1. è·å–å…¨å±€é¡ºåºå·
    int order = acquire_global_order(core->global_order);

    // 2. ç­‰å¾…æ‰€æœ‰ä¹‹å‰çš„æ“ä½œå®Œæˆ
    wait_for_previous_operations(core, order);

    // 3. æ‰§è¡ŒLoadæ“ä½œ
    int value = cache_load(core->cache, addr);

    // 4. è®°å½•æ“ä½œåˆ°å…¨å±€é¡ºåº
    record_operation(core->global_order, order, LOAD, addr, value);

    return value;
}

// é¡ºåºä¸€è‡´æ€§Store
void sc_store(sc_core_t *core, int *addr, int value) {
    // 1. è·å–å…¨å±€é¡ºåºå·
    int order = acquire_global_order(core->global_order);

    // 2. ç­‰å¾…æ‰€æœ‰ä¹‹å‰çš„æ“ä½œå®Œæˆ
    wait_for_previous_operations(core, order);

    // 3. æ‰§è¡ŒStoreæ“ä½œ
    cache_store(core->cache, addr, value);

    // 4. è®°å½•æ“ä½œåˆ°å…¨å±€é¡ºåº
    record_operation(core->global_order, order, STORE, addr, value);

    // 5. é€šçŸ¥å…¶ä»–æ ¸å¿ƒ
    notify_other_cores(core, order);
}
```

### 5.2 C++å®ç°

**é¡ºåºä¸€è‡´æ€§C++å®ç°**ï¼š

```cpp
#include <atomic>
#include <thread>

std::atomic<int> x{0}, y{0};

// çº¿ç¨‹1
void thread1() {
    x.store(1, std::memory_order_seq_cst);  // é¡ºåºä¸€è‡´æ€§Store
    int a = y.load(std::memory_order_seq_cst);  // é¡ºåºä¸€è‡´æ€§Load
}

// çº¿ç¨‹2
void thread2() {
    y.store(1, std::memory_order_seq_cst);  // é¡ºåºä¸€è‡´æ€§Store
    int b = x.load(std::memory_order_seq_cst);  // é¡ºåºä¸€è‡´æ€§Load
}

// ä¸å¯èƒ½å‡ºç°ï¼ša=0 && b=0
// å› ä¸ºé¡ºåºä¸€è‡´æ€§ä¿è¯å…¨å±€é¡ºåº
```

**é¡ºåºä¸€è‡´æ€§ä¿è¯**ï¼š

```cpp
// é¡ºåºä¸€è‡´æ€§ä¿è¯ç¤ºä¾‹
std::atomic<int> flag1{0}, flag2{0};
int data1 = 0, data2 = 0;

// çº¿ç¨‹1
void thread1() {
    data1 = 42;
    flag1.store(1, std::memory_order_seq_cst);
    int f2 = flag2.load(std::memory_order_seq_cst);
    if (f2 == 1) {
        // ä¿è¯çœ‹åˆ°data2çš„æœ€æ–°å€¼
        use(data2);
    }
}

// çº¿ç¨‹2
void thread2() {
    data2 = 100;
    flag2.store(1, std::memory_order_seq_cst);
    int f1 = flag1.load(std::memory_order_seq_cst);
    if (f1 == 1) {
        // ä¿è¯çœ‹åˆ°data1çš„æœ€æ–°å€¼
        use(data1);
    }
}

// é¡ºåºä¸€è‡´æ€§ä¿è¯ï¼šå¦‚æœä¸¤ä¸ªflagéƒ½ä¸º1ï¼Œåˆ™ä¸¤ä¸ªçº¿ç¨‹éƒ½èƒ½çœ‹åˆ°å¯¹æ–¹çš„æ•°æ®
```

### 5.3 æ€§èƒ½ä»£ä»·

**é¡ºåºä¸€è‡´æ€§å¼€é”€**ï¼š

**1. éœ€è¦å…¨å±€åŒæ­¥**ï¼š

- **å…¨å±€é¡ºåº**ï¼šéœ€è¦ç»´æŠ¤å…¨å±€é¡ºåº
- **åŒæ­¥å¼€é”€**ï¼šéœ€è¦ä¸å…¶ä»–æ ¸å¿ƒåŒæ­¥
- **å»¶è¿Ÿå¢åŠ **ï¼šå»¶è¿Ÿæ˜¾è‘—å¢åŠ 

**2. æ€§èƒ½è¾ƒä½**ï¼š

- **å»¶è¿Ÿ**ï¼šé¡ºåºä¸€è‡´æ€§æ“ä½œçš„å»¶è¿Ÿæ˜¯æ™®é€šæ“ä½œçš„2-10å€
- **ååé‡**ï¼šååé‡æ˜¾è‘—é™ä½
- **å¯æ‰©å±•æ€§**ï¼šå¯æ‰©å±•æ€§å·®

**æ€§èƒ½å¯¹æ¯”**ï¼š

| **å†…å­˜åº** | **å»¶è¿Ÿ** | **ååé‡** | **å¯æ‰©å±•æ€§** |
|-----------|---------|-----------|------------|
| **relaxed** | åŸºå‡† | åŸºå‡† | å¥½ |
| **acquire/release** | +20% | -10% | å¥½ |
| **seq_cst** | +200% | -50% | å·® |

**ä½¿ç”¨å»ºè®®**ï¼š

**1. é»˜è®¤ä½¿ç”¨seq_cst**ï¼š

- **æœ€ç®€å•**ï¼šä¸éœ€è¦è€ƒè™‘é‡æ’
- **æœ€å®‰å…¨**ï¼šä¿è¯æœ€å¼º
- **é€‚åˆå¼€å‘**ï¼šé€‚åˆå¼€å‘å’Œè°ƒè¯•

**2. æ€§èƒ½å…³é”®æ—¶ä¼˜åŒ–ä¸ºacquire/release**ï¼š

- **æ€§èƒ½ä¼˜åŒ–**ï¼šåœ¨æ€§èƒ½å…³é”®è·¯å¾„ä½¿ç”¨acquire/release
- **ä»”ç»†éªŒè¯**ï¼šéœ€è¦ä»”ç»†éªŒè¯æ­£ç¡®æ€§
- **é€æ­¥ä¼˜åŒ–**ï¼šé€æ­¥ä¼˜åŒ–ï¼Œä¸è¦ä¸€æ¬¡æ€§æ”¹å˜

---

## 6 å®è·µæ¡ˆä¾‹

### 6.1 é«˜æ€§èƒ½æ— é”é˜Ÿåˆ—å†…å­˜åºä¼˜åŒ–

**æ¡ˆä¾‹4.3.7ï¼ˆé«˜æ€§èƒ½æ— é”é˜Ÿåˆ—ï¼‰**ï¼š

æŸé«˜æ€§èƒ½ç³»ç»Ÿä¼˜åŒ–æ— é”é˜Ÿåˆ—çš„å†…å­˜åºï¼Œæé«˜æ€§èƒ½ã€‚

**ä¼˜åŒ–ç­–ç•¥**ï¼š

**1. ä½¿ç”¨acquire/releaseæ›¿ä»£seq_cst**ï¼š

```cpp
// ä¼˜åŒ–å‰ï¼šä½¿ç”¨seq_cst
template<typename T>
class LockFreeQueue {
    struct Node {
        std::atomic<T*> data{nullptr};
        std::atomic<Node*> next{nullptr};
    };

    std::atomic<Node*> head{nullptr};
    std::atomic<Node*> tail{nullptr};

public:
    void enqueue(T item) {
        Node *new_node = new Node;
        new_node->data.store(new T(item), std::memory_order_seq_cst);  // seq_cst

        Node *prev_tail = tail.exchange(new_node, std::memory_order_seq_cst);  // seq_cst
        prev_tail->next.store(new_node, std::memory_order_seq_cst);  // seq_cst
    }
};

// ä¼˜åŒ–åï¼šä½¿ç”¨acquire/release
template<typename T>
class LockFreeQueue {
    // ... åŒä¸Š ...

public:
    void enqueue(T item) {
        Node *new_node = new Node;
        new_node->data.store(new T(item), std::memory_order_relaxed);  // relaxed

        Node *prev_tail = tail.exchange(new_node, std::memory_order_acq_rel);  // acq_rel
        prev_tail->next.store(new_node, std::memory_order_release);  // release
    }

    bool dequeue(T &item) {
        Node *head_node = head.load(std::memory_order_acquire);  // acquire
        Node *next = head_node->next.load(std::memory_order_acquire);  // acquire

        if (next == nullptr) {
            return false;  // é˜Ÿåˆ—ä¸ºç©º
        }

        T *data = next->data.load(std::memory_order_acquire);  // acquire
        head.store(next, std::memory_order_release);  // release

        item = *data;
        delete data;
        delete head_node;
        return true;
    }
};
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š

| **æŒ‡æ ‡** | **ä¼˜åŒ–å‰ï¼ˆseq_cstï¼‰** | **ä¼˜åŒ–åï¼ˆacq_relï¼‰** | **æ”¹å–„** |
|---------|---------------------|---------------------|---------|
| **å…¥é˜Ÿå»¶è¿Ÿ** | 100ns | 50ns | -50% |
| **å‡ºé˜Ÿå»¶è¿Ÿ** | 100ns | 50ns | -50% |
| **ååé‡** | 10M ops/s | 20M ops/s | +100% |

### 6.2 è‡ªæ—‹é”å†…å­˜åºä¼˜åŒ–

**æ¡ˆä¾‹4.3.8ï¼ˆè‡ªæ—‹é”ä¼˜åŒ–ï¼‰**ï¼š

ä¼˜åŒ–è‡ªæ—‹é”çš„å†…å­˜åºï¼Œå‡å°‘ä¸å¿…è¦çš„åŒæ­¥å¼€é”€ã€‚

**ä¼˜åŒ–å®ç°**ï¼š

```cpp
// ä¼˜åŒ–å‰ï¼šä½¿ç”¨seq_cst
class SpinLock {
    std::atomic<bool> locked{false};

public:
    void lock() {
        bool expected = false;
        while (!locked.compare_exchange_weak(expected, true,
                                             std::memory_order_seq_cst,  // seq_cst
                                             std::memory_order_seq_cst)) {  // seq_cst
            expected = false;
        }
    }

    void unlock() {
        locked.store(false, std::memory_order_seq_cst);  // seq_cst
    }
};

// ä¼˜åŒ–åï¼šä½¿ç”¨acquire/release
class SpinLock {
    std::atomic<bool> locked{false};

public:
    void lock() {
        bool expected = false;
        while (!locked.compare_exchange_weak(expected, true,
                                             std::memory_order_acquire,  // acquire
                                             std::memory_order_relaxed)) {  // relaxed
            expected = false;
            // è‡ªæ—‹ç­‰å¾…æ—¶ä½¿ç”¨relaxedï¼Œå‡å°‘å¼€é”€
            while (locked.load(std::memory_order_relaxed)) {
                cpu_pause();
            }
        }
    }

    void unlock() {
        locked.store(false, std::memory_order_release);  // release
    }
};
```

**ä¼˜åŒ–æ•ˆæœ**ï¼š

| **æŒ‡æ ‡** | **ä¼˜åŒ–å‰** | **ä¼˜åŒ–å** | **æ”¹å–„** |
|---------|-----------|-----------|---------|
| **è·å–é”å»¶è¿Ÿ** | 50ns | 30ns | -40% |
| **é‡Šæ”¾é”å»¶è¿Ÿ** | 20ns | 15ns | -25% |
| **é«˜ç«äº‰ååé‡** | åŸºå‡† | +30% | æå‡ |

## 7 å†…å­˜åºé€‰æ‹©

### 7.1 å†³ç­–æŒ‡å—

**å†…å­˜åºé€‰æ‹©å†³ç­–æ ‘**ï¼š

```text
éœ€è¦å…¨å±€é¡ºåºï¼Ÿ
â”œâ”€ æ˜¯ â†’ seq_cstï¼ˆé¡ºåºä¸€è‡´æ€§ï¼‰
â””â”€ å¦ â†’ ç»§ç»­åˆ¤æ–­

éœ€è¦åŒæ­¥ç‚¹ï¼Ÿ
â”œâ”€ æ˜¯ â†’ acquire/release
â”‚   â”œâ”€ è¯»æ“ä½œ â†’ acquire
â”‚   â””â”€ å†™æ“ä½œ â†’ release
â””â”€ å¦ â†’ relaxed

æ€§èƒ½å…³é”®ï¼Ÿ
â”œâ”€ æ˜¯ â†’ ä»”ç»†é€‰æ‹©å†…å­˜åº
â””â”€ å¦ â†’ é»˜è®¤ä½¿ç”¨seq_cst
```

**é»˜è®¤é€‰æ‹©**ï¼š

**1. ä½¿ç”¨`memory_order_seq_cst`**ï¼š

- **æœ€ç®€å•**ï¼šä¸éœ€è¦è€ƒè™‘é‡æ’
- **æœ€å®‰å…¨**ï¼šä¿è¯æœ€å¼º
- **é€‚åˆå¼€å‘**ï¼šé€‚åˆå¼€å‘å’Œè°ƒè¯•é˜¶æ®µ

**2. æ€§èƒ½ä¼˜åŒ–**ï¼š

- **è¯»æ“ä½œ**ï¼š`memory_order_acquire`
- **å†™æ“ä½œ**ï¼š`memory_order_release`
- **ä»…å½“éœ€è¦æ—¶ä½¿ç”¨**ï¼šåœ¨æ€§èƒ½å…³é”®è·¯å¾„ä½¿ç”¨

**3. é¿å…ä½¿ç”¨**ï¼š

- **`memory_order_relaxed`**ï¼šé™¤éç¡®å®šä¸éœ€è¦åŒæ­¥
- **æ‰‹åŠ¨å†…å­˜å±éšœ**ï¼šé™¤éå¿…è¦ï¼Œä½¿ç”¨æ ‡å‡†åº“æä¾›çš„è¯­ä¹‰

---

## 8 æ€ç»´å¯¼å›¾ï¼šå†…å­˜åºæ¨¡å‹å†³ç­–æ ‘

```mermaid
mindmap
  root((å†…å­˜åºæ¨¡å‹))
    æ¨¡å‹é€‰æ‹©
      é¡ºåºä¸€è‡´æ€§
        æœ€ç®€å•
        ä½†æ€§èƒ½å·®
      TSO
        x86ç¡¬ä»¶
        æ€§èƒ½ä¸­ç­‰
        ä½†Store-Loadé‡æ’
      å¼±ä¸€è‡´æ€§
        ARMç¡¬ä»¶
        æ€§èƒ½æœ€å¥½
        ä½†ç¼–ç¨‹å¤æ‚
    acquire/release
      å¼±ä¸€è‡´æ€§
        æ€§èƒ½å¥½
        ä½†éœ€è¦ç†è§£è¯­ä¹‰
      seq_cst
        é¡ºåºä¸€è‡´æ€§
        æ€§èƒ½å·®
        ä½†æœ€ç®€å•
    ç¡¬ä»¶æ”¯æŒ
      x86 TSO
        ç¡¬ä»¶ä¿è¯
        ä½†Store Buffer
      ARM WMO
        å®Œå…¨å¼±åº
        éœ€è¦æ˜¾å¼å±éšœ
```

---

## 9 æ‰¹åˆ¤æ€§æ€»ç»“

### 7.1 å†…å­˜åºæ¨¡å‹çš„æ ¹æœ¬çŸ›ç›¾

1. **ç®€å•æ€§vsæ€§èƒ½**ï¼šé¡ºåºä¸€è‡´æ€§ç®€å•ï¼Œä½†**æ€§èƒ½å¼€é”€å¤§**ï¼›å¼±ä¸€è‡´æ€§æ€§èƒ½å¥½ï¼Œä½†**ç¼–ç¨‹å¤æ‚**ã€‚

2. **ç¡¬ä»¶vsè½¯ä»¶**ï¼šç¡¬ä»¶å†…å­˜åºæ¨¡å‹ï¼ˆå¦‚TSOï¼‰**ç®€åŒ–ç¼–ç¨‹**ï¼Œä½†å¢åŠ ç¡¬ä»¶å¤æ‚åº¦ã€‚

3. **é€šç”¨æ€§vsä¸“ç”¨æ€§**ï¼šé€šç”¨å†…å­˜åºæ¨¡å‹çµæ´»ï¼Œä½†**æŸäº›åº”ç”¨éœ€è¦ä¸“ç”¨è®¾è®¡**ã€‚

### 7.2 2025å¹´å†…å­˜åºæ¨¡å‹æŠ€æœ¯è¶‹åŠ¿

- **å†…å­˜åºæ¨¡å‹ç»Ÿä¸€**ï¼šC++11/C11å†…å­˜åºæ¨¡å‹**æ ‡å‡†åŒ–**ï¼Œä½†å®ç°å¤æ‚ã€‚
- **ç¡¬ä»¶åŠ é€Ÿ**ï¼šæŸäº›ç¡¬ä»¶ï¼ˆå¦‚ARMï¼‰æä¾›**å†…å­˜å±éšœåŠ é€Ÿ**ï¼Œå‡å°‘å¼€é”€ã€‚
- **å½¢å¼åŒ–éªŒè¯**ï¼šä½¿ç”¨å½¢å¼åŒ–æ–¹æ³•**éªŒè¯å†…å­˜åºæ­£ç¡®æ€§**ï¼Œä½†å¤æ‚åº¦é«˜ã€‚

---

## 10 è·¨é¢†åŸŸæ´å¯Ÿ

### 8.1 å†…å­˜åºæ¨¡å‹çš„æ€§èƒ½vsæ­£ç¡®æ€§æƒè¡¡

**æ ¸å¿ƒçŸ›ç›¾**ï¼šé¡ºåºä¸€è‡´æ€§æ­£ç¡®æ€§ä¿è¯æœ€å¼ºï¼Œä½†æ€§èƒ½å¼€é”€å¤§ï¼›å¼±ä¸€è‡´æ€§æ€§èƒ½å¥½ï¼Œä½†ç¼–ç¨‹å¤æ‚ã€‚

**é‡åŒ–åˆ†æ**ï¼š

| **å†…å­˜åºæ¨¡å‹** | **æ­£ç¡®æ€§ä¿è¯** | **æ€§èƒ½** | **ç¼–ç¨‹å¤æ‚åº¦** | **é€‚ç”¨åœºæ™¯** | **ä»£è¡¨æ¶æ„** |
|--------------|--------------|---------|--------------|------------|------------|
| **é¡ºåºä¸€è‡´æ€§** | â­â­â­â­â­ | â­ | â­ | ç®€å•åº”ç”¨ | ç†è®ºæ¨¡å‹ |
| **TSO** | â­â­â­â­ | â­â­â­ | â­â­ | é€šç”¨åº”ç”¨ | x86 |
| **acquire/release** | â­â­â­â­ | â­â­â­ | â­â­â­ | é€šç”¨åº”ç”¨ | C++11 |
| **relaxed** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | ä¸“å®¶çº§åº”ç”¨ | ä¸“ç”¨åœºæ™¯ |

**æ‰¹åˆ¤æ€§åˆ†æ**ï¼š

1. **æ­£ç¡®æ€§vsæ€§èƒ½**ï¼šé¡ºåºä¸€è‡´æ€§ä¿è¯æœ€å¼ºï¼Œä½†**æ€§èƒ½æœ€å·®**ï¼›relaxedæ€§èƒ½æœ€å¥½ï¼Œä½†**æ­£ç¡®æ€§ä¿è¯æœ€å¼±**ã€‚

2. **ç¼–ç¨‹å¤æ‚åº¦çš„å·®å¼‚**ï¼šrelaxedç¼–ç¨‹æœ€å¤æ‚ï¼Œä½†**æ€§èƒ½æœ€å¥½**ã€‚

3. **2025å¹´è¶‹åŠ¿**ï¼š**acquire/releaseè¯­ä¹‰**æˆä¸ºä¸»æµï¼Œå¹³è¡¡æ€§èƒ½å’Œæ­£ç¡®æ€§ã€‚

### 8.2 ç¡¬ä»¶vsè½¯ä»¶å†…å­˜åºçš„æƒè¡¡

**æ ¸å¿ƒçŸ›ç›¾**ï¼šç¡¬ä»¶å†…å­˜åºæ¨¡å‹ç®€åŒ–ç¼–ç¨‹ï¼Œä½†å¢åŠ ç¡¬ä»¶å¤æ‚åº¦ï¼›è½¯ä»¶å†…å­˜åºæ¨¡å‹çµæ´»ï¼Œä½†ç¼–ç¨‹å¤æ‚ã€‚

**é‡åŒ–åˆ†æ**ï¼š

| **å®ç°æ–¹å¼** | **ç¡¬ä»¶å¤æ‚åº¦** | **ç¼–ç¨‹å¤æ‚åº¦** | **æ€§èƒ½** | **é€‚ç”¨åœºæ™¯** | **ä»£è¡¨æ¶æ„** |
|------------|--------------|--------------|---------|------------|------------|
| **TSOç¡¬ä»¶** | â­â­â­â­ | â­â­ | â­â­â­ | é€šç”¨ | x86 |
| **WMOç¡¬ä»¶** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | èƒ½æ•ˆä¼˜å…ˆ | ARM |
| **è½¯ä»¶å±éšœ** | â­ | â­â­â­â­â­ | â­â­â­ | çµæ´» | è½¯ä»¶å®ç° |

**æ‰¹åˆ¤æ€§åˆ†æ**ï¼š

1. **ç¡¬ä»¶vsè½¯ä»¶çš„æƒè¡¡**ï¼šç¡¬ä»¶å†…å­˜åº**ç®€åŒ–ç¼–ç¨‹**ï¼Œä½†å¢åŠ ç¡¬ä»¶å¤æ‚åº¦ï¼›è½¯ä»¶å†…å­˜åºçµæ´»ï¼Œä½†**ç¼–ç¨‹å¤æ‚**ã€‚

2. **æ€§èƒ½çš„å·®å¼‚**ï¼šWMOç¡¬ä»¶æ€§èƒ½æœ€å¥½ï¼Œä½†**ç¼–ç¨‹æœ€å¤æ‚**ã€‚

3. **2025å¹´è¶‹åŠ¿**ï¼š**ç»Ÿä¸€å†…å­˜åºæ¨¡å‹**ï¼ˆC++11/C11ï¼‰æ ‡å‡†åŒ–ï¼Œä½†å®ç°å¤æ‚ã€‚

---

## 11 å¤šç»´åº¦å¯¹æ¯”

### 9.1 å†…å­˜åºæ¨¡å‹å¯¹æ¯”ï¼ˆ2025å¹´ï¼‰

| **æ¨¡å‹** | **æ­£ç¡®æ€§ä¿è¯** | **æ€§èƒ½** | **ç¼–ç¨‹å¤æ‚åº¦** | **ç¡¬ä»¶æ”¯æŒ** | **ä»£è¡¨æ¶æ„** |
|---------|--------------|---------|--------------|------------|------------|
| **é¡ºåºä¸€è‡´æ€§** | â­â­â­â­â­ | â­ | â­ | æ—  | ç†è®ºæ¨¡å‹ |
| **TSO** | â­â­â­â­ | â­â­â­ | â­â­ | â­â­â­â­ | x86 |
| **WMO** | â­â­â­ | â­â­â­â­ | â­â­â­â­ | â­â­â­ | ARM |
| **acquire/release** | â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­ | C++11 |
| **relaxed** | â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ | ä¸“ç”¨åœºæ™¯ |

**æ‰¹åˆ¤æ€§åˆ†æ**ï¼š

1. **æ­£ç¡®æ€§vsæ€§èƒ½**ï¼šé¡ºåºä¸€è‡´æ€§ä¿è¯æœ€å¼ºï¼Œä½†**æ€§èƒ½æœ€å·®**ï¼›relaxedæ€§èƒ½æœ€å¥½ï¼Œä½†**æ­£ç¡®æ€§ä¿è¯æœ€å¼±**ã€‚

2. **ç¡¬ä»¶æ”¯æŒçš„å·®å¼‚**ï¼šTSOç¡¬ä»¶æ”¯æŒæœ€å¥½ï¼Œä½†**æ€§èƒ½ä¸€èˆ¬**ã€‚

3. **2025å¹´è¶‹åŠ¿**ï¼š**acquire/releaseè¯­ä¹‰**æˆä¸ºä¸»æµï¼Œå¹³è¡¡æ€§èƒ½å’Œæ­£ç¡®æ€§ã€‚

### 9.2 å†…å­˜åºæ¨¡å‹æ¼”è¿›å¯¹æ¯”

| **æ—¶ä»£** | **å†…å­˜åºæ¨¡å‹** | **å…³é”®ç‰¹æ€§** | **æ­£ç¡®æ€§** | **æ€§èƒ½** | **ä»£è¡¨æ¶æ„** |
|---------|------------|------------|-----------|---------|------------|
| **1970s** | é¡ºåºä¸€è‡´æ€§ | ç†è®ºæ¨¡å‹ | â­â­â­â­â­ | â­ | ç†è®º |
| **1980s** | TSO | ç¡¬ä»¶æ”¯æŒ | â­â­â­â­ | â­â­â­ | x86 |
| **1990s** | WMO | å¼±ä¸€è‡´æ€§ | â­â­â­ | â­â­â­â­ | ARM |
| **2010s** | acquire/release | è½¯ä»¶è¯­ä¹‰ | â­â­â­â­ | â­â­â­ | C++11 |
| **2020s** | ç»Ÿä¸€æ¨¡å‹ | æ ‡å‡†åŒ– | â­â­â­â­ | â­â­â­ | C++11/C11 |

**æ‰¹åˆ¤æ€§åˆ†æ**ï¼š

1. **æ¼”è¿›çš„è¶‹åŠ¿**ï¼šä»ç†è®ºæ¨¡å‹åˆ°**ç¡¬ä»¶æ”¯æŒ**ï¼Œä»å›ºå®šåˆ°**è½¯ä»¶è¯­ä¹‰**ã€‚

2. **æ€§èƒ½çš„æå‡**ï¼šWMOæ€§èƒ½æœ€å¥½ï¼Œä½†**æ­£ç¡®æ€§ä¿è¯è¾ƒå¼±**ã€‚

3. **2025å¹´è¶‹åŠ¿**ï¼š**ç»Ÿä¸€å†…å­˜åºæ¨¡å‹**ï¼ˆC++11/C11ï¼‰æ ‡å‡†åŒ–ï¼Œä½†å®ç°å¤æ‚ã€‚

---

## 12 ç›¸å…³ä¸»é¢˜

- [4.1 ç¡¬ä»¶åŒæ­¥åŸè¯­](./04.1_ç¡¬ä»¶åŒæ­¥åŸè¯­.md) - ç¡¬ä»¶åŒæ­¥åŸºç¡€
- [4.2 è½¯ä»¶åŒæ­¥æœºåˆ¶](./04.2_è½¯ä»¶åŒæ­¥æœºåˆ¶.md) - è½¯ä»¶åŒæ­¥å®ç°
- [01.1 CPUå¾®æ¶æ„](../01_CPUç¡¬ä»¶å±‚/01.1_CPUå¾®æ¶æ„.md) - ç¡¬ä»¶å†…å­˜åº
- [09.1 è°ƒåº¦æ¨¡å‹å½¢å¼åŒ–](../09_å½¢å¼åŒ–ç†è®ºä¸è¯æ˜/09.1_è°ƒåº¦æ¨¡å‹å½¢å¼åŒ–.md) - å†…å­˜åºå½¢å¼åŒ–
- [é€šä¿¡åŒæ­¥å¤æ‚åº¦æ€»è§ˆ](../é€šä¿¡åŒæ­¥å¤æ‚åº¦æ€»è§ˆ.md) - é€šä¿¡åŒæ­¥å¤æ‚åº¦è¯¦ç»†åˆ†æ
- [è®ºè¯è„‰ç»œæ€»è§ˆ](../è®ºè¯è„‰ç»œæ€»è§ˆ.md) - è°ƒåº¦æŠ½è±¡æ³„æ¼å®šå¾‹ä¸é€šä¿¡åŒæ­¥å¤æ‚åº¦
- [ä¸»æ–‡æ¡£ï¼šå†…å­˜åºæ¨¡å‹](../schedule_formal_view.md#çŸ¥è¯†å›¾è°±æ¦‚å¿µå…³ç³»é“¾) - å®Œæ•´åˆ†æ

---

**æœ€åæ›´æ–°**: 2025-01-XX
