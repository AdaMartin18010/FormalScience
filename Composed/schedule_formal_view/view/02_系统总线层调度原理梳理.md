# 系统总线层调度原理梳理

> **文档版本**: v1.0.0
> **创建时间**: 2025-11-14
> **最后更新**: 2025-11-14
> **文档状态**: ✅ 系统总线层调度原理梳理完成

---

## 📋 目录

- [系统总线层调度原理梳理](#系统总线层调度原理梳理)
  - [📋 目录](#-目录)
  - [一、PCIe子系统调度](#一pcie子系统调度)
    - [1.1 PCIe协议层次](#11-pcie协议层次)
    - [1.2 TLP事务调度](#12-tlp事务调度)
    - [1.3 IOMMU调度](#13-iommu调度)
  - [二、芯片组架构调度](#二芯片组架构调度)
    - [2.1 北桥与南桥](#21-北桥与南桥)
    - [2.2 PCH平台控制器集线器](#22-pch平台控制器集线器)
    - [2.3 DMI/OPI链路调度](#23-dmiopi链路调度)
  - [三、中断子系统调度](#三中断子系统调度)
    - [3.1 中断类型](#31-中断类型)
    - [3.2 中断路由](#32-中断路由)
    - [3.3 中断处理调度](#33-中断处理调度)
  - [四、相关主题链接](#四相关主题链接)

---

## 一、PCIe子系统调度

### 1.1 PCIe协议层次

**PCIe协议栈**：

- **物理层**：8b/10b编码（Gen1-2）、128b/130b编码（Gen3+）
- **数据链路层**：Ack/Nak机制、流控
- **事务层**：TLP（Transaction Layer Packet）封装

**性能参数**：

| **PCIe版本** | **带宽（x16）** | **编码效率** | **实际带宽** |
|------------|---------------|------------|------------|
| **Gen 3.0** | 16 GB/s | 128/130 | ~15.75 GB/s |
| **Gen 4.0** | 32 GB/s | 128/130 | ~31.5 GB/s |
| **Gen 5.0** | 64 GB/s | 128/130 | ~63 GB/s |

### 1.2 TLP事务调度

**TLP类型**：

- **Memory Read/Write**：内存读写事务
- **I/O Read/Write**：IO读写事务
- **Configuration Read/Write**：配置读写事务
- **Message**：消息事务（MSI/MSI-X中断）

**调度策略**：

- **优先级调度**：不同TLP类型有不同的优先级
- **虚拟通道（VC）**：支持多个虚拟通道，每个通道独立调度
- **流量控制**：基于信用的流量控制机制

**调度延迟**：

$$
T_{TLP} = T_{serialization} + T_{propagation} + T_{processing}
$$

其中：

- $T_{serialization}$：串行化延迟
- $T_{propagation}$：信号传播延迟
- $T_{processing}$：处理延迟

### 1.3 IOMMU调度

**IOMMU功能**：

- **地址转换**：将设备虚拟地址转换为物理地址
- **访问控制**：控制设备对内存的访问权限
- **隔离性**：保证不同设备之间的内存隔离

**IOMMU调度开销**：

- **TLB命中**：~10ns
- **TLB未命中**：~100ns（需要页表遍历）
- **页表遍历**：4级页表需要4次内存访问

---

## 二、芯片组架构调度

### 2.1 北桥与南桥

**传统架构**：

- **北桥（Northbridge）**：连接CPU、内存、显卡
- **南桥（Southbridge）**：连接IO设备、存储设备

**演进趋势**：

- **内存控制器集成**：内存控制器集成到CPU
- **PCIe控制器集成**：PCIe控制器集成到CPU
- **PCH替代**：平台控制器集线器（PCH）替代南北桥

### 2.2 PCH平台控制器集线器

**PCH功能**：

- **DMI/OPI链路**：连接CPU和PCH
- **SATA控制器**：管理SATA设备
- **USB控制器**：管理USB设备
- **网络控制器**：管理网络设备
- **音频控制器**：管理音频设备

**调度特点**：

- **集中管理**：统一管理各种IO设备
- **带宽共享**：多个设备共享DMI/OPI带宽
- **优先级调度**：不同设备有不同的优先级

### 2.3 DMI/OPI链路调度

**DMI（Direct Media Interface）**：

Intel的CPU-PCH互连技术，基于PCIe协议。

**OPI（On-Package Interconnect）**：

AMD的CPU-PCH互连技术，基于PCIe协议。

**带宽调度**：

- **带宽分配**：根据设备需求分配带宽
- **优先级调度**：高优先级设备优先获得带宽
- **流量控制**：防止带宽拥塞

---

## 三、中断子系统调度

### 3.1 中断类型

**中断类型**：

- **INTx**：传统PCI中断（边沿触发）
- **MSI（Message Signaled Interrupts）**：基于消息的中断
- **MSI-X**：扩展MSI，支持更多中断向量

**中断性能**：

| **中断类型** | **延迟** | **可扩展性** | **CPU开销** |
|------------|---------|------------|-----------|
| **INTx** | ~1μs | 低（共享IRQ） | 高 |
| **MSI** | ~500ns | 中（32个向量） | 中 |
| **MSI-X** | ~500ns | 高（2048个向量） | 低 |

### 3.2 中断路由

**APIC（Advanced Programmable Interrupt Controller）**：

- **Local APIC**：每个CPU核心有本地APIC
- **I/O APIC**：系统有IO APIC处理设备中断

**中断路由算法**：

- **静态路由**：中断固定路由到特定CPU核心
- **动态路由**：根据负载动态路由中断
- **亲和性路由**：根据设备亲和性路由中断

### 3.3 中断处理调度

**中断处理流程**：

1. **中断产生**：设备产生中断信号
2. **中断路由**：APIC路由中断到CPU核心
3. **中断处理**：CPU执行中断处理程序（ISR）
4. **中断完成**：中断处理完成，恢复执行

**中断调度优化**：

- **中断亲和性**：将中断绑定到特定CPU核心
- **中断合并**：合并多个小中断
- **NAPI机制**：在高负载时切换到轮询模式

**中断延迟**：

$$
T_{interrupt} = T_{routing} + T_{context\_switch} + T_{ISR}
$$

其中：

- $T_{routing}$：中断路由延迟（~100ns）
- $T_{context\_switch}$：上下文切换延迟（~1μs）
- $T_{ISR}$：中断处理程序执行时间

---

## 四、相关主题链接

- [02_系统总线层](../02_系统总线层/README.md) - 系统总线层详细文档
- [01_硬件层调度原理梳理](./01_硬件层调度原理梳理.md) - 硬件层调度原理
- [03_OS抽象层调度原理梳理](./03_OS抽象层调度原理梳理.md) - OS抽象层调度原理

---

**最后更新**: 2025-11-14
**文档状态**: ✅ 系统总线层调度原理梳理完成
