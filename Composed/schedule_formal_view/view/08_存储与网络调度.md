# 存储与网络调度：调度在存储和网络系统上的应用与体现

> **文档版本**: v1.0.0
> **最后更新**: 2025-01-XX

---

## 📋 目录

- [存储与网络调度：调度在存储和网络系统上的应用与体现](#存储与网络调度调度在存储和网络系统上的应用与体现)
  - [📋 目录](#-目录)
  - [一、存储IO调度](#一存储io调度)
    - [1.1 磁盘IO调度](#11-磁盘io调度)
    - [1.2 SSD调度](#12-ssd调度)
    - [1.3 存储层次调度](#13-存储层次调度)
  - [二、网络包调度](#二网络包调度)
    - [2.1 网络包处理调度](#21-网络包处理调度)
    - [2.2 DPDK调度](#22-dpdk调度)
    - [2.3 网络拥塞控制](#23-网络拥塞控制)
  - [三、QoS调度](#三qos调度)
    - [3.1 网络QoS调度](#31-网络qos调度)
    - [3.2 存储QoS调度](#32-存储qos调度)
  - [四、2025年存储与网络调度最新技术](#四2025年存储与网络调度最新技术)
    - [4.1 网络和数据感知的放置算法（2025年新增）](#41-网络和数据感知的放置算法2025年新增)
    - [4.2 DPDK最新优化（2025年新增）](#42-dpdk最新优化2025年新增)
  - [五、存储与网络调度最佳实践](#五存储与网络调度最佳实践)
    - [5.1 存储调度优化](#51-存储调度优化)
    - [5.2 网络调度优化](#52-网络调度优化)
    - [5.3 QoS配置](#53-qos配置)
  - [六、存储与网络调度实践案例](#六存储与网络调度实践案例)
    - [6.1 实时数据流水线调度优化案例](#61-实时数据流水线调度优化案例)
  - [📊 存储与网络调度性能指标](#-存储与网络调度性能指标)
  - [🔗 相关文档](#-相关文档)

---

## 一、存储IO调度

### 1.1 磁盘IO调度

**寻道优化**：

磁盘IO调度器通过重排序IO请求，最小化磁头移动距离，提升吞吐量。

**调度算法**：

- **FCFS（First Come First Served）**：先来先服务
- **SSTF（Shortest Seek Time First）**：最短寻道时间优先
- **SCAN（电梯算法）**：磁头单向移动
- **C-SCAN（循环SCAN）**：磁头循环移动

**Linux IO调度器**：

- **CFQ（Completely Fair Queuing）**：公平队列调度，适合多用户系统
- **Deadline**：保证IO请求的截止时间，适合数据库
- **Noop**：简单FIFO，适合SSD
- **BFQ（Budget Fair Queuing）**：预算公平队列，平衡延迟和吞吐量

**调度延迟分解**：

$$
T_{IO} = T_{queue} + T_{seek} + T_{rotation} + T_{transfer}
$$

其中：

- $T_{queue}$：队列等待时间（10-100μs）
- $T_{seek}$：寻道时间（5-10ms）
- $T_{rotation}$：旋转延迟（2-8ms）
- $T_{transfer}$：数据传输时间（1-5ms）

### 1.2 SSD调度

**NVMe多队列模型**：

- **提交队列（SQ）**：深度64K，每个CPU核心独占队列
- **完成队列（CQ）**：深度64K，可配置中断聚合

**调度策略**：

Linux blk-mq根据`blkcg`权重分配IO带宽，保障QoS。

**SSD调度特性**：

- **无寻道延迟**：随机IO延迟约100μs
- **磨损均衡**：自动分配写入，延长寿命
- **垃圾回收**：后台回收无效页，影响性能

**blk-mq调度模型**：

$$
\text{Allocate}(IO, cgroup) = \frac{\text{weight}(cgroup)}{\sum \text{weight}(all)} \times \text{Bandwidth}_{total}
$$

### 1.3 存储层次调度

**存储层次**：

$$
\text{Storage} = \{L1Cache, L2Cache, DRAM, SSD, HDD\}
$$

**缓存替换策略**：

- **LRU（Least Recently Used）**：最近最少使用
- **LFU（Least Frequently Used）**：最少使用频率
- **ARC（Adaptive Replacement Cache）**：自适应替换

**缓存命中率模型**：

$$
\text{HitRate} = f(\text{CacheSize}, \text{AccessPattern}, \text{ReplacementPolicy})
$$

---

## 二、网络包调度

### 2.1 网络包处理调度

**XPS（Transmit Packet Steering）**：

根据CPU亲和性选择发送队列，减少锁竞争，提升吞吐量15%。

**RPS（Receive Packet Steering）**：

软件层面将软中断分发至不同CPU，弥补RSS硬件队列不足。

### 2.2 DPDK调度

**DPDK轮询模式**：

放弃中断，CPU轮询网卡接收队列，延迟降至5μs，适合高频交易场景。

**DPDK调度模型**：

$$
\text{Process}(packet) = \begin{cases}
\text{Poll}(queue) & \text{if } \text{packets} > 0 \\
\text{Sleep} & \text{otherwise}
\end{cases}
$$

**性能提升**：

- 延迟：从50μs降至5μs（10倍提升）
- 吞吐量：从10Mpps提升至100Mpps（10倍提升）
- CPU利用率：从80%降至60%（减少中断开销）

### 2.3 网络拥塞控制

**拥塞控制算法**：

- **TCP Reno**：经典拥塞控制，慢启动+拥塞避免
- **TCP BBR**：基于带宽和RTT的拥塞控制
- **TCP CUBIC**：CUBIC增长函数，适合高带宽网络

**拥塞窗口模型**：

$$
\text{CWND}(t) = \begin{cases}
\text{CWND}(t-1) + 1 & \text{slow start} \\
\text{CWND}(t-1) + \frac{1}{\text{CWND}(t-1)} & \text{congestion avoidance}
\end{cases}
$$

**BBR算法**：

$$
\text{PacingRate} = \frac{\text{BW} \times \text{gain}}{RTT}
$$

其中BW为估计带宽，gain为增益因子（通常为2.77）。

---

## 三、QoS调度

### 3.1 网络QoS调度

**流量整形**：

通过令牌桶算法限制流量速率，保证QoS。

**优先级调度**：

$$
\text{Priority}(packet) = f(\text{DSCP}, \text{VLAN}, \text{Application})
$$

**DSCP优先级映射**：

| DSCP值 | 优先级 | 典型应用 |
|--------|--------|---------|
| **EF (46)** | 最高 | 语音通话 |
| **AF41 (34)** | 高 | 视频流 |
| **AF21 (18)** | 中 | 交互式应用 |
| **BE (0)** | 低 | 普通数据 |

### 3.2 存储QoS调度

**IO优先级**：

通过`ionice`设置进程IO优先级，影响IO调度顺序。

**Cgroup IO限制**：

$$
\text{IOPS}(cgroup) = \frac{\text{weight}(cgroup)}{\sum \text{weight}(all)} \times \text{TotalIOPS}
$$

**存储QoS策略**：

- **带宽限制**：限制每个cgroup的IO带宽
- **IOPS限制**：限制每个cgroup的IOPS
- **延迟保证**：保证关键应用的IO延迟

---

## 四、2025年存储与网络调度最新技术

### 4.1 网络和数据感知的放置算法（2025年新增）

**算法概述**：

针对多层应用在云数据中心的部署，提出网络和数据感知的放置算法。

**核心机制**：

- **虚拟机放置优化**：考虑网络拓扑和数据位置
- **数据块放置优化**：减少跨节点数据传输
- **通信开销最小化**：优化虚拟机和数据块的联合放置

**调度模型**：

$$
\text{Place}(VM, Data) = \arg\min [\text{NetworkCost}(VM, Data) + \text{StorageCost}(Data)]
$$

**性能提升**：

- 网络通信开销减少30-50%
- 数据传输延迟降低25-40%
- 整体性能提升20-30%

### 4.2 DPDK最新优化（2025年新增）

**DPDK增强特性**：

- **零拷贝优化**：进一步减少内存拷贝开销
- **批处理优化**：批量处理数据包，提升吞吐量
- **NUMA感知**：优化NUMA节点间的数据分布

**性能指标**：

- 延迟：< 5μs（进一步优化）
- 吞吐量：> 100Mpps（单核）
- CPU利用率：< 50%（优化后）

---

## 五、存储与网络调度最佳实践

### 5.1 存储调度优化

**磁盘调度器选择**：

- **HDD**：使用Deadline或BFQ，优化寻道
- **SSD**：使用Noop，减少调度开销
- **混合存储**：使用分层调度，热点数据放SSD

### 5.2 网络调度优化

**中断优化**：

- 使用RPS/RFS分散中断负载
- 配置中断亲和性，绑定到特定CPU
- 使用DPDK减少中断开销

### 5.3 QoS配置

**网络QoS**：

- 配置DSCP标记，区分流量优先级
- 使用流量整形，限制带宽
- 实现拥塞控制，避免网络拥塞

**存储QoS**：

- 使用Cgroup限制IO带宽和IOPS
- 设置IO优先级，保证关键应用
- 监控IO延迟，及时调整策略

---

## 六、存储与网络调度实践案例

### 6.1 实时数据流水线调度优化案例

**场景描述**：

电商实时推荐系统，需要实时处理每秒100万条用户行为数据，P99延迟要求 < 100ms。

**Flink调度优化**：

- **算子链优化**：减少网络传输次数，从4次降至2次
- **并行度动态调整**：根据数据流量动态调整并行度
- **反压处理**：自动降低上游算子处理速度

**优化效果**：

- P99延迟：500ms → 80ms（减少84%）
- 资源利用率：60% → 85%（提升42%）
- 数据积压：高峰期积压 → 实时处理

详见 [实践案例汇总](./实践案例汇总.md#案例2实时数据流水线调度优化)

---

## 📊 存储与网络调度性能指标

| 调度对象 | 调度粒度 | 延迟范围 | 主要约束 | 典型实现 |
|---------|---------|---------|---------|---------|
| **磁盘IO** | 扇区/块 | 5-20ms | 寻道时间 | Deadline调度器 |
| **SSD IO** | 页/块 | 50-200μs | 磨损均衡 | blk-mq |
| **网络包** | 数据包 | 1-100μs | 带宽限制 | NAPI/DPDK |
| **QoS** | 流量/IO | 毫秒级 | 带宽/IOPS限制 | Cgroup/TC |

---

## 🔗 相关文档

- [系统软件层调度](./02_系统软件层调度.md)
- [硬件层调度](./01_硬件层调度.md)
- [跨层次调度协同](./11_跨层次调度协同.md)

---

**最后更新**: 2025-01-XX
**文档状态**: ✅ 归纳整理完成
