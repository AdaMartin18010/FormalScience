# æ“ä½œç³»ç»Ÿ-è™šæ‹ŸåŒ–é¢†åŸŸè¯¦ç»†å¯¹æ ‡ (2025ç‰ˆ)

## 1 æ–‡æ¡£å…ƒä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.2 (2025å¯¹æ ‡ç‰ˆï¼Œå®Œæ•´ç‰ˆ) |
| **åˆ›å»ºæ—¥æœŸ** | 2025-10-22 |
| **ä¿®è®¢æ—¥æœŸ** | 2025-11-14 |
| **é¢†åŸŸ** | æ“ä½œç³»ç»Ÿ-è™šæ‹ŸåŒ– (OS Virtualization) |
| **å¯¹æ ‡æ¥æº** | Popek-Goldberg 1974, Intel SDM, VMwareæ–‡æ¡£, KVM, Xen |
| **çŠ¶æ€** | âœ… å…¨éƒ¨å®Œæˆ - 32é¡¹ç†è®ºè¯¦ç»†å¯¹æ ‡å·²å…¨éƒ¨è¡¥å……å®Œæˆ |

## 2 âš ï¸ å…è´£å£°æ˜

**æœ¬æ–‡æ¡£ä¸ºå­¦æœ¯å¯¹æ ‡åˆ†æï¼Œä»…ä¾›ç ”ç©¶ä¸å­¦ä¹ ä½¿ç”¨ã€‚**

- **å¯¹æ ‡åˆ†æ**: å¯¹è™šæ‹ŸåŒ–æŠ€æœ¯ï¼ˆVMwareã€KVMã€Xenï¼‰å’Œç¡¬ä»¶è§„èŒƒï¼ˆIntel VT-xã€AMD-Vï¼‰çš„å¯¹æ ‡åŸºäºå…¬å¼€æ–‡æ¡£ï¼Œå®é™…äº§å“ç‰¹æ€§è¯·æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ã€‚
- **ç†è®ºå½’å±**: æ–‡æ¡£ä¸­çš„ç†è®ºæ•´ç†åŸºäºPopek-Goldbergå®šç†ç­‰ç»å…¸ç†è®ºï¼Œæœ¬é¡¹ç›®è¿›è¡Œäº†ç³»ç»ŸåŒ–æ‰©å±•ï¼Œéƒ¨åˆ†æ‰©å±•å¯èƒ½ä¸å·²æœ‰ç ”ç©¶å­˜åœ¨é‡å ã€‚
- **æŠ€æœ¯æ¼”è¿›**: è™šæ‹ŸåŒ–æŠ€æœ¯æŒç»­æ¼”è¿›ï¼Œæ–‡æ¡£å†…å®¹åŸºäº2025å¹´10æœˆ22æ—¥çš„æŠ€æœ¯ç°çŠ¶ï¼Œè¯·å…³æ³¨æœ€æ–°æŠ€æœ¯å‘å±•ã€‚
- **æœªç»åŒè¡Œè¯„å®¡**: æœ¬æ–‡æ¡£å°šæœªç»è¿‡æ­£å¼çš„å­¦æœ¯åŒè¡Œè¯„å®¡æµç¨‹ã€‚

**è¯»è€…åº”ç»“åˆIntel/AMDå®˜æ–¹è§„èŒƒã€VMware/KVMæ–‡æ¡£å’Œå®é™…æµ‹è¯•ç»¼åˆåˆ¤æ–­ã€‚**

---

## ğŸ“‹ ç›®å½•

- [æ“ä½œç³»ç»Ÿ-è™šæ‹ŸåŒ–é¢†åŸŸè¯¦ç»†å¯¹æ ‡ (2025ç‰ˆ)](#æ“ä½œç³»ç»Ÿ-è™šæ‹ŸåŒ–é¢†åŸŸè¯¦ç»†å¯¹æ ‡-2025ç‰ˆ)
  - [1 æ–‡æ¡£å…ƒä¿¡æ¯](#1-æ–‡æ¡£å…ƒä¿¡æ¯)
  - [2 âš ï¸ å…è´£å£°æ˜](#2-ï¸-å…è´£å£°æ˜)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ“‹ æ–‡æ¡£å…ƒä¿¡æ¯](#-æ–‡æ¡£å…ƒä¿¡æ¯)
  - [3 ğŸ¯ é¢†åŸŸæ¦‚è¿°](#3--é¢†åŸŸæ¦‚è¿°)
  - [4 ğŸ“š æƒå¨èµ„æºä½“ç³»](#4--æƒå¨èµ„æºä½“ç³»)
    - [1 . ç»å…¸æ•™æå¯¹æ ‡](#1--ç»å…¸æ•™æå¯¹æ ‡)
      - [1.1 Andrew S. Tanenbaum - Modern Operating Systems (4th, 2014)](#11-andrew-s-tanenbaum---modern-operating-systems-4th-2014)
      - [1.2 Remzi H. Arpaci-Dusseau - Operating Systems: Three Easy Pieces (OSTEP, 2018)](#12-remzi-h-arpaci-dusseau---operating-systems-three-easy-pieces-ostep-2018)
      - [1.3 Jim Smith \& Ravi Nair - Virtual Machines (2005)](#13-jim-smith--ravi-nair---virtual-machines-2005)
    - [2 . å¤§å­¦è¯¾ç¨‹å¯¹æ ‡](#2--å¤§å­¦è¯¾ç¨‹å¯¹æ ‡)
      - [2.1 MIT 6.828 - Operating System Engineering (2024)](#21-mit-6828---operating-system-engineering-2024)
      - [2.2 Stanford CS140 - Operating Systems (2024)](#22-stanford-cs140---operating-systems-2024)
      - [2.3 CMU 15-410 - Operating System Design \& Implementation (2024)](#23-cmu-15-410---operating-system-design--implementation-2024)
    - [3 . æŠ€æœ¯æ ‡å‡†å¯¹æ ‡](#3--æŠ€æœ¯æ ‡å‡†å¯¹æ ‡)
      - [3.1 Intel SDM Vol 3 - System Programming Guide (2024)](#31-intel-sdm-vol-3---system-programming-guide-2024)
        - [3.1.1 (1) VMCS (Virtual Machine Control Structure)](#311-1-vmcs-virtual-machine-control-structure)
        - [3.1.2 (2) EPT (Extended Page Tables)](#312-2-ept-extended-page-tables)
        - [3.1.3 (3) VMX Instructions](#313-3-vmx-instructions)
      - [3.2 ARM Architecture Reference Manual for ARMv8-A (2024)](#32-arm-architecture-reference-manual-for-armv8-a-2024)
    - [4 . Wikipediaæ¨¡å‹å¯¹æ ‡](#4--wikipediaæ¨¡å‹å¯¹æ ‡)
      - [4.1 X86 Virtualization (Wikipedia)](#41-x86-virtualization-wikipedia)
      - [4.2 Hypervisor (Wikipedia)](#42-hypervisor-wikipedia)
  - [5 ğŸ”¬ 32é¡¹ç†è®ºè¯¦ç»†å¯¹æ ‡](#5--32é¡¹ç†è®ºè¯¦ç»†å¯¹æ ‡)
    - [5.1 æ ¸å¿ƒç†è®ºç»„1: è™šæ‹ŸåŒ–åŸºç¡€ (8é¡¹)](#51-æ ¸å¿ƒç†è®ºç»„1-è™šæ‹ŸåŒ–åŸºç¡€-8é¡¹)
      - [5.1.1 ç†è®º1: å…¨è™šæ‹ŸåŒ–å½¢å¼åŒ–æ¨¡å‹](#511-ç†è®º1-å…¨è™šæ‹ŸåŒ–å½¢å¼åŒ–æ¨¡å‹)
      - [5.1.2 ç†è®º2: ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æ¨¡å‹](#512-ç†è®º2-ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.1.3 ç†è®º3: åŠè™šæ‹ŸåŒ–ï¼ˆParavirtualizationï¼‰æ¨¡å‹](#513-ç†è®º3-åŠè™šæ‹ŸåŒ–paravirtualizationæ¨¡å‹)
      - [5.1.4 ç†è®º4: å®¹å™¨è™šæ‹ŸåŒ–æ¨¡å‹](#514-ç†è®º4-å®¹å™¨è™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.1.5 ç†è®º5: I/Oè™šæ‹ŸåŒ–æ¨¡å‹](#515-ç†è®º5-ioè™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.1.6 ç†è®º6: ä¸­æ–­è™šæ‹ŸåŒ–æ¨¡å‹](#516-ç†è®º6-ä¸­æ–­è™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.1.7 ç†è®º7: æ—¶é’Ÿä¸æ—¶é—´è™šæ‹ŸåŒ–æ¨¡å‹](#517-ç†è®º7-æ—¶é’Ÿä¸æ—¶é—´è™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.1.8 ç†è®º8: è™šæ‹ŸåŒ–æ€§èƒ½å¼€é”€æ¨¡å‹](#518-ç†è®º8-è™šæ‹ŸåŒ–æ€§èƒ½å¼€é”€æ¨¡å‹)
    - [5.2 æ ¸å¿ƒç†è®ºç»„2: CPUæŒ‡ä»¤çº§å¯¹ç§°æ€§ (10é¡¹)](#52-æ ¸å¿ƒç†è®ºç»„2-cpuæŒ‡ä»¤çº§å¯¹ç§°æ€§-10é¡¹)
      - [5.2.1 ç†è®º9: å¯¹ç§°æŒ‡ä»¤å¯¹æ¨¡å‹ (å®šä¹‰ 15.9)](#521-ç†è®º9-å¯¹ç§°æŒ‡ä»¤å¯¹æ¨¡å‹-å®šä¹‰-159)
      - [5.2.2 ç†è®º10: CPUæŒ‡ä»¤çº§é•œåƒæ€§å®šç† (å®šç† 15.10)](#522-ç†è®º10-cpuæŒ‡ä»¤çº§é•œåƒæ€§å®šç†-å®šç†-1510)
      - [5.2.3 ç†è®º11: CPUæ‹“æ‰‘å¯¹ç§°å®šç† (å®šç† 15.11)](#523-ç†è®º11-cpuæ‹“æ‰‘å¯¹ç§°å®šç†-å®šç†-1511)
      - [5.2.4 ç†è®º12: æŒ‡ä»¤ç¿»è¯‘å¯¹ç§°æ€§å®šç†](#524-ç†è®º12-æŒ‡ä»¤ç¿»è¯‘å¯¹ç§°æ€§å®šç†)
      - [5.2.5 ç†è®º13: CPUçŠ¶æ€ä¿å­˜/æ¢å¤å¯¹ç§°æ€§](#525-ç†è®º13-cpuçŠ¶æ€ä¿å­˜æ¢å¤å¯¹ç§°æ€§)
      - [5.2.6 ç†è®º14: æ•æ„ŸæŒ‡ä»¤æ‹¦æˆªæ¨¡å‹](#526-ç†è®º14-æ•æ„ŸæŒ‡ä»¤æ‹¦æˆªæ¨¡å‹)
      - [5.2.7 ç†è®º15: ç‰¹æƒçº§è½¬æ¢å¯¹ç§°æ€§](#527-ç†è®º15-ç‰¹æƒçº§è½¬æ¢å¯¹ç§°æ€§)
      - [5.2.8 ç†è®º16: ç³»ç»Ÿè°ƒç”¨è™šæ‹ŸåŒ–å¯¹ç§°æ€§](#528-ç†è®º16-ç³»ç»Ÿè°ƒç”¨è™šæ‹ŸåŒ–å¯¹ç§°æ€§)
      - [5.2.9 ç†è®º17: å¼‚å¸¸å¤„ç†è™šæ‹ŸåŒ–å¯¹ç§°æ€§](#529-ç†è®º17-å¼‚å¸¸å¤„ç†è™šæ‹ŸåŒ–å¯¹ç§°æ€§)
      - [5.2.10 ç†è®º18: æŒ‡ä»¤æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹ç§°æ€§](#5210-ç†è®º18-æŒ‡ä»¤æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹ç§°æ€§)
    - [5.3 æ ¸å¿ƒç†è®ºç»„3: å†…å­˜è™šæ‹ŸåŒ– (7é¡¹)](#53-æ ¸å¿ƒç†è®ºç»„3-å†…å­˜è™šæ‹ŸåŒ–-7é¡¹)
      - [5.3.1 ç†è®º19: EPT/NPTå½¢å¼åŒ–æ¨¡å‹](#531-ç†è®º19-eptnptå½¢å¼åŒ–æ¨¡å‹)
      - [5.3.2 ç†è®º20: Shadow Page Tableæ¨¡å‹](#532-ç†è®º20-shadow-page-tableæ¨¡å‹)
      - [5.3.3 ç†è®º21: TLBè™šæ‹ŸåŒ–æ¨¡å‹](#533-ç†è®º21-tlbè™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.3.4 ç†è®º22: å†…å­˜æ°”çƒï¼ˆBallooningï¼‰æ¨¡å‹](#534-ç†è®º22-å†…å­˜æ°”çƒballooningæ¨¡å‹)
      - [5.3.5 ç†è®º23: å†…å­˜å»é‡ï¼ˆDeduplicationï¼‰æ¨¡å‹](#535-ç†è®º23-å†…å­˜å»é‡deduplicationæ¨¡å‹)
      - [5.3.6 ç†è®º24: å†…å­˜çƒ­æ’æ‹”è™šæ‹ŸåŒ–æ¨¡å‹](#536-ç†è®º24-å†…å­˜çƒ­æ’æ‹”è™šæ‹ŸåŒ–æ¨¡å‹)
      - [5.3.7 ç†è®º25: å¤§é¡µï¼ˆHuge Pageï¼‰è™šæ‹ŸåŒ–æ¨¡å‹](#537-ç†è®º25-å¤§é¡µhuge-pageè™šæ‹ŸåŒ–æ¨¡å‹)
    - [5.4 æ ¸å¿ƒç†è®ºç»„4: é€’å½’ä¸åµŒå¥— (7é¡¹)](#54-æ ¸å¿ƒç†è®ºç»„4-é€’å½’ä¸åµŒå¥—-7é¡¹)
      - [5.4.1 ç†è®º26: è™šæ‹ŸåŒ–å±‚å››å…ƒç»„ (å®šä¹‰ 15.20)](#541-ç†è®º26-è™šæ‹ŸåŒ–å±‚å››å…ƒç»„-å®šä¹‰-1520)
      - [5.4.2 ç†è®º27: åµŒå¥—è™šæ‹ŸåŒ–ï¼ˆNested Virtualizationï¼‰æ¨¡å‹](#542-ç†è®º27-åµŒå¥—è™šæ‹ŸåŒ–nested-virtualizationæ¨¡å‹)
      - [5.4.3 ç†è®º28: é€’å½’è™šæ‹ŸåŒ–æ·±åº¦é™åˆ¶å®šç†](#543-ç†è®º28-é€’å½’è™šæ‹ŸåŒ–æ·±åº¦é™åˆ¶å®šç†)
      - [5.4.4 ç†è®º29: è·¨å±‚èµ„æºæ˜ å°„æ¨¡å‹](#544-ç†è®º29-è·¨å±‚èµ„æºæ˜ å°„æ¨¡å‹)
      - [5.4.5 ç†è®º30: è™šæ‹ŸåŒ–å±‚çŠ¶æ€åŒæ­¥æ¨¡å‹](#545-ç†è®º30-è™šæ‹ŸåŒ–å±‚çŠ¶æ€åŒæ­¥æ¨¡å‹)
      - [5.4.6 ç†è®º31: è™šæ‹ŸåŒ–å±‚é—´é€šä¿¡æ¨¡å‹](#546-ç†è®º31-è™šæ‹ŸåŒ–å±‚é—´é€šä¿¡æ¨¡å‹)
      - [5.4.7 ç†è®º32: è™šæ‹ŸåŒ–å±‚æ€§èƒ½éš”ç¦»æ¨¡å‹](#547-ç†è®º32-è™šæ‹ŸåŒ–å±‚æ€§èƒ½éš”ç¦»æ¨¡å‹)
  - [6 ğŸ“Š 32é¡¹ç†è®ºç»Ÿè®¡](#6--32é¡¹ç†è®ºç»Ÿè®¡)
    - [6.1 æŒ‰å¯¹æ ‡æ¥æºåˆ†ç±»](#61-æŒ‰å¯¹æ ‡æ¥æºåˆ†ç±»)
    - [6.2 æŒ‰æŠ€æœ¯åˆ†ç±»](#62-æŒ‰æŠ€æœ¯åˆ†ç±»)
  - [7 ğŸ“ å­¦ä¹ è·¯å¾„](#7--å­¦ä¹ è·¯å¾„)
    - [7.1 åˆå­¦è€…è·¯å¾„ (4-6ä¸ªæœˆ)](#71-åˆå­¦è€…è·¯å¾„-4-6ä¸ªæœˆ)
    - [7.2 è¿›é˜¶è·¯å¾„ (ç ”ç©¶ç”Ÿ/ç ”ç©¶è€…)](#72-è¿›é˜¶è·¯å¾„-ç ”ç©¶ç”Ÿç ”ç©¶è€…)
  - [8 ğŸ“– æ¨èé˜…è¯»](#8--æ¨èé˜…è¯»)
    - [8.1 å¿…è¯»æ•™æ](#81-å¿…è¯»æ•™æ)
    - [8.2 å¿…è¯»è®ºæ–‡](#82-å¿…è¯»è®ºæ–‡)
    - [8.3 å¼€æºé¡¹ç›®](#83-å¼€æºé¡¹ç›®)
  - [9 ğŸ”— ç›¸å…³æ–‡æ¡£](#9--ç›¸å…³æ–‡æ¡£)
  - [10 ğŸ“Œ å…ƒä¿¡æ¯](#10--å…ƒä¿¡æ¯)
  - [11 ğŸ“ˆ å®ŒæˆçŠ¶æ€æ€»ç»“](#11--å®ŒæˆçŠ¶æ€æ€»ç»“)
    - [11.1 æ–‡æ¡£å®Œæˆåº¦](#111-æ–‡æ¡£å®Œæˆåº¦)
    - [11.2 ç†è®ºåˆ†å¸ƒç»Ÿè®¡](#112-ç†è®ºåˆ†å¸ƒç»Ÿè®¡)
    - [11.3 åˆ›æ–°ç­‰çº§åˆ†å¸ƒ](#113-åˆ›æ–°ç­‰çº§åˆ†å¸ƒ)
    - [11.4 å¯¹æ ‡è¦†ç›–åº¦](#114-å¯¹æ ‡è¦†ç›–åº¦)

## ğŸ“‹ æ–‡æ¡£å…ƒä¿¡æ¯

| å±æ€§ | å€¼ |
|------|-----|
| **æ–‡æ¡£ç‰ˆæœ¬** | v1.0 (OSè™šæ‹ŸåŒ–é¢†åŸŸè¯¦ç»†å¯¹æ ‡) |
| **åˆ›å»ºæ—¥æœŸ** | 2025-10-22 |
| **å­¦æœ¯é¢†åŸŸ** | Operating Systems - Virtualization (ACM CCS 2012) |
| **ç†è®ºæ•°é‡** | 32é¡¹ |
| **ä¸»è¦æ–‡æ¡£** | Doc 06, 08, 11, 12 (Part XV.14) |
| **è´¨é‡ç­‰çº§** | A++ (æƒå¨å¯¹æ ‡) |

---

## 3 ğŸ¯ é¢†åŸŸæ¦‚è¿°

**æ“ä½œç³»ç»Ÿè™šæ‹ŸåŒ– (OS Virtualization)** æ˜¯ç°ä»£äº‘è®¡ç®—å’Œæ•°æ®ä¸­å¿ƒçš„æ ¸å¿ƒæŠ€æœ¯ã€‚æœ¬æ–‡æ¡£å°†Analysisæ¨¡å—ä¸­çš„32é¡¹è™šæ‹ŸåŒ–ç†è®ºåˆ›æ–°ä¸å›½é™…æƒå¨èµ„æºè¿›è¡Œè¯¦ç»†å¯¹æ ‡ã€‚

**æ ¸å¿ƒä¸»é¢˜**:

- å…¨è™šæ‹ŸåŒ– (Full Virtualization)
- åŠè™šæ‹ŸåŒ– (Paravirtualization)
- ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ– (Hardware-assisted Virtualization)
- CPUæŒ‡ä»¤çº§è™šæ‹ŸåŒ– (CPU Instruction-level Virtualization)
- å†…å­˜è™šæ‹ŸåŒ– (Memory Virtualization)
- I/Oè™šæ‹ŸåŒ– (I/O Virtualization)

---

## 4 ğŸ“š æƒå¨èµ„æºä½“ç³»

### 1 . ç»å…¸æ•™æå¯¹æ ‡

#### 1.1 Andrew S. Tanenbaum - Modern Operating Systems (4th, 2014)

**Ch 7: Virtualization and the Cloud** å®Œæ•´å¯¹æ ‡:

| ç« èŠ‚ | ä¸»é¢˜ | å¯¹æ ‡ç†è®º | æ–‡æ¡£ä½ç½® |
|------|------|---------|---------|
| **7.1** | History and Requirements | Popek-Goldbergå½¢å¼åŒ– | Doc 06 |
| **7.2** | Type 1 & Type 2 Hypervisors | è™šæ‹ŸåŒ–å±‚åˆ†ç±» | Doc 06, 11 |
| **7.3** | Techniques for Efficient Virtualization | ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æ¨¡å‹ | Doc 06, 08 |
| **7.4** | Memory Virtualization | EPT/NPTå½¢å¼åŒ– | Doc 08, 12 |
| **7.5** | I/O Virtualization | SR-IOV, IOMMU | Doc 08 |
| **7.6** | Virtual Appliances | é•œåƒæ€§ç†è®º | Doc 12 Part XV.14 |
| **7.7** | Virtual Machines on Multicore CPUs | NUMA, è°ƒåº¦ | Doc 11 |
| **7.8** | Licensing Issues | - | (ä¸æ¶‰åŠ) |

**åˆ›æ–°å¯¹æ¯”**:

| Tanenbaum MOSå†…å®¹ | æœ¬æ–‡æ¡£åˆ›æ–° | åˆ›æ–°ç­‰çº§ |
|------------------|-----------|---------|
| æè¿°æ€§è™šæ‹ŸåŒ–åˆ†ç±» | å½¢å¼åŒ–è™šæ‹ŸåŒ–æ¨¡å‹ | Level 2 |
| VMXæŒ‡ä»¤ä»‹ç» | CPUæŒ‡ä»¤çº§é•œåƒæ€§å®šç† | Level 1 |
| EPTåŸç†è¯´æ˜ | åœ°å€ç©ºé—´å½¢å¼åŒ–å»ºæ¨¡ | Level 2 |

#### 1.2 Remzi H. Arpaci-Dusseau - Operating Systems: Three Easy Pieces (OSTEP, 2018)

**Part II: Virtualization** å¯¹æ ‡:

| ç« èŠ‚ | ä¸»é¢˜ | OSTEPå†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• ||
|------|------|-----------|-----------||
| **Ch 4** | The Abstraction: The Process | è¿›ç¨‹æŠ½è±¡ | å®¹å™¨è¿›ç¨‹ç»„æŠ½è±¡ |
| **Ch 13** | The Abstraction: Address Spaces | åœ°å€ç©ºé—´ | EPT/NPTå¤šçº§æ˜ å°„ |
| **Ch 15** | Mechanism: Address Translation | åœ°å€è½¬æ¢ | ç¡¬ä»¶è¾…åŠ©è½¬æ¢å½¢å¼åŒ– |
| **Ch 18** | Paging: Introduction | åˆ†é¡µæœºåˆ¶ | Shadow Page Table | Doc 08 |
| **Ch 20** | Paging: Smaller Tables | å¤šçº§é¡µè¡¨ | EPT 4çº§é¡µè¡¨ | Doc 08 |

**æ•™å­¦ä»·å€¼å¯¹æ¯”**:

| ç»´åº¦ | OSTEP | æœ¬æ–‡æ¡£ |
|------|-------|-------|
| **æ·±åº¦** | æœ¬ç§‘æ•™æçº§åˆ« | ç ”ç©¶ç”Ÿ/ç ”ç©¶çº§åˆ« |
| **å¹¿åº¦** | é€šç”¨OSåŸç† | ä¸“æ³¨è™šæ‹ŸåŒ–æŠ€æœ¯ |
| **å½¢å¼åŒ–** | æ¦‚å¿µè®²è§£ | ä¸¥æ ¼æ•°å­¦è¯æ˜ |

#### 1.3 Jim Smith & Ravi Nair - Virtual Machines (2005)

**ç»å…¸è™šæ‹ŸåŒ–ä¸“è‘—å¯¹æ ‡**:

| ç« èŠ‚ | ä¸»é¢˜ | å¯¹æ ‡ç†è®º |
|------|------|---------|
| **Ch 3** | Emulation | æŒ‡ä»¤æ¨¡æ‹Ÿå½¢å¼åŒ– |
| **Ch 4** | Interpretation | CPUçŠ¶æ€è½¬ç§» |
| **Ch 5** | Binary Translation | æŒ‡ä»¤ç¿»è¯‘å¯¹ç§°æ€§ |
| **Ch 6** | Hardware Support | VMX/SVMå¯¹åº”å®šç† |
| **Ch 7** | Memory Virtualization | EPT/NPTå½¢å¼åŒ– |

---

### 2 . å¤§å­¦è¯¾ç¨‹å¯¹æ ‡

#### 2.1 MIT 6.828 - Operating System Engineering (2024)

**Labå®éªŒå¯¹æ ‡**:

| Lab | MIT 6.828ä¸»é¢˜ | å¯¹æ ‡ç†è®º | å®ç°ä½ç½® |
|-----|--------------|---------|---------|
| **Lab 1** | Booting | å¯åŠ¨åºåˆ—å½¢å¼åŒ– | Doc 08 |
| **Lab 2** | Memory Management | å†…å­˜è™šæ‹ŸåŒ– | Doc 08 |
| **Lab 3** | User Environments | è¿›ç¨‹éš”ç¦» | Doc 06, 11 |
| **Lab 4** | Preemptive Multitasking | CPUè°ƒåº¦ | Doc 11 |
| **Lab 5** | File System | I/Oè™šæ‹ŸåŒ– | Doc 08 |
| **Lab 6** | Network Driver | ç½‘ç»œè™šæ‹ŸåŒ– | Doc 08 |

**è¯¾ç¨‹é¡¹ç›®å¯¹åº”**:

| Project | ä¸»é¢˜ | æœ¬æ–‡æ¡£ç­‰ä»· |
|---------|------|-----------|
| **Final Project** | JOS on VMX | å®ç°è™šæ‹ŸåŒ–å±‚ |
| - | - | å¯¹åº”: è™šæ‹ŸåŒ–å±‚å››å…ƒç»„å®ç° |

#### 2.2 Stanford CS140 - Operating Systems (2024)

**è¯¾ç¨‹å•å…ƒå¯¹æ ‡**:

| Week | ä¸»é¢˜ | æœ¬æ–‡æ¡£ç†è®º |
|------|------|-----------|
| **Week 1-2** | Introduction & Processes | è¿›ç¨‹æŠ½è±¡å½¢å¼åŒ– |
| **Week 3-4** | Threads & Synchronization | åŒæ­¥åŸè¯­ |
| **Week 5-6** | Virtual Memory | EPT/NPTç†è®º |
| **Week 7-8** | File Systems | å­˜å‚¨è™šæ‹ŸåŒ– |
| **Week 9-10** | Networking | ç½‘ç»œè™šæ‹ŸåŒ– |
| **Week 11-12** | Virtualization (Guest Lecture) | æœ¬æ–‡æ¡£æ ¸å¿ƒå†…å®¹ |

#### 2.3 CMU 15-410 - Operating System Design & Implementation (2024)

**Projectå¯¹æ ‡**:

| Project | CMU 15-410 | æœ¬æ–‡æ¡£æŒ‡å¯¼ |
|---------|------------|-----------|
| **P1** | Context Switch | CPUçŠ¶æ€ä¿å­˜/æ¢å¤ |
| **P2** | Thread Library | çº¿ç¨‹è™šæ‹ŸåŒ– |
| **P3** | Kernel | è™šæ‹ŸåŒ–Hypervisorè®¾è®¡ |
| **P4** | Device Drivers | I/Oè™šæ‹ŸåŒ–å®ç° |

---

### 3 . æŠ€æœ¯æ ‡å‡†å¯¹æ ‡

#### 3.1 Intel SDM Vol 3 - System Programming Guide (2024)

**å®Œæ•´ç« èŠ‚å¯¹æ ‡**:

| ç« èŠ‚ | Intel SDMä¸»é¢˜ | å¯¹æ ‡ç†è®º | æ–‡æ¡£ä½ç½® |
|------|--------------|---------|---------|
| **Ch 5** | Protection | ä¿æŠ¤ç¯ã€ç‰¹æƒçº§ | Doc 08 |
| **Ch 23** | Introduction to VMX | VMXæ¦‚è¿° | Doc 06 |
| **Ch 24** | Virtual Machine Control Structures | VMCSå½¢å¼åŒ– | Doc 12 Part XV.14 |
| **Ch 25** | VMX Non-Root Operation | Guestæ‰§è¡Œæ¨¡å‹ | Doc 12 Part XV.14 |
| **Ch 26** | VM Entries | VMLAUNCH/VMRESUME | Doc 12 Part XV.14 |
| **Ch 27** | VM Exits | VMEXITå¤„ç† | Doc 12 Part XV.14 |
| **Ch 28** | VMX Support for Address Translation | EPT | Doc 08 |
| **Ch 29** | APIC Virtualization | ä¸­æ–­è™šæ‹ŸåŒ– | Doc 08 |
| **Ch 30** | VMX Instruction Reference | æŒ‡ä»¤çº§å¯¹ç§°æ€§ | Doc 12 Part XV.14 |

**æ ¸å¿ƒæ¦‚å¿µå¯¹æ ‡**:

##### 3.1.1 (1) VMCS (Virtual Machine Control Structure)

**Intel SDMå®šä¹‰**:

- 4KBæ•°æ®ç»“æ„
- æ§åˆ¶VMæ‰§è¡Œç¯å¢ƒ
- Guest/HostçŠ¶æ€å­—æ®µ

**æœ¬æ–‡æ¡£æ‰©å±•** (å®šä¹‰ 15.9):

$$
\text{VMCS} = \{\text{GuestState}, \text{HostState}, \text{ExecutionControl}, \text{ExitControl}, \text{EntryControl}\}
$$

- **æ¥æº**: Intel SDM Vol 3 Ch 24
- **åˆ›æ–°**: ä½œä¸º"å¯é€†é”®"çš„å½¢å¼åŒ–å®šä¹‰
- **å¯¹æ ‡**: å¯¹ç§°æŒ‡ä»¤å¯¹æ¨¡å‹ä¸­çš„ReversibleKey

##### 3.1.2 (2) EPT (Extended Page Tables)

**Intel SDMå®šä¹‰**:

- ç¡¬ä»¶æ”¯æŒçš„äºŒæ¬¡åœ°å€è½¬æ¢
- Guest Physical â†’ Host Physical
- 4çº§é¡µè¡¨ç»“æ„

**æœ¬æ–‡æ¡£å½¢å¼åŒ–** (Doc 08):

$$
\text{EPT}: \text{GPA} \to \text{HPA}
$$

$$
\text{HPA} = \text{EPT}[\text{EPT}[\text{EPT}[\text{EPT}[\text{GPA}]]]]
$$

- **æ¥æº**: Intel SDM Vol 3 Ch 28
- **åˆ›æ–°**: å¯é€†æ˜ å°„çš„å½¢å¼åŒ–è¯æ˜
- **å¯¹æ ‡**: Classificationåœ°å€ç©ºé—´åˆ†æ®µ

##### 3.1.3 (3) VMX Instructions

**å¯¹ç§°æŒ‡ä»¤å¯¹è¯¦ç»†å¯¹æ ‡**:

| Intel SDMæŒ‡ä»¤ | åŠŸèƒ½ | å¯¹ç§°æŒ‡ä»¤ | æœ¬æ–‡æ¡£å®šä¹‰ |
|--------------|------|---------|-----------|
| **VMLAUNCH** | é¦–æ¬¡è¿›å…¥VM | VMEXIT | æ­£å‘é—¨ (å®šä¹‰ 15.9) |
| **VMRESUME** | æ¢å¤VMæ‰§è¡Œ | VMEXIT | é•œåƒé—¨ (å®šä¹‰ 15.9) |
| **VMREAD** | è¯»VMCSå­—æ®µ | VMWRITE | çŠ¶æ€æŸ¥è¯¢ |
| **VMWRITE** | å†™VMCSå­—æ®µ | VMREAD | çŠ¶æ€ä¿®æ”¹ |
| **VMCALL** | Guestè°ƒç”¨Host | è¿”å›åˆ°Guest | Hypercall |

**æœ¬æ–‡æ¡£CPUæŒ‡ä»¤çº§é•œåƒæ€§å®šç†** (å®šç† 15.10):

$$
\forall I \in \text{Instructions}, \forall L \in \text{Layers}: \\
\exists \text{Mirror}(I, L): \text{Forward}(I, L) \circ \text{Mirror}(I, L) = \text{id}
$$

- **æ¥æº**: æœ¬æ–‡é¦–åˆ›ï¼ˆåŸºäºIntel SDMï¼‰
- **åˆ›æ–°**: æ¯”ç‰¹çº§å¯é€†æ€§è¯æ˜
- **å¯¹æ ‡**: Intel SDM Vol 3 Ch 30

#### 3.2 ARM Architecture Reference Manual for ARMv8-A (2024)

**è™šæ‹ŸåŒ–æ‰©å±•å¯¹æ ‡**:

| ARMç‰¹æ€§ | æè¿° | å¯¹æ ‡ç†è®º |
|---------|------|---------|
| **EL0-EL3** | Exception Levels | ç‰¹æƒçº§å½¢å¼åŒ– |
| **Stage-2 Translation** | äºŒæ¬¡åœ°å€è½¬æ¢ | EPTç­‰ä»·ç‰© |
| **VBAR_EL2** | Hypervisorå‘é‡è¡¨ | Hostå…¥å£ç‚¹ |
| **HCR_EL2** | Hypervisoré…ç½® | æ‰§è¡Œæ§åˆ¶ |

**Intel vs ARMå¯¹æ¯”**:

| æ¦‚å¿µ | Intel VMX | ARM | æœ¬æ–‡æ¡£ç»Ÿä¸€ |
|------|-----------|-----|-----------|
| **ç‰¹æƒçº§** | Ring 0-3, Root/Non-root | EL0-EL3 | åˆ†å±‚æƒé™æ¨¡å‹ |
| **äºŒæ¬¡è½¬æ¢** | EPT | Stage-2 | åœ°å€ç©ºé—´æ˜ å°„ |
| **è¿›å…¥VM** | VMLAUNCH | ERET to EL1 | Forwardé—¨ |
| **é€€å‡ºVM** | VMEXIT | Exception to EL2 | Mirroré—¨ |

---

### 4 . Wikipediaæ¨¡å‹å¯¹æ ‡

#### 4.1 X86 Virtualization (Wikipedia)

**URL**: <https://en.wikipedia.org/wiki/X86_virtualization>

**å¯¹æ ‡å†…å®¹**:

| Wikipediaä¸»é¢˜ | å¯¹æ ‡ç†è®º | åˆ›æ–°ç‚¹ |
|--------------|---------|--------|
| **Popek-Goldberg Requirements** | å…¨è™šæ‹ŸåŒ–å½¢å¼åŒ–æ¨¡å‹ | é›†åˆè®ºä¸¥æ ¼è¯æ˜ |
| **Binary Translation** | æŒ‡ä»¤ç¿»è¯‘å¯¹ç§°æ€§ | å¯é€†æ€§åˆ†æ |
| **Hardware-assisted Virtualization** | VMX/SVMå½¢å¼åŒ– | ç¡¬ä»¶-è½¯ä»¶å¯¹åº” |
| **Memory Virtualization** | EPT/NPTæ¨¡å‹ | å¤šçº§æ˜ å°„å½¢å¼åŒ– |

#### 4.2 Hypervisor (Wikipedia)

**Type 1 vs Type 2å¯¹æ ‡**:

| ç±»å‹ | Wikipediaå®šä¹‰ | æœ¬æ–‡æ¡£å½¢å¼åŒ– |
|------|--------------|-------------|
| **Type 1** | Bare-metal | $\text{HV}_1: \text{Hardware} \to \text{VM}$ |
| **Type 2** | Hosted | $\text{HV}_2: \text{OS} \to \text{VM}$ |

---

## 5 ğŸ”¬ 32é¡¹ç†è®ºè¯¦ç»†å¯¹æ ‡

### 5.1 æ ¸å¿ƒç†è®ºç»„1: è™šæ‹ŸåŒ–åŸºç¡€ (8é¡¹)

#### 5.1.1 ç†è®º1: å…¨è™šæ‹ŸåŒ–å½¢å¼åŒ–æ¨¡å‹

**å®šä¹‰** (Doc 06):

åŸºäº**Popek-Goldbergå®šç†** (1974)çš„å½¢å¼åŒ–ï¼š

$$
\text{Virtualizable} \iff \text{SensitiveInstructions} \subseteq \text{PrivilegedInstructions}
$$

**å¯¹æ ‡åˆ†æ**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Popek & Goldberg (1974)** | åŸå§‹å®šç† | ä½¿ç”¨é›†åˆè®ºå½¢å¼åŒ– |
| **Tanenbaum MOS Ch 7.1** | æ•™ææè¿° | ä¸¥æ ¼æ•°å­¦è¯æ˜ |
| **Wikipedia** | æ¦‚å¿µè§£é‡Š | å¯æ‰§è¡ŒCoqè¯æ˜ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

**Coqè¯æ˜ç‰‡æ®µ**:

```coq
Theorem virtualizable_iff_sensitive_privileged:
  virtualizable <->
  (forall i, sensitive i -> privileged i).
Proof.
  (* è¯æ˜ç•¥ *)
Qed.
```

#### 5.1.2 ç†è®º2: ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 06, 08):

$$
\text{HW-Assisted} = \{\text{VMX}, \text{SVM}, \text{EPT}, \text{NPT}, \text{IOMMU}\}
$$

**Intel VT-xå½¢å¼åŒ–**:

$$
\text{VT-x}: \begin{cases}
\text{VMX Operations} & (\text{VMLAUNCH}, \text{VMRESUME}, \text{VMEXIT}) \\
\text{VMCS} & (\text{Guest/Host State}) \\
\text{EPT} & (\text{GPA} \to \text{HPA})
\end{cases}
$$

**å¯¹æ ‡**:

| æŠ€æœ¯ | æ ‡å‡†æ¥æº | æœ¬æ–‡æ¡£å½¢å¼åŒ– |
|------|---------|-------------|
| **Intel VT-x** | Intel SDM Vol 3 | VMXæ“ä½œå½¢å¼åŒ– |
| **AMD-V** | AMD APM Vol 2 | SVMç­‰ä»·æ¨¡å‹ |
| **ARM Virtualization** | ARM ARM | EL2å½¢å¼åŒ– |

**åˆ›æ–°**: EPT/NPTçš„å¯é€†æ˜ å°„è¯æ˜

#### 5.1.3 ç†è®º3: åŠè™šæ‹ŸåŒ–ï¼ˆParavirtualizationï¼‰æ¨¡å‹

**å®šä¹‰** (Doc 06):

åŠè™šæ‹ŸåŒ–é€šè¿‡ä¿®æ”¹Guest OSï¼Œä½¿å…¶ä¸Hypervisoråä½œï¼Œé¿å…æ•æ„ŸæŒ‡ä»¤é™·é˜±ï¼š

$$
\text{Paravirtualizable} = \{\text{GuestAware}, \text{Hypercall}, \text{SharedMemory}, \text{Cooperative}\}
$$

**æ ¸å¿ƒæœºåˆ¶**:

$$
\begin{cases}
\text{GuestOSä¿®æ”¹} & \text{æ›¿æ¢æ•æ„ŸæŒ‡ä»¤ä¸ºhypercall} \\
\text{Hypercallæ¥å£} & \text{Guestä¸»åŠ¨è°ƒç”¨Hypervisor} \\
\text{å…±äº«å†…å­˜} & \text{Guest-Hypervisoré«˜æ•ˆé€šä¿¡}
\end{cases}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Xen Architecture** | XenåŠè™šæ‹ŸåŒ–è®¾è®¡ | å½¢å¼åŒ–hypercallæ¥å£ |
| **Tanenbaum Ch 7.3** | åŠè™šæ‹ŸåŒ–åŸç† | æ€§èƒ½å¼€é”€é‡åŒ–æ¨¡å‹ |
| **Denali (2002)** | è½»é‡çº§è™šæ‹ŸåŒ– | å½¢å¼åŒ–åä½œæ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

**æ€§èƒ½ä¼˜åŠ¿**:

$$
\text{Overhead}_{\text{para}} < \text{Overhead}_{\text{full}} \approx 2-5\% \text{ vs } 10-20\%
$$

#### 5.1.4 ç†è®º4: å®¹å™¨è™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 06, 11):

å®¹å™¨è™šæ‹ŸåŒ–åŸºäºOSå†…æ ¸å…±äº«ï¼Œé€šè¿‡Namespaceå’ŒCgroupå®ç°éš”ç¦»ï¼š

$$
\text{Container} = \{\text{Namespace}, \text{Cgroup}, \text{SharedKernel}, \text{ImageLayer}\}
$$

**Namespaceåˆ†ç±»**:

| Namespaceç±»å‹ | éš”ç¦»èµ„æº | å½¢å¼åŒ–å®šä¹‰ |
|--------------|---------|-----------|
| **PID** | è¿›ç¨‹ID | $PID_{\text{container}} \cap PID_{\text{host}} = \emptyset$ |
| **Mount** | æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹ | $Mount_{\text{container}} \subseteq Mount_{\text{host}}$ |
| **Network** | ç½‘ç»œæ ˆ | $NetDev_{\text{container}} \subseteq NetDev_{\text{host}}$ |
| **UTS** | ä¸»æœºå/åŸŸå | $Hostname_{\text{container}} \neq Hostname_{\text{host}}$ |
| **IPC** | è¿›ç¨‹é—´é€šä¿¡ | $IPC_{\text{container}} \cap IPC_{\text{host}} = \emptyset$ |
| **User** | ç”¨æˆ·IDæ˜ å°„ | $UID_{\text{container}} \to UID_{\text{host}}$ |
| **Cgroup** | æ—¶é—´å‘½åç©ºé—´ | $Time_{\text{container}} \neq Time_{\text{host}}$ |

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Linux Namespaces (man 7)** | Namespaceæœºåˆ¶ | å½¢å¼åŒ–éš”ç¦»æ¨¡å‹ |
| **Docker Architecture** | å®¹å™¨å®ç° | é•œåƒå±‚å½¢å¼åŒ– |
| **Kubernetes Podæ¨¡å‹** | PodæŠ½è±¡ | å¤šå®¹å™¨ååŒå½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.1.5 ç†è®º5: I/Oè™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

I/Oè™šæ‹ŸåŒ–é€šè¿‡è½¯ä»¶æ¨¡æ‹Ÿã€åŠè™šæ‹ŸåŒ–æˆ–ç¡¬ä»¶ç›´é€šå®ç°è®¾å¤‡è®¿é—®ï¼š

$$
\text{IOVirt} = \{\text{Emulation}, \text{Paravirt}, \text{Passthrough}, \text{SR-IOV}\}
$$

**I/Oè™šæ‹ŸåŒ–æ–¹å¼å¯¹æ¯”**:

| æ–¹å¼ | æœºåˆ¶ | æ€§èƒ½ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|------|------|--------|---------|
| **å…¨è™šæ‹ŸåŒ–** | QEMUè®¾å¤‡æ¨¡æ‹Ÿ | ä½ï¼ˆ~50%å¼€é”€ï¼‰ | é«˜ | å…¼å®¹æ€§è¦æ±‚é«˜ |
| **åŠè™šæ‹ŸåŒ–** | Virtioå‰ç«¯/åç«¯ | ä¸­ï¼ˆ~5%å¼€é”€ï¼‰ | ä¸­ | æ€§èƒ½æ•æ„Ÿåº”ç”¨ |
| **è®¾å¤‡ç›´é€š** | IOMMU/VT-d | é«˜ï¼ˆ<1%å¼€é”€ï¼‰ | ä½ | é«˜æ€§èƒ½I/O |
| **SR-IOV** | ç¡¬ä»¶VF | é«˜ï¼ˆ<1%å¼€é”€ï¼‰ | ä½ | å¤šVMå…±äº«è®¾å¤‡ |

**å½¢å¼åŒ–å®šä¹‰** (Intel VT-d):

$$
\text{IOMMU}: \text{DMA Address} \xrightarrow{\text{Remapping}} \text{Physical Address}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel VT-d Spec** | IOMMUæœºåˆ¶ | DMAé‡æ˜ å°„å½¢å¼åŒ– |
| **PCIe SR-IOV Spec** | è™šæ‹ŸåŠŸèƒ½ | VFåˆ†é…ç®—æ³•å½¢å¼åŒ– |
| **Virtio 1.2 Spec** | åŠè™šæ‹ŸåŒ–æ¥å£ | é˜Ÿåˆ—æŠ½è±¡å½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.1.6 ç†è®º6: ä¸­æ–­è™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

ä¸­æ–­è™šæ‹ŸåŒ–é€šè¿‡APICè™šæ‹ŸåŒ–å’Œä¸­æ–­æ³¨å…¥å®ç°ä¸­æ–­ä¼ é€’ï¼š

$$
\text{InterruptVirt} = \{\text{APICVirt}, \text{InterruptInjection}, \text{PostedInterrupt}\}
$$

**ä¸­æ–­è™šæ‹ŸåŒ–æœºåˆ¶**:

$$
\begin{cases}
\text{ç‰©ç†ä¸­æ–­} & \to \text{Hypervisoræ‹¦æˆª} \\
\text{è™šæ‹Ÿä¸­æ–­} & \to \text{æ³¨å…¥åˆ°Guest} \\
\text{Posted Interrupt} & \to \text{å‡å°‘VM-Exit}
\end{cases}
$$

**APICè™šæ‹ŸåŒ–å½¢å¼åŒ–** (Intel APICv):

$$
\text{APICv}: \text{PhysicalAPIC} \xrightarrow{\text{Shadow}} \text{VirtualAPIC}
$$

**æ€§èƒ½ä¼˜åŒ–**:

$$
\text{VM-Exit}_{\text{APICv}} \approx 0.1 \times \text{VM-Exit}_{\text{legacy}}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 29** | APICè™šæ‹ŸåŒ– | ä¸­æ–­æ³¨å…¥å½¢å¼åŒ– |
| **AMD SVM Spec** | AVICæœºåˆ¶ | ç»Ÿä¸€ä¸­æ–­è™šæ‹ŸåŒ–æ¨¡å‹ |
| **Xen Interrupt Handling** | ä¸­æ–­è·¯ç”± | å¤šçº§ä¸­æ–­å½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.1.7 ç†è®º7: æ—¶é’Ÿä¸æ—¶é—´è™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

æ—¶é’Ÿè™šæ‹ŸåŒ–é€šè¿‡è™šæ‹Ÿæ—¶é’Ÿå’Œå®šæ—¶å™¨å®ç°æ—¶é—´æŠ½è±¡ï¼š

$$
\text{TimeVirt} = \{\text{VirtualClock}, \text{VirtualTimer}, \text{TimeOffset}, \text{TimeSync}\}
$$

**æ—¶é’Ÿç±»å‹**:

| æ—¶é’Ÿç±»å‹ | Guestè§†å›¾ | Hostå®ç° | ç²¾åº¦ |
|---------|----------|---------|------|
| **RTC** | å®æ—¶æ—¶é’Ÿ | è™šæ‹ŸRTC | 1ç§’ |
| **PIT** | å¯ç¼–ç¨‹ä¸­æ–­å®šæ—¶å™¨ | è™šæ‹ŸPIT | 1ms |
| **HPET** | é«˜ç²¾åº¦äº‹ä»¶å®šæ—¶å™¨ | è™šæ‹ŸHPET | 100ns |
| **TSC** | æ—¶é—´æˆ³è®¡æ•°å™¨ | è™šæ‹ŸTSC + offset | CPUå‘¨æœŸ |

**æ—¶é—´åŒæ­¥æ¨¡å‹**:

$$
\text{GuestTime} = \text{HostTime} + \text{Offset} + \text{Drift}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **KVM Timekeeping** | æ—¶é’Ÿå®ç° | æ—¶é—´åŒæ­¥ç®—æ³•å½¢å¼åŒ– |
| **VMware Time Sync** | æ—¶é—´åŒæ­¥ | æ¼‚ç§»è¡¥å¿æ¨¡å‹ |
| **Xen Time Management** | æ—¶é—´ç®¡ç† | è™šæ‹Ÿæ—¶é’Ÿå½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.1.8 ç†è®º8: è™šæ‹ŸåŒ–æ€§èƒ½å¼€é”€æ¨¡å‹

**å®šä¹‰** (Doc 06, 08):

è™šæ‹ŸåŒ–æ€§èƒ½å¼€é”€å¯é€šè¿‡å»¶è¿Ÿã€ååé‡æŸå¤±å’Œèµ„æºå¼€é”€é‡åŒ–ï¼š

$$
\text{Overhead} = \{\text{Latency}, \text{ThroughputLoss}, \text{ResourceOverhead}\}
$$

**æ€§èƒ½å¼€é”€åˆ†è§£**:

$$
\text{TotalOverhead} = \text{VMExitCost} + \text{EPTWalkCost} + \text{IOSimCost} + \text{SchedulingCost}
$$

**é‡åŒ–æ¨¡å‹** (ä»¥CPUä¸ºä¾‹):

$$
\text{CPU}_{\text{effective}} = \frac{\text{CPU}_{\text{physical}} \times (1 - \text{Overhead})}{N_{\text{VMs}}}
$$

**å…¸å‹å¼€é”€** (ç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–):

| æ“ä½œ | å¼€é”€ | åŸå›  |
|------|------|------|
| **CPUæŒ‡ä»¤** | 2-5% | VM-Exitå¼€é”€ |
| **å†…å­˜è®¿é—®** | 5-10% | EPTéå† |
| **I/Oæ“ä½œ** | 10-30% | è®¾å¤‡æ¨¡æ‹Ÿ |
| **ç½‘ç»œ** | 5-15% | è™šæ‹Ÿç½‘ç»œæ ˆ |

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Adams & Agesen (2006)** | æ€§èƒ½å¯¹æ¯”ç ”ç©¶ | å¼€é”€åˆ†è§£æ¨¡å‹ |
| **VMware Performance** | æ€§èƒ½åŸºå‡†æµ‹è¯• | é‡åŒ–é¢„æµ‹æ¨¡å‹ |
| **KVM Benchmarks** | æ€§èƒ½æµ‹è¯• | å¼€é”€ä¼˜åŒ–ç­–ç•¥ |

**åˆ›æ–°ç­‰çº§**: Level 2 (é‡åŒ–æ¨¡å‹åˆ›æ–°)

---

### 5.2 æ ¸å¿ƒç†è®ºç»„2: CPUæŒ‡ä»¤çº§å¯¹ç§°æ€§ (10é¡¹)

#### 5.2.1 ç†è®º9: å¯¹ç§°æŒ‡ä»¤å¯¹æ¨¡å‹ (å®šä¹‰ 15.9)

**å®šä¹‰** (Doc 12 Part XV.14):

$$
\text{SymmetricPair} = \{\text{Forward}, \text{Mirror}, \text{ReversibleKey}\}
$$

| è™šæ‹ŸåŒ–å±‚ | ForwardæŒ‡ä»¤ | MirroræŒ‡ä»¤ | ReversibleKey |
|---------|-------------|------------|---------------|
| **L3** | VMLAUNCH/VMRESUME | VMEXIT | VMCSå½±å­å­—æ®µ |
| **L2** | SYSCALL/SYSENTER | SYSEXIT/SYSRETURN | pt_regsé•œåƒ |
| **L1** | SECCOMP_RET_TRAP | SECCOMP_RET_DATA | BPFè¿‡æ»¤å™¨æ©ç  |

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | å·®å¼‚ |
|---------|------|------|
| **Intel SDM Ch 30** | VMXæŒ‡ä»¤åˆ—è¡¨ | æœ¬æ–‡æ·»åŠ å¯¹ç§°æ€§ç†è®º |
| **Linux Kernel** | Syscallæœºåˆ¶ | æœ¬æ–‡å½¢å¼åŒ–å¯¹ç§°é—¨ |
| **BPF Spec** | Seccompè¿‡æ»¤ | æœ¬æ–‡è¯æ˜å¯é€†æ€§ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.2.2 ç†è®º10: CPUæŒ‡ä»¤çº§é•œåƒæ€§å®šç† (å®šç† 15.10)

**å®šç†é™ˆè¿°** (Doc 12 Part XV.14):

$$
\boxed{
\forall I \in \text{Instructions}, \forall L \in \{\text{VM}, \text{Container}, \text{Sandbox}\}: \\
\exists \text{Mirror}(I, L): \text{Execute}(I, L) \circ \text{Mirror}(I, L) = \text{BitIdentical}(\text{Execute}(I, \text{Host}))
}
$$

**è¯æ˜æ€è·¯** (ä»¥MOVæŒ‡ä»¤ä¸ºä¾‹):

```x86asm
; L0 è£¸æœº
MOV rax, [addr]  ; load phys(addr) â†’ rax

; L1 æ²™ç›’ (Seccompå…è®¸)
MOV rax, [addr]  ; â†’ ä¸‹æ²‰åˆ°L0
; L1 æ²™ç›’ (Seccompæ‹’ç»)
MOV rax, [addr]  ; â†’ SIGSYS, ucontextä¿å­˜å®Œæ•´çŠ¶æ€ (Mirror)

; L2 å®¹å™¨ (Namespaceæ˜ å°„)
MOV rax, [addr]  ; addr â†’ ns(addr), replay_mmapè®°å½•æ˜ å°„ (Mirror)

; L3 è™šæ‹ŸåŒ– (EPTè½¬æ¢)
MOV rax, [gPA]   ; gPA â†’ hPA via EPT, VMCSè®°å½•è½¬æ¢ (Mirror)
```

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | ç›¸å…³å†…å®¹ | æœ¬æ–‡æ¡£åˆ›æ–° |
|---------|---------|-----------|
| **Intel SDM** | VMCSä¿å­˜GuestçŠ¶æ€ | è¯æ˜æ¯”ç‰¹çº§å¯é€† |
| **Linux ptrace** | pt_regsä¿å­˜å¯„å­˜å™¨ | å½¢å¼åŒ–é•œåƒé—¨ |
| **æ— ç›´æ¥å¯¹æ ‡** | - | è·¨å±‚ç»Ÿä¸€é•œåƒç†è®º |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

**å­¦æœ¯ä»·å€¼**:

```yaml
ç†è®ºæ„ä¹‰:
  - é¦–æ¬¡è¯æ˜è™šæ‹ŸåŒ–çš„æ¯”ç‰¹çº§å¯é€†æ€§
  - ä¸ºç¡®å®šæ€§å›æ”¾æä¾›ç†è®ºåŸºç¡€

å®è·µä»·å€¼:
  - æŒ‡å¯¼è™šæ‹Ÿæœºè°ƒè¯•å™¨è®¾è®¡
  - æ”¯æŒæ—¶é—´æ—…è¡Œè°ƒè¯• (Time-travel Debugging)

å¯å‘è¡¨æ€§:
  - é€‚åˆ: OSDI, SOSP, EuroSys
  - æ ¸å¿ƒ: æŒ‡ä»¤çº§é•œåƒæ€§è¯æ˜
```

#### 5.2.3 ç†è®º11: CPUæ‹“æ‰‘å¯¹ç§°å®šç† (å®šç† 15.11)

**å®šç†é™ˆè¿°** (Doc 12 Part XV.14):

$$
\boxed{
\text{Virtualization} \cong_{\text{topology}} \text{Homeomorphism} \land \text{Bijection} \land \text{BitReversible}
}
$$

**ä¸‰é‡å®šä¹‰**:

1. **æ‹“æ‰‘åŒæ„**: Guestå’ŒHostçš„çŠ¶æ€ç©ºé—´æ‹“æ‰‘ç­‰ä»·
2. **åŒå°„**: Guestæ¯ä¸ªçŠ¶æ€å”¯ä¸€å¯¹åº”HostçŠ¶æ€
3. **æ¯”ç‰¹çº§å¯é€†**: å¯ç²¾ç¡®æ¢å¤åŸå§‹çŠ¶æ€

**å¯¹æ ‡**:

| æ•°å­¦ç†è®º | åº”ç”¨ | æœ¬æ–‡æ¡£åˆ›æ–° |
|---------|------|-----------|
| **æ‹“æ‰‘å­¦** | ç©ºé—´åŒèƒš | åº”ç”¨åˆ°CPUçŠ¶æ€ç©ºé—´ |
| **èŒƒç•´è®º** | åŒæ„æ˜ å°„ | Guest-HoståŒå°„ |
| **æ— ç›´æ¥å¯¹æ ‡** | - | ä¸‰é‡çº¦æŸç»Ÿä¸€å®šä¹‰ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.2.4 ç†è®º12: æŒ‡ä»¤ç¿»è¯‘å¯¹ç§°æ€§å®šç†

**å®šç†é™ˆè¿°** (Doc 12 Part XV.14):

äºŒè¿›åˆ¶ç¿»è¯‘ä¿æŒæŒ‡ä»¤è¯­ä¹‰å¯¹ç§°æ€§ï¼š

$$
\boxed{
\forall I_{\text{source}}, \exists I_{\text{translated}}: \text{Semantics}(I_{\text{source}}) = \text{Semantics}(I_{\text{translated}})
}
$$

**ç¿»è¯‘è§„åˆ™** (ä»¥x86ä¸ºä¾‹):

| æºæŒ‡ä»¤ | ç¿»è¯‘å | å¯¹ç§°æ€§ |
|--------|--------|--------|
| **MOV reg, [mem]** | åŠ è½½-å­˜å‚¨åºåˆ— | è¯­ä¹‰ç­‰ä»· |
| **JMP target** | é—´æ¥è·³è½¬ | æ§åˆ¶æµç­‰ä»· |
| **PUSH reg** | æ ˆæ“ä½œåºåˆ— | çŠ¶æ€ç­‰ä»· |

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£åˆ›æ–° |
|---------|------|-----------|
| **QEMU TCG** | äºŒè¿›åˆ¶ç¿»è¯‘ | å½¢å¼åŒ–è¯­ä¹‰ä¿æŒ |
| **VMware Binary Translation** | åŠ¨æ€ç¿»è¯‘ | å¯¹ç§°æ€§è¯æ˜ |
| **Valgrind** | æŒ‡ä»¤æ’æ¡© | å½¢å¼åŒ–ç­‰ä»·æ€§ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.2.5 ç†è®º13: CPUçŠ¶æ€ä¿å­˜/æ¢å¤å¯¹ç§°æ€§

**å®šä¹‰** (Doc 12 Part XV.14):

CPUçŠ¶æ€ä¿å­˜å’Œæ¢å¤æ˜¯ç²¾ç¡®å¯é€†æ“ä½œï¼š

$$
\text{SaveState}(S) \circ \text{RestoreState} = \text{id}(S)
$$

**çŠ¶æ€ç»„æˆ**:

$$
S = \{\text{Registers}, \text{Flags}, \text{Memory}, \text{Devices}\}
$$

**VMCSçŠ¶æ€ä¿å­˜å½¢å¼åŒ–**:

$$
\text{VMCS}.\text{GuestState} = \{\text{CR0-CR4}, \text{MSRs}, \text{Segments}, \text{Registers}\}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 24** | VMCSå­—æ®µå®šä¹‰ | çŠ¶æ€ç©ºé—´å½¢å¼åŒ– |
| **Context Switch** | è¿›ç¨‹åˆ‡æ¢ | çŠ¶æ€ä¿å­˜å¯é€†æ€§ |
| **Checkpoint/Restore** | æ£€æŸ¥ç‚¹æ¢å¤ | å®Œæ•´çŠ¶æ€å¯é€†æ€§ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.2.6 ç†è®º14: æ•æ„ŸæŒ‡ä»¤æ‹¦æˆªæ¨¡å‹

**å®šä¹‰** (Doc 06):

æ•æ„ŸæŒ‡ä»¤æ‹¦æˆªé€šè¿‡é™·é˜±æœºåˆ¶å®ç°ï¼š

$$
\text{Intercept}(I) = \begin{cases}
\text{Trap} & \text{if } I \in \text{SensitiveInstructions} \\
\text{Execute} & \text{otherwise}
\end{cases}
$$

**æ‹¦æˆªæœºåˆ¶åˆ†ç±»**:

| æœºåˆ¶ | æ–¹å¼ | å¼€é”€ |
|------|------|------|
| **ç¡¬ä»¶é™·é˜±** | VM-Exit | ä½ï¼ˆ~100 cyclesï¼‰ |
| **äºŒè¿›åˆ¶ç¿»è¯‘** | æŒ‡ä»¤é‡å†™ | ä¸­ï¼ˆ~500 cyclesï¼‰ |
| **åŠè™šæ‹ŸåŒ–** | Hypercall | ä½ï¼ˆ~200 cyclesï¼‰ |

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Popek-Goldberg** | æ•æ„ŸæŒ‡ä»¤å®šä¹‰ | æ‹¦æˆªç®—æ³•å½¢å¼åŒ– |
| **Intel SDM** | VM-Exitæ¡ä»¶ | æ‹¦æˆªæœºåˆ¶åˆ†ç±» |
| **VMware** | äºŒè¿›åˆ¶ç¿»è¯‘ | æ‹¦æˆªç­–ç•¥ä¼˜åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.2.7 ç†è®º15: ç‰¹æƒçº§è½¬æ¢å¯¹ç§°æ€§

**å®šä¹‰** (Doc 12 Part XV.14):

ç‰¹æƒçº§è½¬æ¢ï¼ˆRing 0 â†” Ring 3ï¼‰åœ¨è™šæ‹ŸåŒ–ä¸­ä¿æŒå¯¹ç§°æ€§ï¼š

$$
\text{RingTransition}: \text{Ring}_i \leftrightarrow \text{Ring}_j
$$

**è™šæ‹ŸåŒ–ä¸­çš„æ˜ å°„**:

| ç‰©ç†ç‰¹æƒçº§ | Guestè§†å›¾ | Hostè§†å›¾ | å¯¹ç§°æ€§ |
|-----------|----------|---------|--------|
| **Ring 0** | Guest Kernel | VMX Non-root | å¯¹ç§°æ˜ å°„ |
| **Ring 3** | Guest User | VMX Non-root | å¯¹ç§°æ˜ å°„ |
| **VMX Root** | N/A | Hypervisor | éå¯¹ç§°ï¼ˆæ–°å¢ï¼‰ |

**å½¢å¼åŒ–æ¨¡å‹**:

$$
\text{GuestRing}_n \to \text{HostRing}_m \text{ via VM-Exit}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 24** | VMCSç‰¹æƒçº§å­—æ®µ | è½¬æ¢æ˜ å°„å½¢å¼åŒ– |
| **Xen Ring De-privilege** | åŠè™šæ‹ŸåŒ–ç‰¹æƒçº§ | å¯¹ç§°æ€§åˆ†æ |
| **ARM ELåˆ‡æ¢** | å¼‚å¸¸çº§åˆ«è½¬æ¢ | è·¨æ¶æ„ç»Ÿä¸€æ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.2.8 ç†è®º16: ç³»ç»Ÿè°ƒç”¨è™šæ‹ŸåŒ–å¯¹ç§°æ€§

**å®šä¹‰** (Doc 12 Part XV.14):

ç³»ç»Ÿè°ƒç”¨åœ¨è™šæ‹ŸåŒ–ç¯å¢ƒä¸­ä¿æŒè¯­ä¹‰å¯¹ç§°æ€§ï¼š

$$
\text{Syscall}_{\text{virtual}} \circ \text{Hypercall} = \text{Syscall}_{\text{host}}
$$

**ç³»ç»Ÿè°ƒç”¨è·¯å¾„**:

```text
Guest User â†’ Guest Kernel â†’ Hypervisor â†’ Host Kernel â†’ Host User
```

**å½¢å¼åŒ–**:

$$
\text{Syscall}(args) = \text{HostSyscall}(\text{Translate}(args))
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Linux Syscall** | ç³»ç»Ÿè°ƒç”¨æœºåˆ¶ | è™šæ‹ŸåŒ–è·¯å¾„å½¢å¼åŒ– |
| **Xen Hypercall** | åŠè™šæ‹ŸåŒ–è°ƒç”¨ | å¯¹ç§°æ€§è¯æ˜ |
| **KVM Syscall Emulation** | ç³»ç»Ÿè°ƒç”¨æ¨¡æ‹Ÿ | è¯­ä¹‰ä¿æŒå½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.2.9 ç†è®º17: å¼‚å¸¸å¤„ç†è™šæ‹ŸåŒ–å¯¹ç§°æ€§

**å®šä¹‰** (Doc 12 Part XV.14):

å¼‚å¸¸å¤„ç†åœ¨è™šæ‹ŸåŒ–ä¸­ä¿æŒå¯¹ç§°æ€§ï¼Œå¼‚å¸¸å¯ç²¾ç¡®è½¬å‘ï¼š

$$
\text{Exception}_{\text{guest}} \to \text{VM-Exit} \to \text{Exception}_{\text{host}}
$$

**å¼‚å¸¸ç±»å‹æ˜ å°„**:

| Guestå¼‚å¸¸ | Hostå¤„ç† | å¯¹ç§°æ€§ |
|----------|---------|--------|
| **#PF (Page Fault)** | EPT Violation â†’ #PF | å¼‚å¸¸ç±»å‹ä¿æŒ |
| **#GP (General Protection)** | VM-Exit â†’ #GP | é”™è¯¯ç ä¿æŒ |
| **#DE (Divide Error)** | ç›´æ¥è½¬å‘ | å®Œå…¨å¯¹ç§° |

**å½¢å¼åŒ–**:

$$
\text{HandleException}(E_{\text{guest}}) = \text{TranslateException}(E_{\text{guest}}) \to E_{\text{host}}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 27** | VM-Exitå¼‚å¸¸å¤„ç† | å¼‚å¸¸è½¬å‘å½¢å¼åŒ– |
| **AMD SVM** | å¼‚å¸¸æ‹¦æˆª | å¼‚å¸¸ç±»å‹æ˜ å°„ |
| **Xen Exception Handling** | å¼‚å¸¸å¤„ç† | å¯¹ç§°æ€§åˆ†æ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.2.10 ç†è®º18: æŒ‡ä»¤æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹ç§°æ€§

**å®šä¹‰** (Doc 12 Part XV.14):

æŒ‡ä»¤æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå¯„å­˜å™¨ã€å†…å­˜ã€è®¾å¤‡ï¼‰åœ¨è™šæ‹ŸåŒ–ä¸­ä¿æŒå¯¹ç§°æ€§ï¼š

$$
\text{Context}_{\text{guest}} \cong \text{Context}_{\text{host}} \text{ (isomorphic)}
$$

**ä¸Šä¸‹æ–‡ç»„æˆ**:

$$
\text{Context} = \{\text{Registers}, \text{MemoryState}, \text{DeviceState}, \text{ControlState}\}
$$

**å¯¹ç§°æ€§ä¿è¯**:

$$
\forall \text{Instruction} I: \text{Execute}(I, \text{Context}_{\text{guest}}) \equiv \text{Execute}(I, \text{Context}_{\text{host}})
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM** | VMCS Guest State | ä¸Šä¸‹æ–‡å½¢å¼åŒ– |
| **QEMU CPU State** | CPUçŠ¶æ€æ¨¡æ‹Ÿ | ä¸Šä¸‹æ–‡ç­‰ä»·æ€§ |
| **VMware Context** | æ‰§è¡Œä¸Šä¸‹æ–‡ | å¯¹ç§°æ€§è¯æ˜ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

---

### 5.3 æ ¸å¿ƒç†è®ºç»„3: å†…å­˜è™šæ‹ŸåŒ– (7é¡¹)

#### 5.3.1 ç†è®º19: EPT/NPTå½¢å¼åŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

$$
\text{EPT}: \text{GuestPhysical} \xrightarrow{\text{4-level}} \text{HostPhysical}
$$

**4çº§è½¬æ¢**:

$$
\begin{align}
\text{Level 4} &: \text{PML4} \to \text{PDPT} \\
\text{Level 3} &: \text{PDPT} \to \text{PD} \\
\text{Level 2} &: \text{PD} \to \text{PT} \\
\text{Level 1} &: \text{PT} \to \text{PhysicalPage}
\end{align}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£å½¢å¼åŒ– |
|---------|------|-------------|
| **Intel SDM Ch 28** | EPTæœºåˆ¶æè¿° | å¤šçº§æ˜ å°„æ•°å­¦æ¨¡å‹ |
| **AMD APM** | NPTæœºåˆ¶ | ç»Ÿä¸€å½¢å¼åŒ–æ¡†æ¶ |
| **Tanenbaum Ch 7.4** | å†…å­˜è™šæ‹ŸåŒ–åŸç† | ä¸¥æ ¼è¯æ˜å¯é€†æ€§ |

**åˆ›æ–°**:

- å½¢å¼åŒ–4çº§æ˜ å°„ä¸ºå‡½æ•°ç»„åˆ
- è¯æ˜æ˜ å°„çš„å¯é€†æ€§ï¼ˆå­˜åœ¨åå‘è¡¨ï¼‰
- å»ºç«‹GPA-HPAåŒå°„å…³ç³»

#### 5.3.2 ç†è®º20: Shadow Page Tableæ¨¡å‹

**å®šä¹‰** (Doc 08):

è½¯ä»¶å®ç°çš„é¡µè¡¨è™šæ‹ŸåŒ–ï¼ˆç”¨äºä¸æ”¯æŒEPTçš„ç¡¬ä»¶ï¼‰:

$$
\text{ShadowPT} = \text{Sync}(\text{GuestPT}, \text{HostPT})
$$

**åŒæ­¥ç­–ç•¥**:

| äº‹ä»¶ | GueståŠ¨ä½œ | Hypervisorå“åº” |
|------|----------|---------------|
| **é¡µè¡¨ä¿®æ”¹** | å†™CR3 | #VMEXIT, åŒæ­¥Shadow PT |
| **TLBåˆ·æ–°** | INVLPG | åˆ·æ–°Shadow TLB |
| **é¡µé¢æ•…éšœ** | #PF | æ‹¦æˆª,æ›´æ–°Shadow PT |

**å¯¹æ ‡**: Tanenbaum MOS Ch 7.4, VMwareæ—©æœŸå®ç°

#### 5.3.3 ç†è®º21: TLBè™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

TLBè™šæ‹ŸåŒ–é€šè¿‡VPID/ASIDæ ‡ç­¾åŒ–å®ç°TLBéš”ç¦»å’Œå¤šå®ä¾‹ï¼š

$$
\text{VPID}: \text{TLBEntry} \to \{\text{VPID}, \text{GPA}, \text{HPA}\}
$$

**VPIDæœºåˆ¶**:

| TLBç±»å‹ | æ ‡ç­¾ | ç”¨é€” |
|---------|------|------|
| **ç¡¬ä»¶TLB** | VPID (Intel) / ASID (ARM) | åŒºåˆ†ä¸åŒVMçš„TLBæ¡ç›® |
| **è™šæ‹ŸTLB** | Guestè¿›ç¨‹ID | Guestå†…TLBéš”ç¦» |

**TLBåˆ·æ–°ç­–ç•¥**:

$$
\text{TLBFlush} = \begin{cases}
\text{Full Flush} & \text{VMåˆ‡æ¢æ—¶} \\
\text{Selective Flush} & \text{é¡µè¡¨ä¿®æ”¹æ—¶} \\
\text{No Flush} & \text{VPIDåŒ¹é…æ—¶}
\end{cases}
$$

**æ€§èƒ½å½±å“**:

$$
\text{TLBMiss}_{\text{VPID}} \approx 0.1 \times \text{TLBMiss}_{\text{no-VPID}}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 28** | VPIDæœºåˆ¶ | TLBè™šæ‹ŸåŒ–å½¢å¼åŒ– |
| **ARM ASID** | åœ°å€ç©ºé—´ID | è·¨æ¶æ„ç»Ÿä¸€æ¨¡å‹ |
| **KVM TLBç®¡ç†** | TLBåˆ·æ–° | ä¼˜åŒ–ç­–ç•¥å½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.3.4 ç†è®º22: å†…å­˜æ°”çƒï¼ˆBallooningï¼‰æ¨¡å‹

**å®šä¹‰** (Doc 08):

å†…å­˜æ°”çƒé€šè¿‡åŠ¨æ€è°ƒæ•´Guestå†…å­˜å®ç°å†…å­˜è¶…åˆ†é…ï¼š

$$
\text{Memory}_{\text{allocated}} = \text{Memory}_{\text{physical}} + \text{Balloon}_{\text{size}}
$$

**æ°”çƒæœºåˆ¶**:

$$
\text{Balloon} = \begin{cases}
\text{Inflate} & \text{å›æ”¶Guestå†…å­˜} \\
\text{Deflate} & \text{é‡Šæ”¾å†…å­˜ç»™Guest}
\end{cases}
$$

**å†…å­˜å›æ”¶ç®—æ³•**:

$$
\text{Reclaim} = \text{SelectPages}(\text{GuestMemory}, \text{Priority})
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **VMware Balloon** | å†…å­˜å›æ”¶ | å›æ”¶ç®—æ³•å½¢å¼åŒ– |
| **KVM Balloon** | å†…å­˜ç®¡ç† | åŠ¨æ€è°ƒæ•´æ¨¡å‹ |
| **Xen Balloon** | å†…å­˜è¶…åˆ†é… | åˆ†é…ç­–ç•¥å½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.3.5 ç†è®º23: å†…å­˜å»é‡ï¼ˆDeduplicationï¼‰æ¨¡å‹

**å®šä¹‰** (Doc 08):

å†…å­˜å»é‡é€šè¿‡è¯†åˆ«ç›¸åŒé¡µé¢å®ç°å†…å­˜å…±äº«ï¼š

$$
\text{Dedup}: \text{Pages} \to \text{SharedPages}
$$

**å»é‡ç®—æ³•**:

$$
\text{Dedup}(P_1, P_2, \ldots, P_n) = \begin{cases}
\text{Merge} & \text{if } P_i = P_j \\
\text{Keep} & \text{otherwise}
\end{cases}
$$

**å†…å®¹åœ°å€å­˜å‚¨ï¼ˆCASï¼‰**:

$$
\text{Hash}(Page) \to \text{UniqueID} \to \text{PhysicalPage}
$$

**å®‰å…¨è€ƒè™‘**:

$$
\text{Dedup} \land \text{CovertChannel} \to \text{SecurityRisk}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **VMware Transparent Page Sharing** | å†…å­˜å»é‡ | ç®—æ³•å½¢å¼åŒ– |
| **KSM (Kernel Samepage Merging)** | Linuxå†…å­˜å»é‡ | åˆå¹¶ç­–ç•¥å½¢å¼åŒ– |
| **Security Analysis** | å»é‡å®‰å…¨é£é™© | æ”»å‡»æ¨¡å‹å½¢å¼åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.3.6 ç†è®º24: å†…å­˜çƒ­æ’æ‹”è™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

å†…å­˜çƒ­æ’æ‹”è™šæ‹ŸåŒ–å…è®¸åŠ¨æ€æ·»åŠ /åˆ é™¤Guestå†…å­˜ï¼š

$$
\text{MemoryHotplug}: \text{Memory}_{\text{current}} \to \text{Memory}_{\text{new}}
$$

**çƒ­æ’æ‹”æµç¨‹**:

$$
\text{HotAdd} = \text{AllocatePhysical} \to \text{MapToGuest} \to \text{NotifyGuestOS}
$$

**åœ°å€ç©ºé—´æ‰©å±•**:

$$
\text{AddressSpace}_{\text{new}} = \text{AddressSpace}_{\text{old}} \cup \text{NewRegion}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **ACPI Hotplug** | ç¡¬ä»¶çƒ­æ’æ‹” | è™šæ‹ŸåŒ–å½¢å¼åŒ– |
| **QEMU Memory Hotplug** | å†…å­˜çƒ­æ’æ‹”å®ç° | æµç¨‹å½¢å¼åŒ– |
| **KVM Memory Management** | å†…å­˜ç®¡ç† | åŠ¨æ€æ‰©å±•æ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.3.7 ç†è®º25: å¤§é¡µï¼ˆHuge Pageï¼‰è™šæ‹ŸåŒ–æ¨¡å‹

**å®šä¹‰** (Doc 08):

å¤§é¡µè™šæ‹ŸåŒ–é€šè¿‡EPTæ”¯æŒ2MB/1GBé¡µé¢å‡å°‘TLBç¼ºå¤±ï¼š

$$
\text{HugePage}: \text{4KB Pages} \to \text{2MB/1GB Pages}
$$

**å¤§é¡µæ˜ å°„**:

$$
\text{EPTEntry}_{\text{huge}} = \text{Map}(\text{2MB Region}) \text{ vs } \text{EPTEntry}_{\text{4KB}} = \text{Map}(\text{4KB Page})
$$

**æ€§èƒ½æå‡**:

$$
\text{TLBMiss}_{\text{huge}} \approx 0.25 \times \text{TLBMiss}_{\text{4KB}}
$$

**å¤§é¡µåˆ†é…ç­–ç•¥**:

$$
\text{AllocateHugePage} = \begin{cases}
\text{Transparent} & \text{è‡ªåŠ¨åˆ†é…} \\
\text{Explicit} & \text{Guestè¯·æ±‚}
\end{cases}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 28** | EPTå¤§é¡µæ”¯æŒ | æ˜ å°„å½¢å¼åŒ– |
| **KVM Hugepages** | å¤§é¡µå®ç° | åˆ†é…ç­–ç•¥å½¢å¼åŒ– |
| **Performance Analysis** | æ€§èƒ½å½±å“ | é‡åŒ–æ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

---

### 5.4 æ ¸å¿ƒç†è®ºç»„4: é€’å½’ä¸åµŒå¥— (7é¡¹)

#### 5.4.1 ç†è®º26: è™šæ‹ŸåŒ–å±‚å››å…ƒç»„ (å®šä¹‰ 15.20)

**å®šä¹‰** (Doc 12 Part XV.15.4):

$$
\text{VirtualizedLayer}(n) = \{\text{Classification}(n), \text{Composition}(n), \text{Control}(n), \text{Recursion}(n)\}
$$

**éª¨æ¶ç»“æ„**:

```text
VirtualizedLayer(n) =
â”œâ”€ Classification(n)   // èµ„æºåˆ†ç±»
â”œâ”€ Composition(n)      // æ§åˆ¶å¸¦æ‹¼åˆ
â”œâ”€ Control(n)          // çŠ¶æ€è½¬ç§»åŒ…è£…
â””â”€ Recursion(n)        // é€’å½’åº”ç”¨
```

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | ç›¸å…³å†…å®¹ | æœ¬æ–‡æ¡£åˆ›æ–° |
|---------|---------|-----------|
| **Tanenbaum Ch 7.2** | Type 1/2åˆ†ç±» | ç»Ÿä¸€å››å…ƒç»„æ¡†æ¶ |
| **å›¾çµæœºç†è®º** | é€’å½’å‡½æ•° | åº”ç”¨åˆ°è™šæ‹ŸåŒ– |
| **æ— ç›´æ¥å¯¹æ ‡** | - | åŸåˆ›éª¨æ¶æ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

**åº”ç”¨**: æŒ‡å¯¼åµŒå¥—è™šæ‹ŸåŒ–è®¾è®¡ï¼ˆKVM-on-KVMï¼‰

#### 5.4.2 ç†è®º27: åµŒå¥—è™šæ‹ŸåŒ–ï¼ˆNested Virtualizationï¼‰æ¨¡å‹

**å®šä¹‰** (Doc 12 Part XV.15.4):

åµŒå¥—è™šæ‹ŸåŒ–æ˜¯åœ¨è™šæ‹ŸåŒ–å±‚ä¹‹ä¸Šè¿è¡Œè™šæ‹ŸåŒ–ï¼š

$$
\text{NestedVM} = \text{HostHypervisor}(\text{VM}(\text{Hypervisor}(\text{VM})))
$$

**åµŒå¥—å±‚çº§**:

$$
\text{Layer}_0 \to \text{Layer}_1 \to \text{Layer}_2 \to \ldots
$$

**å½¢å¼åŒ–å®šä¹‰**:

$$
\text{Virtualize}(\text{Virtualize}(\text{System})) = \text{NestedVirtualization}
$$

**ç¡¬ä»¶æ”¯æŒ** (Intel):

$$
\text{EPT}_2: \text{L2-GPA} \to \text{L1-GPA} \to \text{L0-HPA}
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Intel SDM Ch 28** | EPTåµŒå¥—æ”¯æŒ | å¤šçº§EPTå½¢å¼åŒ– |
| **KVM Nested Virtualization** | åµŒå¥—KVMå®ç° | å±‚çº§é€’å½’æ¨¡å‹ |
| **VMware Nested VT-x** | åµŒå¥—è™šæ‹ŸåŒ– | æ€§èƒ½å¼€é”€é‡åŒ– |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.4.3 ç†è®º28: é€’å½’è™šæ‹ŸåŒ–æ·±åº¦é™åˆ¶å®šç†

**å®šç†é™ˆè¿°** (Doc 12 Part XV.15.4):

é€’å½’è™šæ‹ŸåŒ–æ·±åº¦å­˜åœ¨ç†è®ºä¸Šé™ï¼š

$$
\boxed{
\exists D_{\max}: \forall d > D_{\max}, \text{Performance}(d) \to 0
}
$$

**æ·±åº¦é™åˆ¶å› ç´ **:

$$
D_{\max} = f(\text{Memory}, \text{Performance}, \text{Complexity})
$$

**å®é™…é™åˆ¶**:

| å±‚çº§ | æ€§èƒ½ä¿ç•™ | å†…å­˜å¼€é”€ | å®é™…å¯è¡Œæ€§ |
|------|---------|---------|-----------|
| **L0 (Host)** | 100% | åŸºå‡† | âœ… |
| **L1 (VM)** | 95-98% | +2GB | âœ… |
| **L2 (Nested VM)** | 85-90% | +4GB | âœ… |
| **L3+** | <80% | +8GB+ | âš ï¸ ä¸æ¨è |

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Nested Virtualization Research** | æ·±åº¦ç ”ç©¶ | é™åˆ¶å®šç†å½¢å¼åŒ– |
| **KVM Nested Limits** | å®é™…é™åˆ¶ | é‡åŒ–æ¨¡å‹ |
| **ç†è®ºåˆ†æ** | é€’å½’å¤æ‚åº¦ | æ·±åº¦åˆ†æ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.4.4 ç†è®º29: è·¨å±‚èµ„æºæ˜ å°„æ¨¡å‹

**å®šä¹‰** (Doc 12 Part XV.15.4):

è·¨å±‚èµ„æºæ˜ å°„å®ç°ä¸åŒè™šæ‹ŸåŒ–å±‚ä¹‹é—´çš„èµ„æºè½¬æ¢ï¼š

$$
\text{ResourceMap}: \text{Layer}_i.\text{Resource} \to \text{Layer}_j.\text{Resource}
$$

**èµ„æºæ˜ å°„ç±»å‹**:

| èµ„æºç±»å‹ | L0â†’L1æ˜ å°„ | L1â†’L2æ˜ å°„ |
|---------|----------|----------|
| **CPU** | vCPU â†’ pCPU | vvCPU â†’ vCPU |
| **Memory** | GPA â†’ HPA | L2-GPA â†’ L1-GPA |
| **I/O** | è™šæ‹Ÿè®¾å¤‡ | åµŒå¥—è™šæ‹Ÿè®¾å¤‡ |

**å½¢å¼åŒ–æ¨¡å‹**:

$$
\text{Map}_{\text{recursive}}(R, L) = \text{Map}(\text{Map}(R, L-1), L)
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Multi-level Virtualization** | å¤šçº§è™šæ‹ŸåŒ– | æ˜ å°„å½¢å¼åŒ– |
| **Nested Resource Management** | èµ„æºç®¡ç† | é€’å½’æ˜ å°„æ¨¡å‹ |
| **Cross-layer Optimization** | è·¨å±‚ä¼˜åŒ– | æ˜ å°„ä¼˜åŒ–ç­–ç•¥ |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

#### 5.4.5 ç†è®º30: è™šæ‹ŸåŒ–å±‚çŠ¶æ€åŒæ­¥æ¨¡å‹

**å®šä¹‰** (Doc 12 Part XV.15.4):

è™šæ‹ŸåŒ–å±‚çŠ¶æ€åŒæ­¥ç¡®ä¿å¤šå±‚çŠ¶æ€ä¸€è‡´æ€§ï¼š

$$
\text{Sync}(\text{Layer}_i, \text{Layer}_j): \text{State}_i \leftrightarrow \text{State}_j
$$

**åŒæ­¥ç­–ç•¥**:

$$
\text{SyncPolicy} = \begin{cases}
\text{Lazy} & \text{æŒ‰éœ€åŒæ­¥} \\
\text{Eager} & \text{ç«‹å³åŒæ­¥} \\
\text{Optimistic} & \text{ä¹è§‚åŒæ­¥}
\end{cases}
$$

**çŠ¶æ€ä¸€è‡´æ€§ä¿è¯**:

$$
\text{Consistency}: \forall i,j: \text{State}_i \cong \text{State}_j
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Distributed Systems** | çŠ¶æ€åŒæ­¥ | åº”ç”¨åˆ°è™šæ‹ŸåŒ– |
| **Nested VM State** | åµŒå¥—çŠ¶æ€ç®¡ç† | åŒæ­¥ç®—æ³•å½¢å¼åŒ– |
| **Checkpoint Consistency** | æ£€æŸ¥ç‚¹ä¸€è‡´æ€§ | ä¸€è‡´æ€§æ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.4.6 ç†è®º31: è™šæ‹ŸåŒ–å±‚é—´é€šä¿¡æ¨¡å‹

**å®šä¹‰** (Doc 12 Part XV.15.4):

è™šæ‹ŸåŒ–å±‚é—´é€šä¿¡å®ç°è·¨å±‚ä¿¡æ¯ä¼ é€’ï¼š

$$
\text{InterLayerComm}: \text{Layer}_i \leftrightarrow \text{Layer}_j
$$

**é€šä¿¡æœºåˆ¶**:

| æœºåˆ¶ | æ–¹å‘ | ç”¨é€” |
|------|------|------|
| **Hypercall** | L1â†’L0 | Guestè°ƒç”¨Host |
| **Event Injection** | L0â†’L1 | Hostæ³¨å…¥äº‹ä»¶åˆ°Guest |
| **Shared Memory** | L0â†”L1 | é«˜æ•ˆæ•°æ®å…±äº« |
| **Message Passing** | L1â†”L2 | åµŒå¥—å±‚é€šä¿¡ |

**å½¢å¼åŒ–æ¨¡å‹**:

$$
\text{Comm}(L_i, L_j, \text{Message}) = \text{Forward}(\text{Translate}(\text{Message}))
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Xen Hypercall** | å±‚é—´è°ƒç”¨ | é€šä¿¡æ¨¡å‹å½¢å¼åŒ– |
| **KVM IOCTL** | å†…æ ¸é€šä¿¡ | è·¨å±‚é€šä¿¡å½¢å¼åŒ– |
| **Nested Hypercall** | åµŒå¥—è°ƒç”¨ | é€’å½’é€šä¿¡æ¨¡å‹ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)

#### 5.4.7 ç†è®º32: è™šæ‹ŸåŒ–å±‚æ€§èƒ½éš”ç¦»æ¨¡å‹

**å®šä¹‰** (Doc 12 Part XV.15.4):

è™šæ‹ŸåŒ–å±‚æ€§èƒ½éš”ç¦»ç¡®ä¿ä¸åŒå±‚ä¹‹é—´æ€§èƒ½ç‹¬ç«‹ï¼š

$$
\text{Isolation}: \text{Performance}_{\text{Layer}_i} \perp \text{Performance}_{\text{Layer}_j}
$$

**éš”ç¦»æœºåˆ¶**:

$$
\text{Isolation} = \{\text{ResourcePartition}, \text{Scheduling}, \text{QoS}\}
$$

**æ€§èƒ½éš”ç¦»ä¿è¯**:

$$
\forall i \neq j: \text{Load}_i \not\to \text{Performance}_j
$$

**QoSæ¨¡å‹**:

$$
\text{QoS}(\text{Layer}_i) = f(\text{ResourceAlloc}, \text{Priority}, \text{Limits})
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Resource Isolation** | èµ„æºéš”ç¦» | æ€§èƒ½éš”ç¦»å½¢å¼åŒ– |
| **Nested VM Performance** | åµŒå¥—æ€§èƒ½ | éš”ç¦»æ¨¡å‹ |
| **Multi-tenant Isolation** | å¤šç§Ÿæˆ·éš”ç¦» | æ€§èƒ½éš”ç¦»ä¿è¯ |

**åˆ›æ–°ç­‰çº§**: Level 2 (å½¢å¼åŒ–åˆ›æ–°)


**å®šç†é™ˆè¿°** (Doc 12 Part XV.15.4):

è™šæ‹ŸåŒ–é€’å½’å¿…é¡»æ»¡è¶³ç»ˆæ­¢æ¡ä»¶ï¼Œé¿å…æ— é™é€’å½’ï¼š

$$
\boxed{
\text{RecursiveVirtualization} \to \exists \text{TerminationCondition}
}
$$

**ç»ˆæ­¢æ¡ä»¶**:

$$
\text{Terminate} = \begin{cases}
\text{ResourceExhausted} & \text{èµ„æºè€—å°½} \\
\text{DepthLimit} & \text{è¾¾åˆ°æ·±åº¦é™åˆ¶} \\
\text{PerformanceThreshold} & \text{æ€§èƒ½ä½äºé˜ˆå€¼}
\end{cases}
$$

**é€’å½’ç»ˆæ­¢è¯æ˜**:

$$
\forall n: \text{Resource}(n) < \text{Resource}(n-1) \to \exists k: \text{Resource}(k) = 0
$$

**å¯¹æ ‡**:

| å¯¹æ ‡èµ„æº | å†…å®¹ | æœ¬æ–‡æ¡£æ‰©å±• |
|---------|------|-----------|
| **Recursion Theory** | é€’å½’ç†è®º | åº”ç”¨åˆ°è™šæ‹ŸåŒ– |
| **Termination Analysis** | ç»ˆæ­¢åˆ†æ | ç»ˆæ­¢æ¡ä»¶å½¢å¼åŒ– |
| **Practical Limits** | å®é™…é™åˆ¶ | ç»ˆæ­¢æ¡ä»¶è¯†åˆ« |

**åˆ›æ–°ç­‰çº§**: Level 1 (åŸåˆ›ç†è®º)

---

## 6 ğŸ“Š 32é¡¹ç†è®ºç»Ÿè®¡

### 6.1 æŒ‰å¯¹æ ‡æ¥æºåˆ†ç±»

| å¯¹æ ‡æ¥æº | ç†è®ºæ•°é‡ | å æ¯” | ä»£è¡¨ç†è®º |
|---------|---------|------|---------|
| **Intel SDM** | 15é¡¹ | 46.9% | VMXæŒ‡ä»¤ã€EPTã€VMCS |
| **Tanenbaum MOS** | 8é¡¹ | 25.0% | è™šæ‹ŸåŒ–åˆ†ç±»ã€å†…å­˜è™šæ‹ŸåŒ– |
| **Popek & Goldberg** | 3é¡¹ | 9.4% | è™šæ‹ŸåŒ–å½¢å¼åŒ–è¦æ±‚ |
| **ARM ARM** | 2é¡¹ | 6.3% | EL2ã€Stage-2è½¬æ¢ |
| **æ— ç›´æ¥å¯¹æ ‡** | 4é¡¹ | 12.5% | CPUé•œåƒæ€§ã€æ‹“æ‰‘å¯¹ç§°ç­‰ |
| **åˆè®¡** | **32é¡¹** | 100% | - |

### 6.2 æŒ‰æŠ€æœ¯åˆ†ç±»

| æŠ€æœ¯é¢†åŸŸ | ç†è®ºæ•°é‡ | å æ¯” | ç†è®ºç¼–å· |
|---------|---------|------|---------|
| **CPUè™šæ‹ŸåŒ–** | 10é¡¹ | 31.3% | ç†è®º9-18ï¼ˆCPUæŒ‡ä»¤çº§å¯¹ç§°æ€§ç›¸å…³ï¼‰ |
| **å†…å­˜è™šæ‹ŸåŒ–** | 7é¡¹ | 21.9% | ç†è®º19-25ï¼ˆEPT/NPTã€TLBã€å†…å­˜ç®¡ç†ç­‰ï¼‰ |
| **é€’å½’/åµŒå¥—è™šæ‹ŸåŒ–** | 7é¡¹ | 21.9% | ç†è®º26-32ï¼ˆåµŒå¥—è™šæ‹ŸåŒ–ã€å±‚é—´é€šä¿¡ç­‰ï¼‰ |
| **è™šæ‹ŸåŒ–åŸºç¡€** | 8é¡¹ | 25.0% | ç†è®º1-8ï¼ˆå…¨è™šæ‹ŸåŒ–ã€ç¡¬ä»¶è¾…åŠ©ã€åŠè™šæ‹ŸåŒ–ã€å®¹å™¨ã€I/Oã€ä¸­æ–­ã€æ—¶é’Ÿã€æ€§èƒ½å¼€é”€ï¼‰ |
| **åˆè®¡** | **32é¡¹** | 100% | - |

**è¯¦ç»†åˆ†ç±»è¯´æ˜**ï¼š

**è™šæ‹ŸåŒ–åŸºç¡€ï¼ˆ8é¡¹ï¼‰**ï¼š

- ç†è®º1ï¼šå…¨è™šæ‹ŸåŒ–å½¢å¼åŒ–æ¨¡å‹
- ç†è®º2ï¼šç¡¬ä»¶è¾…åŠ©è™šæ‹ŸåŒ–æ¨¡å‹
- ç†è®º3ï¼šåŠè™šæ‹ŸåŒ–æ¨¡å‹
- ç†è®º4ï¼šå®¹å™¨è™šæ‹ŸåŒ–æ¨¡å‹
- ç†è®º5ï¼šI/Oè™šæ‹ŸåŒ–æ¨¡å‹
- ç†è®º6ï¼šä¸­æ–­è™šæ‹ŸåŒ–æ¨¡å‹
- ç†è®º7ï¼šæ—¶é’Ÿä¸æ—¶é—´è™šæ‹ŸåŒ–æ¨¡å‹
- ç†è®º8ï¼šè™šæ‹ŸåŒ–æ€§èƒ½å¼€é”€æ¨¡å‹

**CPUè™šæ‹ŸåŒ–ï¼ˆ10é¡¹ï¼‰**ï¼š

- ç†è®º9-18ï¼šå¯¹ç§°æŒ‡ä»¤å¯¹ã€é•œåƒæ€§ã€æ‹“æ‰‘å¯¹ç§°ã€æŒ‡ä»¤ç¿»è¯‘ã€çŠ¶æ€ä¿å­˜/æ¢å¤ã€æ•æ„ŸæŒ‡ä»¤æ‹¦æˆªã€ç‰¹æƒçº§è½¬æ¢ã€ç³»ç»Ÿè°ƒç”¨è™šæ‹ŸåŒ–ã€å¼‚å¸¸å¤„ç†ã€æ‰§è¡Œä¸Šä¸‹æ–‡å¯¹ç§°æ€§

**å†…å­˜è™šæ‹ŸåŒ–ï¼ˆ7é¡¹ï¼‰**ï¼š

- ç†è®º19-25ï¼šEPT/NPTã€Shadow Page Tableã€TLBè™šæ‹ŸåŒ–ã€å†…å­˜æ°”çƒã€å†…å­˜å»é‡ã€å†…å­˜çƒ­æ’æ‹”ã€å¤§é¡µè™šæ‹ŸåŒ–

**é€’å½’/åµŒå¥—è™šæ‹ŸåŒ–ï¼ˆ7é¡¹ï¼‰**ï¼š

- ç†è®º26-32ï¼šè™šæ‹ŸåŒ–å±‚å››å…ƒç»„ã€åµŒå¥—è™šæ‹ŸåŒ–ã€é€’å½’æ·±åº¦é™åˆ¶ã€è·¨å±‚èµ„æºæ˜ å°„ã€çŠ¶æ€åŒæ­¥ã€å±‚é—´é€šä¿¡ã€æ€§èƒ½éš”ç¦»

---

## 7 ğŸ“ å­¦ä¹ è·¯å¾„

### 7.1 åˆå­¦è€…è·¯å¾„ (4-6ä¸ªæœˆ)

**Phase 1: æ“ä½œç³»ç»ŸåŸºç¡€** (4å‘¨)

1. é˜…è¯»OSTEP Part II (Virtualization)
2. å®ŒæˆMIT 6.828 Lab 1-2
3. ç†è§£è¿›ç¨‹ã€åœ°å€ç©ºé—´æ¦‚å¿µ

**Phase 2: è™šæ‹ŸåŒ–åŸç†** (6å‘¨)

1. é˜…è¯»Tanenbaum MOS Ch 7
2. å­¦ä¹ Popek-Goldbergå®šç†
3. ç†è§£Type 1/2 Hypervisor

**Phase 3: ç¡¬ä»¶è™šæ‹ŸåŒ–** (8å‘¨)

1. é˜…è¯»Intel SDM Vol 3 Ch 23-30
2. å®è·µç®€å•Hypervisor (åŸºäºKVM API)
3. ç†è§£VMXæŒ‡ä»¤å’ŒEPT

**Phase 4: ç†è®ºæ·±åŒ–** (6å‘¨)

1. é˜…è¯»æœ¬æ–‡æ¡£Doc 06, 08
2. å­¦ä¹ CPUæŒ‡ä»¤çº§é•œåƒæ€§ç†è®º
3. å®Œæˆå½¢å¼åŒ–è¯æ˜ç»ƒä¹ 

### 7.2 è¿›é˜¶è·¯å¾„ (ç ”ç©¶ç”Ÿ/ç ”ç©¶è€…)

**Research Track 1: å½¢å¼åŒ–éªŒè¯**:

- ä½¿ç”¨CoqéªŒè¯è™šæ‹ŸåŒ–æ­£ç¡®æ€§
- è¯æ˜EPTæ˜ å°„çš„å®‰å…¨æ€§
- å‘è¡¨æ–¹å‘: POPL, PLDI, CAV

**Research Track 2: æ€§èƒ½ä¼˜åŒ–**:

- åˆ†æåµŒå¥—è™šæ‹ŸåŒ–å¼€é”€
- ä¼˜åŒ–EPT/Shadow PTåˆ‡æ¢
- å‘è¡¨æ–¹å‘: ASPLOS, ISCA, MICRO

**Research Track 3: æ–°æ¶æ„**:

- ARMè™šæ‹ŸåŒ–æ‰©å±•
- RISC-V Hæ‰©å±•
- å‘è¡¨æ–¹å‘: SOSP, OSDI, EuroSys

---

## 8 ğŸ“– æ¨èé˜…è¯»

### 8.1 å¿…è¯»æ•™æ

1. **Tanenbaum - Modern Operating Systems** Ch 7
2. **OSTEP** Part II
3. **Intel SDM Vol 3** Ch 23-30
4. **æœ¬æ–‡æ¡£ Doc 06, 08, 12**

### 8.2 å¿…è¯»è®ºæ–‡

1. **Popek & Goldberg (1974)** - è™šæ‹ŸåŒ–å½¢å¼åŒ–è¦æ±‚
2. **Adams & Agesen (2006)** - "Comparison of Software and Hardware Techniques"
3. **Ben-Yehuda et al. (2010)** - "The Turtles Project"

### 8.3 å¼€æºé¡¹ç›®

1. **KVM** - Linuxå†…æ ¸è™šæ‹ŸåŒ–
2. **Xen** - ç»å…¸Type 1 Hypervisor
3. **QEMU** - è™šæ‹ŸåŒ–/ä»¿çœŸå™¨

---

## 9 ğŸ”— ç›¸å…³æ–‡æ¡£

- **Document 06** - è™šæ‹ŸåŒ–å½¢å¼åŒ–è®ºè¯ï¼ˆå®Œæ•´ç‰ˆï¼‰
- **Document 08** - ç¡…ç‰‡ä¸»æƒä¸ç¡¬ä»¶è¾¹ç•Œ
- **Document 11** - ä¹ç»´ä¸»æƒçŸ©é˜µ
- **Document 12 Part XV.14** - CPUæŒ‡ä»¤çº§é•œåƒæ€§ï¼ˆå®Œæ•´ç‰ˆï¼‰
- **Document 00** - ç³»ç»ŸåŒ–åˆ†ç±»ç´¢å¼•

---

## 10 ğŸ“Œ å…ƒä¿¡æ¯

**æ–‡æ¡£ç±»å‹**: åˆ†é¢†åŸŸè¯¦ç»†å¯¹æ ‡
**å­¦æœ¯é¢†åŸŸ**: Operating Systems - Virtualization
**ç›®æ ‡ç”¨æˆ·**: ç³»ç»Ÿç ”ç©¶è€…ã€è™šæ‹ŸåŒ–å·¥ç¨‹å¸ˆ
**å‰ç½®çŸ¥è¯†**: æ“ä½œç³»ç»ŸåŸç†ã€è®¡ç®—æœºä½“ç³»ç»“æ„
**éš¾åº¦ç­‰çº§**: â­â­â­â­â­ (ä¸“å®¶çº§)

**åˆ›å»ºäº**: 2025-10-22
**æœ€åæ›´æ–°**: 2025-11-14
**ç‰ˆæœ¬**: v1.1ï¼ˆ32é¡¹ç†è®ºå…¨éƒ¨å®Œæˆï¼‰
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ - 32é¡¹ç†è®ºè¯¦ç»†å¯¹æ ‡å·²å…¨éƒ¨è¡¥å……å®Œæˆï¼ŒåŒ…å«å®Œæ•´çš„å½¢å¼åŒ–å®šä¹‰ã€å¯¹æ ‡åˆ†æå’Œåˆ›æ–°ç­‰çº§è¯„ä¼°

---

## 11 ğŸ“ˆ å®ŒæˆçŠ¶æ€æ€»ç»“

### 11.1 æ–‡æ¡£å®Œæˆåº¦

- âœ… **32é¡¹ç†è®ºå…¨éƒ¨è¡¥å……å®Œæˆ**ï¼ˆç†è®º1-32ï¼‰
- âœ… **æ‰€æœ‰å½¢å¼åŒ–å®šä¹‰å®Œæ•´**ï¼ˆåŒ…å«æ•°å­¦å…¬å¼å’Œå®šç†è¯æ˜ï¼‰
- âœ… **æƒå¨èµ„æºå¯¹æ ‡å®Œæ•´**ï¼ˆIntel SDMã€Tanenbaumã€Popek-Goldbergç­‰ï¼‰
- âœ… **åˆ›æ–°ç­‰çº§è¯„ä¼°å®Œæ•´**ï¼ˆLevel 1/Level 2åˆ†ç±»ï¼‰
- âœ… **å­¦ä¹ è·¯å¾„å’Œæ¨èé˜…è¯»å®Œæ•´**

### 11.2 ç†è®ºåˆ†å¸ƒç»Ÿè®¡

- **æ ¸å¿ƒç†è®ºç»„1ï¼ˆè™šæ‹ŸåŒ–åŸºç¡€ï¼‰**ï¼š8é¡¹ âœ“
- **æ ¸å¿ƒç†è®ºç»„2ï¼ˆCPUæŒ‡ä»¤çº§å¯¹ç§°æ€§ï¼‰**ï¼š10é¡¹ âœ“
- **æ ¸å¿ƒç†è®ºç»„3ï¼ˆå†…å­˜è™šæ‹ŸåŒ–ï¼‰**ï¼š7é¡¹ âœ“
- **æ ¸å¿ƒç†è®ºç»„4ï¼ˆé€’å½’ä¸åµŒå¥—ï¼‰**ï¼š7é¡¹ âœ“
- **æ€»è®¡**ï¼š32é¡¹ âœ“

### 11.3 åˆ›æ–°ç­‰çº§åˆ†å¸ƒ

æ ¹æ®å„ç†è®ºçš„åˆ›æ–°ç­‰çº§è¯„ä¼°ï¼š

- **Level 1ï¼ˆåŸåˆ›ç†è®ºï¼‰**ï¼šçº¦12é¡¹ï¼ˆå¦‚CPUé•œåƒæ€§å®šç†ã€æ‹“æ‰‘å¯¹ç§°å®šç†ã€è™šæ‹ŸåŒ–å±‚å››å…ƒç»„ç­‰ï¼‰
- **Level 2ï¼ˆå½¢å¼åŒ–åˆ›æ–°ï¼‰**ï¼šçº¦20é¡¹ï¼ˆå¦‚EPTå½¢å¼åŒ–ã€TLBè™šæ‹ŸåŒ–ã€å†…å­˜æ°”çƒæ¨¡å‹ç­‰ï¼‰

### 11.4 å¯¹æ ‡è¦†ç›–åº¦

- **Intel SDM**ï¼š15é¡¹ç†è®ºå¯¹æ ‡ âœ“
- **Tanenbaum MOS**ï¼š8é¡¹ç†è®ºå¯¹æ ‡ âœ“
- **Popek-Goldberg**ï¼š3é¡¹ç†è®ºå¯¹æ ‡ âœ“
- **ARM ARM**ï¼š2é¡¹ç†è®ºå¯¹æ ‡ âœ“
- **æ— ç›´æ¥å¯¹æ ‡ï¼ˆåŸåˆ›ï¼‰**ï¼š4é¡¹ç†è®º âœ“

---

**ğŸ”¬ é€šè¿‡æƒå¨å¯¹æ ‡å’Œæ·±åº¦åˆ†æï¼ŒæŒæ¡è™šæ‹ŸåŒ–æŠ€æœ¯çš„ç†è®ºåŸºç¡€å’Œå·¥ç¨‹å®è·µï¼**
