# 5.5 区块链智能合约 (Blockchain Smart Contracts)

## 目录

- [5.5 区块链智能合约 (Blockchain Smart Contracts)](#55-区块链智能合约-blockchain-smart-contracts)
  - [目录](#目录)
  - [核心命题](#核心命题)
  - [技术优势](#技术优势)
    - [确定性保证](#确定性保证)
    - [性能优势](#性能优势)
  - [主流平台](#主流平台)
    - [EOSIO](#eosio)
    - [NEAR Protocol](#near-protocol)
    - [Polkadot（Substrate）](#polkadotsubstrate)
  - [燃料计量](#燃料计量)
    - [Gas 模型](#gas-模型)
    - [防止攻击](#防止攻击)
  - [批判性分析](#批判性分析)
  - [参考文献](#参考文献)

## 核心命题

**确定性执行定理**：
\[
\forall \text{Node}_i, \text{Node}_j : \text{Exec}(\text{Contract}, \text{Input}) = \text{Result} \quad \text{（一致）}
\]

**燃料计量**：
\[
\text{Gas} = \sum_{i} \text{Cost}(\text{Instr}_i)
\]

**沙箱安全**：
\[
\text{Contract} \not\rightarrow \text{System-Access}
\]

---

## 技术优势

### 确定性保证

**浮点严格性**：
\[
\forall x, y : \texttt{f32.add}(x, y) = \text{IEEE-754}(x, y) \quad \text{（跨平台一致）}
\]

**无未定义行为**：

- 整数溢出：环绕语义
- 除零：陷阱
- 越界访问：陷阱

### 性能优势

**对比 EVM**：

| 指标 | EVM | Wasm |
|------|-----|------|
| **吞吐** | 20-50 TPS | 5000-10000 TPS |
| **Gas 成本** | 高 | 低（~10×） |
| **编译** | JIT | AOT |

**实测（NEAR Protocol）**：

- 简单转账：0.3ms
- 复杂合约：5-10ms
- Gas 效率：10× vs EVM

---

## 主流平台

### EOSIO

**特点**：

- C++ → Wasm
- 账户模型
- 委托权益证明（DPoS）

**合约示例**：

```cpp
#include <eosio/eosio.hpp>

class [[eosio::contract]] token : public eosio::contract {
public:
    using contract::contract;

    [[eosio::action]]
    void transfer(eosio::name from, eosio::name to, uint64_t quantity) {
        // 验证权限
        require_auth(from);

        // 余额检查
        auto from_balance = balances.find(from.value);
        eosio_assert(from_balance != balances.end(), "no balance");
        eosio_assert(from_balance->amount >= quantity, "insufficient");

        // 转账
        balances.modify(from_balance, from, [&](auto& b) {
            b.amount -= quantity;
        });
        // ...
    }
};
```

### NEAR Protocol

**特点**：

- Rust → Wasm
- 分片架构
- 异步跨合约调用

**合约示例**：

```rust
use near_sdk::{near_bindgen, env};
use near_sdk::collections::LookupMap;

#[near_bindgen]
#[derive(Default, BorshDeserialize, BorshSerialize)]
pub struct Token {
    balances: LookupMap<AccountId, Balance>,
}

#[near_bindgen]
impl Token {
    pub fn transfer(&mut self, to: AccountId, amount: Balance) {
        let from = env::predecessor_account_id();

        let from_balance = self.balances.get(&from).unwrap();
        assert!(from_balance >= amount, "Insufficient balance");

        self.balances.insert(&from, &(from_balance - amount));
        let to_balance = self.balances.get(&to).unwrap_or(0);
        self.balances.insert(&to, &(to_balance + amount));
    }
}
```

### Polkadot（Substrate）

**特点**：

- 多链架构
- 自定义运行时
- Wasm 元协议

**Runtime 模块**：

```rust
#[pallet::call]
impl<T: Config> Pallet<T> {
    #[pallet::weight(10_000)]
    pub fn do_something(origin: OriginFor<T>, value: u32) -> DispatchResult {
        let who = ensure_signed(origin)?;

        // 业务逻辑
        <Something<T>>::put(value);

        Self::deposit_event(Event::SomethingStored(value, who));
        Ok(())
    }
}
```

---

## 燃料计量

### Gas 模型

**指令成本**：
\[
\begin{align*}
\text{Cost}(\texttt{i32.add}) &= 1 \\
\text{Cost}(\texttt{i32.mul}) &= 3 \\
\text{Cost}(\texttt{memory.grow}) &= 100 \times \text{pages}
\end{align*}
\]

**合约执行**：

```rust
fn execute_contract(code: &[u8], gas_limit: u64) -> Result<Output, Error> {
    let mut gas_counter = gas_limit;

    for instr in decode(code) {
        let cost = gas_cost(instr);
        if gas_counter < cost {
            return Err(Error::OutOfGas);
        }
        gas_counter -= cost;

        execute_instr(instr)?;
    }

    Ok(output)
}
```

### 防止攻击

**无限循环防御**：

```wasm
(loop $infinite
  ;; 每次迭代消耗 Gas
  call $charge_gas
  br $infinite  ;; 最终会耗尽 Gas
)
```

**存储炸弹防御**：
\[
\text{Cost}(\text{storage}) \propto \text{Size}(\text{data})
\]

---

## 批判性分析

**命题**：
\[
\text{Wasm-Blockchain} = \text{性能} + \text{确定性} - \text{生态}
\]

**优势**：

- 比 EVM 快 100×
- 多语言支持
- 形式化验证友好

**劣势**：

- 生态不成熟
- 开发工具少
- 审计经验不足

**批判**：
> Wasm 在区块链领域是"技术优越但生态落后"。以太坊的网络效应是护城河——Solidity 的技术债务反而成了竞争壁垒。

---

## 参考文献

1. **[EOSIO]** "EOSIO Wasm." https://developers.eos.io/
2. **[NEAR]** "NEAR Protocol Docs." https://docs.near.org/
3. **[Polkadot]** "Substrate Runtime." https://substrate.io/

---

**结论**：
> Wasm 是智能合约的"理想虚拟机"：确定性、安全性、性能三者兼得。但区块链领域成功的决定因素不是技术，而是生态与用户。NEAR、Polkadot 等新链选择 Wasm，是对未来的投注——赌的是 10 年后的格局，而非今天的市场份额。
