# WebAssembly 架构概览

**版本**：1.0.0
**最后更新**：2025-10-30
**目标受众**：架构师、系统设计师

---

## 概述

本文档从架构视角概览 WebAssembly 的整体设计，包括抽象层级、关键组件、交互模式和设计决策。

---

## 📐 抽象层级视图

```text
┌────────────────────────────────────────────────────────────┐
│                      应用层                                 │
│  (Web App, Serverless Function, Smart Contract, Plugin)   │
└────────────────────────────────────────────────────────────┘
                            ↓ 编译
┌────────────────────────────────────────────────────────────┐
│                    源语言层                                 │
│      (Rust, C/C++, AssemblyScript, Go, C#, ...)           │
└────────────────────────────────────────────────────────────┘
                            ↓ 编译器前端
┌────────────────────────────────────────────────────────────┐
│                   WebAssembly IR                           │
│             (抽象语法树 / 中间表示)                         │
└────────────────────────────────────────────────────────────┘
                            ↓ 序列化
┌────────────────────────────────────────────────────────────┐
│               WebAssembly 二进制格式 (.wasm)                │
│              (模块 = Sections 集合)                         │
└────────────────────────────────────────────────────────────┘
                            ↓ 加载 & 验证
┌────────────────────────────────────────────────────────────┐
│                   运行时层                                  │
│  ┌──────────┬──────────┬──────────┬──────────┐            │
│  │ 解释器   │ 基线 JIT │ 优化 JIT │   AOT    │            │
│  └──────────┴──────────┴──────────┴──────────┘            │
└────────────────────────────────────────────────────────────┘
                            ↓ 执行
┌────────────────────────────────────────────────────────────┐
│                   虚拟机层                                  │
│  ┌────────────┬──────────────┬──────────────┐             │
│  │ 线性内存   │ 调用栈       │ 全局变量     │             │
│  └────────────┴──────────────┴──────────────┘             │
└────────────────────────────────────────────────────────────┘
                            ↓ 互操作
┌────────────────────────────────────────────────────────────┐
│                   宿主环境层                                │
│  (浏览器 JS, Node.js, WASI, 嵌入式系统, 区块链)           │
└────────────────────────────────────────────────────────────┘
                            ↓ JIT / 解释
┌────────────────────────────────────────────────────────────┐
│                   硬件层                                    │
│  (x86-64, ARM, RISC-V, GPU, FPGA)                         │
└────────────────────────────────────────────────────────────┘
```

---

## 🧩 核心组件架构

### 1. 模块（Module）

**定义**：Wasm 的基本部署单元

**结构**：

```text
WebAssembly Module
├── Magic Number (0x00 0x61 0x73 0x6D)
├── Version (0x01 0x00 0x00 0x00)
└── Sections (顺序敏感)
    ├── Type Section (类型签名)
    ├── Import Section (外部依赖)
    ├── Function Section (函数索引)
    ├── Table Section (间接调用表)
    ├── Memory Section (线性内存描述)
    ├── Global Section (全局变量)
    ├── Export Section (导出符号)
    ├── Start Section (初始化函数)
    ├── Element Section (表初始化)
    ├── Code Section (函数字节码)
    └── Data Section (静态数据)
```

**关键属性**：

- 自描述：所有类型信息内嵌
- 可流式验证：边加载边验证
- 确定性布局：无运行时不确定性

### 2. 线性内存（Linear Memory）

**定义**：连续字节数组，Wasm 模块的唯一可寻址内存

**架构**：

```text
线性内存布局（典型）
┌─────────────────┬──────────────────────────────────┐
│ 地址范围        │ 用途                              │
├─────────────────┼──────────────────────────────────┤
│ 0x00000000      │ 空指针陷阱区（编译器约定）        │
│ ...             │                                  │
│ 0x00010000      │ 栈起始（由编译器管理）            │
│ ↓               │ 栈向下增长                        │
│ ...             │                                  │
│ 0x00100000      │ 全局变量区                        │
│ ...             │                                  │
│ 0x00200000      │ 堆起始（动态分配）                │
│ ↑               │ 堆向上增长                        │
│ ...             │                                  │
│ 0xFFFFFFFF      │ 地址空间上限（32 位）             │
└─────────────────┴──────────────────────────────────┘
```

**特性**：

- 按页分配（1 页 = 64 KB）
- 运行时可增长（`memory.grow`）
- 与宿主隔离（沙箱边界）
- 支持共享（`SharedArrayBuffer`）

### 3. 执行栈（Execution Stack）

**定义**：操作数栈 + 控制栈

**结构**：

```text
执行栈（逻辑视图）
┌─────────────────────┐
│   操作数栈           │  ← 表达式求值
│   [i32, f64, ...]   │
├─────────────────────┤
│   控制栈             │  ← 控制流（block, loop, if）
│   [Label, ...]      │
├─────────────────────┤
│   调用栈             │  ← 函数调用
│   [Frame, ...]      │
└─────────────────────┘

调用帧（Frame）结构：
┌─────────────────────┐
│ 返回地址             │
│ 局部变量 [i32, ...]  │
│ 父帧指针             │
└─────────────────────┘
```

**安全性**：

- 栈与线性内存隔离
- 栈溢出 → trap
- 类型安全：栈元素带类型标签

### 4. 表（Table）

**定义**：函数引用数组，用于间接调用

**结构**：

```wat
(table $t 10 funcref)  ;; 容量 10，存储函数引用

;; 间接调用
(call_indirect (type $sig) (local.get $index))
```

**用途**：

- 动态分发（虚函数表）
- 插件系统
- 回调机制

**安全性**：

- 运行时类型检查
- 越界 → trap

### 5. 全局变量（Globals）

**定义**：模块级可变/不可变变量

**声明**：

```wat
(global $g (mut i32) (i32.const 0))  ;; 可变
(global $c i32 (i32.const 42))       ;; 不可变
```

**限制**：

- 类型：i32, i64, f32, f64, v128, funcref, externref
- 不可变全局可跨模块共享
- 可变全局不可导出（MVP 限制）

---

## 🔄 执行模型

### 指令执行流程

```text
1. 取指（Fetch）
   ↓
2. 解码（Decode）
   ↓
3. 验证（Validate）—— 静态完成，运行时跳过
   ↓
4. 执行（Execute）
   ├── 操作数栈操作
   ├── 内存访问（带边界检查）
   ├── 控制流跳转
   └── 宿主函数调用
   ↓
5. 异常处理（如果 trap）
```

### 编译策略对比

| 策略 | 延迟 | 吞吐 | 内存 | 适用场景 |
|------|------|------|------|---------|
| **解释器** | ~1 ms | 1× | 低 | 调试、嵌入式 |
| **基线 JIT** | ~100 µs | 2-3× | 中 | 快速启动 |
| **优化 JIT** | ~10 ms | 5-10× | 高 | 长时间运行 |
| **AOT** | ~2.5 µs | 8-12× | 中 | 生产部署 |
| **分层编译** | 自适应 | 最优 | 高 | 浏览器 |

---

## 🔗 互操作架构

### Wasm ↔ 宿主通信

```text
┌─────────────────────────────────────────────────────┐
│                   宿主环境 (JavaScript)              │
│                                                     │
│  ┌─────────────────────────────────────────┐       │
│  │   导入对象 (importObject)                │       │
│  │   ├── env.log(s: string)                │       │
│  │   ├── Math.random() → f64               │       │
│  │   └── fetch(url: string) → Promise      │       │
│  └─────────────────────────────────────────┘       │
│                     ↓                               │
│  ┌─────────────────────────────────────────┐       │
│  │   实例化 (instantiate)                   │       │
│  │   WebAssembly.instantiate(bytes, imports)│       │
│  └─────────────────────────────────────────┘       │
│                     ↓                               │
│  ┌─────────────────────────────────────────┐       │
│  │   Wasm 实例 (instance)                   │       │
│  │   ├── exports.add(a: i32, b: i32) → i32 │       │
│  │   ├── exports.memory: WebAssembly.Memory│       │
│  │   └── exports.table: WebAssembly.Table  │       │
│  └─────────────────────────────────────────┘       │
│                     ↑                               │
│  ┌─────────────────────────────────────────┐       │
│  │   共享内存 (SharedArrayBuffer)           │       │
│  │   零拷贝数据交换                          │       │
│  └─────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────┘
```

### 跨边界调用开销

| 操作 | 延迟 | 说明 |
|------|------|------|
| **Wasm → Wasm** | 1-2 ns | 直接调用 |
| **Wasm → 宿主函数** | 0.4-2 µs | 上下文切换 + 类型转换 |
| **宿主 → Wasm** | 0.4-2 µs | 同上 |
| **SharedArrayBuffer** | ~0 ns | 零拷贝（需同步） |
| **postMessage** | 100-1000 µs | 序列化开销 |

---

## 🔒 安全架构

### 多层安全模型

```text
┌─────────────────────────────────────────────────────┐
│            L4: 进程隔离 (OS/Browser)                 │
│  每个 Wasm 实例独立进程 (Site Isolation)             │
└─────────────────────────────────────────────────────┘
                      ↑
┌─────────────────────────────────────────────────────┐
│         L3: 沙箱隔离 (WebAssembly Runtime)           │
│  线性内存与宿主隔离，所有边界检查                     │
└─────────────────────────────────────────────────────┘
                      ↑
┌─────────────────────────────────────────────────────┐
│         L2: 类型安全 (Type System)                   │
│  静态验证，无类型混淆                                 │
└─────────────────────────────────────────────────────┘
                      ↑
┌─────────────────────────────────────────────────────┐
│         L1: 控制流完整性 (CFI)                       │
│  结构化控制流，无任意跳转                             │
└─────────────────────────────────────────────────────┘
```

### 威胁模型

| 威胁 | 防御层 | 有效性 |
|------|--------|--------|
| **越界访问** | L3 (边界检查) | ✅ 100% |
| **类型混淆** | L2 (类型系统) | ✅ 100% |
| **ROP/JOP** | L1 (结构化控制流) | ✅ 高 |
| **栈溢出** | L3 (栈隔离) | ✅ 100% |
| **Spectre** | L4 (进程隔离) | ⚠️ 部分 |
| **侧信道** | - | ❌ 无防御 |

---

## 📊 性能架构

### 性能瓶颈分析

```text
Wasm 执行总时间分解
┌─────────────────────────────────────────────────────┐
│ 100% 总时间                                          │
│ ├── 5-10%   加载 & 验证                             │
│ ├── 10-20%  编译（JIT/AOT）                         │
│ ├── 60-80%  实际计算                                │
│ │   ├── 50-70%  CPU 执行                           │
│ │   ├── 10-20%  内存访问                           │
│ │   └── 5-10%   边界检查                            │
│ └── 5-10%   跨边界调用                              │
└─────────────────────────────────────────────────────┘
```

### 优化策略

| 瓶颈 | 优化手段 | 效果 |
|------|---------|------|
| **加载** | 流式编译 | -50% |
| **编译** | AOT 预编译 | -80% |
| **计算** | SIMD | +3-8× |
| **内存** | 预分配 | -30% |
| **边界** | 消除检查（编译器） | -5-10% |
| **跨边界** | 批量调用 | +100-1000× |

---

## 🏗️ 系统集成架构

### 典型部署架构：边缘 Serverless

```text
┌──────────────────────────────────────────────────────┐
│                  CDN 边缘节点                         │
│  ┌────────────────────────────────────────────┐      │
│  │         负载均衡器 (LB)                     │      │
│  └────────────────────────────────────────────┘      │
│           ↓                ↓                ↓         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ WasmEdge 1  │  │ WasmEdge 2  │  │ WasmEdge N  │  │
│  │ ├─ Inst A   │  │ ├─ Inst A   │  │ ├─ Inst A   │  │
│  │ ├─ Inst B   │  │ ├─ Inst B   │  │ ├─ Inst B   │  │
│  │ └─ Inst ... │  │ └─ Inst ... │  │ └─ Inst ... │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
│           ↓                ↓                ↓         │
│  ┌────────────────────────────────────────────┐      │
│  │        共享 KV 存储 (Redis)                 │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘
                        ↓
┌──────────────────────────────────────────────────────┐
│                  控制平面                             │
│  - 部署管理                                           │
│  - 监控告警                                           │
│  - 流量调度                                           │
└──────────────────────────────────────────────────────┘
```

**性能指标**：

- 单节点密度：10,000 实例
- 冷启动：<5 ms
- 内存/实例：3.7 MB
- 吞吐：200k req/s/节点

---

## 🔮 演化方向

### 提案阶段（Stage 4 → Stage 0）

```text
[已标准化] Stage 4
├── Core MVP (2017)
├── SIMD (2021)
└── Threads (2021)

[实现中] Stage 3
├── Exception Handling
├── Tail Call
└── Reference Types

[提案中] Stage 2
├── GC (垃圾回收)
├── Component Model
└── Memory64

[探索中] Stage 1
├── GPU 后端
├── 递归类型
└── 分支提示

[想法] Stage 0
├── 硬件加速器
├── 函数式类型
└── 形式化验证集成
```

---

## 🎯 设计权衡

### 核心决策及其影响

| 设计决策 | 优势 | 劣势 | 权衡理由 |
|---------|------|------|---------|
| **栈式机器** | 紧凑、易验证 | 寄存器利用差 | 可移植性优先 |
| **32 位地址空间** | 兼容性好 | 4 GB 限制 | 硬件覆盖面 |
| **静态验证** | 零运行时开销 | 灵活性降低 | 安全性优先 |
| **线性内存** | 简单、快速 | 碎片化 | 实现成本 |
| **结构化控制流** | CFI 保证 | 表达力受限 | 安全性优先 |
| **无 GC (MVP)** | 性能可预测 | 语言限制 | 先简后繁 |

---

## 📖 参考架构文档

- [01_Foundational_Theory/01.1_Formal_Semantics.md](01_Foundational_Theory/01.1_Formal_Semantics.md) - 形式化语义
- [02_Binary_Format/02.1_Module_Structure.md](02_Binary_Format/02.1_Module_Structure.md) - 模块结构
- [03_Runtime_Systems/03.1_Compilation_Strategies.md](03_Runtime_Systems/03.1_Compilation_Strategies.md) - 编译策略
- [04_System_Integration/04.1_WASI_Interface.md](04_System_Integration/04.1_WASI_Interface.md) - WASI 接口

---

**版本历史**：

| 版本 | 日期 | 变更 |
|------|------|------|
| 1.0.0 | 2025-10-30 | 初始版本 |

---

_"好的架构是一系列深思熟虑的权衡，而非完美主义的追求。"_
