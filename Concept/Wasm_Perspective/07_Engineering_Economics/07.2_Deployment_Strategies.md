# 7.2 部署策略 (Deployment Strategies)

## 核心命题

**灰度发布模型**：
\[
\text{Risk} = P(\text{Failure}) \times \text{Impact}(\text{Failure})
\]

**金丝雀原则**：
\[
\alpha_{\text{initial}} \ll 1, \quad \alpha_{\text{final}} = 1
\]

**回滚时间目标**：
\[
T_{\text{rollback}} < 60\text{s}
\]

---

## 部署模式

### 蓝绿部署

**架构**：

```
Load Balancer
  ├─> Blue (v1)  100% traffic
  └─> Green (v2) 0% traffic
      ↓ (切换)
Load Balancer
  ├─> Blue (v1)  0% traffic
  └─> Green (v2) 100% traffic
```

**切换时间**：
\[
T_{\text{switch}} \approx 1-5\text{s（DNS/LB 更新）}
\]

### 金丝雀发布

**流量比例**：
\[
\alpha(t) = \begin{cases}
0.01 & t = 0 \\
0.05 & t = 1\text{h} \\
0.25 & t = 6\text{h} \\
1.00 & t = 24\text{h}
\end{cases}
\]

**风险控制**：
\[
\text{Exposed-Users} = \alpha \times N_{\text{total}}
\]

---

## Wasm 优势

### 快速回滚

**容器回滚**：
\[
T_{\text{container}} = T_{\text{pull}} + T_{\text{start}} \approx 30-120\text{s}
\]

**Wasm 回滚**：
\[
T_{\text{wasm}} = T_{\text{load}} + T_{\text{instantiate}} \approx 1-5\text{s}
\]

### 版本共存

**内存隔离**：

```
Runtime
  ├─> Instance v1 (10% traffic)
  └─> Instance v2 (90% traffic)
```

**开销**：
\[
\text{Memory}_{\text{overhead}} \approx 2 \times \text{Module-Size}
\]

---

## A/B 测试

### 分流策略

**哈希分桶**：
\[
\text{Bucket}(\text{user-id}) = \text{hash}(\text{user-id}) \bmod N
\]

**实验组分配**：
\[
\text{Version}(u) = \begin{cases}
\text{A} & \text{Bucket}(u) < N/2 \\
\text{B} & \text{otherwise}
\end{cases}
\]

### 统计显著性

**t-检验**：
\[
t = \frac{\bar{X}_A - \bar{X}_B}{\sqrt{\frac{s_A^2}{n_A} + \frac{s_B^2}{n_B}}}
\]

**样本量估计**：
\[
n \approx \frac{16\sigma^2}{\delta^2} \quad (\alpha=0.05, \beta=0.2)
\]

---

## 批判性分析

**命题**：
\[
\text{Fast-Deployment} \not\Rightarrow \text{Safe-Deployment}
\]

**批判**：
> Wasm 的快速部署是双刃剑：加速创新，也加速错误传播。没有完善监控与自动回滚，快速部署反而增加风险。技术能力需要配套流程。

---

## 参考文献

1. **[Humble10]** Jez Humble. "Continuous Delivery." Addison-Wesley, 2010.
