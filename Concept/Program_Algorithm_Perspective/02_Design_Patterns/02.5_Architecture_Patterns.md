# æ¶æ„çº§æ¨¡å¼å½¢å¼åŒ–åˆ†æ

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>ğŸ—ï¸ğŸ”¬ ç‚¹å‡»å±•å¼€ï¼šæ¶æ„æ¨¡å¼æ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: è½¯ä»¶æ¶æ„=ç³»ç»Ÿçš„éª¨éª¼ç»“æ„ã€‚äº”å¤§ç»å…¸æ¶æ„ï¼šâ‘ åˆ†å±‚æ¶æ„ï¼ˆLayeredï¼‰ï¼šå•å‘ä¾èµ–å±‚æ¬¡ï¼ŒOSIä¸ƒå±‚å…¸èŒƒï¼Œå…³æ³¨ç‚¹åˆ†ç¦»ï¼Œä½†å±‚é—´é€šä¿¡å¼€é”€â‘¡ç®¡é“-è¿‡æ»¤å™¨ï¼ˆPipes & Filtersï¼‰ï¼šæ•°æ®æµé©±åŠ¨ï¼ŒUnixç®¡é“å“²å­¦ï¼Œæ˜“äºå¹¶è¡ŒåŒ–ï¼Œä½†éš¾ä»¥äº¤äº’â‘¢å¾®å†…æ ¸ï¼ˆMicrokernelï¼‰ï¼šæ ¸å¿ƒ+æ’ä»¶ï¼ŒEclipse/VS Codeæ¶æ„ï¼Œé«˜åº¦å¯æ‰©å±•ï¼Œä½†æ’ä»¶éš”ç¦»ä»£ä»·â‘£å¾®æœåŠ¡ï¼ˆMicroservicesï¼‰ï¼šåˆ†å¸ƒå¼å•ä½“ï¼Œç‹¬ç«‹éƒ¨ç½²/æ‰©å±•/å®¹é”™ï¼Œä½†åˆ†å¸ƒå¼äº‹åŠ¡å¤æ‚ï¼ˆSagaæ¨¡å¼ï¼‰â‘¤äº‹ä»¶é©±åŠ¨ï¼ˆEvent-Drivenï¼‰ï¼šæ¾è€¦åˆå¼‚æ­¥ï¼ŒKafka/Actoræ¨¡å‹ï¼Œé«˜ååä½å»¶è¿Ÿï¼Œä½†è°ƒè¯•å›°éš¾ã€‚å½¢å¼åŒ–æ–¹æ³•ï¼šâ‘ æ¶æ„æè¿°è¯­è¨€ï¼ˆADLï¼‰ï¼šACME/Wright/Darwinâ‘¡Ï€-æ¼”ç®—å»ºæ¨¡åŠ¨æ€é‡é…ç½®â‘¢TLA+éªŒè¯åˆ†å¸ƒå¼ä¸€è‡´æ€§â‘£Coqè¯æ˜æ¶æ„ä¸å˜é‡ã€‚è´¨é‡å±æ€§æƒè¡¡ï¼šæ€§èƒ½vså¯ç»´æŠ¤æ€§ã€å¯æ‰©å±•æ€§vsä¸€è‡´æ€§ã€çµæ´»æ€§vsç®€å•æ€§ã€‚æ¶æ„å†³ç­–è®°å½•ï¼ˆADRï¼‰ï¼šæ–‡æ¡£åŒ–æƒè¡¡ç†ç”±ã€‚å…³é”®ï¼šå¥½çš„æ¶æ„æ˜¯ç³»ç»Ÿè´¨é‡å±æ€§çš„å®ˆæŠ¤è€…ï¼Œå½¢å¼åŒ–ä½¿æ¶æ„å†³ç­–å¯éªŒè¯ã€‚

</details>

---

## ğŸ“‹ ç›®å½•

- [æ¦‚è¿°](#æ¦‚è¿°)
- [1. åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰](#1-åˆ†å±‚æ¶æ„layered-architecture)
  - [1.1 å½¢å¼åŒ–å®šä¹‰](#11-å½¢å¼åŒ–å®šä¹‰)
  - [1.2 mCRL2 å½¢å¼åŒ–](#12-mcrl2-å½¢å¼åŒ–)
  - [1.3 æ€§èƒ½æ¨¡å‹ï¼ˆUPPAALï¼‰](#13-æ€§èƒ½æ¨¡å‹uppaal)
  - [1.4 å®é™…æ¡ˆä¾‹ï¼šOSI ä¸ƒå±‚](#14-å®é™…æ¡ˆä¾‹osi-ä¸ƒå±‚)
- [2. ç®¡é“-è¿‡æ»¤å™¨ï¼ˆPipes & Filtersï¼‰](#2-ç®¡é“-è¿‡æ»¤å™¨pipes--filters)
  - [2.1 å½¢å¼åŒ–å®šä¹‰](#21-å½¢å¼åŒ–å®šä¹‰)
  - [2.2 è¿›ç¨‹ä»£æ•°å»ºæ¨¡ï¼ˆCSPï¼‰](#22-è¿›ç¨‹ä»£æ•°å»ºæ¨¡csp)
  - [2.3 æ•°æ®æµå›¾ï¼ˆDFGï¼‰](#23-æ•°æ®æµå›¾dfg)
  - [2.4 å®é™…æ¡ˆä¾‹ï¼šè§†é¢‘å¤„ç†](#24-å®é™…æ¡ˆä¾‹è§†é¢‘å¤„ç†)
- [3. å¾®å†…æ ¸ï¼ˆMicrokernelï¼‰](#3-å¾®å†…æ ¸microkernel)
  - [3.1 å½¢å¼åŒ–å®šä¹‰](#31-å½¢å¼åŒ–å®šä¹‰)
  - [3.2 Ï€-æ¼”ç®—å»ºæ¨¡](#32-Ï€-æ¼”ç®—å»ºæ¨¡)
  - [3.3 Coq éªŒè¯](#33-coq-éªŒè¯)
  - [3.4 å®é™…æ¡ˆä¾‹ï¼šEclipse IDE](#34-å®é™…æ¡ˆä¾‹eclipse-ide)
- [4. å¾®æœåŠ¡æ¶æ„ï¼ˆMicroservicesï¼‰](#4-å¾®æœåŠ¡æ¶æ„microservices)
  - [4.1 å½¢å¼åŒ–å®šä¹‰](#41-å½¢å¼åŒ–å®šä¹‰)
  - [4.2 TLA+ éªŒè¯](#42-tla-éªŒè¯)
  - [4.3 Saga æ¨¡å¼ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰](#43-saga-æ¨¡å¼åˆ†å¸ƒå¼äº‹åŠ¡)
  - [4.4 å®é™…æ¡ˆä¾‹ï¼šNetflix](#44-å®é™…æ¡ˆä¾‹netflix)
- [5. äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent-Drivenï¼‰](#5-äº‹ä»¶é©±åŠ¨æ¶æ„event-driven)
  - [5.1 å½¢å¼åŒ–å®šä¹‰](#51-å½¢å¼åŒ–å®šä¹‰)
  - [5.2 Actor æ¨¡å‹å®ç°](#52-actor-æ¨¡å‹å®ç°)
  - [5.3 Event Sourcing](#53-event-sourcing)
  - [5.4 å®é™…æ¡ˆä¾‹ï¼šKafka](#54-å®é™…æ¡ˆä¾‹kafka)
- [6. ç©ºé—´æ¶æ„ï¼ˆSpace-Basedï¼‰](#6-ç©ºé—´æ¶æ„space-based)
- [7. æ¨¡å¼å¯¹æ¯”ä¸é€‰æ‹©](#7-æ¨¡å¼å¯¹æ¯”ä¸é€‰æ‹©)
- [8. å¤§å­¦è¯¾ç¨‹å¯¹åº”](#8-å¤§å­¦è¯¾ç¨‹å¯¹åº”)

---

## æ¦‚è¿°

**æ¶æ„çº§æ¨¡å¼**ï¼ˆArchitecture Patternsï¼‰æ˜¯é«˜å±‚æ¬¡çš„ç³»ç»Ÿç»„ç»‡æ¨¡å¼ï¼Œå®šä¹‰äº†ç³»ç»Ÿçš„**ä¸»è¦ç»„ä»¶**å’Œ**å®ƒä»¬ä¹‹é—´çš„äº¤äº’**ã€‚ä¸å¾®è§‚è®¾è®¡æ¨¡å¼ï¼ˆGoFï¼‰ä¸åŒï¼Œæ¶æ„æ¨¡å¼å…³æ³¨**æ•´ä½“ç»“æ„**å’Œ**è´¨é‡å±æ€§**ï¼ˆæ€§èƒ½ã€å¯æ‰©å±•æ€§ã€å¯é æ€§ï¼‰ã€‚

**æ ¸å¿ƒæ€æƒ³**ï¼š

```text
æ¶æ„æ¨¡å¼ = ç»„ä»¶æ‹“æ‰‘ + äº¤äº’åè®® + è´¨é‡å±æ€§ä¿è¯

å½¢å¼åŒ–ï¼š
  Architecture = âŸ¨Components, Connectors, Constraints, PropertiesâŸ©
    Components: {Câ‚, Câ‚‚, ..., Câ‚™}
    Connectors: {conn : Cáµ¢ â†’ Câ±¼}
    Constraints: æ‹“æ‰‘çº¦æŸã€æ€§èƒ½çº¦æŸ
    Properties: å¯éªŒè¯çš„ç³»ç»Ÿæ€§è´¨
```

**æœ¬æ–‡æ¶µç›–**ï¼š

1. **åˆ†å±‚æ¶æ„**ï¼ˆLayered/N-Tierï¼‰
2. **ç®¡é“-è¿‡æ»¤å™¨**ï¼ˆPipes & Filtersï¼‰
3. **å¾®å†…æ ¸**ï¼ˆMicrokernel/Pluginï¼‰
4. **å¾®æœåŠ¡**ï¼ˆMicroservicesï¼‰
5. **äº‹ä»¶é©±åŠ¨**ï¼ˆEvent-Drivenï¼‰
6. **ç©ºé—´æ¶æ„**ï¼ˆSpace-Basedï¼‰

**å½¢å¼åŒ–ç›®æ ‡**ï¼š

- ç”¨ **mCRL2** å»ºæ¨¡ç»„ä»¶äº¤äº’
- ç”¨ **UPPAAL** éªŒè¯å®æ—¶æ€§
- ç”¨ **Alloy** éªŒè¯ç»“æ„çº¦æŸ

---

## 1. åˆ†å±‚æ¶æ„ï¼ˆLayered Architectureï¼‰

### 1.1 å½¢å¼åŒ–å®šä¹‰

**æ‹“æ‰‘ç»“æ„**ï¼š

```text
Layers = âŸ¨Lâ‚, Lâ‚‚, ..., Lâ‚™âŸ©

ä¾èµ–å…³ç³»ï¼š
  âˆ€i < j, Láµ¢ å¯è°ƒç”¨ Lâ±¼
  âˆ€i > j, Láµ¢ ä¸å¯è°ƒç”¨ Lâ±¼ï¼ˆä¸¥æ ¼åˆ†å±‚ï¼‰

å½¢å¼åŒ–ï¼ˆDAGï¼‰ï¼š
  G = (Layers, Edges)
  Edges âŠ† {(Láµ¢, Lâ±¼) | i < j}
  
  æ— ç¯æ€§ï¼šÂ¬âˆƒ è·¯å¾„ Láµ¢ â†’ ... â†’ Láµ¢
```

**ç¤ºä¾‹**ï¼ˆç»å…¸ä¸‰å±‚ï¼‰ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Presentation (Lâ‚) â”‚  UI é€»è¾‘
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Business Logic(Lâ‚‚)â”‚  ä¸šåŠ¡è§„åˆ™
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data Access (Lâ‚ƒ)  â”‚  æ•°æ®åº“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Edges = {(Lâ‚, Lâ‚‚), (Lâ‚‚, Lâ‚ƒ)}
```

### 1.2 mCRL2 å½¢å¼åŒ–

```mcrl2
sort Layer = struct presentation | business | data;

act call : Layer # Layer;     % å±‚é—´è°ƒç”¨
    response : Layer # Layer;  % å“åº”

proc Presentation = 
  call(presentation, business) .
  response(business, presentation) .
  Presentation;

proc Business =
  sum l:Layer . (l == presentation) ->
    response(presentation, business) .
    call(business, data) .
    response(data, business) .
    Business;

proc Data =
  sum l:Layer . (l == business) ->
    response(business, data) .
    Data;

init allow({call, response},
  comm({call|response -> sync},
    Presentation || Business || Data));
```

**éªŒè¯æ— ç¯æ€§**ï¼š

```bash
mcrl22lps layered.mcrl2 | lps2lts -v
# æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾ªç¯è°ƒç”¨
```

### 1.3 æ€§èƒ½æ¨¡å‹ï¼ˆUPPAALï¼‰

**å»¶è¿Ÿä¸Šç•Œ**ï¼š

```text
å®šç†ï¼šç«¯åˆ°ç«¯å»¶è¿Ÿ â‰¤ Î£áµ¢ delayáµ¢

UPPAAL æ¨¡å‹ï¼š
  - æ¯å±‚ä¸€ä¸ªæ—¶é’Ÿè‡ªåŠ¨æœº
  - å±‚é—´é€šä¿¡ç”¨åŒæ­¥é€šé“
  - éªŒè¯ CTLï¼šA[] (request_time - response_time <= MAX_DELAY)
```

**UPPAAL ä»£ç **ï¼š

```uppaal
// Presentation Layer
process Presentation() {
  clock t;
  state idle, waiting;
  
  idle -> waiting { 
    t = 0;
    call_business!;
  }
  
  waiting -> idle {
    response_from_business?;
    t <= 100;  // 100ms è¶…æ—¶
  }
}

// éªŒè¯
A[] (Presentation.t <= 500)  // æ€»å»¶è¿Ÿ â‰¤ 500ms
```

### 1.4 å®é™…æ¡ˆä¾‹ï¼šOSI ä¸ƒå±‚

**å½¢å¼åŒ–æ‹“æ‰‘**ï¼š

```text
Lâ‚‡ Application  â†’ HTTP, FTP
Lâ‚† Presentation â†’ SSL, TLS
Lâ‚… Session      â†’ NetBIOS
Lâ‚„ Transport    â†’ TCP, UDP
Lâ‚ƒ Network      â†’ IP
Lâ‚‚ Data Link    â†’ Ethernet
Lâ‚ Physical     â†’ ç”µä¿¡å·

ä¾èµ–ï¼šLâ‚‡ â†’ Lâ‚† â†’ ... â†’ Lâ‚
```

**åè®®éªŒè¯**ï¼š

- **mCRL2**ï¼šå»ºæ¨¡ TCP ä¸‰æ¬¡æ¡æ‰‹
- **SPIN**ï¼šéªŒè¯ SSL æ¡æ‰‹æ— æ­»é”

---

## 2. ç®¡é“-è¿‡æ»¤å™¨ï¼ˆPipes & Filtersï¼‰

### 2.1 å½¢å¼åŒ–å®šä¹‰

**ç»„ä»¶**ï¼š

```text
Filter: Stream â†’ Stream
  input: Stream<T>
  process: T â†’ U
  output: Stream<U>

Pipe: è¿æ¥ Filter çš„æ•°æ®é€šé“ï¼ˆFIFO é˜Ÿåˆ—ï¼‰

Pipeline = Fâ‚ â†’ Fâ‚‚ â†’ ... â†’ Fâ‚™

è¯­ä¹‰ï¼š
  Output = Fâ‚™(Fâ‚™â‚‹â‚(...Fâ‚(Input)...))
```

**ç¤ºä¾‹**ï¼ˆUnix ç®¡é“ï¼‰ï¼š

```bash
cat file.txt | grep "error" | wc -l
```

### 2.2 è¿›ç¨‹ä»£æ•°å»ºæ¨¡ï¼ˆCSPï¼‰

```csp
FILTER(name) = input?x -> process(x) -> output!result -> FILTER(name)

PIPE(capacity) = 
  (|buffer| < capacity) & write?x -> PIPE(buffer ++ [x])
  []
  (|buffer| > 0) & read!head(buffer) -> PIPE(tail(buffer))

PIPELINE = FILTER("grep") ||| PIPE(10) ||| FILTER("wc")
```

**éªŒè¯**ï¼š

```text
æ­»é”æ£€æŸ¥ï¼šPIPELINE âŠ‘ DEADLOCK_FREE
æœ‰ç•Œæ€§ï¼š|PIPE.buffer| â‰¤ capacity
```

### 2.3 æ•°æ®æµå›¾ï¼ˆDFGï¼‰

**Kahn Process Networks**ï¼š

```text
Process: ç‹¬ç«‹è®¡ç®—å•å…ƒï¼Œé€šè¿‡ FIFO é€šä¿¡
æ€§è´¨ï¼š
  - ç¡®å®šæ€§ï¼ˆè¾“å‡ºåªä¾èµ–è¾“å…¥ï¼‰
  - å•è°ƒæ€§ï¼ˆä¸å›é€€ï¼‰

å®šç†ï¼ˆKahn 1974ï¼‰ï¼š
  è‹¥è¿›ç¨‹æ»¡è¶³å•è°ƒæ€§ï¼Œåˆ™ç½‘ç»œè¡Œä¸ºå”¯ä¸€ç¡®å®šï¼ˆä¸è°ƒåº¦æ— å…³ï¼‰
```

**Lean4 å½¢å¼åŒ–**ï¼š

```lean
structure KahnProcess (Î± Î² : Type) where
  state : Type
  init : state
  step : state â†’ Î± â†’ state Ã— Option Î²
  
-- å•è°ƒæ€§ï¼šä¸ä¾èµ–æœªæ¥è¾“å…¥
axiom monotone (p : KahnProcess Î± Î²) : 
  âˆ€ s input1 input2,
    input1.isPrefixOf input2 â†’
    (p.run s input1).output.isPrefixOf (p.run s input2).output
```

### 2.4 å®é™…æ¡ˆä¾‹ï¼šè§†é¢‘å¤„ç†

**æ¶æ„**ï¼š

```text
Input â†’ Decoder â†’ Scaler â†’ Encoder â†’ Output
         (H.264)   (Resize)  (H.265)
```

**æ€§èƒ½åˆ†æ**ï¼š

- **ååé‡**ï¼šmin(throughput(Fáµ¢))ï¼ˆç“¶é¢ˆï¼‰
- **å»¶è¿Ÿ**ï¼šÎ£áµ¢ latency(Fáµ¢)
- **å¹¶è¡ŒåŒ–**ï¼šæ¯ä¸ª Filter ç‹¬ç«‹çº¿ç¨‹

---

## 3. å¾®å†…æ ¸ï¼ˆMicrokernelï¼‰

### 3.1 å½¢å¼åŒ–å®šä¹‰

**ç»“æ„**ï¼š

```text
System = Core + Plugins

Core: æœ€å°åŠŸèƒ½é›†
  - æ¶ˆæ¯ä¼ é€’
  - è¿›ç¨‹ç®¡ç†
  - åŸºç¡€ I/O

Plugins: å¯æ’æ‹”åŠŸèƒ½æ¨¡å—
  - æ³¨å†Œåˆ° Core
  - é€šè¿‡ IPC é€šä¿¡
```

**æ¥å£è§„èŒƒ**ï¼š

```text
interface Plugin {
  name: String
  version: Version
  init(): Result<(), Error>
  handle_message(msg: Message): Response
}

Core.register(plugin: Plugin) {
  validate(plugin)
  plugins.insert(plugin.name, plugin)
}
```

### 3.2 Ï€-æ¼”ç®—å»ºæ¨¡

```text
Core = Î½registry. (
  register(p).Core{plugins âˆª {p}}
  +
  Î£áµ¢ message(páµ¢).forward_to_plugin(páµ¢).Core
)

Plugin(name) = registerâŸ¨nameâŸ©.RecvLoop(name)

RecvLoop(name) = message_for(name)?msg.handle(msg).RecvLoop(name)
```

**æ€§è´¨**ï¼š

- **çƒ­æ’æ‹”**ï¼šCore çŠ¶æ€ä¸ä¾èµ– Plugin å­˜åœ¨æ€§
- **éš”ç¦»æ€§**ï¼šPlugin å´©æºƒä¸å½±å“ Core
- **å¯ç»„åˆæ€§**ï¼šä»»æ„ Plugin ç»„åˆåˆæ³•

### 3.3 Coq éªŒè¯

```coq
Record Microkernel : Type := mkKernel {
  core : CoreState;
  plugins : list Plugin;
  
  (* ä¸å˜å¼ï¼šCore å§‹ç»ˆå¯ç”¨ *)
  core_available : is_available core = true;
  
  (* æ’ä»¶éš”ç¦» *)
  plugin_isolation : forall p1 p2,
    In p1 plugins -> In p2 plugins ->
    p1 <> p2 -> disjoint (memory p1) (memory p2);
}.

Theorem plugin_crash_safety : forall k p,
  In p k.(plugins) ->
  crash p ->
  is_available k.(core) = true.
Proof.
  intros k p Hin Hcrash.
  (* è¯æ˜ï¼šPlugin å´©æºƒä¸å½±å“ Core *)
  apply k.(core_available).
Qed.
```

### 3.4 å®é™…æ¡ˆä¾‹ï¼šEclipse IDE

**æ¶æ„**ï¼š

- **Core**ï¼šOSGi å®¹å™¨
- **Plugins**ï¼šJDTï¼ˆJava å¼€å‘ï¼‰ã€CDTï¼ˆC/C++ï¼‰ã€PyDevï¼ˆPythonï¼‰

**éªŒè¯**ï¼š

- **ä¾èµ–æ£€æŸ¥**ï¼šAlloy å»ºæ¨¡ Plugin ä¾èµ–å›¾
- **ç‰ˆæœ¬å…¼å®¹**ï¼šSAT æ±‚è§£å™¨éªŒè¯å…¼å®¹æ€§

---

## 4. å¾®æœåŠ¡æ¶æ„ï¼ˆMicroservicesï¼‰

### 4.1 å½¢å¼åŒ–å®šä¹‰

**ç»„ä»¶**ï¼š

```text
Service: ç‹¬ç«‹éƒ¨ç½²çš„ä¸šåŠ¡èƒ½åŠ›å•å…ƒ
  - ç‹¬ç«‹æ•°æ®åº“
  - é€šè¿‡ API é€šä¿¡
  - æ— å…±äº«çŠ¶æ€

ServiceMesh = âŸ¨Services, APIGateway, ServiceRegistryâŸ©

é€šä¿¡æ¨¡å¼ï¼š
  - åŒæ­¥ï¼šHTTP REST / gRPC
  - å¼‚æ­¥ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaã€RabbitMQï¼‰
```

**CAP å®šç†çº¦æŸ**ï¼š

```text
å®šç†ï¼ˆBrewer 2000ï¼‰ï¼š
  åˆ†å¸ƒå¼ç³»ç»Ÿæœ€å¤šåŒæ—¶æ»¡è¶³ CAP ä¸­çš„ä¸¤é¡¹ï¼š
    - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰
    - Availabilityï¼ˆå¯ç”¨æ€§ï¼‰
    - Partition toleranceï¼ˆåˆ†åŒºå®¹é”™ï¼‰

å¾®æœåŠ¡é€‰æ‹©ï¼šé€šå¸¸ APï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰
```

### 4.2 TLA+ éªŒè¯

**ç¤ºä¾‹**ï¼ˆè®¢å•æœåŠ¡ + åº“å­˜æœåŠ¡ï¼‰ï¼š

```tla
VARIABLES order_state, inventory_state, in_transit

TypeOK ==
  /\ order_state \in {"pending", "confirmed", "failed"}
  /\ inventory_state \in Nat
  /\ in_transit \subseteq DOMAIN Messages

PlaceOrder ==
  /\ order_state = "pending"
  /\ inventory_state > 0
  /\ order_state' = "confirmed"
  /\ inventory_state' = inventory_state - 1

Timeout ==
  /\ order_state = "pending"
  /\ in_transit = {}
  /\ order_state' = "failed"

EventualConsistency ==
  <>[] (order_state = "confirmed" => inventory_state < inventory_state_initial)
```

**éªŒè¯å‘½ä»¤**ï¼š

```bash
tlc microservices.tla
```

### 4.3 Saga æ¨¡å¼ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰

**å®šä¹‰**ï¼š

```text
Saga = [Tâ‚, Tâ‚‚, ..., Tâ‚™]
æ¯ä¸ª Táµ¢ æœ‰è¡¥å¿äº‹åŠ¡ Cáµ¢

æ‰§è¡Œï¼š
  è‹¥æ‰€æœ‰ Táµ¢ æˆåŠŸ â†’ æäº¤
  è‹¥æŸ Tâ±¼ å¤±è´¥ â†’ æ‰§è¡Œ Câ‚, Câ‚‚, ..., Câ±¼â‚‹â‚ï¼ˆå›æ»šï¼‰
```

**mCRL2 éªŒè¯**ï¼š

```mcrl2
act transaction : Nat;       % Táµ¢
    compensate : Nat;        % Cáµ¢
    commit, rollback;

proc Saga(n: Nat, i: Nat) =
  (i == n) -> commit . Saga(n, 0)
  +
  (i < n) -> (
    transaction(i) . Saga(n, i+1)
    +
    rollback . Compensate(i)
  );

proc Compensate(i: Nat) =
  (i == 0) -> rollback . Saga(n, 0)
  +
  (i > 0) -> compensate(i) . Compensate(i-1);

init Saga(3, 0);
```

**æ€§è´¨**ï¼š

```text
Safety: Â¬(commit âˆ§ rollback)  (äº’æ–¥)
Liveness: [](transaction(0) -> <>(commit âˆ¨ rollback))
```

### 4.4 å®é™…æ¡ˆä¾‹ï¼šNetflix

**æœåŠ¡æ•°é‡**ï¼š700+

**æŒ‘æˆ˜ä¸è§£å†³**ï¼š

- **æœåŠ¡å‘ç°**ï¼šEureka
- **è´Ÿè½½å‡è¡¡**ï¼šRibbon
- **æ–­è·¯å™¨**ï¼šHystrixï¼ˆé˜²é›ªå´©ï¼‰
- **åˆ†å¸ƒå¼è¿½è¸ª**ï¼šZipkin

**å½¢å¼åŒ–éªŒè¯**ï¼š

- **Chaos Monkey**ï¼šéšæœºæ€æœåŠ¡ï¼ˆæ•…éšœæ³¨å…¥ï¼‰
- **Turbine**ï¼šå®æ—¶èšåˆæŒ‡æ ‡
- **TLA+**ï¼šéªŒè¯ Eureka æ³¨å†Œè¡¨ä¸€è‡´æ€§

---

## 5. äº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent-Drivenï¼‰

### 5.1 å½¢å¼åŒ–å®šä¹‰

**ç»„ä»¶**ï¼š

```text
Event: ç³»ç»Ÿä¸­å‘ç”Ÿçš„äº‹å®ï¼ˆä¸å¯å˜ï¼‰
  - äº‹ä»¶ID
  - æ—¶é—´æˆ³
  - æ•°æ®è½½è·

EventBus: å‘å¸ƒ-è®¢é˜…æœºåˆ¶
  Subscribers: {Sâ‚, Sâ‚‚, ..., Sâ‚™}
  
  publish(event) â†’ notify(Sáµ¢) for all Sáµ¢ âˆˆ Subscribers
```

**æ—¶åºé€»è¾‘**ï¼š

```text
æ€§è´¨ï¼ˆLTLï¼‰ï¼š
  - å› æœæ€§ï¼špublish(e) â†’ â—‡receive(e)
  - é¡ºåºæ€§ï¼špublish(eâ‚) < publish(eâ‚‚) â†’ receive(eâ‚) < receive(eâ‚‚)
  - æ°å¥½ä¸€æ¬¡ï¼šreceive(e) âˆ§ process(e) â†’ Â¬â—‡process(e)
```

### 5.2 Actor æ¨¡å‹å®ç°

**Akka ç¤ºä¾‹**ï¼š

```scala
case class OrderPlaced(orderId: String, amount: Double)

class InventoryActor extends Actor {
  def receive = {
    case OrderPlaced(id, amount) =>
      // æ›´æ–°åº“å­˜
      val newStock = stock - amount
      if (newStock >= 0) {
        context.system.eventStream.publish(StockUpdated(id, newStock))
      } else {
        context.system.eventStream.publish(OutOfStock(id))
      }
  }
}

// mCRL2 éªŒè¯
act order_placed, stock_updated, out_of_stock;

proc InventoryActor(stock: Int) =
  (stock > 0) -> order_placed . stock_updated . InventoryActor(stock - 1)
  +
  (stock == 0) -> order_placed . out_of_stock . InventoryActor(0);
```

### 5.3 Event Sourcing

**å®šä¹‰**ï¼š

```text
State(t) = fold(Events[0..t], InitialState, apply)

æ€§è´¨ï¼š
  - å®¡è®¡ï¼šæ‰€æœ‰çŠ¶æ€å˜æ›´å¯è¿½æº¯
  - é‡æ”¾ï¼šä»äº‹ä»¶æµé‡å»ºä»»æ„æ—¶åˆ»çŠ¶æ€
  - æ—¶é—´æ—…è¡Œï¼šæŸ¥è¯¢å†å²çŠ¶æ€
```

**Coq å½¢å¼åŒ–**ï¼š

```coq
Inductive Event : Type :=
  | Created : nat -> Event
  | Updated : nat -> nat -> Event
  | Deleted : nat -> Event.

Fixpoint apply_event (state : list nat) (e : Event) : list nat :=
  match e with
  | Created x => x :: state
  | Updated old new => map (fun y => if y =? old then new else y) state
  | Deleted x => filter (fun y => negb (y =? x)) state
  end.

Definition replay (events : list Event) : list nat :=
  fold_left apply_event events [].

Theorem replay_deterministic : forall events1 events2,
  events1 = events2 -> replay events1 = replay events2.
Proof.
  intros. rewrite H. reflexivity.
Qed.
```

### 5.4 å®é™…æ¡ˆä¾‹ï¼šKafka

**æ¶æ„**ï¼š

- **Topic**ï¼šäº‹ä»¶åˆ†ç±»
- **Partition**ï¼šå¹¶è¡Œå¤„ç†
- **Consumer Group**ï¼šè´Ÿè½½å‡è¡¡

**ä¿è¯**ï¼š

- **è‡³å°‘ä¸€æ¬¡**ï¼ˆAt-Least-Onceï¼‰ï¼šé»˜è®¤
- **æ°å¥½ä¸€æ¬¡**ï¼ˆExactly-Onceï¼‰ï¼šäº‹åŠ¡æ”¯æŒ
- **é¡ºåºæ€§**ï¼šåŒ Partition å†…æœ‰åº

---

## 6. ç©ºé—´æ¶æ„ï¼ˆSpace-Basedï¼‰

### 6.1 å½¢å¼åŒ–å®šä¹‰

**æ ¸å¿ƒæ€æƒ³**ï¼šæ¶ˆé™¤æ•°æ®åº“ç“¶é¢ˆ

```text
Space = åˆ†å¸ƒå¼å…±äº«å†…å­˜ï¼ˆTuple Spaceï¼‰

æ“ä½œï¼š
  - write(tuple)ï¼šå†™å…¥å…ƒç»„
  - read(template)ï¼šåŒ¹é…è¯»å–ï¼ˆé˜»å¡ï¼‰
  - take(template)ï¼šåŒ¹é…ç§»é™¤ï¼ˆåŸå­ï¼‰

æ€§è´¨ï¼š
  - è§£è€¦ï¼šç”Ÿäº§è€…/æ¶ˆè´¹è€…ä¸ç›´æ¥é€šä¿¡
  - æ—¶é—´è§£è€¦ï¼šå¼‚æ­¥
  - ç©ºé—´è§£è€¦ï¼šä½ç½®é€æ˜
```

### 6.2 Linda å…ƒç»„ç©ºé—´

**ç¤ºä¾‹**ï¼ˆå¹¶è¡Œå½’å¹¶æ’åºï¼‰ï¼š

```c
// Master
for (int i = 0; i < N; i += CHUNK) {
  out("task", i, i + CHUNK);  // å†™å…¥ä»»åŠ¡
}

// Worker
while (true) {
  in("task", ?start, ?end);   // å–å‡ºä»»åŠ¡ï¼ˆåŸå­ï¼‰
  int *sorted = sort(data, start, end);
  out("result", start, sorted);
}

// Collector
for (int i = 0; i < N / CHUNK; i++) {
  in("result", ?start, ?data);
  merge(result, data);
}
```

**Promela éªŒè¯ï¼ˆSPINï¼‰**ï¼š

```promela
mtype = { task, result };

chan space = [10] of { mtype, int, int };

active proctype Master() {
  int i;
  for (i : 0 .. 9) {
    space!task, i, i+10;
  }
}

active [3] proctype Worker() {
  int start, end;
  do
  :: space?task, start, end ->
     /* process */
     space!result, start, 0;
  od;
}

ltl no_deadlock { []<>(len(space) == 0) }
```

### 6.3 å®é™…æ¡ˆä¾‹ï¼šGigaSpaces

**åº”ç”¨**ï¼š

- é«˜å¹¶å‘ Web åº”ç”¨ï¼ˆç”µå•†ç§’æ€ï¼‰
- é‡‘èäº¤æ˜“ç³»ç»Ÿ

**ç‰¹ç‚¹**ï¼š

- å†…å­˜ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰
- è‡ªåŠ¨åˆ†ç‰‡ï¼ˆAuto-Shardingï¼‰
- é«˜å¯ç”¨ï¼ˆReplicationï¼‰

---

## 7. æ¨¡å¼å¯¹æ¯”ä¸é€‰æ‹©

### 7.1 è´¨é‡å±æ€§å¯¹æ¯”

| æ¨¡å¼ | æ€§èƒ½ | å¯æ‰©å±•æ€§ | å¯æµ‹è¯•æ€§ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|----------|--------|----------|
| **Layered** | ä¸­ | ä½ | é«˜ | ä½ | ä¼ ç»Ÿä¼ä¸šåº”ç”¨ |
| **Pipes & Filters** | é«˜ï¼ˆå¹¶è¡Œï¼‰ | ä¸­ | é«˜ | ä½ | æ•°æ®å¤„ç†æµ |
| **Microkernel** | é«˜ | é«˜ | ä¸­ | ä¸­ | æ’ä»¶ç³»ç»Ÿ |
| **Microservices** | ä¸­ | æé«˜ | ä¸­ | é«˜ | å¤§è§„æ¨¡åˆ†å¸ƒå¼ |
| **Event-Driven** | é«˜ | é«˜ | ä½ | é«˜ | å®æ—¶ç³»ç»Ÿ |
| **Space-Based** | æé«˜ | æé«˜ | ä½ | æé«˜ | æç«¯å¹¶å‘ |

### 7.2 å†³ç­–æ ‘

```text
Q1: éœ€è¦æç«¯å¯æ‰©å±•æ€§ï¼Ÿ
  Yes â†’ Q2: èƒ½æ¥å—é«˜å¤æ‚åº¦ï¼Ÿ
          Yes â†’ Microservices / Space-Based
          No â†’ Event-Driven
  No â†’ Q3: æ˜¯æ•°æ®æµå¤„ç†ï¼Ÿ
         Yes â†’ Pipes & Filters
         No â†’ Q4: éœ€è¦æ’ä»¶åŒ–ï¼Ÿ
                Yes â†’ Microkernel
                No â†’ Layeredï¼ˆé»˜è®¤é€‰æ‹©ï¼‰
```

---

## 8. å¤§å­¦è¯¾ç¨‹å¯¹åº”

| è¯¾ç¨‹ | ç›¸å…³ç« èŠ‚ |
|------|----------|
| **CMU 17-313 è½¯ä»¶æ¶æ„** | Layered, Pipes & Filters, Microkernel |
| **MIT 6.033 ç³»ç»Ÿå·¥ç¨‹** | åˆ†å±‚åè®®æ ˆå½¢å¼åŒ– |
| **Berkeley CS 294 äº‘è®¡ç®—** | Microservices, Saga æ¨¡å¼ |
| **Stanford CS 240 ç³»ç»Ÿè®¾è®¡** | Event-Driven, Space-Based |
| **TU Eindhoven æ¶æ„åˆ†æ** | Alloy/UPPAAL éªŒè¯ |

---

## å¿«é€Ÿå‚è€ƒ

### æ ¸å¿ƒæ¨¡å¼

```text
Layered: å•å‘ä¾èµ–å±‚æ¬¡
Pipes & Filters: æ•°æ®æµç®¡é“
Microkernel: æ ¸å¿ƒ + æ’ä»¶
Microservices: åˆ†å¸ƒå¼æœåŠ¡ç½‘æ ¼
Event-Driven: å‘å¸ƒ-è®¢é˜…
Space-Based: åˆ†å¸ƒå¼å…±äº«å†…å­˜
```

### å½¢å¼åŒ–å·¥å…·

```bash
# mCRL2ï¼ˆè¿›ç¨‹ä»£æ•°ï¼‰
mcrl22lps pattern.mcrl2 | lps2lts -v

# UPPAALï¼ˆå®æ—¶è‡ªåŠ¨æœºï¼‰
verifyta model.xml query.q

# TLA+ï¼ˆåˆ†å¸ƒå¼ç³»ç»Ÿï¼‰
tlc spec.tla

# SPINï¼ˆæ¨¡å‹æ£€æµ‹ï¼‰
spin -a spec.pml && gcc -o pan pan.c && ./pan
```

### å®æˆ˜å»ºè®®

1. **èµ·æ­¥**ï¼šLayeredï¼ˆæœ€ç®€å•ï¼‰
2. **è¿›é˜¶**ï¼šMicrokernelï¼ˆEclipse/VSCodeï¼‰
3. **åˆ†å¸ƒå¼**ï¼šMicroservices + Event-Driven
4. **æç«¯æ€§èƒ½**ï¼šSpace-Basedï¼ˆæ…ç”¨ï¼‰

---

## é™„å½• Aï¼šWikipedia æ¦‚å¿µå¯¹ç…§

| æ¦‚å¿µ | Wikipedia æ¡ç›® | æœ¬æ–‡ç« èŠ‚ |
|------|----------------|----------|
| Layered Architecture | <https://en.wikipedia.org/wiki/Multitier_architecture> | Â§1 |
| Pipes and Filters | <https://en.wikipedia.org/wiki/Pipeline_(software)> | Â§2 |
| Microkernel | <https://en.wikipedia.org/wiki/Microkernel> | Â§3 |
| Microservices | <https://en.wikipedia.org/wiki/Microservices> | Â§4 |
| Event-Driven Architecture | <https://en.wikipedia.org/wiki/Event-driven_architecture> | Â§5 |
| Tuple Space | <https://en.wikipedia.org/wiki/Tuple_space> | Â§6 |

---

**ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2025-10-29  
**ç»´æŠ¤è€…**ï¼šFormalScience Project  
**è®¸å¯**ï¼šCC BY-SA 4.0
