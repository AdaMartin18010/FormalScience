# 2.3 Workflow Patterns

> **子主题编号**: 02.3
> **主题**: 程序算法视角

## 1 📊 核心概念深度分析

<details>
<summary><b>🔄🔬 点击展开：工作流模式核心洞察</b></summary>

**终极洞察**: 工作流=业务过程的形式化表达。Petri网（Petri Net）：工作流形式化的黄金标准，PN=⟨P,T,F,M₀⟩，Places（状态）+Transitions（动作）+Flow（流转）+Marking（标记）。经典工作流模式（van der Aalst 43个）：①控制流基础5个：Sequence（顺序）、Parallel Split（AND-分支）、Synchronization（AND-合并）、Exclusive Choice（XOR-分支）、Simple Merge（XOR-合并）②高级控制流：Multi-Choice（OR-分支）、Deferred Choice（延迟选择）、Cancel Activity（取消）③数据模式：Task Data、Block Data、Case Data④资源模式：Role-Based、Separation of Duties。形式化价值：①可达性分析（能否到达目标状态）②死锁检测（Soundness验证）③活性验证（所有任务最终完成）④公平性验证（资源均衡分配）。验证工具：ProM（过程挖掘）、WOFLAN（Soundness检查）、CPN Tools（着色Petri网）。应用：BPMN、UML活动图的形式化基础。关键：工作流模式将隐性业务逻辑显式化为可验证的数学模型。

</details>

---

## 📋 目录

- [工作流模式（Workflow Patterns）](#工作流模式workflow-patterns)
  - [1 📊 核心概念深度分析](#1--核心概念深度分析)
  - [📋 目录](#-目录)
  - [2 概述](#2-概述)
  - [1 . Petri 网基础](#1--petri-网基础)
    - [1.1 形式定义](#11-形式定义)
    - [1.2 基本性质](#12-基本性质)
  - [2 . 控制流模式（基础 5 种）](#2--控制流模式基础-5-种)
    - [2.1 Sequence（顺序）](#21-sequence顺序)
    - [2.2 Parallel Split（并行分支）](#22-parallel-split并行分支)
    - [2.3 Synchronization（同步）](#23-synchronization同步)
    - [2.4 Exclusive Choice（互斥选择 / XOR-Split）](#24-exclusive-choice互斥选择--xor-split)
    - [2.5 Simple Merge（简单合并 / XOR-Join）](#25-simple-merge简单合并--xor-join)
  - [3 . 高级控制流模式（15 种节选）](#3--高级控制流模式15-种节选)
    - [3.1 Multi-Choice（多选 / OR-Split）](#31-multi-choice多选--or-split)
    - [3.2 Structured Synchronizing Merge（结构化同步合并）](#32-structured-synchronizing-merge结构化同步合并)
    - [3.3 Multiple Instances without Synchronization](#33-multiple-instances-without-synchronization)
    - [3.4 Deferred Choice（延迟选择）](#34-deferred-choice延迟选择)
    - [3.5 Cancel Activity（取消活动）](#35-cancel-activity取消活动)
  - [4 . 完整示例：采购流程](#4--完整示例采购流程)
    - [4.1 流程描述](#41-流程描述)
    - [4.2 Petri 网建模](#42-petri-网建模)
    - [4.3 验证](#43-验证)
      - [1 死锁检查](#1-死锁检查)
      - [2 最终必达](#2-最终必达)
      - [3 互斥性](#3-互斥性)
  - [5 . 数据模式（节选 5 种）](#5--数据模式节选-5-种)
    - [5.1 Task Data（任务数据）](#51-task-data任务数据)
    - [5.2 Block Data（块数据）](#52-block-data块数据)
    - [5.3 Case Data（案例数据）](#53-case-data案例数据)
    - [5.4 Task to Task（任务间传递）](#54-task-to-task任务间传递)
    - [5.5 Environment to Task（环境输入）](#55-environment-to-task环境输入)
  - [6 . 资源模式（节选 5 种）](#6--资源模式节选-5-种)
    - [6.1 Direct Allocation（直接分配）](#61-direct-allocation直接分配)
    - [6.2 Role-Based Allocation（基于角色）](#62-role-based-allocation基于角色)
    - [6.3 Deferred Allocation（延迟分配）](#63-deferred-allocation延迟分配)
    - [6.4 Authorization（授权）](#64-authorization授权)
    - [6.5 Separation of Duties（职责分离）](#65-separation-of-duties职责分离)
  - [7 . 工具链](#7--工具链)
    - [7.1 Petri 网建模与验证工具](#71-petri-网建模与验证工具)
    - [7.2 BPMN 到 Petri 网转换](#72-bpmn-到-petri-网转换)
  - [8 . 形式化验证案例](#8--形式化验证案例)
    - [8.1 案例：审批流程](#81-案例审批流程)
  - [9 . 大学课程对应](#9--大学课程对应)
  - [10 . 国际标准对应](#10--国际标准对应)
  - [11 . 本地项目引用](#11--本地项目引用)
  - [12 . 总结](#12--总结)
    - [1 核心洞察](#1-核心洞察)
    - [12.2 工具链推荐](#122-工具链推荐)
    - [12.3 实战建议](#123-实战建议)
  - [13 附录 A：WfMC 43 种模式速查表](#13-附录-awfmc-43-种模式速查表)
    - [1 控制流模式（20 种）](#1-控制流模式20-种)
    - [13.2 数据模式（40 种，节选）](#132-数据模式40-种节选)
    - [13.3 资源模式（43 种，节选）](#133-资源模式43-种节选)
  - [14 附录 B：Petri 网可达图示例](#14-附录-bpetri-网可达图示例)
    - [1 Sequence 可达图](#1-sequence-可达图)
    - [14.2 Parallel Split 可达图](#142-parallel-split-可达图)
  - [15 附录 C：Wikipedia 概念对照](#15-附录-cwikipedia-概念对照)
  - [跨视角链接](#跨视角链接)

---

## 2 概述

**工作流模式**是业务流程管理（BPM）中常见的控制流、数据流和资源分配模式。**Workflow Management Coalition (WfMC)** 定义了 **43 个工作流模式**，涵盖：

1. **控制流模式**（20 种）：任务执行顺序
2. **数据模式**（40 种）：数据在任务间传递
3. **资源模式**（43 种）：人员/设备分配

本文聚焦**控制流模式**，用 **Petri 网**形式化，并通过 **模型检测**验证性质（死锁自由、有界性、活性）。

**核心洞察**：

```text
工作流模式 = 可点燃的 Petri 网

验证 = 状态空间探索 + CTL 性质检查
```

---

## 1 Petri 网基础

### 1.1 形式定义

```text
Petri 网 N = ⟨P, T, F, W, M₀⟩

其中：
  P   : 库所集合（Place，圆圈）
  T   : 变迁集合（Transition，方框）
  F   : 流关系 F ⊆ (P×T) ∪ (T×P)
  W   : 弧权重 W: F → ℕ⁺
  M₀  : 初始标识（Marking）M₀: P → ℕ
```

**点火规则**：

```text
变迁 t 使能（enabled）⟺ ∀p ∈ •t, M(p) ≥ W(p,t)

点火后：
  M'(p) = M(p) - W(p,t) + W(t,p)
```

### 1.2 基本性质

| 性质 | CTL 公式 | 说明 |
|------|----------|------|
| **死锁自由** | `AG EX true` | 任何状态都有后继 |
| **有界性** | `AG (∀p. M(p) ≤ k)` | 托肯数不超过 k |
| **活性** | `AG EF M(p_final)` | 总能到达最终状态 |
| **可逆性** | `AG EF M₀` | 总能回到初始状态 |

---

## 2 控制流模式（基础 5 种）

### 2.1 Sequence（顺序）

**定义**：任务按顺序执行，前一个完成后才能开始下一个。

**Petri 网**：

```text
Place:  start → A → B → end
Marking: [1, 0, 0, 0]

Transitions:
  t₁: start → A
  t₂: A → B
  t₃: B → end
```

**形式化定义**（Tina 格式）：

```text
# Sequence.net
pl start, A, B, end
tr t1 : start -> A
tr t2 : A -> B
tr t3 : B -> end
m0 start:1
```

**验证**：

```bash
tina -ctl Sequence.net -f "AG !deadlock"
# 输出：TRUE
```

**性质**：

```text
定理（线性时间）：
  执行时间 T = T_A + T_B

定理（确定性）：
  只有一条执行路径
```

---

### 2.2 Parallel Split（并行分支）

**定义**：一个任务完成后，多个任务**同时启动**。

**Petri 网**：

```text
Place:  start → split → A
                      ↘ B

Transition:
  t_split: start → A ∧ B  (一次点火产生 2 个托肯)
```

**形式化定义**：

```text
# Parallel_Split.net
pl start, A, B
tr t_split : start -> {A, B}  # 多输出弧
m0 start:1
```

**mCRL2 形式化**：

```mcrl2
proc Split = start . (A | B);  % | 表示并行组合

init Split;
```

**验证**：

```bash
mcrl22lps parallel_split.mcrl2 | lps2lts -v
# 输出：2 个并发状态
```

**性质**：

```text
定理（并行度）：
  Span = max(T_A, T_B)
  Work = T_A + T_B

定理（并发状态数）：
  |Reach| = 2^n  （n 为并行任务数）
```

---

### 2.3 Synchronization（同步）

**定义**：多个任务必须**全部完成**后，才能启动下一个任务。

**Petri 网**：

```text
Place:  A → sync
        B → sync → C

Transition:
  t_sync: {A, B} → C  (需要 2 个托肯才能点火)
```

**形式化定义**：

```text
# Synchronization.net
pl A, B, C
tr t_sync : {A, B} -> C  # 多输入弧
m0 A:1 B:1
```

**性质**：

```text
定理（同步屏障）：
  只有当 M(A) ≥ 1 ∧ M(B) ≥ 1 时，t_sync 才能点火

定理（关键路径）：
  总时间 = max(到达A的时间, 到达B的时间) + T_C
```

---

### 2.4 Exclusive Choice（互斥选择 / XOR-Split）

**定义**：根据条件选择**一条**分支执行。

**Petri 网**：

```text
Place:  start → choice ⇉ A
                       ⇉ B

Transitions:
  t_A: choice → A  (条件 cond_A)
  t_B: choice → B  (条件 cond_B)

  约束：cond_A ∧ cond_B = false
```

**颜色 Petri 网（CPN）**：

```text
colset COND = with condA | condB;
var c : COND;

Place choice: COND;

tr t_A: choice(condA) -> A
tr t_B: choice(condB) -> B
```

**性质**：

```text
定理（互斥性）：
  ∀执行，到达 A ⊕ 到达 B（异或）

定理（非确定性）：
  若条件重叠，则存在多条路径
```

---

### 2.5 Simple Merge（简单合并 / XOR-Join）

**定义**：多条分支**任意一条**到达即继续。

**Petri 网**：

```text
Place:  A → merge → end
        B → merge

Transition:
  t_merge: A ∨ B → end
```

**注意**：若 A 和 B **同时**到达，`t_merge` 会点火**两次**（可能不是期望行为）。

**改进**（加互斥保护）：

```text
使用 Token-Ring 或 Mutex Place 防止重复点火
```

---

## 3 高级控制流模式（15 种节选）

### 3.1 Multi-Choice（多选 / OR-Split）

**定义**：根据条件选择**一个或多个**分支。

**Petri 网**：

```text
tr t_A: start -> A  if cond_A
tr t_B: start -> B  if cond_B
tr t_C: start -> C  if cond_C

可能同时点火多个变迁（非确定性）
```

### 3.2 Structured Synchronizing Merge（结构化同步合并）

**定义**：根据前面的 Multi-Choice，**动态**决定需要等待几个分支。

**实现**：需要**颜色 Petri 网**或**高级同步**机制。

### 3.3 Multiple Instances without Synchronization

**定义**：对每个数据项启动一个任务实例，**不等待**它们完成。

**Petri 网**：

```text
foreach item in list:
  create_token(process_item, item)
```

### 3.4 Deferred Choice（延迟选择）

**定义**：由**环境**（如用户输入）决定走哪条分支。

**实现**：用**计时器**或**外部事件**触发变迁。

### 3.5 Cancel Activity（取消活动）

**定义**：中途取消某个活动。

**Petri 网**：

```text
添加 "cancel" 变迁，直接清空目标 Place 的托肯
```

---

## 4 完整示例：采购流程

### 4.1 流程描述

```text
1. 提交采购申请
2. 并行审批：
   - 部门经理审批
   - 财务审批
3. 同步：两者都通过
4. 选择：
   - 金额 < 10000：自动采购
   - 金额 ≥ 10000：总经理审批 → 采购
5. 完成
```

### 4.2 Petri 网建模

```text
# Purchase.net
pl submit, mgr_review, fin_review, sync, decide, auto_buy, ceo_review, buy, done

tr t1: submit -> {mgr_review, fin_review}  # 并行分支
tr t2: {mgr_review, fin_review} -> sync     # 同步
tr t3: sync -> decide

# 互斥选择
tr t_auto: decide -> auto_buy  if amount < 10000
tr t_ceo: decide -> ceo_review if amount >= 10000

tr t4: auto_buy -> buy
tr t5: ceo_review -> buy
tr t6: buy -> done

m0 submit:1
```

### 4.3 验证

#### 1 死锁检查

```bash
tina -ctl Purchase.net -f "AG !deadlock"
```

#### 2 最终必达

```text
AG EF done
```

#### 3 互斥性

```text
AG !(auto_buy=1 ∧ ceo_review=1)
```

---

## 5 数据模式（节选 5 种）

### 5.1 Task Data（任务数据）

**定义**：数据仅在单个任务内可见。

### 5.2 Block Data（块数据）

**定义**：数据在子流程内共享。

### 5.3 Case Data（案例数据）

**定义**：数据在整个流程实例中共享。

### 5.4 Task to Task（任务间传递）

**Petri 网实现**：用**颜色**或**托肯携带数据**。

**CPN Tools 示例**：

```text
colset DATA = int;
var x : DATA;

tr t1: A(x) -> B(x+1)
```

### 5.5 Environment to Task（环境输入）

**实现**：外部事件触发，托肯携带输入数据。

---

## 6 资源模式（节选 5 种）

### 6.1 Direct Allocation（直接分配）

**定义**：任务指定特定资源（如用户）。

### 6.2 Role-Based Allocation（基于角色）

**定义**：任务分配给满足角色条件的资源。

### 6.3 Deferred Allocation（延迟分配）

**定义**：任务启动时才分配资源。

### 6.4 Authorization（授权）

**定义**：资源需要权限才能执行任务。

### 6.5 Separation of Duties（职责分离）

**定义**：同一流程的某些任务**不能**由同一资源执行。

**Petri 网扩展**：

```text
添加 "resource token"，带标识符
约束：t₁ 和 t₂ 的 resource token 必须不同
```

---

## 7 工具链

### 7.1 Petri 网建模与验证工具

| 工具 | 类型 | 特点 | 安装命令 |
|------|------|------|----------|
| **Tina** | P/T 网 | 轻量、CTL 模型检测 | `apt install tina` |
| **CPN Tools** | 颜色网 | GUI、仿真、性能分析 | `docker pull cpntools/cpntools` |
| **mCRL2** | 进程代数 | LTS 生成、μ-演算 | `brew install mcrl2` |
| **LoLA** | P/T 网 | 状态方程、线性代数 | <https://theo.informatik.uni-rostock.de/theo-forschung/tools/lola/> |
| **PIPE** | P/T 网 | Java GUI | <https://pipe2.sourceforge.net/> |

### 7.2 BPMN 到 Petri 网转换

```bash
# 使用 ProM 工具链
java -jar ProM.jar -f bpmn2pn.xml input.bpmn output.pnml
```

---

## 8 形式化验证案例

### 8.1 案例：审批流程

**需求**：

1. 申请 → 审批 → 执行
2. 审批可拒绝 → 返回申请
3. 执行后必须归档

**Petri 网**：

```text
pl apply, review, approved, rejected, execute, archive

tr t_submit: apply -> review
tr t_approve: review -> approved
tr t_reject: review -> rejected
tr t_rework: rejected -> apply
tr t_exec: approved -> execute
tr t_archive: execute -> archive
```

**验证性质**：

```text
1. 死锁自由：AG EX true  ✓
2. 必达归档：AG EF archive  ✓
3. 拒绝后可重做：AG (rejected -> EF apply)  ✓
```

**mCRL2 验证**：

```mcrl2
proc Approval =
  submit . (approve . execute . archive
           + reject . Approval);

init Approval;
```

```bash
mcrl22lps approval.mcrl2 | lps2lts -v | ltsconvert -eliveness
# 输出：No deadlocks, all paths reach archive
```

---

## 9 大学课程对应

| 课程 | 相关章节 |
|------|----------|
| **TU Eindhoven BPM** | 全部 43 种工作流模式 |
| **ETH Zürich Formal Methods** | Petri 网模型检测 |
| **CMU 17-355 Software Architecture** | 流程建模 |
| **UC Berkeley CS 294 Workflow Systems** | BPMN、YAWL |

---

## 10 国际标准对应

| 标准 | 内容 | 本文对应 |
|------|------|----------|
| **BPMN 2.0** (ISO/IEC 19510) | 业务流程建模符号 | 控制流模式 |
| **WS-BPEL 2.0** | Web 服务编排 | 数据流模式 |
| **XPDL 2.2** | 流程定义交换 | 全部模式 |
| **Petri Net Markup Language (PNML)** | Petri 网交换格式 | 形式化模型 |

---

## 11 本地项目引用

- `02.1_GoF_Formal_Analysis.md` - 设计模式的形式化（行为模式可用 Petri 网）
- `02.2_Distributed_Patterns.md` - Saga 可用 Petri 网建模
- `../03_Algorithm_Complexity/03.1_Multidimensional_Complexity.md` - 工作流的复杂度分析
- `../05_Formal_Verification/05.2_Model_Checking_Tools.md` - Petri 网模型检测工具

---

## 12 总结

### 1 核心洞察

```text
工作流模式 = 可重用的流程片段

形式化 = Petri 网 + CTL 性质

验证 = 状态空间探索 + 模型检测

控制流 5 大基础模式：
  Sequence    → 串行
  Parallel    → 并行
  Sync        → 同步
  XOR-Split   → 互斥选择
  XOR-Join    → 简单合并
```

### 12.2 工具链推荐

| 场景 | 推荐工具 |
|------|----------|
| **快速验证** | Tina + CTL |
| **性能分析** | CPN Tools |
| **工业 BPMN** | Camunda + ProM |
| **学术研究** | mCRL2 |

### 12.3 实战建议

1. **建模**：先用 BPMN 画流程图，再转 Petri 网
2. **验证**：用 Tina 快速检查死锁，用 CPN Tools 深度仿真
3. **优化**：用状态空间大小指导流程简化
4. **工业化**：用 Camunda/Activiti 引擎执行 BPMN

---

## 13 附录 A：WfMC 43 种模式速查表

### 1 控制流模式（20 种）

| ID | 名称 | Petri 网特征 |
|----|------|-------------|
| 1 | Sequence | 单链 |
| 2 | Parallel Split | 多输出弧 |
| 3 | Synchronization | 多输入弧 |
| 4 | Exclusive Choice | 条件分支 |
| 5 | Simple Merge | 单输入弧 |
| 6 | Multi-Choice | OR-Split |
| 7 | Structured Synchronizing Merge | 动态 Join |
| 8 | Multi-Merge | 多次触发 |
| 9 | Discriminator | 首个到达即触发 |
| 10 | Arbitrary Cycles | 任意循环 |
| 11-20 | ... | （高级模式，见 WfMC 官网） |

### 13.2 数据模式（40 种，节选）

| ID | 名称 | 实现方式 |
|----|------|----------|
| 1 | Task Data | 局部变量 |
| 2 | Block Data | 作用域 |
| 9 | Task to Task | 托肯携带数据 |
| 12 | Case to Case | 全局变量 |

### 13.3 资源模式（43 种，节选）

| ID | 名称 | 实现方式 |
|----|------|----------|
| 1 | Direct Allocation | 固定资源 ID |
| 2 | Role-Based | 资源类型标签 |
| 8 | Separation of Duties | 约束检查 |

---

## 14 附录 B：Petri 网可达图示例

### 1 Sequence 可达图

```text
M₀ = [start:1, A:0, B:0, end:0]
  ↓ t₁
M₁ = [start:0, A:1, B:0, end:0]
  ↓ t₂
M₂ = [start:0, A:0, B:1, end:0]
  ↓ t₃
M₃ = [start:0, A:0, B:0, end:1]
```

状态数：4

### 14.2 Parallel Split 可达图

```text
M₀ = [start:1, A:0, B:0]
  ↓ t_split
M₁ = [start:0, A:1, B:1]
```

并发：A 和 B 可任意顺序完成

---

## 15 附录 C：Wikipedia 概念对照

| 概念 | Wikipedia 条目 | 本文章节 |
|------|----------------|----------|
| Petri Net | <https://en.wikipedia.org/wiki/Petri_net> | §1 |
| Workflow Patterns | <https://en.wikipedia.org/wiki/Workflow_patterns> | §2-6 |
| BPMN | <https://en.wikipedia.org/wiki/Business_Process_Model_and_Notation> | §7 |
| Model Checking | <https://en.wikipedia.org/wiki/Model_checking> | §8 |
| Reachability Graph | <https://en.wikipedia.org/wiki/Reachability> | 附录B |

---

**版本**：v1.0
**最后更新**：2025-10-29
**维护者**：FormalScience Project
**许可**：CC BY-SA 4.0

---

## 跨视角链接

- [FormalLanguage_Perspective](../../FormalLanguage_Perspective/README.md)
- [Software_Perspective](../../Software_Perspective/README.md)
- [概念交叉索引（七视角版）](../../CONCEPT_CROSS_INDEX.md) - 查看相关概念的七视角分析：
  - [Chomsky层级](../../CONCEPT_CROSS_INDEX.md#51-chomsky层级-chomsky-hierarchy-七视角) - 工作流模式的形式语言基础
  - [图灵完备性](../../CONCEPT_CROSS_INDEX.md#191-图灵完备性-turing-completeness-七视角) - 工作流系统的计算能力
  - [停机问题](../../CONCEPT_CROSS_INDEX.md#102-停机问题-halting-problem-七视角) - 工作流的终止性验证
