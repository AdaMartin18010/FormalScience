# 04.4 è·¨å±‚éªŒè¯æ–¹æ³• (Cross-Layer Verification Methods)

## 1 ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>ğŸ”—ğŸ”¬ ç‚¹å‡»å±•å¼€ï¼šè·¨å±‚éªŒè¯æ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: è·¨å±‚éªŒè¯=ç«¯åˆ°ç«¯æ­£ç¡®æ€§çš„ä¿è¯ã€‚å•å±‚éªŒè¯ä¸å¤Ÿï¼Œéœ€è¦éªŒè¯å±‚é—´ç²¾åŒ–ï¼ˆRefinementï¼‰å…³ç³»ï¼šé«˜å±‚è§„çº¦åœ¨ä½å±‚å®ç°ä¸­ä¿æŒæ€§è´¨ã€‚ä¸‰ç±»è·¨å±‚éªŒè¯ï¼šâ‘ å‚ç›´ç²¾åŒ–éªŒè¯ï¼šè¯æ˜å®ç°æ»¡è¶³è§„çº¦ï¼Œå¦‚Cä»£ç â†’æ±‡ç¼–â†’æœºå™¨ç ä¿æŒè¯­ä¹‰â‘¡è·¨å±‚æ€§è´¨éªŒè¯ï¼šç«¯åˆ°ç«¯æ€§è´¨åœ¨æ‰€æœ‰å±‚ä¿æŒï¼Œå¦‚å®‰å…¨æ€§ä»éœ€æ±‚ä¼ æ’­åˆ°å®ç°â‘¢ååŒéªŒè¯ï¼šå¤šå±‚è”åˆéªŒè¯ï¼Œæ¶ˆé™¤å±‚é—´ç¼éš™ã€‚ç»å…¸æ¡ˆä¾‹ï¼šâ‘ seL4å¾®å†…æ ¸ï¼šä¸‰å±‚è§„çº¦ï¼ˆæŠ½è±¡è§„çº¦â†’å¯æ‰§è¡Œè§„çº¦â†’Cå®ç°â†’äºŒè¿›åˆ¶ï¼‰ï¼Œç”¨Isabelle/HOLè¯æ˜æ¯å±‚ç²¾åŒ–â‘¡CompCertç¼–è¯‘å™¨ï¼š8å±‚ç¼–è¯‘é˜¶æ®µï¼Œæ¯å±‚è¯­ä¹‰ä¿æŒï¼ŒCoqå…¨ç¨‹éªŒè¯â‘¢Amazon S3ï¼šAPIè§„çº¦â†’åˆ†å¸ƒå¼åè®®â†’å­˜å‚¨å®ç°ï¼ŒTLA+éªŒè¯ä¸€è‡´æ€§ã€‚ç²¾åŒ–å…³ç³»å½¢å¼åŒ–ï¼šè‹¥âˆ€è¡Œä¸ºb. å®ç°âŠ¨b â‡’ è§„çº¦âŠ¨bï¼Œåˆ™å®ç°ç²¾åŒ–è§„çº¦ã€‚æŒ‘æˆ˜ï¼šâ‘ æŠ½è±¡å±‚æ¬¡è·¨åº¦å¤§â‘¡çŠ¶æ€ç©ºé—´çˆ†ç‚¸â‘¢äººå·¥è¯æ˜æˆæœ¬ã€‚è‡ªåŠ¨åŒ–æ¡†æ¶ï¼šBoogie/Dafnyï¼ˆè‡ªåŠ¨éªŒè¯é“¾ï¼‰ã€Why3ï¼ˆå¤šåç«¯è¯æ˜å™¨ï¼‰ã€‚å…³é”®ï¼šè·¨å±‚éªŒè¯æ¶ˆé™¤æ¶æ„å±‚æ¬¡ä¹‹é—´çš„è¯­ä¹‰ç¼éš™ï¼Œæ˜¯é«˜ä¿éšœç³»ç»Ÿçš„å¿…è¦æ¡ä»¶ã€‚

</details>

---

## ğŸ“‹ ç›®å½•

- [04.4 è·¨å±‚éªŒè¯æ–¹æ³• (Cross-Layer Verification Methods)](#044-è·¨å±‚éªŒè¯æ–¹æ³•-cross-layer-verification-methods)
  - [1 ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ](#1--æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [1 . å¼•è¨€ (Introduction)](#1--å¼•è¨€-introduction)
    - [1.1 è·¨å±‚éªŒè¯çš„å¿…è¦æ€§](#11-è·¨å±‚éªŒè¯çš„å¿…è¦æ€§)
    - [1.2 å½¢å¼åŒ–æ¡†æ¶](#12-å½¢å¼åŒ–æ¡†æ¶)
  - [2 . äº”å±‚æ¶æ„æ¨¡å‹ (Five-Layer Architecture Model)](#2--äº”å±‚æ¶æ„æ¨¡å‹-five-layer-architecture-model)
    - [2.1 å±‚æ¬¡åˆ’åˆ†](#21-å±‚æ¬¡åˆ’åˆ†)
    - [2.2 å±‚é—´ç²¾åŒ–å…³ç³» (Refinement)](#22-å±‚é—´ç²¾åŒ–å…³ç³»-refinement)
  - [3 . è·¨å±‚éªŒè¯æŠ€æœ¯åˆ†ç±» (Verification Techniques)](#3--è·¨å±‚éªŒè¯æŠ€æœ¯åˆ†ç±»-verification-techniques)
    - [3.1 ç±»å‹Iï¼šå‚ç›´ç²¾åŒ–éªŒè¯ (Vertical Refinement)](#31-ç±»å‹iå‚ç›´ç²¾åŒ–éªŒè¯-vertical-refinement)
      - [3.1.1 ä¸šåŠ¡æµç¨‹ â†’ æœåŠ¡ç¼–æ’ (L5 â†’ L4)](#311-ä¸šåŠ¡æµç¨‹--æœåŠ¡ç¼–æ’-l5--l4)
      - [3.1.2 API è§„èŒƒ â†’ ä»£ç å®ç° (L4 â†’ L2)](#312-api-è§„èŒƒ--ä»£ç å®ç°-l4--l2)
      - [3.1.3 è½¯ä»¶ â†’ ç¡¬ä»¶ (L2 â†’ L1)](#313-è½¯ä»¶--ç¡¬ä»¶-l2--l1)
    - [3.2 ç±»å‹IIï¼šè·¨å±‚æ€§è´¨éªŒè¯ (Cross-Layer Property)](#32-ç±»å‹iiè·¨å±‚æ€§è´¨éªŒè¯-cross-layer-property)
      - [3.2.1 ç«¯åˆ°ç«¯æ—¶å»¶éªŒè¯ (End-to-End Latency)](#321-ç«¯åˆ°ç«¯æ—¶å»¶éªŒè¯-end-to-end-latency)
      - [3.2.2 å®‰å…¨å±æ€§ä¼ é€’ (Security Property Propagation)](#322-å®‰å…¨å±æ€§ä¼ é€’-security-property-propagation)
    - [3.3 ç±»å‹IIIï¼šååŒéªŒè¯ (Co-Verification)](#33-ç±»å‹iiiååŒéªŒè¯-co-verification)
      - [3.3.1 è½¯ç¡¬ä»¶ååŒä»¿çœŸ (HW/SW Co-Simulation)](#331-è½¯ç¡¬ä»¶ååŒä»¿çœŸ-hwsw-co-simulation)
      - [3.3.2 å½¢å¼åŒ–ååŒéªŒè¯ (Formal Co-Verification)](#332-å½¢å¼åŒ–ååŒéªŒè¯-formal-co-verification)
  - [4 . å·¥ä¸šæ¡ˆä¾‹ç ”ç©¶ (Industrial Case Studies)](#4--å·¥ä¸šæ¡ˆä¾‹ç ”ç©¶-industrial-case-studies)
    - [4.1 seL4 å¾®å†…æ ¸ï¼šL2 (Cä»£ç ) â†’ L1 (æœºå™¨ç )](#41-sel4-å¾®å†…æ ¸l2-cä»£ç --l1-æœºå™¨ç )
    - [4.2 CompCert ç¼–è¯‘å™¨ï¼šè·¨8å±‚ç²¾åŒ–](#42-compcert-ç¼–è¯‘å™¨è·¨8å±‚ç²¾åŒ–)
    - [4.3 Amazon S3: API (L4) â†’ åˆ†å¸ƒå¼å­˜å‚¨ (L2)](#43-amazon-s3-api-l4--åˆ†å¸ƒå¼å­˜å‚¨-l2)
  - [5 . è‡ªåŠ¨åŒ–è·¨å±‚éªŒè¯æ¡†æ¶ (Automated Framework)](#5--è‡ªåŠ¨åŒ–è·¨å±‚éªŒè¯æ¡†æ¶-automated-framework)
    - [5.1 æ¶æ„](#51-æ¶æ„)
    - [5.2 å·¥å…·é›†æˆç¤ºä¾‹](#52-å·¥å…·é›†æˆç¤ºä¾‹)
  - [6 . æŒ‘æˆ˜ä¸å¼€æ”¾é—®é¢˜ (Challenges)](#6--æŒ‘æˆ˜ä¸å¼€æ”¾é—®é¢˜-challenges)
    - [6.1 è¯­ä¹‰é¸¿æ²Ÿ (Semantic Gap)](#61-è¯­ä¹‰é¸¿æ²Ÿ-semantic-gap)
    - [6.2 å·¥å…·é“¾ç¢ç‰‡åŒ– (Tool Fragmentation)](#62-å·¥å…·é“¾ç¢ç‰‡åŒ–-tool-fragmentation)
    - [6.3 å¯æ‰©å±•æ€§ (Scalability)](#63-å¯æ‰©å±•æ€§-scalability)
  - [7 . å¤§å­¦è¯¾ç¨‹æ˜ å°„ (University Course Alignment)](#7--å¤§å­¦è¯¾ç¨‹æ˜ å°„-university-course-alignment)
  - [8 . å·¥å…·æ¨è (Tool Recommendations)](#8--å·¥å…·æ¨è-tool-recommendations)
  - [9 . æœ€ä½³å®è·µ (Best Practices)](#9--æœ€ä½³å®è·µ-best-practices)
    - [9.1 è®¾è®¡é˜¶æ®µï¼šæ˜ç¡®ç²¾åŒ–ç­–ç•¥](#91-è®¾è®¡é˜¶æ®µæ˜ç¡®ç²¾åŒ–ç­–ç•¥)
    - [9.2 å¼€å‘é˜¶æ®µï¼šæŒç»­éªŒè¯](#92-å¼€å‘é˜¶æ®µæŒç»­éªŒè¯)
    - [9.3 æ¼”è¿›é˜¶æ®µï¼šç‰ˆæœ¬å…¼å®¹æ€§](#93-æ¼”è¿›é˜¶æ®µç‰ˆæœ¬å…¼å®¹æ€§)
  - [10 . æ€»ç»“ (Summary)](#10--æ€»ç»“-summary)
  - [11 . æ‰©å±•é˜…è¯» (Further Reading)](#11--æ‰©å±•é˜…è¯»-further-reading)
  - [12 . æœ¬åœ°é¡¹ç›®äº¤å‰å¼•ç”¨ (Cross-References)](#12--æœ¬åœ°é¡¹ç›®äº¤å‰å¼•ç”¨-cross-references)
  - [è·¨è§†è§’é“¾æ¥](#è·¨è§†è§’é“¾æ¥)

---

## 1 . å¼•è¨€ (Introduction)

### 1.1 è·¨å±‚éªŒè¯çš„å¿…è¦æ€§

ç°ä»£è½¯ä»¶ç³»ç»Ÿé€šå¸¸é‡‡ç”¨**å¤šå±‚æ¶æ„**ï¼ˆå¦‚ä¸šåŠ¡å±‚ã€ä¼ä¸šæœåŠ¡å±‚ã€ä¿¡æ¯å±‚ã€è½¯ä»¶å±‚ã€ç¡¬ä»¶å±‚ï¼‰ï¼Œæ¯ä¸€å±‚éƒ½æœ‰å„è‡ªçš„æŠ½è±¡å’Œçº¦æŸã€‚ä¼ ç»Ÿçš„éªŒè¯æ–¹æ³•å¾€å¾€å±€é™äºå•å±‚å†…éƒ¨ï¼ˆå¦‚ä»…éªŒè¯ä»£ç å±‚çš„ç±»å‹å®‰å…¨ï¼Œæˆ–ä»…éªŒè¯ç¡¬ä»¶å±‚çš„æ—¶åºçº¦æŸï¼‰ï¼Œä½†**å±‚ä¸å±‚ä¹‹é—´çš„äº¤äº’**åŒæ ·å¯èƒ½å¼•å‘é”™è¯¯ï¼š

- **è¯­ä¹‰é¸¿æ²Ÿ**ï¼šé«˜å±‚ä¸šåŠ¡é€»è¾‘åœ¨åº•å±‚å®ç°æ—¶è¯­ä¹‰å¯èƒ½å¤±çœŸ
- **æ€§èƒ½ä¿è¯ä¼ é€’**ï¼šä¸Šå±‚çš„æ€§èƒ½è¦æ±‚èƒ½å¦åœ¨åº•å±‚å¾—åˆ°æ»¡è¶³ï¼Ÿ
- **å®‰å…¨å±æ€§ä¿æŒ**ï¼šåŠ å¯†ç®—æ³•åœ¨ç¡¬ä»¶å®ç°æ—¶æ˜¯å¦å¼•å…¥ä¾§ä¿¡é“æ³„æ¼ï¼Ÿ

**è·¨å±‚éªŒè¯ (Cross-Layer Verification)** æ—¨åœ¨å»ºç«‹ä»é«˜å±‚è§„èŒƒåˆ°åº•å±‚å®ç°çš„**ç«¯åˆ°ç«¯æ­£ç¡®æ€§ä¿è¯**ã€‚

### 1.2 å½¢å¼åŒ–æ¡†æ¶

è·¨å±‚éªŒè¯ç³»ç»Ÿå¯å»ºæ¨¡ä¸ºï¼š

```text
CrossLayerSystem = âŸ¨Lâ‚, Lâ‚‚, ..., Lâ‚™, R, Ï†âŸ©

å…¶ä¸­ï¼š
- Láµ¢        : ç¬¬ i å±‚çš„å½¢å¼åŒ–æ¨¡å‹ï¼ˆä¾‹å¦‚ Lâ‚ = ä¸šåŠ¡é€»è¾‘ï¼ŒLâ‚™ = æœºå™¨ç ï¼‰
- R âŠ† Láµ¢ Ã— Láµ¢â‚Šâ‚ : å±‚é—´ç²¾åŒ–å…³ç³» (Refinement Relation)
- Ï†         : å…¨å±€æ€§è´¨ï¼ˆå¦‚ç«¯åˆ°ç«¯å»¶è¿Ÿ < 100msï¼‰

éªŒè¯ç›®æ ‡ï¼š
  âˆ€i âˆˆ [1, n-1] : Láµ¢â‚Šâ‚ âŠ‘ Láµ¢  (ç²¾åŒ–)
  âˆ§ Lâ‚™ âŠ¨ Ï†                    (åº•å±‚æ»¡è¶³æ€§è´¨)
  â‡’ Lâ‚ âŠ¨ Ï†                    (é«˜å±‚æ€§è´¨æˆç«‹)
```

---

## 2 . äº”å±‚æ¶æ„æ¨¡å‹ (Five-Layer Architecture Model)

### 2.1 å±‚æ¬¡åˆ’åˆ†

| å±‚ | åç§° | å…³æ³¨ç‚¹ | å½¢å¼åŒ–å·¥å…· |
|----|------|--------|-----------|
| **L5** | ä¸šåŠ¡å±‚ (Business Layer) | ä¸šåŠ¡æµç¨‹ã€ç­–ç•¥ | BPMN, UML Activity Diagram |
| **L4** | ä¼ä¸šæœåŠ¡å±‚ (Enterprise Layer) | æœåŠ¡ç»„åˆã€API | OpenAPI, WSDL |
| **L3** | ä¿¡æ¯å±‚ (Information Layer) | æ•°æ®æ¨¡å‹ã€çº¦æŸ | ER Diagram, Z Notation |
| **L2** | è½¯ä»¶å±‚ (Software Layer) | ä»£ç å®ç°ã€ç®—æ³• | Hoare Logic, Type Systems |
| **L1** | ç¡¬ä»¶å±‚ (Hardware Layer) | æŒ‡ä»¤é›†ã€ç”µè·¯ | RTL Verification, Model Checking |

### 2.2 å±‚é—´ç²¾åŒ–å…³ç³» (Refinement)

**ç²¾åŒ– (Refinement)** ä¿è¯ä¸‹å±‚å®ç°ä¸ä¸Šå±‚è§„èŒƒçš„ä¸€è‡´æ€§ï¼š

```text
Láµ¢â‚Šâ‚ âŠ‘ Láµ¢  âŸº  âˆ€ observable behavior b :
                 (Láµ¢â‚Šâ‚ exhibits b) â‡’ (Láµ¢ allows b)
```

**ç¤ºä¾‹**ï¼š

- **ä¸šåŠ¡å±‚è§„èŒƒ**ï¼š"è®¢å•æ”¯ä»˜åå¿…é¡»å‘è´§"
- **è½¯ä»¶å±‚å®ç°**ï¼š`if (order.isPaid()) { shipOrder(order); }`
- **éªŒè¯**ï¼šè¯æ˜ä»£ç è¡Œä¸ºç²¾åŒ–ä¸šåŠ¡è§„èŒƒ

---

## 3 . è·¨å±‚éªŒè¯æŠ€æœ¯åˆ†ç±» (Verification Techniques)

### 3.1 ç±»å‹Iï¼šå‚ç›´ç²¾åŒ–éªŒè¯ (Vertical Refinement)

**ç›®æ ‡**ï¼šè¯æ˜æ¯ç›¸é‚»ä¸¤å±‚æ»¡è¶³ç²¾åŒ–å…³ç³»ã€‚

#### 3.1.1 ä¸šåŠ¡æµç¨‹ â†’ æœåŠ¡ç¼–æ’ (L5 â†’ L4)

**å·¥å…·**ï¼šPetri Net + Model Checking

**ç¤ºä¾‹**ï¼šç”µå•†è®¢å•æµç¨‹

**ä¸šåŠ¡å±‚ (BPMN)**ï¼š

```text
[ä¸‹å•] â†’ [æ”¯ä»˜] â†’ [å‘è´§] â†’ [å®Œæˆ]
           â”‚
           â””â”€[è¶…æ—¶]â”€> [å–æ¶ˆ]
```

**æœåŠ¡å±‚ (WS-BPEL)**ï¼š

```xml
<sequence>
  <invoke name="createOrder" />
  <pick>
    <onMessage name="paymentSuccess">
      <invoke name="shipOrder" />
    </onMessage>
    <onAlarm for="PT10M">
      <invoke name="cancelOrder" />
    </onAlarm>
  </pick>
</sequence>
```

**éªŒè¯**ï¼šå°† BPMN å’Œ BPEL åˆ†åˆ«è½¬æ¢ä¸º Petri Netï¼Œä½¿ç”¨ LoLA æ£€æŸ¥è¯­è¨€åŒ…å«å…³ç³»ï¼š

```bash
# å°† BPMN å¯¼å‡ºä¸º Petri Net (.pnml)
# å°† BPEL å¯¼å‡ºä¸º Petri Net
# æ£€æŸ¥ BPEL çš„è¡Œä¸ºæ˜¯å¦è¢« BPMN å…è®¸

lola bpmn_model.lola --formula="AG (paymentSuccess -> AF shipped)"
lola bpel_model.lola --formula="AG (paymentSuccess -> AF shipped)"
```

#### 3.1.2 API è§„èŒƒ â†’ ä»£ç å®ç° (L4 â†’ L2)

**å·¥å…·**ï¼šOpenAPI + Dafny / F*

**ç¤ºä¾‹**ï¼šæ”¯ä»˜API

**OpenAPI è§„èŒƒ** (`payment.yaml`):

```yaml
paths:
  /payments:
    post:
      requestBody:
        content:
          application/json:
            schema:
              properties:
                amount:
                  type: number
                  minimum: 0.01
              required:
                - amount
      responses:
        '200':
          description: Payment successful
        '400':
          description: Invalid amount
```

**Dafny å®ç°**ï¼š

```dafny
method ProcessPayment(amount: real) returns (success: bool)
  requires amount > 0.0  // OpenAPI çº¦æŸè½¬æ¢ä¸ºå‰ç½®æ¡ä»¶
  ensures success ==> amount > 0.0
{
  if amount <= 0.0 {
    return false;  // 400 Bad Request
  }
  // å¤„ç†æ”¯ä»˜é€»è¾‘
  return true;
}
```

**è‡ªåŠ¨åŒ–éªŒè¯æµç¨‹**ï¼š

```python
# ä½¿ç”¨ openapi-to-dafny å·¥å…·ï¼ˆå‡æƒ³ï¼‰è‡ªåŠ¨ç”Ÿæˆ Dafny è§„èŒƒ
import yaml
from openapi_to_dafny import convert

with open("payment.yaml") as f:
    spec = yaml.safe_load(f)

dafny_spec = convert(spec)
# è¾“å‡ºï¼š
# method ProcessPayment(amount: real) returns (...)
#   requires amount >= 0.01
#   ...
```

#### 3.1.3 è½¯ä»¶ â†’ ç¡¬ä»¶ (L2 â†’ L1)

**åœºæ™¯**ï¼šéªŒè¯å¯†ç ç®—æ³•çš„è½¯ä»¶å®ç°ä¸ç¡¬ä»¶åŠ é€Ÿå™¨çš„ä¸€è‡´æ€§ã€‚

**å·¥å…·**ï¼šCompCert + Verilog Model Checking

**ç¤ºä¾‹**ï¼šAES åŠ å¯†

**C å®ç°**ï¼š

```c
void aes_encrypt(uint8_t *plaintext, uint8_t *key, uint8_t *ciphertext) {
    // AES-128 åŠ å¯†å®ç°
    ...
}
```

**Verilog ç¡¬ä»¶å®ç°**ï¼š

```verilog
module aes_core(
    input [127:0] plaintext,
    input [127:0] key,
    output [127:0] ciphertext
);
    // AES ç¡¬ä»¶åŠ é€Ÿé€»è¾‘
endmodule
```

**éªŒè¯ç­–ç•¥**ï¼š

1. **è½¯ä»¶éªŒè¯**ï¼šä½¿ç”¨ Frama-C æˆ– Cryptol è¯æ˜ C ä»£ç æ»¡è¶³ AES è§„èŒƒ
2. **ç¡¬ä»¶éªŒè¯**ï¼šä½¿ç”¨ JasperGold è¯æ˜ Verilog ä¸ C æ¨¡å‹ç­‰ä»·ï¼ˆç¬¦å·æ‰§è¡Œï¼‰
3. **è”åˆéªŒè¯**ï¼šä½¿ç”¨ SAW (Software Analysis Workbench) å»ºç«‹ C â†” Verilog ç­‰ä»·æ€§

**SAW ç¤ºä¾‹**ï¼š

```cryptol
-- Cryptol è§„èŒƒ
aes_spec : [128] -> [128] -> [128]
aes_spec plaintext key = encrypt plaintext key

-- SAW éªŒè¯è„šæœ¬
let verify_aes = do {
    c_impl <- llvm_load_module "aes.bc";
    verilog_impl <- verilog_load_module "aes_core.v";

    llvm_verify c_impl "aes_encrypt" [] (cryptol_spec {{ aes_spec }});
    verilog_verify verilog_impl "aes_core" (cryptol_spec {{ aes_spec }});
};
```

---

### 3.2 ç±»å‹IIï¼šè·¨å±‚æ€§è´¨éªŒè¯ (Cross-Layer Property)

**ç›®æ ‡**ï¼šéªŒè¯å…¨å±€æ€§è´¨åœ¨æ‰€æœ‰å±‚çº§ä¿æŒï¼ˆå¦‚å®‰å…¨æ€§ã€æ€§èƒ½ï¼‰ã€‚

#### 3.2.1 ç«¯åˆ°ç«¯æ—¶å»¶éªŒè¯ (End-to-End Latency)

**é—®é¢˜**ï¼šä¸šåŠ¡å±‚è¦æ±‚"API å“åº”æ—¶é—´ < 500ms"ï¼Œå¦‚ä½•ä¿è¯åº•å±‚å®ç°æ»¡è¶³ï¼Ÿ

**å±‚çº§åˆ†è§£**ï¼š

```text
Total_Latency = L_network + L_application + L_database + L_hardware

ä¸šåŠ¡å±‚è§„èŒƒï¼šTotal_Latency < 500ms
â†“ åˆ†è§£ä¸ºå„å±‚çº¦æŸ
- L_network < 100ms       (ç½‘ç»œå±‚)
- L_application < 200ms   (åº”ç”¨å±‚)
- L_database < 150ms      (æ•°æ®åº“å±‚)
- L_hardware < 50ms       (ç¡¬ä»¶å±‚)
```

**éªŒè¯æ–¹æ³•**ï¼š

1. **åº”ç”¨å±‚**ï¼šä½¿ç”¨ UPPAAL å»ºæ¨¡åº”ç”¨é€»è¾‘ï¼ŒéªŒè¯æ‰§è¡Œè·¯å¾„çš„æœ€åæƒ…å†µæ—¶å»¶

    **UPPAAL æ¨¡å‹**ï¼š

    ```text
    process Application() {
      clock t;

      state Init, Processing, Done;

      Init -> Processing { t <= 200 }
      Processing -> Done { t >= 50 && t <= 200 }
    }

    // æŸ¥è¯¢ï¼šæ˜¯å¦å­˜åœ¨è·¯å¾„ä½¿å¾— t > 200ï¼Ÿ
    A[] Application.Done imply t <= 200
    ```

2. **æ•°æ®åº“å±‚**ï¼šä½¿ç”¨ SQL æŸ¥è¯¢åˆ†æå·¥å…·ï¼ˆå¦‚ `EXPLAIN ANALYZE`ï¼‰æµ‹é‡æŸ¥è¯¢æ—¶å»¶

    ```sql
    EXPLAIN ANALYZE
    SELECT * FROM orders WHERE customer_id = 123;

    -- è¾“å‡ºï¼šExecution Time: 85.3ms
    -- éªŒè¯ï¼š85.3ms < 150ms âœ“
    ```

3. **ç¡¬ä»¶å±‚**ï¼šä½¿ç”¨é™æ€æ—¶åºåˆ†æ (Static Timing Analysis, STA)

    ```bash
    # Synopsys PrimeTime
    report_timing -to [get_ports output] -max_paths 10
    # æ£€æŸ¥å…³é”®è·¯å¾„å»¶è¿Ÿ < 50ms
    ```

**ç»„åˆéªŒè¯**ï¼š

```python
# Python è„šæœ¬èšåˆå„å±‚éªŒè¯ç»“æœ
layer_bounds = {
    "network": 100,
    "application": 200,
    "database": 150,
    "hardware": 50
}

measured_latencies = {
    "network": 95,        # å®æµ‹
    "application": 180,   # UPPAAL éªŒè¯
    "database": 85,       # SQL EXPLAIN
    "hardware": 45        # STA æŠ¥å‘Š
}

total = sum(measured_latencies.values())
required = 500

print(f"Total Latency: {total}ms (Required: {required}ms)")
assert total <= required, "ç«¯åˆ°ç«¯å»¶è¿Ÿè¶…æ ‡ï¼"
```

#### 3.2.2 å®‰å…¨å±æ€§ä¼ é€’ (Security Property Propagation)

**åœºæ™¯**ï¼šä¸šåŠ¡å±‚è¦æ±‚"ç”¨æˆ·å¯†ç å¿…é¡»åŠ å¯†å­˜å‚¨"ï¼ŒéªŒè¯ä»APIåˆ°æ•°æ®åº“çš„å®ç°é“¾æ¡ã€‚

**å±‚çº§è¿½è¸ª**ï¼š

```text
L5 (ä¸šåŠ¡è§„èŒƒ): SecureStorage(password)
  â†“
L4 (APIå±‚): POST /users { password: "plain" } â†’ hash(password)
  â†“
L3 (æ•°æ®æ¨¡å‹): User.password_hash : String (NOT NULL)
  â†“
L2 (ä»£ç å®ç°): bcrypt.hash(password, salt)
  â†“
L1 (æ•°æ®åº“): INSERT INTO users (password_hash) VALUES ($1)
```

**éªŒè¯å·¥å…·é“¾**ï¼š

1. **APIå±‚**ï¼šä½¿ç”¨ OpenAPI + é™æ€åˆ†æå·¥å…·æ£€æŸ¥æ˜¯å¦è°ƒç”¨å“ˆå¸Œå‡½æ•°

    ```python
    # ä½¿ç”¨ Semgrep è§„åˆ™æ£€æµ‹æ˜æ–‡å­˜å‚¨
    rules:
      - id: plaintext-password-storage
        pattern: db.execute("INSERT INTO users (password) VALUES (?)", password)
        message: "å¯†ç åº”å…ˆå“ˆå¸Œå¤„ç†"
        severity: ERROR
    ```

2. **ä»£ç å±‚**ï¼šä½¿ç”¨ Dafny è¯æ˜å“ˆå¸Œå‡½æ•°ä¸å¯é€†

    ```dafny
    function Hash(password: string): string

    lemma HashIsOneWay(p1: string, p2: string)
      ensures Hash(p1) == Hash(p2) ==> p1 == p2  // å¼±ç¢°æ’æŠµæŠ—
    ```

3. **æ•°æ®åº“å±‚**ï¼šä½¿ç”¨æ•°æ®åº“å®¡è®¡å·¥å…·æ£€æŸ¥åˆ—çº¦æŸ

    ```sql
    -- PostgreSQL æ£€æŸ¥åˆ—çº¦æŸ
    SELECT column_name, data_type, is_nullable
    FROM information_schema.columns
    WHERE table_name = 'users' AND column_name = 'password_hash';

    -- ç¡®è®¤ï¼šNOT NULL, ä¸”ä¸å­˜åœ¨ 'password' åˆ—ï¼ˆæ˜æ–‡ï¼‰
    ```

**è‡ªåŠ¨åŒ–è·¨å±‚å®¡è®¡**ï¼š

```python
class SecurityAuditor:
    def verify_password_storage(self):
        # 1. æ£€æŸ¥ API è§„èŒƒ
        assert "password_hash" in api_spec["components"]["schemas"]["User"]["properties"]

        # 2. é™æ€åˆ†æä»£ç 
        result = subprocess.run(["semgrep", "--config=security.yml", "src/"], capture_output=True)
        assert result.returncode == 0, "å‘ç°å®‰å…¨æ¼æ´"

        # 3. æŸ¥è¯¢æ•°æ®åº“ schema
        cursor.execute("SELECT column_name FROM information_schema.columns WHERE table_name='users'")
        columns = [row[0] for row in cursor.fetchall()]
        assert "password" not in columns, "å­˜åœ¨æ˜æ–‡å¯†ç åˆ—"
        assert "password_hash" in columns, "ç¼ºå°‘å“ˆå¸Œåˆ—"

        print("âœ“ å¯†ç å­˜å‚¨éªŒè¯é€šè¿‡")
```

---

### 3.3 ç±»å‹IIIï¼šååŒéªŒè¯ (Co-Verification)

**ç›®æ ‡**ï¼šç¡¬ä»¶å’Œè½¯ä»¶ååŒå¼€å‘æ—¶çš„åŒæ­¥éªŒè¯ã€‚

#### 3.3.1 è½¯ç¡¬ä»¶ååŒä»¿çœŸ (HW/SW Co-Simulation)

**å·¥å…·**ï¼šQEMU + SystemC / Verilator

**åœºæ™¯**ï¼šåµŒå…¥å¼ç³»ç»ŸéªŒè¯ï¼ˆå¦‚è‡ªåŠ¨é©¾é©¶æ§åˆ¶å™¨ï¼‰

**æ¶æ„**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Software (C/C++)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Control Algorithm      â”‚    â”‚
â”‚  â”‚  (Compiled to ARM)      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚             â”‚ MMIO/Interrupts   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Hardware (Verilog)     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚  Sensor Interface â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  Motor Driver     â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**éªŒè¯æµç¨‹**ï¼š

1. **æ„å»ºè½¯ä»¶æ¨¡æ‹Ÿç¯å¢ƒ**ï¼š

    ```bash
    # ä½¿ç”¨ QEMU è¿è¡Œ ARM è½¯ä»¶
    qemu-system-arm -M vexpress-a9 -kernel control.elf -nographic \
      -device sensor-model,addr=0x40000000
    ```

2. **é›†æˆç¡¬ä»¶ä»¿çœŸå™¨**ï¼š

    ```cpp
    // SystemC ç¡¬ä»¶æ¨¡å‹
    SC_MODULE(SensorInterface) {
        sc_in<bool> clk;
        sc_out<uint32_t> sensor_data;

        void read_sensor() {
            // æ¨¡æ‹Ÿä¼ æ„Ÿå™¨è¯»å–
            sensor_data.write(read_physical_sensor());
        }

        SC_CTOR(SensorInterface) {
            SC_METHOD(read_sensor);
            sensitive << clk.pos();
        }
    };
    ```

3. **è”åˆæµ‹è¯•**ï¼š

    ```python
    # Python æµ‹è¯•è„šæœ¬
    def test_emergency_brake():
        # 1. å¯åŠ¨ååŒä»¿çœŸç¯å¢ƒ
        cosim = CoSimulation("qemu", "systemc")

        # 2. æ³¨å…¥æµ‹è¯•åœºæ™¯ï¼šéšœç¢ç‰©è·ç¦» < 5m
        cosim.inject_sensor_data(distance=4.5)

        # 3. è¿è¡Œ 100ms ä»¿çœŸæ—¶é—´
        cosim.run(duration_ms=100)

        # 4. æ£€æŸ¥è½¯ä»¶æ˜¯å¦è§¦å‘åˆ¹è½¦
        assert cosim.read_motor_signal() == "BRAKE", "æœªè§¦å‘ç´§æ€¥åˆ¹è½¦"

        # 5. æ£€æŸ¥ç¡¬ä»¶å“åº”å»¶è¿Ÿ < 10ms
        assert cosim.get_response_time() < 10, "ç¡¬ä»¶å“åº”å»¶è¿Ÿè¿‡é•¿"
    ```

#### 3.3.2 å½¢å¼åŒ–ååŒéªŒè¯ (Formal Co-Verification)

**å·¥å…·**ï¼šLem + Isabelle/HOL

**åœºæ™¯**ï¼šéªŒè¯å¤„ç†å™¨æŒ‡ä»¤é›†å®ç° (ISA)

**æ­¥éª¤**ï¼š

1. **å®šä¹‰æŒ‡ä»¤é›†è¯­ä¹‰** (Lem è§„èŒƒ)ï¼š

    ```lem
    type instruction =
      | ADD of register * register * register
      | LOAD of register * address
      | STORE of register * address

    val execute : instruction -> machine_state -> machine_state
    let execute instr state = match instr with
      | ADD rd rs1 rs2 ->
          let v1 = state.regs[rs1] in
          let v2 = state.regs[rs2] in
          { state with regs = state.regs[rd <- v1 + v2] }
      | ...
    ```

2. **å¯¼å‡ºåˆ° Isabelle/HOL å’Œ Verilog**ï¼š

    ```bash
    # Lem ç¼–è¯‘å™¨ç”Ÿæˆå¤šç›®æ ‡
    lem -isa isa_spec.lem -o isa.thy       # Isabelle ç†è®ºæ–‡ä»¶
    lem -verilog isa_spec.lem -o isa.v    # Verilog RTL
    ```

3. **è¯æ˜ä¸€è‡´æ€§**ï¼š

    ```isabelle
    theorem execute_correct:
      "âˆ€instr state.
        verilog_execute instr state = lem_execute instr state"
    proof
      (* ä½¿ç”¨ç¬¦å·æ‰§è¡Œæˆ–å½’çº³è¯æ˜ *)
    qed
    ```

---

## 4 . å·¥ä¸šæ¡ˆä¾‹ç ”ç©¶ (Industrial Case Studies)

### 4.1 seL4 å¾®å†…æ ¸ï¼šL2 (Cä»£ç ) â†’ L1 (æœºå™¨ç )

**æŒ‘æˆ˜**ï¼šéªŒè¯ C ä»£ç ç»è¿‡ç¼–è¯‘å™¨ä¼˜åŒ–åçš„äºŒè¿›åˆ¶ä»£ç ä»ä¿æŒåŠŸèƒ½æ­£ç¡®æ€§ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **C ä»£ç éªŒè¯**ï¼šä½¿ç”¨ Isabelle/HOL è¯æ˜ C å®ç°æ»¡è¶³æŠ½è±¡è§„èŒƒ
2. **ç¼–è¯‘å™¨éªŒè¯**ï¼šä½¿ç”¨ CompCert ä¿è¯ç¼–è¯‘è¿‡ç¨‹ä¿æŒè¯­ä¹‰
3. **äºŒè¿›åˆ¶éªŒè¯**ï¼šä½¿ç”¨ BAP (Binary Analysis Platform) æ£€æŸ¥ç”Ÿæˆçš„æ±‡ç¼–ä»£ç 

**éªŒè¯é“¾æ¡**ï¼š

```text
æŠ½è±¡è§„èŒƒ (Isabelle)
  â†“ ç²¾åŒ–
C ä»£ç  (Verified with Isabelle)
  â†“ CompCert ç¼–è¯‘
æ±‡ç¼–ä»£ç  (Verified with BAP)
  â†“ é“¾æ¥
äºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
```

**å…³é”®å®šç†**ï¼š

```isabelle
theorem binary_refinement:
  "âˆ€input output.
     (c_semantics input = output) âŸ¹
     (asm_semantics input = output)"
```

### 4.2 CompCert ç¼–è¯‘å™¨ï¼šè·¨8å±‚ç²¾åŒ–

**å±‚çº§**ï¼š

```text
L8: C æºä»£ç  (Clight)
L7: ç®€åŒ–è¡¨è¾¾å¼ (C#minor)
L6: ç§»é™¤å±€éƒ¨å˜é‡ (Cminor)
L5: å¯„å­˜å™¨ä¼ è¾“è¯­è¨€ (RTL)
L4: çº¿æ€§ä¼ è¾“è¯­è¨€ (LTL)
L3: çº¿æ€§æ±‡ç¼– (Linear)
L2: Mach (æŠ½è±¡æœºå™¨æŒ‡ä»¤)
L1: æ±‡ç¼–ä»£ç  (Asm)
```

**éªŒè¯**ï¼šæ¯ä¸¤å±‚ä¹‹é—´çš„ç¼–è¯‘é€šè¡Œè¯ (Pass) éƒ½æœ‰ç²¾åŒ–è¯æ˜

```coq
Theorem transf_program_correct:
  forall p tp,
    transf_program p = OK tp ->
    forward_simulation (semantics p) (semantics tp).
```

### 4.3 Amazon S3: API (L4) â†’ åˆ†å¸ƒå¼å­˜å‚¨ (L2)

**ä¸šåŠ¡è§„èŒƒ** (L5)ï¼š

- æ–‡ä»¶ä¸Šä¼ åå¯æŒä¹…è®¿é—®
- ä¸€è‡´æ€§æ¨¡å‹ï¼šæœ€ç»ˆä¸€è‡´æ€§

**API å±‚** (L4)ï¼š

- `PUT /bucket/key` è¿”å› 200 åï¼Œæ–‡ä»¶å¿…é¡»å¯æ£€ç´¢

**å­˜å‚¨å±‚** (L2)ï¼š

- æ–‡ä»¶åˆ†ç‰‡å­˜å‚¨åœ¨å¤šä¸ªèŠ‚ç‚¹
- ä½¿ç”¨ Quorum è¯»å†™ (W=2, R=2 in N=3)

**è·¨å±‚éªŒè¯**ï¼š

1. **ä½¿ç”¨ TLA+ å»ºæ¨¡åˆ†å¸ƒå¼å­˜å‚¨åè®®**ï¼š

    ```text
    VARIABLES nodes, file_replicas, client_view

    TypeInvariant ==
      /\ \A node \in nodes : node.state \in {"active", "failed"}
      /\ file_replicas \subseteq nodes

    ConsistencyProperty ==
      \A file :
        (client_view[file].status = "uploaded") =>
        (Cardinality({n \in nodes : file \in n.data}) >= 2)
    ```

2. **API å±‚æµ‹è¯•**ï¼šä½¿ç”¨ Chaos Engineering æ³¨å…¥æ•…éšœ

    ```python
    # Chaos Monkeyï¼šéšæœºç»ˆæ­¢å­˜å‚¨èŠ‚ç‚¹
    def test_upload_durability():
        # ä¸Šä¼ æ–‡ä»¶
        response = s3_client.put_object(Bucket='test', Key='file.txt', Body='data')
        assert response['ResponseMetadata']['HTTPStatusCode'] == 200

        # æ³¨å…¥æ•…éšœï¼šå…³é—­ 1 ä¸ªå­˜å‚¨èŠ‚ç‚¹
        chaos_monkey.kill_random_node()

        # éªŒè¯æ–‡ä»¶ä»å¯è¯»å–
        response = s3_client.get_object(Bucket='test', Key='file.txt')
        assert response['Body'].read() == b'data'
    ```

---

## 5 . è‡ªåŠ¨åŒ–è·¨å±‚éªŒè¯æ¡†æ¶ (Automated Framework)

### 5.1 æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Verification Orchestrator               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Layer L5  â”‚  â”‚ Layer L4  â”‚  â”‚ Layer L3  â”‚  ...       â”‚
â”‚  â”‚ (BPMN)    â”‚  â”‚ (OpenAPI) â”‚  â”‚ (Z)       â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
â”‚        â”‚              â”‚              â”‚                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                       â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Refinement Checker                    â”‚            â”‚
â”‚  â”‚   (Model Checker / Theorem Prover)      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                       â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   Property Tracker                      â”‚            â”‚
â”‚  â”‚   (è¿½è¸ªæ€§è´¨åœ¨å„å±‚çš„å®ç°)                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å·¥å…·é›†æˆç¤ºä¾‹

**é…ç½®æ–‡ä»¶** (`verification.yaml`):

```yaml
layers:
  - name: Business
    model: bpmn/order_process.bpmn
    tool: ProM
    properties:
      - "AG (payment_received -> AF order_shipped)"

  - name: Service
    model: openapi/payment_api.yaml
    tool: Dafny
    properties:
      - "amount > 0"

  - name: Code
    model: src/payment.py
    tool: Semgrep
    properties:
      - "no-plaintext-storage"

  - name: Database
    model: schema.sql
    tool: SQLCheck
    properties:
      - "password_hash NOT NULL"

refinement_checks:
  - layers: [Business, Service]
    method: trace_equivalence
  - layers: [Service, Code]
    method: contract_verification
  - layers: [Code, Database]
    method: schema_validation

global_properties:
  - "end_to_end_latency < 500ms"
  - "no_security_violations"
```

**æ‰§è¡Œè„šæœ¬** (Python):

```python
import yaml
import subprocess

def run_verification(config_file):
    with open(config_file) as f:
        config = yaml.safe_load(f)

    results = {}

    # 1. éªŒè¯æ¯ä¸€å±‚çš„å±€éƒ¨æ€§è´¨
    for layer in config['layers']:
        print(f"Verifying {layer['name']} layer...")
        tool = layer['tool']
        model = layer['model']

        if tool == "Dafny":
            result = subprocess.run(["dafny", "/compile:0", model], capture_output=True)
        elif tool == "Semgrep":
            result = subprocess.run(["semgrep", "--config=auto", model], capture_output=True)

        results[layer['name']] = (result.returncode == 0)

    # 2. æ£€æŸ¥å±‚é—´ç²¾åŒ–å…³ç³»
    for check in config['refinement_checks']:
        layers = check['layers']
        method = check['method']
        print(f"Checking refinement: {layers[0]} -> {layers[1]} ({method})")

        # è°ƒç”¨ä¸“ç”¨ç²¾åŒ–æ£€æŸ¥å™¨
        if method == "contract_verification":
            results[f"Refinement_{layers[0]}_{layers[1]}"] = verify_contract(layers)

    # 3. éªŒè¯å…¨å±€æ€§è´¨
    for prop in config['global_properties']:
        print(f"Verifying global property: {prop}")
        # èšåˆå„å±‚éªŒè¯ç»“æœ
        results[prop] = check_global_property(prop, results)

    # 4. ç”ŸæˆæŠ¥å‘Š
    generate_report(results)

def verify_contract(layers):
    # ç¤ºä¾‹ï¼šä» OpenAPI æå– requires/ensuresï¼Œä¸ä»£ç ä¸­çš„ assertions æ¯”å¯¹
    return True

def check_global_property(prop, results):
    if "latency" in prop:
        # èšåˆå„å±‚å»¶è¿Ÿæµ‹é‡
        return sum(latency_measurements.values()) < 500
    elif "security" in prop:
        return all(results[layer] for layer in ["Service", "Code", "Database"])

run_verification("verification.yaml")
```

---

## 6 . æŒ‘æˆ˜ä¸å¼€æ”¾é—®é¢˜ (Challenges)

### 6.1 è¯­ä¹‰é¸¿æ²Ÿ (Semantic Gap)

**é—®é¢˜**ï¼šé«˜å±‚æŠ½è±¡ï¼ˆå¦‚UMLï¼‰ä¸ä½å±‚å®ç°ï¼ˆå¦‚æ±‡ç¼–ï¼‰ä¹‹é—´è¯­ä¹‰æ˜ å°„å›°éš¾ã€‚

**ç°çŠ¶**ï¼š

- äººå·¥å®šä¹‰ç²¾åŒ–å…³ç³»ï¼ˆæˆæœ¬é«˜ï¼‰
- è‡ªåŠ¨æ¨æ–­ç²¾åŒ–æ˜ å°„ä»æ˜¯ç ”ç©¶çƒ­ç‚¹ï¼ˆæœºå™¨å­¦ä¹ è¾…åŠ©ï¼Ÿï¼‰

### 6.2 å·¥å…·é“¾ç¢ç‰‡åŒ– (Tool Fragmentation)

**é—®é¢˜**ï¼šä¸åŒå±‚ä½¿ç”¨ä¸åŒå·¥å…·ï¼ˆBPMN â†’ Petri Net â†’ Dafny â†’ Verilogï¼‰ï¼Œå·¥å…·é—´æ•°æ®äº¤æ¢å›°éš¾ã€‚

**è§£å†³æ–¹å‘**ï¼š

- ç»Ÿä¸€ä¸­é—´è¡¨ç¤º (Universal Intermediate Representation, UIR)
- æ ‡å‡†åŒ–éªŒè¯æ¥å£ï¼ˆå¦‚ OSLC - Open Services for Lifecycle Collaborationï¼‰

### 6.3 å¯æ‰©å±•æ€§ (Scalability)

**é—®é¢˜**ï¼šå¤§å‹ç³»ç»Ÿçš„è·¨å±‚éªŒè¯çŠ¶æ€ç©ºé—´çˆ†ç‚¸ã€‚

**ç¼“è§£ç­–ç•¥**ï¼š

- **æ¨¡å—åŒ–éªŒè¯**ï¼šåˆ†æ²»æ³•åˆ†åˆ«éªŒè¯å­ç³»ç»Ÿ
- **å‡è®¾-ä¿è¯æ¨ç†**ï¼šå±‚é—´åªéªŒè¯æ¥å£å¥‘çº¦
- **æŠ½è±¡è§£é‡Š**ï¼šä½¿ç”¨æŠ½è±¡åŸŸç®€åŒ–éªŒè¯

---

## 7 . å¤§å­¦è¯¾ç¨‹æ˜ å°„ (University Course Alignment)

| ä¸»é¢˜ | æ¨èè¯¾ç¨‹ | æ•™æ/èµ„æº |
|------|---------|----------|
| **ç²¾åŒ–ç†è®º** | å½¢å¼åŒ–æ–¹æ³• (Formal Methods) | _Refinement Calculus_ (Ralph-Johan Back) |
| **æ¨¡å‹æ£€æŸ¥** | è½¯ä»¶éªŒè¯ (Software Verification) | _Principles of Model Checking_ (Baier & Katoen) |
| **ååŒéªŒè¯** | åµŒå…¥å¼ç³»ç»Ÿ (Embedded Systems) | _HW/SW Co-Design_ (J. Teich) |
| **è½¯ä»¶æ¶æ„** | è½¯ä»¶å·¥ç¨‹ (Software Engineering) | _Software Architecture in Practice_ (Bass et al.) |
| **ç¼–è¯‘å™¨éªŒè¯** | ç¼–è¯‘åŸç† (Compilers) | _CompCert_ è®ºæ–‡é›† <https://compcert.org/papers/> |

---

## 8 . å·¥å…·æ¨è (Tool Recommendations)

| å·¥å…· | ç”¨é€” | å¼€æº | ç½‘å€ |
|------|------|------|------|
| **KeY** | Java ä»£ç  â†’ JML è§„èŒƒéªŒè¯ | âœ“ | <https://www.key-project.org> |
| **Frama-C** | C ä»£ç  â†’ ACSL è§„èŒƒéªŒè¯ | âœ“ | <https://frama-c.com> |
| **UPPAAL** | æ—¶å»¶åˆ†æï¼ˆè½¯ä»¶+ç¡¬ä»¶ï¼‰ | âœ“ | <https://uppaal.org> |
| **SAW** | è½¯ç¡¬ä»¶ç­‰ä»·æ€§éªŒè¯ | âœ“ | <https://saw.galois.com> |
| **TLA+** | åˆ†å¸ƒå¼ç³»ç»Ÿç²¾åŒ–éªŒè¯ | âœ“ | <https://lamport.azurewebsites.net/tla/tla.html> |
| **CompCert** | ç¼–è¯‘å™¨æ­£ç¡®æ€§ | éƒ¨åˆ† | <https://compcert.org> |
| **ArchUnit** | æ¶æ„çº¦æŸæ£€æŸ¥ (Java) | âœ“ | <https://www.archunit.org> |
| **ProM** | ä¸šåŠ¡æµç¨‹æŒ–æ˜+éªŒè¯ | âœ“ | <https://www.promtools.org> |

---

## 9 . æœ€ä½³å®è·µ (Best Practices)

### 9.1 è®¾è®¡é˜¶æ®µï¼šæ˜ç¡®ç²¾åŒ–ç­–ç•¥

- **è‡ªé¡¶å‘ä¸‹**ï¼šä»ä¸šåŠ¡è§„èŒƒå¼€å§‹ï¼Œé€å±‚ç»†åŒ–å¹¶è®°å½•ç²¾åŒ–å…³ç³»
- **å¥‘çº¦é©±åŠ¨**ï¼šåœ¨å±‚é—´æ¥å£å®šä¹‰ Pre/Post æ¡ä»¶

**ç¤ºä¾‹**ï¼šAPI è®¾è®¡æ—¶åŒæ­¥ç¼–å†™ OpenAPI è§„èŒƒå’Œ Dafny å¥‘çº¦

```yaml
# OpenAPI
paths:
  /transfer:
    post:
      parameters:
        - name: amount
          schema:
            type: number
            minimum: 0.01
```

```dafny
// Dafny å®ç°
method Transfer(amount: real) returns (success: bool)
  requires amount > 0.0  // ä» OpenAPI è‡ªåŠ¨ç”Ÿæˆ
```

### 9.2 å¼€å‘é˜¶æ®µï¼šæŒç»­éªŒè¯

- **CI/CD é›†æˆ**ï¼šæ¯æ¬¡æäº¤è§¦å‘è·¨å±‚éªŒè¯

```yaml
# GitHub Actions
name: Cross-Layer Verification
on: [push]
jobs:
  verify:
    steps:
      - run: dafny /compile:0 src/*.dfy
      - run: semgrep --config=security src/
      - run: python verify_refinement.py
```

### 9.3 æ¼”è¿›é˜¶æ®µï¼šç‰ˆæœ¬å…¼å®¹æ€§

- **è§„èŒƒç‰ˆæœ¬åŒ–**ï¼šä½¿ç”¨è¯­ä¹‰ç‰ˆæœ¬å·ç®¡ç†å±‚é—´å¥‘çº¦
- **å‘åå…¼å®¹æ€§æµ‹è¯•**ï¼šæ–°ç‰ˆæœ¬å¿…é¡»é€šè¿‡æ—§ç‰ˆæœ¬çš„éªŒè¯æµ‹è¯•

---

## 10 . æ€»ç»“ (Summary)

è·¨å±‚éªŒè¯æ˜¯æ„å»ºå¯ä¿¡è½¯ä»¶ç³»ç»Ÿçš„å…³é”®ï¼Œæ ¸å¿ƒè¦ç´ åŒ…æ‹¬ï¼š

1. **ç²¾åŒ–å…³ç³»**ï¼šæ˜ç¡®å±‚é—´çš„è¯­ä¹‰æ˜ å°„
2. **æ€§è´¨ä¼ é€’**ï¼šä¿è¯å…¨å±€æ€§è´¨åœ¨å„å±‚ä¿æŒ
3. **å·¥å…·é“¾é›†æˆ**ï¼šè‡ªåŠ¨åŒ–éªŒè¯æµç¨‹
4. **æ¡ˆä¾‹é©±åŠ¨**ï¼šä»å·¥ä¸šå®è·µä¸­æç‚¼æ–¹æ³•

**é€‚ç”¨åœºæ™¯**ï¼š

- å…³é”®åŸºç¡€è®¾æ–½ï¼ˆèˆªç©ºã€åŒ»ç–—ã€é‡‘èï¼‰
- å®‰å…¨æ•æ„Ÿç³»ç»Ÿï¼ˆå¯†ç å­¦ã€æ“ä½œç³»ç»Ÿï¼‰
- é«˜æ€§èƒ½è®¡ç®—ï¼ˆHPCã€å®æ—¶ç³»ç»Ÿï¼‰

**æœªæ¥æ–¹å‘**ï¼š

- AI è¾…åŠ©ç²¾åŒ–æ¨æ–­
- äº‘åŸç”Ÿæ¶æ„çš„è·¨å±‚éªŒè¯
- é‡å­-ç»å…¸æ··åˆç³»ç»ŸéªŒè¯

---

## 11 . æ‰©å±•é˜…è¯» (Further Reading)

1. **Refinement Calculus** - Ralph-Johan Back & Joakim von Wright
   <https://www.springer.com/gp/book/9780387984179>

2. **seL4 Verification Papers**
   <https://sel4.systems/Info/FAQ/proof.pml>

3. **CompCert: A Formally Verified Optimizing Compiler** - Xavier Leroy
   <https://xavierleroy.org/publi/compcert-CACM.pdf>

4. **Cross-Layer Optimization in Wireless Networks** - IEEE Survey
   <https://ieeexplore.ieee.org/document/1630566>

5. **TLA+ in Practice: Specifying and Checking Software** - Hillel Wayne
   <https://learntla.com>

---

## 12 . æœ¬åœ°é¡¹ç›®äº¤å‰å¼•ç”¨ (Cross-References)

- **æ¶æ„æ¦‚è§ˆ**ï¼š[[04.0_Architecture_Overview.md]] - äº”å±‚æ¶æ„æ¨¡å‹è¯¦è§£
- **å½¢å¼åŒ–éªŒè¯**ï¼š[[05_Formal_Verification/]] - å„å±‚éªŒè¯å·¥å…·è¯¦è§£
- **å¤æ‚æ€§ç†è®º**ï¼š[[03.1_Multidimensional_Complexity.md]] - æ€§èƒ½åˆ†ææ–¹æ³•
- **å¾®æœåŠ¡æ¶æ„**ï¼š[[04.2_Microservices_Architecture.md]] - æœåŠ¡å±‚éªŒè¯æ¡ˆä¾‹

---

**ç‰ˆæœ¬ä¿¡æ¯**ï¼š

- åˆ›å»ºæ—¥æœŸï¼š2025-10-29
- æœ€åæ›´æ–°ï¼š2025-10-29
- ç»´æŠ¤è€…ï¼šProgram-Algorithm-Design Perspective Team

---

## è·¨è§†è§’é“¾æ¥

- [FormalLanguage_Perspective](../../FormalLanguage_Perspective/README.md)
- [Software_Perspective](../../Software_Perspective/README.md)
- [æ¦‚å¿µäº¤å‰ç´¢å¼•ï¼ˆä¸ƒè§†è§’ç‰ˆï¼‰](../../CONCEPT_CROSS_INDEX.md) - æŸ¥çœ‹ç›¸å…³æ¦‚å¿µçš„ä¸ƒè§†è§’åˆ†æï¼š
  - [GÃ¶delä¸å®Œå¤‡å®šç†](../../CONCEPT_CROSS_INDEX.md#101-gÃ¶delä¸å®Œå¤‡å®šç†-gÃ¶dels-incompleteness-theorems-ä¸ƒè§†è§’) - è·¨å±‚éªŒè¯çš„ç†è®ºé™åˆ¶
  - [åœæœºé—®é¢˜](../../CONCEPT_CROSS_INDEX.md#102-åœæœºé—®é¢˜-halting-problem-ä¸ƒè§†è§’) - å±‚é—´ç²¾åŒ–çš„ç»ˆæ­¢æ€§åˆ¤å®š
  - [åèº«æ€§](../../CONCEPT_CROSS_INDEX.md#31-åèº«æ€§-reflexivity-ä¸ƒè§†è§’) - è·¨å±‚éªŒè¯ç³»ç»Ÿåœ¨å…ƒå±‚çº§æ“ä½œè‡ªèº«çš„èƒ½åŠ›
