# 4.4 GitOps å£°æ˜å¼ä¿®å¤

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
> **æœ€åæ›´æ–°**: 2025-10-27
> **æ–‡æ¡£è§„æ¨¡**: 839è¡Œ | GitOpsä¸å£°æ˜å¼è¿ç»´
> **é˜…è¯»å»ºè®®**: æœ¬æ–‡è¯¦è§£GitOpså·¥ä½œæµå’ŒArgo CDï¼Œæ˜¯å®ç°åŸºç¡€è®¾æ–½å³ä»£ç çš„å®æˆ˜æŒ‡å—

---

## ğŸ“‹ ç›®å½•

- [1 æ ¸å¿ƒå®šä¹‰](#1-æ ¸å¿ƒå®šä¹‰)
- [2 ä¸ºä»€ä¹ˆéœ€è¦ GitOps](#2-ä¸ºä»€ä¹ˆéœ€è¦-gitops)
  - [2.1 ä¼ ç»Ÿéƒ¨ç½²çš„é—®é¢˜](#21-ä¼ ç»Ÿéƒ¨ç½²çš„é—®é¢˜)
  - [2.2 GitOps è§£å†³æ–¹æ¡ˆ](#22-gitops-è§£å†³æ–¹æ¡ˆ)
- [3 GitOps æ¶æ„](#3-gitops-æ¶æ„)
  - [3.1 æ ¸å¿ƒç»„ä»¶](#31-æ ¸å¿ƒç»„ä»¶)
- [4 ArgoCD æ·±åº¦è§£æ](#4-argocd-æ·±åº¦è§£æ)
  - [4.1 å®‰è£…](#41-å®‰è£…)
  - [4.2 åˆ›å»º Application](#42-åˆ›å»º-application)
  - [4.3 è‡ªåŠ¨ä¿®å¤æ¼”ç¤º](#43-è‡ªåŠ¨ä¿®å¤æ¼”ç¤º)
- [5 å£°æ˜å¼ä¿®å¤ç­–ç•¥](#5-å£°æ˜å¼ä¿®å¤ç­–ç•¥)
  - [5.1 ç­–ç•¥ 1ï¼šåŸºäº Git æäº¤çš„å›æ»š](#51-ç­–ç•¥-1åŸºäº-git-æäº¤çš„å›æ»š)
  - [5.2 ç­–ç•¥ 2ï¼šåŸºäº Metric çš„è‡ªåŠ¨å›æ»š](#52-ç­–ç•¥-2åŸºäº-metric-çš„è‡ªåŠ¨å›æ»š)
  - [5.3 ç­–ç•¥ 3ï¼šåŸºäº OTLP çš„æ™ºèƒ½ä¿®å¤](#53-ç­–ç•¥-3åŸºäº-otlp-çš„æ™ºèƒ½ä¿®å¤)
- [6 Kustomize å¤šç¯å¢ƒç®¡ç†](#6-kustomize-å¤šç¯å¢ƒç®¡ç†)
- [7 é‡‘ä¸é›€å‘å¸ƒ GitOps](#7-é‡‘ä¸é›€å‘å¸ƒ-gitops)
- [8 GitOps æœ€ä½³å®è·µ](#8-gitops-æœ€ä½³å®è·µ)
  - [8.1 å•ä¸€ Git ä»“åº“ vs å¤š Git ä»“åº“](#81-å•ä¸€-git-ä»“åº“-vs-å¤š-git-ä»“åº“)
  - [8.2 Git åˆ†æ”¯ç­–ç•¥](#82-git-åˆ†æ”¯ç­–ç•¥)
  - [8.3 Secrets ç®¡ç†](#83-secrets-ç®¡ç†)
    - [3.3.1 æ­£ç¡®æ–¹æ³• 1ï¼šSealed Secrets](#331-æ­£ç¡®æ–¹æ³•-1sealed-secrets)
    - [3.3.2 æ­£ç¡®æ–¹æ³• 2ï¼šExternal Secrets Operator](#332-æ­£ç¡®æ–¹æ³•-2external-secrets-operator)
  - [8.4 å®¡è®¡ä¸åˆè§„](#84-å®¡è®¡ä¸åˆè§„)
- [9 å…³é”®æ´å¯Ÿ](#9-å…³é”®æ´å¯Ÿ)
  - [9.1 æ´å¯Ÿ 1ï¼šGit æ˜¯æ—¶é—´æœºå™¨](#91-æ´å¯Ÿ-1git-æ˜¯æ—¶é—´æœºå™¨)
  - [9.2 æ´å¯Ÿ 2ï¼šå£°æ˜å¼ å‘½ä»¤å¼](#92-æ´å¯Ÿ-2å£°æ˜å¼-å‘½ä»¤å¼)
  - [9.3 æ´å¯Ÿ 3ï¼šè‡ªåŠ¨åŒ– å¯é æ€§](#93-æ´å¯Ÿ-3è‡ªåŠ¨åŒ–-å¯é æ€§)
  - [9.4 GitOpsèµ·æºä¸å®šä¹‰](#94-gitopsèµ·æºä¸å®šä¹‰)
  - [9.5 æ ¸å¿ƒå·¥å…·](#95-æ ¸å¿ƒå·¥å…·)
  - [9.6 å­¦æœ¯ä¸å·¥ä¸šç™½çš®ä¹¦](#96-å­¦æœ¯ä¸å·¥ä¸šç™½çš®ä¹¦)
  - [9.7 ä¼ä¸šå®è·µæ¡ˆä¾‹](#97-ä¼ä¸šå®è·µæ¡ˆä¾‹)
  - [9.8 æ ‡å‡†ä¸è§„èŒƒ](#98-æ ‡å‡†ä¸è§„èŒƒ)
  - [9.9 Helmä¸Kustomize](#99-helmä¸kustomize)
  - [9.10 Gitå·¥ä½œæµç†è®º](#910-gitå·¥ä½œæµç†è®º)
  - [9.11 å£°æ˜å¼åŸºç¡€è®¾æ–½](#911-å£°æ˜å¼åŸºç¡€è®¾æ–½)
  - [9.12 å®‰å…¨ä¸åˆè§„](#912-å®‰å…¨ä¸åˆè§„)
  - [9.13 åœ¨çº¿èµ„æº](#913-åœ¨çº¿èµ„æº)
  - [9.14 éªŒè¯ä¸é‡‡ç”¨ç»Ÿè®¡æˆªè‡³2025-10-27](#914-éªŒè¯ä¸é‡‡ç”¨ç»Ÿè®¡æˆªè‡³2025-10-27)
- [10 ç›¸å…³ä¸»é¢˜](#10-ç›¸å…³ä¸»é¢˜)

---


## 2 æ ¸å¿ƒå®šä¹‰

**GitOps**ï¼šä½¿ç”¨ Git ä½œä¸º**å•ä¸€äº‹å®æ¥æºï¼ˆSingle Source of Truthï¼‰**ï¼Œé€šè¿‡å£°æ˜å¼é…ç½®å’Œè‡ªåŠ¨åŒæ­¥å®ç°åŸºç¡€è®¾æ–½å’Œåº”ç”¨çš„ç®¡ç†ã€‚

**å£°æ˜å¼ä¿®å¤ï¼ˆDeclarative Remediationï¼‰**ï¼šç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹å®é™…çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€çš„åå·®ï¼Œå¹¶è‡ªåŠ¨ä¿®å¤ï¼Œæ— éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

## 3 ä¸ºä»€ä¹ˆéœ€è¦ GitOps

### 3.1 ä¼ ç»Ÿéƒ¨ç½²çš„é—®é¢˜

```text
å‘½ä»¤å¼éƒ¨ç½²ï¼š
1. SSH åˆ°æœåŠ¡å™¨
2. æ‰§è¡Œå‘½ä»¤ï¼škubectl apply -f deployment.yaml
3. æ‰‹åŠ¨éªŒè¯
4. è®°å½•åˆ°æ–‡æ¡£

é—®é¢˜ï¼š
âŒ æ— ç‰ˆæœ¬å†å²ï¼ˆä¸çŸ¥é“è°æ”¹äº†ä»€ä¹ˆï¼‰
âŒ æ— æ³•å›æ»šï¼ˆä¸çŸ¥é“ä¹‹å‰æ˜¯ä»€ä¹ˆçŠ¶æ€ï¼‰
âŒ éš¾ä»¥å®¡è®¡ï¼ˆæ— æ³•è¿½æº¯ï¼‰
âŒ ç¯å¢ƒä¸ä¸€è‡´ï¼ˆdev/staging/prod é…ç½®å„å¼‚ï¼‰
âŒ æ— æ³•è‡ªåŠ¨ä¿®å¤ï¼ˆéœ€è¦äººå·¥ä»‹å…¥ï¼‰
```

### 3.2 GitOps è§£å†³æ–¹æ¡ˆ

```text
å£°æ˜å¼é…ç½® + Gitï¼š
1. æ‰€æœ‰é…ç½®å­˜åœ¨ Git ä»“åº“
2. ä¿®æ”¹ = Pull Request
3. åˆå¹¶ = è‡ªåŠ¨éƒ¨ç½²
4. åå·® = è‡ªåŠ¨ä¿®å¤

ä¼˜ç‚¹ï¼š
âœ… å®Œæ•´å†å²ï¼ˆGit logï¼‰
âœ… è½»æ¾å›æ»šï¼ˆGit revertï¼‰
âœ… è‡ªåŠ¨å®¡è®¡ï¼ˆPR + Mergeï¼‰
âœ… ç¯å¢ƒä¸€è‡´ï¼ˆæ‰€æœ‰ç¯å¢ƒç”¨åŒä¸€å¥—é…ç½®ï¼Œä»…å‚æ•°ä¸åŒï¼‰
âœ… è‡ªåŠ¨ä¿®å¤ï¼ˆæŒç»­åŒæ­¥ï¼‰
```

---

## 4 GitOps æ¶æ„

### 4.1 æ ¸å¿ƒç»„ä»¶

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Git Repository (Single Source of Truth)      â”‚
â”‚  â”œâ”€â”€ manifests/                               â”‚
â”‚  â”‚   â”œâ”€â”€ deployment.yaml                      â”‚
â”‚  â”‚   â”œâ”€â”€ service.yaml                         â”‚
â”‚  â”‚   â””â”€â”€ configmap.yaml                       â”‚
â”‚  â””â”€â”€ kustomize/                               â”‚
â”‚      â”œâ”€â”€ base/                                â”‚
â”‚      â””â”€â”€ overlays/                            â”‚
â”‚          â”œâ”€â”€ dev/                             â”‚
â”‚          â”œâ”€â”€ staging/                         â”‚
â”‚          â””â”€â”€ prod/                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†‘       â”‚
         Pull    â”‚       â”‚ Webhook (optional)
                 â”‚       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitOps Operator (ArgoCD / Flux)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  1. å®šæœŸ Pull Git ä»“åº“ (every 3 min)     â”‚ â”‚
â”‚  â”‚  2. å¯¹æ¯”æœŸæœ›çŠ¶æ€ vs å®é™…çŠ¶æ€             â”‚ â”‚
â”‚  â”‚  3. æ£€æµ‹åˆ°åå·® â†’ è‡ªåŠ¨åŒæ­¥               â”‚ â”‚
â”‚  â”‚  4. éªŒè¯åŒæ­¥æˆåŠŸ                         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes Cluster                            â”‚
â”‚  - Deployment (3 replicas)                    â”‚
â”‚  - Service (ClusterIP)                        â”‚
â”‚  - ConfigMap (app config)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5 ArgoCD æ·±åº¦è§£æ

### 5.1 å®‰è£…

```bash
# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace argocd

# å®‰è£… ArgoCD
kubectl apply -n argocd -f \
  https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# æš´éœ² UI
kubectl port-forward svc/argocd-server -n argocd 8080:443

# è·å–åˆå§‹å¯†ç 
argocd admin initial-password -n argocd
```

### 5.2 åˆ›å»º Application

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-app
  namespace: argocd
spec:
  # Git ä»“åº“
  source:
    repoURL: https://github.com/myorg/myapp-config.git
    targetRevision: main
    path: manifests/prod

    # Kustomize é…ç½®ï¼ˆå¯é€‰ï¼‰
    kustomize:
      images:
      - myapp:v1.2.0

  # ç›®æ ‡é›†ç¾¤
  destination:
    server: https://kubernetes.default.svc
    namespace: production

  # åŒæ­¥ç­–ç•¥
  syncPolicy:
    automated:
      prune: true        # åˆ é™¤ Git ä¸­ä¸å­˜åœ¨çš„èµ„æº
      selfHeal: true     # è‡ªåŠ¨ä¿®å¤åå·®
      allowEmpty: false  # ä¸å…è®¸ç©ºéƒ¨ç½²

    syncOptions:
    - CreateNamespace=true  # è‡ªåŠ¨åˆ›å»ºå‘½åç©ºé—´
    - PruneLast=true        # æœ€ååˆ é™¤èµ„æº

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
```

### 5.3 è‡ªåŠ¨ä¿®å¤æ¼”ç¤º

**åœºæ™¯**ï¼šäººå·¥ä¿®æ”¹äº†å‰¯æœ¬æ•°

```bash
# Git ä¸­çš„é…ç½®ï¼šreplicas: 3
cat manifests/prod/deployment.yaml
---
spec:
  replicas: 3

# äººå·¥ä¿®æ”¹ï¼ˆæ¨¡æ‹Ÿæ‰‹åŠ¨æ‰©å®¹æˆ–æ•…éšœï¼‰
kubectl scale deployment my-app --replicas=5

# 30 ç§’åï¼ŒArgoCD æ£€æµ‹åˆ°åå·®
kubectl get deployment my-app
NAME     READY   UP-TO-DATE   AVAILABLE
my-app   5/3     3            5          # æ£€æµ‹åˆ° 5 ä¸ªï¼ŒæœŸæœ› 3 ä¸ª

# åˆè¿‡ 30 ç§’ï¼ŒArgoCD è‡ªåŠ¨ä¿®å¤
kubectl get deployment my-app
NAME     READY   UP-TO-DATE   AVAILABLE
my-app   3/3     3            3          # æ¢å¤åˆ° 3 ä¸ª
```

**ArgoCD æ—¥å¿—**ï¼š

```text
2025-10-27 10:23:45  INFO  Detected drift: deployment.apps/my-app replicas 5 != 3
2025-10-27 10:24:15  INFO  Auto-healing: syncing application my-app
2025-10-27 10:24:16  INFO  Sync successful: deployment.apps/my-app scaled to 3
```

---

## 6 å£°æ˜å¼ä¿®å¤ç­–ç•¥

### 6.1 ç­–ç•¥ 1ï¼šåŸºäº Git æäº¤çš„å›æ»š

**è‡ªåŠ¨å›æ»šæµç¨‹**ï¼š

```yaml
# ArgoCD Application with Auto-Rollback
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: my-app
spec:
  source:
    repoURL: https://github.com/myorg/myapp-config.git
    targetRevision: main  # å§‹ç»ˆè·Ÿè¸ª main åˆ†æ”¯

  syncPolicy:
    automated:
      selfHeal: true

    # å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
    syncOptions:
    - RollbackOnFailure=true
```

**Git æäº¤è§¦å‘å›æ»š**ï¼š

```bash
# éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼ˆæœ‰ bugï¼‰
git commit -m "Deploy v1.2.0"
git push

# ArgoCD è‡ªåŠ¨åŒæ­¥ï¼Œä½†å‘ç°å¥åº·æ£€æŸ¥å¤±è´¥
# ArgoCD è‡ªåŠ¨åˆ›å»ºå›æ»š commit

git log
commit abc123 (HEAD -> main)
Author: ArgoCD <argocd@system>
Date:   2025-10-27 10:25:00
    Auto-rollback: revert to v1.1.0 due to health check failure

commit def456
Author: Developer <dev@company.com>
Date:   2025-10-27 10:20:00
    Deploy v1.2.0
```

### 6.2 ç­–ç•¥ 2ï¼šåŸºäº Metric çš„è‡ªåŠ¨å›æ»š

**é›†æˆ Prometheus + ArgoCD**ï¼š

```yaml
# AnalysisTemplateï¼ˆArgoCD Rolloutsï¼‰
apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: error-rate-check
spec:
  metrics:
  - name: error-rate
    interval: 1m
    successCondition: result < 0.05  # é”™è¯¯ç‡ < 5%
    failureLimit: 3  # è¿ç»­å¤±è´¥ 3 æ¬¡åˆ™å›æ»š
    provider:
      prometheus:
        address: http://prometheus:9090
        query: |
          rate(http_requests_total{status=~"5.."}[5m]) /
          rate(http_requests_total[5m])
```

**Rollout é…ç½®**ï¼š

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: my-app
spec:
  replicas: 10
  strategy:
    canary:
      steps:
      - setWeight: 20  # 20% æµé‡åˆ°æ–°ç‰ˆæœ¬
      - pause: {duration: 5m}  # è§‚å¯Ÿ 5 åˆ†é’Ÿ
      - analysis:
          templates:
          - templateName: error-rate-check  # æ£€æŸ¥é”™è¯¯ç‡
      - setWeight: 50  # é€šè¿‡æ£€æŸ¥ â†’ 50% æµé‡
      - pause: {duration: 5m}
      - analysis:
          templates:
          - templateName: error-rate-check
      - setWeight: 100  # å®Œå…¨åˆ‡æ¢
```

**æ‰§è¡Œæ•ˆæœ**ï¼š

```text
10:00  éƒ¨ç½² v1.2.0ï¼Œ20% æµé‡
10:01  Prometheus æ£€æµ‹åˆ°é”™è¯¯ç‡ 8% > 5%
10:02  AnalysisRun å¤±è´¥
10:03  è‡ªåŠ¨å›æ»šåˆ° v1.1.0
10:04  æµé‡ 100% æ¢å¤åˆ° v1.1.0
10:05  æäº¤ Git commit: "Auto-rollback to v1.1.0"
10:06  é€šçŸ¥ Slack: "v1.2.0 è‡ªåŠ¨å›æ»šï¼ŒåŸå› ï¼šé”™è¯¯ç‡è¿‡é«˜"
```

### 6.3 ç­–ç•¥ 3ï¼šåŸºäº OTLP çš„æ™ºèƒ½ä¿®å¤

**å®Œæ•´é—­ç¯**ï¼š

```text
1. OTLP é‡‡é›†æŒ‡æ ‡
   â†“
2. Prometheus è§¦å‘å‘Šè­¦
   â†“
3. OPA ç­–ç•¥åˆ¤æ–­ï¼šallow_rollback = true
   â†“
4. PR Controller ä¿®æ”¹ Git é…ç½®
   â†“
5. ArgoCD æ£€æµ‹åˆ° Git å˜åŒ–
   â†“
6. ArgoCD è‡ªåŠ¨åŒæ­¥å›æ»š
   â†“
7. éªŒè¯ä¿®å¤æ•ˆæœ
```

**Git Commit è‡ªåŠ¨åŒ–**ï¼š

```go
// PR Controllerï¼ˆGoï¼‰
func handleRollback(service string, targetVersion string) error {
    // 1. Clone Git ä»“åº“
    repo, err := git.PlainClone("/tmp/config", false, &git.CloneOptions{
        URL: "https://github.com/myorg/config.git",
    })

    // 2. ä¿®æ”¹é…ç½®
    manifestPath := fmt.Sprintf("manifests/%s/kustomization.yaml", service)
    content, _ := ioutil.ReadFile(manifestPath)

    // ä¿®æ”¹é•œåƒç‰ˆæœ¬
    newContent := strings.ReplaceAll(
        string(content),
        "myapp:v1.2.0",
        fmt.Sprintf("myapp:%s", targetVersion),
    )
    ioutil.WriteFile(manifestPath, []byte(newContent), 0644)

    // 3. Commit
    w, _ := repo.Worktree()
    w.Add(manifestPath)
    w.Commit(fmt.Sprintf("Auto-rollback %s to %s", service, targetVersion), &git.CommitOptions{
        Author: &object.Signature{
            Name:  "SelfHeal Bot",
            Email: "bot@company.com",
            When:  time.Now(),
        },
    })

    // 4. Push
    err = repo.Push(&git.PushOptions{
        Auth: &http.BasicAuth{
            Username: "github-token",
            Password: os.Getenv("GITHUB_TOKEN"),
        },
    })

    return err
}
```

---

## 7 Kustomize å¤šç¯å¢ƒç®¡ç†

---

## 8 é‡‘ä¸é›€å‘å¸ƒ GitOps

**ArgoCD Rollouts é…ç½®**ï¼š

```yaml
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: myapp
spec:
  replicas: 10
  revisionHistoryLimit: 3

  selector:
    matchLabels:
      app: myapp

  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:v1.2.0

  strategy:
    canary:
      # é‡‘ä¸é›€æœåŠ¡
      canaryService: myapp-canary
      stableService: myapp-stable

      # æµé‡ç®¡ç†ï¼ˆIstio/Nginxï¼‰
      trafficRouting:
        istio:
          virtualService:
            name: myapp-vsvc
            routes:
            - primary

      # å‘å¸ƒæ­¥éª¤
      steps:
      - setWeight: 10  # 10% æµé‡åˆ°é‡‘ä¸é›€
      - pause: {duration: 2m}

      - setWeight: 20
      - pause: {duration: 2m}

      - setWeight: 50
      - pause: {duration: 5m}

      # åˆ†æ
      - analysis:
          templates:
          - templateName: success-rate
          args:
          - name: service-name
            value: myapp-canary

      - setWeight: 100  # å®Œå…¨åˆ‡æ¢
```

**æµé‡åˆ‡åˆ†ï¼ˆIstio VirtualServiceï¼‰**ï¼š

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: myapp-vsvc
spec:
  hosts:
  - myapp
  http:
  - name: primary
    route:
    - destination:
        host: myapp-stable
        subset: stable
      weight: 90  # 90% æµé‡åˆ°ç¨³å®šç‰ˆæœ¬
    - destination:
        host: myapp-canary
        subset: canary
      weight: 10  # 10% æµé‡åˆ°é‡‘ä¸é›€
```

**è‡ªåŠ¨å›æ»šç¤ºä¾‹**ï¼š

```bash
# éƒ¨ç½² v1.2.0
git commit -m "Deploy v1.2.0" && git push

# ArgoCD æ£€æµ‹å¹¶å¼€å§‹ Rollout
10:00  10% traffic to v1.2.0
10:02  20% traffic to v1.2.0
10:04  50% traffic to v1.2.0
10:09  Analysis started...
10:10  ERROR: Success rate 92% < 95%
10:10  Analysis failed, initiating rollback
10:11  100% traffic back to v1.1.0
10:12  Git commit: "Auto-rollback to v1.1.0"
```

---

## 9 GitOps æœ€ä½³å®è·µ

### 9.1 å•ä¸€ Git ä»“åº“ vs å¤š Git ä»“åº“

**å•ä¸€ä»“åº“**ï¼ˆMonorepoï¼‰ï¼š

```text
config/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ app1/
â”‚   â”œâ”€â”€ app2/
â”‚   â””â”€â”€ app3/
â””â”€â”€ infrastructure/
    â”œâ”€â”€ ingress/
    â”œâ”€â”€ monitoring/
    â””â”€â”€ storage/
```

**ä¼˜ç‚¹**ï¼š

- ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†
- è·¨åº”ç”¨é…ç½®å…±äº«
- ç®€åŒ–æƒé™ç®¡ç†

**ç¼ºç‚¹**ï¼š

- å¤§ä»“åº“æ€§èƒ½é—®é¢˜
- æƒé™ç²’åº¦ç²—

**å¤šä»“åº“**ï¼ˆMulti-repoï¼‰ï¼š

```text
app1-config/
app2-config/
app3-config/
infra-config/
```

**ä¼˜ç‚¹**ï¼š

- ç»†ç²’åº¦æƒé™
- ç‹¬ç«‹ç‰ˆæœ¬è¿­ä»£
- å°ä»“åº“æ€§èƒ½å¥½

**ç¼ºç‚¹**ï¼š

- é…ç½®åˆ†æ•£
- éš¾ä»¥ç»Ÿä¸€ç®¡ç†

**æ¨è**ï¼š

- å°å›¢é˜Ÿï¼ˆ< 10 äººï¼‰ï¼šå•ä¸€ä»“åº“
- å¤§å›¢é˜Ÿï¼šæŒ‰å›¢é˜Ÿ/æœåŠ¡æ‹†åˆ†å¤šä»“åº“

### 9.2 Git åˆ†æ”¯ç­–ç•¥

**ç¯å¢ƒåˆ†æ”¯**ï¼š

```text
main     â†’ ç”Ÿäº§ç¯å¢ƒ
staging  â†’ é¢„å‘ç¯å¢ƒ
develop  â†’ å¼€å‘ç¯å¢ƒ
```

**ä¼˜ç‚¹**ï¼š

- ç¯å¢ƒéš”ç¦»
- éƒ¨ç½²ç›´è§‚

**ç¼ºç‚¹**ï¼š

- åˆå¹¶å†²çª
- éš¾ä»¥è·Ÿè¸ªå˜æ›´

**ç›®å½•ç­–ç•¥**ï¼ˆæ¨èï¼‰ï¼š

```text
main åˆ†æ”¯ï¼š
â”œâ”€â”€ overlays/dev/
â”œâ”€â”€ overlays/staging/
â””â”€â”€ overlays/prod/
```

**ä¼˜ç‚¹**ï¼š

- æ— åˆ†æ”¯å†²çª
- å˜æ›´æ¸…æ™°
- æ˜“äºå›æ»š

### 9.3 Secrets ç®¡ç†

**ä¸è¦ç›´æ¥æäº¤ Secret åˆ° Gitï¼**

```yaml
# âŒ é”™è¯¯
apiVersion: v1
kind: Secret
metadata:
  name: db-password
data:
  password: cGFzc3dvcmQxMjM=  # base64ï¼Œä¸å®‰å…¨
```

#### 3.3.1 æ­£ç¡®æ–¹æ³• 1ï¼šSealed Secrets

```bash
# åŠ å¯† Secret
kubeseal --format yaml < secret.yaml > sealed-secret.yaml

# sealed-secret.yaml å¯ä»¥å®‰å…¨æäº¤åˆ° Git
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: db-password
spec:
  encryptedData:
    password: AgBj7V5...ï¼ˆåŠ å¯†åï¼‰
```

#### 3.3.2 æ­£ç¡®æ–¹æ³• 2ï¼šExternal Secrets Operator

```yaml
# åªå­˜å¼•ç”¨ï¼Œä¸å­˜å€¼
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: db-password
spec:
  secretStoreRef:
    name: aws-secrets-manager
  target:
    name: db-password
  data:
  - secretKey: password
    remoteRef:
      key: prod/db-password  # AWS Secrets Manager çš„ key
```

### 9.4 å®¡è®¡ä¸åˆè§„

**Git Commit ç­–ç•¥**ï¼š

```bash
# âŒ å·®
git commit -m "fix"

# âœ… å¥½
git commit -m "fix(prod): rollback to v1.1.0 due to high error rate

- Error rate: 8%
- Duration: 5 minutes
- Auto-rollback by SelfHeal Bot
- Ticket: INC-12345
"
```

**PR å®¡æ‰¹æµç¨‹**ï¼š

```yaml
# GitHub CODEOWNERS
/overlays/prod/*  @sre-team @security-team

# ç”Ÿäº§ç¯å¢ƒé…ç½®å¿…é¡» 2 äººå®¡æ‰¹
```

---

## 10 å…³é”®æ´å¯Ÿ

### 10.1 æ´å¯Ÿ 1ï¼šGit æ˜¯æ—¶é—´æœºå™¨

```text
æ‰€æœ‰å˜æ›´å¯è¿½æº¯ï¼š
git log --oneline overlays/prod/

abc123  Deploy v1.2.0
def456  Rollback to v1.1.0 (auto)
ghi789  Scale replicas to 10
jkl012  Update config: timeout=30s

ä»»æ„æ—¶åˆ»å¯å›æ»šï¼š
git revert abc123
git push
â†’ ArgoCD è‡ªåŠ¨åŒæ­¥å›æ»š
```

### 10.2 æ´å¯Ÿ 2ï¼šå£°æ˜å¼ å‘½ä»¤å¼

```text
å‘½ä»¤å¼ï¼ˆè„†å¼±ï¼‰ï¼š
kubectl scale deployment myapp --replicas=10
ï¼ˆå¦‚æœ Pod æŒ‚äº†ï¼Œå‰¯æœ¬æ•°å°±ä¸å¯¹äº†ï¼‰

å£°æ˜å¼ï¼ˆå¥å£®ï¼‰ï¼š
# Git ä¸­å£°æ˜ï¼šreplicas: 10
# ArgoCD æŒç»­ç›‘æ§ï¼Œè‡ªåŠ¨ä¿®å¤
```

### 10.3 æ´å¯Ÿ 3ï¼šè‡ªåŠ¨åŒ– å¯é æ€§

```text
äººå·¥å›æ»šï¼š
1. å‘ç°é—®é¢˜ï¼ˆ5 åˆ†é’Ÿï¼‰
2. æ‰¾åˆ°é—®é¢˜ç‰ˆæœ¬ï¼ˆ5 åˆ†é’Ÿï¼‰
3. æ‰§è¡Œå›æ»šï¼ˆ2 åˆ†é’Ÿï¼‰
4. éªŒè¯æ¢å¤ï¼ˆ3 åˆ†é’Ÿï¼‰
æ€»è®¡ï¼š15 åˆ†é’Ÿ

è‡ªåŠ¨å›æ»šï¼š
1. æ£€æµ‹é—®é¢˜ï¼ˆ30 ç§’ï¼‰
2. ç­–ç•¥åˆ¤æ–­ï¼ˆ10 ç§’ï¼‰
3. Git æäº¤ï¼ˆ10 ç§’ï¼‰
4. ArgoCD åŒæ­¥ï¼ˆ1 åˆ†é’Ÿï¼‰
æ€»è®¡ï¼š2 åˆ†é’Ÿ

å¯é æ€§æå‡ï¼š7.5 å€
```

---

## 11 æƒå¨å‚è€ƒä¸æ ‡å‡† | Authoritative References

### 10.4 GitOpsèµ·æºä¸å®šä¹‰

1. **Weaveworks GitOps Manifesto (2017)**
   - ğŸ“‹ **å®˜æ–¹**: [gitops.tech](https://www.gitops.tech/)
   - ğŸ¢ **åˆ›å§‹**: Weaveworks
   - â­ **åœ°ä½**: GitOpsæ¦‚å¿µå‘èµ·è€…
   - ğŸ’¡ **å®šä¹‰**: Git as Single Source of Truth

2. **"GitOps - Operations by Pull Request" (Weaveworks Blog, 2017)**
   - ğŸ“„ **åŸæ–‡**: Weaveworkså®˜æ–¹åšå®¢
   - ğŸ’¡ **å†…å®¹**: GitOpså·¥ä½œæµé¦–æ¬¡ç³»ç»Ÿé˜è¿°

3. **OpenGitOps Project (CNCF)**
   - ğŸ¢ **CNCF**: [opengitops.dev](https://opengitops.dev/)
   - ğŸ“‹ **æ ‡å‡†**: GitOpsåŸåˆ™è§„èŒƒåŒ–
   - â­ **å››å¤§åŸåˆ™**: Declarative, Versioned, Automated, Continuously Reconciled
   - âœ… **éªŒè¯**: 2025-10-27

### 10.5 æ ¸å¿ƒå·¥å…·

4. **Flux CD Official Documentation**
   - ğŸ”— **å®˜æ–¹**: [fluxcd.io](https://fluxcd.io/)
   - ğŸ¢ **CNCF**: Graduated Project (2022)
   - â­ **Stars**: 6,000+ (GitHub)
   - ğŸ’¡ **ç‰¹æ€§**: GitOps for Kubernetes

5. **Argo CD Official Documentation**
   - ğŸ”— **å®˜æ–¹**: [argoproj.github.io/cd/](https://argoproj.github.io/cd/)
   - ğŸ¢ **CNCF**: Graduated Project (2022)
   - â­ **Stars**: 16,000+ (GitHub)
   - ğŸ’¡ **ç‰¹æ€§**: Declarative GitOps CD for K8s

6. **Argo CD Best Practices**
   - ğŸ“„ **æŒ‡å—**: Argoå®˜æ–¹æ–‡æ¡£
   - ğŸ’¡ **å†…å®¹**: Multi-cluster, App of Apps pattern

### 10.6 å­¦æœ¯ä¸å·¥ä¸šç™½çš®ä¹¦

7. **"The State of GitOps 2023" - Weaveworks Survey**
   - ğŸ“„ **æŠ¥å‘Š**: Weaveworkså¹´åº¦è°ƒæŸ¥
   - ğŸ“Š **æ•°æ®**: å…¨çƒGitOpsé‡‡ç”¨è¶‹åŠ¿
   - ğŸ’¡ **å‘ç°**: 80%+ä¼ä¸šé‡‡ç”¨æˆ–è¯„ä¼°GitOps

8. **Google SRE Book - Chapter on Automation**
   - ğŸ“– **åœ¨çº¿**: [sre.google/books/](https://sre.google/books/)
   - ğŸ¢ **Google**: Site Reliability Engineering
   - ğŸ’¡ **ç›¸å…³**: å£°æ˜å¼é…ç½®ç®¡ç†

9. **AWS Whitepaper - GitOps on EKS**
   - ğŸ“„ **AWS**: Amazon EKS Best Practices
   - ğŸ”— [aws.github.io/aws-eks-best-practices/gitops/](https://aws.github.io/aws-eks-best-practices/gitops/)
   - ğŸ’¡ **å†…å®¹**: EKS GitOpså®æ–½æŒ‡å—

### 10.7 ä¼ä¸šå®è·µæ¡ˆä¾‹

10. **Weaveworks at HSBC**
    - ğŸ“„ **æ¡ˆä¾‹**: CNCF Case Study
    - ğŸ¢ **é‡‘è**: HSBCé“¶è¡Œ
    - ğŸ’¡ **è§„æ¨¡**: å…¨çƒé‡‘èçº§GitOpséƒ¨ç½²

11. **Mercedes-Benz GitOps Journey**
    - ğŸ“„ **KubeConæ¼”è®²**: 2021
    - ğŸ¢ **æ±½è½¦**: Mercedes-Benz
    - ğŸ’¡ **åº”ç”¨**: è½¦è”ç½‘GitOpså®è·µ

12. **Adobe Experience Platform**
    - ğŸ“„ **åšå®¢**: Adobe Tech Blog
    - ğŸ’¡ **è§„æ¨¡**: æ•°åƒå¾®æœåŠ¡GitOpsç®¡ç†

### 10.8 æ ‡å‡†ä¸è§„èŒƒ

13. **Kubernetes GitOps Working Group**
    - ğŸ¢ **K8s**: SIG App Delivery
    - ğŸ”— [github.com/kubernetes/community](https://github.com/kubernetes/community)
    - ğŸ’¡ **å†…å®¹**: K8s GitOpsæ ‡å‡†åŒ–

14. **CNCF App Delivery SIG**
    - ğŸ¢ **CNCF**: Special Interest Group
    - ğŸ’¡ **èŒƒå›´**: åº”ç”¨äº¤ä»˜æœ€ä½³å®è·µ

### 10.9 Helmä¸Kustomize

15. **Helm Official Documentation**
    - ğŸ”— **å®˜æ–¹**: [helm.sh](https://helm.sh/)
    - ğŸ¢ **CNCF**: Graduated (2020)
    - â­ **Stars**: 26,000+
    - ğŸ’¡ **åº”ç”¨**: K8såŒ…ç®¡ç†ï¼ŒGitOpsé…ç½®æ¨¡æ¿

16. **Kustomize Official Guide**
    - ğŸ”— **å®˜æ–¹**: [kustomize.io](https://kustomize.io/)
    - ğŸ’¡ **ç‰¹æ€§**: å£°æ˜å¼é…ç½®ç®¡ç†
    - â­ **é›†æˆ**: kubectlåŸç”Ÿæ”¯æŒ

### 10.10 Gitå·¥ä½œæµç†è®º

17. **"A successful Git branching model" - Vincent Driessen (2010)**
    - ğŸ“„ **åšå®¢**: nvie.com
    - ğŸ† **å½±å“**: Git Flowæ¨¡å‹
    - ğŸ’¡ **åŸºç¡€**: GitOpsåˆ†æ”¯ç­–ç•¥

18. **"GitHub Flow" - Scott Chacon**
    - ğŸ“„ **GitHub**: å®˜æ–¹æ¨èå·¥ä½œæµ
    - ğŸ’¡ **ç®€åŒ–**: é€‚åˆæŒç»­éƒ¨ç½²çš„Git Flow

### 10.11 å£°æ˜å¼åŸºç¡€è®¾æ–½

19. **Terraform GitOps Integration**
    - ğŸ”— **HashiCorp**: Terraformå®˜æ–¹æ–‡æ¡£
    - ğŸ’¡ **æ¨¡å¼**: IaC + GitOps

20. **Crossplane - Kubernetes-native IaC**
    - ğŸ”— **GitHub**: [github.com/crossplane/crossplane](https://github.com/crossplane/crossplane)
    - ğŸ¢ **CNCF**: Incubating
    - â­ **Stars**: 9,000+
    - ğŸ’¡ **èåˆ**: GitOps + äº‘èµ„æºç®¡ç†

### 10.12 å®‰å…¨ä¸åˆè§„

21. **"Secure GitOps Practices" - CNCF Security SIG**
    - ğŸ“„ **æŒ‡å—**: CNCFå®‰å…¨æœ€ä½³å®è·µ
    - ğŸ’¡ **å†…å®¹**: Gitç­¾åã€RBACã€å®¡è®¡

22. **Sigstore - Signing and Verification**
    - ğŸ”— **å®˜æ–¹**: [sigstore.dev](https://www.sigstore.dev/)
    - ğŸ¢ **CNCF**: Graduated (2023)
    - ğŸ’¡ **åº”ç”¨**: GitOpsä¾›åº”é“¾å®‰å…¨

### 10.13 åœ¨çº¿èµ„æº

23. **GitOps Working Group**
    - ğŸ”— [github.com/gitops-working-group](https://github.com/gitops-working-group)
    - ğŸ’¡ **å†…å®¹**: æ ‡å‡†ã€å·¥å…·ã€æœ€ä½³å®è·µ

24. **Wikipedia - GitOps**
    - ğŸ”— [en.wikipedia.org/wiki/GitOps](https://en.wikipedia.org/wiki/GitOps)
    - âœ… **éªŒè¯**: 2025-10-27

### 10.14 éªŒè¯ä¸é‡‡ç”¨ç»Ÿè®¡æˆªè‡³2025-10-27

| å·¥å…·/é¡¹ç›® | CNCFçŠ¶æ€ | GitHub Stars | ä¼ä¸šé‡‡ç”¨ |
|----------|---------|-------------|----------|
| Argo CD | Graduated | 16,000+ | æ•°åƒå®¶ |
| Flux CD | Graduated | 6,000+ | æ•°åƒå®¶ |
| Helm | Graduated | 26,000+ | å…¨çƒå¹¿æ³› |
| Crossplane | Incubating | 9,000+ | å¿«é€Ÿå¢é•¿ |
| Sigstore | Graduated | 4,000+ | ä¾›åº”é“¾å®‰å…¨ |

**æ•°æ®æ¥æº**: CNCF, GitHub, ä¼ä¸šæ¡ˆä¾‹ç ”ç©¶ (2025-10-27)

---

## 11 ç›¸å…³ä¸»é¢˜

### 11.1 è·¨è§†è§’é“¾æ¥

- [FormalLanguage_Perspective](../../FormalLanguage_Perspective/README.md)
- [AI_model_Perspective](../../AI_model_Perspective/README.md)
- [æ¦‚å¿µäº¤å‰ç´¢å¼•ï¼ˆä¸ƒè§†è§’ç‰ˆï¼‰](../../CONCEPT_CROSS_INDEX.md) - æŸ¥çœ‹ç›¸å…³æ¦‚å¿µçš„ä¸ƒè§†è§’åˆ†æï¼š
  - [åèº«æ€§](../../CONCEPT_CROSS_INDEX.md#31-åèº«æ€§-reflexivity-ä¸ƒè§†è§’) - GitOpsç³»ç»Ÿåœ¨å…ƒå±‚çº§æ“ä½œè‡ªèº«çš„èƒ½åŠ›
  - [éš”ç¦»](../../CONCEPT_CROSS_INDEX.md#112-éš”ç¦»-isolation-ä¸ƒè§†è§’) - GitOpsä¸­çš„ç¯å¢ƒéš”ç¦»æœºåˆ¶
  - [è™šæ‹ŸåŒ–](../../CONCEPT_CROSS_INDEX.md#212-è™šæ‹ŸåŒ–-virtualization-ä¸ƒè§†è§’) - å£°æ˜å¼åŸºç¡€è®¾æ–½çš„æŠ½è±¡å±‚

### 11.2 ç›¸å…³æ–‡æ¡£

- [4.1 è‡ªæ„ˆç³»ç»Ÿæ¶æ„](./04.1_Self_Healing_Architecture.md)
- [4.2 OTLP å¯è§‚æµ‹æ€§](./04.2_OTLP_Observability.md)
- [4.3 OPA ç­–ç•¥å¼•æ“](./04.3_OPA_Policy_Engine.md)
- [4.5 è‡ªæ„ˆé—­ç¯å®ç°](./04.5_Self_Healing_Loop_Implementation.md)

---
