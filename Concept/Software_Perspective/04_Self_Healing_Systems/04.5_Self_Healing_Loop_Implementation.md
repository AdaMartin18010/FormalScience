# 4.5 è‡ªæ„ˆé—­ç¯å®ç°

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **æœ€åæ›´æ–°**: 2025-10-27  
> **æ–‡æ¡£è§„æ¨¡**: 853è¡Œ | è‡ªæ„ˆç³»ç»Ÿå®Œæ•´å®æ–½æŒ‡å—  
> **é˜…è¯»å»ºè®®**: æœ¬æ–‡æä¾›OTLP+OPA+GitOpsä¸‰ä½ä¸€ä½“çš„å®Œæ•´å®æ–½æ–¹æ¡ˆï¼Œæ˜¯ç”Ÿäº§çº§è‡ªæ„ˆç³»ç»Ÿçš„éƒ¨ç½²æŒ‡å—

---

## ğŸ“‹ ç›®å½•

- [ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ](#-æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ)
- [æ¦‚è¿°](#æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
  - [å®Œæ•´æ‹“æ‰‘](#å®Œæ•´æ‹“æ‰‘)
- [å®æ–½æ­¥éª¤ï¼ˆ2 å‘¨è®¡åˆ’ï¼‰](#å®æ–½æ­¥éª¤2-å‘¨è®¡åˆ’)
  - [Week 1: åŸºç¡€è®¾æ–½æ­å»º](#week-1-åŸºç¡€è®¾æ–½æ­å»º)
    - [Day 1-2: éƒ¨ç½² OpenTelemetry Collector](#day-1-2-éƒ¨ç½²-opentelemetry-collector)
    - [Day 3-4: éƒ¨ç½² Prometheus + Alertmanager](#day-3-4-éƒ¨ç½²-prometheus--alertmanager)
    - [Day 5-6: éƒ¨ç½² OPA + Gatekeeper](#day-5-6-éƒ¨ç½²-opa--gatekeeper)
    - [Day 7: éƒ¨ç½² ArgoCD](#day-7-éƒ¨ç½²-argocd)
  - [Week 2: è‡ªæ„ˆæ§åˆ¶å™¨å¼€å‘](#week-2-è‡ªæ„ˆæ§åˆ¶å™¨å¼€å‘)
    - [PR Controller å®ç°ï¼ˆGoï¼‰](#pr-controller-å®ç°go)
- [ç«¯åˆ°ç«¯æµ‹è¯•](#ç«¯åˆ°ç«¯æµ‹è¯•)
  - [æ··æ²Œå®éªŒ](#æ··æ²Œå®éªŒ)
    - [åœºæ™¯ 1ï¼šæ¨¡æ‹Ÿé«˜é”™è¯¯ç‡](#åœºæ™¯-1æ¨¡æ‹Ÿé«˜é”™è¯¯ç‡)
- [ç”Ÿäº§ä¼˜åŒ–](#ç”Ÿäº§ä¼˜åŒ–)
  - [1. é™æµé˜²æŠ–](#1-é™æµé˜²æŠ–)
  - [2. é‡‘ä¸é›€éªŒè¯](#2-é‡‘ä¸é›€éªŒè¯)
  - [3. é€šçŸ¥ä¸å®¡è®¡](#3-é€šçŸ¥ä¸å®¡è®¡)
- [ç›‘æ§é¢æ¿](#ç›‘æ§é¢æ¿)
  - [Grafana Dashboard JSON](#grafana-dashboard-json)
- [æˆæœ¬åˆ†æ](#æˆæœ¬åˆ†æ)
  - [èµ„æºéœ€æ±‚](#èµ„æºéœ€æ±‚)
  - [ROI è®¡ç®—](#roi-è®¡ç®—)
- [å…³é”®æ´å¯Ÿ](#å…³é”®æ´å¯Ÿ)
  - [æ´å¯Ÿ 1ï¼š60 ç§’é»„é‡‘çª—å£](#æ´å¯Ÿ-160-ç§’é»„é‡‘çª—å£)
  - [æ´å¯Ÿ 2ï¼šç­–ç•¥æ˜¯æ ¸å¿ƒ](#æ´å¯Ÿ-2ç­–ç•¥æ˜¯æ ¸å¿ƒ)
  - [æ´å¯Ÿ 3ï¼šæ¸è¿›å¼æ¨å¹¿](#æ´å¯Ÿ-3æ¸è¿›å¼æ¨å¹¿)
- [ç›¸å…³ä¸»é¢˜](#ç›¸å…³ä¸»é¢˜)

---

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>â™»ï¸ğŸ› ï¸ ç‚¹å‡»å±•å¼€ï¼šè‡ªæ„ˆé—­ç¯å®ç°æ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: å®Œæ•´è‡ªæ„ˆé—­ç¯ï¼šOTLPï¼ˆè§‚å¯Ÿï¼‰+OPAï¼ˆå†³ç­–ï¼‰+GitOpsï¼ˆæ‰§è¡Œï¼‰ä¸‰ä½ä¸€ä½“ã€‚ç³»ç»Ÿæ¶æ„ï¼šâ‘ åº”ç”¨å±‚â†’OTEL SDKå‘é€Metrics/Traces/Logsâ‘¡æ„ŸçŸ¥å±‚â†’OTEL Collector+Prometheuså­˜å‚¨+AlertManagerå‘Šè­¦â‘¢å†³ç­–å±‚â†’OPA Gatewayæ‰§è¡ŒRegoç­–ç•¥è¿”å›å†³ç­–ï¼ˆallow/deny+actionï¼‰â‘£æ‰§è¡Œå±‚â†’PR Controlleråˆ›å»ºå›æ»šPRâ†’Argo CDæ£€æµ‹+åŒæ­¥â†’K8s Applyâ‘¤éªŒè¯å±‚â†’æŒç»­ç›‘æ§â†’é—­ç¯ã€‚å®æ–½æ­¥éª¤ï¼šâ‘ éƒ¨ç½²OTEL Collectorï¼ˆK8s DaemonSetï¼‰â‘¡é…ç½®Prometheus+Grafanaï¼ˆç›‘æ§å¯è§†åŒ–ï¼‰â‘¢éƒ¨ç½²OPAï¼ˆç­–ç•¥å³ä»£ç ï¼‰â‘£éƒ¨ç½²Argo CDï¼ˆGitOpså¼•æ“ï¼‰â‘¤é›†æˆWebhookï¼ˆAlertManagerâ†’OPAâ†’PR Controllerï¼‰ã€‚æ•…éšœåœºæ™¯ï¼šPod CPU>80%â†’å‘Šè­¦â†’OPAå†³ç­–æ‰©å®¹â†’GitOpsè°ƒæ•´replicasâ†’è‡ªåŠ¨ä¿®å¤â†’éªŒè¯ã€‚ä¼˜åŒ–ï¼šå¹¶è¡Œå¤„ç†ã€å¹‚ç­‰æ€§ã€æ­»é”æ£€æµ‹ã€å›æ»šé™æµã€‚æµ‹è¯•ï¼šæ··æ²Œå·¥ç¨‹ï¼ˆChaos Meshï¼‰ã€æ•…éšœæ³¨å…¥ã€‚ç”Ÿäº§å®è·µï¼šSLOç›‘æ§ï¼ˆ99.9%å¯ç”¨æ€§ï¼‰ã€æˆæœ¬ä¼˜åŒ–ï¼ˆæŒ‰éœ€æ‰©å®¹ï¼‰ã€‚å…³é”®ï¼šå·¥ç¨‹åŒ–è½åœ°ã€‚

</details>

---

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›**OTLP + OPA + GitOps**ä¸‰ä½ä¸€ä½“è‡ªæ„ˆç³»ç»Ÿçš„**å®Œæ•´å®æ–½æŒ‡å—**ï¼Œä»é›¶åˆ°ç”Ÿäº§çº§éƒ¨ç½²ã€‚

## ç³»ç»Ÿæ¶æ„

### å®Œæ•´æ‹“æ‰‘

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åº”ç”¨å±‚ (Application Layer)                            â”‚
â”‚  - é›†æˆ OTEL SDK                                       â”‚
â”‚  - å‘é€ Metrics/Traces/Logs                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ OTLP (gRPC :4317 / HTTP :4318)
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ„ŸçŸ¥å±‚ (Observability Layer)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ OTEL Collector   â”‚    â”‚  Prometheus      â”‚        â”‚
â”‚  â”‚ - æ¥æ”¶ OTLP      â”‚â”€â”€â”€>â”‚  - å­˜å‚¨æŒ‡æ ‡      â”‚        â”‚
â”‚  â”‚ - è½¬æ¢æ ¼å¼       â”‚    â”‚  - è®¡ç®—å‘Šè­¦      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚ AlertManager Webhook
                                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†³ç­–å±‚ (Policy Layer)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  OPA Gateway                                 â”‚     â”‚
â”‚  â”‚  - æ¥æ”¶å‘Šè­¦ JSON                             â”‚     â”‚
â”‚  â”‚  - æ‰§è¡Œ Rego ç­–ç•¥                            â”‚     â”‚
â”‚  â”‚  - è¿”å›å†³ç­– {allow: true, action: "rollback"}â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ HTTP POST
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰§è¡Œå±‚ (Execution Layer)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  PR Controller (è½»é‡ Go æœåŠ¡)               â”‚     â”‚
â”‚  â”‚  - æ¥æ”¶ OPA å†³ç­–                             â”‚     â”‚
â”‚  â”‚  - Clone Git repo                            â”‚     â”‚
â”‚  â”‚  - ä¿®æ”¹é…ç½® (image tag / replicas)           â”‚     â”‚
â”‚  â”‚  - åˆ›å»º PR                                   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚ Git Push
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒæ­¥å±‚ (GitOps Layer)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Git Repo   â”‚                â”‚  ArgoCD          â”‚   â”‚
â”‚  â”‚ - configs/ â”‚<â”€â”€â”€pullâ”€â”€â”€â”€â”€â”€â”€â”€â”‚  - æ£€æµ‹å˜åŒ–      â”‚   â”‚
â”‚  â”‚ - overlays/â”‚                â”‚  - è‡ªåŠ¨åŒæ­¥      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚ kubectl apply
                                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Kubernetes Cluster                                    â”‚
â”‚  - Deployment updated                                  â”‚
â”‚  - Pods rolled back                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ çŠ¶æ€åé¦ˆ
                 â””â”€â”€> (å›åˆ°æ„ŸçŸ¥å±‚ï¼ŒéªŒè¯ä¿®å¤æ•ˆæœ)
```

---

## å®æ–½æ­¥éª¤ï¼ˆ2 å‘¨è®¡åˆ’ï¼‰

### Week 1: åŸºç¡€è®¾æ–½æ­å»º

#### Day 1-2: éƒ¨ç½² OpenTelemetry Collector

**å®‰è£…**ï¼š

```bash
# ä½¿ç”¨ Helm å®‰è£…
helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
helm install otel-collector open-telemetry/opentelemetry-collector \
  --namespace observability --create-namespace \
  --values otel-collector-values.yaml
```

**é…ç½®** (`otel-collector-values.yaml`):

```yaml
mode: deployment

config:
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
  
  processors:
    batch:
      timeout: 10s
      send_batch_size: 1024
    
    memory_limiter:
      limit_mib: 512
      spike_limit_mib: 128
  
  exporters:
    prometheus:
      endpoint: "0.0.0.0:8889"
      namespace: app
    
    logging:
      loglevel: info
  
  service:
    pipelines:
      metrics:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [prometheus, logging]
      
      traces:
        receivers: [otlp]
        processors: [memory_limiter, batch]
        exporters: [logging]

ports:
  otlp-grpc:
    enabled: true
    containerPort: 4317
    servicePort: 4317
    protocol: TCP
  
  otlp-http:
    enabled: true
    containerPort: 4318
    servicePort: 4318
    protocol: TCP
  
  prometheus:
    enabled: true
    containerPort: 8889
    servicePort: 8889
    protocol: TCP
```

**éªŒè¯**ï¼š

```bash
# æ£€æŸ¥ Pod çŠ¶æ€
kubectl get pods -n observability

# æµ‹è¯• OTLP ç«¯ç‚¹
curl http://otel-collector:8889/metrics
```

#### Day 3-4: éƒ¨ç½² Prometheus + Alertmanager

**å®‰è£…**ï¼š

```bash
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace observability \
  --values prometheus-values.yaml
```

**é…ç½®** (`prometheus-values.yaml`):

```yaml
prometheus:
  prometheusSpec:
    additionalScrapeConfigs:
    - job_name: 'otel-collector'
      static_configs:
      - targets: ['otel-collector:8889']
    
    # å‘Šè­¦è§„åˆ™
    additionalPrometheusRulesMap:
      self-heal-rules:
        groups:
        - name: self_healing
          interval: 30s
          rules:
          - alert: HighErrorRate
            expr: |
              rate(http_requests_total{status=~"5.."}[5m]) /
              rate(http_requests_total[5m]) > 0.05
            for: 5m
            labels:
              severity: critical
              auto_heal: "true"
            annotations:
              summary: "Error rate > 5% for 5 minutes"
              service: "{{ $labels.service }}"
          
          - alert: HighRestartCount
            expr: |
              increase(kube_pod_container_status_restarts_total[10m]) > 3
            labels:
              severity: warning
              auto_heal: "true"
            annotations:
              summary: "Pod restarted > 3 times in 10 minutes"

alertmanager:
  config:
    route:
      group_by: ['alertname', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 1h
      receiver: 'opa-gateway'
      routes:
      - matchers:
        - auto_heal = "true"
        receiver: 'opa-gateway'
    
    receivers:
    - name: 'opa-gateway'
      webhook_configs:
      - url: 'http://opa-gateway.default.svc:8080/v1/data/selfheal/handle_alert'
        send_resolved: false
        http_config:
          follow_redirects: true
```

#### Day 5-6: éƒ¨ç½² OPA + Gatekeeper

**å®‰è£… OPA Gateway**ï¼š

```bash
kubectl create namespace policy-system

# éƒ¨ç½² OPA
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opa-gateway
  namespace: policy-system
spec:
  replicas: 2
  selector:
    matchLabels:
      app: opa-gateway
  template:
    metadata:
      labels:
        app: opa-gateway
    spec:
      containers:
      - name: opa
        image: openpolicyagent/opa:latest
        args:
        - "run"
        - "--server"
        - "--addr=0.0.0.0:8181"
        - "--set=decision_logs.console=true"
        - "/policies"
        ports:
        - containerPort: 8181
        volumeMounts:
        - name: policies
          mountPath: /policies
      volumes:
      - name: policies
        configMap:
          name: opa-policies
---
apiVersion: v1
kind: Service
metadata:
  name: opa-gateway
  namespace: policy-system
spec:
  selector:
    app: opa-gateway
  ports:
  - port: 8080
    targetPort: 8181
EOF
```

**OPA ç­–ç•¥** (`opa-policies.rego`):

```rego
package selfheal

import future.keywords.if
import future.keywords.in

# é»˜è®¤ä¸å…è®¸è‡ªæ„ˆ
default allow_rollback = false
default allow_scale = false

# å…è®¸å›æ»šçš„æ¡ä»¶
allow_rollback if {
    input.alert.labels.alertname == "HighErrorRate"
    input.alert.labels.severity == "critical"
    input.metrics.error_rate > 0.05
    input.metrics.restart_count > 3
    
    # æ—¶é—´çª—å£é™åˆ¶ï¼šæœ€å¤š 2 æ¬¡/30 åˆ†é’Ÿ
    count(recent_rollbacks) < 2
}

# å…è®¸æ‰©å®¹çš„æ¡ä»¶
allow_scale if {
    input.alert.labels.alertname == "HighCPU"
    input.metrics.cpu_usage > 0.8
    input.current_replicas < input.max_replicas
}

# å†³ç­–è¾“å‡º
decision = {
    "allow_rollback": allow_rollback,
    "allow_scale": allow_scale,
    "action": action,
    "reason": reason
}

action = "rollback" if allow_rollback
action = "scale_up" if {
    not allow_rollback
    allow_scale
}
action = "none" if {
    not allow_rollback
    not allow_scale
}

reason = sprintf("Error rate %.2f%% > threshold 5%%", [input.metrics.error_rate * 100]) if allow_rollback
reason = sprintf("CPU usage %.0f%% > threshold 80%%", [input.metrics.cpu_usage * 100]) if allow_scale
reason = "No action needed" if action == "none"

# å†å²å›æ»šè®°å½•ï¼ˆæ¨¡æ‹Ÿï¼Œå®é™…åº”ä»æ•°æ®åº“è¯»å–ï¼‰
recent_rollbacks = []
```

**éƒ¨ç½²ç­–ç•¥**ï¼š

```bash
kubectl create configmap opa-policies \
  --from-file=selfheal.rego=opa-policies.rego \
  -n policy-system
```

#### Day 7: éƒ¨ç½² ArgoCD

```bash
kubectl create namespace argocd
kubectl apply -n argocd -f \
  https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# å¯ç”¨ selfHeal
kubectl patch application myapp -n argocd --type merge -p '
spec:
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
'
```

---

### Week 2: è‡ªæ„ˆæ§åˆ¶å™¨å¼€å‘

#### PR Controller å®ç°ï¼ˆGoï¼‰

**main.go**:

```go
package main

import (
    "context"
    "encoding/json"
    "fmt"
    "log"
    "net/http"
    "os"
    "os/exec"
    
    "github.com/google/go-github/v50/github"
    "golang.org/x/oauth2"
)

type OPADecision struct {
    AllowRollback bool   `json:"allow_rollback"`
    AllowScale    bool   `json:"allow_scale"`
    Action        string `json:"action"`
    Reason        string `json:"reason"`
}

type AlertPayload struct {
    Alert struct {
        Labels      map[string]string `json:"labels"`
        Annotations map[string]string `json:"annotations"`
    } `json:"alert"`
}

func main() {
    http.HandleFunc("/webhook", handleWebhook)
    log.Println("PR Controller listening on :9090")
    log.Fatal(http.ListenAndServe(":9090", nil))
}

func handleWebhook(w http.ResponseWriter, r *http.Request) {
    var payload AlertPayload
    if err := json.NewDecoder(r.Body).Decode(&payload); err != nil {
        http.Error(w, err.Error(), http.StatusBadRequest)
        return
    }
    
    // æŸ¥è¯¢ OPA å†³ç­–
    decision, err := queryOPA(payload)
    if err != nil {
        http.Error(w, err.Error(), http.StatusInternalServerError)
        return
    }
    
    // æ‰§è¡ŒåŠ¨ä½œ
    if decision.AllowRollback {
        if err := performRollback(payload); err != nil {
            log.Printf("Rollback failed: %v", err)
            http.Error(w, err.Error(), http.StatusInternalServerError)
            return
        }
    }
    
    w.WriteHeader(http.StatusOK)
    fmt.Fprintf(w, "Action: %s, Reason: %s", decision.Action, decision.Reason)
}

func queryOPA(payload AlertPayload) (*OPADecision, error) {
    // æ„é€  OPA è¾“å…¥
    input := map[string]interface{}{
        "alert": payload.Alert,
        "metrics": map[string]interface{}{
            "error_rate":     0.08,  // å®é™…åº”ä» Prometheus æŸ¥è¯¢
            "restart_count":  5,
            "cpu_usage":      0.85,
        },
        "current_replicas": 3,
        "max_replicas":     10,
    }
    
    // è°ƒç”¨ OPA API
    resp, err := http.Post(
        "http://opa-gateway.policy-system.svc:8080/v1/data/selfheal/decision",
        "application/json",
        toJSON(input),
    )
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()
    
    var result struct {
        Result OPADecision `json:"result"`
    }
    if err := json.NewDecoder(resp.Body).Decode(&result); err != nil {
        return nil, err
    }
    
    return &result.Result, nil
}

func performRollback(payload AlertPayload) error {
    service := payload.Alert.Labels["service"]
    
    // Clone Git ä»“åº“
    repoPath := "/tmp/configs"
    if err := gitClone("https://github.com/myorg/configs.git", repoPath); err != nil {
        return err
    }
    
    // ä¿®æ”¹é…ç½®ï¼ˆå›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬ï¼‰
    manifestPath := fmt.Sprintf("%s/overlays/prod/%s-deployment.yaml", repoPath, service)
    if err := rollbackImageTag(manifestPath); err != nil {
        return err
    }
    
    // æäº¤å¹¶åˆ›å»º PR
    commitMsg := fmt.Sprintf("Auto rollback %s: error rate exceeded threshold", service)
    if err := gitCommitAndPush(repoPath, commitMsg); err != nil {
        return err
    }
    
    if err := createGitHubPR(service, commitMsg); err != nil {
        return err
    }
    
    log.Printf("Rollback PR created for %s", service)
    return nil
}

func gitClone(repo, path string) error {
    cmd := exec.Command("git", "clone", repo, path)
    return cmd.Run()
}

func rollbackImageTag(manifestPath string) error {
    // ç®€åŒ–å®ç°ï¼šå°† image tag ä» v1.2.0 æ”¹ä¸º v1.1.0
    // å®é™…åº”è§£æ YAML å¹¶è·å–ä¸Šä¸€ç‰ˆæœ¬
    cmd := exec.Command("sed", "-i", "s/image: myapp:v1.2.0/image: myapp:v1.1.0/", manifestPath)
    return cmd.Run()
}

func gitCommitAndPush(repoPath, message string) error {
    commands := [][]string{
        {"git", "-C", repoPath, "add", "."},
        {"git", "-C", repoPath, "commit", "-m", message},
        {"git", "-C", repoPath, "push", "origin", "main"},
    }
    
    for _, cmd := range commands {
        if err := exec.Command(cmd[0], cmd[1:]...).Run(); err != nil {
            return err
        }
    }
    return nil
}

func createGitHubPR(service, message string) error {
    ctx := context.Background()
    ts := oauth2.StaticTokenSource(
        &oauth2.Token{AccessToken: os.Getenv("GITHUB_TOKEN")},
    )
    tc := oauth2.NewClient(ctx, ts)
    client := github.NewClient(tc)
    
    newPR := &github.NewPullRequest{
        Title: github.String(message),
        Head:  github.String("main"),
        Base:  github.String("main"),
        Body:  github.String("Automated rollback by self-healing system"),
    }
    
    _, _, err := client.PullRequests.Create(ctx, "myorg", "configs", newPR)
    return err
}

func toJSON(v interface{}) *bytes.Reader {
    b, _ := json.Marshal(v)
    return bytes.NewReader(b)
}
```

**éƒ¨ç½²**ï¼š

```bash
# æ„å»ºé•œåƒ
docker build -t myorg/pr-controller:v1.0 .

# éƒ¨ç½²åˆ° K8s
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pr-controller
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pr-controller
  template:
    metadata:
      labels:
        app: pr-controller
    spec:
      containers:
      - name: controller
        image: myorg/pr-controller:v1.0
        env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-token
              key: token
        ports:
        - containerPort: 9090
---
apiVersion: v1
kind: Service
metadata:
  name: pr-controller
  namespace: default
spec:
  selector:
    app: pr-controller
  ports:
  - port: 8080
    targetPort: 9090
EOF
```

---

## ç«¯åˆ°ç«¯æµ‹è¯•

### æ··æ²Œå®éªŒ

#### åœºæ™¯ 1ï¼šæ¨¡æ‹Ÿé«˜é”™è¯¯ç‡

```bash
# ä½¿ç”¨ Chaos Mesh æ³¨å…¥é”™è¯¯
kubectl apply -f - <<EOF
apiVersion: chaos-mesh.org/v1alpha1
kind: HTTPChaos
metadata:
  name: inject-errors
  namespace: default
spec:
  mode: all
  selector:
    namespaces:
    - default
    labelSelectors:
      app: myapp
  target: Response
  abort: true
  duration: 10m
  scheduler:
    cron: "@every 1m"
EOF
```

**é¢„æœŸç»“æœ**ï¼š

```text
1. Prometheus æ£€æµ‹åˆ°é”™è¯¯ç‡ > 5%
2. Alertmanager å‘é€ Webhook åˆ° OPA
3. OPA ç­–ç•¥åˆ¤æ–­ï¼šallow_rollback = true
4. PR Controller åˆ›å»ºå›æ»š PR
5. ArgoCD åŒæ­¥å›æ»š
6. é”™è¯¯ç‡æ¢å¤æ­£å¸¸
æ€»è€—æ—¶ï¼š< 2 åˆ†é’Ÿ
```

**éªŒè¯**ï¼š

```bash
# æŸ¥çœ‹å‘Šè­¦
kubectl port-forward -n observability svc/prometheus-alertmanager 9093:9093
# è®¿é—® http://localhost:9093

# æŸ¥çœ‹ OPA å†³ç­–æ—¥å¿—
kubectl logs -n policy-system deployment/opa-gateway

# æŸ¥çœ‹ Git PR
gh pr list --repo myorg/configs
```

---

## ç”Ÿäº§ä¼˜åŒ–

### 1. é™æµé˜²æŠ–

**é—®é¢˜**ï¼šé¿å…é¢‘ç¹å›æ»š

**è§£å†³**ï¼š

```rego
package selfheal

# é™æµï¼šæœ€å¤š 2 æ¬¡/30 åˆ†é’Ÿ
allow_rollback if {
    # ... å…¶ä»–æ¡ä»¶ ...
    
    # æŸ¥è¯¢æœ€è¿‘ 30 åˆ†é’Ÿçš„å›æ»šè®°å½•
    recent_rollbacks := http.send({
        "method": "GET",
        "url": "http://metrics-api/recent_rollbacks?service=myapp&window=30m"
    }).body
    
    count(recent_rollbacks) < 2
}
```

### 2. é‡‘ä¸é›€éªŒè¯

**é—®é¢˜**ï¼šå›æ»šåä»å¯èƒ½æœ‰é—®é¢˜

**è§£å†³**ï¼š

```yaml
# ArgoCD é…ç½®
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: myapp
spec:
  strategy:
    canary:
      steps:
      - setWeight: 10
      - pause: {duration: 5m}  # è§‚å¯Ÿ 5 åˆ†é’Ÿ
      - setWeight: 50
      - pause: {duration: 10m}
      analysis:
        templates:
        - templateName: error-rate-check
        args:
        - name: threshold
          value: "0.05"
```

### 3. é€šçŸ¥ä¸å®¡è®¡

**Slack é€šçŸ¥**ï¼š

```go
func notifySlack(action, service, reason string) {
    payload := map[string]interface{}{
        "text": fmt.Sprintf(":warning: Auto-healing action taken\nService: %s\nAction: %s\nReason: %s", 
            service, action, reason),
    }
    http.Post(os.Getenv("SLACK_WEBHOOK"), "application/json", toJSON(payload))
}
```

**å®¡è®¡æ—¥å¿—**ï¼š

```sql
-- è®°å½•æ‰€æœ‰è‡ªæ„ˆåŠ¨ä½œ
CREATE TABLE self_heal_actions (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT NOW(),
    service VARCHAR(255),
    action VARCHAR(50),
    reason TEXT,
    decision JSON,
    pr_url VARCHAR(512),
    success BOOLEAN
);
```

---

## ç›‘æ§é¢æ¿

### Grafana Dashboard JSON

```json
{
  "dashboard": {
    "title": "Self-Healing System",
    "panels": [
      {
        "title": "Auto-Healing Actions (24h)",
        "targets": [{
          "expr": "sum(self_heal_actions_total) by (action)"
        }],
        "type": "timeseries"
      },
      {
        "title": "MTTR",
        "targets": [{
          "expr": "avg(self_heal_mttr_seconds)"
        }],
        "type": "stat"
      },
      {
        "title": "Success Rate",
        "targets": [{
          "expr": "sum(self_heal_success_total) / sum(self_heal_actions_total)"
        }],
        "type": "gauge"
      }
    ]
  }
}
```

---

## æˆæœ¬åˆ†æ

### èµ„æºéœ€æ±‚

| ç»„ä»¶ | CPU | å†…å­˜ | å­˜å‚¨ | å‰¯æœ¬ | æˆæœ¬/æœˆ |
|-----|-----|------|------|------|---------|
| OTEL Collector | 0.5 æ ¸ | 512 MB | - | 2 | $20 |
| Prometheus | 2 æ ¸ | 4 GB | 100 GB | 2 | $150 |
| OPA | 0.5 æ ¸ | 256 MB | - | 2 | $15 |
| PR Controller | 0.2 æ ¸ | 128 MB | - | 1 | $5 |
| ArgoCD | 1 æ ¸ | 1 GB | 10 GB | 2 | $60 |
| **æ€»è®¡** | **4.7 æ ¸** | **6 GB** | **110 GB** | - | **$250** |

### ROI è®¡ç®—

**ä¼ ç»Ÿè¿ç»´æˆæœ¬**ï¼š

```text
å€¼ç­å·¥ç¨‹å¸ˆï¼š2 äºº Ã— $8K/æœˆ = $16K/æœˆ
å¹³å‡æ•…éšœï¼š10 æ¬¡/æœˆ Ã— 30 min Ã— $200/å°æ—¶ = $1K/æœˆ
æ€»è®¡ï¼š$17K/æœˆ
```

**è‡ªæ„ˆç³»ç»Ÿ**ï¼š

```text
åŸºç¡€è®¾æ–½ï¼š$250/æœˆ
äººå·¥ä»‹å…¥ï¼š1 æ¬¡/æœˆ Ã— 30 min Ã— $200/å°æ—¶ = $100/æœˆ
æ€»è®¡ï¼š$350/æœˆ

èŠ‚çœï¼š$17K - $350 = $16.65K/æœˆ (98%)
ROIï¼š16650 / 250 = 66 å€
```

---

## å…³é”®æ´å¯Ÿ

### æ´å¯Ÿ 1ï¼š60 ç§’é»„é‡‘çª—å£

**MTTR åˆ†è§£**ï¼š

```text
0-10s:   OTLP é‡‡é›†æŒ‡æ ‡
10-30s:  Prometheus è§¦å‘å‘Šè­¦
30-40s:  OPA ç­–ç•¥åˆ¤æ–­
40-50s:  åˆ›å»º Git PR
50-60s:  ArgoCD åŒæ­¥å›æ»š
60s+:    éªŒè¯æ¢å¤

å…³é”®ï¼šæ¯ä¸ªç¯èŠ‚éƒ½è¦ä¼˜åŒ–
```

### æ´å¯Ÿ 2ï¼šç­–ç•¥æ˜¯æ ¸å¿ƒ

ç³»ç»Ÿè´¨é‡ = ç­–ç•¥è´¨é‡

- å¥½çš„ç­–ç•¥ï¼šç²¾å‡†è§¦å‘ï¼Œè¯¯æŠ¥ç‡ < 1%
- å·®çš„ç­–ç•¥ï¼šé¢‘ç¹è¯¯è§¦å‘ï¼Œåè€Œå¢åŠ æ•…éšœ

### æ´å¯Ÿ 3ï¼šæ¸è¿›å¼æ¨å¹¿

**ä¸è¦ä¸€æ­¥åˆ°ä½**ï¼š

```text
é˜¶æ®µ 1ï¼ˆ1 å‘¨ï¼‰ï¼šéç”Ÿäº§ç¯å¢ƒéªŒè¯
é˜¶æ®µ 2ï¼ˆ2 å‘¨ï¼‰ï¼šç”Ÿäº§ç¯å¢ƒå•ä¸ªæœåŠ¡
é˜¶æ®µ 3ï¼ˆ1 æœˆï¼‰ï¼šæ‰©å±•åˆ° 10 ä¸ªæœåŠ¡
é˜¶æ®µ 4ï¼ˆ3 æœˆï¼‰ï¼šå…¨é‡æœåŠ¡
```

---

## ç›¸å…³ä¸»é¢˜

- [4.1 è‡ªæ„ˆæ¶æ„åŸç†](./04.1_Self_Healing_Architecture.md)
- [4.2 OTLP å¯è§‚æµ‹æ€§](./04.2_OTLP_Observability.md)
- [4.3 OPA ç­–ç•¥å¼•æ“](./04.3_OPA_Policy_Engine.md)
- [4.4 GitOps å£°æ˜å¼ä¿®å¤](./04.4_GitOps_Declarative_Remediation.md)

---
