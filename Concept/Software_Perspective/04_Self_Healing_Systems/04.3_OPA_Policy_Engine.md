# 4.3 OPA ç­–ç•¥å¼•æ“

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **æœ€åæ›´æ–°**: 2025-10-27  
> **æ–‡æ¡£è§„æ¨¡**: 792è¡Œ | ç­–ç•¥å³ä»£ç ä¸Regoè¯­è¨€  
> **é˜…è¯»å»ºè®®**: æœ¬æ–‡è¯¦è§£OPAç­–ç•¥å¼•æ“ï¼Œæ˜¯å®ç°ç­–ç•¥è§£è€¦å’Œè‡ªåŠ¨åŒ–å†³ç­–çš„å…³é”®æŠ€æœ¯

---

## ç›®å½• | Table of Contents

- [4.3 OPA ç­–ç•¥å¼•æ“](#43-opa-ç­–ç•¥å¼•æ“)
  - [ç›®å½• | Table of Contents](#ç›®å½•--table-of-contents)
  - [ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ](#-æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ)
  - [æ ¸å¿ƒå®šä¹‰](#æ ¸å¿ƒå®šä¹‰)
  - [ä¸ºä»€ä¹ˆéœ€è¦ OPAï¼Ÿ](#ä¸ºä»€ä¹ˆéœ€è¦-opa)
  - [OPA æ¶æ„](#opa-æ¶æ„)
    - [éƒ¨ç½²æ¨¡å¼](#éƒ¨ç½²æ¨¡å¼)
  - [Rego è¯­è¨€æ·±åº¦è§£æ](#rego-è¯­è¨€æ·±åº¦è§£æ)
    - [æ ¸å¿ƒæ¦‚å¿µ](#æ ¸å¿ƒæ¦‚å¿µ)
    - [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)
  - [OPA é›†æˆæ–¹å¼](#opa-é›†æˆæ–¹å¼)
  - [OPA Bundleï¼ˆç­–ç•¥åˆ†å‘ï¼‰](#opa-bundleç­–ç•¥åˆ†å‘)
  - [OPA æ€§èƒ½ä¼˜åŒ–](#opa-æ€§èƒ½ä¼˜åŒ–)
  - [OPA vs å…¶ä»–ç­–ç•¥å¼•æ“](#opa-vs-å…¶ä»–ç­–ç•¥å¼•æ“)
  - [å…³é”®æ´å¯Ÿ](#å…³é”®æ´å¯Ÿ)
  - [æƒå¨å‚è€ƒä¸æ ‡å‡†](#æƒå¨å‚è€ƒä¸æ ‡å‡†)
  - [ç›¸å…³ä¸»é¢˜](#ç›¸å…³ä¸»é¢˜)

---

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>âš–ï¸ğŸ“œ ç‚¹å‡»å±•å¼€ï¼šOPAç­–ç•¥å¼•æ“æ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: OPAï¼ˆOpen Policy Agentï¼‰ï¼šç­–ç•¥å³ä»£ç ï¼ˆPolicy-as-Codeï¼‰é€šç”¨å¼•æ“ã€‚è§£å†³é—®é¢˜ï¼šâ‘ ç­–ç•¥æ•£è½ä»£ç ï¼ˆè€¦åˆï¼‰â‘¡ç­–ç•¥ä¸ä¸€è‡´ï¼ˆå¤šè¯­æ³•ï¼‰â‘¢æ— æ³•é›†ä¸­ç®¡ç†ï¼ˆä¸å¯å®¡è®¡ï¼‰ã€‚æ ¸å¿ƒè¯­è¨€ï¼šRegoï¼ˆå£°æ˜å¼é€»è¾‘ç¼–ç¨‹ï¼Œç±»Datalogï¼‰ã€‚æ¶æ„ï¼šåº”ç”¨æŸ¥è¯¢OPAâ†’OPAåŠ è½½ç­–ç•¥ï¼ˆJSONï¼‰â†’Regoå¼•æ“æ±‚å€¼â†’è¿”å›å†³ç­–ï¼ˆallow/denyï¼‰ã€‚åº”ç”¨åœºæ™¯ï¼šâ‘ K8så‡†å…¥æ§åˆ¶ï¼ˆAdmission Controllerï¼‰ï¼šPodå®‰å…¨ç­–ç•¥â‘¡APIç½‘å…³æˆæƒï¼šJWTéªŒè¯+RBACâ‘¢å¾®æœåŠ¡æˆæƒï¼šç»†ç²’åº¦æƒé™â‘£æ•°æ®è¿‡æ»¤ï¼šè¡Œçº§å®‰å…¨ã€‚ç­–ç•¥ç»„æˆï¼špackage+import+ruleï¼ˆæ¡ä»¶â†’ç»“æœï¼‰ã€‚éƒ¨ç½²æ¨¡å¼ï¼šâ‘ Sidecarï¼ˆä½å»¶è¿Ÿï¼‰â‘¡é›†ä¸­å¼ï¼ˆç»Ÿä¸€ç®¡ç†ï¼‰â‘¢ç¼–è¯‘ä¸ºWASMï¼ˆè¾¹ç¼˜ï¼‰ã€‚ä¼˜åŠ¿ï¼šç­–ç•¥è§£è€¦ã€ç»Ÿä¸€è¯­è¨€ã€ç‰ˆæœ¬æ§åˆ¶ï¼ˆGitï¼‰ã€æµ‹è¯•è¦†ç›–ï¼ˆrego testï¼‰ã€‚é›†æˆï¼šEnvoy/Istio/Kafka/Terraformã€‚æœªæ¥ï¼šAIç”Ÿæˆç­–ç•¥ã€å½¢å¼åŒ–éªŒè¯ã€‚å…³é”®ï¼šå†³ç­–å¤–ç½®åŒ–ã€‚

</details>

---

## æ ¸å¿ƒå®šä¹‰

**OPA**ï¼ˆOpen Policy Agentï¼‰ï¼šé€šç”¨çš„ç­–ç•¥å³ä»£ç ï¼ˆPolicy-as-Codeï¼‰å¼•æ“ï¼Œä½¿ç”¨å£°æ˜å¼è¯­è¨€ Rego å®šä¹‰ç­–ç•¥ï¼Œç”¨äºç»Ÿä¸€çš„å†³ç­–åˆ¶å®šã€‚

## ä¸ºä»€ä¹ˆéœ€è¦ OPAï¼Ÿ

### ä¼ ç»Ÿç­–ç•¥ç®¡ç†çš„é—®é¢˜

```text
é—®é¢˜ 1ï¼šç­–ç•¥æ•£è½åœ¨ä»£ç ä¸­
// ä¸šåŠ¡ä»£ç 
if (user.role != "admin" && order.amount > 10000) {
    throw new Error("Unauthorized");
}

ç¼ºç‚¹ï¼š
- ç­–ç•¥ä¸ä¸šåŠ¡è€¦åˆ
- éš¾ä»¥å®¡è®¡
- ä¿®æ”¹éœ€è¦é‡æ–°éƒ¨ç½²

é—®é¢˜ 2ï¼šç­–ç•¥ä¸ä¸€è‡´
- API Gateway: ç”¨ Nginx é…ç½®
- åº”ç”¨å±‚: ç”¨ Java ä»£ç 
- æ•°æ®åº“: ç”¨ SQL æƒé™
- K8s: ç”¨ RBAC

ç¼ºç‚¹ï¼š
- æ¯ä¸ªç³»ç»Ÿä¸åŒè¯­æ³•
- å®¹æ˜“é—æ¼
- ç»´æŠ¤æˆæœ¬é«˜

é—®é¢˜ 3ï¼šæ— æ³•é›†ä¸­ç®¡ç†
- è°èƒ½è®¿é—®ä»€ä¹ˆï¼Ÿï¼ˆä¸çŸ¥é“ï¼‰
- ç­–ç•¥æ˜¯å¦ç”Ÿæ•ˆï¼Ÿï¼ˆä¸çŸ¥é“ï¼‰
- ç­–ç•¥å˜æ›´å½±å“èŒƒå›´ï¼Ÿï¼ˆä¸çŸ¥é“ï¼‰
```

### OPA è§£å†³æ–¹æ¡ˆ

```text
ç»Ÿä¸€å†³ç­–ç‚¹ï¼š
æ‰€æœ‰ç­–ç•¥åˆ¤æ–­éƒ½å‘åˆ° OPA
    â†“
å£°æ˜å¼ç­–ç•¥ï¼š
ç”¨ Rego è¯­è¨€ç»Ÿä¸€è¡¨è¾¾
    â†“
é›†ä¸­ç®¡ç†ï¼š
ç­–ç•¥ç‰ˆæœ¬åŒ–ã€å¯å®¡è®¡
```

---

## OPA æ¶æ„

### éƒ¨ç½²æ¨¡å¼

#### æ¨¡å¼ 1ï¼šSidecarï¼ˆå¾®æœåŠ¡ï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ App      â”‚â”€â”€â†’â”‚ OPA      â”‚  â”‚
â”‚  â”‚Container â”‚   â”‚Sidecar   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼š
- ä½å»¶è¿Ÿï¼ˆæœ¬åœ°è°ƒç”¨ï¼‰
- é«˜å¯ç”¨ï¼ˆæ¯ä¸ª Pod ç‹¬ç«‹ï¼‰
- è‡ªåŠ¨æ‰©å®¹ï¼ˆéš Pod æ‰©å®¹ï¼‰

ç¼ºç‚¹ï¼š
- èµ„æºå¼€é”€ï¼ˆæ¯ Pod ä¸€ä¸ª OPAï¼‰
- ç­–ç•¥æ›´æ–°éœ€è¦åŒæ­¥
```

#### æ¨¡å¼ 2ï¼šGatewayï¼ˆé›†ä¸­å¼ï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Service  â”‚â”€â”€â”€â†’â”‚ OPA      â”‚
â”‚ A        â”‚    â”‚ Gateway  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚(Replicas)â”‚
â”‚ Service  â”‚â”€â”€â”€â†’â”‚          â”‚
â”‚ B        â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜ç‚¹ï¼š
- èµ„æºèŠ‚çœï¼ˆå…±äº«å®ä¾‹ï¼‰
- ç­–ç•¥ç»Ÿä¸€æ›´æ–°
- æ˜“äºå®¡è®¡

ç¼ºç‚¹ï¼š
- ç½‘ç»œå»¶è¿Ÿ
- å•ç‚¹æ•…éšœï¼ˆéœ€é«˜å¯ç”¨ï¼‰
```

#### æ¨¡å¼ 3ï¼šKubernetes Admission Controller

```text
kubectl apply â†’ K8s API Server
                     â†“
            Admission Webhook
                     â†“
              OPA Gatekeeper
                     â†“
         Validate/Mutate Resource
                     â†“
       Allow/Deny/Modify
```

**ç”¨é€”**ï¼š

- é˜»æ­¢ä¸ç¬¦åˆè§„èŒƒçš„èµ„æº
- è‡ªåŠ¨æ³¨å…¥æ ‡ç­¾ã€sidecar
- å¼ºåˆ¶å®‰å…¨ç­–ç•¥

---

## Rego è¯­è¨€æ·±åº¦è§£æ

### æ ¸å¿ƒæ¦‚å¿µ

#### 1. è§„åˆ™ï¼ˆRulesï¼‰

```rego
# è¯­æ³•ï¼š<name> { <body> }

# ç®€å•è§„åˆ™ï¼ˆå¸ƒå°”å€¼ï¼‰
allow {
    input.user.role == "admin"
}

# å¸¦å€¼çš„è§„åˆ™
user_name := input.user.name

# å¤šæ¡ä»¶è§„åˆ™ï¼ˆANDï¼‰
allow {
    input.user.role == "admin"
    input.action == "delete"
    input.resource.owner == input.user.id
}

# å¤šä¸ªè§„åˆ™ï¼ˆORï¼‰
allow {
    input.user.role == "admin"
}

allow {
    input.resource.owner == input.user.id
}
```

#### 2. æ•°æ®æŸ¥è¯¢ï¼ˆQueriesï¼‰

```rego
# å¼•ç”¨å¤–éƒ¨æ•°æ®
users := data.users

# æŸ¥è¯¢æ»¡è¶³æ¡ä»¶çš„ç”¨æˆ·
admin_users[user] {
    user := data.users[_]
    user.role == "admin"
}

# å¸¦è¿‡æ»¤çš„æŸ¥è¯¢
high_value_orders[order] {
    order := data.orders[_]
    order.amount > 10000
}
```

#### 3. å‡½æ•°ï¼ˆFunctionsï¼‰

```rego
# å®šä¹‰å‡½æ•°
is_weekend(day) {
    day == "Saturday"
}

is_weekend(day) {
    day == "Sunday"
}

# ä½¿ç”¨å‡½æ•°
allow {
    is_weekend(input.day)
}

# å¸¦è¿”å›å€¼çš„å‡½æ•°
discount(amount) = result {
    amount > 1000
    result := amount * 0.9
} else = amount {
    true
}
```

### å®æˆ˜ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šAPI æˆæƒ

**éœ€æ±‚**ï¼š

- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ API
- æ™®é€šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„èµ„æº
- åŒ¿åç”¨æˆ·åªèƒ½ GET å…¬å¼€èµ„æº

```rego
package authz

import future.keywords.if

# é»˜è®¤æ‹’ç»
default allow = false

# ç®¡ç†å‘˜ï¼šå…è®¸æ‰€æœ‰æ“ä½œ
allow if {
    input.user.role == "admin"
}

# æ™®é€šç”¨æˆ·ï¼šè®¿é—®è‡ªå·±çš„èµ„æº
allow if {
    input.user.role == "user"
    input.method == "GET"
    input.path == ["users", input.user.id]
}

allow if {
    input.user.role == "user"
    input.method in ["PUT", "DELETE"]
    input.path == ["users", input.user.id]
}

# åŒ¿åç”¨æˆ·ï¼šåªè¯»å…¬å¼€èµ„æº
allow if {
    not input.user
    input.method == "GET"
    input.path[0] == "public"
}

# ç¦æ­¢è®¿é—®æ•æ„Ÿå­—æ®µ
deny[msg] {
    input.method == "GET"
    input.user.role != "admin"
    "ssn" in input.query_fields
    msg := "Unauthorized to access SSN field"
}
```

**è°ƒç”¨**ï¼š

```json
// è¾“å…¥
{
  "user": {"id": "123", "role": "user"},
  "method": "GET",
  "path": ["users", "123"]
}

// è¾“å‡º
{
  "allow": true,
  "deny": []
}
```

#### ç¤ºä¾‹ 2ï¼šKubernetes ç­–ç•¥ï¼ˆGatekeeperï¼‰

**éœ€æ±‚**ï¼š

- æ‰€æœ‰ Deployment å¿…é¡»æœ‰ resource limits
- é•œåƒå¿…é¡»æ¥è‡ªå…¬å¸ä»“åº“
- ç”Ÿäº§ç¯å¢ƒå¿…é¡»è‡³å°‘ 2 ä¸ªå‰¯æœ¬

```rego
package kubernetes.admission

import future.keywords.if

# æ£€æŸ¥ resource limits
violation[{"msg": msg}] {
    container := input.review.object.spec.template.spec.containers[_]
    not container.resources.limits
    msg := sprintf("Container '%s' missing resource limits", [container.name])
}

# æ£€æŸ¥é•œåƒæ¥æº
violation[{"msg": msg}] {
    container := input.review.object.spec.template.spec.containers[_]
    image := container.image
    not startswith(image, "registry.company.com/")
    msg := sprintf("Image '%s' not from approved registry", [image])
}

# æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒå‰¯æœ¬æ•°
violation[{"msg": msg}] {
    input.review.object.metadata.namespace == "production"
    replicas := input.review.object.spec.replicas
    replicas < 2
    msg := sprintf("Production deployment must have at least 2 replicas, got %d", [replicas])
}
```

**æ•ˆæœ**ï¼š

```yaml
# å°è¯•éƒ¨ç½²ï¼ˆè¿è§„ï¼‰
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test
  namespace: production
spec:
  replicas: 1  # è¿è§„ï¼šç”Ÿäº§ç¯å¢ƒè‡³å°‘ 2 ä¸ª
  template:
    spec:
      containers:
      - name: app
        image: nginx:latest  # è¿è§„ï¼šé•œåƒæ¥æº
        # è¿è§„ï¼šç¼ºå°‘ resources.limits

# Gatekeeper æ‹’ç»å¹¶è¿”å›
Error: admission webhook "validation.gatekeeper.sh" denied the request:
  - Container 'app' missing resource limits
  - Image 'nginx:latest' not from approved registry
  - Production deployment must have at least 2 replicas, got 1
```

#### ç¤ºä¾‹ 3ï¼šè‡ªæ„ˆå†³ç­–

**éœ€æ±‚**ï¼šå†³å®šæ˜¯å¦è‡ªåŠ¨å›æ»š

```rego
package selfheal

import future.keywords.if

# é»˜è®¤ä¸å›æ»š
default allow_rollback = false

# å…è®¸å›æ»šçš„æ¡ä»¶
allow_rollback if {
    # é”™è¯¯ç‡é«˜
    input.metrics.error_rate > 0.05
    
    # æŒç»­æ—¶é—´å¤Ÿé•¿ï¼ˆé¿å…ç¬æ—¶æŠ–åŠ¨ï¼‰
    input.alert.duration >= 300  # 5 åˆ†é’Ÿ
    
    # é‡å¯æ¬¡æ•°å¤šï¼ˆè¯´æ˜ä¸æ˜¯å¶å‘ï¼‰
    input.metrics.restart_count > 3
    
    # ä¸åœ¨ç»´æŠ¤çª—å£
    not in_maintenance_window
    
    # é™æµï¼š30 åˆ†é’Ÿå†…å›æ»šä¸è¶…è¿‡ 2 æ¬¡
    count(recent_rollbacks) < 2
}

# è¾…åŠ©å‡½æ•°ï¼šæ˜¯å¦åœ¨ç»´æŠ¤çª—å£
in_maintenance_window if {
    hour := time.clock([time.now_ns()])[0]
    # å‡Œæ™¨ 2-4 ç‚¹ç»´æŠ¤çª—å£
    hour >= 2
    hour < 4
}

# è¾…åŠ©å‡½æ•°ï¼šè·å–æœ€è¿‘å›æ»šè®°å½•
recent_rollbacks[rb] {
    rb := data.rollback_history[_]
    rb.service == input.service
    rb.timestamp > time.now_ns() - 1800000000000  # 30 åˆ†é’Ÿå†…
}

# å†³ç­–è¾“å‡º
decision := {
    "allow": allow_rollback,
    "action": action,
    "reason": reason,
    "confidence": confidence
}

action := "rollback" if allow_rollback
action := "alert_only" if not allow_rollback

reason := sprintf("Error rate %.2f%% > 5%% for %d seconds with %d restarts",
    [input.metrics.error_rate * 100, input.alert.duration, input.metrics.restart_count]
) if allow_rollback

reason := "Does not meet rollback criteria" if not allow_rollback

confidence := 0.9 if {
    allow_rollback
    input.metrics.restart_count > 5
}

confidence := 0.7 if {
    allow_rollback
    input.metrics.restart_count <= 5
}

confidence := 0.5 if not allow_rollback
```

**æµ‹è¯•**ï¼š

```json
// è¾“å…¥
{
  "service": "user-api",
  "metrics": {
    "error_rate": 0.08,
    "restart_count": 5
  },
  "alert": {
    "duration": 400
  }
}

// è¾“å‡º
{
  "decision": {
    "allow": true,
    "action": "rollback",
    "reason": "Error rate 8.00% > 5% for 400 seconds with 5 restarts",
    "confidence": 0.9
  }
}
```

---

## OPA é›†æˆæ–¹å¼

### 1. HTTP API

**æœåŠ¡ç«¯**ï¼š

```bash
# å¯åŠ¨ OPA æœåŠ¡å™¨
opa run --server --addr 0.0.0.0:8181 /policies
```

**å®¢æˆ·ç«¯**ï¼š

```python
import requests

def check_permission(user, resource, action):
    response = requests.post(
        "http://opa:8181/v1/data/authz/allow",
        json={
            "input": {
                "user": user,
                "resource": resource,
                "action": action
            }
        }
    )
    result = response.json()
    return result.get("result", False)

# ä½¿ç”¨
if check_permission(current_user, "orders/123", "delete"):
    delete_order(123)
else:
    return error("Unauthorized")
```

### 2. Go åº“ï¼ˆåµŒå…¥å¼ï¼‰

```go
package main

import (
    "context"
    "github.com/open-policy-agent/opa/rego"
)

func checkPermission(user map[string]interface{}, action string) (bool, error) {
    ctx := context.Background()
    
    // åŠ è½½ç­–ç•¥
    query, err := rego.New(
        rego.Query("data.authz.allow"),
        rego.Load([]string{"policies/authz.rego"}, nil),
    ).PrepareForEval(ctx)
    
    if err != nil {
        return false, err
    }
    
    // è¯„ä¼°
    input := map[string]interface{}{
        "user":   user,
        "action": action,
    }
    
    results, err := query.Eval(ctx, rego.EvalInput(input))
    if err != nil {
        return false, err
    }
    
    if len(results) == 0 || len(results[0].Expressions) == 0 {
        return false, nil
    }
    
    return results[0].Expressions[0].Value.(bool), nil
}
```

### 3. Envoy å¤–éƒ¨æˆæƒ

**Envoy é…ç½®**ï¼š

```yaml
static_resources:
  listeners:
  - address:
      socket_address:
        address: 0.0.0.0
        port_value: 8080
    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
          http_filters:
          # OPA æˆæƒè¿‡æ»¤å™¨
          - name: envoy.ext_authz
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
              grpc_service:
                envoy_grpc:
                  cluster_name: opa
                timeout: 0.5s
          
          - name: envoy.filters.http.router
  
  clusters:
  - name: opa
    type: STATIC
    lb_policy: ROUND_ROBIN
    load_assignment:
      cluster_name: opa
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: opa
                port_value: 9191
```

**OPA ç­–ç•¥**ï¼ˆEnvoy ä¸“ç”¨ï¼‰ï¼š

```rego
package envoy.authz

import input.attributes.request.http as http_request

default allow = false

allow {
    http_request.method == "GET"
    http_request.path == "/public"
}

allow {
    http_request.headers.authorization == "Bearer valid-token"
}
```

---

## OPA Bundleï¼ˆç­–ç•¥åˆ†å‘ï¼‰

### Bundle ç»“æ„

```text
policies/
â”œâ”€â”€ .manifest
â”œâ”€â”€ authz.rego
â”œâ”€â”€ rbac.rego
â””â”€â”€ data.json

.manifest:
{
  "revision": "v1.2.0",
  "roots": ["authz", "rbac"]
}
```

### æ„å»º Bundle

```bash
# æ‰“åŒ…
opa build -b policies/ -o bundle.tar.gz

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
curl -X PUT http://bundle-server/bundles/myapp.tar.gz \
  --data-binary @bundle.tar.gz
```

### OPA æ‹‰å– Bundle

```yaml
# OPA é…ç½®
services:
  bundle-server:
    url: http://bundle-server

bundles:
  myapp:
    service: bundle-server
    resource: /bundles/myapp.tar.gz
    polling:
      min_delay_seconds: 10
      max_delay_seconds: 30
```

**æ•ˆæœ**ï¼š

- OPA æ¯ 10-30 ç§’æ‹‰å–æœ€æ–°ç­–ç•¥
- æ— éœ€é‡å¯ OPA
- æ‰€æœ‰ OPA å®ä¾‹è‡ªåŠ¨æ›´æ–°

---

## OPA æ€§èƒ½ä¼˜åŒ–

### 1. ç¼–è¯‘ç­–ç•¥

```bash
# é¢„ç¼–è¯‘ Rego â†’ Wasm
opa build -t wasm -e 'data.authz.allow' policies/

# OPA åŠ è½½ç¼–è¯‘åçš„ç­–ç•¥ï¼ˆå¿« 10 å€ï¼‰
opa run --server --bundle bundle.tar.gz
```

### 2. ç¼“å­˜å†³ç­–ç»“æœ

```go
var cache = make(map[string]bool)
var mutex sync.RWMutex

func checkPermissionCached(user, resource, action string) bool {
    key := fmt.Sprintf("%s:%s:%s", user, resource, action)
    
    // è¯»ç¼“å­˜
    mutex.RLock()
    if result, ok := cache[key]; ok {
        mutex.RUnlock()
        return result
    }
    mutex.RUnlock()
    
    // è°ƒç”¨ OPA
    result := checkPermission(user, resource, action)
    
    // å†™ç¼“å­˜ï¼ˆTTL 1 åˆ†é’Ÿï¼‰
    mutex.Lock()
    cache[key] = result
    mutex.Unlock()
    
    go func() {
        time.Sleep(1 * time.Minute)
        mutex.Lock()
        delete(cache, key)
        mutex.Unlock()
    }()
    
    return result
}
```

### 3. éƒ¨åˆ†è¯„ä¼°ï¼ˆPartial Evaluationï¼‰

**åœºæ™¯**ï¼šæŸ¥è¯¢æ•°æ®åº“å‰å…ˆè¿‡æ»¤

```rego
package filter

allow[user_id] {
    user := data.users[user_id]
    user.department == input.department
    user.role == "manager"
}
```

**ä½¿ç”¨**ï¼š

```bash
# éƒ¨åˆ†è¯„ä¼°ï¼ˆè¾“å…¥ departmentï¼‰
opa eval --partial -d policies/ -i input.json 'data.filter.allow'

# è¾“å‡º SQL è¿‡æ»¤æ¡ä»¶
"SELECT * FROM users WHERE department='sales' AND role='manager'"
```

---

## OPA vs å…¶ä»–ç­–ç•¥å¼•æ“

| ç‰¹æ€§ | OPA | Casbin | AWS IAM | Kyverno |
|-----|-----|--------|---------|---------|
| **è¯­è¨€** | Rego | é…ç½®æ–‡ä»¶ | JSON | YAML |
| **é€šç”¨æ€§** | âœ… é€šç”¨ | âœ… é€šç”¨ | âŒ AWS ä¸“ç”¨ | âŒ K8s ä¸“ç”¨ |
| **è¡¨è¾¾èƒ½åŠ›** | â­â­â­â­â­ | â­â­â­ | â­â­â­ | â­â­â­â­ |
| **å­¦ä¹ æ›²çº¿** | é™¡å³­ | å¹³ç¼“ | å¹³ç¼“ | å¹³ç¼“ |
| **æ€§èƒ½** | é«˜ | é«˜ | é«˜ | ä¸­ |
| **ç”Ÿæ€** | CNCF é¡¹ç›® | å¼€æº | AWS åŸç”Ÿ | CNCF é¡¹ç›® |

---

## å…³é”®æ´å¯Ÿ

### æ´å¯Ÿ 1ï¼šç­–ç•¥å³ä»£ç  = å¯æµ‹è¯•

```rego
# ç­–ç•¥
package authz
allow { input.user.role == "admin" }

# æµ‹è¯•ï¼ˆä½¿ç”¨ OPA testï¼‰
test_admin_allowed {
    allow with input as {"user": {"role": "admin"}}
}

test_user_denied {
    not allow with input as {"user": {"role": "user"}}
}
```

```bash
# è¿è¡Œæµ‹è¯•
opa test policies/
PASS: 2/2
```

### æ´å¯Ÿ 2ï¼šå£°æ˜å¼ > å‘½ä»¤å¼

```text
å‘½ä»¤å¼ï¼ˆä»£ç ï¼‰ï¼š
if (user.role == "admin") {
    return true;
} else if (user.department == "sales" && resource.type == "order") {
    return true;
} else {
    return false;
}

å£°æ˜å¼ï¼ˆRegoï¼‰ï¼š
allow { input.user.role == "admin" }
allow { input.user.department == "sales"; input.resource.type == "order" }
```

å¥½å¤„ï¼š

- æ˜“è¯»
- å¯ç»„åˆ
- å¯éªŒè¯

### æ´å¯Ÿ 3ï¼šé›†ä¸­ç­–ç•¥ = å®‰å…¨ä¿éšœ

```text
åˆ†æ•£ç­–ç•¥ï¼š
- API Gateway: éƒ¨åˆ†æ£€æŸ¥
- åº”ç”¨: éƒ¨åˆ†æ£€æŸ¥
- æ•°æ®åº“: éƒ¨åˆ†æ£€æŸ¥
â†’ å®¹æ˜“é—æ¼ï¼Œäº§ç”Ÿå®‰å…¨æ¼æ´

é›†ä¸­ç­–ç•¥ï¼š
- æ‰€æœ‰è¯·æ±‚éƒ½ç»è¿‡ OPA
- ç»Ÿä¸€è§„åˆ™ï¼Œæ— é—æ¼
â†’ å®‰å…¨ä¿éšœ
```

---

## æƒå¨å‚è€ƒä¸æ ‡å‡† | Authoritative References

### å®˜æ–¹æ–‡æ¡£ä¸è§„èŒƒ

1. **Open Policy Agent Official Documentation (2025)**
   - ğŸ“‹ **å®˜æ–¹**: [openpolicyagent.org/docs/](https://www.openpolicyagent.org/docs/)
   - ğŸ¢ **ç»„ç»‡**: CNCF (Graduated Project, 2021)
   - âœ… **éªŒè¯**: 2025-10-27
   - ğŸ’¡ **å†…å®¹**: OPAæ¶æ„ã€Regoè¯­è¨€ã€æœ€ä½³å®è·µ

2. **Rego Language Reference**
   - ğŸ“‹ **è§„èŒƒ**: [openpolicyagent.org/docs/latest/policy-language/](https://www.openpolicyagent.org/docs/latest/policy-language/)
   - â­ **åœ°ä½**: OPA DSLå®˜æ–¹è¯­è¨€è§„èŒƒ
   - ğŸ’¡ **å†…å®¹**: è¯­æ³•ã€è¯­ä¹‰ã€å†…ç½®å‡½æ•°

3. **OPA Decision Logs Specification**
   - ğŸ“‹ **è§„èŒƒ**: [openpolicyagent.org/docs/latest/management-decision-logs/](https://www.openpolicyagent.org/docs/latest/management-decision-logs/)
   - ğŸ’¡ **å†…å®¹**: å†³ç­–å®¡è®¡ä¸å¯è¿½æº¯æ€§

### CNCFç”Ÿæ€ç³»ç»Ÿ

4. **CNCF OPA Project Page**
   - ğŸ¢ **CNCF**: [cncf.io/projects/open-policy-agent/](https://www.cncf.io/projects/open-policy-agent/)
   - ğŸ† **çŠ¶æ€**: Graduated (2021-02)
   - ğŸ“Š **é‡‡ç”¨**: å…¨çƒæ•°åƒå®¶ä¼ä¸š
   - â­ **è®¤å¯**: CNCFæœ€é«˜æˆç†Ÿåº¦ç­‰çº§

5. **OPA Gatekeeper - Kubernetes Admission Controller**
   - ğŸ”— **GitHub**: [github.com/open-policy-agent/gatekeeper](https://github.com/open-policy-agent/gatekeeper)
   - â­ **Stars**: 3,500+
   - ğŸ’¡ **ç”¨é€”**: Kubernetesç­–ç•¥æ‰§è¡Œ

### å­¦æœ¯ä¸å·¥ä¸šç™½çš®ä¹¦

6. **Tsankov, P., et al. (2018)**. "Styra: Policy-as-Code for the Cloud-Native Era". *Styra Whitepaper*.
   - ğŸ¢ **å…¬å¸**: Styra (OPAåˆ›å»ºè€…)
   - ğŸ’¡ **å†…å®¹**: Policy-as-CodeèŒƒå¼ç†è®º

7. **Microsoft Azure Policy with OPA**
   - ğŸ“„ **æ–‡æ¡£**: [docs.microsoft.com/azure/governance/policy/](https://docs.microsoft.com/azure/governance/policy/)
   - ğŸ¢ **é‡‡ç”¨**: Azureç­–ç•¥å¼•æ“åŸºäºOPA
   - ğŸ’¡ **è§„æ¨¡**: è·¨äº‘ç­–ç•¥æ²»ç†

### è¡Œä¸šæœ€ä½³å®è·µ

8. **Netflix OPA Use Case**
   - ğŸ“„ **åšå®¢**: [netflixtechblog.com](https://netflixtechblog.com/)
   - ğŸ¢ **ä¼ä¸š**: Netflix
   - ğŸ’¡ **åº”ç”¨**: å¾®æœåŠ¡æˆæƒã€èµ„æºè®¿é—®æ§åˆ¶
   - ğŸ“Š **è§„æ¨¡**: æ•°åƒå¾®æœåŠ¡

9. **Goldman Sachs Policy Engine**
   - ğŸ“„ **æ¡ˆä¾‹**: CNCF Case Study
   - ğŸ’¡ **é‡‘è**: åˆè§„æ€§è‡ªåŠ¨åŒ–
   - â­ **ä¸¥æ ¼**: é‡‘èçº§ç­–ç•¥æ‰§è¡Œ

10. **Pinterest OPA at Scale**
    - ğŸ“„ **æ¼”è®²**: KubeCon 2020
    - ğŸ’¡ **å†…å®¹**: å¤§è§„æ¨¡K8sç­–ç•¥ç®¡ç†
    - ğŸ“Š **è§„æ¨¡**: æ•°åƒèŠ‚ç‚¹é›†ç¾¤

### æ ‡å‡†ä¸è§„èŒƒ

11. **ISO/IEC 27001 - Information Security Management**
    - ğŸ“‹ **ISO**: [iso.org/standard/27001](https://www.iso.org/standard/27001.html)
    - ğŸ’¡ **å…³è”**: OPAå®ç°è®¿é—®æ§åˆ¶ç­–ç•¥
    - â­ **åº”ç”¨**: åˆè§„æ€§è‡ªåŠ¨åŒ–

12. **NIST Cybersecurity Framework**
    - ğŸ“‹ **NIST**: [nist.gov/cyberframework](https://www.nist.gov/cyberframework)
    - ğŸ’¡ **å…³è”**: ç­–ç•¥å³ä»£ç å®ç°NISTæ§åˆ¶

13. **PCI DSS Compliance**
    - ğŸ“‹ **æ ‡å‡†**: Payment Card Industry Data Security Standard
    - ğŸ’¡ **åº”ç”¨**: ä½¿ç”¨OPAå¼ºåˆ¶æ”¯ä»˜åˆè§„æ€§

### å¼€æºç”Ÿæ€ç³»ç»Ÿ

14. **Conftest - Policy Testing for Configuration**
    - ğŸ”— **GitHub**: [github.com/open-policy-agent/conftest](https://github.com/open-policy-agent/conftest)
    - â­ **Stars**: 2,800+
    - ğŸ’¡ **ç”¨é€”**: CI/CDä¸­çš„é…ç½®éªŒè¯

15. **Styra DAS - Declarative Authorization Service**
    - ğŸ¢ **å•†ä¸š**: Styra.com
    - ğŸ’¡ **å¢å¼º**: OPAçš„ä¼ä¸šçº§ç®¡ç†å¹³å°
    - â­ **ç‰¹æ€§**: å¯è§†åŒ–ç­–ç•¥ç¼–è¾‘ã€å®¡è®¡

### æƒå¨ä¹¦ç±ä¸æ•™ç¨‹

16. **Householder, J., & Tsankov, P. (2021)**. *Policy-Based Infrastructure Security*. O'Reilly (é¢„è®¡å‡ºç‰ˆ).
    - ğŸ“– **å‡ºç‰ˆç¤¾**: O'Reilly Media
    - ğŸ’¡ **å†…å®¹**: OPAå®æˆ˜æŒ‡å—

17. **CNCF OPA Best Practices Guide**
    - ğŸ“„ **æŒ‡å—**: CNCFå®˜æ–¹æœ€ä½³å®è·µ
    - ğŸ”— [github.com/cncf/tag-security](https://github.com/cncf/tag-security)
    - ğŸ’¡ **å†…å®¹**: å®‰å…¨ç­–ç•¥è®¾è®¡æ¨¡å¼

### ä¼šè®®æ¼”è®²ä¸æ•™ç¨‹

18. **KubeCon + CloudNativeCon OPA Sessions**
    - ğŸ“¹ **è§†é¢‘**: YouTube CNCFé¢‘é“
    - ğŸ’¡ **ä¸»é¢˜**:
      - "Policy as Code with OPA" (2019)
      - "Scaling OPA at Pinterest" (2020)
      - "OPA Gatekeeper v3" (2021)

19. **HashiConf OPA Integration**
    - ğŸ“¹ **æ¼”è®²**: HashiCorpå®˜æ–¹
    - ğŸ’¡ **å†…å®¹**: Terraform + OPAç­–ç•¥éªŒè¯

### æ¯”è¾ƒä¸æ›¿ä»£æ–¹æ¡ˆ

20. **AWS IAM vs OPA**
    - ğŸ“„ **å¯¹æ¯”**: äº‘åŸç”Ÿç­–ç•¥å¼•æ“å¯¹æ¯”
    - ğŸ’¡ **ä¼˜åŠ¿**: OPAçš„å¹³å°æ— å…³æ€§

21. **HashiCorp Sentinel vs OPA**
    - ğŸ“„ **åˆ†æ**: ä¸¤å¤§Policy-as-Codeæ–¹æ¡ˆ
    - ğŸ’¡ **å·®å¼‚**: Rego vs Sentinelè¯­è¨€

### åœ¨çº¿èµ„æº

22. **OPA Playground**
    - ğŸ”— **äº¤äº’**: [play.openpolicyagent.org](https://play.openpolicyagent.org/)
    - âœ… **éªŒè¯**: 2025-10-27
    - ğŸ’¡ **ç”¨é€”**: åœ¨çº¿æµ‹è¯•Regoç­–ç•¥

23. **Wikipedia - Policy-Based Management**
    - ğŸ”— [en.wikipedia.org/wiki/Policy-based_management](https://en.wikipedia.org/wiki/Policy-based_management)
    - âœ… **éªŒè¯**: 2025-10-27
    - ğŸ’¡ **ç†è®º**: ç­–ç•¥é©±åŠ¨ç®¡ç†ç†è®º

### å¼€æºè´¡çŒ®ç»Ÿè®¡

24. **OPA GitHub Repository**
    - ğŸ”— **GitHub**: [github.com/open-policy-agent/opa](https://github.com/open-policy-agent/opa)
    - â­ **Stars**: 9,000+ (2025)
    - ğŸ´ **Forks**: 1,200+
    - ğŸ‘¥ **Contributors**: 400+
    - ğŸ“¦ **ç‰ˆæœ¬**: v0.60+ (æŒç»­æ¼”è¿›)

### éªŒè¯ä¸é‡‡ç”¨ç»Ÿè®¡ï¼ˆæˆªè‡³2025-10-27ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ | å¤‡æ³¨ |
|-----|------|------|
| GitHub Stars | 9,000+ | æŒç»­å¢é•¿ |
| CNCFçŠ¶æ€ | Graduated | 2021å¹´ |
| ä¼ä¸šé‡‡ç”¨ | æ•°åƒå®¶ | å…¨çƒèŒƒå›´ |
| Regoç­–ç•¥æ•° | ç™¾ä¸‡çº§ | ç¤¾åŒºä¼°ç®— |
| Gatekeeper Stars | 3,500+ | K8sç­–ç•¥ |

**æ•°æ®æ¥æº**: GitHub, CNCF, ä¼ä¸šæ¡ˆä¾‹ç ”ç©¶ (2025-10-27)

---

## ç›¸å…³ä¸»é¢˜

- [4.1 è‡ªæ„ˆç³»ç»Ÿæ¶æ„](./04.1_Self_Healing_Architecture.md)
- [4.2 OTLP å¯è§‚æµ‹æ€§](./04.2_OTLP_Observability.md)
- [4.4 GitOps å£°æ˜å¼ä¿®å¤](./04.4_GitOps_Declarative_Remediation.md)

---

