# 9.1 å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **æœ€åæ›´æ–°**: 2025-10-27  
> **æ–‡æ¡£è§„æ¨¡**: 645è¡Œ | å¾®æœåŠ¡æ‹†åˆ†æ–¹æ³•è®º  
> **é˜…è¯»å»ºè®®**: æœ¬æ–‡ç³»ç»Ÿä»‹ç»å¾®æœåŠ¡æ‹†åˆ†çš„åŸåˆ™ã€ç­–ç•¥å’Œå®è·µ

---

## ç›®å½• | Table of Contents

- [9.1 å¾®æœåŠ¡åˆ†è§£ç­–ç•¥](#91-å¾®æœåŠ¡åˆ†è§£ç­–ç•¥)
  - [ç›®å½• | Table of Contents](#ç›®å½•--table-of-contents)
  - [ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ](#-æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ)
  - [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
  - [æ‹†åˆ†åŸåˆ™](#æ‹†åˆ†åŸåˆ™)
    - [1. æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†](#1-æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†)
    - [2. æŒ‰é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰](#2-æŒ‰é¢†åŸŸé©±åŠ¨è®¾è®¡ddd)
    - [3. æŒ‰å›¢é˜Ÿç»“æ„æ‹†åˆ†](#3-æŒ‰å›¢é˜Ÿç»“æ„æ‹†åˆ†)
  - [æ‹†åˆ†ç²’åº¦](#æ‹†åˆ†ç²’åº¦)
  - [æ‹†åˆ†å®æˆ˜ï¼šç”µå•†æ¡ˆä¾‹](#æ‹†åˆ†å®æˆ˜ç”µå•†æ¡ˆä¾‹)
  - [æ•°æ®ç®¡ç†](#æ•°æ®ç®¡ç†)
  - [æœåŠ¡é€šä¿¡](#æœåŠ¡é€šä¿¡)
  - [æ‹†åˆ†æ£€æŸ¥æ¸…å•](#æ‹†åˆ†æ£€æŸ¥æ¸…å•)
  - [å…³é”®æ´å¯Ÿ](#å…³é”®æ´å¯Ÿ)
  - [ç›¸å…³ä¸»é¢˜](#ç›¸å…³ä¸»é¢˜)

---

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>ğŸ§©ğŸ”¨ ç‚¹å‡»å±•å¼€ï¼šå¾®æœåŠ¡æ‹†åˆ†æ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: å¾®æœåŠ¡æ‹†åˆ†=DDDé¢†åŸŸé©±åŠ¨+åº·å¨å®šå¾‹+æŠ€æœ¯è¾¹ç•Œçš„ä¸‰ç»´å¹³è¡¡ã€‚æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•ä»å•ä½“æ‹†åˆ†ä¸ºå¾®æœåŠ¡ï¼Ÿè¾¹ç•Œåœ¨å“ªï¼Ÿç²’åº¦å¦‚ä½•ï¼Ÿæ‹†åˆ†åŸåˆ™ï¼šâ‘ æŒ‰ä¸šåŠ¡èƒ½åŠ›ï¼ˆBusiness Capabilityï¼‰ï¼šç”µå•†=ç”¨æˆ·+å•†å“+è®¢å•+æ”¯ä»˜+ç‰©æµâ‘¡æŒ‰é¢†åŸŸé©±åŠ¨DDDï¼šé™ç•Œä¸Šä¸‹æ–‡Bounded Contextã€èšåˆæ ¹Aggregateâ‘¢æŒ‰å›¢é˜Ÿç»„ç»‡ï¼ˆåº·å¨å®šå¾‹ï¼‰ï¼šç³»ç»Ÿç»“æ„=ç»„ç»‡æ²Ÿé€šç»“æ„â‘£æŒ‰æ•°æ®è¾¹ç•Œï¼šæ¯æœåŠ¡ç‹¬ç«‹æ•°æ®åº“â‘¤æŒ‰å˜æ›´é¢‘ç‡ï¼šé«˜é¢‘vsä½é¢‘åˆ†ç¦»ã€‚æ‹†åˆ†ç­–ç•¥ï¼šâ‘ é™Œç”Ÿäººæ¨¡å¼Stranglerï¼šé€æ­¥è¿ç§»ï¼ŒåŒè½¨è¿è¡Œâ‘¡åˆ†æ”¯æŠ½è±¡Branch by Abstractionï¼šé‡æ„ä¸ºæ¥å£â†’æ›¿æ¢å®ç°â‘¢äº‹ä»¶æº¯æºEvent Sourcingï¼šé€šè¿‡äº‹ä»¶è§£è€¦ã€‚ç²’åº¦æƒè¡¡ï¼šè¿‡ç»†â†’é€šä¿¡å¼€é”€ã€å¤æ‚åº¦â†‘ï¼›è¿‡ç²—â†’è€¦åˆåº¦é«˜ã€éš¾ä»¥ç‹¬ç«‹æ¼”è¿›ã€‚åæ¨¡å¼ï¼šâ‘ åˆ†å¸ƒå¼å•ä½“ï¼ˆå…±äº«æ•°æ®åº“ï¼‰â‘¡çº³ç±³æœåŠ¡ï¼ˆè¿‡åº¦æ‹†åˆ†ï¼‰â‘¢æ•°æ®è€¦åˆã€‚æœ€ä½³å®è·µï¼šæ¯æœåŠ¡5-10äººå›¢é˜Ÿã€ç‹¬ç«‹éƒ¨ç½²ã€æ˜ç¡®æ¥å£ã€‚å…³é”®ï¼šå¾®æœåŠ¡éç›®æ ‡ï¼Œè€Œæ˜¯è¾¾æˆç‹¬ç«‹æ¼”è¿›ã€å¿«é€Ÿäº¤ä»˜çš„æ‰‹æ®µã€‚

</details>

---

## æ ¸å¿ƒé—®é¢˜

> å¦‚ä½•å°†å•ä½“åº”ç”¨æ‹†åˆ†ä¸ºå¾®æœåŠ¡ï¼Ÿæ‹†åˆ†çš„è¾¹ç•Œåœ¨å“ªé‡Œï¼Ÿç²’åº¦å¦‚ä½•æŠŠæ¡ï¼Ÿ

## æ‹†åˆ†åŸåˆ™

### 1. æŒ‰ä¸šåŠ¡èƒ½åŠ›æ‹†åˆ†ï¼ˆBusiness Capabilityï¼‰

**å®šä¹‰**ï¼šæ ¹æ®ä¸šåŠ¡é¢†åŸŸçš„æ ¸å¿ƒèƒ½åŠ›åˆ’åˆ†æœåŠ¡è¾¹ç•Œ

**ç¤ºä¾‹ï¼šç”µå•†ç³»ç»Ÿ**

```
å•ä½“åº”ç”¨ï¼š
â””â”€â”€ E-commerce Monolith

å¾®æœåŠ¡æ‹†åˆ†ï¼ˆæŒ‰ä¸šåŠ¡èƒ½åŠ›ï¼‰ï¼š
â”œâ”€â”€ ç”¨æˆ·æœåŠ¡ï¼ˆUser Serviceï¼‰
â”‚   â”œâ”€â”€ ç”¨æˆ·æ³¨å†Œ
â”‚   â”œâ”€â”€ ç”¨æˆ·ç™»å½•
â”‚   â””â”€â”€ ç”¨æˆ·èµ„æ–™ç®¡ç†
â”œâ”€â”€ å•†å“æœåŠ¡ï¼ˆProduct Serviceï¼‰
â”‚   â”œâ”€â”€ å•†å“ç®¡ç†
â”‚   â”œâ”€â”€ åº“å­˜ç®¡ç†
â”‚   â””â”€â”€ ä»·æ ¼ç®¡ç†
â”œâ”€â”€ è®¢å•æœåŠ¡ï¼ˆOrder Serviceï¼‰
â”‚   â”œâ”€â”€ è®¢å•åˆ›å»º
â”‚   â”œâ”€â”€ è®¢å•æ”¯ä»˜
â”‚   â””â”€â”€ è®¢å•çŠ¶æ€ç®¡ç†
â”œâ”€â”€ æ”¯ä»˜æœåŠ¡ï¼ˆPayment Serviceï¼‰
â”‚   â”œâ”€â”€ æ”¯ä»˜å¤„ç†
â”‚   â”œâ”€â”€ é€€æ¬¾å¤„ç†
â”‚   â””â”€â”€ æ”¯ä»˜é€šçŸ¥
â””â”€â”€ ç‰©æµæœåŠ¡ï¼ˆLogistics Serviceï¼‰
    â”œâ”€â”€ ç‰©æµè·Ÿè¸ª
    â”œâ”€â”€ é…é€ç®¡ç†
    â””â”€â”€ ç­¾æ”¶ç¡®è®¤
```

**åˆ¤æ–­æ ‡å‡†**ï¼š
```
å¥½çš„æ‹†åˆ†ï¼š
âœ… æ¯ä¸ªæœåŠ¡å¯¹åº”ä¸€ä¸ªä¸šåŠ¡èƒ½åŠ›
âœ… æœåŠ¡å¯ç‹¬ç«‹æ¼”è¿›
âœ… å›¢é˜Ÿå¯ç‹¬ç«‹äº¤ä»˜

å·®çš„æ‹†åˆ†ï¼š
âŒ æœåŠ¡è¾¹ç•Œæ¨¡ç³Š
âŒ æœåŠ¡é—´é¢‘ç¹é€šä¿¡
âŒ ä¿®æ”¹éœ€è¦å¤šä¸ªæœåŠ¡é…åˆ
```

### 2. æŒ‰é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š

| æ¦‚å¿µ | å®šä¹‰ | ç¤ºä¾‹ |
|-----|------|------|
| **é¢†åŸŸï¼ˆDomainï¼‰** | ä¸šåŠ¡èŒƒå›´ | ç”µå•† |
| **å­åŸŸï¼ˆSubdomainï¼‰** | é¢†åŸŸç»†åˆ† | å•†å“ã€è®¢å•ã€æ”¯ä»˜ |
| **æœ‰ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰** | æœåŠ¡è¾¹ç•Œ | è®¢å•ä¸Šä¸‹æ–‡ |
| **èšåˆï¼ˆAggregateï¼‰** | ä¸€è‡´æ€§è¾¹ç•Œ | è®¢å•+è®¢å•é¡¹ |
| **å®ä½“ï¼ˆEntityï¼‰** | æœ‰å”¯ä¸€æ ‡è¯† | è®¢å•ï¼ˆOrder IDï¼‰ |
| **å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰** | æ— æ ‡è¯†ï¼Œä¸å¯å˜ | åœ°å€ï¼ˆAddressï¼‰ |

**DDDæ‹†åˆ†æµç¨‹**ï¼š

```
Step 1: è¯†åˆ«é¢†åŸŸ
ç”µå•†é¢†åŸŸ

Step 2: åˆ’åˆ†å­åŸŸ
â”œâ”€â”€ æ ¸å¿ƒåŸŸï¼ˆCore Domainï¼‰
â”‚   â””â”€â”€ è®¢å•å¤„ç†ï¼ˆä¸šåŠ¡æ ¸å¿ƒç«äº‰åŠ›ï¼‰
â”œâ”€â”€ æ”¯æ’‘åŸŸï¼ˆSupporting Domainï¼‰
â”‚   â”œâ”€â”€ ç”¨æˆ·ç®¡ç†
â”‚   â””â”€â”€ åº“å­˜ç®¡ç†
â””â”€â”€ é€šç”¨åŸŸï¼ˆGeneric Domainï¼‰
    â”œâ”€â”€ æ”¯ä»˜ï¼ˆå¯ç”¨ç¬¬ä¸‰æ–¹ï¼‰
    â””â”€â”€ ç‰©æµï¼ˆå¯ç”¨ç¬¬ä¸‰æ–¹ï¼‰

Step 3: å®šä¹‰æœ‰ç•Œä¸Šä¸‹æ–‡
è®¢å•ä¸Šä¸‹æ–‡ï¼ˆOrder Contextï¼‰:
- èšåˆï¼šOrder, OrderItem
- å®ä½“ï¼šOrder, Customer
- å€¼å¯¹è±¡ï¼šAddress, Money

å•†å“ä¸Šä¸‹æ–‡ï¼ˆProduct Contextï¼‰:
- èšåˆï¼šProduct, Inventory
- å®ä½“ï¼šProduct, Category
- å€¼å¯¹è±¡ï¼šPrice, SKU

Step 4: ç¡®å®šä¸Šä¸‹æ–‡æ˜ å°„
Order Context â†’ Product Context: è°ƒç”¨ GetProduct API
Order Context â†’ Payment Context: å‘å¸ƒ OrderCreated äº‹ä»¶
```

**ä¸Šä¸‹æ–‡æ˜ å°„æ¨¡å¼**ï¼š

```
1. å…±äº«å†…æ ¸ï¼ˆShared Kernelï¼‰
   ä¸¤ä¸ªä¸Šä¸‹æ–‡å…±äº«éƒ¨åˆ†æ¨¡å‹
   ä¾‹ï¼šOrder å’Œ Logistics å…±äº« Address

2. å®¢æˆ·-ä¾›åº”å•†ï¼ˆCustomer-Supplierï¼‰
   ä¸‹æ¸¸ä¾èµ–ä¸Šæ¸¸
   ä¾‹ï¼šOrder ä¾èµ– Product

3. é˜²è…å±‚ï¼ˆAnti-Corruption Layerï¼‰
   éš”ç¦»å¤–éƒ¨ç³»ç»Ÿ
   ä¾‹ï¼šå¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜ï¼Œç”¨ ACL è½¬æ¢æ•°æ®

4. å¼€æ”¾ä¸»æœºæœåŠ¡ï¼ˆOpen Host Serviceï¼‰
   æä¾›æ ‡å‡† API
   ä¾‹ï¼šProduct Service æä¾› RESTful API
```

### 3. æŒ‰å›¢é˜Ÿç»“æ„æ‹†åˆ†ï¼ˆConway's Lawï¼‰

**åº·å¨å®šå¾‹**ï¼š
> ç³»ç»Ÿæ¶æ„åæ˜ äº†ç»„ç»‡æ²Ÿé€šç»“æ„

**ç¤ºä¾‹**ï¼š

```
ç»„ç»‡ç»“æ„ â†’ ç³»ç»Ÿæ¶æ„

ç»„ç»‡ï¼š
â”œâ”€â”€ å‰ç«¯å›¢é˜Ÿï¼ˆ5äººï¼‰
â”œâ”€â”€ ç”¨æˆ·å›¢é˜Ÿï¼ˆ3äººï¼‰
â”œâ”€â”€ è®¢å•å›¢é˜Ÿï¼ˆ4äººï¼‰
â”œâ”€â”€ æ”¯ä»˜å›¢é˜Ÿï¼ˆ2äººï¼‰
â””â”€â”€ ç‰©æµå›¢é˜Ÿï¼ˆ3äººï¼‰

ç³»ç»Ÿæ¶æ„ï¼ˆè‡ªç„¶å¯¹åº”ï¼‰ï¼š
â”œâ”€â”€ Web/Mobile å‰ç«¯
â”œâ”€â”€ ç”¨æˆ·æœåŠ¡
â”œâ”€â”€ è®¢å•æœåŠ¡
â”œâ”€â”€ æ”¯ä»˜æœåŠ¡
â””â”€â”€ ç‰©æµæœåŠ¡

å¥½å¤„ï¼š
âœ… å›¢é˜Ÿè‡ªæ²»
âœ… æ²Ÿé€šé«˜æ•ˆ
âœ… è´£ä»»æ¸…æ™°
```

**é€†å‘åº·å¨ç­–ç•¥ï¼ˆReverse Conway Maneuverï¼‰**ï¼š
```
å¦‚æœæƒ³è¦æŸç§æ¶æ„ï¼š
å…ˆè°ƒæ•´ç»„ç»‡ç»“æ„

ä¾‹å¦‚ï¼šæƒ³è¦å¾®æœåŠ¡æ¶æ„
â†’ å…ˆç»„å»ºå°å‹ã€è·¨èŒèƒ½å›¢é˜Ÿ
â†’ æ¯ä¸ªå›¢é˜Ÿè´Ÿè´£ä¸€ä¸ªæœåŠ¡
```

---

## æ‹†åˆ†ç²’åº¦

### æœåŠ¡å¤§å°æŒ‡å—

| ç²’åº¦ | ä»£ç é‡ | å›¢é˜Ÿè§„æ¨¡ | é€‚ç”¨åœºæ™¯ | ä¼˜ç¼ºç‚¹ |
|-----|--------|---------|---------|--------|
| **ç»†ç²’åº¦** | < 1K LOC | 1-2äºº | é«˜å˜åŒ–é¢‘ç‡ | âœ…æ•æ· âŒå¤æ‚åº¦é«˜ |
| **ä¸­ç²’åº¦** | 1K-10K LOC | 2-5äºº | å¹³è¡¡åœºæ™¯ | âœ…é€‚ä¸­ âœ…æ¨è |
| **ç²—ç²’åº¦** | 10K-50K LOC | 5-10äºº | ç¨³å®šç³»ç»Ÿ | âœ…ç®€å• âŒè€¦åˆé£é™© |
| **è¿·ä½ å•ä½“** | > 50K LOC | 10+äºº | é¿å… | âŒåˆ†å¸ƒå¼å•ä½“ |

### æ‹†åˆ†ä¿¡å·

**ä½•æ—¶åº”è¯¥æ‹†åˆ†**ï¼š

```
ä¿¡å· 1: å›¢é˜Ÿå†²çª
- å¤šä¸ªå›¢é˜Ÿä¿®æ”¹åŒä¸€ä»£ç 
- ä»£ç åˆå¹¶å†²çªé¢‘ç¹
â†’ æŒ‰å›¢é˜Ÿè¾¹ç•Œæ‹†åˆ†

ä¿¡å· 2: éƒ¨ç½²ç“¶é¢ˆ
- å°æ”¹åŠ¨éœ€è¦å…¨é‡éƒ¨ç½²
- éƒ¨ç½²æ—¶é—´ > 1å°æ—¶
â†’ æ‹†åˆ†é«˜å˜åŒ–æ¨¡å—

ä¿¡å· 3: æ‰©å±•ç“¶é¢ˆ
- éƒ¨åˆ†åŠŸèƒ½éœ€è¦æ‰©å±•ï¼Œä½†æ•´ä½“æ€§èƒ½è¶³å¤Ÿ
- èµ„æºæµªè´¹
â†’ æ‹†åˆ†é«˜è´Ÿè½½æ¨¡å—

ä¿¡å· 4: æŠ€æœ¯æ ˆé™åˆ¶
- éƒ¨åˆ†åŠŸèƒ½é€‚åˆä¸åŒæŠ€æœ¯
- ä¾‹ï¼šAIæ¨èç”¨Pythonï¼Œæ ¸å¿ƒä¸šåŠ¡ç”¨Java
â†’ æ‹†åˆ†æŠ€æœ¯è¾¹ç•Œ
```

**ä½•æ—¶ä¸åº”è¯¥æ‹†åˆ†**ï¼š

```
ä¿¡å· 1: è¿‡æ—©ä¼˜åŒ–
- ä¸šåŠ¡æœªç¨³å®š
- ç”¨æˆ·é‡ < 1000
â†’ ä¿æŒå•ä½“ï¼Œå¿«é€Ÿè¿­ä»£

ä¿¡å· 2: å›¢é˜Ÿè§„æ¨¡å°
- å›¢é˜Ÿ < 5äºº
- æ— DevOpsèƒ½åŠ›
â†’ å•ä½“è¶³å¤Ÿ

ä¿¡å· 3: å¼ºä¸€è‡´æ€§éœ€æ±‚
- é‡‘èäº¤æ˜“
- åº“å­˜æ‰£å‡
â†’ å•ä½“æˆ–è°¨æ…æ‹†åˆ†
```

---

## æ‹†åˆ†å®æˆ˜ï¼šç”µå•†æ¡ˆä¾‹

### åŸå§‹å•ä½“æ¶æ„

```java
// Monolith E-commerce Application

@RestController
public class OrderController {
    @Autowired
    private UserService userService;
    @Autowired
    private ProductService productService;
    @Autowired
    private PaymentService paymentService;
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private LogisticsService logisticsService;
    
    @PostMapping("/orders")
    @Transactional
    public Order createOrder(OrderRequest request) {
        // 1. éªŒè¯ç”¨æˆ·
        User user = userService.getUser(request.getUserId());
        if (user == null) throw new UserNotFoundException();
        
        // 2. éªŒè¯å•†å“å’Œåº“å­˜
        for (OrderItem item : request.getItems()) {
            Product product = productService.getProduct(item.getProductId());
            if (product == null) throw new ProductNotFoundException();
            
            if (!inventoryService.checkStock(item.getProductId(), item.getQuantity())) {
                throw new InsufficientStockException();
            }
        }
        
        // 3. åˆ›å»ºè®¢å•
        Order order = new Order();
        order.setUserId(request.getUserId());
        order.setItems(request.getItems());
        order.setTotalAmount(calculateTotal(request.getItems()));
        orderRepository.save(order);
        
        // 4. æ‰£å‡åº“å­˜
        for (OrderItem item : request.getItems()) {
            inventoryService.deductStock(item.getProductId(), item.getQuantity());
        }
        
        // 5. è°ƒç”¨æ”¯ä»˜
        Payment payment = paymentService.createPayment(order.getId(), order.getTotalAmount());
        
        // 6. åˆ›å»ºç‰©æµå•
        logisticsService.createShipment(order.getId(), user.getAddress());
        
        return order;
    }
}
```

**é—®é¢˜**ï¼š
- âŒ æ‰€æœ‰é€»è¾‘åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼ˆé•¿äº‹åŠ¡ï¼‰
- âŒ æœåŠ¡é—´ç´§è€¦åˆ
- âŒ æ— æ³•ç‹¬ç«‹æ‰©å±•
- âŒ æ•…éšœä¼ æ’­ï¼ˆæ”¯ä»˜æ…¢â†’æ•´ä¸ªè®¢å•æ…¢ï¼‰

### æ‹†åˆ†åçš„å¾®æœåŠ¡æ¶æ„

#### æœåŠ¡åˆ’åˆ†

```
å¾®æœåŠ¡æ¶æ„ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Gateway    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“         â†“        â†“        â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚User    â”‚ â”‚Orderâ”‚ â”‚Productâ”‚Paymentâ”‚ â”‚Logisticsâ”‚
â”‚Service â”‚ â”‚Svc  â”‚ â”‚Serviceâ”‚Serviceâ”‚ â”‚Service  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚        â”‚        â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Event Bus     â”‚
              â”‚  (Kafka)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Order Serviceï¼ˆè®¢å•æœåŠ¡ï¼‰

```java
@RestController
public class OrderController {
    @Autowired
    private OrderService orderService;
    
    @PostMapping("/orders")
    public CompletableFuture<OrderResponse> createOrder(OrderRequest request) {
        return orderService.createOrderAsync(request);
    }
}

@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    @Autowired
    private EventPublisher eventPublisher;
    @Autowired
    private ProductServiceClient productClient;
    
    public CompletableFuture<OrderResponse> createOrderAsync(OrderRequest request) {
        // 1. éªŒè¯å•†å“ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰
        CompletableFuture<List<Product>> productsFuture = 
            productClient.getProducts(request.getItemIds());
        
        return productsFuture.thenCompose(products -> {
            // 2. åˆ›å»ºè®¢å•ï¼ˆä»…æœ¬åœ°æ•°æ®ï¼‰
            Order order = new Order();
            order.setUserId(request.getUserId());
            order.setItems(request.getItems());
            order.setStatus(OrderStatus.PENDING);
            order.setTotalAmount(calculateTotal(products, request.getItems()));
            
            Order savedOrder = orderRepository.save(order);
            
            // 3. å‘å¸ƒäº‹ä»¶ï¼ˆå¼‚æ­¥é€šçŸ¥å…¶ä»–æœåŠ¡ï¼‰
            eventPublisher.publish(new OrderCreatedEvent(
                savedOrder.getId(),
                savedOrder.getUserId(),
                savedOrder.getItems(),
                savedOrder.getTotalAmount()
            ));
            
            return CompletableFuture.completedFuture(
                new OrderResponse(savedOrder.getId(), "PENDING")
            );
        });
    }
}
```

#### Inventory Serviceï¼ˆåº“å­˜æœåŠ¡ï¼‰

```java
@Service
public class InventoryEventHandler {
    @Autowired
    private InventoryService inventoryService;
    @Autowired
    private EventPublisher eventPublisher;
    
    @KafkaListener(topics = "order-created")
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            // 1. æ£€æŸ¥åº“å­˜
            boolean sufficient = inventoryService.checkStock(event.getItems());
            
            if (sufficient) {
                // 2. æ‰£å‡åº“å­˜
                inventoryService.deductStock(event.getItems());
                
                // 3. å‘å¸ƒæˆåŠŸäº‹ä»¶
                eventPublisher.publish(new InventoryReservedEvent(
                    event.getOrderId(),
                    event.getItems()
                ));
            } else {
                // 4. å‘å¸ƒå¤±è´¥äº‹ä»¶
                eventPublisher.publish(new InventoryInsufficientEvent(
                    event.getOrderId(),
                    "Insufficient stock"
                ));
            }
        } catch (Exception e) {
            // 5. å‘å¸ƒå¤±è´¥äº‹ä»¶
            eventPublisher.publish(new InventoryReservationFailedEvent(
                event.getOrderId(),
                e.getMessage()
            ));
        }
    }
}
```

#### SAGAç¼–æ’ï¼ˆåˆ†å¸ƒå¼äº‹åŠ¡ï¼‰

```java
@Service
public class OrderSagaOrchestrator {
    @Autowired
    private EventPublisher eventPublisher;
    @Autowired
    private OrderRepository orderRepository;
    
    // ç›‘å¬åº“å­˜é¢„ç•™æˆåŠŸ
    @KafkaListener(topics = "inventory-reserved")
    public void handleInventoryReserved(InventoryReservedEvent event) {
        // è§¦å‘æ”¯ä»˜
        eventPublisher.publish(new PaymentRequestedEvent(
            event.getOrderId(),
            getOrderAmount(event.getOrderId())
        ));
    }
    
    // ç›‘å¬æ”¯ä»˜æˆåŠŸ
    @KafkaListener(topics = "payment-completed")
    public void handlePaymentCompleted(PaymentCompletedEvent event) {
        // æ›´æ–°è®¢å•çŠ¶æ€
        Order order = orderRepository.findById(event.getOrderId());
        order.setStatus(OrderStatus.PAID);
        orderRepository.save(order);
        
        // è§¦å‘ç‰©æµ
        eventPublisher.publish(new ShipmentRequestedEvent(
            event.getOrderId(),
            order.getUserId()
        ));
    }
    
    // ç›‘å¬åº“å­˜ä¸è¶³ï¼ˆè¡¥å¿ï¼‰
    @KafkaListener(topics = "inventory-insufficient")
    public void handleInventoryInsufficient(InventoryInsufficientEvent event) {
        // å–æ¶ˆè®¢å•
        Order order = orderRepository.findById(event.getOrderId());
        order.setStatus(OrderStatus.CANCELLED);
        order.setCancelReason("åº“å­˜ä¸è¶³");
        orderRepository.save(order);
        
        // é€šçŸ¥ç”¨æˆ·
        eventPublisher.publish(new OrderCancelledEvent(
            event.getOrderId(),
            "åº“å­˜ä¸è¶³"
        ));
    }
    
    // ç›‘å¬æ”¯ä»˜å¤±è´¥ï¼ˆè¡¥å¿ï¼‰
    @KafkaListener(topics = "payment-failed")
    public void handlePaymentFailed(PaymentFailedEvent event) {
        // 1. å–æ¶ˆè®¢å•
        Order order = orderRepository.findById(event.getOrderId());
        order.setStatus(OrderStatus.CANCELLED);
        order.setCancelReason("æ”¯ä»˜å¤±è´¥");
        orderRepository.save(order);
        
        // 2. å›æ»šåº“å­˜
        eventPublisher.publish(new InventoryReleaseRequestedEvent(
            event.getOrderId(),
            order.getItems()
        ));
    }
}
```

---

## æ•°æ®ç®¡ç†

### Database per Service

**åŸåˆ™**ï¼šæ¯ä¸ªæœåŠ¡æœ‰è‡ªå·±çš„æ•°æ®åº“

```
User Service â†’ users_db (PostgreSQL)
Order Service â†’ orders_db (PostgreSQL)
Product Service â†’ products_db (PostgreSQL)
Inventory Service â†’ inventory_db (Redis)
```

**æ•°æ®åŒæ­¥ç­–ç•¥**ï¼š

```
ç­–ç•¥ 1: APIè°ƒç”¨ï¼ˆåŒæ­¥ï¼‰
Order Service è°ƒç”¨ Product Service API è·å–å•†å“ä¿¡æ¯

ç­–ç•¥ 2: äº‹ä»¶é©±åŠ¨ï¼ˆå¼‚æ­¥ï¼‰
Product Service å‘å¸ƒ ProductUpdated äº‹ä»¶
Order Service ç›‘å¬äº‹ä»¶ï¼Œæ›´æ–°æœ¬åœ°ç¼“å­˜

ç­–ç•¥ 3: æ•°æ®å¤åˆ¶ï¼ˆå†—ä½™ï¼‰
Order Service ä¿å­˜å•†å“å¿«ç…§ï¼ˆè®¢å•æ—¶çš„å•†å“ä¿¡æ¯ï¼‰
é¿å…å•†å“å˜æ›´å½±å“å†å²è®¢å•
```

### æ•°æ®ä¸€è‡´æ€§

**æœ€ç»ˆä¸€è‡´æ€§ç¤ºä¾‹**ï¼š

```
æ—¶é—´çº¿ï¼šè®¢å•åˆ›å»ºæµç¨‹

T0: User ç‚¹å‡»"è´­ä¹°"
T1: Order Service åˆ›å»ºè®¢å•ï¼ˆçŠ¶æ€ï¼šPENDINGï¼‰
T2: å‘å¸ƒ OrderCreated äº‹ä»¶
T3: Inventory Service æ‰£å‡åº“å­˜
T4: å‘å¸ƒ InventoryReserved äº‹ä»¶
T5: Payment Service å¤„ç†æ”¯ä»˜
T6: å‘å¸ƒ PaymentCompleted äº‹ä»¶
T7: Order Service æ›´æ–°çŠ¶æ€ï¼ˆçŠ¶æ€ï¼šPAIDï¼‰

ä¸€è‡´æ€§çª—å£ï¼šT0-T7ï¼ˆçº¦ 2-5ç§’ï¼‰
- T0-T7: è®¢å•çŠ¶æ€ä¸ä¸€è‡´ï¼ˆPENDING â†’ PAIDï¼‰
- T7å: è¾¾åˆ°ä¸€è‡´æ€§
```

---

## æœåŠ¡é€šä¿¡

### åŒæ­¥ vs å¼‚æ­¥

| ç»´åº¦ | åŒæ­¥ï¼ˆREST/gRPCï¼‰ | å¼‚æ­¥ï¼ˆMessage Queueï¼‰ |
|-----|------------------|---------------------|
| **å“åº”æ—¶é—´** | å¿«ï¼ˆæ¯«ç§’çº§ï¼‰ | æ…¢ï¼ˆç§’çº§ï¼‰ |
| **è€¦åˆåº¦** | é«˜ï¼ˆä¾èµ–å¯ç”¨æ€§ï¼‰ | ä½ï¼ˆè§£è€¦ï¼‰ |
| **ä¸€è‡´æ€§** | å¼ºä¸€è‡´ | æœ€ç»ˆä¸€è‡´ |
| **å¤æ‚åº¦** | ä½ | é«˜ |
| **é€‚ç”¨åœºæ™¯** | æŸ¥è¯¢ã€å®æ—¶è¦æ±‚ | äº‹ä»¶é€šçŸ¥ã€å¼‚æ­¥å¤„ç† |

**é€‰æ‹©æŒ‡å—**ï¼š

```
ä½¿ç”¨åŒæ­¥ï¼ˆRESTï¼‰ï¼š
âœ… è¯»æ“ä½œï¼ˆæŸ¥è¯¢å•†å“è¯¦æƒ…ï¼‰
âœ… å¹‚ç­‰æ“ä½œï¼ˆè·å–è®¢å•çŠ¶æ€ï¼‰
âœ… ä½å»¶è¿Ÿè¦æ±‚ï¼ˆ< 100msï¼‰

ä½¿ç”¨å¼‚æ­¥ï¼ˆMQï¼‰ï¼š
âœ… å†™æ“ä½œï¼ˆåˆ›å»ºè®¢å•ï¼‰
âœ… éå¹‚ç­‰æ“ä½œï¼ˆæ‰£æ¬¾ï¼‰
âœ… è§£è€¦è¦æ±‚ï¼ˆè®¢å•â†’ç‰©æµï¼‰
```

---

## æ‹†åˆ†æ£€æŸ¥æ¸…å•

### æ‹†åˆ†å‰

```
[ ] ä¸šåŠ¡è¾¹ç•Œæ˜¯å¦æ¸…æ™°ï¼Ÿ
[ ] å›¢é˜Ÿæ˜¯å¦å‡†å¤‡å¥½ï¼Ÿï¼ˆDevOpsèƒ½åŠ›ï¼‰
[ ] æ˜¯å¦æœ‰ç›‘æ§ä½“ç³»ï¼Ÿ
[ ] æ˜¯å¦æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Ÿ
[ ] æ˜¯å¦æœ‰CI/CDï¼Ÿ
```

### æ‹†åˆ†ä¸­

```
[ ] æ˜¯å¦å®šä¹‰äº†APIå¥‘çº¦ï¼Ÿ
[ ] æ˜¯å¦å®ç°äº†æœåŠ¡å‘ç°ï¼Ÿ
[ ] æ˜¯å¦å®ç°äº†é…ç½®ç®¡ç†ï¼Ÿ
[ ] æ˜¯å¦å®ç°äº†åˆ†å¸ƒå¼è¿½è¸ªï¼Ÿ
[ ] æ˜¯å¦å®ç°äº†ç†”æ–­é™çº§ï¼Ÿ
```

### æ‹†åˆ†å

```
[ ] æœåŠ¡æ˜¯å¦å¯ç‹¬ç«‹éƒ¨ç½²ï¼Ÿ
[ ] æœåŠ¡æ˜¯å¦å¯ç‹¬ç«‹æ‰©å±•ï¼Ÿ
[ ] æœåŠ¡æ•…éšœæ˜¯å¦éš”ç¦»ï¼Ÿ
[ ] æ•°æ®æ˜¯å¦ä¸€è‡´ï¼Ÿ
[ ] æ€§èƒ½æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Ÿ
```

---

## å…³é”®æ´å¯Ÿ

### æ´å¯Ÿ 1ï¼šæ‹†åˆ†æ˜¯æ¼”è¿›ï¼Œä¸æ˜¯é©å‘½

```
âŒ é”™è¯¯ï¼šä¸€æ¬¡æ€§é‡å†™ä¸ºå¾®æœåŠ¡
âœ… æ­£ç¡®ï¼šæ¸è¿›å¼æ‹†åˆ†

æ­¥éª¤ï¼š
1. è¯†åˆ«æ˜“æ‹†åˆ†æ¨¡å—ï¼ˆè¾¹ç¼˜æœåŠ¡ï¼‰
2. å…ˆæ‹†åˆ† 1-2 ä¸ªæœåŠ¡
3. éªŒè¯ã€å­¦ä¹ ã€ä¼˜åŒ–
4. é€æ­¥æ‹†åˆ†æ ¸å¿ƒæœåŠ¡
```

### æ´å¯Ÿ 2ï¼šæ‹†åˆ†æ˜¯æ‰‹æ®µï¼Œä¸æ˜¯ç›®çš„

```
ç›®çš„ï¼šè§£å†³é—®é¢˜
- å›¢é˜Ÿæ‰©å±•
- æŠ€æœ¯å‡çº§
- æ€§èƒ½ç“¶é¢ˆ

æ‰‹æ®µï¼šå¾®æœåŠ¡
ä½†å¾®æœåŠ¡å¸¦æ¥å¤æ‚åº¦

æƒè¡¡ï¼š
æˆæœ¬ï¼ˆå¤æ‚åº¦ï¼‰< æ”¶ç›Šï¼ˆè§£å†³é—®é¢˜ï¼‰
```

### æ´å¯Ÿ 3ï¼šæ‹†åˆ†åè¦"å®ˆ"

```
æ‹†åˆ†åçš„æŒ‘æˆ˜ï¼š
- é˜²æ­¢æœåŠ¡å†æ¬¡è€¦åˆ
- é˜²æ­¢è¿‡åº¦æ‹†åˆ†
- æŒç»­ä¼˜åŒ–è¾¹ç•Œ

éœ€è¦ï¼š
- æ¶æ„å®ˆæŠ¤ï¼ˆCode Reviewï¼‰
- å®šæœŸé‡æ„
- å›¢é˜ŸåŸ¹è®­
```

---

## ç›¸å…³ä¸»é¢˜


---


