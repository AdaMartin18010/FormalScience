# 9.3 æ–­è·¯å™¨ä¸å¼¹æ€§è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **æœ€åæ›´æ–°**: 2025-10-27  
> **æ–‡æ¡£è§„æ¨¡**: 750è¡Œ | å¼¹æ€§è®¾è®¡æ¨¡å¼è¯¦è§£  
> **é˜…è¯»å»ºè®®**: æœ¬æ–‡æ·±å…¥è§£ææ–­è·¯å™¨æ¨¡å¼åŠå…¶åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„åº”ç”¨

---

## ç›®å½• | Table of Contents

- [9.3 æ–­è·¯å™¨ä¸å¼¹æ€§æ¨¡å¼](#93-æ–­è·¯å™¨ä¸å¼¹æ€§æ¨¡å¼)
  - [ç›®å½• | Table of Contents](#ç›®å½•--table-of-contents)
  - [ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ](#-æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ)
  - [æ ¸å¿ƒé—®é¢˜](#æ ¸å¿ƒé—®é¢˜)
  - [æ–­è·¯å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰](#æ–­è·¯å™¨æ¨¡å¼circuit-breaker)
  - [å®ç°æ–¹æ¡ˆ](#å®ç°æ–¹æ¡ˆ)
  - [é™çº§ç­–ç•¥](#é™çº§ç­–ç•¥)
  - [èˆ±å£éš”ç¦»æ¨¡å¼ï¼ˆBulkheadï¼‰](#èˆ±å£éš”ç¦»æ¨¡å¼bulkhead)
  - [é™æµæ¨¡å¼ï¼ˆRate Limitingï¼‰](#é™æµæ¨¡å¼rate-limiting)
  - [å…³é”®æ´å¯Ÿ](#å…³é”®æ´å¯Ÿ)
  - [ç›¸å…³ä¸»é¢˜](#ç›¸å…³ä¸»é¢˜)

---

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>âš¡ğŸ”Œ ç‚¹å‡»å±•å¼€ï¼šæ–­è·¯å™¨ä¸å¼¹æ€§è®¾è®¡æ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: æ–­è·¯å™¨=åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¿é™©ä¸ï¼Œå¿«é€Ÿå¤±è´¥ä¼˜é›…é™çº§ã€‚æ ¸å¿ƒé—®é¢˜ï¼šä¸‹æ¸¸æœåŠ¡æ•…éšœâ†’å¦‚ä½•é˜²æ­¢çº§è”å¤±è´¥ï¼Ÿç”µè·¯ç±»æ¯”ï¼šç”µæµè¿‡å¤§â†’ä¿é™©ä¸ç†”æ–­â†’ä¿æŠ¤æ•´ä¸ªç”µè·¯ã€‚æ–­è·¯å™¨ä¸‰çŠ¶æ€ï¼šâ‘ Closedå…³é—­ï¼šæ­£å¸¸è¯·æ±‚é€šè¿‡â‘¡Openæ‰“å¼€ï¼šå¤±è´¥ç‡è¶…é˜ˆå€¼ï¼Œç›´æ¥æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥â‘¢Half-OpenåŠå¼€ï¼šå°è¯•éƒ¨åˆ†è¯·æ±‚ï¼ŒéªŒè¯æ¢å¤ã€‚çŠ¶æ€è½¬æ¢ï¼šClosedâ†’(å¤±è´¥ç‡>é˜ˆå€¼)â†’Openâ†’(è¶…æ—¶å)â†’Half-Openâ†’(æˆåŠŸç‡>é˜ˆå€¼)â†’Closedã€‚é…ç½®å‚æ•°ï¼šâ‘ å¤±è´¥ç‡é˜ˆå€¼ï¼ˆå¦‚50%ï¼‰â‘¡è¶…æ—¶æ—¶é—´ï¼ˆå¦‚30sï¼‰â‘¢åŠå¼€å°è¯•æ¬¡æ•°ï¼ˆå¦‚10æ¬¡ï¼‰â‘£æ»‘åŠ¨çª—å£ï¼ˆå¦‚æœ€è¿‘100æ¬¡ï¼‰ã€‚å®ç°å·¥å…·ï¼šâ‘ Hystrixï¼ˆNetflixå·²åœæ›´ï¼‰â‘¡Resilience4jï¼ˆæ¨èï¼‰â‘¢Sentinelï¼ˆé˜¿é‡Œï¼‰â‘£Istio/Envoyï¼ˆService Meshï¼‰ã€‚é…å¥—æ¨¡å¼ï¼šâ‘ è¶…æ—¶Timeoutâ‘¡é‡è¯•Retryï¼ˆæŒ‡æ•°é€€é¿ï¼‰â‘¢é™æµRate Limitingâ‘£èˆ±å£éš”ç¦»Bulkheadâ‘¤é™çº§Fallbackã€‚å…³é”®ï¼šå¼¹æ€§è®¾è®¡=å‡è®¾å¤±è´¥æ˜¯å¸¸æ€ï¼Œè®¾è®¡å®¹é”™è€Œéå®Œç¾ã€‚

</details>

---

## æ ¸å¿ƒé—®é¢˜

> å½“ä¸‹æ¸¸æœåŠ¡æ•…éšœæ—¶ï¼Œå¦‚ä½•é˜²æ­¢çº§è”å¤±è´¥ï¼Ÿå¦‚ä½•å¿«é€Ÿå¤±è´¥å¹¶ä¼˜é›…é™çº§ï¼Ÿ

## æ–­è·¯å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰

### æ ¸å¿ƒæ¦‚å¿µ

**ç”µè·¯ç±»æ¯”**ï¼š
```
ç”µè·¯ä¸­çš„ä¿é™©ä¸ï¼š
- ç”µæµè¿‡å¤§ â†’ ä¿é™©ä¸ç†”æ–­
- ä¿æŠ¤æ•´ä¸ªç”µè·¯ä¸è¢«çƒ§æ¯

è½¯ä»¶ä¸­çš„æ–­è·¯å™¨ï¼š
- è¯·æ±‚å¤±è´¥ç‡è¿‡é«˜ â†’ æ–­è·¯å™¨æ‰“å¼€
- ä¿æŠ¤ç³»ç»Ÿä¸è¢«æ‹–å®
```

### ä¸‰ç§çŠ¶æ€

```
                 å¤±è´¥ç‡ < é˜ˆå€¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚
          â†“                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Closed  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚   Open   â”‚
    â”‚  (æ­£å¸¸)  â”‚å¤±è´¥ç‡>é˜ˆå€¼â”‚  (æ–­å¼€)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘                     â”‚
          â”‚                     â”‚ è¶…æ—¶å
          â”‚                     â†“
          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ Half-Open    â”‚
           æµ‹è¯•è¯·æ±‚æˆåŠŸ   â”‚  (åŠå¼€)      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ€è¯´æ˜**ï¼š

| çŠ¶æ€ | è¡Œä¸º | è½¬æ¢æ¡ä»¶ |
|-----|------|---------|
| **Closed**ï¼ˆé—­åˆï¼‰ | æ­£å¸¸è¯·æ±‚é€šè¿‡ | å¤±è´¥ç‡ > é˜ˆå€¼ â†’ Open |
| **Open**ï¼ˆæ‰“å¼€ï¼‰ | ç›´æ¥è¿”å›é”™è¯¯ï¼Œä¸è°ƒç”¨ä¸‹æ¸¸ | è¶…æ—¶å â†’ Half-Open |
| **Half-Open**ï¼ˆåŠå¼€ï¼‰ | å…è®¸å°‘é‡æµ‹è¯•è¯·æ±‚ | æˆåŠŸ â†’ Closedï¼›å¤±è´¥ â†’ Open |

---

## å®ç°æ–¹æ¡ˆ

### åŸºç¡€å®ç°ï¼ˆJavaï¼‰

```java
public class CircuitBreaker {
    private enum State {
        CLOSED, OPEN, HALF_OPEN
    }
    
    private State state = State.CLOSED;
    private int failureCount = 0;
    private int successCount = 0;
    private long openTimestamp = 0;
    
    // é…ç½®å‚æ•°
    private final int failureThreshold = 5;      // å¤±è´¥é˜ˆå€¼
    private final int successThreshold = 2;      // æˆåŠŸé˜ˆå€¼ï¼ˆåŠå¼€â†’é—­åˆï¼‰
    private final long timeout = 60000;          // è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    
    public <T> T call(Supplier<T> supplier) throws Exception {
        if (state == State.OPEN) {
            // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
            if (System.currentTimeMillis() - openTimestamp > timeout) {
                state = State.HALF_OPEN;
                successCount = 0;
            } else {
                throw new CircuitBreakerOpenException("Circuit breaker is OPEN");
            }
        }
        
        try {
            T result = supplier.get();
            onSuccess();
            return result;
        } catch (Exception e) {
            onFailure();
            throw e;
        }
    }
    
    private void onSuccess() {
        failureCount = 0;
        
        if (state == State.HALF_OPEN) {
            successCount++;
            if (successCount >= successThreshold) {
                state = State.CLOSED;
            }
        }
    }
    
    private void onFailure() {
        failureCount++;
        successCount = 0;
        
        if (failureCount >= failureThreshold) {
            state = State.OPEN;
            openTimestamp = System.currentTimeMillis();
        }
    }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```java
CircuitBreaker breaker = new CircuitBreaker();

try {
    User user = breaker.call(() -> {
        return userService.getUser(userId);  // å¯èƒ½å¤±è´¥çš„è°ƒç”¨
    });
} catch (CircuitBreakerOpenException e) {
    // æ–­è·¯å™¨æ‰“å¼€ï¼Œè¿”å›é™çº§æ•°æ®
    return getCachedUser(userId);
} catch (Exception e) {
    // å…¶ä»–å¼‚å¸¸å¤„ç†
    log.error("Failed to get user", e);
    return getDefaultUser();
}
```

### Resilience4j å®ç°ï¼ˆæ¨èï¼‰

**Maven ä¾èµ–**ï¼š
```xml
<dependency>
    <groupId>io.github.resilience4j</groupId>
    <artifactId>resilience4j-spring-boot2</artifactId>
    <version>2.1.0</version>
</dependency>
```

**é…ç½®**ï¼š
```yaml
resilience4j:
  circuitbreaker:
    instances:
      userService:
        registerHealthIndicator: true
        slidingWindowSize: 10                    # æ»‘åŠ¨çª—å£å¤§å°
        minimumNumberOfCalls: 5                  # æœ€å°è°ƒç”¨æ¬¡æ•°
        permittedNumberOfCallsInHalfOpenState: 3 # åŠå¼€çŠ¶æ€æµ‹è¯•æ¬¡æ•°
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 60s             # æ‰“å¼€çŠ¶æ€æŒç»­æ—¶é—´
        failureRateThreshold: 50                 # å¤±è´¥ç‡é˜ˆå€¼ï¼ˆ%ï¼‰
        eventConsumerBufferSize: 10
        recordExceptions:                        # è®°å½•ä¸ºå¤±è´¥çš„å¼‚å¸¸
          - java.io.IOException
          - java.util.concurrent.TimeoutException
        ignoreExceptions:                        # å¿½ç•¥çš„å¼‚å¸¸
          - com.myapp.BusinessException
```

**ä»£ç ä½¿ç”¨**ï¼š
```java
@Service
public class UserService {
    @Autowired
    private RestTemplate restTemplate;
    
    @CircuitBreaker(name = "userService", fallbackMethod = "getUserFallback")
    public User getUser(Long userId) {
        return restTemplate.getForObject(
            "http://user-service/users/" + userId,
            User.class
        );
    }
    
    // é™çº§æ–¹æ³•
    private User getUserFallback(Long userId, Exception e) {
        log.warn("User service is down, returning cached data", e);
        return cache.get("user_" + userId);
    }
}
```

---

## é™çº§ç­–ç•¥

### 1. è¿”å›ç¼“å­˜æ•°æ®

```java
@Service
public class ProductService {
    @Autowired
    private RedisTemplate<String, Product> redis;
    
    @CircuitBreaker(name = "productService", fallbackMethod = "getProductFromCache")
    public Product getProduct(Long productId) {
        return restTemplate.getForObject(
            "http://product-service/products/" + productId,
            Product.class
        );
    }
    
    private Product getProductFromCache(Long productId, Exception e) {
        Product cached = redis.opsForValue().get("product_" + productId);
        
        if (cached != null) {
            cached.setFromCache(true);  // æ ‡è®°æ•°æ®æ¥æº
            return cached;
        }
        
        // ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼Œè¿”å›é»˜è®¤æ•°æ®
        return Product.builder()
            .id(productId)
            .name("å•†å“æš‚æ—¶ä¸å¯ç”¨")
            .available(false)
            .build();
    }
}
```

### 2. è¿”å›é»˜è®¤å€¼

```java
@Service
public class RecommendationService {
    @CircuitBreaker(name = "recommendationService", 
                   fallbackMethod = "getDefaultRecommendations")
    public List<Product> getRecommendations(Long userId) {
        return restTemplate.getForObject(
            "http://recommendation-service/recommendations/" + userId,
            List.class
        );
    }
    
    private List<Product> getDefaultRecommendations(Long userId, Exception e) {
        // è¿”å›çƒ­é—¨å•†å“ä½œä¸ºé»˜è®¤æ¨è
        return productService.getHotProducts(10);
    }
}
```

### 3. è¿”å›ç©ºç»“æœï¼ˆéæ ¸å¿ƒåŠŸèƒ½ï¼‰

```java
@Service
public class CommentService {
    @CircuitBreaker(name = "commentService", fallbackMethod = "getEmptyComments")
    public List<Comment> getComments(Long productId) {
        return restTemplate.getForObject(
            "http://comment-service/comments/" + productId,
            List.class
        );
    }
    
    private List<Comment> getEmptyComments(Long productId, Exception e) {
        // è¯„è®ºæ˜¯éæ ¸å¿ƒåŠŸèƒ½ï¼Œè¿”å›ç©ºåˆ—è¡¨
        log.warn("Comment service is down, returning empty list");
        return Collections.emptyList();
    }
}
```

### 4. å¿«é€Ÿå¤±è´¥ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

```java
@Service
public class PaymentService {
    @CircuitBreaker(name = "paymentService", fallbackMethod = "paymentFallback")
    public PaymentResult processPayment(PaymentRequest request) {
        return restTemplate.postForObject(
            "http://payment-service/payments",
            request,
            PaymentResult.class
        );
    }
    
    private PaymentResult paymentFallback(PaymentRequest request, Exception e) {
        // æ”¯ä»˜æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Œä¸èƒ½é™çº§ï¼Œç›´æ¥å¤±è´¥
        log.error("Payment service is down", e);
        throw new PaymentUnavailableException(
            "æ”¯ä»˜æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•"
        );
    }
}
```

---

## èˆ±å£éš”ç¦»æ¨¡å¼ï¼ˆBulkheadï¼‰

### æ¦‚å¿µ

**èˆ¹èˆ¶èˆ±å£**ï¼š
```
èˆ¹èˆ±è¢«åˆ†éš”æˆå¤šä¸ªç‹¬ç«‹èˆ±å®¤
ä¸€ä¸ªèˆ±å®¤è¿›æ°´ â†’ å…¶ä»–èˆ±å®¤ä¸å—å½±å“
```

**è½¯ä»¶éš”ç¦»**ï¼š
```
çº¿ç¨‹æ± éš”ç¦»ï¼š
- ä¸åŒæœåŠ¡ä½¿ç”¨ä¸åŒçº¿ç¨‹æ± 
- ä¸€ä¸ªæœåŠ¡æ…¢ â†’ ä¸å½±å“å…¶ä»–æœåŠ¡
```

### å®ç°ï¼ˆResilience4jï¼‰

**é…ç½®**ï¼š
```yaml
resilience4j:
  bulkhead:
    instances:
      userService:
        maxConcurrentCalls: 10        # æœ€å¤§å¹¶å‘æ•°
        maxWaitDuration: 100ms         # æœ€å¤§ç­‰å¾…æ—¶é—´
      
      orderService:
        maxConcurrentCalls: 20
        maxWaitDuration: 200ms
```

**ä»£ç **ï¼š
```java
@Service
public class UserService {
    @Bulkhead(name = "userService", fallbackMethod = "getUserBulkheadFallback")
    public User getUser(Long userId) {
        return restTemplate.getForObject(
            "http://user-service/users/" + userId,
            User.class
        );
    }
    
    private User getUserBulkheadFallback(Long userId, BulkheadFullException e) {
        log.warn("User service bulkhead is full");
        throw new ServiceUnavailableException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

**æ•ˆæœ**ï¼š
```
åœºæ™¯ï¼šUser Service æ…¢æŸ¥è¯¢å¯¼è‡´çº¿ç¨‹æ± è€—å°½

Without Bulkhead:
- User Service å ç”¨æ‰€æœ‰çº¿ç¨‹ï¼ˆ100ä¸ªï¼‰
- Order Service ä¹Ÿæ— æ³•è°ƒç”¨ï¼ˆæ— å¯ç”¨çº¿ç¨‹ï¼‰
- æ•´ä¸ªç³»ç»Ÿç˜«ç—ª

With Bulkhead:
- User Service åªå ç”¨ 10 ä¸ªçº¿ç¨‹
- Order Service ä»æœ‰ 20 ä¸ªçº¿ç¨‹å¯ç”¨
- éƒ¨åˆ†åŠŸèƒ½å¯ç”¨
```

---

## é™æµæ¨¡å¼ï¼ˆRate Limitingï¼‰

### ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰

**åŸç†**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Token Bucket   â”‚  å®¹é‡ï¼š10ä¸ªä»¤ç‰Œ
â”‚  â”Œâ”€â”€â”¬â”€â”€â”¬â”€â”€â”¬â”€â”€â” â”‚
â”‚  â”‚â—â”‚â—â”‚â—â”‚â—â”‚ ... â”‚  æ¯ç§’å¡«å……ï¼š5ä¸ªä»¤ç‰Œ
â”‚  â””â”€â”€â”´â”€â”€â”´â”€â”€â”´â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    è¯·æ±‚åˆ°è¾¾ â†’ å–å‡º1ä¸ªä»¤ç‰Œ â†’ å¤„ç†è¯·æ±‚
         â”‚
    ä»¤ç‰Œä¸è¶³ â†’ æ‹’ç»è¯·æ±‚
```

**å®ç°ï¼ˆResilience4jï¼‰**ï¼š
```yaml
resilience4j:
  ratelimiter:
    instances:
      userService:
        limitForPeriod: 10           # æ—¶é—´çª—å£å†…çš„è¯·æ±‚æ•°
        limitRefreshPeriod: 1s       # æ—¶é—´çª—å£
        timeoutDuration: 0ms         # ç­‰å¾…æ—¶é—´ï¼ˆ0=ç«‹å³å¤±è´¥ï¼‰
```

```java
@Service
public class UserService {
    @RateLimiter(name = "userService", fallbackMethod = "rateLimitFallback")
    public User getUser(Long userId) {
        return restTemplate.getForObject(
            "http://user-service/users/" + userId,
            User.class
        );
    }
    
    private User rateLimitFallback(Long userId, RequestNotPermitted e) {
        log.warn("Rate limit exceeded for user service");
        throw new TooManyRequestsException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰

**åŸç†**ï¼š
```
         è¯·æ±‚
          â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Bucket â”‚  å®¹é‡å›ºå®š
    â”‚   â–ˆâ–ˆâ–ˆâ–ˆ   â”‚
    â”‚   â–ˆâ–ˆâ–ˆâ–ˆ   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚ åŒ€é€Ÿæµå‡º
         â†“
      å¤„ç†è¯·æ±‚
```

**ç‰¹ç‚¹**ï¼š
- è¾“å‡ºé€Ÿç‡æ’å®š
- å¹³æ»‘æµé‡
- é€‚åˆéœ€è¦æ’å®šé€Ÿç‡çš„åœºæ™¯

### åˆ†å¸ƒå¼é™æµï¼ˆRedisï¼‰

```java
@Service
public class RateLimiterService {
    @Autowired
    private RedisTemplate<String, String> redis;
    
    public boolean isAllowed(String key, int limit, int window) {
        String redisKey = "rate_limit:" + key;
        long current = System.currentTimeMillis();
        long windowStart = current - window * 1000;
        
        // ä½¿ç”¨ Lua è„šæœ¬ä¿è¯åŸå­æ€§
        String script = 
            "local current = tonumber(ARGV[1]) " +
            "local window_start = tonumber(ARGV[2]) " +
            "local limit = tonumber(ARGV[3]) " +
            
            "redis.call('zremrangebyscore', KEYS[1], 0, window_start) " +
            "local count = redis.call('zcard', KEYS[1]) " +
            
            "if count < limit then " +
            "  redis.call('zadd', KEYS[1], current, current) " +
            "  redis.call('expire', KEYS[1], ARGV[4]) " +
            "  return 1 " +
            "else " +
            "  return 0 " +
            "end";
        
        Long result = redis.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(redisKey),
            String.valueOf(current),
            String.valueOf(windowStart),
            String.valueOf(limit),
            String.valueOf(window + 1)
        );
        
        return result != null && result == 1;
    }
}
```

---

## é‡è¯•æ¨¡å¼ï¼ˆRetryï¼‰

### æŒ‡æ•°é€€é¿ï¼ˆExponential Backoffï¼‰

**ç­–ç•¥**ï¼š
```
å¤±è´¥åé‡è¯•ï¼Œæ¯æ¬¡ç­‰å¾…æ—¶é—´æŒ‡æ•°å¢é•¿

ç¬¬1æ¬¡å¤±è´¥ â†’ ç­‰å¾… 1 ç§’ â†’ é‡è¯•
ç¬¬2æ¬¡å¤±è´¥ â†’ ç­‰å¾… 2 ç§’ â†’ é‡è¯•
ç¬¬3æ¬¡å¤±è´¥ â†’ ç­‰å¾… 4 ç§’ â†’ é‡è¯•
ç¬¬4æ¬¡å¤±è´¥ â†’ ç­‰å¾… 8 ç§’ â†’ é‡è¯•
...
æœ€å¤šé‡è¯• 5 æ¬¡
```

**å®ç°ï¼ˆResilience4jï¼‰**ï¼š
```yaml
resilience4j:
  retry:
    instances:
      userService:
        maxAttempts: 3                          # æœ€å¤§é‡è¯•æ¬¡æ•°
        waitDuration: 1000ms                    # åˆå§‹ç­‰å¾…æ—¶é—´
        enableExponentialBackoff: true          # å¯ç”¨æŒ‡æ•°é€€é¿
        exponentialBackoffMultiplier: 2         # ä¹˜æ•°
        retryExceptions:                        # é‡è¯•çš„å¼‚å¸¸
          - java.io.IOException
          - java.util.concurrent.TimeoutException
        ignoreExceptions:                       # ä¸é‡è¯•çš„å¼‚å¸¸
          - com.myapp.BusinessException
```

```java
@Service
public class UserService {
    @Retry(name = "userService", fallbackMethod = "getUserRetryFallback")
    public User getUser(Long userId) {
        log.info("Calling user service for user {}", userId);
        return restTemplate.getForObject(
            "http://user-service/users/" + userId,
            User.class
        );
    }
    
    private User getUserRetryFallback(Long userId, Exception e) {
        log.error("Failed after retries", e);
        return getCachedUser(userId);
    }
}
```

### æŠ–åŠ¨ï¼ˆJitterï¼‰

**é—®é¢˜**ï¼šæ‰€æœ‰å®¢æˆ·ç«¯åŒæ—¶é‡è¯• â†’ é›ªå´©

**è§£å†³**ï¼šåŠ å…¥éšæœºæ€§

```java
public class RetryWithJitter {
    private Random random = new Random();
    
    public void retryWithJitter(Runnable task, int maxRetries) {
        int retries = 0;
        
        while (retries < maxRetries) {
            try {
                task.run();
                return;  // æˆåŠŸ
            } catch (Exception e) {
                retries++;
                
                if (retries >= maxRetries) {
                    throw e;
                }
                
                // æŒ‡æ•°é€€é¿ + æŠ–åŠ¨
                long baseDelay = (long) Math.pow(2, retries) * 1000;
                long jitter = random.nextInt(1000);
                long delay = baseDelay + jitter;
                
                try {
                    Thread.sleep(delay);
                } catch (InterruptedException ie) {
                    Thread.currentThread().interrupt();
                    throw new RuntimeException(ie);
                }
            }
        }
    }
}
```

---

## è¶…æ—¶æ¨¡å¼ï¼ˆTimeoutï¼‰

### è®¾ç½®åˆç†çš„è¶…æ—¶

```java
@Service
public class UserService {
    @Autowired
    private RestTemplate restTemplate;
    
    @TimeLimiter(name = "userService", fallbackMethod = "getUserTimeout")
    public CompletableFuture<User> getUserAsync(Long userId) {
        return CompletableFuture.supplyAsync(() ->
            restTemplate.getForObject(
                "http://user-service/users/" + userId,
                User.class
            )
        );
    }
    
    private CompletableFuture<User> getUserTimeout(Long userId, TimeoutException e) {
        log.warn("User service timeout");
        return CompletableFuture.completedFuture(getCachedUser(userId));
    }
}
```

**é…ç½®**ï¼š
```yaml
resilience4j:
  timelimiter:
    instances:
      userService:
        timeoutDuration: 3s           # è¶…æ—¶æ—¶é—´
        cancelRunningFuture: true     # å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡
```

### è¶…æ—¶ä¼ æ’­

```
Client â†’ Service A (3s timeout)
             â†“
         Service B (2s timeout)
             â†“
         Service C (1s timeout)

å»ºè®®ï¼šé€å±‚é€’å‡ï¼Œç•™å‡ºå¤„ç†æ—¶é—´
```

---

## ç»„åˆä½¿ç”¨

### å®Œæ•´å¼¹æ€§æ ˆ

```java
@Service
public class UserService {
    // ç»„åˆå¤šç§æ¨¡å¼
    @CircuitBreaker(name = "userService")
    @RateLimiter(name = "userService")
    @Retry(name = "userService")
    @Bulkhead(name = "userService")
    @TimeLimiter(name = "userService")
    public CompletableFuture<User> getUser(Long userId) {
        return CompletableFuture.supplyAsync(() ->
            restTemplate.getForObject(
                "http://user-service/users/" + userId,
                User.class
            )
        );
    }
}
```

**æ‰§è¡Œé¡ºåº**ï¼š
```
Request
  â†“
RateLimiterï¼ˆé™æµï¼‰
  â†“
CircuitBreakerï¼ˆæ–­è·¯å™¨ï¼‰
  â†“
Bulkheadï¼ˆéš”ç¦»ï¼‰
  â†“
TimeLimiterï¼ˆè¶…æ—¶ï¼‰
  â†“
Retryï¼ˆé‡è¯•ï¼‰
  â†“
å®é™…è°ƒç”¨
```

---

## ç›‘æ§ä¸å‘Šè­¦

### å…³é”®æŒ‡æ ‡

```yaml
æ–­è·¯å™¨çŠ¶æ€ï¼š
- circuit_breaker.state (0=Closed, 1=Open, 2=Half-Open)
- circuit_breaker.failure_rate
- circuit_breaker.slow_call_rate

è°ƒç”¨ç»Ÿè®¡ï¼š
- resilience4j.calls.total
- resilience4j.calls.successful
- resilience4j.calls.failed
- resilience4j.calls.duration

é™æµç»Ÿè®¡ï¼š
- resilience4j.ratelimiter.available_permissions
- resilience4j.ratelimiter.waiting_threads
```

### Grafana ä»ªè¡¨ç›˜

```promql
# æ–­è·¯å™¨æ‰“å¼€æ¬¡æ•°
increase(resilience4j_circuitbreaker_state{state="open"}[5m])

# å¤±è´¥ç‡
rate(resilience4j_circuitbreaker_calls_total{kind="failed"}[5m]) /
rate(resilience4j_circuitbreaker_calls_total[5m])

# é™æµæ‹’ç»ç‡
rate(resilience4j_ratelimiter_calls_total{kind="failed"}[5m]) /
rate(resilience4j_ratelimiter_calls_total[5m])
```

---

## å…³é”®æ´å¯Ÿ

### æ´å¯Ÿ 1ï¼šå¿«é€Ÿå¤±è´¥ > æ…¢å¤±è´¥

```
æ…¢å¤±è´¥ï¼ˆæ— æ–­è·¯å™¨ï¼‰ï¼š
- è¯·æ±‚è¶…æ—¶ï¼š30ç§’
- ç”¨æˆ·ä½“éªŒï¼šç­‰å¾… 30 ç§’åå¤±è´¥
- ç³»ç»Ÿèµ„æºï¼šçº¿ç¨‹è¢«å ç”¨ 30 ç§’

å¿«é€Ÿå¤±è´¥ï¼ˆæœ‰æ–­è·¯å™¨ï¼‰ï¼š
- æ–­è·¯å™¨æ‰“å¼€ï¼šç«‹å³è¿”å›
- ç”¨æˆ·ä½“éªŒï¼šç¬é—´å¤±è´¥ï¼ˆå¯é™çº§ï¼‰
- ç³»ç»Ÿèµ„æºï¼šä¸å ç”¨èµ„æº
```

### æ´å¯Ÿ 2ï¼šé™çº§ > å¤±è´¥

```
æ— é™çº§ï¼š
æœåŠ¡ä¸å¯ç”¨ â†’ è¿”å› 500 é”™è¯¯ â†’ ç”¨æˆ·çœ‹åˆ°æŠ¥é”™

æœ‰é™çº§ï¼š
æœåŠ¡ä¸å¯ç”¨ â†’ è¿”å›ç¼“å­˜æ•°æ® â†’ ç”¨æˆ·ä½“éªŒé™ä½ä½†å¯ç”¨
```

### æ´å¯Ÿ 3ï¼šéš”ç¦» > å…±äº«

```
å…±äº«çº¿ç¨‹æ± ï¼š
ä¸€ä¸ªæœåŠ¡æ…¢ â†’ å æ»¡çº¿ç¨‹æ±  â†’ æ‰€æœ‰æœåŠ¡å—å½±å“

éš”ç¦»çº¿ç¨‹æ± ï¼š
ä¸€ä¸ªæœåŠ¡æ…¢ â†’ åªå ç”¨è‡ªå·±çš„çº¿ç¨‹æ±  â†’ å…¶ä»–æœåŠ¡æ­£å¸¸
```

---

## ç›¸å…³ä¸»é¢˜

- [09.1 å¾®æœåŠ¡æ‹†åˆ†ç­–ç•¥](./09.1_Microservices_Decomposition.md)
- [09.2 æœåŠ¡é—´é€šä¿¡æ¨¡å¼](./09.2_Inter_Service_Communication.md)
- [09.8 ç§’æ€ç³»ç»Ÿæ¡ˆä¾‹](./09.8_Case_Study_Flash_Sale_System.md)

---

**å¯¼èˆª**ï¼š[è¿”å›äº‘åŸç”Ÿæ¨¡å¼](./README.md) | [â† ä¸Šä¸€èŠ‚ï¼šæœåŠ¡é—´é€šä¿¡](./09.2_Inter_Service_Communication.md) | [ä¸‹ä¸€èŠ‚ï¼šåˆ†å¸ƒå¼æ•°æ®ç®¡ç† â†’](./09.4_Distributed_Data_Management.md)

