# 9.8 å®æˆ˜æ¡ˆä¾‹ï¼šé«˜å¹¶å‘ç§’æ€ç³»ç»Ÿ

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
> **æœ€åæ›´æ–°**: 2025-10-27  
> **æ–‡æ¡£è§„æ¨¡**: 725è¡Œ | ç§’æ€ç³»ç»Ÿæ¶æ„è®¾è®¡  
> **é˜…è¯»å»ºè®®**: æœ¬æ–‡ä»¥åŒ11ç§’æ€ä¸ºä¾‹ï¼Œå±•ç¤ºäº‘åŸç”Ÿæ¨¡å¼çš„ç»¼åˆåº”ç”¨

---

## ğŸ“‹ ç›®å½•

- [ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ](#æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ)
- [æ¡ˆä¾‹èƒŒæ™¯](#æ¡ˆä¾‹èƒŒæ™¯)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
  - [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ](#æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ)
  - [1. é¡µé¢é™æ€åŒ– + CDN](#1-é¡µé¢é™æ€åŒ–-cdn)
  - [2. å¤šçº§é™æµ](#2-å¤šçº§é™æµ)
    - [Level 1ï¼šNginxé™æµ](#level-1nginxé™æµ)
    - [Level 2ï¼šRedisä»¤ç‰Œæ¡¶é™æµ](#level-2redisä»¤ç‰Œæ¡¶é™æµ)
  - [3. åº“å­˜é¢„æ‰£å‡ï¼ˆRedisåŸå­æ“ä½œï¼‰](#3-åº“å­˜é¢„æ‰£å‡redisåŸå­æ“ä½œ)
  - [4. å¼‚æ­¥å‰Šå³°ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰](#4-å¼‚æ­¥å‰Šå³°æ¶ˆæ¯é˜Ÿåˆ—)
  - [5. é˜²åˆ·ç­–ç•¥](#5-é˜²åˆ·ç­–ç•¥)
    - [éªŒè¯ç ](#éªŒè¯ç )
    - [é˜²æ­¢é‡å¤ä¸‹å•](#é˜²æ­¢é‡å¤ä¸‹å•)
  - [6. è®¢å•è¶…æ—¶å–æ¶ˆ](#6-è®¢å•è¶…æ—¶å–æ¶ˆ)
- [å®Œæ•´æµç¨‹æ—¶åºå›¾](#å®Œæ•´æµç¨‹æ—¶åºå›¾)
- [æ€§èƒ½æµ‹è¯•ç»“æœ](#æ€§èƒ½æµ‹è¯•ç»“æœ)
  - [å‹æµ‹åœºæ™¯](#å‹æµ‹åœºæ™¯)
  - [æµ‹è¯•ç»“æœ](#æµ‹è¯•ç»“æœ)
- [æˆæœ¬åˆ†æ](#æˆæœ¬åˆ†æ)
  - [èµ„æºé…ç½®](#èµ„æºé…ç½®)
- [å…³é”®æ´å¯Ÿ](#å…³é”®æ´å¯Ÿ)
  - [æ´å¯Ÿ 1ï¼šæ‹¦æˆªåœ¨å‰ï¼Œå¤„ç†åœ¨å](#æ´å¯Ÿ-1æ‹¦æˆªåœ¨å‰å¤„ç†åœ¨å)
  - [æ´å¯Ÿ 2ï¼šç©ºé—´æ¢æ—¶é—´](#æ´å¯Ÿ-2ç©ºé—´æ¢æ—¶é—´)
  - [æ´å¯Ÿ 3ï¼šå¼‚æ­¥å‰Šå³°](#æ´å¯Ÿ-3å¼‚æ­¥å‰Šå³°)
- [ç›¸å…³ä¸»é¢˜](#ç›¸å…³ä¸»é¢˜)
- [é™„å½•ï¼šå‹æµ‹è„šæœ¬](#é™„å½•å‹æµ‹è„šæœ¬)

---

## ğŸ“Š æ ¸å¿ƒæ¦‚å¿µæ·±åº¦åˆ†æ

<details>
<summary><b>ğŸ”¥ğŸš€ ç‚¹å‡»å±•å¼€ï¼šç§’æ€ç³»ç»Ÿæ ¸å¿ƒæ´å¯Ÿ</b></summary>

**ç»ˆææ´å¯Ÿ**: ç§’æ€ç³»ç»Ÿ=é«˜å¹¶å‘+è¶…å–é˜²æŠ¤+ç³»ç»Ÿéš”ç¦»çš„ä¸‰é‡æŒ‘æˆ˜ã€‚åœºæ™¯ï¼šåŒ11ç§’æ€ï¼ˆ100ä¸‡äººæŠ¢100ä»¶å•†å“ï¼Œå³°å€¼10ä¸‡QPSï¼ŒæˆåŠŸç‡<0.01%ï¼‰ã€‚æ ¸å¿ƒæŒ‘æˆ˜ï¼šâ‘ é«˜å¹¶å‘ï¼šç¬æ—¶æµé‡å†²å‡»â‘¡è¶…å–é—®é¢˜ï¼šåº“å­˜ä¸€è‡´æ€§â‘¢ç³»ç»Ÿç¨³å®šæ€§ï¼šä¸å½±å“æ­£å¸¸ä¸šåŠ¡â‘£ç”¨æˆ·ä½“éªŒï¼šå¿«é€Ÿå“åº”ã€‚æ¶æ„è®¾è®¡ï¼šâ‘ CDNé™æ€èµ„æºâ‘¡Nginxé™æµï¼ˆä»¤ç‰Œæ¡¶ï¼‰â‘¢Redisé¢„çƒ­åº“å­˜ï¼ˆåŸå­æ‰£å‡DECRï¼‰â‘£æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ï¼ˆå‰Šå³°å¡«è°·ï¼‰â‘¤åˆ†å¸ƒå¼é”ï¼ˆé˜²è¶…å–ï¼‰â‘¥æœåŠ¡éš”ç¦»ï¼ˆå•ç‹¬é›†ç¾¤ï¼‰â‘¦é™çº§å…œåº•ï¼ˆå”®ç½„æç¤ºï¼‰ã€‚å…³é”®æŠ€æœ¯ï¼šâ‘ å‰ç«¯é˜²åˆ·ï¼šæŒ‰é’®ç½®ç°ã€éªŒè¯ç â‘¡ç¼“å­˜é¢„çƒ­ï¼šæå‰åŠ è½½åˆ°Redisâ‘¢åŸå­æ“ä½œï¼šDECRä¿è¯åŸå­æ€§â‘£å¼‚æ­¥åŒ–ï¼šMQå‰Šå³°â‘¤é™æµé™çº§ï¼šSentinel/Hystrixâ‘¥ç›‘æ§å‘Šè­¦ï¼šå®æ—¶Metricsã€‚å‹æµ‹éªŒè¯ï¼šâ‘ åŸºå‡†æµ‹è¯•ï¼šå•æœºQPSâ‘¡å®¹é‡è§„åˆ’ï¼šé›†ç¾¤è§„æ¨¡â‘¢å…¨é“¾è·¯å‹æµ‹ï¼šæ¨¡æ‹ŸçœŸå®æµé‡ã€‚å…³é”®ç»éªŒï¼šâ‘ æµé‡å±‚å±‚è¿‡æ»¤ï¼ˆCDNâ†’é™æµâ†’ç¼“å­˜â†’é˜Ÿåˆ—ï¼‰â‘¡æœ€å°åŒ–DBå‹åŠ›â‘¢å¿«é€Ÿå¤±è´¥ä¼˜é›…é™çº§ã€‚

</details>

---

## æ¡ˆä¾‹èƒŒæ™¯

**åœºæ™¯**ï¼šåŒ11ç§’æ€æ´»åŠ¨

- **å³°å€¼QPS**ï¼š10ä¸‡/ç§’
- **å•†å“æ•°é‡**ï¼š100ä»¶ï¼ˆåº“å­˜æå°‘ï¼‰
- **å‚ä¸äººæ•°**ï¼š100ä¸‡äºº
- **æˆåŠŸç‡**ï¼š< 0.01%

**æ ¸å¿ƒæŒ‘æˆ˜**ï¼š

1. **é«˜å¹¶å‘**ï¼š100ä¸‡è¯·æ±‚ç¬é—´æ¶Œå…¥
2. **è¶…å–é—®é¢˜**ï¼šåº“å­˜100ä»¶ï¼Œä¸èƒ½å–å‡º101ä»¶
3. **ç³»ç»Ÿç¨³å®šæ€§**ï¼šä¸èƒ½å› ç§’æ€å½±å“æ­£å¸¸è®¢å•
4. **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿå“åº”ï¼Œé¿å…å¡é¡¿

---

## ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·å±‚ï¼ˆ100ä¸‡ç”¨æˆ·ï¼‰                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ HTTPS
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CDN + é™æ€èµ„æº                                         â”‚
â”‚  - å•†å“è¯¦æƒ…é¡µï¼ˆé™æ€åŒ–ï¼‰                                  â”‚
â”‚  - JS/CSS/å›¾ç‰‡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ åŠ¨æ€è¯·æ±‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¥å…¥å±‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Nginx    â”‚  â”‚ é™æµ     â”‚  â”‚ é˜²åˆ·      â”‚              â”‚
â”‚  â”‚ è´Ÿè½½å‡è¡¡  â”‚  â”‚ 100K QPS â”‚  â”‚ éªŒè¯ç    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                 â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç§’æ€æœåŠ¡  â”‚    â”‚è®¢å•æœåŠ¡  â”‚  â”‚æ”¯ä»˜æœåŠ¡ â”‚
â”‚(æ ¸å¿ƒ)    â”‚    â”‚         â”‚  â”‚        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¼“å­˜å±‚ï¼ˆRedis Clusterï¼‰             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚åº“å­˜ç¼“å­˜     â”‚  â”‚ä»¤ç‰Œæ¡¶é™æµ   â”‚     â”‚
â”‚  â”‚100 â†’ 99... â”‚  â”‚            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaï¼‰                   â”‚
â”‚  - å¼‚æ­¥å‰Šå³°                          â”‚
â”‚  - è®¢å•åˆ›å»ºè§£è€¦                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åº“ï¼ˆMySQL ä¸»ä»ï¼‰                â”‚
â”‚  - è®¢å•è¡¨                           â”‚
â”‚  - åº“å­˜è¡¨ï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ

### 1. é¡µé¢é™æ€åŒ– + CDN

**é—®é¢˜**ï¼šå•†å“è¯¦æƒ…é¡µé¢‘ç¹è®¿é—®ï¼Œæ•°æ®åº“å‹åŠ›å¤§

**è§£å†³**ï¼šé™æ€åŒ– + CDN

```html
<!-- ç§’æ€å•†å“è¯¦æƒ…é¡µï¼ˆé™æ€HTMLï¼‰ -->
<!DOCTYPE html>
<html>
<head>
    <title>iPhone 15 Pro ç§’æ€</title>
    <link rel="stylesheet" href="https://cdn.example.com/css/seckill.css">
</head>
<body>
    <!-- å•†å“ä¿¡æ¯ï¼ˆé™æ€ï¼‰ -->
    <div class="product-info">
        <img src="https://cdn.example.com/images/iphone15.jpg" />
        <h1>iPhone 15 Pro 256GB</h1>
        <p class="price">ç§’æ€ä»·ï¼šÂ¥5999 <del>åŸä»·ï¼šÂ¥8999</del></p>
        <p class="stock">åº“å­˜ï¼š<span id="stock">100</span>ä»¶</p>
    </div>
    
    <!-- ç§’æ€æŒ‰é’® -->
    <button id="seckill-btn" onclick="doSeckill()">ç«‹å³æŠ¢è´­</button>
    
    <script src="https://cdn.example.com/js/seckill.js"></script>
    <script>
        // åŠ¨æ€åŠ è½½åº“å­˜ï¼ˆAJAXï¼‰
        fetch('https://api.example.com/seckill/stock/12345')
            .then(res => res.json())
            .then(data => {
                document.getElementById('stock').innerText = data.stock;
            });
        
        // ç§’æ€å€’è®¡æ—¶
        let startTime = new Date('2025-11-11 20:00:00');
        setInterval(() => {
            let now = new Date();
            let diff = startTime - now;
            if (diff <= 0) {
                document.getElementById('seckill-btn').disabled = false;
            }
        }, 1000);
        
        function doSeckill() {
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            document.getElementById('seckill-btn').disabled = true;
            
            fetch('https://api.example.com/seckill/purchase', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    productId: 12345,
                    userId: getUserId(),
                    token: getCaptchaToken()  // éªŒè¯ç token
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('æŠ¢è´­æˆåŠŸï¼è®¢å•å·ï¼š' + data.orderId);
                    location.href = '/orders/' + data.orderId;
                } else {
                    alert('æŠ¢è´­å¤±è´¥ï¼š' + data.message);
                    document.getElementById('seckill-btn').disabled = false;
                }
            });
        }
    </script>
</body>
</html>
```

**æ•ˆæœ**ï¼š

- é™æ€é¡µé¢å‘½ä¸­CDNï¼š100% â†’ ä¸è®¿é—®æœåŠ¡å™¨
- åº“å­˜æ•°æ®åŠ¨æ€åŠ è½½ï¼šå»¶è¿ŸåŠ è½½ï¼Œå‡å°‘å‹åŠ›
- **QPSé™ä½**ï¼š100ä¸‡ â†’ 1ä¸‡ï¼ˆåªæœ‰åŠ¨æ€è¯·æ±‚ï¼‰

### 2. å¤šçº§é™æµ

#### Level 1ï¼šNginxé™æµ

```nginx
# nginx.conf
http {
    # å®šä¹‰é™æµåŒºåŸŸ
    limit_req_zone $binary_remote_addr zone=seckill_limit:10m rate=10r/s;
    
    server {
        listen 80;
        server_name api.example.com;
        
        location /seckill/ {
            # åº”ç”¨é™æµï¼šæ¯IPæ¯ç§’10ä¸ªè¯·æ±‚ï¼Œburst 20
            limit_req zone=seckill_limit burst=20 nodelay;
            
            # é™åˆ¶å¹¶å‘è¿æ¥æ•°
            limit_conn_zone $binary_remote_addr zone=addr:10m;
            limit_conn addr 5;
            
            proxy_pass http://seckill_backend;
        }
    }
}
```

**æ•ˆæœ**ï¼š

- å•IPé™æµï¼šé˜²æ­¢å•ä¸ªç”¨æˆ·æš´åŠ›åˆ·æ¥å£
- æ€»QPSé™æµï¼š10ä¸‡ â†’ 5ä¸‡ï¼ˆNginxå±‚ï¼‰

#### Level 2ï¼šRedisä»¤ç‰Œæ¡¶é™æµ

```java
@Service
public class RateLimiterService {
    @Autowired
    private RedisTemplate<String, String> redis;
    
    /**
     * ä»¤ç‰Œæ¡¶é™æµ
     * @param key é™æµkeyï¼ˆå¦‚ï¼šseckill:12345ï¼‰
     * @param capacity æ¡¶å®¹é‡
     * @param rate ä»¤ç‰Œç”Ÿæˆé€Ÿç‡ï¼ˆä¸ª/ç§’ï¼‰
     */
    public boolean tryAcquire(String key, int capacity, int rate) {
        String script =
            "local key = KEYS[1] " +
            "local capacity = tonumber(ARGV[1]) " +
            "local rate = tonumber(ARGV[2]) " +
            "local now = tonumber(ARGV[3]) " +
            
            "local tokens_key = key .. ':tokens' " +
            "local timestamp_key = key .. ':timestamp' " +
            
            // è·å–å½“å‰ä»¤ç‰Œæ•°å’Œä¸Šæ¬¡æ›´æ–°æ—¶é—´
            "local tokens = tonumber(redis.call('get', tokens_key) or capacity) " +
            "local last_time = tonumber(redis.call('get', timestamp_key) or now) " +
            
            // è®¡ç®—æ–°å¢ä»¤ç‰Œæ•°
            "local delta = math.max(0, now - last_time) " +
            "local new_tokens = math.min(capacity, tokens + delta * rate) " +
            
            // å°è¯•æ¶ˆè´¹1ä¸ªä»¤ç‰Œ
            "if new_tokens >= 1 then " +
            "  redis.call('set', tokens_key, new_tokens - 1) " +
            "  redis.call('set', timestamp_key, now) " +
            "  return 1 " +
            "else " +
            "  redis.call('set', tokens_key, new_tokens) " +
            "  redis.call('set', timestamp_key, now) " +
            "  return 0 " +
            "end";
        
        Long result = redis.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(capacity),
            String.valueOf(rate),
            String.valueOf(System.currentTimeMillis() / 1000)
        );
        
        return result != null && result == 1;
    }
}
```

**ä½¿ç”¨**ï¼š

```java
@RestController
@RequestMapping("/seckill")
public class SeckillController {
    @Autowired
    private RateLimiterService rateLimiter;
    
    @PostMapping("/purchase")
    public Result purchase(@RequestBody SeckillRequest request) {
        String limiterKey = "seckill:" + request.getProductId();
        
        // é™æµï¼šæ¯ç§’1000ä¸ªä»¤ç‰Œ
        if (!rateLimiter.tryAcquire(limiterKey, 1000, 1000)) {
            return Result.fail("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åå†è¯•");
        }
        
        // å¤„ç†ç§’æ€é€»è¾‘...
        return seckillService.purchase(request);
    }
}
```

### 3. åº“å­˜é¢„æ‰£å‡ï¼ˆRedisåŸå­æ“ä½œï¼‰

**é—®é¢˜**ï¼š100ä¸‡è¯·æ±‚ï¼Œåº“å­˜åªæœ‰100ï¼Œå¦‚ä½•é˜²æ­¢è¶…å–ï¼Ÿ

**æ–¹æ¡ˆ**ï¼šRedisåŸå­æ“ä½œ

```java
@Service
public class StockService {
    @Autowired
    private RedisTemplate<String, String> redis;
    
    /**
     * é¢„æ‰£å‡åº“å­˜
     */
    public boolean deductStock(Long productId, int quantity) {
        String key = "stock:" + productId;
        
        // Luaè„šæœ¬ä¿è¯åŸå­æ€§
        String script =
            "local stock = tonumber(redis.call('get', KEYS[1]) or 0) " +
            "local quantity = tonumber(ARGV[1]) " +
            "if stock >= quantity then " +
            "  redis.call('decrby', KEYS[1], quantity) " +
            "  return 1 " +
            "else " +
            "  return 0 " +
            "end";
        
        Long result = redis.execute(
            new DefaultRedisScript<>(script, Long.class),
            Collections.singletonList(key),
            String.valueOf(quantity)
        );
        
        return result != null && result == 1;
    }
    
    /**
     * åˆå§‹åŒ–åº“å­˜ï¼ˆç§’æ€å‰ï¼‰
     */
    public void initStock(Long productId, int stock) {
        String key = "stock:" + productId;
        redis.opsForValue().set(key, String.valueOf(stock));
    }
    
    /**
     * å›æ»šåº“å­˜ï¼ˆè®¢å•å–æ¶ˆï¼‰
     */
    public void rollbackStock(Long productId, int quantity) {
        String key = "stock:" + productId;
        redis.opsForValue().increment(key, quantity);
    }
}
```

**æµç¨‹**ï¼š

```
Step 1: ç§’æ€å‰åˆå§‹åŒ–
initStock(12345, 100)
â†’ Redis: stock:12345 = 100

Step 2: ç”¨æˆ·æŠ¢è´­
deductStock(12345, 1)
â†’ Redis: stock:12345 = 99  (åŸå­æ“ä½œ)

Step 3: åº“å­˜è€—å°½
deductStock(12345, 1)
â†’ Redis: stock:12345 = 0
â†’ å†æœ‰è¯·æ±‚ï¼šè¿”å› falseï¼ˆä¸å…è®¸æ‰£å‡ï¼‰

Step 4: è®¢å•å–æ¶ˆï¼ˆ15åˆ†é’Ÿæœªæ”¯ä»˜ï¼‰
rollbackStock(12345, 1)
â†’ Redis: stock:12345 = 1
```

### 4. å¼‚æ­¥å‰Šå³°ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰

**é—®é¢˜**ï¼š1ç§’å†…100ä¸‡è¯·æ±‚ï¼Œæ•°æ®åº“å†™å…¥æ‰¿å—ä¸äº†

**æ–¹æ¡ˆ**ï¼šæ¶ˆæ¯é˜Ÿåˆ—å‰Šå³°

```java
@Service
public class SeckillService {
    @Autowired
    private StockService stockService;
    @Autowired
    private KafkaTemplate<String, SeckillMessage> kafka;
    
    public Result purchase(SeckillRequest request) {
        Long productId = request.getProductId();
        Long userId = request.getUserId();
        
        // 1. éªŒè¯ç”¨æˆ·èµ„æ ¼
        if (!validateUser(userId, productId)) {
            return Result.fail("ä¸ç¬¦åˆæŠ¢è´­æ¡ä»¶");
        }
        
        // 2. é¢„æ‰£å‡åº“å­˜ï¼ˆRedisï¼‰
        if (!stockService.deductStock(productId, 1)) {
            return Result.fail("å•†å“å·²å”®ç½„");
        }
        
        // 3. å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ï¼ˆå¼‚æ­¥åˆ›å»ºè®¢å•ï¼‰
        SeckillMessage message = new SeckillMessage();
        message.setProductId(productId);
        message.setUserId(userId);
        message.setTimestamp(System.currentTimeMillis());
        
        kafka.send("seckill-orders", message);
        
        // 4. ç«‹å³è¿”å›ï¼ˆä¸ç­‰å¾…è®¢å•åˆ›å»ºï¼‰
        return Result.success("æŠ¢è´­æˆåŠŸï¼Œæ­£åœ¨åˆ›å»ºè®¢å•...");
    }
}
```

**æ¶ˆè´¹è€…**ï¼ˆå¼‚æ­¥åˆ›å»ºè®¢å•ï¼‰ï¼š

```java
@Service
public class OrderConsumer {
    @KafkaListener(topics = "seckill-orders", concurrency = "10")
    public void handleSeckillOrder(SeckillMessage message) {
        try {
            // 1. åˆ›å»ºè®¢å•
            Order order = new Order();
            order.setUserId(message.getUserId());
            order.setProductId(message.getProductId());
            order.setStatus(OrderStatus.UNPAID);
            order.setExpireTime(LocalDateTime.now().plusMinutes(15));
            
            orderRepository.save(order);
            
            // 2. å‘é€æ”¯ä»˜é€šçŸ¥
            notificationService.sendPaymentNotice(order);
            
            // 3. è®¾ç½®è®¢å•è¶…æ—¶å–æ¶ˆä»»åŠ¡
            scheduleOrderExpiration(order.getId(), 15 * 60 * 1000);
            
        } catch (Exception e) {
            log.error("Failed to create order", e);
            
            // å¤±è´¥å›æ»šåº“å­˜
            stockService.rollbackStock(
                message.getProductId(), 
                1
            );
        }
    }
}
```

**æ•ˆæœ**ï¼š

```
ç¬æ—¶å³°å€¼ï¼š100ä¸‡è¯·æ±‚/ç§’
    â†“
Redisé¢„æ‰£å‡ï¼š100ä¸ªæˆåŠŸï¼Œå…¶ä½™å¤±è´¥
    â†“
Kafkaå‰Šå³°ï¼š100ä¸ªè®¢å•æ¶ˆæ¯
    â†“
æ¶ˆè´¹è€…å¤„ç†ï¼š10 TPSï¼ˆæ…¢æ…¢å†™æ•°æ®åº“ï¼‰

ç»“æœï¼š
- æ•°æ®åº“å‹åŠ›ï¼š10 TPSï¼ˆå¯æ‰¿å—ï¼‰
- ç”¨æˆ·ä½“éªŒï¼šç§’çº§å“åº”
```

### 5. é˜²åˆ·ç­–ç•¥

#### éªŒè¯ç 

```java
@Service
public class CaptchaService {
    @Autowired
    private RedisTemplate<String, String> redis;
    
    /**
     * ç”ŸæˆéªŒè¯ç 
     */
    public String generateCaptcha(Long userId) {
        // ç”Ÿæˆ4ä½æ•°å­—éªŒè¯ç 
        String code = String.format("%04d", new Random().nextInt(10000));
        
        // å­˜å…¥Redisï¼Œ5åˆ†é’Ÿè¿‡æœŸ
        String key = "captcha:" + userId;
        redis.opsForValue().set(key, code, 5, TimeUnit.MINUTES);
        
        return code;
    }
    
    /**
     * éªŒè¯éªŒè¯ç 
     */
    public boolean validateCaptcha(Long userId, String code) {
        String key = "captcha:" + userId;
        String stored = redis.opsForValue().get(key);
        
        if (stored == null || !stored.equals(code)) {
            return false;
        }
        
        // éªŒè¯æˆåŠŸååˆ é™¤ï¼ˆé˜²æ­¢é‡å¤ä½¿ç”¨ï¼‰
        redis.delete(key);
        return true;
    }
}
```

#### é˜²æ­¢é‡å¤ä¸‹å•

```java
@Service
public class DuplicateCheckService {
    @Autowired
    private RedisTemplate<String, String> redis;
    
    /**
     * æ£€æŸ¥æ˜¯å¦å·²å‚ä¸ç§’æ€
     */
    public boolean isAlreadyPurchased(Long userId, Long productId) {
        String key = String.format("seckill:user:%d:product:%d", userId, productId);
        
        // SETNXï¼šä¸å­˜åœ¨æ‰è®¾ç½®
        Boolean success = redis.opsForValue().setIfAbsent(
            key, 
            "1", 
            24, 
            TimeUnit.HOURS
        );
        
        // success = true: ç¬¬ä¸€æ¬¡å‚ä¸
        // success = false: å·²ç»å‚ä¸è¿‡
        return success == null || !success;
    }
}
```

### 6. è®¢å•è¶…æ—¶å–æ¶ˆ

```java
@Service
public class OrderExpirationService {
    @Autowired
    private RedisTemplate<String, String> redis;
    @Autowired
    private OrderService orderService;
    @Autowired
    private StockService stockService;
    
    /**
     * å»¶è¿Ÿä»»åŠ¡ï¼š15åˆ†é’Ÿåå–æ¶ˆæœªæ”¯ä»˜è®¢å•
     */
    public void scheduleOrderExpiration(Long orderId, long delayMs) {
        // ä½¿ç”¨Redisçš„è¿‡æœŸé”® + KeyExpiredListener
        String key = "order:expiration:" + orderId;
        redis.opsForValue().set(key, "1", delayMs, TimeUnit.MILLISECONDS);
    }
    
    @Component
    public static class OrderExpirationListener extends KeyExpirationEventMessageListener {
        @Autowired
        private OrderService orderService;
        @Autowired
        private StockService stockService;
        
        @Override
        public void onMessage(Message message, byte[] pattern) {
            String expiredKey = message.toString();
            
            if (expiredKey.startsWith("order:expiration:")) {
                Long orderId = Long.parseLong(expiredKey.substring(17));
                
                // æŸ¥è¯¢è®¢å•çŠ¶æ€
                Order order = orderService.getOrder(orderId);
                
                if (order != null && order.getStatus() == OrderStatus.UNPAID) {
                    // å–æ¶ˆè®¢å•
                    order.setStatus(OrderStatus.CANCELLED);
                    order.setCancelReason("è¶…æ—¶æœªæ”¯ä»˜");
                    orderService.updateOrder(order);
                    
                    // å›æ»šåº“å­˜
                    stockService.rollbackStock(order.getProductId(), 1);
                    
                    log.info("Order {} cancelled due to expiration", orderId);
                }
            }
        }
    }
}
```

---

## å®Œæ•´æµç¨‹æ—¶åºå›¾

```
ç”¨æˆ·    â”‚  Nginx  â”‚  ç§’æ€æœåŠ¡  â”‚  Redis  â”‚  Kafka  â”‚  è®¢å•æ¶ˆè´¹è€…  â”‚  æ•°æ®åº“
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚é™æµæ£€æŸ¥ â”‚          â”‚         â”‚         â”‚             â”‚
  â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚é˜²åˆ·éªŒè¯  â”‚         â”‚         â”‚             â”‚
  â”‚         â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚éªŒè¯ç    â”‚         â”‚             â”‚
  â”‚         â”‚         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚         â”‚             â”‚
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  â”‚         â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚é¢„æ‰£åº“å­˜ â”‚         â”‚             â”‚
  â”‚         â”‚         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤æˆåŠŸ/å¤±è´¥â”‚         â”‚             â”‚
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  â”‚         â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚å‘é€æ¶ˆæ¯ â”‚             â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”¤<â”€â”€â”€â”€â”€â”€â”€â”€â”¤æŠ¢è´­æˆåŠŸ  â”‚         â”‚         â”‚             â”‚
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  â”‚         â”‚         â”‚          â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚æ¶ˆè´¹æ¶ˆæ¯     â”‚
  â”‚         â”‚         â”‚          â”‚         â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚åˆ›å»ºè®¢å•
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤æ”¯ä»˜é€šçŸ¥     â”‚
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚æ”¯ä»˜
  â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚         â”‚         â”‚          â”‚         â”‚         â”‚             â”‚
  
æ€»è€—æ—¶ï¼š< 200msï¼ˆç”¨æˆ·æ„ŸçŸ¥ï¼‰
åå°å¼‚æ­¥ï¼šåˆ›å»ºè®¢å•ï¼ˆ2-5ç§’ï¼‰
```

---

## æ€§èƒ½æµ‹è¯•ç»“æœ

### å‹æµ‹åœºæ™¯

```
å·¥å…·ï¼šJMeter
å¹¶å‘ç”¨æˆ·ï¼š100ä¸‡
æŒç»­æ—¶é—´ï¼š10ç§’
ç›®æ ‡QPSï¼š10ä¸‡/ç§’
```

### æµ‹è¯•ç»“æœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|-----|--------|--------|------|
| **å³°å€¼QPS** | 5K | 10ä¸‡ | **20å€** |
| **å¹³å‡å“åº”æ—¶é—´** | 5000ms | 150ms | **33å€** |
| **P95å“åº”æ—¶é—´** | 10000ms | 300ms | **33å€** |
| **æˆåŠŸç‡** | 60% | 99.9% | **1.6å€** |
| **æ•°æ®åº“QPS** | 5K | 10 | **500å€é™ä½** |
| **è¶…å–æ¬¡æ•°** | 23æ¬¡ | 0æ¬¡ | âœ… |

---

## æˆæœ¬åˆ†æ

### èµ„æºé…ç½®

| èµ„æº | æ•°é‡ | è§„æ ¼ | æˆæœ¬/å°æ—¶ | ç§’æ€æ—¶é•¿ | æ€»æˆæœ¬ |
|-----|------|------|----------|---------|--------|
| **Nginx** | 10å° | 4æ ¸8G | $0.2 | 1å°æ—¶ | $2 |
| **ç§’æ€æœåŠ¡** | 50å° | 8æ ¸16G | $0.4 | 1å°æ—¶ | $20 |
| **Redis Cluster** | 6èŠ‚ç‚¹ | 16æ ¸32G | $1 | 1å°æ—¶ | $6 |
| **Kafka** | 3èŠ‚ç‚¹ | 8æ ¸16G | $0.4 | 1å°æ—¶ | $1.2 |
| **æ•°æ®åº“** | ä¸»ä» | 16æ ¸64G | $2 | 24å°æ—¶ | $48 |
| **å¸¦å®½** | 1Gbps | - | $10 | 1å°æ—¶ | $10 |
| **æ€»è®¡** | - | - | - | - | **$87.2** |

**ROI**ï¼š

```
ç§’æ€å•†å“ï¼š100ä»¶ Ã— $1000åˆ©æ¶¦ = $100K
ç³»ç»Ÿæˆæœ¬ï¼š$87.2
ROIï¼š1150å€
```

---

## å…³é”®æ´å¯Ÿ

### æ´å¯Ÿ 1ï¼šæ‹¦æˆªåœ¨å‰ï¼Œå¤„ç†åœ¨å

```
100ä¸‡è¯·æ±‚ï¼š
- 90%æ‹¦æˆªåœ¨CDNï¼ˆé™æ€èµ„æºï¼‰
- 9%æ‹¦æˆªåœ¨Nginxï¼ˆé™æµï¼‰
- 0.9%æ‹¦æˆªåœ¨Redisï¼ˆåº“å­˜æ£€æŸ¥ï¼‰
- 0.01%çœŸæ­£å¤„ç†ï¼ˆ100ä¸ªè®¢å•ï¼‰

æ¼æ–—æ•ˆåº”ï¼šå‡è½»åç«¯å‹åŠ›
```

### æ´å¯Ÿ 2ï¼šç©ºé—´æ¢æ—¶é—´

```
Redisé¢„æ‰£åº“å­˜ï¼š
- å†…å­˜æ“ä½œï¼ˆçº³ç§’çº§ï¼‰
- åŸå­æ“ä½œï¼ˆæ— å¹¶å‘é—®é¢˜ï¼‰
- æœ€ç»ˆä¸€è‡´æ€§ï¼ˆå¼‚æ­¥åŒæ­¥åˆ°æ•°æ®åº“ï¼‰

æƒè¡¡ï¼š
- æˆæœ¬å¢åŠ ï¼šRediså†…å­˜
- æ€§èƒ½æå‡ï¼š1000å€
```

### æ´å¯Ÿ 3ï¼šå¼‚æ­¥å‰Šå³°

```
åŒæ­¥å¤„ç†ï¼š
100ä¸‡è¯·æ±‚ â†’ æ•°æ®åº“å†™å…¥ â†’ æ•°æ®åº“å´©æºƒ

å¼‚æ­¥å¤„ç†ï¼š
100ä¸‡è¯·æ±‚ â†’ é¢„ç­›é€‰ â†’ 100ä¸ªæ¶ˆæ¯ â†’ æ…¢æ…¢å†™å…¥

å…³é”®ï¼šç”¨æˆ·ä¸éœ€è¦ç«‹å³çœ‹åˆ°è®¢å•ï¼Œå¯ä»¥å¼‚æ­¥é€šçŸ¥
```

---

## ç›¸å…³ä¸»é¢˜

- [09.3 æ–­è·¯å™¨ä¸å¼¹æ€§è®¾è®¡](./09.3_Circuit_Breaker_Resilience.md)
- [05.1 é…ç½®ç®¡ç†ä¸è‡ªåŠ¨æ‰©ç¼©å®¹](../05_Configuration_Scaling/05.1_Configuration_Management_Landscape.md)

---

---

## é™„å½•ï¼šå‹æµ‹è„šæœ¬

**JMeteræµ‹è¯•è®¡åˆ’**ï¼š

```xml
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2">
  <hashTree>
    <TestPlan>
      <stringProp name="TestPlan.comments">ç§’æ€å‹æµ‹</stringProp>
      <boolProp name="TestPlan.functional_mode">false</boolProp>
      <boolProp name="TestPlan.serialize_threadgroups">false</boolProp>
    </TestPlan>
    <hashTree>
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup">
        <stringProp name="ThreadGroup.num_threads">10000</stringProp>
        <stringProp name="ThreadGroup.ramp_time">1</stringProp>
        <longProp name="ThreadGroup.duration">10</longProp>
      </ThreadGroup>
      <hashTree>
        <HTTPSamplerProxy>
          <stringProp name="HTTPSampler.domain">api.example.com</stringProp>
          <stringProp name="HTTPSampler.path">/seckill/purchase</stringProp>
          <stringProp name="HTTPSampler.method">POST</stringProp>
          <boolProp name="HTTPSampler.use_keepalive">true</boolProp>
        </HTTPSamplerProxy>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```
