# 07.4 分布式系统

> **来源**: view07.md

## 📋 内容概览

本文档从形式科学视角分析分布式系统，包括共识算法、一致性模型等。

## 🔐 共识算法

### 基本问题

**共识问题**：多个节点就某个值达成一致

**挑战**：

- **网络分区**：网络可能分区
- **节点故障**：节点可能故障
- **消息丢失**：消息可能丢失

### Raft算法

**状态**：

- **Leader**：领导者
- **Follower**：跟随者
- **Candidate**：候选者

**动力学**：

```
P(Leader=i) ∝ votes_i / total_votes
votes_i = exp(β·uptime_i)  (β=可靠性权重)
```

**临界现象**：脑裂

**参数**：网络分区时间 Δt，心跳间隔 T_heartbeat

**分岔**：当 Δt > T_heartbeat·log(N)，**多数派消失** → 两个Leader共存

### Paxos算法

**阶段**：

1. **Prepare阶段**：提议者发送prepare请求
2. **Accept阶段**：提议者发送accept请求

**保证**：

- **安全性**：不会选择错误的值
- **活性**：最终会达成一致

## 🔄 一致性模型

### 强一致性

**定义**：所有节点看到相同的数据

**实现**：

- **两阶段提交**：2PC
- **三阶段提交**：3PC
- **Paxos/Raft**：共识算法

### 弱一致性

**定义**：允许节点看到不同的数据

**类型**：

- **最终一致性**：最终会一致
- **因果一致性**：保持因果关系
- **会话一致性**：会话内一致

### CAP定理

**内容**：在分布式系统中，一致性（Consistency）、可用性（Availability）、分区容错性（Partition tolerance）三者不能同时满足

**选择**：

- **CP系统**：一致性 + 分区容错（如etcd）
- **AP系统**：可用性 + 分区容错（如DynamoDB）
- **CA系统**：一致性 + 可用性（单机系统）

## 📊 分布式事务

### 两阶段提交（2PC）

**阶段1：准备阶段**

- 协调者发送prepare请求
- 参与者准备事务

**阶段2：提交阶段**

- 协调者发送commit/abort请求
- 参与者提交/回滚事务

**问题**：

- **阻塞**：协调者故障导致阻塞
- **性能**：两轮通信延迟

### 三阶段提交（3PC）

**改进**：

- 添加超时机制
- 减少阻塞

**阶段**：

1. **CanCommit**：询问是否可以提交
2. **PreCommit**：准备提交
3. **DoCommit**：执行提交

### Saga模式

**原理**：将长事务分解为多个短事务

**类型**：

- **编排式**：中央协调器
- **协同式**：事件驱动

## 🔗 分布式系统模式

### 模式1：主从模式

**结构**：一个主节点，多个从节点

**特点**：

- **简单**：实现简单
- **单点故障**：主节点故障影响大

### 模式2：对等模式

**结构**：所有节点平等

**特点**：

- **无单点故障**：无单点故障
- **复杂**：实现复杂

### 模式3：分片模式

**结构**：数据分片存储

**特点**：

- **可扩展**：易于扩展
- **复杂性**：分片管理复杂

## 🎯 分布式系统挑战

### 挑战1：网络延迟

**问题**：网络延迟影响性能

**解决**：

- **本地缓存**：使用本地缓存
- **异步处理**：异步处理
- **批量操作**：批量操作

### 挑战2：数据一致性

**问题**：保证数据一致性困难

**解决**：

- **共识算法**：使用共识算法
- **版本控制**：版本控制
- **冲突解决**：冲突解决策略

### 挑战3：故障处理

**问题**：节点故障处理

**解决**：

- **冗余**：数据冗余
- **故障检测**：故障检测
- **自动恢复**：自动恢复

## 🔗 相关文档

- [07.1_Kubernetes动力学.md](07.1_Kubernetes动力学.md)
- [07.2_EKS系统分析.md](07.2_EKS系统分析.md)
- [07.3_微服务架构.md](07.3_微服务架构.md)

## 📖 扩展阅读

- 《Designing Data-Intensive Applications》- Martin Kleppmann
- Wikipedia: [Distributed Computing](https://en.wikipedia.org/wiki/Distributed_computing)
