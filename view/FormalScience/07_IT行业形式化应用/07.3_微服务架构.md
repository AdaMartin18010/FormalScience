# 07.3 å¾®æœåŠ¡æ¶æ„

> **æ¥æº**: view07.md

## ğŸ“‹ å†…å®¹æ¦‚è§ˆ

æœ¬æ–‡æ¡£ä»åŠ¨åŠ›å­¦ç³»ç»Ÿè§†è§’åˆ†æå¾®æœåŠ¡æ¶æ„ï¼Œæ­ç¤ºå…¶èƒŒåçš„æ•°å­¦ç»“æ„ã€‚

## ğŸŒ æœåŠ¡ç½‘æ ¼åŠ¨åŠ›å­¦

### çŠ¶æ€å˜é‡

- **æœåŠ¡é—´æµé‡** Qáµ¢â±¼(t) (iâ†’jçš„è¯·æ±‚æ•°/ç§’)
- **å»¶è¿Ÿåœº** Ï„áµ¢â±¼(t)
- **é”™è¯¯ç‡** Îµáµ¢(t)

### åŠ¨åŠ›å­¦ï¼šLattice Boltzmannæ–¹ç¨‹

```
Qáµ¢â±¼(t+Î”t) = Qáµ¢â±¼(t) - (1/Ï„)Â·(Qáµ¢â±¼ - Qáµ¢â±¼^eq) + Forceáµ¢â±¼
Qáµ¢â±¼^eq = wáµ¢â±¼Â·Ïáµ¢Â·(1 + váµ¢Â·u/câ‚›Â²)  (å¹³è¡¡æ€åˆ†å¸ƒ)
```

- Ïáµ¢ = æœåŠ¡içš„è´Ÿè½½å¯†åº¦
- váµ¢ = æœåŠ¡içš„æµå‘é‡ï¼ˆè°ƒç”¨é“¾ï¼‰
- **Forceáµ¢â±¼ = ç†”æ–­å™¨ + é™æµå™¨ + é‡è¯•ç­–ç•¥**

### ä¸è¡€æ¶²åŠ¨åŠ›å­¦åŒæ„

- **Qáµ¢â±¼** = è¡€æµé€Ÿ
- **Ï„áµ¢â±¼** = è¡€ç®¡é˜»åŠ›
- **Îµáµ¢** = è¡€æ “æ¦‚ç‡
- **Istio** = **å¿ƒè„èµ·æå™¨ + æŠ—å‡å‰‚**

### ä¸´ç•Œç°è±¡ï¼šçº§è”è¶…æ—¶

**å‚æ•°**ï¼šæœåŠ¡è°ƒç”¨æ·±åº¦ Lï¼Œè¶…æ—¶é˜ˆå€¼ T

**åˆ†å²”**ï¼šå½“ LÂ·mean(Ï„) > Tï¼Œç³»ç»Ÿè¿›å…¥**è¶…æ—¶é£æš´**ï¼ˆ**æ­£åé¦ˆå¾ªç¯**ï¼‰ï¼š

```
è¶…æ—¶ â†’ é‡è¯• â†’ è´Ÿè½½â†‘ â†’ å»¶è¿Ÿâ†‘ â†’ æ›´å¤šè¶…æ—¶
```

**é¢„æµ‹**ï¼šå¾®æœåŠ¡è°ƒç”¨é“¾>7å±‚ï¼Œé‡è¯•3æ¬¡ï¼Œè¶…æ—¶1ç§’ â†’ **ç³»ç»Ÿå¯ç”¨æ€§<50%**

## ğŸ”„ åˆ†å¸ƒå¼ç³»ç»Ÿå…±è¯†

### çŠ¶æ€å˜é‡

- **èŠ‚ç‚¹çŠ¶æ€** sáµ¢ âˆˆ {Leader, Follower, Candidate}
- **æ—¥å¿—æ¡ç›®** Láµ¢(t) = [term, index, command]
- **æäº¤æŒ‡é’ˆ** commit_idx(t)

### åŠ¨åŠ›å­¦ï¼šéšæœºæ³¢åˆ©äºšç“®æ¨¡å‹ï¼ˆPÃ³lya's Urnï¼‰

```
P(Leader=i) âˆ votes_i / total_votes
votes_i = exp(Î²Â·uptime_i)  (Î²=å¯é æ€§æƒé‡)
```

### ä¸é€‰ä¸¾åŠ¨åŠ›å­¦åŒæ„

uptime=å£°æœ›ï¼Œvote=æ°‘æ„ï¼ŒLeader=æ‰§æ”¿è”ç›Ÿ

### ä¸´ç•Œç°è±¡ï¼šè„‘è£‚

**å‚æ•°**ï¼šç½‘ç»œåˆ†åŒºæ—¶é—´ Î”tï¼Œå¿ƒè·³é—´éš” T_heartbeat

**åˆ†å²”**ï¼šå½“ Î”t > T_heartbeatÂ·log(N)ï¼Œ**å¤šæ•°æ´¾æ¶ˆå¤±** â†’ ä¸¤ä¸ªLeaderå…±å­˜ï¼ˆ**åºå‚é‡=0**ï¼‰

**é¢„æµ‹**ï¼šè·¨Region etcdé›†ç¾¤å½“å»¶è¿Ÿ>500msï¼Œ**è„‘è£‚æ¦‚ç‡>50%**

## ğŸ›¡ï¸ ç†”æ–­å™¨ä¸é™æµå™¨

### ç†”æ–­å™¨åŠ¨åŠ›å­¦

**çŠ¶æ€**ï¼šç†”æ–­å™¨çŠ¶æ€ âˆˆ {Closed, Open, Half-Open}

**åŠ¨åŠ›å­¦**ï¼š

```
if (error_rate > threshold):
    state = Open
    wait(cooldown)
    state = Half-Open
    if (test_request_success):
        state = Closed
```

### ä¸ç”µè·¯ä¿æŠ¤åŒæ„

- **ç†”æ–­å™¨** = ç”µè·¯æ–­è·¯å™¨
- **é”™è¯¯ç‡** = ç”µæµ
- **é˜ˆå€¼** = ç†”æ–­ç”µæµ
- **å†·å´æœŸ** = æ¢å¤æ—¶é—´

### é™æµå™¨åŠ¨åŠ›å­¦

**ç®—æ³•**ï¼šä»¤ç‰Œæ¡¶ï¼ˆToken Bucketï¼‰

**çŠ¶æ€**ï¼š

- **ä»¤ç‰Œæ•°** T(t)
- **æ¡¶å®¹é‡** C
- **å¡«å……é€Ÿç‡** r

**åŠ¨åŠ›å­¦**ï¼š

```
dT/dt = r - Î»Â·I(T>0)  (Î»=è¯·æ±‚é€Ÿç‡)
```

### ä¸´ç•Œç°è±¡ï¼šé™æµå¤±æ•ˆ

**å‚æ•°**ï¼šè¯·æ±‚çªå‘ç‡ Î»_burst

**åˆ†å²”**ï¼šå½“ Î»_burst > CÂ·rï¼Œä»¤ç‰Œæ¡¶ç¬é—´è€—å°½ â†’ **é™æµå¤±æ•ˆ**

**é¢„æµ‹**ï¼šå½“çªå‘è¯·æ±‚>æ¡¶å®¹é‡ï¼Œé™æµå™¨æ— æ³•ä¿æŠ¤åç«¯æœåŠ¡

## ğŸ” æœåŠ¡å‘ç°ä¸æ³¨å†Œ

### çŠ¶æ€å˜é‡

- **æœåŠ¡æ³¨å†Œè¡¨** R(t) = {serviceâ‚, serviceâ‚‚, ...}
- **æœåŠ¡å¥åº·çŠ¶æ€** Háµ¢(t) âˆˆ {Healthy, Unhealthy}
- **æœåŠ¡å®ä¾‹æ•°** Náµ¢(t)

### åŠ¨åŠ›å­¦ï¼šä¸»æ–¹ç¨‹

```
dNáµ¢/dt = Î»_register - Î¼_deregister - Î»_failureÂ·Náµ¢
```

- Î»_register = æ³¨å†Œé€Ÿç‡
- Î¼_deregister = æ³¨é”€é€Ÿç‡
- Î»_failure = æ•…éšœç‡

### ä¸´ç•Œç°è±¡ï¼šæ³¨å†Œè¡¨è¿‡è½½

**å‚æ•°**ï¼šæœåŠ¡æ•°é‡ Nï¼Œå¿ƒè·³é¢‘ç‡ f

**åˆ†å²”**ï¼šå½“ NÂ·f > å¤„ç†èƒ½åŠ›ï¼Œæ³¨å†Œè¡¨æˆä¸ºç“¶é¢ˆ â†’ **æœåŠ¡å‘ç°å»¶è¿Ÿæ¿€å¢**

**é¢„æµ‹**ï¼šå½“æœåŠ¡æ•°>1000ï¼Œå¿ƒè·³é—´éš”<10ç§’ï¼Œæ³¨å†Œè¡¨CPUä½¿ç”¨ç‡>90%

## ğŸ“Š å¾®æœåŠ¡æ¶æ„å¥åº·åº¦æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | åŠ¨åŠ›å­¦æ„ä¹‰ | ä¸´ç•Œå€¼ | ç›‘æ§æ–¹æ³• |
|------|------------|--------|----------|
| **æœåŠ¡è°ƒç”¨æ·±åº¦** | ç³»ç»Ÿå¤æ‚åº¦ | L > 7 | åˆ†å¸ƒå¼è¿½è¸ª |
| **å¹³å‡å»¶è¿Ÿ** | ç³»ç»Ÿå“åº”æ€§ | Ï„ > 1s | APMå·¥å…· |
| **é”™è¯¯ç‡** | ç³»ç»Ÿç¨³å®šæ€§ | Îµ > 1% | æ—¥å¿—åˆ†æ |
| **æœåŠ¡å®ä¾‹æ•°** | ç³»ç»Ÿè§„æ¨¡ | N > 100 | æœåŠ¡æ³¨å†Œè¡¨ |
| **ç½‘ç»œåˆ†åŒºæ¦‚ç‡** | ç³»ç»Ÿå¯é æ€§ | p > 0.1% | ç½‘ç»œç›‘æ§ |

### ç›¸ç©ºé—´ç›‘æ§

**çŠ¶æ€ç©ºé—´**ï¼š(L, Ï„, Îµ, N, p)

**å¥åº·åŒºåŸŸ**ï¼š

- L < 5
- Ï„ < 500ms
- Îµ < 0.1%
- N < 50
- p < 0.01%

**å±é™©åŒºåŸŸ**ï¼š

- L > 7
- Ï„ > 1s
- Îµ > 1%
- N > 100
- p > 0.1%

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [07.1_KubernetesåŠ¨åŠ›å­¦.md](07.1_KubernetesåŠ¨åŠ›å­¦.md)
- [07.2_EKSç³»ç»Ÿåˆ†æ.md](07.2_EKSç³»ç»Ÿåˆ†æ.md)
- [07.4_åˆ†å¸ƒå¼ç³»ç»Ÿ.md](07.4_åˆ†å¸ƒå¼ç³»ç»Ÿ.md)

## ğŸ“– æ‰©å±•é˜…è¯»

- ã€Šå¾®æœåŠ¡æ¶æ„è®¾è®¡æ¨¡å¼ã€‹- Chris Richardson
- ã€ŠBuilding Microservicesã€‹- Sam Newman
