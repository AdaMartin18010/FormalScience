# Rust 2024 å¤šçº¿ç¨‹ç¼–ç¨‹

åœ¨ Rust 2024 ç‰ˆæœ¬ä¸­ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹çš„æ ¸å¿ƒæœºåˆ¶åŒ…æ‹¬çº¿ç¨‹åˆ›å»ºã€é€šä¿¡å’ŒåŒæ­¥ã€‚
è¿™äº›æœºåˆ¶ä½¿å¾— Rust èƒ½å¤Ÿé«˜æ•ˆã€å®‰å…¨åœ°è¿›è¡Œå¹¶å‘ç¼–ç¨‹ã€‚ä»¥ä¸‹æ˜¯è¿™äº›æœºåˆ¶çš„æ ¸å¿ƒå®šä¹‰ã€æ¦‚å¿µã€è§£é‡Šã€ç¤ºä¾‹å’Œç»¼åˆåº”ç”¨ã€‚

## ğŸ“‹ ç›®å½•

- [1 æ ¸å¿ƒå®šä¹‰ä¸æ¦‚å¿µ](#1-æ ¸å¿ƒå®šä¹‰ä¸æ¦‚å¿µ)
  - [1.1 ç¤ºä¾‹ä¸è§£é‡Š](#11-ç¤ºä¾‹ä¸è§£é‡Š)
    - [1.1.1 çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†](#111-çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†)
    - [1.1.2 çº¿ç¨‹é—´é€šä¿¡](#112-çº¿ç¨‹é—´é€šä¿¡)
    - [1.1.3 çº¿ç¨‹åŒæ­¥](#113-çº¿ç¨‹åŒæ­¥)
- [2 ç»¼åˆåº”ç”¨](#2-ç»¼åˆåº”ç”¨)
  - [2.1 æ€ç»´å¯¼å›¾](#21-æ€ç»´å¯¼å›¾)
- [3 æ€»ç»“](#3-æ€»ç»“)
- [4 è¯¦ç»†è§£é‡Š](#4-è¯¦ç»†è§£é‡Š)
  - [4.1 çº¿ç¨‹æœ¬åœ°å­˜å‚¨Thread Local Storage](#41-çº¿ç¨‹æœ¬åœ°å­˜å‚¨thread-local-storage)
  - [4.2 å¤šçº¿ç¨‹é€€å‡ºä¸ä¸»çº¿ç¨‹é€€å‡º](#42-å¤šçº¿ç¨‹é€€å‡ºä¸ä¸»çº¿ç¨‹é€€å‡º)
  - [4.3 åŒæ­¥æœºåˆ¶](#43-åŒæ­¥æœºåˆ¶)
  - [4.4 é€šä¿¡æœºåˆ¶](#44-é€šä¿¡æœºåˆ¶)
  - [4.5 åŸå­é”ç±»å‹](#45-åŸå­é”ç±»å‹)
  - [4.6 åŸå­é”è®¿é—®é¡ºåº](#46-åŸå­é”è®¿é—®é¡ºåº)
  - [4.7 ç»¼åˆåº”ç”¨](#47-ç»¼åˆåº”ç”¨)
  - [4.8 æ€ç»´å¯¼å›¾](#48-æ€ç»´å¯¼å›¾)
  - [4.9 æ€»ç»“](#49-æ€»ç»“)
  - [4.10 10 1 çº¿ç¨‹æœ¬åœ°å­˜å‚¨Thread Local Storage](#410-10-1-çº¿ç¨‹æœ¬åœ°å­˜å‚¨thread-local-storage)
  - [4.11 11 2 å¤šçº¿ç¨‹é€€å‡ºä¸ä¸»çº¿ç¨‹é€€å‡º](#411-11-2-å¤šçº¿ç¨‹é€€å‡ºä¸ä¸»çº¿ç¨‹é€€å‡º)
  - [4.12 12 3 åŒæ­¥æœºåˆ¶](#412-12-3-åŒæ­¥æœºåˆ¶)
  - [4.13 13 4 é€šä¿¡æœºåˆ¶](#413-13-4-é€šä¿¡æœºåˆ¶)
  - [4.14 14 5 åŸå­é”ç±»å‹](#414-14-5-åŸå­é”ç±»å‹)
  - [4.15 15 6 åŸå­é”è®¿é—®é¡ºåº](#415-15-6-åŸå­é”è®¿é—®é¡ºåº)
  - [4.16 ç»¼åˆåº”ç”¨](#416-ç»¼åˆåº”ç”¨)
  - [4.17 æ€ç»´å¯¼å›¾](#417-æ€ç»´å¯¼å›¾)
  - [4.18 æ€»ç»“](#418-æ€»ç»“)
  - [4.19 æ ¸å¿ƒæ¦‚å¿µ](#419-æ ¸å¿ƒæ¦‚å¿µ)
  - [4.20 å®ç°æ­¥éª¤](#420-å®ç°æ­¥éª¤)
  - [4.21 ç¤ºä¾‹ä»£ç ](#421-ç¤ºä¾‹ä»£ç )
  - [4.22 è§£é‡Š](#422-è§£é‡Š)
  - [4.23 ç»„åˆå¼çº¿ç¨‹åˆ›å»ºå’Œçº§è”é€€å‡ºçš„ä¼˜ç‚¹](#423-ç»„åˆå¼çº¿ç¨‹åˆ›å»ºå’Œçº§è”é€€å‡ºçš„ä¼˜ç‚¹)
  - [4.24 æ€»ç»“](#424-æ€»ç»“)

---

## 1 æ ¸å¿ƒå®šä¹‰ä¸æ¦‚å¿µ

1. **çº¿ç¨‹ï¼ˆThreadï¼‰**
   - **å®šä¹‰**: çº¿ç¨‹æ˜¯æ“ä½œç³»ç»Ÿèƒ½å¤Ÿç‹¬ç«‹è°ƒåº¦çš„æœ€å°å•ä½ã€‚
   - **Rust å®ç°**: ä½¿ç”¨ `std::thread` æ¨¡å—åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹ã€‚

2. **é€šä¿¡ï¼ˆCommunicationï¼‰**
   - **å®šä¹‰**: çº¿ç¨‹ä¹‹é—´çš„æ•°æ®äº¤æ¢ã€‚
   - **Rust å®ç°**: ä½¿ç”¨ `std::sync::mpsc` æ¨¡å—æä¾›çš„é€šé“ï¼ˆchannelï¼‰è¿›è¡Œçº¿ç¨‹é—´é€šä¿¡ã€‚

3. **åŒæ­¥ï¼ˆSynchronizationï¼‰**
   - **å®šä¹‰**: æ§åˆ¶çº¿ç¨‹å¯¹å…±äº«èµ„æºçš„è®¿é—®ã€‚
   - **Rust å®ç°**: ä½¿ç”¨ `Mutex`ã€`RwLock` ç­‰åŒæ­¥åŸè¯­ã€‚

### 1.1 ç¤ºä¾‹ä¸è§£é‡Š

#### 1.1.1 çº¿ç¨‹åˆ›å»ºä¸ç®¡ç†

```rust
use std::thread;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!("Hello from the spawned thread: {}", i);
            thread::sleep(std::time::Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!("Hello from the main thread: {}", i);
        thread::sleep(std::time::Duration::from_millis(1));
    }

    handle.join().unwrap();
}
```

- **è§£é‡Š**: ä½¿ç”¨ `thread::spawn` åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹ï¼Œ`join` æ–¹æ³•ç”¨äºç­‰å¾…çº¿ç¨‹å®Œæˆã€‚

#### 1.1.2 çº¿ç¨‹é—´é€šä¿¡

```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let val = String::from("Hello");
        tx.send(val).unwrap();
    });

    let received = rx.recv().unwrap();
    println!("Received: {}", received);
}
```

- **è§£é‡Š**: ä½¿ç”¨ `mpsc::channel` åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œ`tx` æ˜¯å‘é€ç«¯ï¼Œ`rx` æ˜¯æ¥æ”¶ç«¯ã€‚`send` æ–¹æ³•ç”¨äºå‘é€æ•°æ®ï¼Œ`recv` æ–¹æ³•ç”¨äºæ¥æ”¶æ•°æ®ã€‚

#### 1.1.3 çº¿ç¨‹åŒæ­¥

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

- **è§£é‡Š**: ä½¿ç”¨ `Mutex` ä¿æŠ¤å…±äº«æ•°æ®ï¼Œ`Arc` ç”¨äºåœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ‰€æœ‰æƒã€‚`lock` æ–¹æ³•ç”¨äºè·å–é”ã€‚

## 2 ç»¼åˆåº”ç”¨

åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRust çš„å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥ç”¨äºæ„å»ºé«˜æ•ˆçš„å¹¶å‘ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„å¹¶å‘ Web æœåŠ¡å™¨ï¼š

```rust
use std::net::{TcpListener, TcpStream};
use std::io::{Read, Write};
use std::thread;
use std::sync::{Arc, Mutex};

fn handle_client(mut stream: TcpStream, counter: Arc<Mutex<u32>>) {
    let mut buffer = [0; 512];
    stream.read(&mut buffer).unwrap();
    let response = b"HTTP/1.1 200 OK\r\n\r\nHello, World!";
    stream.write(response).unwrap();
    stream.flush().unwrap();

    let mut num = counter.lock().unwrap();
    *num += 1;
    println!("Handled {} requests", *num);
}

fn main() {
    let listener = TcpListener::bind("127.0.0.1:7878").unwrap();
    let counter = Arc::new(Mutex::new(0));

    for stream in listener.incoming() {
        let stream = stream.unwrap();
        let counter = Arc::clone(&counter);
        thread::spawn(move || {
            handle_client(stream, counter);
        });
    }
}
```

- **è§£é‡Š**: è¿™ä¸ªç®€å•çš„ Web æœåŠ¡å™¨ä½¿ç”¨ `TcpListener` æ¥å—è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥ç”±ä¸€ä¸ªæ–°çº¿ç¨‹å¤„ç†ã€‚ä½¿ç”¨ `Arc<Mutex<u32>>` è®¡æ•°å¤„ç†çš„è¯·æ±‚æ•°ã€‚

### 2.1 æ€ç»´å¯¼å›¾

```text
Rust 2024 å¤šçº¿ç¨‹æœºåˆ¶
â”œâ”€â”€ çº¿ç¨‹
â”‚   â”œâ”€â”€ åˆ›å»º
â”‚   â””â”€â”€ ç®¡ç†
â”œâ”€â”€ é€šä¿¡
â”‚   â”œâ”€â”€ é€šé“
â”‚   â””â”€â”€ å‘é€/æ¥æ”¶
â””â”€â”€ åŒæ­¥
    â”œâ”€â”€ Mutex
    â”œâ”€â”€ RwLock
    â””â”€â”€ Arc
```

## 3 æ€»ç»“

Rust 2024 çš„å¤šçº¿ç¨‹æœºåˆ¶æä¾›äº†å¼ºå¤§çš„å·¥å…·æ¥æ„å»ºé«˜æ•ˆã€å®‰å…¨çš„å¹¶å‘ç¨‹åºã€‚é€šè¿‡çº¿ç¨‹ã€é€šä¿¡å’ŒåŒæ­¥çš„ç»„åˆï¼Œå¼€å‘è€…å¯ä»¥å®ç°å¤æ‚çš„å¹¶å‘é€»è¾‘ï¼ŒåŒæ—¶ä¿æŒå†…å­˜å®‰å…¨å’Œæ•°æ®ä¸€è‡´æ€§ã€‚
Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨ç³»ç»Ÿåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­æä¾›äº†é¢å¤–çš„å®‰å…¨ä¿éšœï¼Œé˜²æ­¢æ•°æ®ç«äº‰å’Œå…¶ä»–å¸¸è§çš„å¹¶å‘é”™è¯¯ã€‚

## 4 è¯¦ç»†è§£é‡Š

åœ¨ Rust 2024 ç‰ˆæœ¬ä¸­ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹æ¶‰åŠå¤šä¸ªæ ¸å¿ƒæ¦‚å¿µå’Œæœºåˆ¶ã€‚
ä»¥ä¸‹æ˜¯å¯¹è¿™äº›æ¦‚å¿µçš„è¯¦ç»†è§£é‡Šå’Œç¤ºä¾‹ï¼ŒåŒ…æ‹¬çº¿ç¨‹æœ¬åœ°å­˜å‚¨ã€çº¿ç¨‹é€€å‡ºã€åŒæ­¥æœºåˆ¶ã€é€šä¿¡æœºåˆ¶ã€åŸå­é”ç±»å‹å’Œè®¿é—®é¡ºåºç­‰ã€‚

### 4.1 çº¿ç¨‹æœ¬åœ°å­˜å‚¨Thread Local Storage

**å®šä¹‰**: çº¿ç¨‹æœ¬åœ°å­˜å‚¨å…è®¸æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ç‹¬ç«‹æ•°æ®å‰¯æœ¬ã€‚

**ç¤ºä¾‹**:

```rust
use std::thread;
use std::cell::RefCell;

thread_local! {
    static THREAD_LOCAL_DATA: RefCell<u32> = RefCell::new(0);
}

fn main() {
    let handles: Vec<_> = (0..5).map(|i| {
        thread::spawn(move || {
            THREAD_LOCAL_DATA.with(|data| {
                *data.borrow_mut() = i;
                println!("Thread {}: {}", i, *data.borrow());
            });
        })
    }).collect();

    for handle in handles {
        handle.join().unwrap();
    }
}
```

**è§£é‡Š**: ä½¿ç”¨ `thread_local!` å®å®šä¹‰çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹ä¿®æ”¹å…¶å€¼ã€‚

### 4.2 å¤šçº¿ç¨‹é€€å‡ºä¸ä¸»çº¿ç¨‹é€€å‡º

**å®šä¹‰**: Rust ä¸­ï¼Œä¸»çº¿ç¨‹ä¼šç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆåæ‰ä¼šé€€å‡ºï¼Œé™¤éä½¿ç”¨ `std::process::exit` å¼ºåˆ¶é€€å‡ºã€‚

**ç¤ºä¾‹**:

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!("Spawned thread: {}", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!("Main thread: {}", i);
        thread::sleep(Duration::from_millis(1));
    }

    handle.join().unwrap();
}
```

**è§£é‡Š**: ä¸»çº¿ç¨‹åœ¨ `handle.join()` å¤„ç­‰å¾…å­çº¿ç¨‹å®Œæˆã€‚

### 4.3 åŒæ­¥æœºåˆ¶

**å®šä¹‰**: åŒæ­¥æœºåˆ¶ç”¨äºæ§åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œé˜²æ­¢æ•°æ®ç«äº‰ã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

**è§£é‡Š**: ä½¿ç”¨ `Mutex` ä¿æŠ¤å…±äº«æ•°æ®ï¼Œ`Arc` ç”¨äºåœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ‰€æœ‰æƒã€‚

### 4.4 é€šä¿¡æœºåˆ¶

**å®šä¹‰**: é€šä¿¡æœºåˆ¶ç”¨äºåœ¨çº¿ç¨‹é—´ä¼ é€’æ•°æ®ã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let val = String::from("Hello");
        tx.send(val).unwrap();
    });

    let received = rx.recv().unwrap();
    println!("Received: {}", received);
}
```

**è§£é‡Š**: ä½¿ç”¨ `mpsc::channel` åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œ`tx` æ˜¯å‘é€ç«¯ï¼Œ`rx` æ˜¯æ¥æ”¶ç«¯ã€‚

### 4.5 åŸå­é”ç±»å‹

**å®šä¹‰**: åŸå­ç±»å‹æä¾›äº†æ— éœ€é”çš„çº¿ç¨‹å®‰å…¨æ“ä½œã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::atomic::{AtomicUsize, Ordering};
use std::thread;

fn main() {
    let counter = AtomicUsize::new(0);
    let mut handles = vec![];

    for _ in 0..10 {
        let handle = thread::spawn({
            let counter = &counter;
            move || {
                for _ in 0..1000 {
                    counter.fetch_add(1, Ordering::SeqCst);
                }
            }
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", counter.load(Ordering::SeqCst));
}
```

**è§£é‡Š**: ä½¿ç”¨ `AtomicUsize` è¿›è¡ŒåŸå­æ“ä½œï¼Œ`Ordering::SeqCst` ç¡®ä¿æ“ä½œçš„é¡ºåºæ€§ã€‚

### 4.6 åŸå­é”è®¿é—®é¡ºåº

**å®šä¹‰**: åŸå­æ“ä½œçš„é¡ºåºæ€§ç”± `Ordering` æšä¸¾æ§åˆ¶ï¼Œå¸¸ç”¨çš„æœ‰ `Relaxed`ã€`Acquire`ã€`Release` å’Œ `SeqCst`ã€‚

- **Relaxed**: ä¸ä¿è¯é¡ºåºï¼Œä»…ä¿è¯åŸå­æ€§ã€‚
- **Acquire/Release**: ç”¨äºå®ç°é”çš„è·å–å’Œé‡Šæ”¾ã€‚
- **SeqCst**: æä¾›å…¨å±€é¡ºåºä¸€è‡´æ€§ã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::atomic::{AtomicBool, Ordering};
use std::thread;

fn main() {
    let flag = AtomicBool::new(false);

    let handle = thread::spawn({
        let flag = &flag;
        move || {
            flag.store(true, Ordering::Release);
        }
    });

    while !flag.load(Ordering::Acquire) {
        // ç­‰å¾… flag è¢«è®¾ç½®ä¸º true
    }

    handle.join().unwrap();
    println!("Flag was set!");
}
```

**è§£é‡Š**: ä½¿ç”¨ `Ordering::Release` å’Œ `Ordering::Acquire` å®ç°ç®€å•çš„åŒæ­¥ã€‚

### 4.7 ç»¼åˆåº”ç”¨

åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRust çš„å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥ç”¨äºæ„å»ºé«˜æ•ˆçš„å¹¶å‘ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„å¹¶å‘è®¡æ•°å™¨ï¼š

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

### 4.8 æ€ç»´å¯¼å›¾

```text
Rust 2024 å¤šçº¿ç¨‹æœºåˆ¶
â”œâ”€â”€ çº¿ç¨‹
â”‚   â”œâ”€â”€ åˆ›å»º
â”‚   â”œâ”€â”€ ç®¡ç†
â”‚   â””â”€â”€ é€€å‡º
â”œâ”€â”€ é€šä¿¡
â”‚   â”œâ”€â”€ é€šé“
â”‚   â””â”€â”€ å‘é€/æ¥æ”¶
â”œâ”€â”€ åŒæ­¥
â”‚   â”œâ”€â”€ Mutex
â”‚   â”œâ”€â”€ RwLock
â”‚   â””â”€â”€ Arc
â”œâ”€â”€ åŸå­æ“ä½œ
â”‚   â”œâ”€â”€ AtomicUsize
â”‚   â”œâ”€â”€ AtomicBool
â”‚   â””â”€â”€ Ordering
â””â”€â”€ çº¿ç¨‹æœ¬åœ°å­˜å‚¨
    â””â”€â”€ thread_local!
```

### 4.9 æ€»ç»“

Rust 2024 çš„å¤šçº¿ç¨‹æœºåˆ¶æä¾›äº†å¼ºå¤§çš„å·¥å…·æ¥æ„å»ºé«˜æ•ˆã€å®‰å…¨çš„å¹¶å‘ç¨‹åºã€‚é€šè¿‡çº¿ç¨‹ã€é€šä¿¡å’ŒåŒæ­¥çš„ç»„åˆï¼Œå¼€å‘è€…å¯ä»¥å®ç°å¤æ‚çš„å¹¶å‘é€»è¾‘ï¼ŒåŒæ—¶ä¿æŒå†…å­˜å®‰å…¨å’Œæ•°æ®ä¸€è‡´æ€§ã€‚Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨ç³»ç»Ÿåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­æä¾›äº†é¢å¤–çš„å®‰å…¨ä¿éšœï¼Œé˜²æ­¢æ•°æ®ç«äº‰å’Œå…¶ä»–å¸¸è§çš„å¹¶å‘é”™è¯¯ã€‚

åœ¨ Rust 2024 ç‰ˆæœ¬ä¸­ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹æ¶‰åŠå¤šä¸ªæ ¸å¿ƒæ¦‚å¿µå’Œæœºåˆ¶ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™äº›æ¦‚å¿µçš„è¯¦ç»†è§£é‡Šå’Œç¤ºä¾‹ï¼ŒåŒ…æ‹¬çº¿ç¨‹æœ¬åœ°å­˜å‚¨ã€çº¿ç¨‹é€€å‡ºã€åŒæ­¥æœºåˆ¶ã€é€šä¿¡æœºåˆ¶ã€åŸå­é”ç±»å‹å’Œè®¿é—®é¡ºåºç­‰ã€‚

### 4.10 1 çº¿ç¨‹æœ¬åœ°å­˜å‚¨Thread Local Storage

**å®šä¹‰**: çº¿ç¨‹æœ¬åœ°å­˜å‚¨å…è®¸æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ç‹¬ç«‹æ•°æ®å‰¯æœ¬ã€‚

**ç¤ºä¾‹**:

```rust
use std::thread;
use std::cell::RefCell;

thread_local! {
    static THREAD_LOCAL_DATA: RefCell<u32> = RefCell::new(0);
}

fn main() {
    let handles: Vec<_> = (0..5).map(|i| {
        thread::spawn(move || {
            THREAD_LOCAL_DATA.with(|data| {
                *data.borrow_mut() = i;
                println!("Thread {}: {}", i, *data.borrow());
            });
        })
    }).collect();

    for handle in handles {
        handle.join().unwrap();
    }
}
```

**è§£é‡Š**: ä½¿ç”¨ `thread_local!` å®å®šä¹‰çº¿ç¨‹æœ¬åœ°å­˜å‚¨ï¼Œæ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹ä¿®æ”¹å…¶å€¼ã€‚

### 4.11 2 å¤šçº¿ç¨‹é€€å‡ºä¸ä¸»çº¿ç¨‹é€€å‡º

**å®šä¹‰**: Rust ä¸­ï¼Œä¸»çº¿ç¨‹ä¼šç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆåæ‰ä¼šé€€å‡ºï¼Œé™¤éä½¿ç”¨ `std::process::exit` å¼ºåˆ¶é€€å‡ºã€‚

**ç¤ºä¾‹**:

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 1..10 {
            println!("Spawned thread: {}", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 1..5 {
        println!("Main thread: {}", i);
        thread::sleep(Duration::from_millis(1));
    }

    handle.join().unwrap();
}
```

**è§£é‡Š**: ä¸»çº¿ç¨‹åœ¨ `handle.join()` å¤„ç­‰å¾…å­çº¿ç¨‹å®Œæˆã€‚

### 4.12 3 åŒæ­¥æœºåˆ¶

**å®šä¹‰**: åŒæ­¥æœºåˆ¶ç”¨äºæ§åˆ¶å¯¹å…±äº«èµ„æºçš„è®¿é—®ï¼Œé˜²æ­¢æ•°æ®ç«äº‰ã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

**è§£é‡Š**: ä½¿ç”¨ `Mutex` ä¿æŠ¤å…±äº«æ•°æ®ï¼Œ`Arc` ç”¨äºåœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ‰€æœ‰æƒã€‚

### 4.13 4 é€šä¿¡æœºåˆ¶

**å®šä¹‰**: é€šä¿¡æœºåˆ¶ç”¨äºåœ¨çº¿ç¨‹é—´ä¼ é€’æ•°æ®ã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::mpsc;
use std::thread;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let val = String::from("Hello");
        tx.send(val).unwrap();
    });

    let received = rx.recv().unwrap();
    println!("Received: {}", received);
}
```

**è§£é‡Š**: ä½¿ç”¨ `mpsc::channel` åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œ`tx` æ˜¯å‘é€ç«¯ï¼Œ`rx` æ˜¯æ¥æ”¶ç«¯ã€‚

### 4.14 5 åŸå­é”ç±»å‹

**å®šä¹‰**: åŸå­ç±»å‹æä¾›äº†æ— éœ€é”çš„çº¿ç¨‹å®‰å…¨æ“ä½œã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::atomic::{AtomicUsize, Ordering};
use std::thread;

fn main() {
    let counter = AtomicUsize::new(0);
    let mut handles = vec![];

    for _ in 0..10 {
        let handle = thread::spawn({
            let counter = &counter;
            move || {
                for _ in 0..1000 {
                    counter.fetch_add(1, Ordering::SeqCst);
                }
            }
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", counter.load(Ordering::SeqCst));
}
```

**è§£é‡Š**: ä½¿ç”¨ `AtomicUsize` è¿›è¡ŒåŸå­æ“ä½œï¼Œ`Ordering::SeqCst` ç¡®ä¿æ“ä½œçš„é¡ºåºæ€§ã€‚

### 4.15 6 åŸå­é”è®¿é—®é¡ºåº

**å®šä¹‰**: åŸå­æ“ä½œçš„é¡ºåºæ€§ç”± `Ordering` æšä¸¾æ§åˆ¶ï¼Œå¸¸ç”¨çš„æœ‰ `Relaxed`ã€`Acquire`ã€`Release` å’Œ `SeqCst`ã€‚

- **Relaxed**: ä¸ä¿è¯é¡ºåºï¼Œä»…ä¿è¯åŸå­æ€§ã€‚
- **Acquire/Release**: ç”¨äºå®ç°é”çš„è·å–å’Œé‡Šæ”¾ã€‚
- **SeqCst**: æä¾›å…¨å±€é¡ºåºä¸€è‡´æ€§ã€‚

**ç¤ºä¾‹**:

```rust
use std::sync::atomic::{AtomicBool, Ordering};
use std::thread;

fn main() {
    let flag = AtomicBool::new(false);

    let handle = thread::spawn({
        let flag = &flag;
        move || {
            flag.store(true, Ordering::Release);
        }
    });

    while !flag.load(Ordering::Acquire) {
        // ç­‰å¾… flag è¢«è®¾ç½®ä¸º true
    }

    handle.join().unwrap();
    println!("Flag was set!");
}
```

**è§£é‡Š**: ä½¿ç”¨ `Ordering::Release` å’Œ `Ordering::Acquire` å®ç°ç®€å•çš„åŒæ­¥ã€‚

### 4.16 ç»¼åˆåº”ç”¨

åœ¨å®é™…åº”ç”¨ä¸­ï¼ŒRust çš„å¤šçº¿ç¨‹æœºåˆ¶å¯ä»¥ç”¨äºæ„å»ºé«˜æ•ˆçš„å¹¶å‘ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œæ„å»ºä¸€ä¸ªç®€å•çš„å¹¶å‘è®¡æ•°å™¨ï¼š

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Result: {}", *counter.lock().unwrap());
}
```

### 4.17 æ€ç»´å¯¼å›¾

```text
Rust 2024 å¤šçº¿ç¨‹æœºåˆ¶
â”œâ”€â”€ çº¿ç¨‹
â”‚   â”œâ”€â”€ åˆ›å»º
â”‚   â”œâ”€â”€ ç®¡ç†
â”‚   â””â”€â”€ é€€å‡º
â”œâ”€â”€ é€šä¿¡
â”‚   â”œâ”€â”€ é€šé“
â”‚   â””â”€â”€ å‘é€/æ¥æ”¶
â”œâ”€â”€ åŒæ­¥
â”‚   â”œâ”€â”€ Mutex
â”‚   â”œâ”€â”€ RwLock
â”‚   â””â”€â”€ Arc
â”œâ”€â”€ åŸå­æ“ä½œ
â”‚   â”œâ”€â”€ AtomicUsize
â”‚   â”œâ”€â”€ AtomicBool
â”‚   â””â”€â”€ Ordering
â””â”€â”€ çº¿ç¨‹æœ¬åœ°å­˜å‚¨
    â””â”€â”€ thread_local!
```

### 4.18 æ€»ç»“

Rust 2024 çš„å¤šçº¿ç¨‹æœºåˆ¶æä¾›äº†å¼ºå¤§çš„å·¥å…·æ¥æ„å»ºé«˜æ•ˆã€å®‰å…¨çš„å¹¶å‘ç¨‹åºã€‚é€šè¿‡çº¿ç¨‹ã€é€šä¿¡å’ŒåŒæ­¥çš„ç»„åˆï¼Œå¼€å‘è€…å¯ä»¥å®ç°å¤æ‚çš„å¹¶å‘é€»è¾‘ï¼ŒåŒæ—¶ä¿æŒå†…å­˜å®‰å…¨å’Œæ•°æ®ä¸€è‡´æ€§ã€‚Rust çš„æ‰€æœ‰æƒå’Œå€Ÿç”¨ç³»ç»Ÿåœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­æä¾›äº†é¢å¤–çš„å®‰å…¨ä¿éšœï¼Œé˜²æ­¢æ•°æ®ç«äº‰å’Œå…¶ä»–å¸¸è§çš„å¹¶å‘é”™è¯¯ã€‚

åœ¨ Rust 2024 ä¸­ï¼Œä½¿ç”¨åŸå­æ“ä½œå’Œæ¡ä»¶å˜é‡å¯ä»¥å®ç°ç»„åˆå¼çº¿ç¨‹åˆ›å»ºå’Œçº§è”é€€å‡ºã€‚è¿™ç§æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹ååŒå·¥ä½œï¼Œå¹¶åœ¨æŸä¸ªæ¡ä»¶æ»¡è¶³æ—¶æœ‰åºé€€å‡ºã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·æ¥å®ç°è¿™ç§æ¨¡å¼çš„è¯¦ç»†è¯´æ˜å’Œç¤ºä¾‹ã€‚

### 4.19 æ ¸å¿ƒæ¦‚å¿µ

1. **åŸå­æ“ä½œ**: æä¾›çº¿ç¨‹å®‰å…¨çš„åŸºæœ¬æ“ä½œï¼Œå…è®¸åœ¨ä¸ä½¿ç”¨é”çš„æƒ…å†µä¸‹è¿›è¡Œæ•°æ®å…±äº«ã€‚
2. **æ¡ä»¶å˜é‡**: ç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹å‘å‡ºä¿¡å·ã€‚
3. **ç»„åˆå¼çº¿ç¨‹åˆ›å»º**: åˆ›å»ºå¤šä¸ªçº¿ç¨‹å¹¶è®©å®ƒä»¬ååŒå·¥ä½œã€‚
4. **çº§è”é€€å‡º**: å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆå·¥ä½œåï¼Œé€šçŸ¥å…¶ä»–çº¿ç¨‹æœ‰åºé€€å‡ºã€‚

### 4.20 å®ç°æ­¥éª¤

1. **ä½¿ç”¨åŸå­å˜é‡è·Ÿè¸ªçŠ¶æ€**: ä½¿ç”¨ `AtomicBool` æˆ– `AtomicUsize` æ¥è·Ÿè¸ªçº¿ç¨‹çš„çŠ¶æ€æˆ–è®¡æ•°ã€‚
2. **ä½¿ç”¨æ¡ä»¶å˜é‡è¿›è¡ŒåŒæ­¥**: ä½¿ç”¨ `Condvar` æ¥åè°ƒçº¿ç¨‹çš„ç­‰å¾…å’Œé€šçŸ¥ã€‚
3. **åˆ›å»ºå¤šä¸ªçº¿ç¨‹**: ä½¿ç”¨ `thread::spawn` åˆ›å»ºå¤šä¸ªçº¿ç¨‹ã€‚
4. **å®ç°çº§è”é€€å‡º**: å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆå·¥ä½œåï¼Œä½¿ç”¨æ¡ä»¶å˜é‡é€šçŸ¥å…¶ä»–çº¿ç¨‹é€€å‡ºã€‚

### 4.21 ç¤ºä¾‹ä»£ç 

```rust
use std::sync::{Arc, Mutex, Condvar};
use std::sync::atomic::{AtomicBool, Ordering};
use std::thread;
use std::time::Duration;

fn main() {
    let is_done = Arc::new(AtomicBool::new(false));
    let pair = Arc::new((Mutex::new(false), Condvar::new()));

    let mut handles = vec![];

    for i in 0..5 {
        let is_done = Arc::clone(&is_done);
        let pair = Arc::clone(&pair);

        let handle = thread::spawn(move || {
            let (lock, cvar) = &*pair;
            let mut started = lock.lock().unwrap();

            while !*started {
                started = cvar.wait(started).unwrap();
            }

            println!("Thread {} is working...", i);
            thread::sleep(Duration::from_secs(1));

            if i == 4 {
                is_done.store(true, Ordering::SeqCst);
                cvar.notify_all();
            }
        });

        handles.push(handle);
    }

    {
        let (lock, cvar) = &*pair;
        let mut started = lock.lock().unwrap();
        *started = true;
        cvar.notify_all();
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("All threads have completed.");
}
```

### 4.22 è§£é‡Š

1. **åŸå­å˜é‡ `is_done`**: ç”¨äºæ ‡è®°æ‰€æœ‰çº¿ç¨‹æ˜¯å¦åº”è¯¥é€€å‡ºã€‚
2. **æ¡ä»¶å˜é‡ `pair`**: åŒ…å«ä¸€ä¸ª `Mutex` å’Œä¸€ä¸ª `Condvar`ï¼Œç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥ã€‚
3. **çº¿ç¨‹åˆ›å»º**: ä½¿ç”¨ `thread::spawn` åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹ç­‰å¾…æ¡ä»¶å˜é‡çš„ä¿¡å·ã€‚
4. **çº§è”é€€å‡º**: å½“æœ€åä¸€ä¸ªçº¿ç¨‹å®Œæˆå·¥ä½œæ—¶ï¼Œè®¾ç½® `is_done` ä¸º `true` å¹¶é€šçŸ¥æ‰€æœ‰çº¿ç¨‹é€€å‡ºã€‚

### 4.23 ç»„åˆå¼çº¿ç¨‹åˆ›å»ºå’Œçº§è”é€€å‡ºçš„ä¼˜ç‚¹

- **é«˜æ•ˆçš„èµ„æºåˆ©ç”¨**: çº¿ç¨‹åœ¨éœ€è¦æ—¶æ‰å¼€å§‹å·¥ä½œï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚
- **æœ‰åºé€€å‡º**: ç¡®ä¿æ‰€æœ‰çº¿ç¨‹åœ¨å®Œæˆå·¥ä½œåæœ‰åºé€€å‡ºï¼Œé¿å…èµ„æºæ³„æ¼ã€‚
- **çµæ´»çš„åŒæ­¥æœºåˆ¶**: ä½¿ç”¨æ¡ä»¶å˜é‡å’ŒåŸå­æ“ä½œå®ç°çµæ´»çš„çº¿ç¨‹é—´åŒæ­¥ã€‚

### 4.24 æ€»ç»“

é€šè¿‡ç»“åˆä½¿ç”¨åŸå­æ“ä½œå’Œæ¡ä»¶å˜é‡ï¼ŒRust 2024 æä¾›äº†ä¸€ç§é«˜æ•ˆçš„æ–¹å¼æ¥å®ç°ç»„åˆå¼çº¿ç¨‹åˆ›å»ºå’Œçº§è”é€€å‡ºã€‚
è¿™ç§æ¨¡å¼é€‚ç”¨äºéœ€è¦å¤šä¸ªçº¿ç¨‹ååŒå·¥ä½œçš„åœºæ™¯ï¼Œç¡®ä¿çº¿ç¨‹åœ¨å®Œæˆå·¥ä½œåèƒ½å¤Ÿæœ‰åºé€€å‡ºï¼Œä»è€Œæé«˜ç¨‹åºçš„æ•ˆç‡å’Œå¯é æ€§ã€‚
