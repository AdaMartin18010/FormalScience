# rust threads

åœ¨ Rust ä¸­ï¼Œçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼ˆThread Local Storage, TLSï¼‰æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå…è®¸æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å…¶ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬ã€‚
Rust æä¾›äº† `thread_local!` å®æ¥å®ç°è¿™ä¸€åŠŸèƒ½ã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•è®¾è®¡å’Œä½¿ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„è¯¦ç»†è¯´æ˜ï¼š

## ğŸ“‹ ç›®å½•

- [1 ä½¿ç”¨ thread_local å®](#1-ä½¿ç”¨-thread_local-å®)
  - [1.1 ç¤ºä¾‹ä»£ç ](#11-ç¤ºä¾‹ä»£ç )
  - [1.2 è®¿é—®çº¿ç¨‹å±€éƒ¨å­˜å‚¨](#12-è®¿é—®çº¿ç¨‹å±€éƒ¨å­˜å‚¨)
    - [2.2.1 -ç¤ºä¾‹ä»£ç ](#221--ç¤ºä¾‹ä»£ç )
  - [1.3 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ç”Ÿå‘½å‘¨æœŸ](#13-çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ç”Ÿå‘½å‘¨æœŸ)
  - [1.4 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ä¼˜åŠ¿](#14-çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ä¼˜åŠ¿)
  - [1.5 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ä½¿ç”¨åœºæ™¯](#15-çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ä½¿ç”¨åœºæ™¯)
  - [1.6 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„é™åˆ¶](#16-çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„é™åˆ¶)
  - [1.7 ç¬¬ä¸‰æ–¹åº“æ”¯æŒ](#17-ç¬¬ä¸‰æ–¹åº“æ”¯æŒ)
  - [1.8 æ€»ç»“](#18-æ€»ç»“)
- [2 PoisonError](#2-poisonerror)
  - [2.1 å¤„ç† PoisonError](#21-å¤„ç†-poisonerror)
    - [1.1.1 into_inner æ–¹æ³•](#111-into_inner-æ–¹æ³•)
    - [1.1.2 get_ref æ–¹æ³•](#112-get_ref-æ–¹æ³•)
    - [1.1.3 get_mut æ–¹æ³•](#113-get_mut-æ–¹æ³•)
  - [2.2 PoisonError çš„æœºåˆ¶](#22-poisonerror-çš„æœºåˆ¶)
  - [2.3 é¿å… PoisonError](#23-é¿å…-poisonerror)
- [3 mutex or rwlock](#3-mutex-or-rwlock)
  - [3.1 ä½¿ç”¨ Mutex ä¿è¯æ•°æ®ä¸€è‡´æ€§](#31-ä½¿ç”¨-mutex-ä¿è¯æ•°æ®ä¸€è‡´æ€§)
    - [1.1.1 ç¤ºä¾‹ä»£ç ï¼šä½¿ç”¨ Mutex ä¿æŠ¤å…¨å±€çŠ¶æ€](#111-ç¤ºä¾‹ä»£ç ä½¿ç”¨-mutex-ä¿æŠ¤å…¨å±€çŠ¶æ€)
  - [3.2 ä½¿ç”¨ RwLock æé«˜å¹¶å‘æ€§èƒ½](#32-ä½¿ç”¨-rwlock-æé«˜å¹¶å‘æ€§èƒ½)
    - [2.2.1 ç¤ºä¾‹ä»£ç ï¼šä½¿ç”¨ RwLock ä¿æŠ¤å…±äº«æ•°æ®](#221-ç¤ºä¾‹ä»£ç ä½¿ç”¨-rwlock-ä¿æŠ¤å…±äº«æ•°æ®)
  - [3.3 ä½¿ç”¨ Arc å®ç°å¤šçº¿ç¨‹å…±äº«](#33-ä½¿ç”¨-arc-å®ç°å¤šçº¿ç¨‹å…±äº«)
    - [3.3.1 ç¤ºä¾‹ä»£ç ï¼šä½¿ç”¨ Arc å’Œ Mutex](#331-ç¤ºä¾‹ä»£ç ä½¿ç”¨-arc-å’Œ-mutex)
  - [3.4 å¤„ç†é”ç«äº‰å’Œæ­»é”](#34-å¤„ç†é”ç«äº‰å’Œæ­»é”)
  - [3.5 ä½¿ç”¨ PoisonError å¤„ç†æ¯’åŒ–é”](#35-ä½¿ç”¨-poisonerror-å¤„ç†æ¯’åŒ–é”)
    - [5.5.1 ç¤ºä¾‹ä»£ç ï¼šå¤„ç†æ¯’åŒ–é”](#551-ç¤ºä¾‹ä»£ç å¤„ç†æ¯’åŒ–é”)
  - [3.6 æ€»ç»“](#36-æ€»ç»“)
  - [3.7 è®¾è®¡ç­–ç•¥](#37-è®¾è®¡ç­–ç•¥)
  - [3.8 Rust çš„ä¿æŠ¤æ€§æœºåˆ¶](#38-rust-çš„ä¿æŠ¤æ€§æœºåˆ¶)
  - [3.9 ç¤ºä¾‹](#39-ç¤ºä¾‹)
    - [9.9.1 ä½¿ç”¨ catch_unwind æ•è· panic](#991-ä½¿ç”¨-catch_unwind-æ•è·-panic)
    - [9.9.2 ä½¿ç”¨ Mutex å’Œ PoisonError](#992-ä½¿ç”¨-mutex-å’Œ-poisonerror)
  - [3.10 æ€»ç»“](#310-æ€»ç»“)
  - [3.11 çº¿ç¨‹å–æ¶ˆThread Cancellation](#311-çº¿ç¨‹å–æ¶ˆthread-cancellation)
  - [3.12 å †æ ˆå±•å¼€Stack Unwinding](#312-å †æ ˆå±•å¼€stack-unwinding)
  - [3.13 ç¨‹åºç»ˆæ­¢](#313-ç¨‹åºç»ˆæ­¢)
  - [3.14 è·¨çº¿ç¨‹å½±å“](#314-è·¨çº¿ç¨‹å½±å“)
  - [3.15 å¦‚ä½•æ•è· panic](#315-å¦‚ä½•æ•è·-panic)
  - [3.16 -æ€»ç»“-](#316--æ€»ç»“)
  - [3.17 ä½¿ç”¨ Result å’Œ Option](#317-ä½¿ç”¨-result-å’Œ-option)
    - [17.17.1 ä½¿ç”¨ Result å¤„ç†é”™è¯¯](#17171-ä½¿ç”¨-result-å¤„ç†é”™è¯¯)
    - [17.17.2 ä½¿ç”¨ Option å¤„ç†å¯èƒ½ç¼ºå¤±çš„å€¼](#17172-ä½¿ç”¨-option-å¤„ç†å¯èƒ½ç¼ºå¤±çš„å€¼)
  - [3.18 é¿å…ç›´æ¥è°ƒç”¨ unwrap å’Œ expect](#318-é¿å…ç›´æ¥è°ƒç”¨-unwrap-å’Œ-expect)
    - [18.18.1 ä½¿ç”¨ if let å¤„ç† Option](#18181-ä½¿ç”¨-if-let-å¤„ç†-option)
    - [18.18.2 ä½¿ç”¨ match å¤„ç† Result](#18182-ä½¿ç”¨-match-å¤„ç†-result)
  - [3.19 å•å…ƒæµ‹è¯•å’Œæ¨¡ç³Šæµ‹è¯•](#319-å•å…ƒæµ‹è¯•å’Œæ¨¡ç³Šæµ‹è¯•)
    - [19.19.1 å•å…ƒæµ‹è¯•](#19191-å•å…ƒæµ‹è¯•)
    - [19.19.2 æ¨¡ç³Šæµ‹è¯•ä½¿ç”¨ libfuzzer-sys](#19192-æ¨¡ç³Šæµ‹è¯•ä½¿ç”¨-libfuzzer-sys)
  - [3.20 ä½¿ç”¨å°è£…å’ŒæŠ½è±¡](#320-ä½¿ç”¨å°è£…å’ŒæŠ½è±¡)
    - [20.20.1 å°è£…æ–‡ä»¶è¯»å–é€»è¾‘](#20201-å°è£…æ–‡ä»¶è¯»å–é€»è¾‘)
  - [3.21 ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹](#321-ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹)
    - [21.21.1 é˜²å¾¡æ€§æ£€æŸ¥ç¤ºä¾‹](#21211-é˜²å¾¡æ€§æ£€æŸ¥ç¤ºä¾‹)
  - [3.22 ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ](#322-ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ)
    - [22.22.1 ä½¿ç”¨ RefCell](#22221-ä½¿ç”¨-refcell)
  - [3.23 å®¡æŸ¥ç¬¬ä¸‰æ–¹ä¾èµ–](#323-å®¡æŸ¥ç¬¬ä¸‰æ–¹ä¾èµ–)
    - [23.23.1 å®¡æŸ¥ä¾èµ–çš„ Cargotoml](#23231-å®¡æŸ¥ä¾èµ–çš„-cargotoml)
  - [3.24 -æ€»ç»“](#324--æ€»ç»“)
  - [3.25 Rust é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•](#325-rust-é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•)
  - [3.26 unwrap_or çš„è§£é‡Šå’Œç¤ºä¾‹](#326-unwrap_or-çš„è§£é‡Šå’Œç¤ºä¾‹)
    - [26.26.1 è§£é‡Š](#26261-è§£é‡Š)
    - [26.26.2 -ç¤ºä¾‹](#26262--ç¤ºä¾‹)
  - [3.27 unwrap_or_else çš„è§£é‡Šå’Œç¤ºä¾‹](#327-unwrap_or_else-çš„è§£é‡Šå’Œç¤ºä¾‹)
    - [27.27.1 -è§£é‡Š](#27271--è§£é‡Š)
    - [27.27.2 --ç¤ºä¾‹](#27272---ç¤ºä¾‹)
  - [3.28 match çš„è§£é‡Šå’Œç¤ºä¾‹](#328-match-çš„è§£é‡Šå’Œç¤ºä¾‹)
    - [28.28.1 --è§£é‡Š](#28281---è§£é‡Š)
    - [28.28.2 ---ç¤ºä¾‹](#28282----ç¤ºä¾‹)
  - [3.29 unwrap çš„è§£é‡Šå’Œç¤ºä¾‹](#329-unwrap-çš„è§£é‡Šå’Œç¤ºä¾‹)
    - [29.29.1 ---è§£é‡Š](#29291----è§£é‡Š)
    - [29.29.2 ---ç¤ºä¾‹-](#29292----ç¤ºä¾‹)
  - [3.30 expect çš„è§£é‡Šå’Œç¤ºä¾‹](#330-expect-çš„è§£é‡Šå’Œç¤ºä¾‹)
    - [30.30.1 ----è§£é‡Š](#30301-----è§£é‡Š)
    - [30.30.2 ----ç¤ºä¾‹](#30302-----ç¤ºä¾‹)
  - [3.31 Result çš„é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•](#331-result-çš„é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•)
    - [31.31.1 ----ç¤ºä¾‹--](#31311-----ç¤ºä¾‹)
  - [3.32 æ€»ç»“](#332-æ€»ç»“)

---

## 1 ä½¿ç”¨ thread_local å®

`thread_local!` å®ç”¨äºå£°æ˜çº¿ç¨‹å±€éƒ¨å­˜å‚¨å˜é‡ã€‚
æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å…¶ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œè¿™æ„å‘³ç€å½“ä½ åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­ä¿®æ”¹è¯¥å˜é‡æ—¶ï¼Œå…¶ä»–çº¿ç¨‹ä¸ä¼šå—åˆ°å½±å“ã€‚

### 1.1 ç¤ºä¾‹ä»£ç 

```rust
use std::cell::RefCell;
use std::thread;

thread_local! {
    static FOO: RefCell<i32> = RefCell::new(0);
}

fn main() {
    // åœ¨ä¸»çº¿ç¨‹ä¸­ä¿®æ”¹ FOO
    FOO.with(|f| *f.borrow_mut() += 2);

    // åœ¨æ–°çº¿ç¨‹ä¸­è®¿é—® FOO
    let handle = thread::spawn(|| {
        FOO.with(|f| *f.borrow_mut() += 3);
        FOO.with(|f| println!("Thread: {}", f.borrow()));
    });

    handle.join().unwrap();

    // å†æ¬¡åœ¨ä¸»çº¿ç¨‹ä¸­è®¿é—® FOO
    FOO.with(|f| println!("Main: {}", f.borrow()));
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`FOO` æ˜¯ä¸€ä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å…¶ç‹¬ç«‹çš„å‰¯æœ¬ã€‚ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹å¯¹ `FOO` çš„ä¿®æ”¹äº’ä¸å½±å“ã€‚

### 1.2 è®¿é—®çº¿ç¨‹å±€éƒ¨å­˜å‚¨

è¦è®¿é—®çº¿ç¨‹å±€éƒ¨å­˜å‚¨å˜é‡ï¼Œå¯ä»¥ä½¿ç”¨ `with` æ–¹æ³•ã€‚`with` æ–¹æ³•æ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œå¹¶åœ¨é—­åŒ…ä¸­æä¾›å¯¹å˜é‡çš„å¼•ç”¨ã€‚

#### 2.2.1 -ç¤ºä¾‹ä»£ç 

```rust
FOO.with(|f| {
    *f.borrow_mut() = 42;
    println!("Value: {}", f.borrow());
});
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`with` æ–¹æ³•è¢«ç”¨æ¥ä¿®æ”¹å’Œè®¿é—® `FOO` çš„å€¼ã€‚

### 1.3 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ç”Ÿå‘½å‘¨æœŸ

çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç›¸åŒã€‚
å½“çº¿ç¨‹ç»“æŸæ—¶ï¼Œçº¿ç¨‹å±€éƒ¨å­˜å‚¨ä¸­çš„æ•°æ®ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ã€‚
è¿™æ„å‘³ç€ä½ ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ç”Ÿå‘½å‘¨æœŸã€‚

### 1.4 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ä¼˜åŠ¿

- **ç‹¬ç«‹çŠ¶æ€**ï¼šæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å…¶ç‹¬ç«‹çš„çŠ¶æ€ï¼Œé¿å…äº†çº¿ç¨‹é—´çš„æ•°æ®ç«äº‰ã€‚
- **é¿å…é”çš„å¼€é”€**ï¼šç”±äºæ¯ä¸ªçº¿ç¨‹æ“ä½œè‡ªå·±çš„æ•°æ®å‰¯æœ¬ï¼Œå› æ­¤ä¸éœ€è¦ä½¿ç”¨é”æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶æ¥ä¿è¯æ•°æ®å®‰å…¨ã€‚
- **ç‰¹å®šäºçº¿ç¨‹çš„èµ„æºç®¡ç†**ï¼šå¯ä»¥ç”¨äºç®¡ç†ç‰¹å®šäºçº¿ç¨‹çš„èµ„æºï¼Œå¦‚å¥æŸ„æˆ–ä¸Šä¸‹æ–‡ã€‚

### 1.5 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„ä½¿ç”¨åœºæ™¯

- **çº¿ç¨‹ç‰¹å®šçš„ç¼“å­˜**ï¼šæ¯ä¸ªçº¿ç¨‹å¯ä»¥æœ‰è‡ªå·±çš„ç¼“å­˜ï¼Œé¿å…äº†ç¼“å­˜æ•°æ®çš„å…±äº«å’ŒåŒæ­¥é—®é¢˜ã€‚
- **çº¿ç¨‹ç‰¹å®šçš„é…ç½®**ï¼šå¯ä»¥ä¸ºæ¯ä¸ªçº¿ç¨‹è®¾ç½®ç‰¹å®šçš„é…ç½®ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹ã€‚
- **çº¿ç¨‹ç‰¹å®šçš„ä¸Šä¸‹æ–‡**ï¼šå¯ä»¥ç”¨äºå­˜å‚¨çº¿ç¨‹ç‰¹å®šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·ä¼šè¯æˆ–äº‹åŠ¡ä¿¡æ¯ã€‚

### 1.6 çº¿ç¨‹å±€éƒ¨å­˜å‚¨çš„é™åˆ¶

- **åˆå§‹åŒ–**ï¼šçº¿ç¨‹å±€éƒ¨å­˜å‚¨å˜é‡çš„åˆå§‹åŒ–å¿…é¡»åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼Œä¸èƒ½åœ¨è¿è¡Œæ—¶åŠ¨æ€åˆå§‹åŒ–ã€‚
- **ç±»å‹é™åˆ¶**ï¼šçº¿ç¨‹å±€éƒ¨å­˜å‚¨å˜é‡çš„ç±»å‹å¿…é¡»æ˜¯ `Send` æˆ– `Sync`ï¼Œä»¥ç¡®ä¿çº¿ç¨‹é—´çš„å®‰å…¨æ€§ã€‚

### 1.7 ç¬¬ä¸‰æ–¹åº“æ”¯æŒ

é™¤äº†æ ‡å‡†åº“çš„ `thread_local!` å®ï¼Œè¿˜æœ‰ä¸€äº›ç¬¬ä¸‰æ–¹åº“æä¾›äº†æ›´çµæ´»çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨å®ç°ï¼Œå¦‚ `thread_local` crateã€‚
è¿™äº›åº“å…è®¸æ¯ä¸ªå¯¹è±¡æ‹¥æœ‰ç‹¬ç«‹çš„çº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼Œè€Œä¸æ˜¯ä»…é™äºé™æ€çº¿ç¨‹å±€éƒ¨å­˜å‚¨ã€‚

### 1.8 æ€»ç»“

Rust çš„ `thread_local!` å®æä¾›äº†ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹å¼æ¥å®ç°çº¿ç¨‹å±€éƒ¨å­˜å‚¨ã€‚
é€šè¿‡ä½¿ç”¨ `thread_local!`ï¼Œä½ å¯ä»¥ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬ï¼Œé¿å…çº¿ç¨‹é—´çš„æ•°æ®ç«äº‰å’Œé”çš„å¼€é”€ã€‚
è¿™å¯¹äºéœ€è¦åœ¨çº¿ç¨‹çº§åˆ«ä¿æŒçŠ¶æ€çš„åœºæ™¯éå¸¸æœ‰ç”¨ã€‚

## 2 PoisonError

åœ¨ Rust ä¸­ï¼Œ`PoisonError` æ˜¯ä¸€ç§ç‰¹æ®Šçš„é”™è¯¯ç±»å‹ï¼Œç”¨äºå¤„ç†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ç”±äºçº¿ç¨‹ `panic` å¯¼è‡´çš„é”ä¸­æ¯’é—®é¢˜ã€‚
å½“ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰ `Mutex` æˆ– `RwLock` æ—¶å‘ç”Ÿ `panic`ï¼Œè¯¥é”ä¼šè¢«æ ‡è®°ä¸ºâ€œä¸­æ¯’â€ã€‚
åç»­å°è¯•è·å–è¯¥é”çš„æ“ä½œä¼šè¿”å›ä¸€ä¸ª `PoisonError`ï¼Œä»¥é˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨ä¸ç»æ„é—´è®¿é—®åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

### 2.1 å¤„ç† PoisonError

Rust æä¾›äº†å‡ ç§æ–¹æ³•æ¥å¤„ç† `PoisonError`ï¼š

#### 1.1.1 into_inner æ–¹æ³•

- æ¶ˆè€— `PoisonError`ï¼Œè¿”å›åº•å±‚ä¿æŠ¤çš„æ•°æ®ï¼Œå…è®¸è®¿é—®ã€‚
- ç¤ºä¾‹ï¼š

     ```rust
     use std::sync::{Arc, Mutex};
     use std::thread;

     fn main() {
         let mutex = Arc::new(Mutex::new(0));

         let c_mutex = Arc::clone(&mutex);
         let _ = thread::spawn(move || {
             let mut data = c_mutex.lock().unwrap();
             *data = 10;
             panic!();
         }).join();

         let p_err = mutex.lock().unwrap_err();
         let data = p_err.into_inner();
         println!("Recovered data: {}", data);
     }
     ```

     åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`into_inner` æ–¹æ³•è¢«ç”¨æ¥è·å–ä¸­æ¯’é”çš„åº•å±‚æ•°æ®ã€‚

#### 1.1.2 get_ref æ–¹æ³•

- è¿”å›å¯¹åº•å±‚ä¿æŠ¤æ•°æ®çš„å¼•ç”¨ï¼Œå…è®¸è®¿é—®ã€‚
- ç¤ºä¾‹ï¼š

     ```rust
     use std::sync::{Arc, Mutex};
     use std::thread;

     fn main() {
         let mutex = Arc::new(Mutex::new(0));

         let c_mutex = Arc::clone(&mutex);
         let _ = thread::spawn(move || {
             let mut data = c_mutex.lock().unwrap();
             *data = 10;
             panic!();
         }).join();

         let p_err = mutex.lock().unwrap_err();
         let data = p_err.get_ref();
         println!("Recovered data: {}", data);
     }
     ```

     åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`get_ref` æ–¹æ³•è¢«ç”¨æ¥è·å–ä¸­æ¯’é”çš„åº•å±‚æ•°æ®çš„å¼•ç”¨ã€‚

#### 1.1.3 get_mut æ–¹æ³•

- è¿”å›å¯¹åº•å±‚ä¿æŠ¤æ•°æ®çš„å¯å˜å¼•ç”¨ï¼Œå…è®¸ä¿®æ”¹ã€‚
- ç¤ºä¾‹ï¼š

     ```rust
     use std::sync::{Arc, Mutex};
     use std::thread;

     fn main() {
         let mutex = Arc::new(Mutex::new(0));

         let c_mutex = Arc::clone(&mutex);
         let _ = thread::spawn(move || {
             let mut data = c_mutex.lock().unwrap();
             *data = 10;
             panic!();
         }).join();

         let p_err = mutex.lock().unwrap_err();
         let mut data = p_err.get_mut();
         *data += 1;
         println!("Recovered and modified data: {}", data);
     }
     ```

     åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`get_mut` æ–¹æ³•è¢«ç”¨æ¥è·å–ä¸­æ¯’é”çš„åº•å±‚æ•°æ®çš„å¯å˜å¼•ç”¨ã€‚

### 2.2 PoisonError çš„æœºåˆ¶

1. **é”ä¸­æ¯’**ï¼š
   - å½“ä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰ `Mutex` æˆ– `RwLock` æ—¶å‘ç”Ÿ `panic`ï¼Œè¯¥é”ä¼šè¢«æ ‡è®°ä¸ºâ€œä¸­æ¯’â€ã€‚
   - åç»­å°è¯•è·å–è¯¥é”çš„æ“ä½œä¼šè¿”å›ä¸€ä¸ª `PoisonError`ï¼Œä»¥é˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨ä¸ç»æ„é—´è®¿é—®åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

2. **é”™è¯¯ä¼ æ’­**ï¼š
   - `PoisonError` ä¼šä¼ æ’­ç»™å°è¯•è·å–é”çš„çº¿ç¨‹ï¼Œç¡®ä¿è¿™äº›çº¿ç¨‹èƒ½å¤Ÿå¤„ç†é”™è¯¯å¹¶é‡‡å–é€‚å½“çš„æªæ–½ã€‚
   - é€šè¿‡ `into_inner`ã€`get_ref` å’Œ `get_mut` æ–¹æ³•ï¼Œå¯ä»¥å®‰å…¨åœ°è®¿é—®å’Œä¿®æ”¹ä¸­æ¯’é”çš„åº•å±‚æ•°æ®ã€‚

3. **å®‰å…¨è®¿é—®**ï¼š
   - å°½ç®¡ `PoisonError` è¡¨ç¤ºé”å·²è¢«ä¸­æ¯’ï¼Œä½†é€šè¿‡ `into_inner`ã€`get_ref` å’Œ `get_mut` æ–¹æ³•ï¼Œå¯ä»¥å®‰å…¨åœ°è®¿é—®å’Œä¿®æ”¹åº•å±‚æ•°æ®ã€‚
   - è¿™äº›æ–¹æ³•ç¡®ä¿åœ¨è®¿é—®æ•°æ®æ—¶ä¸ä¼šå‘ç”Ÿæ•°æ®ç«äº‰æˆ–å…¶ä»–å¹¶å‘é—®é¢˜ã€‚

### 2.3 é¿å… PoisonError

ä¸ºäº†é¿å… `PoisonError`ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

1. **ä½¿ç”¨ `catch_unwind` æ•è· `panic`**ï¼š
   - ä½¿ç”¨ `std::panic::catch_unwind` æ•è· `panic`ï¼Œé˜²æ­¢ `panic` ä¼ æ’­åˆ°å…¶ä»–çº¿ç¨‹ã€‚
   - ç¤ºä¾‹ï¼š

     ```rust
     use std::panic;
     use std::sync::{Arc, Mutex};
     use std::thread;

     fn main() {
         let mutex = Arc::new(Mutex::new(0));

         let c_mutex = Arc::clone(&mutex);
         let _ = thread::spawn(move || {
             let result = panic::catch_unwind(|| {
                 let mut data = c_mutex.lock().unwrap();
                 *data = 10;
                 panic!();
             });
             if let Err(_) = result {
                 println!("Panic caught");
             }
         }).join();

         let data = mutex.lock().unwrap();
         println!("Data: {}", data);
     }
     ```

     åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`catch_unwind` æ•è·äº† `panic`ï¼Œé˜²æ­¢é”è¢«æ ‡è®°ä¸ºä¸­æ¯’ã€‚

2. **é¿å…åœ¨ä¸´ç•ŒåŒºä¸­ä½¿ç”¨ `panic`**ï¼š
   - å°½é‡é¿å…åœ¨æŒæœ‰é”æ—¶ä½¿ç”¨ `panic`ï¼Œå¦‚æœéœ€è¦å¤„ç†é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ `Result` æˆ– `Option` ç±»å‹ã€‚

3. **ä½¿ç”¨ `try_lock` æ–¹æ³•**ï¼š
   - ä½¿ç”¨ `try_lock` æ–¹æ³•å°è¯•è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥ï¼Œå¯ä»¥ç«‹å³å¤„ç†é”™è¯¯ï¼Œè€Œä¸æ˜¯ç­‰å¾… `panic` å‘ç”Ÿã€‚

é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥æœ‰æ•ˆåœ°å¤„ç†å’Œé¿å… `PoisonError`ï¼Œç¡®ä¿å¤šçº¿ç¨‹ç¨‹åºçš„å¥å£®æ€§å’Œå®‰å…¨æ€§ã€‚

## 3 mutex or rwlock

åœ¨ Rust ä¸­ï¼Œçº¿ç¨‹é”ï¼ˆå¦‚ `Mutex` æˆ– `RwLock`ï¼‰æ˜¯ç”¨äºåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å®‰å…¨åœ°å…±äº«å’Œä¿®æ”¹æ•°æ®çš„åŒæ­¥åŸè¯­ã€‚
å®ƒä»¬ç¡®ä¿åœ¨ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«æ•°æ®ï¼Œä»è€Œé˜²æ­¢æ•°æ®ç«äº‰å’Œå…¶ä»–å¹¶å‘é—®é¢˜ã€‚
ä»¥ä¸‹æ˜¯å¦‚ä½•è®¾è®¡å’Œä½¿ç”¨çº¿ç¨‹é”çš„è¯¦ç»†è¯´æ˜ï¼š

### 3.1 ä½¿ç”¨ Mutex ä¿è¯æ•°æ®ä¸€è‡´æ€§

`Mutex`ï¼ˆäº’æ–¥é”ï¼‰æ˜¯ä¸€ç§æœ€åŸºæœ¬çš„åŒæ­¥åŸè¯­ï¼Œç”¨äºç¡®ä¿åœ¨ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«æ•°æ®ã€‚
Rust æä¾›äº† `std::sync::Mutex` ç±»å‹ï¼Œç”¨äºå°è£…å…±äº«æ•°æ®ï¼Œå¹¶æä¾›çº¿ç¨‹å®‰å…¨çš„è®¿é—®æ–¹å¼ã€‚

#### 1.1.1 ç¤ºä¾‹ä»£ç ï¼šä½¿ç”¨ Mutex ä¿æŠ¤å…¨å±€çŠ¶æ€

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    // ä½¿ç”¨ Arc (Atomic Reference Counted) åŒ…è£¹ Mutex ä»¥å®ç°å¤šçº¿ç¨‹å…±äº«
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();  // è·å–é”
            *num += 1;  // ä¿®æ”¹å…±äº«æ•°æ®
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Final counter: {}", *counter.lock().unwrap());
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`Arc` ç¡®ä¿å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿå®‰å…¨åœ°å…±äº« `Mutex`ï¼Œè€Œ `Mutex` ä¿æŠ¤å…±äº«æ•°æ® `counter`ï¼Œé˜²æ­¢åœ¨å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹æ—¶å‡ºç°æ•°æ®ç«äº‰ã€‚

### 3.2 ä½¿ç”¨ RwLock æé«˜å¹¶å‘æ€§èƒ½

`RwLock`ï¼ˆè¯»å†™é”ï¼‰å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–æ•°æ®ï¼Œä½†åœ¨å†™å…¥æ•°æ®æ—¶ä¼šç‹¬å é”ã€‚
è¿™åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹å¯ä»¥æé«˜å¹¶å‘æ€§èƒ½ã€‚

#### 2.2.1 ç¤ºä¾‹ä»£ç ï¼šä½¿ç”¨ RwLock ä¿æŠ¤å…±äº«æ•°æ®

```rust
use std::sync::{Arc, RwLock};
use std::thread;

fn main() {
    let data = Arc::new(RwLock::new(0));
    let mut handles = vec![];

    for i in 0..10 {
        let data = Arc::clone(&data);
        let handle = thread::spawn(move || {
            let mut num = data.write().unwrap();  // è·å–å†™é”
            *num += i;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Final data: {}", *data.read().unwrap());
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`RwLock` å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–æ•°æ®ï¼Œä½†åœ¨å†™å…¥æ•°æ®æ—¶ä¼šç‹¬å é”ï¼Œä»è€Œæé«˜å¹¶å‘æ€§èƒ½ã€‚

### 3.3 ä½¿ç”¨ Arc å®ç°å¤šçº¿ç¨‹å…±äº«

`Arc`ï¼ˆAtomic Reference Countedï¼‰æ˜¯ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«æ•°æ®ã€‚
ç»“åˆ `Mutex` æˆ– `RwLock`ï¼Œå¯ä»¥å®‰å…¨åœ°å…±äº«å’Œä¿®æ”¹æ•°æ®ã€‚

#### 3.3.1 ç¤ºä¾‹ä»£ç ï¼šä½¿ç”¨ Arc å’Œ Mutex

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let counter = Arc::new(Mutex::new(0));
    let mut handles = vec![];

    for _ in 0..10 {
        let counter = Arc::clone(&counter);
        let handle = thread::spawn(move || {
            let mut num = counter.lock().unwrap();
            *num += 1;
        });
        handles.push(handle);
    }

    for handle in handles {
        handle.join().unwrap();
    }

    println!("Final counter: {}", *counter.lock().unwrap());
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`Arc` ç¡®ä¿å¤šä¸ªçº¿ç¨‹èƒ½å¤Ÿå®‰å…¨åœ°å…±äº« `Mutex`ï¼Œè€Œ `Mutex` ä¿æŠ¤å…±äº«æ•°æ® `counter`ã€‚

### 3.4 å¤„ç†é”ç«äº‰å’Œæ­»é”

åœ¨ä½¿ç”¨çº¿ç¨‹é”æ—¶ï¼Œéœ€è¦æ³¨æ„é”ç«äº‰å’Œæ­»é”çš„é—®é¢˜ã€‚
é”ç«äº‰ä¼šå¯¼è‡´çº¿ç¨‹é˜»å¡ï¼Œé™ä½ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½ã€‚
è¿‡å¤šçš„é”ç«äº‰å¯èƒ½ä¼šå¯¼è‡´ä¼˜å…ˆçº§åè½¬å’Œæ­»é”ç­‰é—®é¢˜ã€‚
å› æ­¤ï¼Œå¿…é¡»åœ¨è®¾è®¡æ—¶å¯¹é”çš„ç²’åº¦å’ŒæŒæœ‰æ—¶é—´è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚

### 3.5 ä½¿ç”¨ PoisonError å¤„ç†æ¯’åŒ–é”

å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶å‘ç”Ÿ `panic`ï¼Œé”ä¼šè¢«æ ‡è®°ä¸ºâ€œä¸­æ¯’â€ã€‚
åç»­å°è¯•è·å–è¯¥é”çš„æ“ä½œä¼šè¿”å›ä¸€ä¸ª `PoisonError`ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨ä¸ç»æ„é—´è®¿é—®åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

#### 5.5.1 ç¤ºä¾‹ä»£ç ï¼šå¤„ç†æ¯’åŒ–é”

```rust
use std::sync::{Arc, Mutex};
use std::thread;

fn main() {
    let lock = Arc::new(Mutex::new(0_u32));
    let lock2 = Arc::clone(&lock);

    let _ = thread::spawn(move || -> () {
        let _guard = lock2.lock().unwrap();
        panic!();
    }).join();

    let mut guard = match lock.lock() {
        Ok(guard) => guard,
        Err(poisoned) => poisoned.into_inner(),
    };

    *guard += 1;
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰é”æ—¶å‘ç”Ÿ `panic`ï¼Œåç»­å°è¯•è·å–è¯¥é”çš„æ“ä½œä¼šè¿”å›ä¸€ä¸ª `PoisonError`ï¼Œå¯ä»¥é€šè¿‡ `into_inner` æ–¹æ³•è·å–é”çš„å†…éƒ¨å€¼ã€‚

### 3.6 æ€»ç»“

- **ä½¿ç”¨ `Mutex` æˆ– `RwLock`**ï¼šç¡®ä¿åœ¨ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«æ•°æ®ï¼Œé˜²æ­¢æ•°æ®ç«äº‰ã€‚
- **ä½¿ç”¨ `Arc`**ï¼šå®ç°å¤šçº¿ç¨‹ä¹‹é—´çš„å®‰å…¨å…±äº«ã€‚
- **å¤„ç†é”ç«äº‰å’Œæ­»é”**ï¼šåœ¨è®¾è®¡æ—¶å¯¹é”çš„ç²’åº¦å’ŒæŒæœ‰æ—¶é—´è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚
- **å¤„ç†æ¯’åŒ–é”**ï¼šä½¿ç”¨ `PoisonError` å¤„ç†æ¯’åŒ–é”ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹è®¿é—®ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

é€šè¿‡è¿™äº›è®¾è®¡å’Œä½¿ç”¨æ–¹æ³•ï¼Œå¯ä»¥æœ‰æ•ˆåœ°åœ¨ Rust ä¸­å®ç°çº¿ç¨‹å®‰å…¨çš„å…±äº«çŠ¶æ€ï¼Œç¡®ä¿ç¨‹åºçš„å¥å£®æ€§å’Œå®‰å…¨æ€§ã€‚

åœ¨ Rust ä¸­ï¼Œçº¿ç¨‹ä¹‹é—´å…±äº«çŠ¶æ€æ—¶ï¼Œå¦‚æœå‘ç”Ÿ `panic`ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå‡ºç°æ„å¤–è¡Œä¸ºã€‚
ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œå¯ä»¥é‡‡å–ä»¥ä¸‹è®¾è®¡ç­–ç•¥å’Œåˆ©ç”¨ Rust çš„ä¿æŠ¤æ€§æœºåˆ¶ï¼š

### 3.7 è®¾è®¡ç­–ç•¥

1. **ä½¿ç”¨ `Result` å’Œ `Option` ç±»å‹**
   - ä½¿ç”¨ `Result` å’Œ `Option` ç±»å‹æ¥å¤„ç†å¯èƒ½çš„é”™è¯¯å’Œç¼ºå¤±å€¼ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ `panic`ã€‚
   - ä¾‹å¦‚ï¼Œä½¿ç”¨ `Result` æ¥å¤„ç†æ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰æ“ä½œï¼Œè¿”å› `Err` è€Œä¸æ˜¯ `panic`ã€‚

2. **é¿å…åœ¨å…±äº«çŠ¶æ€ä¸­ä½¿ç”¨ `panic`**
   - åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå°½é‡é¿å…åœ¨å…±äº«çŠ¶æ€çš„ä¸´ç•ŒåŒºä¸­ä½¿ç”¨ `panic`ã€‚å¦‚æœéœ€è¦å¤„ç†é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ `Result` æˆ– `Option` ç±»å‹æ¥ä¼ é€’é”™è¯¯ä¿¡æ¯ã€‚
   - ä¾‹å¦‚ï¼Œä½¿ç”¨ `Mutex` æˆ– `RwLock` æ¥ä¿æŠ¤å…±äº«çŠ¶æ€ï¼Œå¹¶åœ¨è®¿é—®æ—¶æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–é”ã€‚

3. **ä½¿ç”¨ `catch_unwind` æ•è· `panic`**
   - ä½¿ç”¨ `std::panic::catch_unwind` æ¥æ•è· `panic`ï¼Œé˜²æ­¢ `panic` ä¼ æ’­åˆ°å…¶ä»–çº¿ç¨‹ã€‚
   - ä¾‹å¦‚ï¼Œåœ¨å¯èƒ½å‘ç”Ÿ `panic` çš„çº¿ç¨‹ä¸­ä½¿ç”¨ `catch_unwind` æ¥æ•è·é”™è¯¯ï¼Œå¹¶è¿”å›ä¸€ä¸ªé»˜è®¤å€¼æˆ–é”™è¯¯ä¿¡æ¯ã€‚

4. **é¿å…åœ¨ `main` çº¿ç¨‹ä¸­å¤„ç†è¿‡å¤šä»»åŠ¡**
   - å°†ä»»åŠ¡åˆ†é…åˆ°å­çº¿ç¨‹ä¸­ï¼Œé¿å… `main` çº¿ç¨‹å›  `panic` è€Œç»ˆæ­¢æ•´ä¸ªç¨‹åºã€‚
   - ä¾‹å¦‚ï¼Œå°†æ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰ä»»åŠ¡åˆ†é…åˆ°å­çº¿ç¨‹ä¸­ï¼Œå³ä½¿å­çº¿ç¨‹å‘ç”Ÿ `panic`ï¼Œä¹Ÿä¸ä¼šå½±å“ `main` çº¿ç¨‹ã€‚

### 3.8 Rust çš„ä¿æŠ¤æ€§æœºåˆ¶

1. **ç±»å‹ç³»ç»Ÿå’Œæ‰€æœ‰æƒæœºåˆ¶**
   - Rust çš„ç±»å‹ç³»ç»Ÿå’Œæ‰€æœ‰æƒæœºåˆ¶ç¡®ä¿äº†å†…å­˜å®‰å…¨ï¼Œé˜²æ­¢äº†æ•°æ®ç«äº‰å’Œç©ºæŒ‡é’ˆç­‰é—®é¢˜ã€‚
   - ä¾‹å¦‚ï¼Œ`Mutex` å’Œ `RwLock` ç­‰åŒæ­¥åŸè¯­é€šè¿‡ç±»å‹ç³»ç»Ÿç¡®ä¿äº†çº¿ç¨‹å®‰å…¨ã€‚

2. **`Result` å’Œ `Option` ç±»å‹**
   - `Result` å’Œ `Option` ç±»å‹ç”¨äºå¤„ç†å¯èƒ½çš„é”™è¯¯å’Œç¼ºå¤±å€¼ï¼Œé¿å…äº†ç›´æ¥ä½¿ç”¨ `panic`ã€‚
   - ä¾‹å¦‚ï¼Œ`Result` ç±»å‹å¯ä»¥ç”¨äºå¤„ç†æ–‡ä»¶è¯»å–ã€ç½‘ç»œè¯·æ±‚ç­‰æ“ä½œï¼Œè¿”å› `Err` è€Œä¸æ˜¯ `panic`ã€‚

3. **`catch_unwind`**
   - `std::panic::catch_unwind` å¯ä»¥æ•è· `panic`ï¼Œé˜²æ­¢ `panic` ä¼ æ’­åˆ°å…¶ä»–çº¿ç¨‹ã€‚
   - ä¾‹å¦‚ï¼Œåœ¨å¯èƒ½å‘ç”Ÿ `panic` çš„çº¿ç¨‹ä¸­ä½¿ç”¨ `catch_unwind` æ¥æ•è·é”™è¯¯ï¼Œå¹¶è¿”å›ä¸€ä¸ªé»˜è®¤å€¼æˆ–é”™è¯¯ä¿¡æ¯ã€‚

4. **`PanicInfo` å’Œ `panic_hook`**
   - `PanicInfo` æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ŒåŒ…å«äº† `panic` çš„ä½ç½®å’Œä¿¡æ¯ã€‚
   - `panic_hook` æ˜¯ä¸€ä¸ªé’©å­å‡½æ•°ï¼Œå¯ä»¥åœ¨ `panic` å‘ç”Ÿæ—¶æ‰§è¡Œè‡ªå®šä¹‰çš„æ“ä½œï¼Œå¦‚é‡Šæ”¾ç‰¹å®šèµ„æºæˆ–æ˜¾ç¤ºé”™è¯¯å¼¹çª—ã€‚

5. **`Mutex` å’Œ `RwLock` çš„æ¯’åŒ–æœºåˆ¶**
   - å¦‚æœä¸€ä¸ªçº¿ç¨‹åœ¨æŒæœ‰ `Mutex` æˆ– `RwLock` æ—¶å‘ç”Ÿ `panic`ï¼Œé”ä¼šè¢«æ ‡è®°ä¸ºâ€œä¸­æ¯’â€ã€‚
   - åç»­å°è¯•è·å–è¯¥é”çš„æ“ä½œä¼šè¿”å›ä¸€ä¸ª `PoisonError`ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨ä¸ç»æ„é—´è®¿é—®åˆ°ä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

### 3.9 ç¤ºä¾‹

#### 9.9.1 ä½¿ç”¨ catch_unwind æ•è· panic

```rust
use std::panic;

fn main() {
    let result = panic::catch_unwind(|| {
        let data = Some(42);
        data.unwrap_or_else(|| panic!("No data found"));
    });

    match result {
        Ok(value) => println!("Value: {}", value),
        Err(_) => println!("An error occurred"),
    }
}
```

#### 9.9.2 ä½¿ç”¨ Mutex å’Œ PoisonError

```rust
use std::sync::{Mutex, PoisonError};
use std::thread;

fn main() {
    let data = Mutex::new(42);
    let data_clone = data.clone();

    let handle = thread::spawn(move || {
        let mut num = data_clone.lock().unwrap();
        *num = 43;
    });

    match handle.join() {
        Ok(_) => println!("Thread finished"),
        Err(_) => println!("Thread panicked"),
    }

    match data.lock() {
        Ok(num) => println!("Data: {}", *num),
        Err(PoisonError { .. }) => println!("Mutex is poisoned"),
    }
}
```

### 3.10 æ€»ç»“

- **è®¾è®¡ç­–ç•¥**ï¼šä½¿ç”¨ `Result` å’Œ `Option` ç±»å‹å¤„ç†é”™è¯¯ï¼Œé¿å…åœ¨å…±äº«çŠ¶æ€ä¸­ä½¿ç”¨ `panic`ï¼Œä½¿ç”¨ `catch_unwind` æ•è· `panic`ï¼Œé¿å…åœ¨ `main` çº¿ç¨‹ä¸­å¤„ç†è¿‡å¤šä»»åŠ¡ã€‚
- **ä¿æŠ¤æ€§æœºåˆ¶**ï¼šRust çš„ç±»å‹ç³»ç»Ÿå’Œæ‰€æœ‰æƒæœºåˆ¶ã€`Result` å’Œ `Option` ç±»å‹ã€`catch_unwind`ã€`PanicInfo` å’Œ `panic_hook`ã€`Mutex` å’Œ `RwLock` çš„æ¯’åŒ–æœºåˆ¶ç­‰ï¼Œéƒ½ä¸ºçº¿ç¨‹å®‰å…¨å’Œé”™è¯¯å¤„ç†æä¾›äº†å¼ºå¤§çš„æ”¯æŒã€‚

é€šè¿‡è¿™äº›è®¾è®¡ç­–ç•¥å’Œä¿æŠ¤æ€§æœºåˆ¶ï¼Œå¯ä»¥æœ‰æ•ˆåœ°é¿å…çº¿ç¨‹é—´å…±äº«çŠ¶æ€æ—¶å›  `panic` å¯¼è‡´çš„æ„å¤–è¡Œä¸ºï¼Œç¡®ä¿ç¨‹åºçš„å¥å£®æ€§å’Œå®‰å…¨æ€§ã€‚

åœ¨ Rust ä¸­ï¼Œå½“ç¨‹åºè§¦å‘ `panic` æ—¶ï¼Œä¼šå‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š

### 3.11 çº¿ç¨‹å–æ¶ˆThread Cancellation

å½“ä¸€ä¸ªçº¿ç¨‹ä¸­å‡ºç° `panic` ä¸”æœªè¢«æ•è·æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼š**å¼€å§‹å–æ¶ˆ**ã€‚
å–æ¶ˆè¿‡ç¨‹ä¼šè§¦å‘èµ„æºçš„æ¸…ç†ï¼Œé€šè¿‡è°ƒç”¨ `drop` æ–¹æ³•é‡Šæ”¾æ‰€æœ‰ç›¸å…³èµ„æºï¼ˆå¦‚åˆ†é…çš„å†…å­˜ã€æ–‡ä»¶å¥æŸ„ç­‰ï¼‰ã€‚
ä¾‹å¦‚ï¼š

```rust
fn main() {
    let handle = std::thread::spawn(|| {
        let data = Box::new("hello"); // åˆ†é…å†…å­˜
        panic!("Something went wrong!"); // è§¦å‘ panic
    });

    handle.join().unwrap();
    println!("This line may not execute.");
}
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ`panic` ä¼šå¯¼è‡´çº¿ç¨‹ç«‹å³å–æ¶ˆï¼Œå¹¶åœ¨å–æ¶ˆè¿‡ç¨‹ä¸­è°ƒç”¨ `data` çš„ `drop` æ–¹æ³•é‡Šæ”¾å†…å­˜ã€‚

### 3.12 å †æ ˆå±•å¼€Stack Unwinding

`panic` ä¼š**è§¦å‘å †æ ˆå±•å¼€**ï¼Œå³ä» `panic` å‘ç”Ÿçš„ä½ç½®å¼€å§‹ï¼Œä¾æ¬¡å¼¹å‡ºå‡½æ•°è°ƒç”¨æ ˆï¼Œé‡Šæ”¾æ‰€æœ‰å·²åˆ†é…çš„èµ„æºã€‚
è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºå…¶ä»–è¯­è¨€ä¸­çš„å¼‚å¸¸ä¼ æ’­ã€‚
å †æ ˆå±•å¼€ä¼šæ‰§è¡Œæ‰€æœ‰å˜é‡çš„ `drop` æ–¹æ³•ï¼Œç¡®ä¿èµ„æºèƒ½å¤Ÿå¾—åˆ°é€‚å½“çš„æ¸…ç†ã€‚
**æ³¨æ„**ï¼šå¦‚æœä½ ä½¿ç”¨äº† `#![feature(panic_implementation)]` æˆ–æŸäº›ç‰¹æ®Šçš„ç¼–è¯‘å™¨æ ‡å¿—ï¼ˆå¦‚ `panic = "abort"`ï¼‰ï¼Œå †æ ˆå¯èƒ½ä¸ä¼šå±•å¼€ã€‚

### 3.13 ç¨‹åºç»ˆæ­¢

å¦‚æœ `panic` å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ•è·ï¼Œç¨‹åºå°†**ç»ˆæ­¢**ã€‚
ç»ˆæ­¢æ—¶ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ï¼ˆé€šå¸¸æ˜¯ `101`ï¼Œè¡¨ç¤ºç¨‹åºå› å¼‚å¸¸è€Œé€€å‡ºï¼‰ã€‚
è¿è¡Œæ—¶ä¼šæ‰“å°ä¸€æ¡æ¶ˆæ¯ï¼Œç±»ä¼¼ï¼š

```text
thread 'main' panicked at 'explicit panic', src/main.rs:3:5
```

å¦‚æœ `panic` æ˜¯ç”±äºæœªå¤„ç†çš„é”™è¯¯ï¼ˆå¦‚ `unwrap` æˆ– `expect`ï¼‰å¼•èµ·çš„ã€‚

### 3.14 è·¨çº¿ç¨‹å½±å“

å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸­å‘ç”Ÿ `panic`ï¼Œä¸ä¼šç«‹å³å½±å“å…¶ä»–çº¿ç¨‹ï¼Œå› ä¸º Rust çš„çº¿ç¨‹é»˜è®¤æ˜¯ç‹¬ç«‹çš„ã€‚
ä½†æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹ä¾èµ–äºå¦ä¸€ä¸ªçº¿ç¨‹çš„ç»“æœï¼Œæˆ–è€…çº¿ç¨‹ä¹‹é—´å…±äº«çŠ¶æ€ï¼Œ`panic` å¯èƒ½ä¼šå¯¼è‡´ç¨‹åºå‡ºç°æ„å¤–è¡Œä¸ºã€‚

### 3.15 å¦‚ä½•æ•è· panic

å¯ä»¥ä½¿ç”¨ `std::panic::catch_unwind` æ•è· `panic`ï¼Œä»è€Œé¿å…ç¨‹åºç»ˆæ­¢ã€‚

```rust
use std::panic;

fn main() {
    let result = panic::catch_unwind(|| {
        println!("Starting the operation...");
        panic!("An error occurred!");
        println!("This line will not execute.");
    });

    match result {
        Ok(()) => println!("Operation completed successfully."),
        Err(err) => println!("Operation failed with panic: {:?}", err),
    }

    println!("Program continues after handling the panic.");
}
```

è¾“å‡ºï¼š

```text
Starting the operation...
Operation failed with panic: Any
Program continues after handling the panic.
```

### 3.16 -æ€»ç»“-

- **`panic` ä¼šå¯¼è‡´çº¿ç¨‹å–æ¶ˆ**ï¼Œèµ„æºä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼ˆè°ƒç”¨ `drop` æ–¹æ³•ï¼‰ã€‚
- **ä¸»çº¿ç¨‹ä¸­çš„ `panic` ä¼šå¯¼è‡´ç¨‹åºç»ˆæ­¢**ï¼Œè€Œå…¶ä»–çº¿ç¨‹çš„ `panic` ä¸ä¼šç«‹å³å½±å“ä¸»çº¿ç¨‹ã€‚
- å¯ä»¥ä½¿ç”¨ `catch_unwind` æ•è· `panic`ï¼Œä»¥ä¾¿ç¨‹åºåœ¨ `panic` åç»§ç»­æ‰§è¡Œã€‚
- å½“ `panic` æ—¶ï¼Œè¿è¡Œæ—¶ä¼šå°è¯•ä¼˜é›…åœ°æ¸…ç†èµ„æºï¼Œç¡®ä¿ç¨‹åºçŠ¶æ€çš„ä¸€è‡´æ€§ã€‚
- å¦‚æœç¨‹åºæ— æ³•æ¢å¤ï¼Œåº”è¯¥æ˜¾å¼åœ°å¤„ç† `Result` å’Œ `Option` ç±»å‹ï¼Œé¿å…ä¸å¿…è¦çš„ `panic`ã€‚

ç†è§£ Rust ä¸­çš„ `panic` è¡Œä¸ºæœ‰åŠ©äºç¼–å†™æ›´å¥å£®å’Œå®¹é”™çš„ç¨‹åºã€‚
åœ¨ Rust ä¸­ï¼Œ`panic` å‘ç”Ÿçš„åŸå› é€šå¸¸æ˜¯ç”±äºç¨‹åºè¿è¡Œæ—¶å‡ºç°äº†æ— æ³•æ¢å¤çš„é”™è¯¯ï¼Œæ¯”å¦‚æœªå¤„ç†çš„ `unwrap` æˆ–å¯¹ `None` çš„è§£å¼•ç”¨ç­‰ã€‚
ä¸ºäº†é¿å… `panic`ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š

### 3.17 ä½¿ç”¨ Result å’Œ Option

Rust æä¾›äº† `Result` å’Œ `Option` ç±»å‹ï¼Œç”¨äºå¤„ç†å¯èƒ½å¤±è´¥çš„æ“ä½œã€‚é€šè¿‡æ˜ç¡®çš„é”™è¯¯å¤„ç†ï¼Œå¯ä»¥é¿å…ç¨‹åºè¿›å…¥ `panic` çŠ¶æ€ã€‚

#### 17.17.1 ä½¿ç”¨ Result å¤„ç†é”™è¯¯

```rust
use std::fs::File;
use std::io::{self, Read};

fn read_file() -> Result<String, io::Error> {
    let mut file = File::open("config.txt")?; // ä½¿ç”¨ `?` ä¼ æ’­é”™è¯¯
    let mut contents = String::new();
    file.read_to_string(&mut contents)?;
    Ok(contents)
}

fn main() {
    match read_file() {
        Ok(contents) => println!("File contents: {}", contents),
        Err(e) => eprintln!("Error occurred: {}", e),
    }
}
```

**è§£é‡Šï¼š**

- ä½¿ç”¨ `Result` å¯ä»¥æ˜ç¡®åŒºåˆ†æˆåŠŸå’Œå¤±è´¥ä¸¤ç§æƒ…å†µã€‚
- `?` æ“ä½œç¬¦ä¼šè‡ªåŠ¨ä¼ æ’­é”™è¯¯ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œä¼šè¿”å›ä¸€ä¸ª `Err`ï¼Œè€Œä¸æ˜¯ `panic`ã€‚

#### 17.17.2 ä½¿ç”¨ Option å¤„ç†å¯èƒ½ç¼ºå¤±çš„å€¼

```rust
fn get_optional_value() -> Option<i32> {
    Some(42)
    // æˆ–è®¸æœ‰æ—¶ä¼šè¿”å› None
    // None
}

fn main() {
    let value = get_optional_value().unwrap_or(10); // æä¾›é»˜è®¤å€¼
    println!("Value: {}", value);
}
```

**è§£é‡Šï¼š**

- ä½¿ç”¨ `Option` å¤„ç†å¯èƒ½ç¼ºå¤±çš„å€¼ã€‚
- `unwrap_or` æ–¹æ³•ä¼šåœ¨å€¼ä¸º `None` æ—¶æä¾›ä¸€ä¸ªé»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯ `panic`ã€‚

### 3.18 é¿å…ç›´æ¥è°ƒç”¨ unwrap å’Œ expect

ç›´æ¥è°ƒç”¨ `unwrap` å’Œ `expect` ä¼šå¯¼è‡´ç¨‹åºåœ¨å€¼ä¸º `None` æˆ– `Err` æ—¶ `panic`ã€‚ä¾‹å¦‚ï¼š

```rust
let value = Some(42).unwrap(); // æ­£å¸¸
let value = None.unwrap();     // ä¼šå¯¼è‡´ panic
```

**æ›¿ä»£æ–¹æ³•ï¼šä½¿ç”¨ `match` æˆ– `if let`**

```rust
fn main() {
    let optional_value = Some(42);
    if let Some(v) = optional_value {
        println!("Value: {}", v);
    } else {
        println!("No value found");
    }
}
```

#### 18.18.1 ä½¿ç”¨ if let å¤„ç† Option

```rust
if let Some(value) = get_optional_value() {
    println!("Got a value: {}", value);
} else {
    println!("No value found");
}
```

#### 18.18.2 ä½¿ç”¨ match å¤„ç† Result

```rust
match read_file() {
    Ok(contents) => println!("File contents: {}", contents),
    Err(e) => eprintln!("Error occurred: {}", e),
}
```

### 3.19 å•å…ƒæµ‹è¯•å’Œæ¨¡ç³Šæµ‹è¯•

é€šè¿‡å•å…ƒæµ‹è¯•å’Œæ¨¡ç³Šæµ‹è¯•å¯ä»¥æå‰å‘ç°æ½œåœ¨çš„é”™è¯¯ï¼Œç¡®ä¿ä»£ç çš„é²æ£’æ€§ã€‚

#### 19.19.1 å•å…ƒæµ‹è¯•

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_read_file_success() {
        let contents = read_file().unwrap();
        assert_eq!(contents, "Expected file contents");
    }

    #[test]
    #[should_panic(expected = "No such file or directory")]
    fn test_read_file_failure() {
        let contents = read_file().unwrap(); // åœ¨æµ‹è¯•å¤±è´¥æ—¶é¢„æœŸ panic
    }
}
```

#### 19.19.2 æ¨¡ç³Šæµ‹è¯•ä½¿ç”¨ libfuzzer-sys

```rust
#![no_main]

use libfuzzer_sys::fuzz_target;

fuzz_target!(|data: &[u8]| {
    let s = String::from_utf8_lossy(data);
    // æ¨¡ç³Šæµ‹è¯•ä»£ç 
    println!("{}", s);
});
```

### 3.20 ä½¿ç”¨å°è£…å’ŒæŠ½è±¡

é€šè¿‡å°è£…å’ŒæŠ½è±¡ï¼Œå¯ä»¥éšè—é”™è¯¯å¤„ç†çš„ç»†èŠ‚ï¼Œé¿å…ä¸å¿…è¦çš„ `panic`ã€‚

#### 20.20.1 å°è£…æ–‡ä»¶è¯»å–é€»è¾‘

```rust
fn read_config_key(key: &str) -> Option<String> {
    let file_contents = match read_file() {
        Ok(contents) => contents,
        Err(_) => return None,
    };
    // è§£æé…ç½®æ–‡ä»¶å¹¶æå–é”®å€¼
    Some("parsed_value".to_string())
}

fn main() {
    let value = read_config_key("name").unwrap_or("default".to_string());
    println!("Value: {}", value);
}
```

### 3.21 ä½¿ç”¨é˜²å¾¡æ€§ç¼–ç¨‹

åœ¨ä»£ç ä¸­åŠ å…¥é˜²å¾¡æ€§æ£€æŸ¥ï¼Œç¡®ä¿è¾“å…¥çš„æœ‰æ•ˆæ€§ï¼Œé¿å…æ½œåœ¨çš„é”™è¯¯ã€‚

#### 21.21.1 é˜²å¾¡æ€§æ£€æŸ¥ç¤ºä¾‹

```rust
fn divide(a: i32, b: i32) -> Option<i32> {
    if b == 0 {
        None // é¿å…é™¤é›¶é”™è¯¯
    } else {
        Some(a / b)
    }
}

fn main() {
    let result = divide(10, 0);
    if let None = result {
        println!("Division by zero occurred");
    } else {
        println!("Result: {}", result.unwrap());
    }
}
```

### 3.22 ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆ

Rust çš„æ™ºèƒ½æŒ‡é’ˆï¼ˆå¦‚ `RefCell` å’Œ `Mutex`ï¼‰å¯ä»¥æä¾›é¢å¤–çš„å®‰å…¨ä¿éšœï¼Œé¿å…æ•°æ®ç«äº‰å’Œç©ºæŒ‡é’ˆç­‰é—®é¢˜ã€‚

#### 22.22.1 ä½¿ç”¨ RefCell

```rust
use std::cell::RefCell;

struct Data {
    value: RefCell<i32>,
}

fn increment(data: &Data) {
    *data.value.borrow_mut() += 1;
}

fn main() {
    let data = Data { value: RefCell::new(10) };
    increment(&data);
    println!("Value: {}", data.value.borrow());
}
```

### 3.23 å®¡æŸ¥ç¬¬ä¸‰æ–¹ä¾èµ–

ç¡®ä¿ä½¿ç”¨çš„ç¬¬ä¸‰æ–¹åº“æ˜¯å®‰å…¨çš„ï¼Œé¿å…å¼•å…¥æ½œåœ¨çš„ `panic` é£é™©ã€‚

#### 23.23.1 å®¡æŸ¥ä¾èµ–çš„ Cargotoml

```toml
[dependencies]
serde = "1.0"
tokio = { version = "1.0", features = ["full"] }
```

### 3.24 -æ€»ç»“

é¿å… `panic` çš„å…³é”®æ˜¯é‡‡ç”¨å®‰å…¨çš„ç¼–ç¨‹å®è·µï¼Œå¦‚ä½¿ç”¨ `Result` å’Œ `Option`ã€é¿å…ç›´æ¥è°ƒç”¨ `unwrap` å’Œ `expect`ã€ç¼–å†™å•å…ƒæµ‹è¯•å’Œä½¿ç”¨å°è£…ç­‰ã€‚
é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥ç¡®ä¿ä»£ç æ›´åŠ é²æ£’å’Œå®‰å…¨ã€‚

### 3.25 Rust é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•

åœ¨ Rust ä¸­ï¼Œé”™è¯¯å¤„ç†æ˜¯é€šè¿‡ `Result` å’Œ `Option` ç±»å‹æ¥å®ç°çš„ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•ï¼š

### 3.26 unwrap_or çš„è§£é‡Šå’Œç¤ºä¾‹

#### 26.26.1 è§£é‡Š

`unwrap_or` æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¤„ç† `Option` ç±»å‹çš„å€¼ã€‚å½“ `Option` çš„å€¼ä¸º `Some` æ—¶ï¼Œ`unwrap_or` ä¼šè¿”å›è¯¥å€¼ï¼›
å½“å€¼ä¸º `None` æ—¶ï¼Œ`unwrap_or` ä¼šè¿”å›ä¸€ä¸ªé»˜è®¤å€¼ã€‚

#### 26.26.2 -ç¤ºä¾‹

```rust
fn get_config_value() -> Option<String> {
    // æ¨¡æ‹Ÿä»é…ç½®æ–‡ä»¶è¯»å–å€¼
    Some("value".to_string())
    // æˆ–è€…æœ‰æ—¶å¯èƒ½è¿”å› None
    // None
}

fn main() {
    let config_value = get_config_value().unwrap_or("default_value".to_string());
    println!("Config value is: {}", config_value);
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`get_config_value` å‡½æ•°è¿”å›ä¸€ä¸ª `Option<String>`ã€‚å¦‚æœå‡½æ•°è¿”å› `Some("value")`ï¼Œ`unwrap_or` ä¼šè¿”å› `"value"`ï¼›
å¦‚æœè¿”å› `None`ï¼Œ`unwrap_or` ä¼šè¿”å› `"default_value"`ã€‚

### 3.27 unwrap_or_else çš„è§£é‡Šå’Œç¤ºä¾‹

#### 27.27.1 -è§£é‡Š

`unwrap_or_else` æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¤„ç† `Option` ç±»å‹çš„å€¼ã€‚
å½“ `Option` çš„å€¼ä¸º `Some` æ—¶ï¼Œ`unwrap_or_else` ä¼šè¿”å›è¯¥å€¼ï¼›
å½“å€¼ä¸º `None` æ—¶ï¼Œ`unwrap_or_else` ä¼šè°ƒç”¨ä¸€ä¸ªé—­åŒ…æ¥ç”Ÿæˆä¸€ä¸ªé»˜è®¤å€¼ã€‚

#### 27.27.2 --ç¤ºä¾‹

```rust
fn get_data_from_system() -> Option<String> {
    // æ¨¡æ‹Ÿä»ç³»ç»Ÿè·å–æ•°æ®
    Some("Data from system".to_string())
}

fn main() {
    let data = get_data_from_system().unwrap_or_else(|| {
        println!("Failed to get data from system, using default data.");
        "default_data".to_string()
    });
    
    println!("Data: {}", data);
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`get_data_from_system` å‡½æ•°è¿”å›ä¸€ä¸ª `Option<String>`ã€‚
å¦‚æœå‡½æ•°è¿”å› `Some("Data from system")`ï¼Œ`unwrap_or_else` ä¼šè¿”å› `"Data from system"`ï¼›
å¦‚æœè¿”å› `None`ï¼Œ`unwrap_or_else` ä¼šè°ƒç”¨é—­åŒ…ç”Ÿæˆ `"default_data"`ã€‚

### 3.28 match çš„è§£é‡Šå’Œç¤ºä¾‹

#### 28.28.1 --è§£é‡Š

`match` æ˜¯ Rust ä¸­ç”¨äºæ¨¡å¼åŒ¹é…çš„å…³é”®å­—ã€‚å®ƒç”¨äºåŒ¹é…ä¸åŒçš„å€¼æˆ–ç±»å‹ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘ã€‚

#### 28.28.2 ---ç¤ºä¾‹

```rust
fn main() {
    let config_value: Option<&str> = None;

    match config_value {
        Some(value) => println!("Found configuration value: {}", value),
        None => eprintln!("No configuration value found, using default settings."),
    }
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`config_value` æ˜¯ä¸€ä¸ª `Option<&str>`ã€‚`match` è¡¨è¾¾å¼ä¼šæ£€æŸ¥ `config_value` çš„å€¼ï¼Œå¦‚æœå®ƒæ˜¯ `Some(value)`ï¼Œåˆ™æ‰“å° `value`ï¼›å¦‚æœå®ƒæ˜¯ `None`ï¼Œåˆ™æ‰“å°é”™è¯¯æ¶ˆæ¯ã€‚

### 3.29 unwrap çš„è§£é‡Šå’Œç¤ºä¾‹

#### 29.29.1 ---è§£é‡Š

`unwrap` æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¤„ç† `Option` å’Œ `Result` ç±»å‹çš„å€¼ã€‚å½“å€¼ä¸º `Some` æˆ– `Ok` æ—¶ï¼Œ`unwrap` ä¼šè¿”å›è¯¥å€¼ï¼›å½“å€¼ä¸º `None` æˆ– `Err` æ—¶ï¼Œ`unwrap` ä¼šå¼•å‘ panicã€‚

#### 29.29.2 ---ç¤ºä¾‹-

```rust
fn get_config_value() -> Option<String> {
    Some("value".to_string())
}

fn main() {
    let value = get_config_value().unwrap();
    println!("Configuration value is: {}", value);
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`get_config_value` å‡½æ•°è¿”å›ä¸€ä¸ª `Option<String>`ã€‚å¦‚æœå‡½æ•°è¿”å› `Some("value")`ï¼Œ`unwrap` ä¼šè¿”å› `"value"`ï¼›å¦‚æœè¿”å› `None`ï¼Œ`unwrap` ä¼šå¼•å‘ panicã€‚

### 3.30 expect çš„è§£é‡Šå’Œç¤ºä¾‹

#### 30.30.1 ----è§£é‡Š

`expect` æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºå¤„ç† `Option` å’Œ `Result` ç±»å‹çš„å€¼ã€‚ä¸ `unwrap` ç±»ä¼¼ï¼Œå½“å€¼ä¸º `Some` æˆ– `Ok` æ—¶ï¼Œ`expect` ä¼šè¿”å›è¯¥å€¼ï¼›å½“å€¼ä¸º `None` æˆ– `Err` æ—¶ï¼Œ`expect` ä¼šå¼•å‘ panicï¼Œå¹¶é™„å¸¦ä¸€æ¡è‡ªå®šä¹‰çš„é”™è¯¯æ¶ˆæ¯ã€‚

#### 30.30.2 ----ç¤ºä¾‹

```rust
fn get_config_value() -> Option<String> {
    None
}

fn main() {
    let value = get_config_value().expect("Failed to get configuration value");
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`get_config_value` å‡½æ•°è¿”å›ä¸€ä¸ª `Option<String>`ã€‚å¦‚æœå‡½æ•°è¿”å› `Some("value")`ï¼Œ`expect` ä¼šè¿”å› `"value"`ï¼›å¦‚æœè¿”å› `None`ï¼Œ`expect` ä¼šå¼•å‘ panicï¼Œå¹¶æ‰“å° `"Failed to get configuration value"`ã€‚

### 3.31 Result çš„é”™è¯¯å¤„ç†æƒ¯ç”¨æ³•

#### 31.31.1 ----ç¤ºä¾‹--

```rust
use std::fs::File;
use std::io;
use std::io::Read;

fn read_file(file_path: &str) -> Result<String, io::Error> {
    let mut file = File::open(file_path)?;
    let mut contents = String::new();
    file.read_to_string(&mut contents)?;
    Ok(contents)
}

fn main() {
    match read_file("config.txt") {
        Ok(contents) => println!("File contents: {}", contents),
        Err(err) => eprintln!("Error reading file: {}", err),
    }
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œ`read_file` å‡½æ•°è¿”å›ä¸€ä¸ª `Result<String, io::Error>`ã€‚
`main` å‡½æ•°ä¸­çš„ `match` è¡¨è¾¾å¼ä¼šå¤„ç† `Result` çš„å€¼ï¼Œå¦‚æœè¿”å› `Ok(contents)`ï¼Œåˆ™æ‰“å°æ–‡ä»¶å†…å®¹ï¼›
å¦‚æœè¿”å› `Err(err)`ï¼Œåˆ™æ‰“å°é”™è¯¯æ¶ˆæ¯ã€‚

### 3.32 æ€»ç»“

- **`unwrap_or` å’Œ `unwrap_or_else`**ï¼šç”¨äºä¸º `Option` ç±»å‹çš„å€¼æä¾›é»˜è®¤å€¼ã€‚
- **`match`**ï¼šç”¨äºåŒ¹é…ä¸åŒçš„å€¼æˆ–ç±»å‹ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘ã€‚
- **`unwrap` å’Œ `expect`**ï¼šç”¨äºåœ¨è°ƒè¯•æ—¶å¿«é€Ÿå¤„ç†é”™è¯¯ã€‚
- **`Result`**ï¼šç”¨äºå¤„ç†å¯æ¢å¤çš„é”™è¯¯ï¼Œé€šè¿‡ `?` æ“ä½œç¬¦å’Œ `match` è¡¨è¾¾å¼æ¥å¤„ç†ã€‚
