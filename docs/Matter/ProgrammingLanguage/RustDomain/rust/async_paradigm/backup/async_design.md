# Rustå¼‚æ­¥ç¼–ç¨‹è®¾è®¡æƒè¡¡

ä»¥ä¸‹æ˜¯å…³äº Rust async è®¾è®¡ä¸­å¤šçº¿ç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹æƒè¡¡çš„é—®é¢˜è®¨è®ºï¼Œä»¥åŠå¦‚ä½•æ ¹æ®æ€§èƒ½éœ€æ±‚åœ¨ä¸åŒå±‚æ¬¡åšè®¾è®¡å†³ç­–çš„è¯¦ç»†è¯´æ˜ã€‚

---

## ğŸ“‹ ç›®å½•

- [1 å¤šçº¿ç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬ç‰¹ç‚¹](#1-å¤šçº¿ç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬ç‰¹ç‚¹)
  - [1.1 å¼‚æ­¥ç¼–ç¨‹asyncawait æ¨¡å‹](#11-å¼‚æ­¥ç¼–ç¨‹asyncawait-æ¨¡å‹)
  - [1.2 å¤šçº¿ç¨‹ç¼–ç¨‹](#12-å¤šçº¿ç¨‹ç¼–ç¨‹)
- [2 æƒè¡¡ä¸è®¾è®¡å†³ç­–çš„å„ä¸ªå±‚æ¬¡](#2-æƒè¡¡ä¸è®¾è®¡å†³ç­–çš„å„ä¸ªå±‚æ¬¡)
  - [2.1 ä»»åŠ¡ç±»å‹åˆ†æ](#21-ä»»åŠ¡ç±»å‹åˆ†æ)
  - [2.2 ä»»åŠ¡åˆ‡æ¢ä¸è°ƒåº¦å¼€é”€](#22-ä»»åŠ¡åˆ‡æ¢ä¸è°ƒåº¦å¼€é”€)
  - [2.3 æ•°æ®å…±äº«ä¸åŒæ­¥](#23-æ•°æ®å…±äº«ä¸åŒæ­¥)
  - [2.4 æ•´ä½“æ¶æ„å±‚æ¬¡å†³ç­–](#24-æ•´ä½“æ¶æ„å±‚æ¬¡å†³ç­–)
- [3 æ€§èƒ½å¹³è¡¡ä¸å†³ç­–çš„å¸¸è§æªæ–½](#3-æ€§èƒ½å¹³è¡¡ä¸å†³ç­–çš„å¸¸è§æªæ–½)
- [4 æ€ç»´å¯¼å›¾æ€»ç»“](#4-æ€ç»´å¯¼å›¾æ€»ç»“)
- [5 æ€»ç»“](#5-æ€»ç»“)
- [6 æ··åˆæ¨¡å‹è®¾è®¡æ€è·¯](#6-æ··åˆæ¨¡å‹è®¾è®¡æ€è·¯)
- [7 ç¤ºä¾‹ä»£ç ](#7-ç¤ºä¾‹ä»£ç )
  - [7.1 ä»£ç è¯´æ˜](#71-ä»£ç è¯´æ˜)
- [8 æ€ç»´å¯¼å›¾æ€»ç»“](#8-æ€ç»´å¯¼å›¾æ€»ç»“)
- [9 è®¾è®¡å»ºè®®](#9-è®¾è®¡å»ºè®®)
- [10 å·¥å…·ä¸èƒŒæ™¯](#10-å·¥å…·ä¸èƒŒæ™¯)
  - [10.1 Tokio Console ç®€ä»‹](#101-tokio-console-ç®€ä»‹)
  - [10.2 å¹¶å‘é›†æˆçš„æ„ä¹‰](#102-å¹¶å‘é›†æˆçš„æ„ä¹‰)
- [11 é›†æˆæ­¥éª¤](#11-é›†æˆæ­¥éª¤)
- [12 ç¤ºä¾‹ä»£ç ](#12-ç¤ºä¾‹ä»£ç )
  - [12.1 ä»£ç è¯´æ˜](#121-ä»£ç è¯´æ˜)
- [13 æ€ç»´å¯¼å›¾](#13-æ€ç»´å¯¼å›¾)
- [14 Async Rust ä¸­é›†æˆ Metrics](#14-async-rust-ä¸­é›†æˆ-metrics)
- [15 æ·»åŠ ä¾èµ–](#15-æ·»åŠ ä¾èµ–)
- [16 å®‰è£… Recorder å¹¶å¯åŠ¨ HTTP æœåŠ¡](#16-å®‰è£…-recorder-å¹¶å¯åŠ¨-http-æœåŠ¡)
- [17 ä»£ç è¯´æ˜](#17-ä»£ç è¯´æ˜)
- [18 è¿è¡Œä¸ç›‘æ§](#18-è¿è¡Œä¸ç›‘æ§)

---

## 1 å¤šçº¿ç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬ç‰¹ç‚¹

### 1.1 å¼‚æ­¥ç¼–ç¨‹asyncawait æ¨¡å‹

- **åä½œå¼è°ƒåº¦**  
  å¼‚æ­¥ä»»åŠ¡é€šè¿‡çŠ¶æ€æœºå’Œ `.await` æš‚åœç‚¹å®ç°åä½œå¼è°ƒåº¦ï¼Œä¸éœ€æ¯ä¸ªä»»åŠ¡å•ç‹¬å ç”¨çº¿ç¨‹ã€‚  
- **ä½å¼€é”€**  
  æ¯ä¸ª async ä»»åŠ¡ä»…ä½¿ç”¨å°‘é‡å†…å­˜ï¼Œä¸éœ€è¦ä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…æ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œé€‚åˆ I/O å¯†é›†å‹åœºæ™¯ã€‚  
- **äº‹ä»¶é©±åŠ¨**  
  å¼‚æ­¥è¿è¡Œæ—¶ï¼ˆå¦‚ Tokioï¼‰çš„äº‹ä»¶å¾ªç¯åè°ƒä»»åŠ¡æ‰§è¡Œï¼Œé€‚åˆå¤„ç†å¤§é‡å¹¶å‘ç½‘ç»œ I/O æˆ–æ–‡ä»¶ I/O æ“ä½œã€‚

### 1.2 å¤šçº¿ç¨‹ç¼–ç¨‹

- **æŠ¢å å¼è°ƒåº¦**  
  å¤šçº¿ç¨‹èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼Œé€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œé€šè¿‡æ“ä½œç³»ç»Ÿè°ƒåº¦æ¥å……åˆ†åˆ†é… CPU æ—¶é—´ã€‚  
- **è¾ƒé«˜çš„èµ„æºå¼€é”€**  
  æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å›ºå®šæ ˆç©ºé—´ï¼Œå¤šçº¿ç¨‹æ•°é‡è¿‡å¤šå¯èƒ½å¢åŠ å†…å­˜å¼€é”€å’Œè°ƒåº¦æˆæœ¬ã€‚  
- **é˜»å¡æ“ä½œå‹å¥½**  
  å¯¹äºåŒæ­¥é˜»å¡è°ƒç”¨ã€å¤š CPU è¿ç®—åœºæ™¯ï¼Œå¤šçº¿ç¨‹æ¨¡å‹è¾ƒæ˜“å®ç°å’Œè°ƒè¯•ã€‚

---

## 2 æƒè¡¡ä¸è®¾è®¡å†³ç­–çš„å„ä¸ªå±‚æ¬¡

åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå¸¸å¸¸éœ€è¦åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢åšå‡ºæƒè¡¡å’Œè®¾è®¡å†³ç­–ï¼š

### 2.1 ä»»åŠ¡ç±»å‹åˆ†æ

- **I/O å¯†é›†å‹**  
  å¦‚æœä¸»è¦æ˜¯ç½‘ç»œã€æ–‡ä»¶æˆ–æ•°æ®åº“ I/Oï¼Œæ­¤æ—¶å¤§å¤šæ•°ä»»åŠ¡å¤„äºç­‰å¾…çŠ¶æ€ï¼Œä½¿ç”¨ async ç¼–ç¨‹èƒ½é«˜æ•ˆåˆ©ç”¨å•ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ï¼Œå€ŸåŠ©äº‹ä»¶å¾ªç¯å¤„ç†æˆåƒä¸Šä¸‡çš„å¹¶å‘è¿æ¥ã€‚  
- **CPU å¯†é›†å‹**  
  å¯¹äºéœ€è¦å¤§é‡ CPU è¿ç®—çš„ä»»åŠ¡ï¼Œå•çº¯çš„ async è°ƒç”¨å¯èƒ½ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ï¼Œæ­¤æ—¶åº”é‡‡ç”¨å¤šçº¿ç¨‹ï¼ˆä¾‹å¦‚åˆ©ç”¨ Tokio çš„ `spawn_blocking` æˆ–ç‹¬ç«‹çº¿ç¨‹æ± ï¼‰æ¥åˆ†æ•£è´Ÿè½½ã€‚

### 2.2 ä»»åŠ¡åˆ‡æ¢ä¸è°ƒåº¦å¼€é”€

- **å¼‚æ­¥ä¸Šä¸‹æ–‡åˆ‡æ¢**  
  å°½ç®¡ async ä»»åŠ¡åˆ‡æ¢å¼€é”€æ¯”æ“ä½œç³»ç»Ÿçº¿ç¨‹åˆ‡æ¢ä½ï¼Œä½†ä»»åŠ¡çŠ¶æ€æœºè½¬æ¢ä»¥åŠéšå¼ä¸Šä¸‹æ–‡ä¼ é€’ä»ä¼šæ¶ˆè€—ä¸€å®š CPU èµ„æºï¼Œå°¤å…¶å½“ä»»åŠ¡æ•°é‡æå¤§æ—¶éœ€è¦å°å¿ƒç®¡ç†ã€‚  
- **å¤šçº¿ç¨‹è°ƒåº¦å¼€é”€**  
  å¤§é‡çº¿ç¨‹å¹¶è¡Œè¿è¡Œæ—¶ï¼Œç”±äºæ“ä½œç³»ç»ŸæŠ¢å å¼è°ƒåº¦å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢å¯èƒ½å¸¦æ¥é¢å¤–å¼€é”€ï¼Œå› æ­¤åœ¨è®¾è®¡æ—¶åº”è€ƒè™‘çº¿ç¨‹æ•°ä¸è¦è¿œè¶… CPU æ ¸æ•°å¤ªå¤šã€‚

### 2.3 æ•°æ®å…±äº«ä¸åŒæ­¥

- **å¼‚æ­¥ç¯å¢ƒä¸‹çš„å…±äº«çŠ¶æ€**  
  åœ¨ async ç¯å¢ƒä¸­å…±äº«æ•°æ®é€šå¸¸ä¾èµ–äº `Arc` ä¸å¼‚æ­¥ Mutexï¼ˆæˆ– RwLockï¼‰ä¿æŠ¤ï¼Œæ³¨æ„é¿å…é”ç«äº‰å¯¼è‡´çš„è°ƒåº¦é˜»å¡ã€‚  
- **å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜**  
  å¤šçº¿ç¨‹é€šå¸¸é¢ä¸´æ›´ä¸¥æ ¼çš„ç«æ€ä¸åŒæ­¥é—®é¢˜ï¼Œéœ€è¦ç²¾å¿ƒè®¾è®¡é”çš„ç²’åº¦å’Œå¹¶è¡Œè¯»å†™ç­–ç•¥ã€‚

### 2.4 æ•´ä½“æ¶æ„å±‚æ¬¡å†³ç­–

- **æ··åˆæ¨¡å‹**  
  åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œå¸¸å¸¸é‡‡ç”¨æ··åˆæ¶æ„ï¼š
  - ä½¿ç”¨ async æ¥ç®¡ç†å¹¶å‘ I/O æ“ä½œã€ç½‘ç»œæœåŠ¡ç­‰ã€‚
  - å¯¹äº CPU å¯†é›†ä»»åŠ¡ï¼Œåˆ©ç”¨ `spawn_blocking` æˆ–ç‹¬ç«‹çš„çº¿ç¨‹æ± å°†ä»»åŠ¡éš”ç¦»å‡ºæ¥ï¼Œé¿å…å½±å“äº‹ä»¶å¾ªç¯çš„å“åº”æ€§ã€‚
- **ç»„ä»¶åˆ†å±‚**  
  å°†ç³»ç»Ÿåˆ†ä¸º I/O å±‚ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆæ ¹æ®å®é™…å·¥ä½œè´Ÿè½½å†³å®šæ˜¯å¦å¹¶è¡Œï¼‰ã€å’Œè¿ç®—å±‚ï¼ˆCPU å¯†é›†å‹ä»»åŠ¡é€‚åˆå¤šçº¿ç¨‹ï¼‰ï¼Œåœ¨æ¯ä¸ªå±‚æ¬¡éƒ½åšåˆç†çš„æ€§èƒ½è¯„ä¼°å’Œæµ‹é‡ï¼Œå¹¶åŠ¨æ€è°ƒæ•´èµ„æºåˆ†é…ã€‚

---

## 3 æ€§èƒ½å¹³è¡¡ä¸å†³ç­–çš„å¸¸è§æªæ–½

åœ¨è®¾è®¡å’Œå®ç°æ—¶ï¼Œå¯ä»ä»¥ä¸‹å‡ ä¸ªå±‚é¢åšå‡ºå†³ç­–ï¼š

1. **è¿è¡Œæ—¶é€‰æ‹©**  
   - ä½¿ç”¨ Tokio æ—¶ï¼Œå¯åˆ©ç”¨å…¶å¤šçº¿ç¨‹æ‰§è¡Œå™¨å’Œ `spawn_blocking` æ–¹æ³•ï¼Œå°†é˜»å¡å‹ CPU ä»»åŠ¡ä» I/O å¾ªç¯ä¸­å‰¥ç¦»ã€‚  
   - async-std ä¸ smol ç­‰è¿è¡Œæ—¶é€‚ç”¨äºç®€å•åœºæ™¯ï¼Œä½†åœ¨æ€§èƒ½å’Œå¤šçº¿ç¨‹æ‰©å±•æ€§ä¸Šéœ€è¦è¿›è¡Œå¯¹æ¯”æµ‹è¯•ã€‚

2. **è°ƒåº¦ä¸èµ„æºé…ç½®**  
   - æ ¹æ®å®é™…æµ‹è¯•ç»“æœï¼Œè°ƒæ•´çº¿ç¨‹æ± å¤§å°å’Œä»»åŠ¡åˆ†é…ç­–ç•¥ï¼Œç¡®ä¿æ—¢èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿ï¼Œåˆä¸ä¼šå› è¿‡åº¦å¹¶è¡Œäº§ç”Ÿç«äº‰ã€‚  
   - ä½¿ç”¨æ€§èƒ½è®¡æ•°å™¨ã€åˆ†æå·¥å…·ï¼ˆå¦‚ tokio-consoleï¼‰æ¥ç›‘æ§è°ƒåº¦å’Œèµ„æºä½¿ç”¨æƒ…å†µã€‚

3. **ä»»åŠ¡æ‹†åˆ†ä¸ç²’åº¦æ§åˆ¶**  
   - åˆç†æ‹†åˆ†ä»»åŠ¡ï¼Œä½¿å¾—æ¯ä¸ª async å‡½æ•°ï¼ˆçŠ¶æ€æœºï¼‰æ—¢ä¸è‡³äºè¿‡äºç»†ç²’åº¦å¸¦æ¥ç®¡ç†å¼€é”€ï¼Œä¹Ÿä¸è‡³äºè¿‡äºç²—ç²’åº¦å¯¼è‡´å“åº”å»¶è¿Ÿã€‚  
   - å¯¹äº CPU å¯†é›†å‹ä»»åŠ¡ï¼Œè€ƒè™‘åˆ†è§£ä¸ºæ›´å°çš„å¼‚æ­¥å•å…ƒæˆ–å°½å¯èƒ½å‰¥ç¦»åˆ°ç‹¬ç«‹çº¿ç¨‹ä¸­å¤„ç†ã€‚

4. **å…±äº«æ•°æ®ä¼˜åŒ–**  
   - è®¾è®¡æ— é”ç»“æ„æˆ–å‡å°‘å…±äº«çŠ¶æ€çš„å†™é”ä½¿ç”¨å¯èƒ½å¸¦æ¥çš„æ€§èƒ½ç“¶é¢ˆã€‚  
   - åœ¨ async ç¯å¢ƒä¸‹ä¼˜å…ˆé‡‡ç”¨æ— é˜»å¡çš„æ•°æ®ç»“æ„å’Œæ¶ˆæ¯ä¼ é€’æ¨¡å¼ï¼ˆå¦‚åŸºäº channel æ–¹å¼ï¼‰é™ä½é”ç«äº‰é£é™©ã€‚

---

## 4 æ€ç»´å¯¼å›¾æ€»ç»“

ä¸‹é¢çš„ Mermaid æ€ç»´å¯¼å›¾æ¦‚æ‹¬äº† Rust async è®¾è®¡ä¸­å¤šçº¿ç¨‹ä¸å¼‚æ­¥ç¼–ç¨‹æƒè¡¡å’Œæ€§èƒ½å¹³è¡¡å†³ç­–çš„å„ä¸ªå±‚æ¬¡ï¼š

```mermaid
flowchart TD
    A[Rust Async&å¤šçº¿ç¨‹è®¾è®¡å†³ç­–]
    
    A --> B[ä»»åŠ¡ç±»å‹åˆ†æ]
    B --> B1[I/Oå¯†é›†å‹ï¼šé€‚åˆå¼‚æ­¥å¤„ç†]
    B --> B2[CPUå¯†é›†å‹ï¼šé‡‡ç”¨å¤šçº¿ç¨‹æˆ– spawn_blocking]
    
    A --> C[è°ƒåº¦ä¸åˆ‡æ¢å¼€é”€]
    C --> C1[å¼‚æ­¥ä¸Šä¸‹æ–‡åˆ‡æ¢ä½ä½†æœ‰çŠ¶æ€æœºå¼€é”€]
    C --> C2[çº¿ç¨‹åˆ‡æ¢å¼€é”€é«˜ï¼Œæ•°é‡æ§åˆ¶å…³é”®]
    
    A --> D[æ•°æ®å…±äº«ä¸åŒæ­¥]
    D --> D1[å¼‚æ­¥å…±äº«ï¼šArc + Async Mutex/RwLock]
    D --> D2[å¤šçº¿ç¨‹å…±äº«ï¼šç²¾ç²’åº¦é”å’Œå¹¶è¡Œç­–ç•¥]
    
    A --> E[æ¶æ„åˆ†å±‚å†³ç­–]
    E --> E1[I/Oå±‚ï¼šå¼‚æ­¥äº‹ä»¶å¾ªç¯]
    E --> E2[ä¸šåŠ¡é€»è¾‘å±‚ï¼šä¾æ®è´Ÿè½½å†³å®šå¹¶è¡Œåº¦]
    E --> E3[è¿ç®—å±‚ï¼šCPUå¯†é›†å‹ä»»åŠ¡ç‹¬ç«‹çº¿ç¨‹æ± ]
    
    A --> F[è¿è¡Œæ—¶ä¸è°ƒåº¦é…ç½®]
    F --> F1[Tokio: å¤šçº¿ç¨‹ + spawn_blocking]
    F --> F2[ç›‘æ§ä¸åŠ¨æ€è°ƒæ•´ï¼šä½¿ç”¨ profiling å·¥å…·]
```

---

## 5 æ€»ç»“

- **å¼‚æ­¥ç¼–ç¨‹**é€‚åˆå¤§è§„æ¨¡å¹¶å‘ I/O æ“ä½œï¼Œå¯å‡å°‘çº¿ç¨‹æ•°ã€èŠ‚çœå†…å­˜ï¼Œä½†éœ€æ³¨æ„çŠ¶æ€æœºè½¬æ¢å’Œå…±äº«æ•°æ®åŒæ­¥ã€‚  
- **å¤šçº¿ç¨‹ç¼–ç¨‹**èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ CPU å¤šæ ¸èµ„æºï¼Œé€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œä½†çº¿ç¨‹åˆ‡æ¢å’Œè°ƒåº¦å¼€é”€è¾ƒé«˜ã€‚  
- åœ¨è®¾è®¡æ—¶éœ€æ ¹æ®ä»»åŠ¡ç‰¹æ€§ã€èµ„æºä½¿ç”¨å’Œç³»ç»Ÿè´Ÿè½½ï¼Œé‡‡ç”¨æ··åˆæ¨¡å‹ï¼ˆä¾‹å¦‚å¼‚æ­¥ I/O ä¸ç‹¬ç«‹ CPU ä»»åŠ¡åˆ†ç¦»ï¼‰å¹¶åˆ©ç”¨è¿è¡Œæ—¶ï¼ˆå¦‚ Tokioï¼‰çš„çµæ´» API è¿›è¡Œèµ„æºè°ƒä¼˜ã€‚  
- æ€§èƒ½å†³ç­–åº”ä»ä»»åŠ¡åˆ’åˆ†ã€è°ƒåº¦æœºåˆ¶ã€æ•°æ®å…±äº«ã€ä»¥åŠç³»ç»Ÿç›‘æ§ç­‰å±‚é¢ç»¼åˆè€ƒè™‘ï¼Œä»¥è¾¾åˆ°å„å±‚æ¬¡æ€§èƒ½å¹³è¡¡ã€‚

é€šè¿‡åˆç†åˆ†æä»»åŠ¡ç‰¹æ€§å¹¶é‡‡ç”¨åˆé€‚çš„å¼‚æ­¥ä¸å¤šçº¿ç¨‹æ··åˆè®¾è®¡ï¼Œèƒ½å¤Ÿå®ç°é«˜æ•ˆã€å“åº”è¿…é€Ÿçš„ç³»ç»Ÿæ¶æ„ï¼ŒåŒæ—¶ä¿è¯ç³»ç»Ÿæ‰©å±•æ€§å’Œç¨³å®šæ€§ã€‚

ä¸‹é¢æä¾›ä¸€ä¸ªè¯¦ç»†çš„è¯´æ˜ï¼Œä»‹ç»äº†å¦‚ä½•åœ¨ Rust ä¸­å°† async ä¸å¤šçº¿ç¨‹æ··åˆæ¨¡å‹ç»“åˆï¼Œä»è€Œå……åˆ†å‘æŒ¥å¼‚æ­¥ I/O çš„é«˜å¹¶å‘ä¼˜åŠ¿ä»¥åŠå¤šçº¿ç¨‹åœ¨ CPU å¯†é›†ä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚
ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä½¿ç”¨ Tokio è¿è¡Œæ—¶ï¼Œå…¶ä¸­é€šè¿‡ `tokio::spawn` å¯åŠ¨å¼‚æ­¥ I/O ä»»åŠ¡ï¼ŒåŒæ—¶ä½¿ç”¨ `tokio::task::spawn_blocking` å°†é˜»å¡æˆ– CPU å¯†é›†å‹æ“ä½œäº¤ç»™ä¸“é—¨çš„çº¿ç¨‹æ± æ‰§è¡Œï¼Œä»è€Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯ã€‚

---

## 6 æ··åˆæ¨¡å‹è®¾è®¡æ€è·¯

- **å¼‚æ­¥ I/O ä»»åŠ¡**  
  å¼‚æ­¥ä»»åŠ¡é€‚åˆå¤„ç†ç½‘ç»œã€æ–‡ä»¶ç­‰ I/O æ“ä½œï¼Œåˆ©ç”¨äº‹ä»¶é©±åŠ¨ & çŠ¶æ€æœºæœºåˆ¶åœ¨å•ä¸ªæˆ–å°‘é‡çº¿ç¨‹å†…åŒæ—¶ç®¡ç†å¤§é‡ä»»åŠ¡ï¼Œç¡®ä¿é«˜å¹¶å‘ä¸ä½å»¶è¿Ÿã€‚

- **é˜»å¡ / CPU å¯†é›†å‹ä»»åŠ¡**  
  é•¿æ—¶é—´çš„é˜»å¡è°ƒç”¨æˆ–è€…å¤§é‡è®¡ç®—ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚æ­¤æ—¶å¯ä»¥ä½¿ç”¨ `tokio::task::spawn_blocking` å°†å…¶æäº¤åˆ°ä¸“ç”¨çº¿ç¨‹æ± ï¼Œç¡®ä¿ä¸ä¼šå¹²æ‰°ä¸»å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œã€‚

- **æ··åˆæ¨¡å‹ä¼˜åŠ¿**  
  - å¼‚æ­¥ä»»åŠ¡è°ƒåº¦è®¾è®¡å¯ä»¥æœ‰æ•ˆåˆ©ç”¨æ“ä½œç³»ç»Ÿèµ„æºè¿›è¡Œ I/O å¤šè·¯å¤ç”¨ã€‚  
  - é˜»å¡ä»»åŠ¡äº¤ç”±ç‹¬ç«‹çº¿ç¨‹æ‰§è¡Œï¼Œæ—¢èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸ CPUï¼Œåˆä¸ä¼šæ‹–æ…¢å¼‚æ­¥äº‹ä»¶å¾ªç¯çš„å“åº”ã€‚

---

## 7 ç¤ºä¾‹ä»£ç 

ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•ç»„åˆ async ä¸å¤šçº¿ç¨‹çš„æ··åˆæ¨¡å‹ã€‚  
**æ–‡ä»¶è·¯å¾„ï¼š** `src/hybrid.rs`

```rust:src/hybrid.rs
use tokio::task;
use tokio::time::{sleep, Duration};

/// å¼‚æ­¥ I/O ä»»åŠ¡ç¤ºä¾‹
async fn async_io_task(task_id: u32) {
    println!("å¼‚æ­¥ I/O ä»»åŠ¡ {} å¼€å§‹æ‰§è¡Œ", task_id);
    // æ¨¡æ‹Ÿ I/O æ“ä½œï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚æˆ–æ–‡ä»¶è¯»å–
    sleep(Duration::from_millis(500)).await;
    println!("å¼‚æ­¥ I/O ä»»åŠ¡ {} æ‰§è¡Œç»“æŸ", task_id);
}

/// CPU å¯†é›†å‹ä»»åŠ¡ç¤ºä¾‹ï¼šä¾‹å¦‚å¤§é‡è®¡ç®—
fn cpu_intensive_operation(n: u32) -> u32 {
    // æ¨¡æ‹Ÿ CPU å¯†é›†å‹è®¡ç®—ï¼šæ±‚ 1 åˆ° n çš„ç´¯åŠ å’Œ
    (1..=n).sum()
}

#[tokio::main(flavor = "multi_thread", worker_threads = 4)]
async fn main() {
    println!("ä¸»ä»»åŠ¡å¼€å§‹");

    // å¯åŠ¨å¤šä¸ªå¼‚æ­¥ I/O ä»»åŠ¡
    let io_handle1 = tokio::spawn(async_io_task(1));
    let io_handle2 = tokio::spawn(async_io_task(2));

    // ä½¿ç”¨ spawn_blocking å¯åŠ¨ CPU å¯†é›†å‹ä»»åŠ¡
    let cpu_handle = task::spawn_blocking(|| {
        println!("CPU å¯†é›†å‹ä»»åŠ¡å¼€å§‹æ‰§è¡Œ");
        let result = cpu_intensive_operation(100_000);
        println!("CPU å¯†é›†å‹ä»»åŠ¡æ‰§è¡Œç»“æŸï¼Œè®¡ç®—ç»“æœ: {}", result);
        result
    });

    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œæ¯•
    let _ = io_handle1.await.expect("å¼‚æ­¥ä»»åŠ¡ 1 æ‰§è¡Œå¼‚å¸¸");
    let _ = io_handle2.await.expect("å¼‚æ­¥ä»»åŠ¡ 2 æ‰§è¡Œå¼‚å¸¸");
    let cpu_result = cpu_handle.await.expect("CPU ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸");

    println!("æ‰€æœ‰ä»»åŠ¡å‡å·²å®Œæˆï¼ŒCPU ä»»åŠ¡ç»“æœ: {}", cpu_result);
}
```

### 7.1 ä»£ç è¯´æ˜

- **å¼‚æ­¥ä»»åŠ¡éƒ¨åˆ†**  
  ä½¿ç”¨ `tokio::spawn` å¯åŠ¨çš„ `async_io_task` æ¼”ç¤ºäº†ä¸€ä¸ªç½‘ç»œ/æ–‡ä»¶ I/O æ“ä½œï¼Œé€šè¿‡ `sleep` æ¨¡æ‹Ÿå¼‚æ­¥ç­‰å¾…ã€‚  
- **é˜»å¡ / CPU å¯†é›†å‹ä»»åŠ¡éƒ¨åˆ†**  
  å¯¹äº CPU å¯†é›†å‹ä»»åŠ¡ï¼Œè°ƒç”¨ `tokio::task::spawn_blocking` å°†è€—æ—¶è®¡ç®—æäº¤åˆ°ä¸“ç”¨çº¿ç¨‹æ± ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡å¼‚æ­¥äº‹ä»¶å¾ªç¯ã€‚

- **å¤šçº¿ç¨‹è¿è¡Œæ—¶**  
  ç¤ºä¾‹ä¸­ä½¿ç”¨ `#[tokio::main(flavor = "multi_thread", worker_threads = 4)]` è¡¨ç¤º Tokio å°†å¯åŠ¨ä¸€ä¸ªå¤šçº¿ç¨‹è¿è¡Œæ—¶ï¼Œå¹¶åˆ†é… 4 ä¸ªå·¥ä½œçº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚

---

## 8 æ€ç»´å¯¼å›¾æ€»ç»“

ä¸‹é¢çš„ Mermaid æ€ç»´å¯¼å›¾ç›´è§‚å±•ç¤ºäº†å¼‚æ­¥ä»»åŠ¡ä¸å¤šçº¿ç¨‹ï¼ˆé˜»å¡ä»»åŠ¡ï¼‰çš„æ··åˆæ¨¡å‹è®¾è®¡ï¼š

```mermaid:diagram/hybrid_model.mmd
flowchart TD
    A[åº”ç”¨ç¨‹åº]
    A --> B[å¼‚æ­¥ I/O ä»»åŠ¡]
    B --> B1[tokio::spawn å¯åŠ¨]
    A --> C[CPU å¯†é›†/é˜»å¡ä»»åŠ¡]
    C --> C1[tokio::task::spawn_blocking]
    C1 --> D[ä¸“ç”¨çº¿ç¨‹æ± ]
    A --> E[ç»“æœåˆå¹¶ä¸ç­‰å¾…]
    E --> B
    E --> C
```

---

## 9 è®¾è®¡å»ºè®®

- **ä»»åŠ¡åˆ’åˆ†**ï¼š  
  å°† I/O å¯†é›†å‹ä»»åŠ¡ä¸ CPU å¯†é›†å‹/é˜»å¡ä»»åŠ¡åˆ†ç¦»ï¼›å¼‚æ­¥ä»»åŠ¡é‡‡ç”¨ `tokio::spawn`ï¼Œè€Œé˜»å¡ä»»åŠ¡ä½¿ç”¨ `spawn_blocking` æˆ–ç‹¬ç«‹çº¿ç¨‹å¯åŠ¨ã€‚
  
- **èµ„æºç®¡ç†**ï¼š  
  æ ¹æ®ç³»ç»Ÿè´Ÿè½½åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å¤§å°ï¼Œå¹¶åˆç†æ‹†åˆ†ä»»åŠ¡ï¼Œç¡®ä¿æ—¢èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸æ€§èƒ½ï¼Œåˆä¸ä¼šå› é˜»å¡æ“ä½œæ‹–æ…¢æ•´ä¸ªäº‹ä»¶å¾ªç¯ã€‚
  
- **æ•°æ®é€šä¿¡**ï¼š  
  ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„ï¼ˆå¦‚ `Arc`ã€å¼‚æ­¥é”ç­‰ï¼‰æˆ–å¼‚æ­¥ Channel åœ¨ä¸åŒä»»åŠ¡é—´ä¼ é€’æ•°æ®ï¼Œä¿è¯å¹¶å‘å®‰å…¨å’Œé«˜æ€§èƒ½ã€‚

---

## 10 5 æ€»ç»“

é€šè¿‡ä¸Šè¿°ç¤ºä¾‹ï¼Œæˆ‘ä»¬å±•ç¤ºäº†å¦‚ä½•åœ¨ Rust ä¸­ç»“åˆ async ä¸å¤šçº¿ç¨‹ç¼–ç¨‹æ¨¡å‹ï¼š  

- é€šè¿‡ `tokio::spawn` æ¥å¯åŠ¨å¤§é‡çš„å¼‚æ­¥ I/O æ“ä½œã€‚  
- åˆ©ç”¨ `tokio::task::spawn_blocking` å°†é˜»å¡æˆ– CPU å¯†é›†å‹ä»»åŠ¡éš”ç¦»åˆ°ä¸“ç”¨çº¿ç¨‹æ± æ‰§è¡Œã€‚  
- æ··åˆæ¨¡å‹æ—¢æ»¡è¶³é«˜å¹¶å‘ I/O æ“ä½œçš„éœ€æ±‚ï¼Œåˆå……åˆ†åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨æ‰§è¡Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œä»è€Œå®ç°æ€§èƒ½ä¸å“åº”æ€§çš„å¹³è¡¡ã€‚

è¿™ç§æ··åˆæ–¹æ³•åœ¨å®é™…ç³»ç»Ÿä¸­éå¸¸å¸¸è§ï¼Œèƒ½å¤Ÿæœ‰æ•ˆè§£å†³å„ç§å„æ ·çš„æ€§èƒ½ç“¶é¢ˆé—®é¢˜ã€‚

ä¸‹é¢ä»‹ç»ä¸‹å¦‚ä½•åœ¨ Rust çš„ async ç¨‹åºä¸­ä¸ Console å·¥å…·ï¼ˆä¾‹å¦‚ [tokio-console](https://github.com/tokio-rs/console)ï¼‰è¿›è¡Œå¹¶å‘é›†æˆï¼Œä»¥ä¾¿å¯¹è¿è¡Œæ—¶ä»»åŠ¡ã€è°ƒåº¦å’ŒçŠ¶æ€è¿›è¡Œå®æ—¶ç›‘æ§å’Œè°ƒè¯•ã€‚ä»¥ä¸‹å†…å®¹åŒ…æ‹¬å·¥å…·ä»‹ç»ã€é›†æˆæ­¥éª¤ä¸ä»£ç ç¤ºä¾‹ï¼Œä»¥åŠè®¾è®¡ä¸­çš„æ³¨æ„ç‚¹ã€‚

---

## 11 å·¥å…·ä¸èƒŒæ™¯

### 11.1 Tokio Console ç®€ä»‹

- **Tokio Console**  
  æ˜¯ä¸€ä¸ªä¸“é—¨ç”¨äºç›‘æ§ Tokio å¼‚æ­¥è¿è¡Œæ—¶çš„è°ƒè¯•å·¥å…·ã€‚å®ƒåˆ©ç”¨è¿½è¸ªï¼ˆtracingï¼‰ç³»ç»Ÿï¼Œå±•ç¤ºå½“å‰ä»»åŠ¡ã€è°ƒåº¦å™¨çŠ¶æ€ã€ä»»åŠ¡ç­‰å¾…æ—¶é—´ã€é˜»å¡çŠ¶å†µç­‰ä¿¡æ¯ï¼Œä»è€Œå¸®åŠ©å¼€å‘è€…äº†è§£å¼‚æ­¥ä»»åŠ¡ä¹‹é—´çš„å¹¶å‘æ‰§è¡Œæƒ…å†µã€‚

- **Console Subscriber**  
  é›†æˆæ–¹å¼é€šå¸¸é‡‡ç”¨ [`console-subscriber`](https://crates.io/crates/console-subscriber)ï¼ˆè¿™æ˜¯ Tokio Console ä¸­çš„ä¸€ä¸ªç»„ä»¶ï¼‰ï¼Œé€šè¿‡å°†å…¶ä½œä¸º `tracing` çš„ Subscriber æ³¨å…¥åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œä½¿å¾—è¿è¡Œæ—¶æ•°æ®èƒ½å¤Ÿè¢« Console æ•æ‰ã€‚

### 11.2 å¹¶å‘é›†æˆçš„æ„ä¹‰

- å¯¹äºå¤æ‚çš„å¼‚æ­¥ç¨‹åºï¼Œè°ƒè¯•å¹¶å‘é—®é¢˜å’Œæ€§èƒ½ç“¶é¢ˆååˆ†å›°éš¾ã€‚  
- åˆ©ç”¨ Console å·¥å…·ï¼Œå¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ä»»åŠ¡åˆ›å»ºã€è¿è¡Œã€æŒ‚èµ·ã€é˜»å¡ç­‰çŠ¶æ€ä¿¡æ¯ï¼Œæœ‰åŠ©äºå‘ç°è°ƒåº¦é—®é¢˜ã€é•¿æ—¶é—´å ç”¨ CPU çš„ä»»åŠ¡æˆ–è€…èµ„æºç«äº‰ç­‰é—®é¢˜ã€‚

---

## 12 é›†æˆæ­¥éª¤

1. **æ·»åŠ ä¾èµ–**  
   åœ¨ `Cargo.toml` ä¸­æ·»åŠ  `console-subscriber` ä»¥åŠç›¸å…³ä¾èµ–ï¼ˆé€šå¸¸ä¸ `tracing` å’Œ `tokio` ä¸€åŒä½¿ç”¨ï¼‰ã€‚
2. **åˆå§‹åŒ– Console Subscriber**  
   åœ¨åº”ç”¨ç¨‹åºå…¥å£ï¼ˆä¾‹å¦‚ `main` å‡½æ•°ï¼‰ä¸­ï¼Œè°ƒç”¨ `console_subscriber::init()`ï¼ˆæˆ–è€…ä½¿ç”¨æ›´ç»†ç²’åº¦çš„é…ç½®ï¼‰å°† Console Subscriber åŠ å…¥åˆ° `tracing` ç³»ç»Ÿä¸­ã€‚
3. **å¯åŠ¨ Tokio Console åå°æœåŠ¡**  
   æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å¯åŠ¨å¹¶è¿æ¥ Console æœåŠ¡ï¼ˆå¯åŠ¨æ—¶å¯èƒ½éœ€è¦æ‰§è¡Œ `cargo install console` æˆ–è€…é€šè¿‡ Docker éƒ¨ç½² Console åå°ï¼‰ã€‚
4. **è¿è¡Œè§‚å¯Ÿ**  
   å½“ç¨‹åºè¿è¡Œæ—¶ï¼ŒConsole ä¼šè‡ªåŠ¨æ•è·æ‰€æœ‰ç”± Tokio äº§ç”Ÿçš„ä»»åŠ¡æ•°æ®ï¼Œå¯é€šè¿‡æµè§ˆå™¨æˆ–è€…å‘½ä»¤è¡Œç•Œé¢æŸ¥çœ‹å®æ—¶æ•°æ®ã€‚

---

## 13 ç¤ºä¾‹ä»£ç 

ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ç¨‹åºï¼Œå±•ç¤ºå¦‚ä½•åœ¨ Tokio å¼‚æ­¥åº”ç”¨ä¸­é›†æˆ Console ç›‘æ§åŠŸèƒ½ã€‚

**æ–‡ä»¶è·¯å¾„ï¼š** `src/main.rs`

```rust:src/main.rs
use tokio::time::{sleep, Duration};

// å¯¼å…¥ Console Subscriber
// æ·»åŠ åˆ° Cargo.toml: console-subscriber = "0.1"ï¼ˆç‰ˆæœ¬è¯·å‚è€ƒæœ€æ–°å‘å¸ƒï¼‰
fn init_console() {
    // åˆå§‹åŒ– console subscriberï¼Œè¿™æ ·æ‰€æœ‰çš„ tracing æ•°æ®éƒ½å°†è¢«è¾“é€åˆ° Console
    console_subscriber::init();
}

/// æ¨¡æ‹Ÿä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œå±•ç¤ºä»»åŠ¡åˆ›å»ºä¸è°ƒåº¦æƒ…å†µ
async fn simulated_task(id: u32) {
    println!("ä»»åŠ¡ {} å¼€å§‹æ‰§è¡Œ", id);
    // æ¨¡æ‹Ÿå¼‚æ­¥ç­‰å¾…
    sleep(Duration::from_millis(300 * id as u64)).await;
    println!("ä»»åŠ¡ {} æ‰§è¡Œç»“æŸ", id);
}

#[tokio::main(flavor = "multi_thread", worker_threads = 4)]
async fn main() {
    // åˆå§‹åŒ– Console Subscriberï¼Œè®© tokio-console èƒ½æ•è·ä»»åŠ¡ç›‘æ§æ•°æ®
    init_console();

    println!("ç¨‹åºå¯åŠ¨ï¼Œå¼‚æ­¥ä»»åŠ¡å¼€å§‹æ‰§è¡Œ...");

    // å¯åŠ¨å¤šä¸ªå¼‚æ­¥ä»»åŠ¡
    let mut handles = vec![];
    for i in 1..=5 {
        handles.push(tokio::spawn(simulated_task(i)));
    }
    
    // ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    for handle in handles {
        let _ = handle.await;
    }
    
    println!("æ‰€æœ‰ä»»åŠ¡å‡å·²å®Œæˆ");
}
```

### 13.1 ä»£ç è¯´æ˜

- **åˆå§‹åŒ– Subscriber**  
  é€šè¿‡ `console_subscriber::init()` å°† Console Subscriber æ³¨å…¥åˆ° tracing ç³»ç»Ÿä¸­ï¼Œä¹‹å Tokio è¿è¡Œæ—¶ä¼šè‡ªåŠ¨é‡‡é›†å„ä¸ªä»»åŠ¡çš„ä¿¡æ¯å¹¶ä¼ é€åˆ° Console åå°æœåŠ¡ã€‚

- **ä»»åŠ¡è¿è¡Œ**  
  ç¤ºä¾‹ä¸­åˆ›å»ºäº†å¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œåœ¨ Console å·¥å…·ä¸­å¯ç›´è§‚çœ‹åˆ°è¿™äº›ä»»åŠ¡çš„åˆ›å»ºã€è°ƒåº¦ã€ç­‰å¾…ä¸å®Œæˆæƒ…å†µã€‚

- **å¤šçº¿ç¨‹è¿è¡Œæ—¶**  
  ä½¿ç”¨ `#[tokio::main(flavor = "multi_thread", worker_threads = 4)]` å¯åŠ¨å¤šçº¿ç¨‹ Tokio è¿è¡Œæ—¶ï¼ŒConsole ä¼šæ˜¾ç¤ºå„ä¸ªå·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡è´Ÿè½½å’ŒçŠ¶æ€ä¿¡æ¯ã€‚

---

## 14 æ€ç»´å¯¼å›¾

ä¸‹é¢çš„ Mermaid æ€ç»´å¯¼å›¾å±•ç¤ºäº†å¼‚æ­¥ç¨‹åºä¸ Console é›†æˆçš„æ•´ä½“å·¥ä½œæµç¨‹ï¼š

```mermaid:diagram/async_console_integration.mmd
flowchart TD
    A[ç¨‹åºå…¥å£ main]
    A --> B[åˆå§‹åŒ– tracing Subscriber]
    B --> C[è°ƒç”¨ console_subscriber::init()]
    C --> D[å¯åŠ¨ Tokio è¿è¡Œæ—¶]
    D --> E[ä»»åŠ¡è°ƒåº¦ä¸æ‰§è¡Œ]
    E --> F[ä»»åŠ¡çŠ¶æ€æ•°æ®å‘é€]
    F --> G[Tokio Console æ”¶é›†æ•°æ®]
    G --> H[é€šè¿‡æ§åˆ¶å°æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€ã€è°ƒåº¦ä¿¡æ¯]
```

---

## 15 5 æ€»ç»“

- **é›†æˆä¼˜åŠ¿**  
  åˆ©ç”¨ Consoleï¼ˆä¾‹å¦‚ tokio-consoleï¼‰å¯ä»¥åœ¨è¿è¡Œæ—¶å®æ—¶ç›‘æ§å¼‚æ­¥ä»»åŠ¡ã€çº¿ç¨‹è´Ÿè½½å’Œè°ƒåº¦æƒ…å†µï¼Œæœ‰åŠ©äºè°ƒè¯•å¹¶å‘é—®é¢˜ã€æ€§èƒ½ç“¶é¢ˆå’Œèµ„æºç«äº‰ã€‚
  
- **å®ç°æ­¥éª¤**  
  åªéœ€åœ¨é¡¹ç›®ä¸­æ·»åŠ  `console-subscriber` ä¾èµ–ï¼Œå¹¶åœ¨ç¨‹åºå…¥å£è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•ï¼Œç„¶åæ­£å¸¸ä½¿ç”¨ Tokio å¼‚æ­¥ä»»åŠ¡å³å¯ã€‚åå° Console å·¥å…·å°†è‡ªåŠ¨æ•è·ä¸å±•ç¤ºç›¸å…³æ•°æ®ã€‚

- **æ‰©å±•æ€è€ƒ**  
  å¯ç»“åˆ tracingã€metrics ç­‰å·¥å…·ï¼Œå®ç°æ›´ä¸ºç»†ç²’åº¦çš„æ€§èƒ½ç›‘æ§ä¸è°ƒä¼˜ï¼Œä»è€Œæ‰“é€ é«˜æ€§èƒ½ã€é«˜å¯è§‚æµ‹æ€§çš„å¼‚æ­¥ç³»ç»Ÿã€‚

é€šè¿‡ä¸Šè¿°æ–¹å¼ï¼ŒRust çš„ async ç¨‹åºå°±èƒ½ä¸ Console å¹¶å‘é›†æˆï¼Œä¸ºå¼€å‘è€…å¸¦æ¥æ›´ç›´è§‚ã€å®æ—¶çš„ç›‘æ§å’Œè°ƒè¯•ä½“éªŒã€‚

## 16 Async Rust ä¸­é›†æˆ Metrics

æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ Rust å¼‚æ­¥é¡¹ç›®ä¸­é›†æˆ Metricsï¼Œé€šè¿‡ [`metrics`](https://crates.io/crates/metrics) åŠ
 [`metrics-exporter-prometheus`](https://crates.io/crates/metrics-exporter-prometheus) æ¥è®°å½•å’Œå¯¼å‡ºåº”ç”¨æŒ‡æ ‡æ•°æ®ï¼Œ
 å¹¶é€šè¿‡ HTTP æœåŠ¡æš´éœ²ç»™ Prometheus è¿›è¡Œç›‘æ§ã€‚

---

## 17 æ·»åŠ ä¾èµ–

åœ¨é¡¹ç›®çš„ `Cargo.toml` æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä¾èµ–ï¼š

```toml:Cargo.toml
[dependencies]
tokio = { version = "1", features = ["full"] }
metrics = "0.17"
metrics-exporter-prometheus = "0.7"
hyper = "0.14"
```

---

## 18 å®‰è£… Recorder å¹¶å¯åŠ¨ HTTP æœåŠ¡

ä½¿ç”¨ `PrometheusBuilder` å®‰è£…æŒ‡æ ‡ Recorderï¼Œä¹‹åæ‰€æœ‰é€šè¿‡ `metrics` å½•å…¥çš„æŒ‡æ ‡éƒ½ä¼šè¢«èšåˆã€‚å†åˆ©ç”¨ Hyper åˆ›å»ºä¸€ä¸ª HTTP æœåŠ¡ï¼Œå°†æŒ‡æ ‡æ•°æ®ä»¥æ–‡æœ¬æ ¼å¼æš´éœ²ç»™ Prometheus ç­‰ç›‘æ§å·¥å…·ã€‚

**æ–‡ä»¶è·¯å¾„ï¼š** `src/main.rs`

```rust:src/main.rs
use hyper::{Body, Request, Response, Server};
use hyper::service::{make_service_fn, service_fn};
use metrics_exporter_prometheus::{PrometheusBuilder, PrometheusHandle};
use tokio::time::{interval, Duration};

/// å¯åŠ¨ HTTP æœåŠ¡ï¼Œæä¾› Prometheus æŒ‡æ ‡æŸ¥è¯¢æ¥å£
async fn serve_metrics(handle: PrometheusHandle, port: u16) {
    // ä¸ºæ¯æ¬¡ HTTP è¯·æ±‚åˆ›å»ºä¸€ä¸ªæœåŠ¡ï¼Œè¿”å›å½“å‰çš„æŒ‡æ ‡æ•°æ®
    let make_service = make_service_fn(move |_conn| {
        let handle = handle.clone();
        async move {
            Ok::<_, hyper::Error>(service_fn(move |_req: Request<Body>| {
                let data = handle.render();
                async move { Ok::<_, hyper::Error>(Response::new(Body::from(data))) }
            }))
        }
    });

    let addr = ([127, 0, 0, 1], port).into();
    let server = Server::bind(&addr).serve(make_service);

    println!("Prometheus æŒ‡æ ‡ HTTP ç«¯ç‚¹: http://{}", addr);

    if let Err(e) = server.await {
        eprintln!("HTTP æœåŠ¡å™¨é”™è¯¯: {}", e);
    }
}

#[tokio::main]
async fn main() {
    // å®‰è£… Prometheus Recorderï¼Œå…¨å±€è®°å½•æŒ‡æ ‡æ•°æ®
    let builder = PrometheusBuilder::new();
    let handle = builder.install_recorder().expect("Recorder å®‰è£…å¤±è´¥");

    // å¯åŠ¨ä¸€ä¸ªä»»åŠ¡ï¼Œå¼€å¯ HTTP æŒ‡æ ‡ç«¯ç‚¹
    tokio::spawn(serve_metrics(handle.clone(), 9100));

    // æ¨¡æ‹Ÿä¸šåŠ¡é€»è¾‘ï¼Œé€šè¿‡å®šæ—¶å™¨å‘¨æœŸæ€§å½•å…¥æŒ‡æ ‡æ•°æ®
    let mut ticker = interval(Duration::from_secs(1));
    loop {
        ticker.tick().await;
        
        // è®°å½•è®¡æ•°å™¨æŒ‡æ ‡ï¼Œç»Ÿè®¡è¯·æ±‚æ•°é‡
        metrics::increment_counter!("app_requests_total");
        
        // è®°å½•ç›´æ–¹å›¾æŒ‡æ ‡ï¼Œæ¨¡æ‹Ÿå“åº”æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
        metrics::histogram!("app_response_time_seconds", 0.345);

        println!("æ›´æ–°æŒ‡æ ‡: app_requests_total ä¸ app_response_time_seconds");
    }
}
```

---

## 19 ä»£ç è¯´æ˜

- **Recorder å®‰è£…ï¼š**  
  ä½¿ç”¨ `PrometheusBuilder::new().install_recorder()` å°† Recorder å®‰è£…è‡³å…¨å±€åï¼Œæ‰€æœ‰é€šè¿‡ `metrics` å®å½•å…¥çš„æŒ‡æ ‡æ•°æ®éƒ½ä¼šè‡ªåŠ¨ç»Ÿç­¹æ±‡æ€»ã€‚

- **HTTP æœåŠ¡ï¼š**  
  åˆ©ç”¨ Hyper åˆ›å»ºä¸€ä¸ªç®€å•çš„ HTTP æœåŠ¡ï¼Œæ¯æ¬¡è¯·æ±‚æ—¶è°ƒç”¨ `handle.render()` è¿”å›å½“å‰çš„æŒ‡æ ‡æ•°æ®æ–‡æœ¬ï¼Œä¾› Prometheus ç­‰å·¥å…·æŠ“å–ã€‚

- **æŒ‡æ ‡å½•å…¥ï¼š**  
  åœ¨ç¤ºä¾‹ä¸­ï¼Œé€šè¿‡ `metrics::increment_counter!` å’Œ `metrics::histogram!` åˆ†åˆ«æ¨¡æ‹Ÿè®°å½•ç¨‹åºè¯·æ±‚æ€»æ•°å’Œå“åº”æ—¶é—´ã€‚ä½ å¯ä»¥åœ¨å®é™…ä¸šåŠ¡é€»è¾‘ä¸­æ ¹æ®éœ€è¦é‡‡é›†å„ç§æŒ‡æ ‡ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„æ ‡ç­¾ä»¥ä¾¿ç»†ç²’åº¦ç›‘æ§ã€‚

---

## 20 è¿è¡Œä¸ç›‘æ§

1. ç¼–è¯‘å¹¶è¿è¡Œç¨‹åºåï¼ŒæŒ‡æ ‡æœåŠ¡ä¼šåœ¨ `http://127.0.0.1:9100` å¯åŠ¨ã€‚  
2. é…ç½® Prometheus æŠ“å–è¯¥ç«¯ç‚¹çš„æ•°æ®ï¼Œå³å¯è·å¾—å®æ—¶çš„åº”ç”¨ç›‘æ§æ•°æ®ã€‚

---

## 21 5 æ€»ç»“

é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œä½ å¯ä»¥åœ¨ Rust çš„å¼‚æ­¥ç¨‹åºä¸­è½»æ¾é›†æˆ Metricsï¼Œåšåˆ°ä»¥ä¸‹å‡ ç‚¹ï¼š

- **å…¨å±€æŒ‡æ ‡é‡‡é›†ï¼š** ä½¿ç”¨ `metrics` ç»Ÿä¸€å½•å…¥åº”ç”¨æŒ‡æ ‡ã€‚
- **æŒ‡æ ‡æ•°æ®èšåˆä¸å¯¼å‡ºï¼š** åˆ©ç”¨ `metrics-exporter-prometheus` å°†æŒ‡æ ‡æ•°æ®è½¬æ¢ä¸º Prometheus æ ¼å¼ã€‚
- **å®æ—¶ç›‘æ§ï¼š** é€šè¿‡ HTTP æœåŠ¡å¿«é€Ÿæš´éœ²æŒ‡æ ‡ï¼Œä¾¿äº Prometheus æŠ“å–å’Œç›‘æ§ä»ªè¡¨ç›˜å±•ç¤ºã€‚

è¿™ç§æ–¹å¼å¯å¸®åŠ©å¼€å‘è€…å¯¹åº”ç”¨çš„æ€§èƒ½å’Œå¥åº·çŠ¶å†µè¿›è¡Œç»†è‡´ç›‘æ§ï¼Œå¹¶ä¸ºåç»­çš„æ€§èƒ½è°ƒä¼˜å’Œå‘Šè­¦è®¾ç½®æä¾›æ•°æ®æ”¯æŒã€‚
