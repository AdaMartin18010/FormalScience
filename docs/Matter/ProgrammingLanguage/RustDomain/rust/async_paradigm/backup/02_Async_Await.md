# Rust ä¸­çš„ async å’Œ await

åœ¨ Rust ä¸­ï¼Œ`async` å’Œ `await` æ˜¯ç”¨äºç¼–å†™å¼‚æ­¥ä»£ç çš„å…³é”®å­—ï¼Œå®ƒä»¬ä½¿å¾—å¼‚æ­¥ä»£ç çš„ç¼–å†™æ›´åŠ ç›´è§‚å’Œç®€æ´ã€‚ä»¥ä¸‹æ˜¯è¿™äº›å…³é”®å­—çš„ä½¿ç”¨å’Œè§£é‡Šï¼š

## ğŸ“‹ ç›®å½•

- [1 async](#1-async)
- [2 await](#2-await)
- [3 ä½¿ç”¨ç¤ºä¾‹](#3-ä½¿ç”¨ç¤ºä¾‹)
  - [3.1 è§£é‡Š](#31-è§£é‡Š)
  - [3.2 å¼‚æ­¥è¿è¡Œæ—¶çš„ä½œç”¨](#32-å¼‚æ­¥è¿è¡Œæ—¶çš„ä½œç”¨)
  - [3.3 é”™è¯¯å¤„ç†](#33-é”™è¯¯å¤„ç†)

---

## 1 async

- `async` å…³é”®å­—ç”¨äºå®šä¹‰ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼ˆä¹Ÿç§°ä¸ºå¼‚æ­¥å—ï¼‰ã€‚å¼‚æ­¥å‡½æ•°è¿”å›ä¸€ä¸ªå®ç°äº† `Future` trait çš„ç±»å‹ã€‚
- å¼‚æ­¥å‡½æ•°å¯ä»¥åŒ…å« `.await` è¡¨è¾¾å¼ï¼Œç”¨äºç­‰å¾…å…¶ä»–å¼‚æ­¥æ“ä½œå®Œæˆã€‚

## 2 await

- `await` å…³é”®å­—ç”¨äºç­‰å¾…ä¸€ä¸ª `Future` æˆ– `Stream` å®Œæˆã€‚
- å½“ä¸€ä¸ª `await` è¡¨è¾¾å¼è¢«æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šæš‚åœå½“å‰çš„å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œï¼Œç›´åˆ°è¢«ç­‰å¾…çš„ `Future` æˆ– `Stream` å®Œæˆã€‚
- `await` åªèƒ½åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨ã€‚

## 3 ä½¿ç”¨ç¤ºä¾‹

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ `async` å’Œ `await`ï¼š

```rust
use std::future::Future;
use std::pin::Pin;
use std::task::{Context, Poll};
use std::time::Duration;
use tokio::time::sleep;

struct MyFuture {
    value: i32,
}

impl Future for MyFuture {
    type Output = i32;

    fn poll(self: Pin<&mut Self>, _cx: &mut Context<'_>) -> Poll<Self::Output> {
        Poll::Ready(self.value)
    }
}

async fn async_function() {
    let future = MyFuture { value: 42 };
    let result = await!(future);
    println!("Future çš„ç»“æœæ˜¯ï¼š{}", result);
}

#[tokio::main]
async fn main() {
    async_function().await;
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š

1. `MyFuture` ç»“æ„ä½“å®ç°äº† `Future` traitã€‚
2. `async_function` æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒä½¿ç”¨ `await` ç­‰å¾… `MyFuture` å®Œæˆã€‚
3. `main` å‡½æ•°æ˜¯ä¸€ä¸ªæ ‡è®°ä¸º `#[tokio::main]` çš„å¼‚æ­¥å…¥å£ç‚¹ï¼Œå®ƒè°ƒç”¨ `async_function` å¹¶ç­‰å¾…å…¶å®Œæˆã€‚

### 3.1 è§£é‡Š

- **`async` å‡½æ•°**ï¼šä½¿ç”¨ `async` å…³é”®å­—å®šä¹‰çš„å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå®ç°äº† `Future` trait çš„ç±»å‹ã€‚è¿™æ„å‘³ç€è¿™äº›å‡½æ•°å¯ä»¥è¢« `await`ã€‚
- **`await` è¡¨è¾¾å¼**ï¼š`await` å…³é”®å­—ç”¨äºç­‰å¾…ä¸€ä¸ª `Future` æˆ– `Stream` å®Œæˆã€‚å®ƒåªèƒ½åœ¨å¼‚æ­¥å‡½æ•°ä¸­ä½¿ç”¨ã€‚
- **å¼‚æ­¥è¿è¡Œæ—¶**ï¼šRust çš„å¼‚æ­¥ä»£ç éœ€è¦åœ¨ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼ˆå¦‚ Tokioï¼‰ä¸­æ‰§è¡Œã€‚`#[tokio::main]` å®ç”¨äºè®¾ç½®ä¸€ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¹¶ä½œä¸ºç¨‹åºçš„å…¥å£ç‚¹ã€‚

### 3.2 å¼‚æ­¥è¿è¡Œæ—¶çš„ä½œç”¨

å¼‚æ­¥è¿è¡Œæ—¶è´Ÿè´£ï¼š

- è°ƒåº¦å’Œç®¡ç†å¼‚æ­¥ä»»åŠ¡ã€‚
- å¤„ç†äº‹ä»¶å¾ªç¯å’Œä»»åŠ¡çš„å”¤é†’ã€‚
- æä¾›å¼‚æ­¥ I/Oã€å®šæ—¶å™¨ç­‰åŸºç¡€è®¾æ–½ã€‚

### 3.3 é”™è¯¯å¤„ç†

åœ¨å¼‚æ­¥ä»£ç ä¸­ï¼Œé”™è¯¯å¤„ç†é€šå¸¸ä½¿ç”¨ `Result` ç±»å‹å’Œ `?` æ“ä½œç¬¦ã€‚ä¾‹å¦‚ï¼š

```rust
async fn fetch_data() -> Result<String, Box<dyn std::error::Error>> {
    let client = reqwest::Client::new();
    let response = client.get("https://www.example.com").send().await?;
    let html = response.text().await?;
    Ok(html)
}

#[tokio::main]
async fn main() {
    match fetch_data().await {
        Ok(html) => println!("ç½‘é¡µå†…å®¹ï¼š{}", html),
        Err(e) => println!("å‘ç”Ÿé”™è¯¯ï¼š{}", e),
    }
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š

- `fetch_data` æ˜¯ä¸€ä¸ªå¼‚æ­¥å‡½æ•°ï¼Œå®ƒä½¿ç”¨ `reqwest` åº“å‘é€ HTTP è¯·æ±‚å¹¶è·å–å“åº”ã€‚
- ä½¿ç”¨ `?` æ“ä½œç¬¦å¤„ç†å¯èƒ½çš„é”™è¯¯ï¼Œå¹¶å°†é”™è¯¯ä¼ é€’ç»™è°ƒç”¨è€…ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒRust çš„ `async` å’Œ `await` å…³é”®å­—ä½¿å¾—å¼‚æ­¥ä»£ç çš„ç¼–å†™æ›´åŠ ç›´è§‚å’Œæ˜“äºç†è§£ã€‚
