# rust Future

åœ¨ Rust ä¸­ï¼Œ`Future` æ˜¯ä¸€ä¸ªæ ¸å¿ƒçš„å¼‚æ­¥ç¼–ç¨‹æ¦‚å¿µã€‚
å®ƒä»£è¡¨äº†ä¸€ä¸ªå¯èƒ½å°šæœªå®Œæˆçš„å¼‚æ­¥æ“ä½œï¼Œä½†æœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªç»“æœã€‚
`Future` trait å®šä¹‰äº† `Future` ç±»å‹å¿…é¡»å®ç°çš„æ–¹æ³•ï¼Œä½¿å¾—å®ƒä»¬å¯ä»¥è¢«å¼‚æ­¥è¿è¡Œæ—¶ç®¡ç†å’Œè°ƒåº¦ã€‚

## ğŸ“‹ ç›®å½•

- [1 Future Trait å®šä¹‰](#1-future-trait-å®šä¹‰)
  - [1.1 Context å’Œ Poll](#11-context-å’Œ-poll)
  - [1.2 ä½¿ç”¨ Future](#12-ä½¿ç”¨-future)
    - [2.2.1 ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ Future](#221-ç¤ºä¾‹å®ç°ä¸€ä¸ªç®€å•çš„-future)
  - [1.3 è§£é‡Š](#13-è§£é‡Š)

---

## 1 Future Trait å®šä¹‰

`Future` trait å®šä¹‰åœ¨ Rust çš„æ ‡å‡†åº“ä¸­ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

- **å…³è”ç±»å‹ `Output`**ï¼šè¡¨ç¤º `Future` å®Œæˆæ—¶è¿”å›çš„ç»“æœç±»å‹ã€‚
- **æ–¹æ³• `poll`**ï¼šè¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•ï¼Œç”±å¼‚æ­¥è¿è¡Œæ—¶è°ƒç”¨ï¼Œç”¨ä»¥æ£€æŸ¥ `Future` æ˜¯å¦å·²ç»å®Œæˆã€‚

ä»¥ä¸‹æ˜¯ `Future` trait çš„å®šä¹‰ï¼š

```rust
trait Future {
    type Output;
    fn poll(self: Pin<&mut Self>, cx: &mut Context<'_>) -> Poll<Self::Output>;
}
```

- **`type Output`**ï¼šè¿™æ˜¯ä¸€ä¸ªå…³è”ç±»å‹ï¼Œå®šä¹‰äº† `Future` å®Œæˆæ—¶è¿”å›çš„ç»“æœç±»å‹ã€‚
- **`fn poll`**ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯å¼‚æ­¥è¿è¡Œæ—¶è°ƒç”¨çš„ï¼Œç”¨æ¥æ£€æŸ¥ `Future` æ˜¯å¦å·²ç»å®Œæˆã€‚å®ƒæ¥å—ä¸€ä¸ª `Context` å¯¹è±¡å’Œä¸€ä¸ª `Pin` åŒ…è£…çš„ `self` å¼•ç”¨ã€‚

### 1.1 Context å’Œ Poll

- **`Context`**ï¼šè¿™æ˜¯ä¸€ä¸ªç”±å¼‚æ­¥è¿è¡Œæ—¶æä¾›çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨äºä¼ é€’ `Waker`ã€‚`Waker` æ˜¯ä¸€ä¸ªç”¨äºå”¤é†’å½“å‰ä»»åŠ¡çš„å¥æŸ„ã€‚
- **`Poll`**ï¼šè¿™æ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œè¡¨ç¤º `Future` çš„å½“å‰çŠ¶æ€ï¼š
  - `Poll::Ready(T)`ï¼šè¡¨ç¤º `Future` å·²ç»å®Œæˆï¼Œè¿”å›ç»“æœ `T`ã€‚
  - `Poll::Pending`ï¼šè¡¨ç¤º `Future` å°šæœªå®Œæˆï¼Œéœ€è¦ç»§ç»­ç­‰å¾…ã€‚

### 1.2 ä½¿ç”¨ Future

è¦ä½¿ç”¨ `Future`ï¼Œä½ éœ€è¦ï¼š

1. å®ç° `Future` traitã€‚
2. ä½¿ç”¨ `.await` æ¥ç­‰å¾… `Future` å®Œæˆã€‚

#### 2.2.1 ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ Future

```rust
use std::future::Future;
use std::pin::Pin;
use std::task::{Context, Poll};

struct MyFuture {
    value: i32,
}

impl Future for MyFuture {
    type Output = i32;

    fn poll(self: Pin<&mut Self>, _cx: &mut Context<'_>) -> Poll<Self::Output> {
        Poll::Ready(self.value)
    }
}

fn main() {
    let future = MyFuture { value: 42 };
    let result = future.await;
    println!("Future çš„ç»“æœæ˜¯ï¼š{}", result);
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š

- `MyFuture` ç»“æ„ä½“å®ç°äº† `Future` traitã€‚
- `poll` æ–¹æ³•è¿”å› `Poll::Ready(self.value)`ï¼Œè¡¨ç¤º `Future` ç«‹å³å®Œæˆå¹¶è¿”å›å€¼ `42`ã€‚
- åœ¨ `main` å‡½æ•°ä¸­ï¼Œä½¿ç”¨ `.await` ç­‰å¾… `MyFuture` å®Œæˆï¼Œå¹¶æ‰“å°ç»“æœã€‚

### 1.3 è§£é‡Š

- **`Pin`**ï¼š`Pin` æ˜¯ä¸€ä¸ªåŒ…è£…å™¨ï¼Œç”¨äºç¡®ä¿ `Future` åœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…ä¸ä¼šè¢«ç§»åŠ¨ã€‚è¿™æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå¼‚æ­¥è¿è¡Œæ—¶å¯èƒ½ä¼šå¤šæ¬¡è°ƒç”¨ `poll` æ–¹æ³•ï¼Œè€Œ `Future` éœ€è¦ä¿æŒåœ¨åŒä¸€ä¸ªå†…å­˜ä½ç½®ã€‚
- **`Waker`**ï¼š`Waker` æ˜¯ `Context` ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œç”¨äºé€šçŸ¥å¼‚æ­¥è¿è¡Œæ—¶å½“å‰ä»»åŠ¡éœ€è¦è¢«å”¤é†’ã€‚å½“ `Future` éœ€è¦ç»§ç»­æ‰§è¡Œæ—¶ï¼Œå®ƒä¼šé€šè¿‡ `Waker` æ¥é€šçŸ¥è¿è¡Œæ—¶ã€‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒRust çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹èƒ½å¤Ÿé«˜æ•ˆåœ°ç®¡ç†å¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œç¡®ä¿èµ„æºçš„åˆç†åˆ©ç”¨å’Œç¨‹åºçš„å“åº”æ€§ã€‚
