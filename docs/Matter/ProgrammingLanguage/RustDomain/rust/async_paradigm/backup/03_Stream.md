# Rust Stream

åœ¨ Rust ä¸­ï¼Œ`Stream` æ˜¯ä¸€ç§ç‰¹æ®Šçš„ `Future`ï¼Œå®ƒç”¨äºå¼‚æ­¥åœ°ç”Ÿæˆä¸€ç³»åˆ—å€¼ã€‚
ä¸æ™®é€šçš„ `Future` ä¸åŒï¼Œ`Stream` å¯ä»¥å¤šæ¬¡è¢« `await`ï¼Œæ¯æ¬¡éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å€¼ï¼Œç›´åˆ°æµç»“æŸã€‚

## ğŸ“‹ ç›®å½•

- [1 Stream Trait å®šä¹‰](#1-stream-trait-å®šä¹‰)
  - [1.1 ä½¿ç”¨ Stream](#11-ä½¿ç”¨-stream)
    - [1.1.1 ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ Stream](#111-ç¤ºä¾‹å®ç°ä¸€ä¸ªç®€å•çš„-stream)
  - [1.2 è§£é‡Š](#12-è§£é‡Š)
  - [1.3 å¼‚æ­¥è¿è¡Œæ—¶](#13-å¼‚æ­¥è¿è¡Œæ—¶)
- [2 Stream çš„ä¸»è¦ç”¨é€”](#2-stream-çš„ä¸»è¦ç”¨é€”)
- [3 å…¸å‹çš„ä»£ç ç¤ºä¾‹](#3-å…¸å‹çš„ä»£ç ç¤ºä¾‹)
  - [3.1 ç¤ºä¾‹ï¼šé€šè¿‡ futuresstreamiter æ¨¡æ‹Ÿæ•°æ®æµ](#31-ç¤ºä¾‹é€šè¿‡-futuresstreamiter-æ¨¡æ‹Ÿæ•°æ®æµ)
  - [3.2 ç¤ºä¾‹ï¼šä½¿ç”¨ async_stream å®æ„å»º Stream](#32-ç¤ºä¾‹ä½¿ç”¨-async_stream-å®æ„å»º-stream)
- [4 åˆ†æ](#4-åˆ†æ)
- [5 å¸¸è§çš„åä¾‹åŠè¯¯åŒº](#5-å¸¸è§çš„åä¾‹åŠè¯¯åŒº)
  - [5.1 åä¾‹ 1ï¼šåœ¨å¼‚æ­¥ Stream å†…è¿è¡Œå¯†é›†è®¡ç®—å¯¼è‡´é˜»å¡](#51-åä¾‹-1åœ¨å¼‚æ­¥-stream-å†…è¿è¡Œå¯†é›†è®¡ç®—å¯¼è‡´é˜»å¡)
  - [5.2 åä¾‹ 2ï¼šé”™è¯¯ä½¿ç”¨åŒæ­¥ Iterator æ›¿ä»£ Stream](#52-åä¾‹-2é”™è¯¯ä½¿ç”¨åŒæ­¥-iterator-æ›¿ä»£-stream)
- [6 æ€ç»´å¯¼å›¾æ€»ç»“](#6-æ€ç»´å¯¼å›¾æ€»ç»“)
- [7 æ€»ç»“](#7-æ€»ç»“)

---

## 1 Stream Trait å®šä¹‰

`Stream` trait å®šä¹‰åœ¨ `futures` crate ä¸­ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”Ÿæˆå™¨ï¼Œå¯ä»¥è¿ç»­äº§ç”Ÿå€¼ã€‚ä»¥ä¸‹æ˜¯ `Stream` trait çš„åŸºæœ¬å®šä¹‰ï¼š

```rust
trait Stream: Future<Output = ()> {
    type Item;
    // å°è¯•ä» Stream ä¸­å–å‡ºä¸‹ä¸€ä¸ªå€¼ï¼Œå¦‚æœæ²¡æœ‰å€¼å¯ç”¨ï¼Œåˆ™è¿”å› Poll::Pendingã€‚
    fn poll_next(
        self: Pin<&mut Self>,
        cx: &mut Context<'_>,
    ) -> Poll<Option<Self::Item>>;
}
```

- `type Item`ï¼šè¿™æ˜¯ä¸€ä¸ªå…³è”ç±»å‹ï¼Œå®šä¹‰äº† `Stream` äº§ç”Ÿçš„å€¼çš„ç±»å‹ã€‚
- `fn poll_next`ï¼šè¿™ä¸ªæ–¹æ³•å°è¯•ä» `Stream` ä¸­å–å‡ºä¸‹ä¸€ä¸ªå€¼ã€‚å¦‚æœ `Stream` å·²ç»ç»“æŸï¼Œåˆ™è¿”å› `Poll::Ready(None)`ï¼›å¦‚æœè¿˜æœ‰å€¼ï¼Œä½†å½“å‰ä¸èƒ½ç«‹å³æä¾›ï¼Œåˆ™è¿”å› `Poll::Pending`ï¼›å¦‚æœå½“å‰æœ‰ä¸€ä¸ªå€¼å¯ç”¨ï¼Œåˆ™è¿”å› `Poll::Ready(Some(item))`ã€‚

### 1.1 ä½¿ç”¨ Stream

ä½¿ç”¨ `Stream` é€šå¸¸æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š

1. å®ç° `Stream` traitã€‚
2. ä½¿ç”¨ `await` å¾ªç¯åœ°ä» `Stream` ä¸­è·å–å€¼ã€‚

#### 1.1.1 ç¤ºä¾‹ï¼šå®ç°ä¸€ä¸ªç®€å•çš„ Stream

```rust
use futures::Stream;
use std::pin::Pin;
use std::task::{Context, Poll};
use std::stream::StreamExt; // ç”¨äºç®€åŒ– Stream çš„ä½¿ç”¨

struct MyStream {
    items: Vec<i32>,
    index: usize,
}

impl Stream for MyStream {
    type Item = i32;

    fn poll_next(
        mut self: Pin<&mut Self>,
        _cx: &mut Context<'_>,
    ) -> Poll<Option<Self::Item>> {
        if self.index >= self.items.len() {
            Poll::Ready(None)
        } else {
            let item = self.items[self.index].take();
            self.index += 1;
            Poll::Ready(Some(item))
        }
    }
}

#[tokio::main]
async fn main() {
    let stream = MyStream {
        items: vec![1, 2, 3, 4, 5],
        index: 0,
    };

    // ä½¿ç”¨ StreamExt ç®€åŒ– Stream çš„ä½¿ç”¨
    let results: Vec<i32> = stream.collect().await;
    println!("Stream äº§ç”Ÿçš„å€¼ï¼š {:?}", results);
}
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š

- `MyStream` ç»“æ„ä½“å®ç°äº† `Stream` traitã€‚
- `poll_next` æ–¹æ³•è¿”å› `Stream` çš„ä¸‹ä¸€ä¸ªå€¼ï¼Œå¦‚æœæ²¡æœ‰æ›´å¤šå€¼ï¼Œåˆ™è¿”å› `None`ã€‚
- åœ¨ `main` å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª `MyStream` å®ä¾‹ï¼Œå¹¶ä½¿ç”¨ `.collect().await` æ¥æ”¶é›†æ‰€æœ‰çš„å€¼åˆ°ä¸€ä¸ª `Vec<i32>` ä¸­ã€‚

### 1.2 è§£é‡Š

- `Stream` å¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€ä¸ªå¯ä»¥å¤šæ¬¡ `await` çš„ `Future`ã€‚æ¯æ¬¡ `await` `Stream` æ—¶ï¼Œå®ƒéƒ½ä¼šå°è¯•äº§ç”Ÿä¸€ä¸ªæ–°çš„å€¼ã€‚
- `Stream` çš„ `poll_next` æ–¹æ³•è¢«è®¾è®¡ä¸ºå¯ä»¥è¢«å¤šæ¬¡è°ƒç”¨ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½å¯èƒ½äº§ç”Ÿä¸€ä¸ªæ–°çš„ `Poll`ã€‚
- ä½¿ç”¨ `StreamExt` ä¸­çš„æ–¹æ³•ï¼ˆå¦‚ `collect`ï¼‰å¯ä»¥ç®€åŒ–å¯¹ `Stream` çš„å¤„ç†ï¼Œä½¿å¾—ä»£ç æ›´åŠ æ˜“è¯»ã€‚

### 1.3 å¼‚æ­¥è¿è¡Œæ—¶

ä¸ `Future` ä¸€æ ·ï¼Œ`Stream` ä¹Ÿéœ€è¦åœ¨å¼‚æ­¥è¿è¡Œæ—¶ä¸­æ‰§è¡Œã€‚ä¾‹å¦‚ï¼ŒTokio æä¾›äº†è¿™æ ·çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå…è®¸ `Stream` è¢«æœ‰æ•ˆåœ°è°ƒåº¦å’Œæ‰§è¡Œã€‚

é€šè¿‡ `Stream`ï¼ŒRust çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹å¯ä»¥å¤„ç†å¤æ‚çš„å¼‚æ­¥æ•°æ®æµï¼Œä½¿å¾—ç¼–å†™é«˜æ€§èƒ½çš„å¼‚æ­¥ I/O åº”ç”¨ç¨‹åºæˆä¸ºå¯èƒ½ã€‚

ä¸‹é¢ä»‹ç» Rust å¼‚æ­¥ç¼–ç¨‹ä¸­ Stream çš„ä¸»è¦ç”¨é€”ã€ä»£ç ç¤ºä¾‹ã€èƒŒåçš„è®¾è®¡æ€æƒ³ï¼Œå¹¶ç»™å‡ºä¸€äº›å…¸å‹çš„åä¾‹è¯´æ˜å¸¸è§é”™è¯¯çš„ç”¨æ³•ã€‚

---

## 2 Stream çš„ä¸»è¦ç”¨é€”

åœ¨ Rust çš„ async ç”Ÿæ€ä¸­ï¼Œ**Stream** ç±»ä¼¼äºåŒæ­¥ç¨‹åºé‡Œçš„ Iteratorï¼Œä½†å®ƒç”¨äºæŒ‰éœ€å¼‚æ­¥äº§ç”Ÿä¸€ç³»åˆ—å€¼ã€‚ä¸»è¦ç”¨é€”åŒ…æ‹¬ï¼š

- **å¤„ç†æ¸è¿›å¼æ•°æ®æµ**  
  ä»ç½‘ç»œ socketã€æ–‡ä»¶ã€æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰å¼‚æ­¥æ•°æ®æºä¸­è¿ç»­æ¥æ”¶æ•°æ®ï¼Œä¾‹å¦‚ï¼šä¸€è¡Œä¸€è¡Œåœ°è¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œæˆ–è€…ä¸æ–­æ¥æ”¶ç½‘ç»œæ•°æ®åŒ…ã€‚

- **äº‹ä»¶æµä¸æ¶ˆæ¯æµ**  
  ç”¨äºå¤„ç† GUI äº‹ä»¶ã€å¼‚æ­¥ä¿¡é“çš„æ¶ˆæ¯ï¼ˆä¾‹å¦‚ Tokio çš„ mpsc ç­‰ï¼‰æˆ–å…¶å®ƒè§¦å‘å™¨äº§ç”Ÿçš„ç¦»æ•£äº‹ä»¶ã€‚

- **æ•°æ®ç®¡é“ä¸è½¬æ¢**  
  å°†ä¸€ç³»åˆ—å¼‚æ­¥æ•°æ®æŒ‰ä¸€å®šçš„è§„åˆ™è¿›è¡Œè½¬æ¢ã€è¿‡æ»¤ã€èšåˆç­‰æ“ä½œï¼Œç±»ä¼¼äºåœ¨ Iterator ä¸Šä½¿ç”¨è¯¸å¦‚ mapã€filterã€fold ç­‰ç»„åˆå™¨ã€‚

ä½¿ç”¨ Stream å¯ä»¥åœ¨ä¸é˜»å¡æ‰§è¡Œå™¨çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨å¼‚æ­¥ç®—å­é“¾åŠ¨æ€å¤„ç†æºæºä¸æ–­çš„æ•°æ®ï¼ŒåŒæ—¶æ”¯æŒèƒŒå‹æœºåˆ¶ï¼ˆback pressureï¼‰ï¼Œä¿è¯æ¶ˆè´¹è€…æŒ‰éœ€æ¶ˆè´¹æ•°æ®ã€‚

---

## 3 å…¸å‹çš„ä»£ç ç¤ºä¾‹

ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨ `futures` å’Œ `tokio` æä¾›çš„ stream å·¥å…·ï¼Œå±•ç¤ºå¦‚ä½•åˆ›å»ºå¹¶æ¶ˆè´¹ä¸€ä¸ªå¼‚æ­¥ streamã€‚

### 3.1 ç¤ºä¾‹ï¼šé€šè¿‡ futuresstreamiter æ¨¡æ‹Ÿæ•°æ®æµ

**æ–‡ä»¶è·¯å¾„ï¼š** `src/async_stream_example.rs`

```rust:src/async_stream_example.rs
use futures::stream::{self, StreamExt};
use tokio::time::{sleep, Duration};

#[tokio::main]
async fn main() {
    // æ¨¡æ‹Ÿä¸€ä¸ªæ•°æ®æµï¼Œäº§ç”Ÿ 1 åˆ° 5 çš„æ•°å­—ï¼Œæ¯ä¸ªæ•°å­—äº§ç”Ÿå‰å»¶æ—¶ 200 æ¯«ç§’
    let my_stream = stream::iter(1..=5).then(|num| async move {
        // æ¨¡æ‹Ÿå¼‚æ­¥ IO æ“ä½œ
        sleep(Duration::from_millis(200)).await;
        num
    });

    // æ¶ˆè´¹ stream çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®å°†æŒ‰é¡ºåºå¼‚æ­¥äº§ç”Ÿ
    tokio::pin!(my_stream);
    while let Some(value) = my_stream.next().await {
        println!("Received value: {}", value);
    }
}
```

### 3.2 ç¤ºä¾‹ï¼šä½¿ç”¨ async_stream å®æ„å»º Stream

ä½¿ç”¨ [async-stream](https://crates.io/crates/async-stream) crate å¯æ›´æ–¹ä¾¿åœ°ä¹¦å†™å¼‚æ­¥ streamã€‚

**æ–‡ä»¶è·¯å¾„ï¼š** `src/async_stream_macro_example.rs`

```rust:src/async_stream_macro_example.rs
use async_stream::stream;
use tokio::time::{sleep, Duration};
use futures::StreamExt;

#[tokio::main]
async fn main() {
    // ä½¿ç”¨ stream! å®å°†å¼‚æ­¥é€»è¾‘å†™å¾—æ›´è‡ªç„¶
    let my_stream = stream! {
        for i in 0..5 {
            // æ¨¡æ‹Ÿæ¯ä¸ªæ•°æ®é¡¹äº§ç”Ÿå‰çš„ç­‰å¾…
            sleep(Duration::from_millis(150)).await;
            yield i;
        }
    };

    tokio::pin!(my_stream);
    while let Some(item) = my_stream.next().await {
        println!("Yielded: {}", item);
    }
}
```

åœ¨ä»¥ä¸Šä¸¤ä¸ªç¤ºä¾‹ä¸­ï¼Œstream ç”¨äºå¼‚æ­¥äº§ç”Ÿæ•°æ®ï¼Œæ¶ˆè´¹ç«¯é€šè¿‡ `.next().await` æŒ‰é¡ºåºå–å¾—æ¯ä¸ªå€¼ï¼Œå¹¶å¯ä¸å…¶å®ƒå¼‚æ­¥æ“ä½œå¹¶å‘åä½œã€‚

---

## 4 åˆ†æ

- **å¼‚æ­¥æ•°æ®å¤„ç†**  
  Stream å…è®¸åœ¨å¼‚æ­¥ç¯å¢ƒä¸­æŒ‰éœ€æ‹‰å–æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨åŠ è½½ã€‚è¿™æ ·æ—¢èŠ‚çœå†…å­˜ï¼Œåˆèƒ½åº”å¯¹æ•°æ®æºå»¶è¿Ÿæˆ–ä¸ç¡®å®šæ€§ã€‚

- **äº‹ä»¶é“¾ä¸è½¬æ¢**  
  ç±»ä¼¼è¿­ä»£å™¨ï¼ŒStream æä¾›è¯¸å¦‚ `map`, `filter`, `fold` ç­‰ç»„åˆå™¨å‡½æ•°ï¼Œé€šè¿‡å‡½æ•°é“¾å¯ä»¥æ–¹ä¾¿åœ°å¯¹æ•°æ®æµè¿›è¡Œè½¬æ¢å’Œå½’çº³è®¡ç®—ã€‚

- **èƒŒå‹æœºåˆ¶**  
  å½“ç”Ÿäº§è€…ä¸æ–­äº§ç”Ÿæ•°æ®æ—¶ï¼Œæ¶ˆè´¹è€…å¯ä»¥æ ¹æ®å®é™…å¤„ç†é€Ÿåº¦æ§åˆ¶æµé‡ï¼Œé¿å…è¿‡å¤šæœªæ¶ˆè´¹çš„æ•°æ®å †ç§¯ï¼Œä»è€Œæ›´å¥½åœ°åˆ©ç”¨å¼‚æ­¥ä»»åŠ¡è°ƒåº¦å™¨ã€‚

- **ä¸å¼‚æ­¥è¿è¡Œæ—¶çš„é…åˆ**  
  ä¸ Tokio æˆ– async-std ç­‰è¿è¡Œæ—¶ç»“åˆï¼Œstream å…è®¸åœ¨ç­‰å¾… IO çš„åŒæ—¶è°ƒåº¦å…¶ä»–ä»»åŠ¡ï¼Œå½“æ•°æ®å°±ç»ªæ—¶é€šè¿‡ `.next().await` å¾—åˆ°å¯¹åº”çš„å€¼ã€‚

---

## 5 å¸¸è§çš„åä¾‹åŠè¯¯åŒº

ä¸‹é¢ç»™å‡ºä¸¤ä¸ªå¸¸è§åä¾‹è¯´æ˜ä¸æ­£ç¡®çš„ç”¨æ³•ï¼Œå¸®åŠ©é¿å…å¸¸è§é—®é¢˜ã€‚

### 5.1 åä¾‹ 1ï¼šåœ¨å¼‚æ­¥ Stream å†…è¿è¡Œå¯†é›†è®¡ç®—å¯¼è‡´é˜»å¡

**é—®é¢˜æè¿°ï¼š**  
å¦‚æœåœ¨ stream çš„ç”Ÿæˆè¿‡ç¨‹ä¸­è¿›è¡Œé•¿æ—¶é—´å¯†é›†è®¡ç®—è€Œä¸è¿›è¡Œå¼‚æ­¥ç­‰å¾…æ“ä½œï¼Œä¼šé˜»å¡å½“å‰ä»»åŠ¡ï¼Œå½±å“æ•´ä¸ªå¼‚æ­¥è¿è¡Œæ—¶ã€‚ä¾‹å¦‚ï¼š

```rust:src/stream_blocking_example.rs
use futures::stream::{self, StreamExt};

fn heavy_computation(x: u32) -> u32 {
    // æ¨¡æ‹Ÿå¯†é›†è®¡ç®—ï¼ˆæ— ä»»ä½• awaitï¼‰
    let mut sum = 0;
    for i in 0..1_000_000 {
        sum = sum.wrapping_add(i);
    }
    x + sum
}

#[tokio::main]
async fn main() {
    // è¿™é‡Œç›´æ¥è¿­ä»£å¹¶åœ¨åŒæ­¥ä»£ç ä¸­è°ƒç”¨ heavy_computation
    // å°†å¯¼è‡´ä»»åŠ¡åœ¨å¼‚æ­¥æ‰§è¡Œå™¨ä¸­é•¿æ—¶é—´å ç”¨ CPUï¼Œé˜»å¡å…¶å®ƒä»»åŠ¡ã€‚
    let my_stream = stream::iter(1..=5).map(|num| heavy_computation(num));
    tokio::pin!(my_stream);
    while let Some(result) = my_stream.next().await {
        println!("Result: {}", result);
    }
}
```

**é—®é¢˜åˆ†æï¼š**  
ä¸Šä¾‹ä¸­ï¼Œ`heavy_computation` æ˜¯ä¸€ä¸ªåŒæ­¥è€—æ—¶ä»»åŠ¡ï¼Œç›´æ¥åœ¨ stream ä¸­è°ƒç”¨åæ²¡æœ‰ä»»ä½• `.await` æˆ–è€…å¼‚æ­¥è°ƒåº¦ï¼Œè¢«é˜»å¡çš„éƒ¨åˆ†ä¼šå»¶è¿Ÿå…¶å®ƒå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œï¼Œå¤±å»äº†å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜åŠ¿ã€‚æ­¤æ—¶åº”è€ƒè™‘æ”¾åˆ° [`tokio::task::spawn_blocking`] ä¸­æˆ–å¼•å…¥é€‚å½“çš„ yield æ“ä½œã€‚

---

### 5.2 åä¾‹ 2ï¼šé”™è¯¯ä½¿ç”¨åŒæ­¥ Iterator æ›¿ä»£ Stream

**é—®é¢˜æè¿°ï¼š**  
åœ¨å¼‚æ­¥åœºæ™¯ä¸‹ï¼Œé”™è¯¯åœ°ä½¿ç”¨åŒæ­¥ Iterator è¿›è¡Œæ•°æ®å¤„ç†ä¼šä½¿å¾—ç¨‹åºä¸èƒ½æ­£ç¡®åˆ©ç”¨å¼‚æ­¥ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼š

```rust:src/sync_iterator_wrong.rs
fn sync_iter() -> impl Iterator<Item = u32> {
    // ç›´æ¥äº§ç”Ÿä¸€ä¸ªåŒæ­¥è¿­ä»£å™¨ï¼ˆéå¼‚æ­¥æ•°æ®æµï¼‰
    (1..=5).into_iter()
}

#[tokio::main]
async fn main() {
    // é”™è¯¯ï¼šè¿™é‡Œä½¿ç”¨åŒæ­¥ Iteratorï¼Œå¹¶è¯•å›¾åœ¨å¼‚æ­¥å‡½æ•°ä¸­ç­‰å¾…
    // è¿™æ— æ³•æ­£ç¡®åˆ‡æ¢ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šåœ¨å¼‚æ­¥ä¸Šä¸‹æ–‡ä¸­è´¡çŒ®èƒŒå‹ç‰¹æ€§ã€‚
    for value in sync_iter() {
        // å¦‚æœä¼å›¾è°ƒç”¨ async æ“ä½œå¿…é¡»è°ƒç”¨ .awaitï¼Œä½†è¿™é‡Œæ²¡æœ‰ await ç‚¹
        println!("Sync value: {}", value);
    }
    // æ­£ç¡®åšæ³•æ˜¯ä½¿ç”¨ Stream æ¥ç”Ÿæˆå¹¶å¼‚æ­¥æ¶ˆè´¹æ•°æ®
}
```

**é—®é¢˜åˆ†æï¼š**  
ä¸Šä¾‹ä¸­ä½¿ç”¨çš„ Iterator æ— æ³•æ’å…¥å¼‚æ­¥ç­‰å¾…ç‚¹ï¼Œæ—¢ä¸é‡Šæ”¾å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæƒï¼Œä¹Ÿä¸æ”¯æŒå¼‚æ­¥ç»„åˆå™¨ã€‚å¦‚æœæ•°æ®æºæœ¬èº«æ˜¯å¼‚æ­¥ï¼ˆä¾‹å¦‚ç½‘ç»œ I/Oï¼‰ï¼Œåº”ä½¿ç”¨ Stream æ¥å»ºæ¨¡ï¼Œç¡®ä¿å¼‚æ­¥ä»»åŠ¡èƒ½å¤ŸæŒ‰éœ€è°ƒåº¦å’Œç­‰å¾…ã€‚

---

## 6 æ€ç»´å¯¼å›¾æ€»ç»“

ä¸‹é¢æä¾›ä¸€ä¸ª Mermaid æ€ç»´å¯¼å›¾ï¼Œæ¦‚æ‹¬äº† Rust async ä¸­ Stream çš„ä¸»è¦ç”¨é€”ã€æ­£ç¡®ç”¨æ³•ä»¥åŠå¸¸è§é”™è¯¯åœºæ™¯ï¼š

```mermaid:diagram/rust_async_stream.mmd
flowchart TD
    A[Async Stream]
    A --> B[ä¸»è¦ç”¨é€”]
    B --> B1[æ¸è¿›å¼æ•°æ®å¤„ç†]
    B --> B2[äº‹ä»¶/æ¶ˆæ¯æµ]
    B --> B3[æ•°æ®ç®¡é“è½¬æ¢]
    
    A --> C[æ­£ç¡®ä½¿ç”¨]
    C --> C1[æŒ‰éœ€äº§ç”Ÿæ•°æ®]
    C --> C2[æ’å…¥å¼‚æ­¥ç­‰å¾…ï¼Œé¿å…é˜»å¡]
    C --> C3[ä½¿ç”¨ç»„åˆå™¨(map/filter/fold)]
    
    A --> D[ä»£ç ç¤ºä¾‹]
    D --> D1[ä½¿ç”¨ futures::stream::iter & then]
    D --> D2[ä½¿ç”¨ async_stream::stream å®]
    
    A --> E[å¸¸è§åä¾‹]
    E --> E1[åœ¨ Stream å†…è¿›è¡Œé˜»å¡å¼å¯†é›†è®¡ç®—]
    E --> E2[é”™è¯¯ä½¿ç”¨åŒæ­¥ Iterator æ›¿ä»£ Stream]
```

---

## 7 æ€»ç»“

- **ä¸»è¦ç”¨é€”ï¼š**  
  Stream åœ¨å¼‚æ­¥é€šä¿¡ä¸­ç”¨äºæŒ‰éœ€å¼‚æ­¥äº§ç”Ÿä¸€ç³»åˆ—æ•°æ®ï¼Œé€‚ç”¨äºç½‘ç»œã€æ–‡ä»¶ I/Oã€äº‹ä»¶å¤„ç†ç­‰åœºæ™¯ã€‚

- **æ­£ç¡®ç”¨æ³•ï¼š**  
  åˆ©ç”¨å¼‚æ­¥ç­‰å¾…ï¼ˆä¾‹å¦‚ sleepã€I/O ç­‰ï¼‰æ¥äº§ç”Ÿæ•°æ®ï¼Œä½¿ç”¨ç»„åˆå™¨å‡½æ•°å¯¹æ•°æ®æµè¿›è¡Œè½¬æ¢ï¼Œå¹¶é€šè¿‡ `.next().await` æŒ‰é¡ºåºæ¶ˆè´¹æ•°æ®ã€‚

- **åä¾‹è­¦ç¤ºï¼š**  
  é¿å…åœ¨ stream ä¸­è¿›è¡Œè€—æ—¶çš„åŒæ­¥è®¡ç®—ï¼›ä¸è¦å°†æ™®é€šçš„ Iterator å½“ä½œå¼‚æ­¥æµä½¿ç”¨ï¼Œå¦åˆ™å°†å¤±å»å¼‚æ­¥ç¼–ç¨‹çš„å¥½å¤„ã€‚

é€šè¿‡æ­£ç¡®ç†è§£å’Œä½¿ç”¨ async Streamï¼Œå¯ä»¥å……åˆ†å‘æŒ¥å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜åŠ¿ï¼Œä»è€Œæ„å»ºé«˜æ•ˆã€å“åº”åŠæ—¶çš„æ•°æ®å¤„ç†ç³»ç»Ÿã€‚
