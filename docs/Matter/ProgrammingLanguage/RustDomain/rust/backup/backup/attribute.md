# Rust å±æ€§ï¼ˆattributeï¼‰

ä¸‹é¢å¯¹ Rust ä¸­çš„**å±æ€§ï¼ˆattributeï¼‰**çš„å®šä¹‰ã€è§£é‡Šå’Œä½¿ç”¨åšè¯¦ç»†è¯´æ˜ã€‚

## ğŸ“‹ ç›®å½•

- [1 å±æ€§çš„å®šä¹‰ä¸åŸºæœ¬æ¦‚å¿µ](#1-å±æ€§çš„å®šä¹‰ä¸åŸºæœ¬æ¦‚å¿µ)
- [2 å¸¸è§çš„å†…ç½®å±æ€§åŠå…¶ä½œç”¨](#2-å¸¸è§çš„å†…ç½®å±æ€§åŠå…¶ä½œç”¨)
- [3 è‡ªå®šä¹‰å±æ€§åŠè¿‡ç¨‹å®](#3-è‡ªå®šä¹‰å±æ€§åŠè¿‡ç¨‹å®)
- [4 å±æ€§çš„å®é™…ä½¿ç”¨ç¤ºä¾‹](#4-å±æ€§çš„å®é™…ä½¿ç”¨ç¤ºä¾‹)
  - [4.1 ç¤ºä¾‹ 1ï¼šè‡ªåŠ¨æ´¾ç”Ÿ trait](#41-ç¤ºä¾‹-1è‡ªåŠ¨æ´¾ç”Ÿ-trait)
  - [4.2 ç¤ºä¾‹ 2ï¼šæ¡ä»¶ç¼–è¯‘](#42-ç¤ºä¾‹-2æ¡ä»¶ç¼–è¯‘)
  - [4.3 ç¤ºä¾‹ 3ï¼šæ§åˆ¶è­¦å‘Š](#43-ç¤ºä¾‹-3æ§åˆ¶è­¦å‘Š)
- [5 æ€»ç»“](#5-æ€»ç»“)

---

## 1 å±æ€§çš„å®šä¹‰ä¸åŸºæœ¬æ¦‚å¿µ

- **ä»€ä¹ˆæ˜¯å±æ€§ï¼Ÿ**  
  å±æ€§æ˜¯é™„åŠ åœ¨ä»£ç é¡¹ï¼ˆå¦‚ crateã€æ¨¡å—ã€ç»“æ„ä½“ã€æšä¸¾ã€å‡½æ•°ã€å˜é‡ç­‰ï¼‰ä¸Šçš„å…ƒæ•°æ®ï¼Œå®ƒä»¬æä¾›ç»™ç¼–è¯‘å™¨é¢å¤–ä¿¡æ¯ï¼Œæ§åˆ¶ç¼–è¯‘ã€å®å±•å¼€ã€æ¡ä»¶ç¼–è¯‘ã€ä»£ç ç”Ÿæˆç­‰è¡Œä¸ºã€‚å±æ€§é€šå¸¸ä»¥ `#` å¼€å¤´ï¼Œç´§è·Ÿä¸€å¯¹æ–¹æ‹¬å· `[...]` è¡¨ç¤ºã€‚

- **å±æ€§çš„ä¸¤ç§å½¢å¼ï¼š**  
  - **å¤–éƒ¨å±æ€§ï¼ˆOuter Attributesï¼‰**ï¼š  
    å†™åœ¨é¡¹çš„å¤–éƒ¨ï¼Œç”¨æ¥ä¿®é¥°æ¥ä¸‹æ¥çš„ä»£ç ã€‚ä¾‹å¦‚ï¼š

  ```rust
  #[derive(Debug, Clone)]
  struct MyStruct {
      value: i32,
  }
  ```

  è¿™é‡Œ `#[derive(Debug, Clone)]` å°±æ˜¯ä¸€ä¸ªå¤–éƒ¨å±æ€§ï¼Œä½œç”¨æ˜¯è‡ªåŠ¨ä¸º `MyStruct` å®ç° `Debug` ä¸ `Clone` traitã€‚

  - **å†…éƒ¨å±æ€§ï¼ˆInner Attributesï¼‰**ï¼š  
    å†™åœ¨æ–‡ä»¶æˆ–æ¨¡å—çš„æœ€å‰é¢ï¼Œé€šå¸¸ä»¥ `#![attribute]` å½¢å¼å‡ºç°ï¼Œç”¨äºç»™æ•´ä¸ªæ¨¡å—æˆ– crate æ·»åŠ å…ƒæ•°æ®ã€‚ä¾‹å¦‚ï¼Œåœ¨ crate æ ¹æ–‡ä»¶ï¼ˆå¦‚ `lib.rs` æˆ– `main.rs`ï¼‰ä¸­ï¼š

```rust
#![allow(dead_code)]
```

è¯¥å±æ€§å‘Šè¯‰ç¼–è¯‘å™¨å¯¹æ•´ä¸ª crate æ”¾å®½æ­»ä»£ç ï¼ˆdead codeï¼‰è­¦å‘Šã€‚

---

## 2 å¸¸è§çš„å†…ç½®å±æ€§åŠå…¶ä½œç”¨

Rust æ ‡å‡†åº“å’Œç¼–è¯‘å™¨å®šä¹‰äº†ä¸€äº›å¸¸è§å±æ€§ï¼Œæ¯ä¸ªå±æ€§éƒ½æœ‰ç‰¹å®šçš„ç”¨é€”ã€‚å¸¸è§çš„æœ‰ï¼š

- **`#[derive(...)]`**  
  è‡ªåŠ¨ä¸ºæ•°æ®ç»“æ„ç”Ÿæˆ trait å®ç°ï¼Œä¾‹å¦‚ `Debug`ã€`Clone`ã€`PartialEq` ç­‰ã€‚

```rust
#[derive(Debug, PartialEq)]
struct Point {
    x: i32,
    y: i32,
}
```

- **`#[cfg(...)]`**  
  æ¡ä»¶ç¼–è¯‘å±æ€§ï¼Œç”¨äºåœ¨ä¸åŒå¹³å°æˆ–æ¡ä»¶ä¸‹ç¼–è¯‘ä¸åŒä»£ç ã€‚

```rust
#[cfg(target_os = "linux")]
fn linux_only() {
    println!("è¿™æ®µä»£ç åªåœ¨ Linux å¹³å°ä¸Šç¼–è¯‘è¿è¡Œ");
}
```

- **`#[inline]` / `#[inline(always)]`**  
  æç¤ºç¼–è¯‘å™¨å¯¹å‡½æ•°è¿›è¡Œå†…è”ä¼˜åŒ–ã€‚

```rust
#[inline]
fn add(a: i32, b: i32) -> i32 {
    a + b
}
```

- **`#[test]`**  
  æ ‡è®°æµ‹è¯•å‡½æ•°ï¼Œç”¨äºè‡ªåŠ¨æµ‹è¯•ã€‚

```rust
#[cfg(test)]
mod tests {
    #[test]
    fn test_add() {
        assert_eq!(2 + 2, 4);
    }
}
```

- **`#![allow(...)]` å’Œ `#![warn(...)]`**  
  æ§åˆ¶ç¼–è¯‘å™¨è­¦å‘Šã€‚ä¾‹å¦‚åœ¨ crate æ ¹æ–‡ä»¶ä¸­ï¼š

```rust
#![allow(unused_variables)]
```

---

## 3 è‡ªå®šä¹‰å±æ€§åŠè¿‡ç¨‹å®

- **è‡ªå®šä¹‰å±æ€§**  
  é™¤äº†å†…ç½®å±æ€§å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡è¿‡ç¨‹å®ï¼ˆproc-macroï¼‰è‡ªå®šä¹‰æ´¾ç”Ÿå±æ€§ã€‚ä¾‹å¦‚ï¼Œ`serde` åº“æä¾›äº†ï¼š

```rust
#[derive(Serialize, Deserialize)]
struct Person {
    name: String,
    age: u8,
}
```

è¿™é‡Œï¼Œ`Serialize` ä¸ `Deserialize` ä¾¿æ˜¯é€šè¿‡è¿‡ç¨‹å®å®ç°çš„è‡ªå®šä¹‰å±æ€§ï¼Œè‡ªåŠ¨ç”Ÿæˆåºåˆ—åŒ–ä¸ååºåˆ—åŒ–ä»£ç ã€‚

- **å¦‚ä½•å®šä¹‰è‡ªå®šä¹‰è¿‡ç¨‹å®å±æ€§**  
  è‡ªå®šä¹‰è¿‡ç¨‹å®éœ€è¦æ–°å»ºä¸€ä¸ª proc-macro crateï¼Œåœ¨å…¶ä¸­ä½¿ç”¨ `proc_macro` å’Œç›¸å…³å®å·¥å…·ã€‚
  ç¤ºä¾‹ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```rust
// Cargo.toml ä¸­éœ€è¦æŒ‡å®š crate-type ä¸º proc-macro
// [lib]
// proc-macro = true

extern crate proc_macro;
use proc_macro::TokenStream;

#[proc_macro_attribute]
pub fn my_attribute(_attr: TokenStream, item: TokenStream) -> TokenStream {
    // å¤„ç†ä¼ å…¥çš„ itemï¼Œå¯ä»¥ç”Ÿæˆä¿®æ”¹åçš„ä»£ç 
    item
}
```

  ä½¿ç”¨ï¼š

```rust
#[my_attribute]
fn example() {
    println!("è¿™æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„å±æ€§å‡½æ•°");
}
```

---

## 4 å±æ€§çš„å®é™…ä½¿ç”¨ç¤ºä¾‹

ä¸‹é¢é€šè¿‡å‡ ä¸ªç¤ºä¾‹å±•ç¤ºå±æ€§åœ¨å®é™…å¼€å‘ä¸­çš„ä½¿ç”¨åœºæ™¯ã€‚

### 4.1 ç¤ºä¾‹ 1ï¼šè‡ªåŠ¨æ´¾ç”Ÿ trait

```rust:src/derive_example.rs
#[derive(Debug, Clone, PartialEq)]
struct MyStruct {
    id: u32,
    name: String,
}

fn main() {
    let a = MyStruct { id: 1, name: "Rustacean".to_string() };
    // è‡ªåŠ¨ç”Ÿæˆçš„ Debug å®ç°ä½¿å¾—å¯ä»¥ç›´æ¥ä½¿ç”¨ {:?} æ ¼å¼åŒ–è¾“å‡º
    println!("MyStruct a: {:?}", a);

    // é€šè¿‡è‡ªåŠ¨ç”Ÿæˆçš„ Clone å®ç°è¿›è¡Œå…‹éš†æ“ä½œ
    let b = a.clone();
    println!("å…‹éš†åçš„ b: {:?}", b);

    // PartialEq å®ç°æ”¯æŒç›´æ¥æ¯”è¾ƒ
    assert_eq!(a, b);
}
```

### 4.2 ç¤ºä¾‹ 2ï¼šæ¡ä»¶ç¼–è¯‘

```rust:src/cfg_example.rs
#[cfg(target_os = "windows")]
fn check_os() {
    println!("å½“å‰è¿è¡Œåœ¨ Windows å¹³å°");
}

#[cfg(target_os = "linux")]
fn check_os() {
    println!("å½“å‰è¿è¡Œåœ¨ Linux å¹³å°");
}

fn main() {
    check_os();
}
```

### 4.3 ç¤ºä¾‹ 3ï¼šæ§åˆ¶è­¦å‘Š

åœ¨ crate æ ¹æ–‡ä»¶ä¸­ï¼ˆå¦‚ `main.rs`ï¼‰ï¼Œä½¿ç”¨å†…éƒ¨å±æ€§æ§åˆ¶è­¦å‘Šï¼š

```rust:src/main.rs
#![allow(dead_code)]

fn unused_function() {
    // è¿™ä¸ªå‡½æ•°å³ä½¿æœªè¢«è°ƒç”¨ï¼Œä¹Ÿä¸ä¼šè§¦å‘æ­»ä»£ç è­¦å‘Š
}

fn main() {
    println!("Rust å±æ€§ç¤ºä¾‹");
}
```

---

## 5 æ€»ç»“

- **å±æ€§**ä¸º Rust æä¾›äº†ä¸€ç§å¼ºå¤§çš„å…ƒæ•°æ®æœºåˆ¶ï¼Œå¸®åŠ©æ§åˆ¶ç¼–è¯‘å™¨è¡Œä¸ºå’Œè‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œæå¤§åœ°ç®€åŒ–äº†ä»£ç å¼€å‘å·¥ä½œã€‚
- å¸¸è§çš„å†…ç½®å±æ€§åŒ…æ‹¬ `derive`ã€`cfg`ã€`inline`ã€`test` ç­‰ï¼Œå…¶ä½¿ç”¨æ–¹å¼å¤šæ ·ä¸”åŠŸèƒ½ä¸°å¯Œã€‚
- å±æ€§å¯ä»¥åˆ†ä¸ºå¤–éƒ¨å±æ€§å’Œå†…éƒ¨å±æ€§ï¼Œæ ¹æ®ä½ç½®å’Œç”¨é€”æœ‰æ‰€ä¸åŒã€‚
- å€ŸåŠ©è¿‡ç¨‹å®ï¼Œè¿˜å¯ä»¥å®ç°è‡ªå®šä¹‰å±æ€§ï¼Œä¸ºç‰¹å®šåœºæ™¯ç”Ÿæˆä¸“é—¨çš„ä»£ç ã€‚

é€šè¿‡åˆç†åˆ©ç”¨ Rust çš„å±æ€§æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™å‡ºæ—¢ç®€æ´åˆé«˜æ•ˆçš„ä»£ç ï¼ŒåŒæ—¶å…¼é¡¾ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œçµæ´»æ€§ã€‚
