# 07.6.2 重构 (Refactoring)

## 目录

- [07.6.2 重构 (Refactoring)](#0762-重构-refactoring)
  - [目录](#目录)
  - [1. 定义与背景](#1-定义与背景)
  - [2. 批判性分析](#2-批判性分析)
  - [3. 核心概念与实践](#3-核心概念与实践)
  - [4. 形式化表达](#4-形式化表达)
  - [5. 交叉引用](#5-交叉引用)
  - [6. 参考文献](#6-参考文献)

---

## 1. 定义与背景

重构是在**不改变软件可观察行为**的前提下，对代码进行修改，以提高其内部结构的过程。它是一种系统性的、有纪律的清理代码的方法，旨在降低技术债务、提高代码的可理解性和可维护性。

---

## 2. 批判性分析

- **关键点**: 重构的精髓在于"小步快跑"和"行为保持"。每次重构都应该是小规模的、可验证的。重构不是添加新功能，也不是修复bug，尽管它可能使得添加功能和修复bug变得更容易。
- **挑战**: 何时重构？（"预备性重构"、"理解性重构"、"捡垃圾式重构"）。如何说服管理者为"没有产出新功能"的活动投入时间？

---

## 3. 核心概念与实践

- **代码坏味道 (Code Smells)**:
  - **描述**: 由Kent Beck和Martin Fowler推广，指代码中可能预示着深层问题的某种结构。坏味道本身不一定是错误的，但它们是值得检查的信号。
  - **示例**: 重复代码、过长方法、过大类、过长参数列表、数据泥团、依恋情结等。
- **常见重构手法**:
  - **提取方法 (Extract Method)**: 将一段代码从一个较长的方法中提取出来，放入一个新的、独立的、命名良好的方法中。
  - **内联方法 (Inline Method)**: 提取方法的逆操作。
  - **提取变量 (Extract Variable)**: 将复杂的表达式替换为一个命名良好的临时变量。
  - **以查询取代临时变量 (Replace Temp with Query)**
  - **提炼类 (Extract Class)**: 当一个类承担了两个或更多的职责时，将其中的一个职责分离到一个新的类中。
- **重构与测试**:
  - **描述**: 一套健壮的、自动化的单元测试是进行安全重构的**先决条件**。测试套件就像一个安全网，可以在重构破坏了原有功能时快速给出反馈。

---

## 4. 形式化表达

**重构的节奏**:

```mermaid
graph TD
    A[开始] --> B{有测试吗?};
    B -- No --> C[编写测试];
    B -- Yes --> D;
    C --> D;
    D[小步修改代码<br><i>(如: 提取方法)</i>] --> E[运行测试];
    E -- 测试通过 --> F{还有坏味道?};
    E -- 测试失败 --> G[修复/回滚];
    G --> D;
    F -- Yes --> D;
    F -- No --> H[结束];
```

---

## 5. 交叉引用

- [软件维护与演化总览](./README.md)
- [代码质量与度量](../07.5_Software_Quality_and_Testing/07.5.3_Code_Quality_and_Metrics.md)
- [测试理论与层级](../07.5_Software_Quality_and_Testing/07.5.2_Testing_Theory_and_Levels.md)

---

## 6. 参考文献

1. Fowler, Martin. *Refactoring: Improving the Design of Existing Code*. 1999 (2nd Edition, 2018).
2. Kerievsky, Joshua. *Refactoring to Patterns*. 2004.
