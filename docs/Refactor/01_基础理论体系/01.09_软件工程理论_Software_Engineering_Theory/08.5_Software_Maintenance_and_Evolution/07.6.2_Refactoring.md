# 07.6.2 重构 (Refactoring)

## 目录

- [07.6.2 重构 (Refactoring)](#0762-重构-refactoring)
  - [目录](#目录)
  - [1. 定义与背景](#1-定义与背景)
  - [2. 批判性分析](#2-批判性分析)
  - [3. 核心概念与实践](#3-核心概念与实践)
  - [4. 形式化表达](#4-形式化表达)
  - [5. 交叉引用](#5-交叉引用)
  - [6. 参考文献](#6-参考文献)

---

## 1. 定义与背景

重构是在**不改变软件可观察行为**的前提下，对代码进行修改，以提高其内部结构的过程。它是一种系统性的、有纪律的清理代码的方法，旨在降低技术债务、提高代码的可理解性和可维护性。

---

## 2. 批判性分析

### 多元理论视角

- 工程视角：重构为软件工程提供系统化的代码改进方法论。
- 质量视角：重构通过改善代码结构提高软件质量和可维护性。
- 管理视角：重构涉及资源投入和风险管理的决策。
- 技术视角：重构需要深入理解代码结构和设计模式。

### 局限性

- 风险控制：重构可能引入新的缺陷，特别是在大型系统中。
- 成本评估：重构的成本和收益难以准确量化。
- 时机选择：何时进行重构的决策困难。
- 团队技能：重构效果高度依赖团队的技术能力。

### 争议与分歧

- 重构时机：预防性重构vs问题驱动重构。
- 重构范围：大规模重构vs小步重构。
- 测试覆盖：重构对测试覆盖度的要求。
- 管理支持：如何获得管理层对重构活动的支持。

### 应用前景

- 遗留系统：大型遗留系统的现代化改造。
- 敏捷开发：敏捷开发中的持续重构实践。
- 代码质量：提高代码质量和可维护性。
- 技术债务：管理和减少技术债务。

### 改进建议

- 发展自动化重构工具和智能分析技术。
- 建立重构效果评估和度量体系。
- 推进重构最佳实践和标准化。
- 加强重构教育和培训。

---

## 3. 核心概念与实践

- **代码坏味道 (Code Smells)**:
  - **描述**: 由Kent Beck和Martin Fowler推广，指代码中可能预示着深层问题的某种结构。坏味道本身不一定是错误的，但它们是值得检查的信号。
  - **示例**: 重复代码、过长方法、过大类、过长参数列表、数据泥团、依恋情结等。
- **常见重构手法**:
  - **提取方法 (Extract Method)**: 将一段代码从一个较长的方法中提取出来，放入一个新的、独立的、命名良好的方法中。
  - **内联方法 (Inline Method)**: 提取方法的逆操作。
  - **提取变量 (Extract Variable)**: 将复杂的表达式替换为一个命名良好的临时变量。
  - **以查询取代临时变量 (Replace Temp with Query)**
  - **提炼类 (Extract Class)**: 当一个类承担了两个或更多的职责时，将其中的一个职责分离到一个新的类中。
- **重构与测试**:
  - **描述**: 一套健壮的、自动化的单元测试是进行安全重构的**先决条件**。测试套件就像一个安全网，可以在重构破坏了原有功能时快速给出反馈。

---

## 4. 形式化表达

**重构的节奏**:

```mermaid
graph TD
    A[开始] --> B{有测试吗?};
    B -- No --> C[编写测试];
    B -- Yes --> D;
    C --> D;
    D[小步修改代码<br><i>(如: 提取方法)</i>] --> E[运行测试];
    E -- 测试通过 --> F{还有坏味道?};
    E -- 测试失败 --> G[修复/回滚];
    G --> D;
    F -- Yes --> D;
    F -- No --> H[结束];
```

---

## 5. 交叉引用

- [软件维护与演化总览](README.md)
- [代码质量与度量](../07.5_Software_Quality_and_Testing/07.5.3_Code_Quality_and_Metrics.md)
- [测试理论与层级](../07.5_Software_Quality_and_Testing/07.5.2_Testing_Theory_and_Levels.md)

---

## 6. 参考文献

1. Fowler, Martin. *Refactoring: Improving the Design of Existing Code*. 1999 (2nd Edition, 2018).
2. Kerievsky, Joshua. *Refactoring to Patterns*. 2004.
