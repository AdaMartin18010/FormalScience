# 04.1.3 Hindley–Milner 类型系统 (HM)

## 📋 概述

HM 提供多态类型与高效类型推断（Damas–Milner 算法W），是函数式语言（ML/OCaml/Haskell早期核心）的经典基础。

## 要点

- 类型模式：`∀α. τ`（let‑多态），实例化与泛化
- 约束生成与合一（unification），替换与最普遍合一（MGU）
- 算法W：自顶向下推断并生成替换，let 处泛化，使用处实例化

## 规则（轮廓）

- Var/Abs/App 与 STLC 类似，let：`let x = e1 in e2`
- 环境多态：`Γ ⊢ e1 : τ` 后，`σ = generalize(Γ, τ)`，在 `e2` 中以 `x:σ` 扩展环境

## 示例

```haskell
-- 算法W（极简伪码，演示思路）
w Γ e = case e of
  Var x      -> ([], instantiate (lookup Γ x))
  Abs x e1   -> let a = freshTyVar()
                    (s1, t1) = w (Γ ∪ {x : a}) e1
                in (s1, s1 a -> t1)
  App e1 e2  -> let (s1, t1) = w Γ e1
                    (s2, t2) = w (s1 Γ) e2
                    a = freshTyVar()
                    s3 = unify (s2 t1) (t2 -> a)
                in (s3 ∘ s2 ∘ s1, s3 a)
  Let x e1 e2-> let (s1, t1) = w Γ e1
                    σ = generalize (s1 Γ) t1
                in w (s1 Γ ∪ {x : σ}) e2
```

```haskell
-- 示例：let id = \x -> x in (id 1, id True)
-- 推断到 (Int, Bool)
```

## 参考文献

- Damas & Milner (1982)；Pierce TAPL；OCaml/Haskell 文档

## 批判性分析

- 多元理论视角：
  - 实用多态核心：在保持推断可行性的前提下提供强表达力，成为工程上“默认多态”的基线。
  - 语义承载：与约束系统、区域/效应标签等组合，形成可扩展的静态分析框架。
- 局限性分析：
  - let‑多态边界：递归与多态递归的限制；与类型类、GADTs、Rank‑N 的交互需额外机制。
  - 错误可读性：复杂合一错误对新手不友好，需要IDE与提示工程支撑。
- 争议与分歧：
  - 推断 vs. 注解：完全推断的便利与错误定位的可解释性之间的权衡。
- 应用前景：
  - DSL 与通用语言的多态内核；与效果系统/线性约束结合以提升工程适配性。
- 改进建议：
  - 建立“HM+约束/效果”的教程化模板与错误消息设计准则；提供可交互的可视化合一调试器。
