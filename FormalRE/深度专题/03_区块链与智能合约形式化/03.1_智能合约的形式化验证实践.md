# 智能合约的形式化验证实践

> **主题**: 智能合约验证工具与实践
> **核心**: 形式化方法+静态分析+符号执行
> **重要性**: ⭐⭐⭐⭐⭐
> **创建日期**: 2025-12-02

---

## 1. 验证工具生态

### 工具分类图

```text
    智能合约验证工具
            |
    ┌───────┼───────┐
    |       |       |
  静态    符号    形式化
  分析    执行    验证
    |       |       |
    ↓       ↓       ↓
 Slither Mythril  Certora
 Solhint Manticore K框架
    |       |       |
   快✓    中等    慢⚠️
   浅     中等    深✓
```

---

## 2. Slither静态分析

```text
Slither (Trail of Bits):

检测漏洞:
✓ 重入攻击
✓ 整数溢出/下溢
✓ 未检查返回值
✓ 访问控制缺失
✓ 时间戳依赖

示例:
slither contract.sol

输出:
- 高危: 3个
- 中危: 5个
- 低危: 10个

复杂度: O(n) (AST遍历)
误报率: 中等 ⚠️

递归理论:
✓ 静态分析 ∈ 可判定 (特定模式)
✗ 但Rice定理: 无法完全
```

---

## 3. Mythril符号执行

```text
Mythril (ConsenSys):

原理:
1. 符号执行路径
2. SMT求解器
3. 查找反例

检测:
✓ 重入
✓ 整数问题
✓ 访问控制
✓ 未检查调用

复杂度: O(2^n) (路径爆炸)
实践: 超时机制 (5分钟)

案例:
mythril analyze contract.sol

→ 发现The DAO漏洞类型 ✓
```

---

## 4. Certora形式化验证

```text
Certora Prover:

方法: CVL (Certora Verification Language)

规范示例:
rule totalSupplyConsistent {
  uint256 before = totalSupply();
  method f; env e;
  calldataarg args;
  f(e, args);
  uint256 after = totalSupply();

  assert before <= after;
}

验证:
✓ 不变量保持
✓ 状态转移正确
✓ 全路径覆盖 (理论上)

成本:
⚠️ 商业工具 (昂贵)
⚠️ 需要专业知识
✓ 高价值合约值得

成功案例:
- Aave
- Compound
- MakerDAO
```

---

## 5. 验证策略矩阵

| 方法 | 成本 | 深度 | 误报 | 适用场景 |
|------|------|------|------|---------|
| **Slither** | 低 | 浅 | 中 | 所有合约 |
| **Mythril** | 中 | 中 | 中 | 中等复杂度 |
| **Certora** | 高 | 深✓ | 低✓ | 高价值DeFi |
| **手动审计** | 高 | 深✓ | 低✓ | 所有重要合约 |

**推荐流程**:

1. Slither (快速筛查)
2. Mythril (深度检测)
3. 手动审计 (人工review)
4. Certora (关键合约)
5. 漏洞悬赏 (持续)

---

**最后更新**: 2025-12-02
**定位**: 实践指南
**工具**: Slither/Mythril/Certora/K框架
